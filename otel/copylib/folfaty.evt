* folfaty.evt
* folfaty.evt is generated from D:\asya\acugt.ytl\otel\folfaty.Psf
* This is a generated file. DO NOT modify this file directly.


 Acu-Form1-Ta-1-Cmd-Tabchanged.
     EVALUATE Event-Type
     WHEN Cmd-Tabchanged
        MOVE Event-Data-1 TO Form1-Ta-1-Value
        MOVE 0 TO Form1-Pg-1-Visible, Form1-Pg-2-Visible
        EVALUATE Event-Data-1
        WHEN 1
           MOVE 1 TO Form1-Pg-1-Visible
        WHEN 2
           MOVE 1 TO Form1-Pg-2-Visible
        END-EVALUATE
*       Before-Tabchg-Display
        DISPLAY Form1
        PERFORM Form1-Ta-1-Aft-Tabchg-Display
     END-EVALUATE
     .

 Form1-Exception-Proc.
     PERFORM Ex-Oth-Form1
     .

 cb-fat-tipi-Exception-Proc.
* 
     IF Event-Occurred
        EVALUATE Event-Type
        WHEN Ntf-Selchange
           PERFORM cb-fat-tipi-Ex-Ntf-Selchange
        END-EVALUATE
     END-IF
     .

 Form2-Cm-1-Exception-Proc.
* 
     IF Event-Occurred
        EVALUATE Event-Type
        WHEN Ntf-Selchange
           PERFORM Form2-Cm-1-Ex-Ntf-Selchange
        END-EVALUATE
     END-IF
     .

 gd-sec-Event-Proc.
     PERFORM gd-sec-Ev-Other
     .

 gd-sec-Exception-Proc.
     PERFORM gd-sec-Ex-Other
     .

 gd-yaz-Event-Proc.
     PERFORM gd-yaz-Ev-Other
     .

 Form1-Gd-1-Event-Proc.
     .

 cb-durum-Exception-Proc.
* 
     IF Event-Occurred
        EVALUATE Event-Type
        WHEN Ntf-Selchange
           PERFORM cb-durum-Ex-Ntf-Selchange
        END-EVALUATE
     END-IF
     .

 Form2-Event-Proc.
     .

 Form2-Exception-Proc.
     PERFORM Form2-Ex-Other
     .

 Form2-Gd-1-Event-Proc.
     PERFORM gd-dzn-Ev-Other
     .
***   start event editor code   ***
*
 Bef-Create-Form1.
        perform adresleri-tasi
        open input kodlar02
        open input genel genel2
        
        initialize genel-rec islkilit-acik-kapali
        move 1   to genel-anahtar
        read genel no lock invalid 
             display message box "Genel Parametre Tanimsiz.."
                             title "Uyari"
                             icon 1
              close genel
              exit paragraph 
        end-read 
**           move donem-basi of genel-rec to kv-gecis-tar
        initialize genel2-rec  
        move 1   to genel2-anah 
        read genel2 no lock invalid 
             display message box "Genel Parametre Tanimsiz.."
                             title "Uyari"
                             icon 1
              close genel2
              exit paragraph 
        end-read 

        close genel  genel2
        
        move muha-sirketi to muhasebe-entegre-sirketi mgenelfis-dosya-adres.
         open i-o odalar2
        move genel-fol-fat-no     to genelde-fol-fat
        move genel-printer-filtre to text-oku-filtre
        perform acuserve-adres-aktar
        if genel-e-arsiv-gecis-tarihi > "20150101"  then 
          move 1 to e-arsiv-ac
          if genel-folfatta-def-arsiv of genel-rec = 1 
             move 1 to e-arsiv-var-mi
          end-if
        else
             move 0 to e-arsiv-ac
        end-if

        open input mgenel
        move 1 to mgenel-anahtar
        read mgenel no lock invalid
             display message box 
                     "mgenel parametre tanimsiz ..."
                     icon mb_error_icon
                     title "Hata"
                     close mgenel
                     destroy form1-handle
                     goback
        end-read
        close mgenel

        open i-o earsbil close earsbil  
        move tarih-tasi           to rap-fat-tar.
        if kullanilan-yazicilar(9) > 0 then 
           move  kullanilan-yazicilar(9) to folfat-seri
        end-if.
*
 Form1-Aft-Initdata.
        move 2 to firma-faturasi
        call "c$narg" using link-var.
        if genel-toplu-folio-faturasi-kesilsin = 1
           modify btn-fih, visible = true 
           modify btn-kimlik,visible = true
        end-if 
         evaluate true
          when folfat-seri not > 1 
               move genel-fol-fat-no  to genelde-fol-fat  
          when folfat-seri = 2 
               move genel-fol-fat-no2 to genelde-fol-fat  
          when folfat-seri = 3 
               move genel-fol-fat-no3 to genelde-fol-fat  
          when folfat-seri = 4 
               move genel-fol-fat-no4 to genelde-fol-fat  
          when folfat-seri = 5 
               move genel-fol-fat-no5 to genelde-fol-fat  
        end-evaluate

        compute rap-fat-no = genelde-fol-fat  + 1           
        display acc-fat-no 
        perform acc-fat-no-Aft-Procedure
        
        if genel-muha-uzak-ip(1:1) > "0"
          if genel-fatura-oto-cari = 1
             perform takcari-ilk
             initialize cari-rec
          end-if 
        else
          if genel-fatura-oto-cari = 1
             perform Acu-screen1-routine
             initialize cari-rec
          end-if 
        end-if
**        perform takcari-ilk
        perform takas-dosya-ac.

        perform konuk-bul
           
           
        if link-var = 3               
           initialize toplam-kdv-tutari matrah-tutari alt-toplam genel-toplam
           move 1  to kayit-sayi kdv-toplam-sayi
 
           perform varying ii 
                   from 1 
                   by 1 
                   until ii > 10
                      if penler(ii) = link-pencere 
                         move ii  to event-data-2
                         add 1 to event-data-2
                         exit perform 
                      end-if                          
           end-perform
       
           if event-data-2 < 999 
              inquire gd-sec(event-data-2,1),
                       hidden-data gd-sec-rec
        
              inquire gd-sec(event-data-2,2)
                       hidden-data in gd-sec-secildi
           end-if
         
           if function numval(gd-sec-bakiye) > 0
              display message box "Bakiyeli Folio'ya Fatura Kesilemez..." new-line
                                  "Bakiye : " gd-sec-bakiye
                              title "Uyari"
                              icon 1
                  exit paragraph 
           end-if 
           perform grid-kayit-secildi
        end-if
      
        move rap-fat-no        to xrez-no
        perform dosya-kilit-kontrol
        if link-islkilit-durum <> spaces
           exit paragraph 
        end-if.                 
*
 takas-dosya-ac.
     open i-o genelfis
     initialize genelfis-rec 
     move 1        to genelfis-anahtar
     read genelfis no lock invalid 
          continue 
     not invalid
           add 1 to ekran-fis-1 of genelfis
           move ekran-fis-1 of genelfis  to takas-no deptop-no kdv-no takasisim-no
           rewrite genelfis-rec end-rewrite 
     end-read 
     close genelfis

     open output takasisim takas deptop kdv close kdv takas deptop takasisim.        


* 

*
 Ex-Oth-Form1.
        evaluate key-status
        when 1
           evaluate control-id
           when 4051
                if genel2-uyumsoft-fat-ent-devrede = 1
                if rap-il = spaces 
                   initialize kodtan-cagir
                   move "P" to kodtan-tipi-cagir
                   call "/asya/ytl/obj/otel/kodara.asy"
                     using kodtan-cagir
                     on exception 
                       initialize kodtan-cagir
                     not on exception 
                       cancel "/asya/ytl/obj/otel/kodara.asy"
                   end-call
                   move kodtan-kodu-cagir to uym-il   
                   move kodtan-adi-cagir  to rap-il
                   display acc-il acc-uym-il
                end-if

                initialize kodtan-cagir
                move "G"    to kodtan-tipi-cagir
                move rap-il to kodtan-kodu-cagir
                call "/asya/ytl/obj/otel/kodara.asy"
                  using kodtan-cagir
                  on exception 
                    initialize kodtan-cagir
                  not on exception 
                    cancel "/asya/ytl/obj/otel/kodara.asy"
                end-call
                move kodtan-kodu-cagir to rap-ilce
                display acc-ilce
                end-if

           when 4061
                if genel2-uyumsoft-fat-ent-devrede = 1
                initialize kodtan-cagir                                    
                move "P" to kodtan-tipi-cagir
                call "/asya/ytl/obj/otel/kodara.asy"
                  using kodtan-cagir
                  on exception 
                    initialize kodtan-cagir
                  not on exception 
                    cancel "/asya/ytl/obj/otel/kodara.asy"
                end-call
                move kodtan-kodu-cagir to uym-il
                move kodtan-adi-cagir  to rap-il
                display acc-il acc-uym-il
                end-if

           when 4071
                if genel2-uyumsoft-fat-ent-devrede = 1
                initialize kodtan-cagir                                    
                move "U" to kodtan-tipi-cagir
                call "/asya/ytl/obj/otel/kodara.asy"
                  using kodtan-cagir
                  on exception 
                    initialize kodtan-cagir
                  not on exception 
                    cancel "/asya/ytl/obj/otel/kodara.asy"
                end-call
                move kodtan-kodu-cagir to uym-ulke
                move kodtan-adi-cagir  to rap-ulke
                display acc-ulke acc-uym-ulke
                end-if

           when 4081
                if genel2-uyumsoft-fat-ent-devrede = 1
                initialize kodtan-cagir                                    
                move "V" to kodtan-tipi-cagir
                call "/asya/ytl/obj/otel/kodara.asy"
                  using kodtan-cagir
                  on exception 
                    initialize kodtan-cagir
                  not on exception 
                    cancel "/asya/ytl/obj/otel/kodara.asy"
                end-call
                move kodtan-kodu-cagir to uym-vd
                move kodtan-adi-cagir  to rap-vd
                display acc-vd acc-uym-vd
                end-if

           when 1021
           when 1022
                     initialize oda-cagir
                     if rap-inhouse
                        move "D" to oda-db-cagir
                     end-if
                     call "/asya/ytl/obj/otel/odaara.asy"
                       using oda-cagir
                       on exception 
                         initialize odano-cagir
                       not on exception 
                         cancel "/asya/ytl/obj/otel/odaara.asy"
                     end-call
                     move odano-cagir to rap-oda-no-k
                     move rap-oda-no-k  to o-kisa 
                    perform oda-uzat
                    move o-uzun to rap-oda-no

                     display acc-oda-no
           when 1071
           when 1072
                    
                     initialize acenta-cagir
                     call "/asya/ytl/obj/otel/acenara.asy"
                       using acenta-cagir
                       on exception 
                         initialize acenta-cagir
                       not on exception 
                         cancel "/asya/ytl/obj/otel/acenara.asy"
                     end-call               
                     move acenta-cagir to rap-acenta
                     display acc-acenta
                     perform acenta-oku
           when 90
           when 91
                      initialize firma-cagir
                      call "/asya/ytl/obj/otel/firmara.asy" using firma-cagir
                            on exception perform callerr-proc
                               not on exception
                               cancel "/asya/ytl/obj/otel/firmara.asy" 
                       end-call
                       move firma-cagir     to rap-firma
                       display acc-firma
                       perform firma-oku
           when 8
           when 9
                    initialize gruplar-cagir
                    call "/asya/ytl/obj/otel/gruplara.asy" using gruplar-cagir  
                         on exception perform callerr-proc
                         not on exception
                    cancel "/asya/ytl/obj/otel/gruplara.asy" 
                    end-call
                    if gruplar-cagir > 0 then 
                       move gruplar-cagir   to rap-grup
                       display acc-grup                    
                    end-if                    
                    perform grup-oku
           end-evaluate
        when 2
             if genel2-uyumsoft-fat-ent-devrede = 1  
                perform uyumsoft-kodlari-aktar          |firat 31/3/2021
             end-if
**************************
             move rap-fat-tar  to muhasebe-tar
             perform muhasebe-entegre-kontrol
             if muh-isl-durdur = 1 
                exit paragraph
             end-if
*********************************
              if genel2-e-arsiv-e-fatura-kullanici-degil = 1 and        || fatura kontrol firat 24/02/2020
                 firma-faturasi = 2    
                 perform firma-sorgula
              end-if

             if genel-toplam = 0 then  
                display message box "Fatura kesilmis " title "Hareket Yok" 
                exit paragraph
             end-if
*********************************
*           if rap-fat-tar >= "20160101" 
*               display message box "LUTFEN ASYASOFT YAZILIM DESTEK EKIBINI ARAYINIZ .." NEW-LINE
*                                   "ISLEM IPTAL EDILDI...."
*                               title "Uyari"
*                               icon 2
*               exit paragraph 
*           end-if 
           inspect rap-ack  replacing  all X"0D0A" by  "  "
           initialize  bu-fat-online
           move rap-fat-no        to xrez-no
           perform dosya-kilit-kontrol
             if link-islkilit-durum <> spaces
               exit paragraph 
             end-if            
           open input takvim
           initialize takvim-rec
           move rap-fat-tar   to takvim-anah
           read takvim no lock invalid 
               display message box "Hatali Tarih Girdiniz.."
                               title "Uyari"
                               icon 1
                   close takvim
                   exit paragraph 
           end-read 
           close takvim
           if k-kodu-tasi not = "ASYA" and k-kodu-tasi not = "X   "
              if rap-fat-tar > tarih-tasi
                 display message box "Ileri Tarihe Fatura Kesilemez..."
                                 title "Uyari"
                                 icon 1
                       exit paragraph 
              end-if 
           end-if
 
**************************************************************************************************************************************
           accept gun-tar from century-date                            |firat long beach gecmise kesme sorunu icin konuldu 17/08/2020|
           compute gun-yil = gun-yil - 1                               |**************************************************************
           if rap-fat-yil < gun-yil                                    |
              display message box "2 Yil Oncesine Fatura Kesilemez..." |
                              title "Uyari"                            |
                              icon 1                                   |
                    exit paragraph                                     |
           end-if                                                      |
************************************************************************

           if efat-degil not = 1  
              if genel-e-arsiv-gecis-tarihi <= rap-fat-tar and
                 genel-e-arsiv-gecis-tarihi > "20150101"
                  if e-arsiv-var-mi not = 1

                      if mGENEL-EFATURA-ENT-TURU <> "E"
                           if rap-e-mail = spaces  and rap-telefon = spaces
                              display message box "E-Arsiv icin E-Mail yada Telefon girilmesi zorunludur..."
                                              title "Uyari"
                                              icon 1
                                 move 4   to accept-control
                                 move 35  to control-id 
                                 exit paragraph 
                           end-if 
                           if rap-e-mail not = spaces
                                   unstring rap-e-mail delimited by "@"
                                   into dogru-mail delimiter IN karakter  
                                   if karakter not = "@"
                                      display message box "E-Mail Alaninda @ isareti olmalidir.."
                                                      title "Uyari"
                                                      icon 1
                                         move 4   to accept-control
                                         move 35  to control-id 
                                         exit paragraph 
                                   end-if 
                           end-if 
                      end-if
                 end-if 
              end-if 
           end-if

           if efat-degil not = 1  
              if genel-e-arsiv-gecis-tarihi <= rap-fat-tar and
                 genel-e-arsiv-gecis-tarihi > "20150101"
                     open input konuk acenta
                     initialize konuk-rec
                     move link-fol-no  to konuk-folio
                     read konuk no lock invalid 
                         continue 
                     not invalid 
                          initialize acenta-rec
                          move konuk-acenta  to acenta-kodu
                          read acenta no lock invalid 
                               continue 
                          not invalid 
                              if acenta-online-rez-acentasi = 1  and konuk-fol-kodu = "R"
                                if e-arsiv-var-mi = 1 
                                   display message box "Online Rezervasyon Faturasidir ...." new-line
                                                       "Fatura No " genel-online-onek   " serisinmden alacaktir..."     
                                                 title "Uyari"
                                                  icon 1
                                 end-if
                                       move 1 to bu-fat-online
*                                  initialize e-arsiv-var-mi
*                                  display Form1-Cb-5
                              end-if 
                          end-read 
                     end-read 
                     close konuk acenta                   
              end-if 
           end-if
     
           if rap-vno = spaces and rap-tcno = spaces and rap-pasno = spaces
              display message box "Zorunlu Alanlarda Eksik Bilgi " new-line new-line
                                  "Vergi No / TC Kimlik No veya Pasaport No Alanlarindan bir tanesinin dogru girilmis olmasi gereklidir."
                                  "Fatura Kesilemez.."
                              title "Uyari"
                              icon 1
                    exit paragraph 
           end-if

           if rap-il= spaces or  rap-ilce = spaces or rap-ulke = spaces or rap-adi = spaces
                perform vergi-no-kontrol
                if efat-degil = 1 or 0
                   display message box "Eksik Cari Bilgisi Unvan Il Ilce ve Ulke Girilesi Zorunludur" new-line
                                        "Lutfen Kontrol Ediniz."
                                    title "Uyari"
                                    icon 1
                    exit paragraph 
                end-if 
           end-if

           if rap-vno not = spaces               
              move function numval(rap-vno)   to s-vno
              if s-vno not = rap-vno
                 display message box "Hatali Vergi Numarasi Girisi Yapildi.." new-line
                                     "Lutfen Kontrol Ediniz."
                                 title "Uyari"
                                 icon 1
                    exit paragraph 
              end-if 
              if s-vno < 65
                 display message box "Hatali Vergi Numarasi Girisi Yapildi.." new-line
                                     "Lutfen Kontrol Ediniz."
                                 title "Uyari"
                                 icon 1
                    exit paragraph                 
              end-if 
           end-if
 
           if rap-tcno not = spaces
              move function numval(rap-tcno)   to stc
              if stc not = rap-tcno
                 display message box "Hatali TC Kimlik Numarasi Girisi Yapildi.." new-line
                                     "Lutfen Kontrol Ediniz."
                                 title "Uyari"
                                 icon 1
                    exit paragraph 
              end-if 
              if stc < 1000
                 display message box "Hatali TC Kimlik Numarasi Girisi Yapildi.." new-line
                                     "Lutfen Kontrol Ediniz."
                                 title "Uyari"
                                 icon 1
                    exit paragraph                 
              end-if                
           end-if

           if rap-vno not = spaces and 
              rap-tcno not = spaces 
                 display message box "Zorunlu alanlardan sadece bir tanesi dolu olmali"
                                 title "Uyari"
                                 icon 1
                   exit paragraph 
           end-if
           
           perform cari-ata

           open input kllnc
           initialize kllnc-rec 
           move k-kodu-tasi to k-kodu
           read kllnc no lock invalid
                continue
           end-read 
           close kllnc

           evaluate true
           when  rap-vno not = spaces

                      perform vergi-no-kontrol
                      if efat-degil = 1
                         if rap-fat-no > genel-efol-fat-no - 400 and 
                            rap-fat-no < genel-efol-fat-no + 400
                               continue
                         else              
                                 compute rap-fat-no = genel-efol-fat-no  + 1
                                 display acc-fat-no
                                 perform acc-fat-no-Aft-Procedure    

                         end-if

                         if k-folio-efat-kesemez = 1    | Firat Delphine Memis Beyin istegi 07/06/2021     0700045539
                            display message box "!!!!          E-FATURA Kesme yetkiniz bulunmamaktadir.          !!!!" new-line new-line new-line
                                                "Islem iptal edilecektir."
                                          title "Dikkat"
                            exit paragraph
                         end-if

                         display message box "!!!!          E-FATURA Kesilecektir          !!!!" new-line new-line new-line
                                              "              Eminmisiniz?                       " new-line new-line new-line
                                              "Not:E-FATURA Sisteminde Cikti Verilmeyecektir."
                                          title "Dikkat"
                                          icon 2
                                          type 2 
                                          default 2
                                          returning return-code 
                         if return-code = 2
                            exit paragraph 
                         end-if 
                      else      
                         if rap-fat-no > genelde-fol-fat - 400 and  rap-fat-no < genelde-fol-fat + 400
*                            continue
                            if genel2-e-arsiv-e-fatura-kullanici-degil = 1 and         | firat ekleme 21/02/2020
                               genel-toplam > 5000 
                               perform fatura-no-ata
                            end-if
                         else
*                             compute rap-fat-no = genelde-fol-fat  + 1
*                             display acc-fat-no
*                             perform acc-fat-no-Aft-Procedure

                            if genel2-e-arsiv-e-fatura-kullanici-degil = 0         | firat ekleme 21/02/2020
                               compute rap-fat-no = genel-efol-fat-no  + 1
                               display acc-fat-no
                               perform acc-fat-no-Aft-Procedure    
                            else 
                               if genel-toplam < 5000
                                  compute rap-fat-no = genel-efol-fat-no  + 1
                                  display acc-fat-no
                                  perform acc-fat-no-Aft-Procedure  
                               else 
                                  perform fatura-no-ata 
                               end-if  
                            end-if

                         end-if
                     end-if
              
           when rap-tcno not = spaces
              
              perform vergi-no-kontrol
              if efat-degil = 1
                 if rap-fat-no > genel-efol-fat-no - 400 and  rap-fat-no < genel-efol-fat-no + 400
                    continue                                                            
                 else
                   
                    compute rap-fat-no = genel-efol-fat-no  + 1
                    display acc-fat-no
                    perform acc-fat-no-Aft-Procedure
                 end-if
              
                 if k-folio-efat-kesemez = 1    | Firat Delphine Memis Beyin istegi 07/06/2021
                    display message box "!!!!          E-FATURA Kesme yetkiniz bulunmamaktadir.          !!!!" new-line new-line new-line
                                        "Islem iptal edilecektir."
                                  title "Dikkat"
                    exit paragraph
                 end-if

                  display message box "!!!!          E-FATURA Kesilecektir          !!!!" new-line new-line new-line
                                      "              Eminmisiniz?                       " new-line new-line new-line
                                      "Not:E-FATURA Sisteminde Cikti Verilmeyecektir."
                                  title "Dikkat"
                                  icon 2
                                  type 2 
                                  default 2
                                  returning return-code 
                 if return-code = 2
                    exit paragraph 
                 end-if 

              else 
                 if rap-fat-no > genelde-fol-fat - 400 and   rap-fat-no < genelde-fol-fat + 400
*                    continue                                                            | firat ekleme 21/02/2020
                    if genel2-e-arsiv-e-fatura-kullanici-degil = 1 
                       if firma-faturasi = 1
                          if genel-toplam not < 5000
                             perform fatura-no-ata
                          end-if
                        else 
                          if genel-toplam not < 30000  
                             perform fatura-no-ata
                          end-if
                       end-if
                    end-if
                 else
*                     compute rap-fat-no = genelde-fol-fat  + 1
*                     display acc-fat-no
*                     perform acc-fat-no-Aft-Procedure

                    if genel2-e-arsiv-e-fatura-kullanici-degil = 0         | firat ekleme 21/02/2020
                       compute rap-fat-no = genel-efol-fat-no  + 1
                       display acc-fat-no
                       perform acc-fat-no-Aft-Procedure    
                    else 
                       if firma-faturasi = 1
                          if genel-toplam  not < 30000 
                             perform fatura-no-ata
                          else 
                             compute rap-fat-no = genel-efol-fat-no  + 1
                             display acc-fat-no
                             perform acc-fat-no-Aft-Procedure    
                          end-if
                       else 
                          if genel-toplam  not < 5000 
                             perform fatura-no-ata
                          else 
                             compute rap-fat-no = genel-efol-fat-no  + 1
                             display acc-fat-no
                             perform acc-fat-no-Aft-Procedure    
                          end-if
                       end-if  
                    end-if
                 end-if
              end-if 
             
           when other
               
                 if rap-fat-no > genelde-fol-fat - 400 and  rap-fat-no < genelde-fol-fat + 400
*                    continue                                                            | firat ekleme 21/02/2020
                    if genel2-e-arsiv-e-fatura-kullanici-degil = 1  
                       if genel-toplam not < 30000
                          perform fatura-no-ata
                       end-if
                    end-if
                 else
*                       compute rap-fat-no = genelde-fol-fat  + 1
*                       display acc-fat-no
*                       perform acc-fat-no-Aft-Procedure
                    if genel2-e-arsiv-e-fatura-kullanici-degil = 0         | firat ekleme 21/02/2020
                       compute rap-fat-no = genel-efol-fat-no  + 1
                       display acc-fat-no
                       perform acc-fat-no-Aft-Procedure    
                    else 
                       
                       if genel-toplam < 30000
                          compute rap-fat-no = genel-efol-fat-no  + 1
                          display acc-fat-no
                          perform acc-fat-no-Aft-Procedure 
                       else 
                          perform fatura-no-ata
                       end-if  
                    end-if
                 end-if
            

           end-evaluate
        
           perform fatura-no-kontrol
           
           if hata = 1
              exit paragraph
           end-if
           
           perform fatura-bakiye-kontrol
           if hata = 1
              display message box "Sifir [0] veya eksi  Tutarli Fatura Kesilemez.."
                              title "Uyari"
                              icon 1
              exit paragraph 
           end-if  
           if efat-degil not = 1
              evaluate fat-turu-value(1:1)
              when "F"
                      display message box rap-fat-no " 'Nolu Fatura Kesilecektir." new-line
                                                     "Eminmisiniz?"
                                      title "Uyari"
                                      icon 1
                                      type 2
                                      default 2
                                      returning return-code 
                      if return-code = 2
                         exit paragraph
                      end-if 
              when "T"
                      display message box "                      !!! DIKKAT !!!" new-line new-line
                                          "        !!! TEST !!!  !!! TEST !!!  !!! TEST !!!" new-line new-line
                                          rap-fat-no " 'Nolu Fatura !!! TEST !!! Olarak Kesilecektir." new-line                                                  
                                                     "Eminmisiniz?"
                                      title "Dikkat"
                                      icon 3
                                      type 2
                                      default 2
                                      returning return-code 
                      if return-code = 2
                         exit paragraph
                      end-if 
              end-evaluate
           end-if 

           initialize det-ara-rec
           perform max-satir-bul
           perform dep-bul
           if fazla-departman-var = 1 and dep-var = 1
              display message box "Departman Sayisi 15 'den Buyuk Olamaz..." new-line
                                  "Iki ayri fatura kesmeniz gerekmektedir..."
                              title "Uyari"
                              icon 1
                exit paragraph
           end-if 
           perform kdv-bul

           open input takas musteri konuk ulke
           open i-o fatdokum
           initialize fatdokum-rec i4
           accept fatdokum-tarih from century-date
           accept fatdokum-zaman from time
           move rap-fat-no       to fatdokum-fat-no
           initialize takas-rec fat-sat i top-TL-TUTAR
           start takas key not < takas-anah invalid 
                 continue 
           not invalid 
           perform with test after until fs-takas = "10"
           read takas next no lock end move "10" to fs-takas
           not at end
*                   if takas-folio <> link-fol-no |alakasiz folio geliyor
*                      exit perform cycle  |alakasiz folio geliyor
*                   end-if |alakasiz folio geliyor
                   add 1             to i4                   
                   move takas-tutar  to det-ara-tl-tut(i4)
                   compute top-TL-TUTAR = top-TL-TUTAR + takas-tutar 

                   initialize konuk-rec 
                   move takas-folio  to konuk-folio
                   read konuk no lock invalid 
                        continue  
                   not invalid
                        move konuk-gel-tar    to det-ara-girtar(i4)
                        move konuk-git-tar    to det-ara-ciktar(i4)
                        move konuk-buyuk      to det-ara-buyuk(i4)
                        move konuk-kucuk      to det-ara-kucuk(i4)
                        move konuk-pan-tipi   to det-ara-pan-kod(i4)
                                               
                        if konuk-ulke not = spaces
                           initialize ulke-rec
                           move konuk-ulke     to ulke-anah
                           read ulke no lock invalid 
                               move konuk-ulke  to  det-ara-ulke-adi(i4)
                           not invalid 
                               move ulke-adi   to det-ara-ulke-adi(i4)
                           end-read                            
                        end-if 

                        move konuk-voucher to tmp-fat-voucher  det-ara-voucher(i4)
                   end-read 
                   if kisi-fat = 1 then
                       move rap-adi    to takas-adi
                       move rap-soyadi to takas-soy 
                       move 1          to det-ara-buyuk(i4)
                       move 0          to det-ara-kucuk(i4)
                   end-if
                   if isimsiz not = 1 
                      move takas-adi    to det-ara-adi(i4)
                      move takas-soy    to det-ara-soy(i4)
                      move takas-oda    to det-ara-oda(i4)                
                   else
                      if konuk-fol-kodu = "R"
                         move "KONAKLAMA      "   to det-ara-adi(i4)
                         move "BEDELI   "         to det-ara-soy(i4)
                         move "OTEL "             to det-ara-oda(i4)           
                      else
                         move "HARCAMA      "   to det-ara-adi(i4)
                         move "BEDELI   "         to det-ara-soy(i4)
                         move "EXTRA"             to det-ara-oda(i4)           
                      end-if 
                   end-if

                   if i4 >= max-satir                       
***                      perform fat-bas
                      evaluate cb-yazici-tipi(1:1)
                      when "A"
                           initialize k 
                           perform varying k 
                                   from 1
                                   by 1
                                   until k > m
                                         perform fat-bas2        
                           end-perform
                      when "S"
                           perform fat-bas
                      end-evaluate 
                   end-if 

           end-read 
           end-perform
           end-start
           close takas musteri konuk ulke
           if i4 < max-satir      
              evaluate cb-yazici-tipi(1:1)
                  when "A"
                       initialize k 
                       perform varying k 
                               from 1
                               by 1
                               until k > m
                                     perform fat-bas2        
                       end-perform
                  when "S"
                       perform fat-bas
              end-evaluate 
***              perform fat-bas                                
           end-if
           close fatdokum
           evaluate fat-turu-value(1:1)
               when "F"
                    perform fatura-data-yaz
           end-evaluate

           initialize yazici-secildi
           if efat-degil = 1
              display message box "E-FATURA Kesildi..."
                              title "Uyari"
                              icon 1
              set exit-pushed to true 
           else
              if genel-e-arsiv-gecis-tarihi <= rap-fat-tar and
                 genel-e-arsiv-gecis-tarihi > "20150101"
                   perform e-arsiv-fat-dok
              end-if 
              set exit-pushed to true              
           end-if 
        when 5
           perform fatura-hazirla
        when 5005
           move 1   to sahis-fat
           perform fatura-bilgisi-al
           move 0   to sahis-fat
        when 5006
           move 1   to kurum-fat
           perform fatura-bilgisi-al
           move 0   to kurum-fat
        when 5007
             initialize fihara-cagir
             call "/asya/ytl/obj/otel/fihara.asy"
               using fihara-cagir
               on exception 
                 initialize fihara-cagir
               not on exception 
                 cancel "/asya/ytl/obj/otel/fihara.asy"
             end-call
           initialize rap-adi rap-soyadi rap-adr1 rap-adr2 rap-il rap-ilce 
                   rap-pasno rap-vno rap-tcno rap-vd rap-ulke rap-e-mail rap-telefon              
             perform fihrist-oku
        when 5008
           initialize rap-adi rap-soyadi rap-adr1 rap-adr2 rap-il rap-ilce 
                   rap-pasno rap-vno rap-tcno rap-vd rap-ulke rap-e-mail rap-telefon              
              perform kimlik-bilgilerini-getir           
        end-evaluate.
*
 kimlik-bilgilerini-getir.
        open input konuk polisxml
        initialize konuk-rec
        move gd-sec-folio to konuk-folio
        read konuk no lock invalid 
             continue 
        not invalid 
           if konuk-rez-no > 0  or konuk-extra-rez-no > 0                
              initialize polisxml-rec
              if konuk-extra-rez-no > 0
                 move konuk-extra-rez-no to polisxml-rezno
              else 
                move konuk-rez-no   to polisxml-rezno
              end-if 
              move 1              to polisxml-sirano
              read polisxml no lock invalid 
                   move konuk-adi    to rap-adi
                   move konuk-soyadi to rap-soyadi
              not invalid 
                   move polisxml-adi        to rap-adi
                   move polisxml-soyadi     to rap-soyadi
                   initialize rap-vno
                   if polisxml-uyruk(1:2) = "TC"
                      move polisxml-tckimlikno to stc
                      move stc                 to rap-tcno
                      initialize rap-pasno
                   else
                      move polisxml-kseri      to rap-pasno
                      initialize rap-tcno
                   end-if 
                   move polisxml-adr           to rap-adr1
                   move polisxml-nil           to rap-il
                   move polisxml-nilce         to rap-ilce                      
              end-read 
           end-if 
        end-read
        close polisxml konuk
        perform ekran-goster. 
*
 fihrist-oku.   
     open input fihrist
     initialize fihrist-rec
     move fihara-anahtar to fihrist-anahtar
     read fihrist no lock invalid
          continue 
     end-read 
         if fihrist-unvani = spaces
            move fihrist-adi     to rap-adi
         else
            move fihrist-unvani  to rap-adi
         end-if
         move fihrist-soyadi  to rap-soyadi
         move fihrist-adres-1 to rap-adr1
         move fihrist-adres-2 to rap-adr2
         move fihrist-ilce    to rap-ilce
         move fihrist-il      to rap-il
         move fihrist-ulke    to rap-ulke
         move fihrist-adres-3 to rap-vd
         move fihrist-not     to rap-vno 
         move FIHRIST-EMAIL   to rap-e-mail
     close fihrist
     perform ekran-goster.
*
 konuk-bul.
     perform acenta-oku
     perform firma-oku
     perform grup-oku
     modify gd-sec, reset-grid = 1
                    mass-update = 1
     initialize gd-sec-rec
     move "Sec"                to gd-sec-buton
     move "Oda"                to gd-sec-odano
     move "T"                  to gd-sec-tipi
     move "Folio"              to gd-sec-folio
     move "Adi"                to gd-sec-adi
     move "Soyadi"             to gd-sec-soyadi
     move "Gir.Tarihi"         to gd-sec-gir-tar
     move "Cik.Tarihi"         to gd-sec-git-tar
     move "Folio Bakiyesi"     to gd-sec-bakiye
     move "P"                  to gd-sec-pen
     move "Profil"             to gd-sec-profil
     move "Fatura Tutari"      to gd-sec-tutar
     modify gd-sec,
            record-to-add(gd-sec-rec)
     move 1                    to i
        
     open input konuk folref musteri depkod
     if link-var = 3 |gelen folionun inhouse mu history mi olduðunu buluyor baska bir ise yaramýyor...
        initialize konuk-rec yedek-konuk-firma
        move link-fol-no    to konuk-folio
        read konuk no lock invalid 
             display message box "Register Karti Bulunamadi..."
                             title "Uyari"
                             icon 1
              set exit-pushed to true 
        not invalid 
            move konuk-durumu  to rap-durum(1:1)
            move konuk-firma   to yedek-konuk-firma
            if rap-durum(1:1) = "H"
               move konuk-git-tar to rap-cout-tarihi
               move 1             to vis-1
               display cb-durum acc-cout-gun acc-cout-ay 

                       acc-cout-yil lb-durumb cb-gir-cik
            else
              display cb-durum
            end-if 
        end-read 
     end-if 
     initialize konuk-rec 

     evaluate rap-durum(1:1)
     when "I" 
        if link-var not = 3 
           move rap-durum(1:1)      to konuk-durumu         
           start konuk key not < konuk-oda invalid 
                 continue 
           end-start
        else
           move rap-durum(1:1)      to konuk-durumu         
           move link-fol-no         to konuk-folio
           start konuk key not < konuk-anah invalid 
                 continue 
           end-start           
        end-if 
     when "H"
        evaluate gir-cik-durum(1:1)
        when "C"
          if link-var not = 3
                move rap-durum(1:1)      to konuk-durumu
                move rap-cout-tarihi     to konuk-git-tar
                start konuk key not < konuk-git invalid 
                      continue 
                end-start
          else
              move rap-durum(1:1)        to konuk-durumu
              move link-fol-no           to konuk-folio
              start konuk key not < konuk-anah invalid 
                    continue 
              end-start             
          end-if 
        when "G"
              move rap-durum(1:1)      to konuk-durumu
              move rap-cout-tarihi     to konuk-gel-tar
              start konuk key not < konuk-gel invalid 
                    continue 
              end-start
        end-evaluate 
     end-evaluate 
      move rap-oda-no to o-uzun
            perform oda-kisalt
            move o-kisa to  rap-oda-no-k   
     perform with test after until fs-konuk = "10"
     read konuk next no lock end move "10" to fs-konuk
     not at end
            if link-var = 3
                if konuk-folio <> link-fol-no
                    exit perform 
                end-if 
            end-if 
            if konuk-durumu <> rap-durum(1:1)
                exit perform 
            end-if
            if konuk-fol-kodu not = rap-tipi(1:1) and
               rap-tipi(1:1)  not = "X"
                 exit perform cycle 
            end-if 
            if konuk-acenta not = rap-acenta and
               rap-acenta not = spaces
                  exit perform cycle 
            end-if 
            if konuk-firma not = rap-firma and
               rap-firma not = spaces
                  exit perform cycle 
            end-if
            if konuk-odano not = rap-oda-no-k and
               rap-oda-no not = spaces
                 exit perform cycle 
            end-if
            if konuk-grup-no not = rap-grup and
               rap-grup not = zeroes 
                  exit perform cycle 
            end-if

            evaluate rap-durum(1:1) 
            when "H"
               evaluate gir-cik-durum(1:1)
               when "C"
                 if konuk-git-tar <> rap-cout-tarihi
                      exit perform 
                 end-if 
               when "G"
                 if konuk-gel-tar <> rap-cout-tarihi
                      exit perform 
                 end-if 
               end-evaluate 
            end-evaluate

            move konuk-room-kdv-yok       to room-kdv-yok
            move konuk-extra-kdv-yok      to extra-kdv-yok
            initialize xkonuk-fiyat-konumu
            move konuk-fiyat-konumu      to xkonuk-fiyat-konumu
            initialize pencere-toplamlar
            perform bakiye-bul
            perform grid-kayit-ekle
            if onkpara-fatura-cout-tar-kontrol = 1
               if konuk-git-tar not = tarih-tasi
                  evaluate true
                      when konuk-git-tar > tarih-tasi
                           display message box "Cikis gunu oncesine fatura kesmeniz onerilmez.."
                      when konuk-git-tar < tarih-tasi
                           display message box "Cikis gunu sonrasina fatura kesmeniz onerilmez.."
                  end-evaluate
               end-if
            end-if
     end-read 
     end-perform
     close konuk folref musteri depkod 
     modify gd-sec,mass-update = 0.
*
 grid-kayit-ekle. |penceredeki bakiyeler bulunuyor..
     initialize ii  kac-adet penler-ust 
     perform varying ii 
               from 1
               by 1
               until ii > 10
                  if p-var(ii) not = 0 and
                     p-var(ii) not = spaces
                       if p-var(ii) = 1
                          add 1 to kac-adet
                          move ii       to penler(kac-adet)
                          initialize gd-sec-rec
                          perform grid-satir-ekle |pencerelere göre grid yükleniyor.
                       end-if 
                  end-if 
     end-perform.
*
 grid-satir-ekle.        
     move konuk-odano    to gd-sec-odano  
     move konuk-fol-kodu to gd-sec-tipi
     move konuk-folio    to gd-sec-folio 
     move konuk-adi      to gd-sec-adi   
     move konuk-soyadi   to gd-sec-soyadi 
     
     move konuk-gel-gun  to egun
     move konuk-gel-ay   to eay
     move konuk-gel-yil  to eyil
     move etarih         to gd-sec-gir-tar
     
     move konuk-git-gun  to egun
     move konuk-git-ay   to eay
     move konuk-git-yil  to eyil
     move etarih         to gd-sec-git-tar
     add 1               to i
     
     move p-bakiye(ii)   to stutar
     move stutar         to gd-sec-bakiye  
     move ii             to gd-sec-pen

     move p-tutar(ii)    to 13-z
     move 13-z           to gd-sec-tutar
        
     modify gd-sec(i,1)
        record-to-add   = gd-sec-rec
        row-color       = 480
        bitmap          = artieksi-bmp
        bitmap-number   = 1 
        bitmap-width    = 16
        bitmap-trailing = 1
        hidden-data     = gd-sec-rec.
*
 fatura-hazirla.
     evaluate rap-durum
     when "I"
             perform konuk-bul
     when "H"
             perform konuk-bul
     end-evaluate.
*
 gd-sec-Ev-Other.
     evaluate event-type
     when msg-begin-entry
            set event-action to event-action-fail 
            inquire gd-sec(event-data-2,1),
                       hidden-data gd-sec-rec                         
     when msg-bitmap-clicked         
         set event-action to event-action-fail 
         evaluate event-data-1
         when 1               
              initialize toplam-kdv-tutari matrah-tutari alt-toplam genel-toplam
              move 1  to kayit-sayi kdv-toplam-sayi

              inquire gd-sec(event-data-2,1),
                      hidden-data gd-sec-rec

              inquire gd-sec(event-data-2,2)
                      hidden-data in gd-sec-secildi

              if gd-sec-bakiye <> spaces
                 display message box "Bakiyeli Folio'ya Fatura Kesilemez..." new-line
                                     "Bakiye : "gd-sec-bakiye
                                 title "Uyari"
                                 icon 1
                     exit paragraph 
              end-if 
              
              if gd-sec-secildi = 1
                 perform grid-kayit-secim-iptal
              else
                 perform grid-kayit-secildi   
              end-if                             
         end-evaluate 
     end-evaluate.
*
 kdv-baslik-yukle.
     modify form1-gd-1,reset-grid = 1
                       mass-update = 1
     initialize form1-gd-1-record
     move "Kdv"           to gd-1-col-1
     move "Matrah"        to gd-1-col-2
     move "Kdv Tutari"    to gd-1-col-3
     move "Tutar"         to gd-1-col-4
     modify form1-gd-1,record-to-add(form1-gd-1-record).
*
 kdv-grid-yukle.
     open input kdv
     initialize kdv-rec 
     start kdv key not < kdv-anah invalid 
          continue 
     not invalid 
     perform with test after until fs-kdv = "10"
     read kdv next no lock end move "10" to fs-kdv
     not at end              
              initialize form1-gd-1-record
              if kdv-orani = 2
                move "KV" to gd-1-col-1
                 else
                  move kdv-orani      to gd-1-col-1
              end-if
              move kdv-matrah     to etutar
              move etutar         to gd-1-col-2

              move kdv-kdv-tutar  to etutar
              move etutar         to gd-1-col-3

              move kdv-tutar      to etutar
              move etutar         to gd-1-col-4

              add 1 to kdv-toplam-sayi
               if kdv-orani = 2
                   continue 
               else
              compute genel-toplam = genel-toplam + kdv-tutar
              end-if
              modify form1-gd-1,
                      record-to-add(form1-gd-1-record)
     end-read 
     end-perform
     end-start
     close kdv
     modify form1-gd-1,mass-update = 0

     if genel-toplam > 0
        initialize form1-gd-1-record
        move "T"              to gd-1-col-1
        move genel-toplam     to etutar
        move etutar           to gd-1-col-4
        modify form1-gd-1(kdv-toplam-sayi+ 1 ,1),
                   record-to-add(form1-gd-1-record)
                   row-color = 480
     end-if. 
*
 dep-top-grid-yukle.
     open input deptop depkod
     open i-o kdv
     initialize deptop-rec 
     start deptop key not < deptop-anah invalid 
          continue 
     not invalid 
     perform with test after until fs-deptop = "10"
     read deptop next no lock end move "10" to fs-deptop
     not at end 
             initialize  depkod-rec
             move deptop-depkod(1:3)                 to  depkod-anah
             read depkod no lock invalid 
                  move "Tanimsiz..."            to depkod-adi
             end-read 
             if DEPKOD-FATURA-TAKIP <> "E"
                 exit perform cycle 
             end-if 
             if depkod-ba <> "B"
                exit perform cycle 
             end-if 
             if deptop-kdv-tutari = 0
                move 0                       to depkod-kdv
             end-if 
             initialize kdv-rec
             move depkod-kdv                 to kdv-orani
             read kdv no lock invalid  
                  move deptop-tutar          to kdv-tutar
                  move deptop-matrah-tutari  to kdv-matrah
                  move deptop-kdv-tutari     to kdv-kdv-tutar
                  write kdv-rec end-write 
             not invalid 
                  add deptop-tutar           to kdv-tutar
                  add deptop-matrah-tutari   to kdv-matrah
                  add deptop-kdv-tutari      to kdv-kdv-tutar
                  rewrite kdv-rec end-rewrite 
             end-read 
           
               move kv-orani                to kdv-orani
             read kdv no lock invalid  
                  move deptop-tutar       to kdv-tutar
                  move deptop-kv-matrah  to kdv-matrah
                  move  deptop-kv-tutari           to kdv-kdv-tutar
                  write kdv-rec end-write 
             not invalid 
                  add deptop-tutar           to kdv-tutar
                  add  deptop-kv-matrah    to kdv-matrah
                  add  deptop-kv-tutari         to kdv-kdv-tutar
                  rewrite kdv-rec end-rewrite 
             end-read 

     end-read 
     end-perform
     end-start
     if genel-folfat-kdv-yuvarlama = 1
     initialize kdv-rec
     start kdv key >= kdv-anah invalid continue
       not invalid 
         perform until fs-kdv = "10" 
           read kdv next no lock end move "10" to fs-kdv 
             not end
           compute kdv-matrah rounded = kdv-tutar / ((100 + kdv-orani )/ 100 )
           compute  kdv-kdv-tutar rounded = kdv-tutar - kdv-matrah
            rewrite kdv-rec end-rewrite 
          end-read
         end-perform
     end-start
     end-if

     close deptop depkod kdv.




*
 alt-grid-baslik-yukle.
     modify gd-yaz,reset-grid = 1
                   mass-update = 1
     initialize gd-yaz-rec
     move "#"                     to gd-yaz-buton
     move "Tarih"                 to gd-yaz-tarih
     move "Oda"                   to gd-yaz-odano
     move "Folio"                 to gd-yaz-folio
     move "Dep"                   to gd-yaz-dep
     move "Departman Adi"         to gd-yaz-dep-adi
     move "Matrah(KDV'siz)"       to gd-yaz-matrah
     move "KDV"                   to gd-yaz-kdv
     move "Tutar(KDV'li)"         to gd-yaz-tutar
     modify gd-yaz,record-to-add(gd-yaz-rec).
*
 takas-sil.
     open i-o takas
     initialize takas-rec 
     move gd-sec-folio        to takas-folio
     move gd-sec-odano        to takas-oda
     move gd-sec-pen          to takas-pen
     read takas no lock invalid
         continue 
     not invalid 
         delete takas end-delete 
     end-read 
     close takas.
*
 takas-yaz.
     open i-o takas.
     initialize takas-rec 
     move gd-sec-folio   to takas-folio
     move gd-sec-odano   to takas-oda
     move gd-sec-adi     to takas-adi
     move gd-sec-soyadi  to takas-soy
     move gd-sec-pen     to takas-pen
     move function numval(gd-sec-tutar)   to takas-tutar
     move gd-sec-tipi    to takas-folio-tipi 
     write takas-rec invalid 
         rewrite takas-rec end-rewrite 
     end-write 
     close takas.
*
 alt-grid-ekle.| alt grid ve tab sekmesindeki grid için yapýldý.!!!!!! Dikkat !!!en önemli paragraf.
    delete file deptop kdv
*/**/********************************************************************************************
    open input romhrk depkod doviz  depkod2
              takas yromhrk hrk2 exthrk konu2
    open i-o kdv deptop takasisim
    initialize takas-rec 
    move 1    to kayit-sayi   
    start takas key not < takas-anah invalid 
         continue 
    not invalid 
    perform with test after until fs-takas = "10"
    read takas next no lock end move "10"  to fs-takas
    not at end          
               evaluate takas-folio-tipi
               when "R"
                  perform romhrk-bul
               when "E"
                  perform exthrk-bul
               end-evaluate                    
    end-read 
    end-perform
    end-start

     initialize deptop-rec 
     start deptop key > deptop-anah invalid 
        continue
          not invalid
          perform until fs-deptop = "10"
              read deptop next no lock end move "10" to fs-deptop 
                   not end
                      if  deptop-tutar  < 0 then 
                            display message box "Toplam Eksi Gelire Fatura Kesemessiniz " new-line
                                                "Lutfen duzeltiniz"                      new-line
                                                deptop-depkod  " " deptop-dep-adi     
                      end-if
              end-read
          end-perform
     end-start
         
    close romhrk depkod takas doviz takasisim    depkod2
          deptop exthrk kdv yromhrk hrk2 konu2

    modify gd-yaz,mass-update = 0.
*
 romhrk-bul.     
    initialize romhrk-rec cor-var
    move takas-folio     to romhrk-folio
    start romhrk key not < romhrk-anah invalid 
         continue 
    not invalid 
    perform with test after until fs-romhrk = "10"
    read romhrk next no lock end move "10"  to fs-romhrk
    not at end 
          if romhrk-folio <> takas-folio
              exit perform 
          end-if
          if romhrk-fatura-no not = zeroes
             exit perform cycle 
          end-if
          if romhrk-ref not = takas-pen
             exit perform cycle 
          end-if 

          initialize depkod-rec 
          move romhrk-depkod       to depkod-anah
          read depkod no lock invalid
               move "Tanimsiz.."   to depkod-adi
          end-read 
  
          add 1                    to kayit-sayi
          initialize gd-yaz-rec
          move romhrk-gun          to egun
          move romhrk-ay           to eay
          move romhrk-yil          to eyil
          move etarih              to gd-yaz-tarih

          move takas-oda           to gd-yaz-odano
          move takas-folio         to gd-yaz-folio
          move gd-sec-tipi         to gd-yaz-tipi
          move romhrk-depkod       to gd-yaz-dep

          initialize depkod-rec depkod2-rec
          move romhrk-depkod       to depkod-anah depkod2-anah
          read depkod no lock invalid
               move "Tanimsiz.."   to depkod-adi
          end-read 
           read depkod2 no lock invalid
               move "Tanimsiz.."   to depkod-adi
          end-read 
               move depkod-adi     to gd-yaz-dep-adi

            initialize hrk2-rec
            move romhrk-anah      to hrk2-anah
            read hrk2 no lock invalid
                 continue
            end-read
            initialize yromhrk-rec 
            move hrk2-kaynak-folio     to yromhrk-folio
            move romhrk-islem          to yromhrk-islem
            read yromhrk no lock invalid
                 continue 
            end-read 
           
            initialize konu2-rec
            move hrk2-kaynak-folio          to konu2-folio
            read konu2 no lock invalid 
                 continue 
            not invalid 
                  initialize takasisim-rec
                  move konu2-folio          to takasisim-folio
                  read takasisim no lock invalid 
                       move konu2-adi       to takasisim-adi
                       move konu2-soyadi    to takasisim-soy
                       move konu2-odano     to takasisim-oda
                       move konu2-gel-tar   to takasisim-gir-tar
                       move konu2-git-tar   to takasisim-cik-tar
                       move konu2-voucher to takasisim-voucher
                       write takasisim-rec invalid 
                           continue 
                       end-write 
                  end-read 
            end-read 

          
          initialize deptop-rec 
          move romhrk-depkod     to deptop-depkod(1:3)  
                if yromhrk-kk-onay-kodu not = spaces 
                   move yromhrk-kk-onay-kodu  to deptop-depkod(4:)
                   move 2                     to deptop-dovizli|onay kodu
                else
                   if yromhrk-doviz-kodu > 0 and yromhrk-doviz-tut > 0
                      initialize doviz-rec 
                      move yromhrk-doviz-kodu to doviz-kodu
                      read doviz no lock invalid 
                           continue 
                      not invalid    
                           add 1                  to t
                           if t < 50
                              move romhrk-depkod to deptop-depkod(1:3) dizi-d-kodu(t)                     
                              move d-kisa-adi    to deptop-depkod(4:) dizi-d-adi(t)
                              move 1             to deptop-dovizli  dizi-d-mi(t)
                           end-if 
                      end-read                        
                   end-if 
                end-if
          
          move romhrk-ba                      to deptop-ba
          read deptop no lock invalid 
              if DEPKOD-TURU = 2 then             
                 initialize depkod-rec deptop-rec  okunamadi-deptop
                 move ROMHRK-CORR-DEPKOD to depkod-anah deptop-depkod(1:3)   depkod2-anah
                 read depkod no lock invalid
                     continue
                 end-read
                 read depkod2 no lock invalid
                         continue
                     end-read
                     move depkod-ba       to deptop-ba
                     read deptop no lock invalid 
                        move 1            to okunamadi-deptop                     
                     end-read 
                     if okunamadi-deptop = 1
                        initialize t
                        perform varying t 
                                from 1 
                                by 1 
                                until t > 50
                                     if dizi-d-kodu(t) <> ROMHRK-CORR-DEPKOD
                                        exit perform cycle 
                                     end-if 
                                     move dizi-d-adi(t)   to deptop-depkod(4:)
                                     move dizi-d-mi(t)    to deptop-dovizli
                                     read deptop no lock invalid 
                                        move 1            to okunamadi-deptop                     
                                     end-read 
                        end-perform 
                     end-if 
                     move -1 to carpan
              else 
                     move 1  to carpan
              end-if
                  if (room-kdv-yok = 1 and depkod-tipi = 2) or (extra-kdv-yok = 1 and depkod-tipi = 3)
                     move 0  to depkod-kdv
                  end-if            
       
                  
              if (kv-gecis-tar <= romhrk-tarih and depkod2-kv-uygula = 1 )

                  compute matrah-tutari rounded = 
                      (romhrk-tl-tutar  / (100 + depkod-kdv + kv-orani ) ) * 100

              compute toplam-kdv-tutari rounded = 
                     matrah-tutari * ( depkod-kdv ) / 100

                    

              compute toplam-kv-tutari rounded = 
                     matrah-tutari * ( kv-orani ) / 100

                 compute matrah-tutari rounded =    romhrk-tl-tutar -   toplam-kdv-tutari - toplam-kv-tutari

                      compute kv-matrah-tutari rounded = 
                      matrah-tutari

              else
              compute matrah-tutari rounded = 
                      (romhrk-tl-tutar  / ((100 + depkod-kdv )/100 ) )

                compute toplam-kdv-tutari rounded = 
                     matrah-tutari * ( depkod-kdv ) / 100

                       compute toplam-kv-tutari = 0

                       compute matrah-tutari rounded =    romhrk-tl-tutar -   toplam-kdv-tutari - toplam-kv-tutari
                         compute kv-matrah-tutari rounded = 0
                    

               end-if
              
               move depkod-adi             to deptop-dep-adi

                  if carpan = 1 
                       add romhrk-tl-tutar         to deptop-tutar
                       if yromhrk-doviz-kodu > 0 and yromhrk-doviz-tut > 0
                          add yromhrk-doviz-tut       to deptop-dv-tutar
                       end-if 
                       add matrah-tutari           to deptop-matrah-tutari
                       add toplam-kdv-tutari       to deptop-kdv-tutari




                         add  kv-matrah-tutari to deptop-kv-matrah            
                          add toplam-kv-tutari to    deptop-kv-tutari               

                  else
                      subtract romhrk-tl-tutar         from deptop-tutar
                      subtract matrah-tutari           from deptop-matrah-tutari
                      subtract toplam-kdv-tutari       from deptop-kdv-tutari

                     subtract  kv-matrah-tutari from deptop-kv-matrah            
                     subtract toplam-kv-tutari from    deptop-kv-tutari            


                       if yromhrk-doviz-kodu > 0 and yromhrk-doviz-tut > 0
                          subtract yromhrk-doviz-tut       from deptop-dv-tutar
                       end-if
                 end-if

               write deptop-rec invalid 
                  rewrite deptop-rec end-rewrite 
               end-write 
          not invalid 
              if DEPKOD-TURU = 2 then             
                 initialize depkod-rec deptop-rec 
                 move ROMHRK-CORR-DEPKOD to depkod-anah deptop-depkod  depkod2-anah 
                 read depkod no lock invalid
                     exit perform cycle
                 end-read
                 read depkod2 no lock invalid
                         continue
                     end-read
                     move depkod-ba  to deptop-ba
                     read deptop no lock invalid 
                        continue                             
                     not invalid 
                         compute deptop-tutar = deptop-tutar - romhrk-tl-tutar
                         if deptop-tutar < 0
                             continue
                         end-if
                     end-read
                     move -1 to carpan
              else 
                     move 1 to carpan
              end-if
                  if (room-kdv-yok = 1 and depkod-tipi = 2) or (extra-kdv-yok = 1 and depkod-tipi = 3)
                     move 0  to depkod-kdv
                  end-if 

                  

              if (kv-gecis-tar <= romhrk-tarih and depkod2-kv-uygula = 1 )



                              compute matrah-tutari rounded = 
                                      romhrk-tl-tutar  / ((100  + depkod-kdv + kv-orani )/100 ) 
                
                              compute toplam-kdv-tutari rounded = 
                                      matrah-tutari  * ( depkod-kdv / 100)


                               compute toplam-kv-tutari rounded = 
                                      matrah-tutari  * ( kv-orani / 100)

                                compute matrah-tutari rounded =   romhrk-tl-tutar -  toplam-kdv-tutari -  toplam-kv-tutari
                                
                                
                                compute kv-matrah-tutari rounded = matrah-tutari
                                
                

                                   
                              compute deptop-tutar = 
                                      deptop-tutar + ( romhrk-tl-tutar  * carpan )
                
                              compute deptop-matrah-tutari = 
                                      deptop-matrah-tutari + ( matrah-tutari * carpan )
                
                              compute deptop-kdv-tutari = 
                                      deptop-kdv-tutari +  ( toplam-kdv-tutari * carpan )


                              compute deptop-kv-matrah = 
                                      deptop-kv-matrah + ( kv-matrah-tutari * carpan )
                
                              compute deptop-kv-tutari = 
                                      deptop-kv-tutari +  ( toplam-kv-tutari * carpan )
                            


                      else
                              
                         compute kv-matrah-tutari = 0
                         compute toplam-kv-tutari  = 0
                              compute matrah-tutari rounded = 
                                      (romhrk-tl-tutar  / 
                                      ((100 + depkod-kdv )/100 ) )

                               compute toplam-kdv-tutari rounded = 
                                      matrah-tutari  * ( depkod-kdv / 100)

                
                                 compute matrah-tutari =    romhrk-tl-tutar   - toplam-kdv-tutari
                
                              compute deptop-tutar = 
                                      deptop-tutar + ( romhrk-tl-tutar  * carpan )
                
                              compute deptop-matrah-tutari = 
                                      deptop-matrah-tutari + ( matrah-tutari * carpan )
                
                              compute deptop-kdv-tutari = 
                                      deptop-kdv-tutari +  ( toplam-kdv-tutari * carpan )





                      end-if
              if yromhrk-doviz-kodu > 0 and yromhrk-doviz-tut > 0                      
                     compute deptop-dv-tutar = deptop-dv-tutar + (yromhrk-doviz-tut * carpan)
              end-if 
              rewrite deptop-rec end-rewrite 
          end-read
                 
          move matrah-tutari       to etutar
          move etutar              to gd-yaz-matrah

          move toplam-kdv-tutari   to etutar
          move etutar              to gd-yaz-kdv

          move romhrk-tl-tutar     to etutar
          move etutar              to gd-yaz-tutar
          compute alt-toplam = alt-toplam + romhrk-tl-tutar  

          modify gd-yaz(kayit-sayi,1)
               record-to-add   = gd-yaz-rec
               bitmap          = artieksi-bmp
               bitmap-number   = 2 
               bitmap-width    = 16
               bitmap-trailing = 1
               hidden-data     = gd-yaz-rec
        
    end-read 
    end-perform
    end-start.
*
 exthrk-bul.   
    initialize exthrk-rec 
    move takas-folio     to exthrk-folio
    start exthrk key not < exthrk-anah invalid 
         continue 
    not invalid 
    perform with test after until fs-exthrk = "10"
    read exthrk next no lock end move "10"  to fs-exthrk
    not at end 
          if exthrk-folio <> takas-folio
              exit perform 
          end-if
          if exthrk-fatura-no not = zeroes
             exit perform cycle 
          end-if

          if exthrk-ref not = takas-pen
             exit perform cycle 
          end-if 

          initialize depkod-rec 
          move exthrk-depkod  to depkod-anah  
          read depkod no lock invalid
               move "Tanimsiz.." to depkod-adi
          end-read 

          add 1               to kayit-sayi          
          initialize gd-yaz-rec
          move takas-oda      to gd-yaz-odano
          move takas-folio    to gd-yaz-folio
          move gd-sec-tipi    to gd-yaz-tipi
          move exthrk-depkod  to gd-yaz-dep

          move exthrk-gun     to egun
          move exthrk-ay      to eay
          move exthrk-yil     to eyil
          move etarih         to gd-yaz-tarih

          initialize depkod-rec 
          move exthrk-depkod  to depkod-anah   depkod2-anah
          read depkod no lock invalid
               move "Tanimsiz.." to depkod-adi
          end-read 
          read depkod2 no lock invalid
               continue
          end-read          
          move depkod-adi    to gd-yaz-dep-adi

            initialize hrk2-rec
            move exthrk-anah      to hrk2-anah
            read hrk2 no lock invalid
                 continue
            end-read
            initialize yromhrk-rec 
            move hrk2-kaynak-folio     to yromhrk-folio
            move exthrk-islem          to yromhrk-islem
            read yromhrk no lock invalid
                 continue 
            end-read

            initialize konu2-rec
            move hrk2-kaynak-folio          to konu2-folio
            read konu2 no lock invalid 
                 continue 
            not invalid 
                  initialize takasisim-rec
                  move konu2-folio          to takasisim-folio
                  read takasisim no lock invalid 
                       move konu2-adi       to takasisim-adi
                       move konu2-soyadi    to takasisim-soy
                       move konu2-odano     to takasisim-oda
                       move konu2-gel-tar   to takasisim-gir-tar
                       move konu2-git-tar   to takasisim-cik-tar
                       move konu2-voucher to takasisim-voucher
                       write takasisim-rec invalid 
                           continue 
                       end-write 
                  end-read 
            end-read 
            

          initialize deptop-rec 
          move exthrk-depkod     to deptop-depkod(1:3)
                if yromhrk-kk-onay-kodu not = spaces 
                   move yromhrk-kk-onay-kodu  to deptop-depkod(4:)
                   move 2                     to deptop-dovizli|onay kodu
                else
                   if yromhrk-doviz-kodu > 0 and yromhrk-doviz-tut > 0
                      initialize doviz-rec 
                      move yromhrk-doviz-kodu to doviz-kodu
                      read doviz no lock invalid 
                           continue 
                      not invalid 
                           add 1                  to t
                           if t < 50
                             move exthrk-depkod to deptop-depkod(1:3) dizi-d-kodu(t)
                             move d-kisa-adi    to deptop-depkod(4:)  dizi-d-adi(t)
                             move 1             to deptop-dovizli   dizi-d-mi(t)
                           end-if 
                      end-read                        
                   end-if 
                end-if 

          move exthrk-ba         to deptop-ba
          read deptop no lock invalid 
                  if DEPKOD-TURU = 2 then             
                     initialize depkod-rec deptop-rec okunamadi-deptop
                     move extHRK-CORR-DEPKOD to depkod-anah deptop-depkod(1:3)  depkod2-anah 
                     read depkod no lock invalid
                         continue
                     end-read
                     read depkod2 no lock invalid
                         continue
                     end-read
                         move depkod-ba  to deptop-ba
                         read deptop no lock invalid 
                            move 1            to okunamadi-deptop                                                
                         end-read 
                             if okunamadi-deptop = 1
                                initialize t
                                perform varying t 
                                        from 1 
                                        by 1 
                                        until t > 50
                                             if dizi-d-kodu(t) <> extHRK-CORR-DEPKOD
                                                exit perform cycle 
                                             end-if 
                                             move dizi-d-adi(t)   to deptop-depkod(4:)
                                             move dizi-d-mi(t)    to deptop-dovizli
                                             read deptop no lock invalid 
                                                move 1            to okunamadi-deptop                     
                                             end-read 
                                end-perform 
                             end-if 
                           move -1 to carpan
                  else 
                           move 1 to carpan
                  end-if
                  if (room-kdv-yok = 1 and depkod-tipi = 2) or (extra-kdv-yok = 1 and depkod-tipi = 3)
                     move 0  to depkod-kdv
                  end-if 



               if (kv-gecis-tar <= exthrk-tarih and depkod2-kv-uygula = 1 )    


                          compute matrah-tutari rounded = 
                                  exthrk-tl-tutar  / ((100 + depkod-kdv + kv-orani ) /100) 
                          compute toplam-kdv-tutari rounded = 
                                  matrah-tutari * (depkod-kdv / 100)
                            compute toplam-kv-tutari rounded = 
                                  matrah-tutari * (kv-orani / 100)
                             compute matrah-tutari rounded = exthrk-tl-tutar -   toplam-kdv-tutari - toplam-kv-tutari
                             move matrah-tutari to kv-matrah-tutari
                        
                 else

                              compute matrah-tutari rounded = 
                                  exthrk-tl-tutar  / ((100 + depkod-kdv )/100 ) 

                                   compute toplam-kdv-tutari rounded = 
                                  matrah-tutari * (depkod-kdv / 100)
                        

                                  move 0 to kv-matrah-tutari
                                  move 0 to toplam-kv-tutari
                                     compute matrah-tutari rounded = exthrk-tl-tutar -   toplam-kdv-tutari - toplam-kv-tutari

               end-if
        
                         if carpan = 1 
                               add exthrk-tl-tutar             to deptop-tutar
                               add matrah-tutari               to deptop-matrah-tutari
                               add toplam-kdv-tutari           to deptop-kdv-tutari


                               add kv-matrah-tutari               to deptop-kv-matrah
                               add toplam-kv-tutari           to deptop-kv-tutari
                               if yromhrk-doviz-kodu > 0 and yromhrk-doviz-tut > 0
                                  add yromhrk-doviz-tut        to deptop-dv-tutar
                               end-if 
                         else
                              subtract exthrk-tl-tutar         from deptop-tutar
                              subtract matrah-tutari           from deptop-matrah-tutari
                              subtract toplam-kdv-tutari       from deptop-kdv-tutari


                                subtract kv-matrah-tutari           from deptop-kv-matrah
                              subtract toplam-kv-tutari       from deptop-kv-tutari
                               if yromhrk-doviz-kodu > 0 and yromhrk-doviz-tut > 0
                                  subtract yromhrk-doviz-tut   from deptop-dv-tutar
                               end-if                       
                         end-if



                 
            
                 move depkod-adi                       to deptop-dep-adi
              
               write deptop-rec invalid 
               rewrite deptop-rec end-rewrite 
               end-write 
          not invalid        
                  if DEPKOD-TURU = 2 then             
                     initialize depkod-rec deptop-rec 
                     move extHRK-CORR-DEPKOD to depkod-anah deptop-depkod  depkod2-anah 
                     read depkod no lock invalid
                         continue
                     end-read
                      read depkod2 no lock invalid
                         continue
                     end-read
                         move depkod-ba  to deptop-ba
                         read deptop no lock invalid 
                             continue
                                                
                         end-read 
                          move -1 to carpan
                      else 
                           move 1 to carpan
                  end-if

                  if (room-kdv-yok = 1 and depkod-tipi = 2) or (extra-kdv-yok = 1 and depkod-tipi = 3)
                     move 0  to depkod-kdv
                  end-if 


                if (kv-gecis-tar <= exthrk-tarih and depkod2-kv-uygula = 1 )    



                        compute matrah-tutari rounded = 
                                  (exthrk-tl-tutar  / (100 + depkod-kdv + kv-orani) ) * 100
                       compute toplam-kdv-tutari rounded = 
                                   matrah-tutari * (  depkod-kdv / 100)   

                      
                           compute toplam-kv-tutari rounded = 
                                   matrah-tutari * (  kv-orani / 100)   


                               compute matrah-tutari rounded =   exthrk-tl-tutar -    toplam-kdv-tutari -   toplam-kv-tutari
                                 move   matrah-tutari to  kv-matrah-tutari

                          else


                       compute matrah-tutari rounded = 
                                    (exthrk-tl-tutar  / (100 + depkod-kdv ) ) * 100
                        compute toplam-kdv-tutari rounded = 
                                   matrah-tutari * (  depkod-kdv / 100)     

                               move 0 to kv-matrah-tutari
                                  move 0 to toplam-kv-tutari

                           compute matrah-tutari rounded =   exthrk-tl-tutar -    toplam-kdv-tutari -   toplam-kv-tutari

                          end-if
                          
                          
                          
                          
                          
                            compute deptop-kv-matrah = deptop-kv-matrah + (  kv-matrah-tutari * carpan)
                             compute deptop-kv-tutari = deptop-kv-tutari + (  toplam-kv-tutari * carpan)
                             

                          
                          
                          
                          compute deptop-tutar = 
                               deptop-tutar + ( exthrk-tl-tutar * carpan )
        
                       compute deptop-matrah-tutari = 
                               deptop-matrah-tutari + (matrah-tutari * carpan )
        
                       compute deptop-kdv-tutari = 
                               deptop-kdv-tutari + (toplam-kdv-tutari * carpan )
                      if yromhrk-doviz-kodu > 0 and yromhrk-doviz-tut > 0                      
                             compute deptop-dv-tutar = deptop-dv-tutar + (yromhrk-doviz-tut * carpan)
                      end-if
               rewrite deptop-rec end-rewrite 
          end-read 
          move matrah-tutari     to etutar
          move etutar            to gd-yaz-matrah

          move toplam-kdv-tutari        to etutar
          move etutar            to gd-yaz-kdv

          move exthrk-tl-tutar   to etutar
          move etutar            to gd-yaz-tutar
          compute alt-toplam = alt-toplam + exthrk-tl-tutar  

          modify gd-yaz(kayit-sayi,1)
               record-to-add   = gd-yaz-rec
               bitmap          = artieksi-bmp
               bitmap-number   = 2 
               bitmap-width    = 16
               bitmap-trailing = 1
               hidden-data     = gd-yaz-rec
 
    end-read 
    end-perform
    end-start.
*
 acenta-oku.
    if rap-acenta not = spaces
       open input acenta
       initialize acenta-rec
       move rap-acenta   to acenta-kodu
       read acenta no lock invalid 
            move "Tanimsiz Acenta" to rap-acenta-adi
            MOVE 4    to accept-control
            move 1071 to control-id
       not invalid 
           move acenta-adi  to rap-acenta-adi
       end-read 
       close acenta 
    else
       move "Hepsi"         to rap-acenta-adi
    end-if 
    display lb-acenta-adi.
*
 firma-oku.     
    if rap-firma not = spaces
       open input firma
       initialize firma-rec
       move rap-firma   to firma-kodu
       read firma no lock invalid 
            move "Tanimsiz Firma" to rap-firma-adi
            MOVE 4    to accept-control
            move 90   to control-id
       not invalid 
           move firma-adi  to rap-firma-adi
       end-read 
       close firma 
    else
       move "Hepsi"   to rap-firma-adi
    end-if 
    display lb-firma-adi.
*
 grup-oku.
    if rap-grup not = zeroes
       open input gruplar
       initialize gruplar-rec
       move rap-grup   to gruplar-kodu
       read gruplar no lock invalid 
            move "Tanimsiz Firma" to rap-grup-adi
            MOVE 4    to accept-control
            move 90   to control-id
       not invalid 
           move gruplar-adi  to rap-grup-adi
       end-read 
       close gruplar 
    else
       move "Hepsi"   to rap-grup-adi
    end-if 
    display lb-grup-adi.
*
 cb-durum-Ex-Ntf-Selchange.
    if rap-durum(1:1) = "H"
       move tarih-tasi   to rap-cout-tarihi
       move 1 to vis-1
       display acc-cout-gun acc-cout-ay acc-cout-yil
               lb-duruma lb-durumb cb-gir-cik
    else
       initialize rap-cout-tarihi
       move 0 to vis-1
       display acc-cout-gun acc-cout-ay acc-cout-yil
               lb-duruma lb-durumb cb-gir-cik   
    end-if.
*
 bakiye-bul.
    evaluate konuk-fol-kodu
    when "R"
       perform romhrk-bakiye-bul
    when "E"
       perform exthrk-bakiye-bul
    end-evaluate.
*
 romhrk-bakiye-bul.
    open input romhrk
    initialize romhrk-rec bakiye
    move konuk-folio              to romhrk-folio
    start romhrk key not < romhrk-anah invalid 
         continue 
    not invalid 
    perform with test after until fs-romhrk = "10"
    read romhrk next no lock end move "10" to fs-romhrk
    not at end  
           if romhrk-folio <> konuk-folio
               exit perform 
           end-if
           if romhrk-fatura-no not = zeroes
               exit perform cycle 
           end-if
           if link-var = 3
               if romhrk-ref <> link-pencere
                 continue 
*                  exit perform cycle 
               end-if 
           end-if


           initialize folref-rec
           move konuk-folio       to folref-folio
           move romhrk-ref        to folref-ref
           read folref no lock invalid 
                continue 
           end-read                
                move folref-profil-anah to p-profil-anah(folref-ref)
                move 1                  to p-var(folref-ref)
                evaluate romhrk-ba
                when "B"
                        initialize depkod-rec
                        move romhrk-depkod     to depkod-anah
                        read depkod no lock invalid 
                             continue 
                        end-read 
 
                        if depkod-turu = 2  
                           initialize depkod-rec
                           move romhrk-corr-depkod to depkod-anah
                           read depkod no lock invalid 
                              continue 
                           not invalid 
                               compute alacak-bakiye(folref-ref) = alacak-bakiye(folref-ref) - romhrk-tl-tutar
                                if DEPKOD-FATURA-TAKIP = "E" 
                                        compute   p-tutar(folref-ref) =   p-tutar(folref-ref) - romhrk-tl-tutar
                                  end-if
                           end-read 
                        else
                           compute borc-bakiye(folref-ref) = borc-bakiye(folref-ref) + romhrk-tl-tutar 
                            if DEPKOD-FATURA-TAKIP = "E" 
                                        compute   p-tutar(folref-ref) =   p-tutar(folref-ref) + romhrk-tl-tutar
                                  end-if
                        end-if                       
                when "A"
                        initialize depkod-rec
                        move romhrk-depkod     to depkod-anah
                        read depkod no lock invalid 
                             continue 
                        end-read 
 
                        if depkod-turu = 2
                           initialize depkod-rec
                           move romhrk-corr-depkod to depkod-anah
                           read depkod no lock invalid 
                              continue 
                           not invalid 
                               compute borc-bakiye(folref-ref) = borc-bakiye(folref-ref) - romhrk-tl-tutar |21022014
                               compute p-tutar(folref-ref) =   p-tutar(folref-ref) - romhrk-tl-tutar |21022014
                           end-read 
                        else
                           compute alacak-bakiye(folref-ref) = alacak-bakiye(folref-ref) + romhrk-tl-tutar 
                        end-if
                end-evaluate
                compute fark(folref-ref) = borc-bakiye(folref-ref) - alacak-bakiye(folref-ref) 
                move fark(folref-ref)          to p-bakiye(folref-ref)                        
    end-read 
    end-perform
    end-start
    close romhrk
    .
*
 exthrk-bakiye-bul.
    open input exthrk  
    initialize exthrk-rec bakiye  
    move konuk-folio              to exthrk-folio
    start exthrk key not < exthrk-anah invalid 
         continue 
    not invalid 
    perform with test after until fs-exthrk = "10"
    read exthrk next no lock end move "10" to fs-exthrk
    not at end  
           if exthrk-folio <> konuk-folio
               exit perform 
           end-if 
           if exthrk-fatura-no not = zeroes
               exit perform cycle 
           end-if 
           if link-var = 3
               if exthrk-ref <> link-pencere
                 continue
*                  exit perform cycle 
               end-if 
           end-if 

           initialize folref-rec
           move konuk-folio       to folref-folio
           move exthrk-ref        to folref-ref
           read folref no lock invalid 
                continue 
           end-read  
                move folref-profil-anah to p-profil-anah(folref-ref)
                move 1                  to p-var(folref-ref)
                evaluate exthrk-ba
                when "B"
                        initialize depkod-rec
                        move exthrk-depkod         to depkod-anah
                        read depkod no lock invalid 
                             continue 
                        end-read 
 
                        if depkod-turu = 2   
                           initialize depkod-rec
                           move exthrk-corr-depkod to depkod-anah
                           read depkod no lock invalid 
                              continue 
                           not invalid 
                               compute alacak-bakiye(folref-ref) = alacak-bakiye(folref-ref) - exthrk-tl-tutar
                                if DEPKOD-FATURA-TAKIP = "E" 
                                        compute   p-tutar(folref-ref) =   p-tutar(folref-ref) - exthrk-tl-tutar
                                  end-if
                           end-read 
                        else
                           compute borc-bakiye(folref-ref) = borc-bakiye(folref-ref) + exthrk-tl-tutar 
                            if DEPKOD-FATURA-TAKIP = "E" 
                                        compute   p-tutar(folref-ref) =   p-tutar(folref-ref) + exthrk-tl-tutar
                                  end-if
                        end-if                        
                when "A"
                        initialize depkod-rec
                        move exthrk-depkod     to depkod-anah
                        read depkod no lock invalid 
                             continue 
                        end-read 
 
                        if depkod-turu = 2
                           initialize depkod-rec
                           move exthrk-corr-depkod to depkod-anah
                           read depkod no lock invalid 
                              continue 
                           not invalid 
                               compute borc-bakiye(folref-ref) = borc-bakiye(folref-ref) - exthrk-tl-tutar
                               compute p-tutar(folref-ref) =   p-tutar(folref-ref) - exthrk-tl-tutar |21022014
                           end-read 
                        else
                           compute alacak-bakiye(folref-ref) = alacak-bakiye(folref-ref) + exthrk-tl-tutar
                        end-if 
                end-evaluate
                compute fark(folref-ref) = borc-bakiye(folref-ref) - alacak-bakiye (folref-ref)
                move fark(folref-ref)                            to p-bakiye(folref-ref)               
    end-read 
    end-perform
    end-start
    close exthrk  .
*
 gd-sec-Ex-Other.
    evaluate key-status
     when 6|ctrl - f folio
          inquire gd-sec,cursor-y in sayac
          inquire gd-sec(sayac,4),
               cell-data in ydk-konuk-folio
           perform folio-cagir
    end-evaluate.
*
 folio-cagir.
     initialize dokcagir-tasi
     set dokcagir-tasi-call-folio1      to true
     move ydk-konuk-folio               to dokcagir-konuk-folio
     perform dokcagir-call
     move dokcagir-konuk-folio          to konuk-folio.
*
 dokcagir-call.
     call "/asya/ytl/obj/otel/dokcagir.asy" using dokcagir-tasi
          on exception 
             perform callerr-proc
          not on exception
             cancel "/asya/ytl/obj/otel/dokcagir.asy"
     end-call.
*
 ozet-fatura-hazirla.   
     perform alt-grid-baslik-yukle
     perform alt-grid-ekle
     perform alt-grid-baslik-yukle      
     perform dep-top-grid-yukle

     open input deptop depkod
     initialize deptop-rec etutar 
     move 1   to kayit-sayi
     start deptop key not < deptop-anah invalid 
          continue 
     not invalid 
     perform with test after until fs-deptop = "10"
     read deptop next no lock end move "10" to fs-deptop
     not at end 
          initialize  depkod-rec
          move deptop-depkod                 to  depkod-anah
          read depkod no lock invalid 
               move "Tanimsiz..."            to depkod-adi
          end-read
          add 1 to kayit-sayi
          initialize gd-yaz-rec
          move gd-sec-tipi         to gd-yaz-tipi
          move deptop-depkod       to gd-yaz-dep

          initialize depkod-rec 
          move deptop-depkod       to depkod-anah
          read depkod no lock invalid
               move "Tanimsiz.."   to depkod-adi
          end-read 
               move depkod-adi     to gd-yaz-dep-adi
                
          move deptop-matrah-tutari       to etutar
          move etutar              to gd-yaz-matrah

          move deptop-kdv-tutari   to etutar
          move etutar              to gd-yaz-kdv

          move deptop-tutar     to etutar
          move etutar              to gd-yaz-tutar
           
          modify gd-yaz(kayit-sayi,1)
               record-to-add   = gd-yaz-rec
               bitmap          = artieksi-bmp
               bitmap-number   = 2 
               bitmap-width    = 16
               bitmap-trailing = 1
               hidden-data     = gd-yaz-rec
     end-read 
     end-perform
     end-start
     close deptop depkod
     modify gd-yaz,mass-update = 0
     .
*
 detay-fatura-hazirla.
     initialize toplam-kdv-tutari matrah-tutari alt-toplam genel-toplam  
     perform alt-grid-baslik-yukle
     perform alt-grid-ekle.
*
 fatura-bilgisi-al.    
     initialize rap-adi rap-soyadi rap-adr1 rap-adr2 rap-il rap-ilce 
                rap-pasno rap-vno rap-tcno rap-vd rap-ulke rap-e-mail rap-telefon
     open input musteri folref polisxml konuk firma ulke yanrez
     initialize musteri-rec 
     move gd-sec-folio  to folref-folio
     if link-var = 3
        move link-pencere  to folref-ref
     else
        move gd-sec-pen    to folref-ref
     end-if 
        
     read folref no lock invalid 
          initialize konuk-rec
          move gd-sec-folio to konuk-folio
          read konuk no lock invalid 
               continue 
          not invalid 
              if konuk-rez-no > 0  or konuk-extra-rez-no > 0                
                 initialize polisxml-rec
                 if konuk-extra-rez-no > 0
                    move konuk-extra-rez-no to polisxml-rezno
                 else 
                   move konuk-rez-no   to polisxml-rezno
                 end-if 
                 move 1              to polisxml-sirano
                 read polisxml no lock invalid 
                      move konuk-adi    to rap-adi
                      move konuk-soyadi to rap-soyadi
                 not invalid 
                      move polisxml-adi        to rap-adi
                      move polisxml-soyadi     to rap-soyadi
                      initialize rap-vno
                      if polisxml-uyruk(1:2) = "TC"
                         move polisxml-tckimlikno to stc
                         move stc                 to rap-tcno
                         initialize rap-pasno
                      else
                         move polisxml-kseri      to rap-pasno
                         initialize rap-tcno
                      end-if 
                      move polisxml-adr           to rap-adr1
                      move polisxml-nil           to rap-il
                      move polisxml-nilce         to rap-ilce                      
                 end-read 

                 |||likya world istegi firat 20/07/2020
                 initialize yanrez-rec 
                 if konuk-extra-rez-no > 0
                    move konuk-extra-rez-no to yanrez-rezno
                 else 
                   move konuk-rez-no   to yanrez-rezno
                 end-if 
                 move 1              to yanrez-sirano
                 read yanrez no lock invalid                                               
                      continue                                                             
                 not invalid
                     initialize musteri-rec 
                     move yanrez-profil-sirket to musteri-sirket
                     move yanrez-profil-no     to musteri-no
                     read musteri no lock invalid 
                          continue
                     not invalid
                         if genel2-fat-bilgi-kisisel = 1
                            if rap-adr1 = spaces or rap-adr1(1:1) = "." 
                               move musteri-kis-adrs  to rap-adr1
                            end-if
                            if rap-adr2 = spaces or rap-adr2(1:1) = "." 
                               move musteri-kis-adrs1 to rap-adr2
                            end-if
                            if rap-il = spaces or rap-il(1:1) = "." 
                               move musteri-kis-il    to rap-il
                            end-if
                            if rap-ilce = spaces or rap-ilce(1:1) = "." 
                               move musteri-kis-ilce  to rap-ilce
                            end-if
                         end-if
                     end-read 
                 end-read 
                 |||
              end-if 
          end-read 
     not invalid
          initialize musteri-rec 
          move folref-profil-sirket  to musteri-sirket
          move folref-profil-no      to musteri-no
          read musteri no lock invalid 
                 initialize konuk-rec
                 move gd-sec-folio to konuk-folio
                 read konuk no lock invalid 
                      continue 
                 not invalid 
                     if konuk-rez-no > 0  or konuk-extra-rez-no > 0                
                        initialize polisxml-rec
                        if konuk-extra-rez-no > 0
                           move konuk-extra-rez-no       to polisxml-rezno
                        else 
                          move konuk-rez-no              to polisxml-rezno
                        end-if 
                        move 1                           to polisxml-sirano
                        read polisxml no lock invalid 
                             move konuk-adi              to rap-adi
                             move konuk-soyadi           to rap-soyadi
                        not invalid 
                             move polisxml-adi           to rap-adi
                             move polisxml-soyadi        to rap-soyadi
                             initialize rap-vno
                             if polisxml-uyruk(1:2) = "TC"
                                move polisxml-tckimlikno to stc
                                move stc                 to rap-tcno
                                initialize rap-pasno 
                             else
                                move polisxml-kseri      to rap-pasno
                                initialize rap-tcno
                             end-if 
                             move polisxml-adr           to rap-adr1
                             move polisxml-nil           to rap-il
                             move polisxml-nilce         to rap-ilce
                        end-read 

                        |||likya world istegi firat 20/07/2020
                        initialize yanrez-rec 
                        if konuk-extra-rez-no > 0
                           move konuk-extra-rez-no to yanrez-rezno
                        else 
                          move konuk-rez-no   to yanrez-rezno
                        end-if 
                        move 1              to yanrez-sirano
                        read yanrez no lock invalid                                               
                             continue                                                             
                        not invalid
                            initialize musteri-rec 
                            move yanrez-profil-sirket to musteri-sirket
                            move yanrez-profil-no     to musteri-no
                            read musteri no lock invalid 
                                 continue
                            not invalid
                                if genel2-fat-bilgi-kisisel = 1
                                   if rap-adr1 = spaces or rap-adr1(1:1) = "." 
                                      move musteri-kis-adrs  to rap-adr1
                                   end-if
                                   if rap-adr2 = spaces or rap-adr2(1:1) = "." 
                                      move musteri-kis-adrs1 to rap-adr2
                                   end-if
                                   if rap-il = spaces or rap-il(1:1) = "." 
                                      move musteri-kis-il    to rap-il
                                   end-if
                                   if rap-ilce = spaces or rap-ilce(1:1) = "." 
                                      move musteri-kis-ilce  to rap-ilce
                                   end-if
*                                   move musteri-kis-adrs  to rap-adr1
*                                   move musteri-kis-adrs1 to rap-adr2
*                                   move musteri-kis-il    to rap-il
*                                   move musteri-kis-ilce  to rap-ilce
                                end-if
                            end-read 
                        end-read 
                        |||

                     end-if 
                 end-read
          not invalid
                  if musteri-unvan1 not = spaces or 
                     musteri-vno not = spaces or 
                     musteri-vdairesi not = spaces                        
                     move musteri-unvan1     to rap-adi   
                     move musteri-unvan2     to rap-soyadi
                     move musteri-adres1     to rap-adr1  
                     move musteri-adres2     to rap-adr2  
                     move musteri-vdairesi   to rap-vd 
                     move function numval(musteri-vno)        to stcno
                     if stcno > 9999999999
                        move stcno              to rap-tcno
                        move musteri-il         to rap-il
                        move musteri-ilce       to rap-ilce
                        move musteri-fat-ulke   to rap-ulke
                        move musteri-e-mail     to rap-e-mail
                        if musteri-tel1 not = spaces
                           move musteri-tel1    to rap-telefon
                        end-if
                        if musteri-tel2 not = spaces
                           move musteri-tel2    to rap-telefon
                        end-if
                        if musteri-tel3 not = spaces
                           move musteri-tel3    to rap-telefon
                        end-if
                        if musteri-gsm not = spaces
                           move musteri-gsm    to rap-telefon
                        end-if
                        initialize rap-pasno rap-vno
                     else
                        if musteri-vno not = spaces
                           move function numval(musteri-vno)        to svno  
                           move svno                                to rap-vno
                           if svno = 0
                              move musteri-vno    to rap-vno
                           end-if 
                           initialize rap-tcno
                        else
                           if musteri-kim-uyruk(1:2) = "TC"
                              move musteri-kim-tcno to stc
                              move stc                  to rap-tcno
                              initialize rap-pasno 
                           else
                              move musteri-seri-no       to rap-pasno
                              initialize rap-tcno
                           end-if 
        
                             |  move musteri-kim-tcno   to stc
                             |  move stc                to rap-tcno 
                            initialize rap-vno
                        end-if 
                        move musteri-il         to rap-il
                        move musteri-ilce       to rap-ilce
                        move musteri-fat-ulke   to rap-ulke
                        move musteri-e-mail     to rap-e-mail
                        if musteri-tel1 not = spaces
                           move musteri-tel1    to rap-telefon
                        end-if
                        if musteri-tel2 not = spaces
                           move musteri-tel2    to rap-telefon
                        end-if
                        if musteri-tel3 not = spaces
                           move musteri-tel3    to rap-telefon
                        end-if
                        if musteri-gsm not = spaces
                           move musteri-gsm    to rap-telefon
                        end-if

                        |||likya world istegi firat 20/07/2020
                         if genel2-fat-bilgi-kisisel = 1
                            if rap-adr1 = spaces or rap-adr1(1:1) = "." 
                               move musteri-kis-adrs  to rap-adr1
                            end-if
                            if rap-adr2 = spaces or rap-adr2(1:1) = "." 
                               move musteri-kis-adrs1 to rap-adr2
                            end-if
                            if rap-il = spaces or rap-il(1:1) = "." 
                               move musteri-kis-il    to rap-il
                            end-if
                            if rap-ilce = spaces or rap-ilce(1:1) = "." 
                               move musteri-kis-ilce  to rap-ilce
                            end-if
*                            move musteri-kis-adrs  to rap-adr1
*                            move musteri-kis-adrs1 to rap-adr2
*                            move musteri-kis-il    to rap-il
*                            move musteri-kis-ilce  to rap-ilce
                         end-if
                        |||
                     end-if
                  else
                     move musteri-adi           to rap-adi   
                     move musteri-soyadi        to rap-soyadi
                     move musteri-kim-adrs      to rap-adr1  
                     move musteri-kim-adrs1     to rap-adr2  
                     move musteri-vdairesi      to rap-vd 
        
                     if musteri-kim-uyruk(1:2) = "TC"
                           move musteri-kim-tcno to stc
                           move stc                  to rap-tcno
                           initialize rap-pasno 
                     else
                           move musteri-seri-no       to rap-pasno
                           initialize rap-tcno
                     end-if 
                     initialize rap-vno rap-ulke
        
                     move musteri-kim-il     to rap-il
                     move musteri-kim-ilce   to rap-ilce 
                     if musteri-tel1 not = spaces
                        move musteri-tel1    to rap-telefon
                     end-if
                     if musteri-tel2 not = spaces
                        move musteri-tel2    to rap-telefon
                     end-if
                     if musteri-tel3 not = spaces
                        move musteri-tel3    to rap-telefon
                     end-if
                     if musteri-gsm not = spaces
                        move musteri-gsm    to rap-telefon
                     end-if
                     move musteri-e-mail    to rap-e-mail
                     |||likya world istegi firat 20/07/2020
                     if genel2-fat-bilgi-kisisel = 1
                        if rap-adr1 = spaces or rap-adr1(1:1) = "." 
                           move musteri-kis-adrs  to rap-adr1
                        end-if
                        if rap-adr2 = spaces or rap-adr2(1:1) = "." 
                           move musteri-kis-adrs1 to rap-adr2
                        end-if
                        if rap-il = spaces or rap-il(1:1) = "." 
                           move musteri-kis-il    to rap-il
                        end-if
                        if rap-ilce = spaces or rap-ilce(1:1) = "." 
                           move musteri-kis-ilce  to rap-ilce
                        end-if
*                        move musteri-kis-adrs  to rap-adr1
*                        move musteri-kis-adrs1 to rap-adr2
*                        move musteri-kis-il    to rap-il
*                        move musteri-kis-ilce  to rap-ilce
                     end-if
                     |||

                   end-if 
           end-read 
     end-read
     
     if (rap-vno = spaces or kurum-fat = 1) and 
        yedek-konuk-firma not = spaces and 
        (link-pencere = 1  or kurum-fat = 1 ) and sahis-fat = 0      
         initialize firma-rec
         move yedek-konuk-firma   to firma-kodu
         read firma no lock invalid 
              continue 
         not invalid 
             initialize musteri-rec 
*             move firma-profil-anah  to m-profil     |firat m-profil bos gorunuyor.. 17/08/2020
             move firma-profil-sirket to musteri-sirket 
             move firma-profil-no     to musteri-no
             read musteri no lock invalid 
                  continue 
             not invalid 
                  if (musteri-vno not = spaces and musteri-no > 0) or kurum-fat = 1
                    move musteri-unvan1     to rap-adi   
                    move musteri-unvan2     to rap-soyadi
                    move musteri-adres1     to rap-adr1  
                    move musteri-adres2     to rap-adr2  
                    move musteri-vdairesi   to rap-vd 
                    if musteri-vno not = spaces                                              
                       move function numval(musteri-vno)        to svno
                       move svno                                to rap-vno   
                       initialize rap-tcno rap-pasno
                    else 
                       move musteri-kim-tcno   to stc
                       move stc                to rap-tcno                       
                    end-if 
                    move musteri-il         to rap-il
                    move musteri-ilce       to rap-ilce
                    move musteri-fat-ulke   to rap-ulke
                    move musteri-e-mail     to rap-e-mail
                    if musteri-tel1 not = spaces
                       move musteri-tel1    to rap-telefon
                    end-if
                    if musteri-tel2 not = spaces
                       move musteri-tel2    to rap-telefon
                    end-if
                    if musteri-tel3 not = spaces
                       move musteri-tel3    to rap-telefon
                    end-if
                    if musteri-gsm not = spaces
                       move musteri-gsm    to rap-telefon
                    end-if
                     |||likya world istegi firat 20/07/2020
                     if genel2-fat-bilgi-kisisel = 1
                        if rap-adr1 = spaces or rap-adr1(1:1) = "." 
                           move musteri-kis-adrs  to rap-adr1
                        end-if
                        if rap-adr2 = spaces or rap-adr2(1:1) = "." 
                           move musteri-kis-adrs1 to rap-adr2
                        end-if
                        if rap-il = spaces or rap-il(1:1) = "." 
                           move musteri-kis-il    to rap-il
                        end-if
                        if rap-ilce = spaces or rap-ilce(1:1) = "." 
                           move musteri-kis-ilce  to rap-ilce
                        end-if
*                        move musteri-kis-adrs  to rap-adr1
*                        move musteri-kis-adrs1 to rap-adr2
*                        move musteri-kis-il    to rap-il
*                        move musteri-kis-ilce  to rap-ilce
                     end-if
                     |||
                  end-if 
             end-read 
         end-read 
     end-if

         if rap-adr1 = spaces 
                               move "."  to rap-adr1
                            end-if
                            if rap-adr2 = spaces 
                               move "." to rap-adr2
                            end-if
                            if rap-il = spaces 
                               move "."    to rap-il
                            end-if
                            if rap-ilce = spaces 
                               move "."  to rap-ilce
                            end-if


        if rap-e-mail = spaces 
                               move "@"  to rap-e-mail
                            end-if
          if rap-ulke = spaces 
                               move "."  to rap-ulke
                            end-if


     close musteri folref polisxml konuk firma ulke yanrez
 
     perform ekran-goster
        
     perform cari-ata.
*
 ekran-goster.
      display acc-adi,acc-soyadi,acc-adr1,acc-adr2,acc-ilce,acc-il,acc-ulke,
             acc-vd,acc-vno acc-tcno acc-pasno acc-e-mail acc-telefon.
*
 Form1-Ta-1-Aft-Tabchg-Display.
     evaluate Form1-Ta-1-Value
     when 2                    
        perform ozet-fatura-hazirla        
     end-evaluate.
*
 fat-bas. 
     open i-o genelfis doviz alsat alsatek takasisim muh-kodlar  
     move 1 to genelfis-anahtar
     read genelfis no lock invalid
       accept print-no of genelfis from time
      not invalid
       add 1 to print-no of genelfis
       rewrite genelfis-rec end-rewrite
     end-read
     close genelfis


     initialize dokumer-rec dokumer-anah dokumer-ozellikler-rec
                dokumer-dosya 
     set  dokumer-asya-set to true
     move print-no         to dokumer-dosya-adi
     open output dokumer
     add 1 to dokumer-anah
     write dokumer-rec
       
        perform  fat-dok
      
     set dokumer-yazici-text to true
       move "H"                to dokumer-genel-baslik-yaz
       if cb-yazici-tipi(1:1) <> 'S'
          move "E"                to faturaya-gonder
       end-if

     close dokumer doviz alsat alsatek takasisim muh-kodlar
     if efat-degil not = 1  
        if genel-e-arsiv-gecis-tarihi <= rap-fat-tar and
           genel-e-arsiv-gecis-tarihi > "20150101"
                 continue 
**              perform e-arsiv-fat-dok
        else   
           call dokumer-prog on exception
                 move   dokumer-prog to  hatali-program-adi
                   initialize faturaya-gonder
                perform callerr-proc
           not on exception
                   initialize faturaya-gonder
                cancel dokumer-prog
           end-call
        end-if 
     end-if.
*
 fat-bas2.
     open i-o genelfis doviz alsat alsatek takasisim muh-kodlar 
     move 1 to genelfis-anahtar
     read genelfis no lock invalid
       accept print-no from time
      not invalid
       add 1 to print-no
       rewrite genelfis-rec end-rewrite
     end-read
     close genelfis


     initialize dokumer-rec dokumer-anah dokumer-ozellikler-rec
                dokumer-dosya 
     set  dokumer-asya-set to true
     move print-no         to dokumer-dosya-adi
     open output dokumer
     add 1                 to dokumer-anah
     write dokumer-rec
        call "c$sleep" using 1

        perform  fat-dok
               
     set dokumer-yazici-text to true
     move "H"                to dokumer-genel-baslik-yaz
     move "E"                to faturaya-gonder     

     close dokumer doviz alsat alsatek takasisim muh-kodlar
     if efat-degil not = 1  
        if genel-e-arsiv-gecis-tarihi <= rap-fat-tar and
           genel-e-arsiv-gecis-tarihi > "20150101"              
             continue  
        else
*          call dokumer-prog using dokumer-link-bilgiler on exception
          call dokumer-prog on exception
                  initialize faturaya-gonder
               perform callerr-proc
          not on exception
                  initialize faturaya-gonder
               cancel dokumer-prog
          end-call
        end-if 
     end-if.
*
 fat-dok.   
       initialize ikinci-fatura            
       move 1 to i efat-sira 
       initialize dokumer-rec  text-oku-rec
       open input text-oku DEPKOD depkod2 odalar,
       perform with test after until fs-text-oku = "10"
       initialize text-oku-2
       read text-oku next no lock end move "10" to fs-text-oku
          not end
          if text-oku-1(1:1) = "#"
            exit perform cycle 
          end-if
 
          add 1 to fatdokum-fat-sira
          initialize dokumer-rec
          if text-oku-1  = "0"
             initialize text-oku-2
          end-if


          if text-oku-1 = "1"
             move rap-fat-yil to eyil
             move rap-fat-ay  to eay
             move rap-fat-gun to egun
              
             inspect text-oku-2 replacing all "[ACENADI_______________________________]" 
                   by rap-adi(1:40) 
             inspect text-oku-2 replacing all "[ACENUNV_______________________________]"  
                   by rap-soyadi(1:40)  
             inspect text-oku-2 replacing all "[ACENADR1______________________________]"  
                   by rap-adr1 (1:40) 
             inspect text-oku-2 replacing all "[ACENADR2______________________________]"  
                   by rap-adr2 (1:40) 
             inspect text-oku-2 replacing all "[ACEN-IL___________]"                     
                   by rap-il(1:20) 
             inspect text-oku-2 replacing all "[ACEN-ILCE_________]"                     
                   by rap-ilce(1:20) 
             inspect text-oku-2 replacing all "[ACENULKE____]"                            
                   by rap-ulke(1:14)  
             inspect text-oku-2 replacing all "[ACENVDA___________]"                      
                   by rap-vd (1:20) 

             if rap-vno not = spaces
             inspect text-oku-2 replacing all "[ACENVNO__________]"                       
                   by rap-vno(1:19)
             else
               if rap-tcno not = spaces
                  move "T.C. No:"     to rap-tcno2(1:8)
                  move rap-tcno       to rap-tcno2(9:)
                  inspect text-oku-2 replacing all "[ACENVNO__________]"                       
                        by rap-tcno2(1:19)
               else
                  move "Pas. No:"      to rap-tcno2(1:8)
                  move rap-pasno       to rap-tcno2(9:)
                  inspect text-oku-2 replacing all "[ACENVNO__________]"                       
                        by rap-tcno2(1:19)                
               end-if 
             end-if 

             inspect text-oku-2 replacing all "[FATTAR__]"                                
                   by etarih
             accept zaman from time
             move zaman(1:2)   to esaat
             move zaman(3:2)   to edakika
             move zaman(5:2)   to esaniye 

             inspect text-oku-2 replacing all "[FATZ__]"                                
                   by ezaman
             move rap-fat-no   to xrap-fat-no
             inspect text-oku-2 replacing all "[FATNO_]"                                
                   by xrap-fat-no

                inspect text-oku-2 replacing all "[ACIKLAMA____________________]"                                
                   by rap-ack(1:30)

                inspect text-oku-2 replacing all "[ACIKLAMA2______________________________________________________________________________]"                                
                   by rap-ack(31:89)        

          end-if
          if text-oku-1 = "2"            
             if det-ara-tl-tut(i) not = zeroes           
                move det-ara-giryil(i)  to cin-yil
                move det-ara-giray(i)   to cin-ay
                move det-ara-girgun(i)  to cin-gun
                if det-ara-giryil(i) = zeroes
                   inspect text-oku-2 replacing all "[GIRTAR__]" by spaces
                 else  
                  inspect text-oku-2 replacing all "[GIRTAR__]" by d03-detay
                end-if
              
                move det-ara-cikyil(i)  to cout-yil
                move det-ara-cikay(i)   to cout-ay
                move det-ara-cikgun(i)  to cout-gun
                if det-ara-cikyil(i) = zeroes
                   inspect text-oku-2 replacing all "[CIKTAR__]"  by spaces
                else
                   inspect text-oku-2 replacing all "[CIKTAR__]"  by d04-detay
                end-if 
                 if genel-uzun-oda-no-kullanilsin = 1 
                                     initialize oda-uzun
                                 move det-ara-oda(i)       to  odalar2-no 
                                 read odalar2 no lock key odalar2-anah1  invalid continue
                                 not invalid
                                 move det-ara-oda(i)   to o-uzun

                                  end-read
                         inspect text-oku-2 replacing all " [OD]"        by o-uzun
                       else
                       inspect text-oku-2 replacing all "[OD]"        by det-ara-oda(i)
                     end-if
                inspect text-oku-2 replacing all "[OD]"        by det-ara-oda(i)

                move det-ara-buyuk(i)       to 3-z
                inspect text-oku-2 replacing all "[B]"         by  3-z

                move det-ara-kucuk(i)       to 3-z
                inspect text-oku-2 replacing all "[K]"         by  3-z

                move det-ara-pan-kod(i)    to 2-x,
                inspect text-oku-2 replacing all "PP"          by  2-x


                   inspect text-oku-2 replacing all "[VOUCHER_]"       by det-ara-voucher(i)(1:10) 
                   inspect text-oku-2 replacing all "[VOUCHER__]"      by det-ara-voucher(i)(1:11) 
                   inspect text-oku-2 replacing all "[VOUCHER___]"     by det-ara-voucher(i)(1:12) 
                   inspect text-oku-2 replacing all "[VOUCHER____]"    by det-ara-voucher(i)(1:13) 
                   inspect text-oku-2 replacing all "[VOUCHER_____]"   by det-ara-voucher(i)(1:14)  
                   inspect text-oku-2 replacing all "[VOUCHER______]"  by det-ara-voucher(i)(1:15)
                   inspect text-oku-2 replacing all "[VOUCHER_______]" by det-ara-voucher(i)(1:16)
                   inspect text-oku-2 replacing all "[VOUCHER___________]" by det-ara-voucher(i)(1:20)





                inspect text-oku-2 replacing all "[MUSADI__]" by det-ara-adi(i)
                inspect text-oku-2 replacing all "[MUSSOY__]" by det-ara-soy(i)

                initialize tl-tut  
                move det-ara-tl-tut(i) to tl-tut
                move tl-tut            to 13-z
                inspect text-oku-2 replacing all "[TLTUTAR____]"  by  13-z 
                if det-ara-ulke-adi(i) not = spaces
                   inspect text-oku-2 replacing all "[ULKE_ADI_____]" by det-ara-ulke-adi(i)
                else
                   move spaces  to det-ara-ulke-adi(i)
                   inspect text-oku-2 replacing all "[ULKE_ADI_____]" by det-ara-ulke-adi(i)
                end-if
                


                 if bos-satir = 1 | || alba ankara 04.07.2015 bos-satir var ise hicibr detay cikmayacak  
                    initialize text-oku-2
                 end-if
                  if efat-degil = 1 and ikinci-fatura not = 1                
                     initialize alsat-rec
                     move text-oku-2(5:)   to alsat-satir-aciklama-yedek
*                     perform e-fatura-al-sat-yaz
*                     add 1 to efat-sira 
                   end-if 


             else
                initialize text-oku-2
             end-if
             add 1 to i
             
          end-if
            
             if text-oku-1 = "3"  and detaylar-atildi = 0  and ikinci-fatura not = 1 
                move 1  to detaylar-atildi
                perform varying iii 
                        from 1 
                        by 1 
                        until iii > 15 
                           if aladeptutar(iii) > 0
************************************************depler
                              move aladeptutar(iii) to 8-z
                              string alac-satirlar delimited by "              "                               
                                    aladepadi(iii) delimited by "    " 
                                    "-" delimited by size  
                                    8-z delimited by size
                                    " -" delimited by size   
                              into alac-satirlar 
                           end-if 
                           if bordeptutar(iii) > 0                               
                             initialize alsat-rec 
                             if  genel-netsis-earsiv of genel-rec  = 1 
                                 move bordepadi(iii)     to alsat-satir-aciklama2
                                 move bordeptutar(iii)   to 13-z
                                 move 13-z               to alsat-satir-aciklama(160:15)
                                 move "*_*#0,00 Z"       to alsat-satir-aciklama(150:10)
                                 move "X"                to alsat-satir-aciklama(176:1)
                             else
                                 move bordepadi(iii)     to alsat-satir-aciklama(20:19)
                                 move bordeptutar(iii)   to 13-z
                                 move 13-z               to alsat-satir-aciklama(40:15)
                             end-if
                                                           
                              inspect dizi-isim replacing
                                             trailing spaces by low-values
                               
                              initialize takasisim-rec isim-sayi
                              start takasisim key not < takasisim-anah invalid 
                                  continue 
                              not invalid 
                              perform with test after until fs-takasisim = "10"
                              read takasisim next no lock end move "10"  to fs-takasisim
                              not at end 
                                      add 1                     to isim-sayi
                                      if isim-sayi < 15
                                         move takasisim-adi        to dizi-adi(isim-sayi)                                     
                                         move takasisim-soy        to dizi-soy(isim-sayi)
                                         move takasisim-oda        to dizi-oda(isim-sayi)
                                         move takasisim-gir-yil    to dizi-gir-yil(isim-sayi)
                                         move takasisim-gir-ay     to dizi-gir-ay(isim-sayi)
                                         move takasisim-gir-gun    to dizi-gir-gun(isim-sayi)
                                         move takasisim-cik-yil    to dizi-cik-yil(isim-sayi)
                                         move takasisim-cik-ay     to dizi-cik-ay(isim-sayi)
                                         move takasisim-cik-gun    to dizi-cik-gun(isim-sayi)
                                         move takasisim-voucher to  dizi-voucher(isim-sayi)
                                      end-if 
                              end-read 
                              end-perform
                              end-start

                              if bos-satir <> 1  || alba ankara 04.07.2015
                                      move all low-values to satirlar
                                      inspect dizi-isim replacing
                                                     trailing spaces by low-values
                                      string satirlar                                
                                            dizi-isim delimited by low-values                                    
                                      into satirlar
                              end-if 
                                if  genel-netsis-earsiv of genel-rec  = 1 
                                    initialize  alsat-satir-aciklama(1:149)
                                    inspect satirlar replacing
                                            all low-values by spaces 
                                    string  "WOda/Misafir:"  delimited by size
                                        dizi-isim-occ(1) delimited by "                               "
                                    into     alsat-satir-aciklama(1:149)
                                    
                                else
                                    move satirlar           to alsat-satir-aciklama(57:)
                              end-if
*/*********************************************para iade e faturada çýkmasýn alba ankara *****************************************************
                              initialize depkod-rec
                              move bordepkodu(iii)    to depkod-anah 
                              read depkod no lock invalid 
                                   continue 
                              end-read    
***                              stop " " 
                                  if depkod-turu not = 3
                    move bordep-kdv(iii)    to alsat-kdv-orani
                  

                    move  bordep-kdv-matrah(iii)   to     
                               alsat-matrah   alsat-gercek-matrah    

                    move  bordep-kdv-tutar(iii)    to    
                                          alsat-kdv-tutar  
                    move  bordep-kv-tutar(iii)     to  
                                       alsat-konaklama-vergisi-tutar      
                     move  bordep-kv-matrah(iii)    to   
                                         alsat-konaklama-vergisi-matrah 

                                        

                                     compute alsat-kdvli =         bordeptutar(iii)     -  bordep-kv-tutar(iii)


                  if (bordep-kv-matrah(iii))  > 0
                      move 2                        to    
                                  alsat-konaklama-vergisi-oran 
                                  else
                           move 0                       to    
                                  alsat-konaklama-vergisi-oran 

                    end-if
                                      
                                        
                                                          
                                       
               


                                      
                                  
*                                      if (room-kdv-yok = 1 and depkod-tipi = 2) or (extra-kdv-yok = 1 and depkod-tipi = 3)
*                                             move 0  to alsat-kdv-orani
*                                      end-if 
*                                      compute alsat-matrah rounded = alsat-kdvli / ((100 + alsat-kdv-orani) /100) 
                                      if fat-turu-value(1:1) = "F" | test fatura alsata yazmasýn
                                         perform e-fatura-al-sat-yaz
                                      end-if
                                      add 1 to efat-sira
                                      initialize yed-alsat-ana-anahtar | son kayit para iade olursa 
                                      move alsat-ana-anahtar     to yed-alsat-ana-anahtar | son kayit para iade olursa
                                  else  | son kayit para iade olursa
                                      move yed-alsat-ana-anahtar to alsat-ana-anahtar | son kayit para iade olursa
                                  end-if  
*/*********************************************para iade e faturada çýkmasýn alba ankara *****************************************************                             
                           end-if 
                 end-perform                
             end-if

             if text-oku-1 = "3"  
                                 
                  inspect text-oku-2 replacing all "[BORC_ADI_1_______]"                                
                  by bordepadi(1)                  
                  move bordeptutar(1) to 13-z
                  inspect text-oku-2 replacing all "[B1TUTAR____]"                                
                  by 13-z
                 
                  inspect text-oku-2 replacing all "[BORC_ADI_2_______]"                                
                  by bordepadi(2)                  
                  move bordeptutar(2) to 13-z
                  inspect text-oku-2 replacing all "[B2TUTAR____]"                                
                  by 13-z                                
                  inspect text-oku-2 replacing all "[BORC_ADI_3_______]"                                
                  by bordepadi(3)                  
                  move bordeptutar(3) to 13-z
                  inspect text-oku-2 replacing all "[B3TUTAR____]"                                
                  by 13-z
                   
                  inspect text-oku-2 replacing all "[BORC_ADI_4_______]"                                
                  by bordepadi(4)                  
                  move bordeptutar(4) to 13-z
                  inspect text-oku-2 replacing all "[B4TUTAR____]"                                
                  by 13-z

                  inspect text-oku-2 replacing all "[BORC_ADI_5_______]"                                
                  by bordepadi(5)                  
                  move bordeptutar(5) to 13-z
                  inspect text-oku-2 replacing all "[B5TUTAR____]"                                
                  by 13-z

                  inspect text-oku-2 replacing all "[BORC_ADI_6_______]"                                
                  by bordepadi(6)                  
                  move bordeptutar(6) to 13-z
                  inspect text-oku-2 replacing all "[B6TUTAR____]"                                
                  by 13-z

                  inspect text-oku-2 replacing all "[BORC_ADI_7_______]"                                
                  by bordepadi(7)                  
                  move bordeptutar(7) to 13-z
                  inspect text-oku-2 replacing all "[B7TUTAR____]"                                
                  by 13-z

                  inspect text-oku-2 replacing all "[BORC_ADI_8_______]"                                
                  by bordepadi(8)                  
                  move bordeptutar(8) to 13-z
                  inspect text-oku-2 replacing all "[B8TUTAR____]"                                
                  by 13-z

                  inspect text-oku-2 replacing all "[BORC_ADI_9_______]"                                
                  by bordepadi(9)                  
                  move bordeptutar(9) to 13-z
                  inspect text-oku-2 replacing all "[B9TUTAR____]"                                
                  by 13-z

                  inspect text-oku-2 replacing all "[BORC_ADI_10______]"                                
                  by bordepadi(10)
                  move bordeptutar(10) to 13-z
                  inspect text-oku-2 replacing all "[B10TUTAR___]"                                
                  by 13-z

                   inspect text-oku-2 replacing all "[BORC_ADI_11______]"                                
                  by bordepadi(11)
                  move bordeptutar(11) to 13-z
                  inspect text-oku-2 replacing all "[B11TUTAR___]"                                
                  by 13-z

                   inspect text-oku-2 replacing all "[BORC_ADI_12______]"                                
                  by bordepadi(12)
                  move bordeptutar(12) to 13-z
                  inspect text-oku-2 replacing all "[B12TUTAR___]"                                
                  by 13-z

                   inspect text-oku-2 replacing all "[BORC_ADI_13______]"                                
                  by bordepadi(13)
                  move bordeptutar(13) to 13-z
                  inspect text-oku-2 replacing all "[B13TUTAR___]"                                
                  by 13-z

                   inspect text-oku-2 replacing all "[BORC_ADI_14______]"                                
                  by bordepadi(14)
                  move bordeptutar(14) to 13-z
                  inspect text-oku-2 replacing all "[B14TUTAR___]"                                
                  by 13-z

                   inspect text-oku-2 replacing all "[BORC_ADI_15______]"                                
                  by bordepadi(15)
                  move bordeptutar(15) to 13-z

                  inspect text-oku-2 replacing all "[B15TUTAR___]"                                
                  by 13-z
*/alacak departmanlarý yukleniyor                  
                  inspect text-oku-2 replacing all "[ALAC_ADI_1_______]"                                
                  by aladepadi(1)                  
                  move aladeptutar(1) to 13-z
                  inspect text-oku-2 replacing all "[A1TUTAR____]"                                
                  by 13-z

                  inspect text-oku-2 replacing all "[ALAC_ADI_2_______]"                                
                  by aladepadi(2)                  
                  move aladeptutar(2) to 13-z
                  inspect text-oku-2 replacing all "[A2TUTAR____]"                                
                  by 13-z

                  inspect text-oku-2 replacing all "[ALAC_ADI_3_______]"                                
                  by aladepadi(3)                  
                  move aladeptutar(3) to 13-z
                  inspect text-oku-2 replacing all "[A3TUTAR____]"                                
                  by 13-z

                  inspect text-oku-2 replacing all "[ALAC_ADI_4_______]"                                
                  by aladepadi(4)                  
                  move aladeptutar(4) to 13-z
                  inspect text-oku-2 replacing all "[A4TUTAR____]"                                
                  by 13-z

                  inspect text-oku-2 replacing all "[ALAC_ADI_5_______]"                                
                  by aladepadi(5)                  
                  move aladeptutar(5) to 13-z
                  inspect text-oku-2 replacing all "[A5TUTAR____]"                                
                  by 13-z
                
              end-if 
          if text-oku-1(1:1) = "B" 
             if depart-cikma not = 1
                continue 
             else
                initialize text-oku-2
             end-if 
          end-if 
          if text-oku-1 = "4" 
                  inspect text-oku-2 replacing all "K1"                                
                  by kdvler-kodu(1)                  
                  move kdvler-matrah(1) to 13-z
                  inspect text-oku-2 replacing all "[TTLKDVNET1_]"                                
                  by 13-z
                  move kdvler-kdv-tutar(1) to 13-z
                  inspect text-oku-2 replacing all "[TTLKDVSI1__]"                                
                  by 13-z
                  move kdvler-tutar(1) to 13-z
                  inspect text-oku-2 replacing all "[TTLBRUT1___]"                                
                  by 13-z

                  inspect text-oku-2 replacing all "K2"                                
                  by kdvler-kodu(2)                  
                  move kdvler-matrah(2) to 13-z
                  inspect text-oku-2 replacing all "[TTLKDVNET2_]"                                
                  by 13-z
                  move kdvler-kdv-tutar(2) to 13-z
                  inspect text-oku-2 replacing all "[TTLKDVSI2__]"                                
                  by 13-z
                  move kdvler-tutar(2) to 13-z
                  inspect text-oku-2 replacing all "[TTLBRUT2___]"                                
                  by 13-z
             

                  inspect text-oku-2 replacing all "K3"                                
                  by kdvler-kodu(3)                  
                  move kdvler-matrah(3) to 13-z
                  inspect text-oku-2 replacing all "[TTLKDVNET3_]"                                
                  by 13-z
                  move kdvler-kdv-tutar(3) to 13-z
                  inspect text-oku-2 replacing all "[TTLKDVSI3__]"                                
                  by 13-z
                  move kdvler-tutar(3) to 13-z
                  inspect text-oku-2 replacing all "[TTLBRUT3___]"                                
                  by 13-z


                  inspect text-oku-2 replacing all "K4"                                
                  by kdvler-kodu(4)                  
                  move kdvler-matrah(4) to 13-z
                  inspect text-oku-2 replacing all "[TTLKDVNET4_]"                                
                  by 13-z
                  move kdvler-kdv-tutar(4) to 13-z
                  inspect text-oku-2 replacing all "[TTLKDVSI4__]"                                
                  by 13-z
                  move kdvler-tutar(4) to 13-z
                  inspect text-oku-2 replacing all "[TTLBRUT4___]"                                
                  by 13-z


                  inspect text-oku-2 replacing all "K5"                                
                  by kdvler-kodu(5)                  
                  move kdvler-matrah(5) to 13-z
                  inspect text-oku-2 replacing all "[TTLKDVNET5_]"                                
                  by 13-z
                  move kdvler-kdv-tutar(5) to 13-z
                  inspect text-oku-2 replacing all "[TTLKDVSI5__]"                                
                  by 13-z
                  move kdvler-tutar(5) to 13-z
                  inspect text-oku-2 replacing all "[TTLBRUT5___]"                                
                  by 13-z

            
 

*********** KV
            move  kv-matrah-toplam        to 13-z
             inspect text-oku-2 replacing all "[TTLKV_NET__]"     by  13-z

             move  kv-kv-toplam           to 13-z
             inspect text-oku-2 replacing all "[TTLKV_SIT__]"     by  13-z


*************



             move  kdv-matrah-toplam        to 13-z
             inspect text-oku-2 replacing all "[TTLKDVNET__]"     by  13-z

             move  kdv-kdv-toplam           to 13-z
             inspect text-oku-2 replacing all "[TTLKDVSIT__]"     by  13-z

             move  top-TL-TUTAR             to 13-z
             inspect text-oku-2 replacing all "[TTLBRUTT___]"     by  13-z

             if dov-tut > 0
                  move  dov-tut             to 13-z
                  inspect text-oku-2 replacing all "[TDVBRUTT___]"     by  13-z
                  initialize doviz-rec
                  move konuk-doviz               to doviz-kodu
                  read doviz no lock invalid 
                      continue 
                  end-read 
                  inspect text-oku-2 replacing all "[DVZ]"  by  d-kisa-adi               
             else
                  move  spaces             to 13-z
                  inspect text-oku-2 replacing all "[TDVBRUTT___]"     by  13-z  
                  inspect text-oku-2 replacing all "[DVZ]"             by  spaces
             end-if 
             
           end-if

          if text-oku-1 = "5"
             initialize rakam yaziile
             move top-TL-TUTAR to rakam
             call "/asya/ytl/obj/otel/yaziile.asy" using rakam yaziile
                  on exception perform callerr-proc
                  not on exception
                  cancel "/asya/ytl/obj/otel/yaziile.asy" 
             end-call

             inspect text-oku-2 replacing all
             "[YAZI.........................................................................................]"
                                                      by yaziile(1:95)
              move 1 to i
              move 1 to ikinci-fatura
          end-if,
*          if text-oku-1 = "9"
*             move text-oku-2 to yaziile(1:95)
*          end-if
         
              move text-oku-2   to det-filler
              write dokumer-rec from detay
           
          move det-filler   to fatdokum-detay





          move k-kodu-tasi  to fatdokum-staf
          evaluate fat-turu-value(1:1)
          when "F"
             move "FATURA"       to fatdokum-aciklama
          when "T"
             move "TEST FATURA"  to fatdokum-aciklama
          end-evaluate
          if efat-degil = 1
              move "E-FATURA"   to fatdokum-aciklama
          end-if 
          write fatdokum-rec invalid 
              rewrite fatdokum-rec end-rewrite 
          end-write 

       end-read
       end-perform
       close text-oku odalar depkod depkod2.
*    
 max-satir-bul.
       open input text-oku,
       initialize max-satir dep-var
       perform with test after until fs-text-oku = "10"
       read text-oku next no lock end move "10" to fs-text-oku
            not end
              if text-oku-1 = "2"
                   initialize  apo
                   inspect text-oku-2 tallying apo for all "[TLTUTAR____]" 
                   if apo > 0
                     add 1 to max-satir
                  end-if
              end-if
              if text-oku-1 = "3"
                   initialize  dep-varmi
                   inspect text-oku-2 tallying dep-varmi for all "[B1TUTAR____]" 
                   if dep-varmi > 0
                     move 1 to dep-var
                   end-if                    
              end-if 
       end-read
       end-perform,
       close text-oku.
*
 dep-bul.
       open input deptop depkod
       initialize deptop-rec depler k  p fazla-departman-var
       start deptop key not < deptop-anah invalid 
            continue 
       not invalid 
       perform with test after until fs-deptop = "10"
       read deptop next no lock end move "10" to fs-deptop
       not at end 
              if deptop-tutar = 0 
                  exit perform cycle 
              end-if
                initialize depkod-rec  ||||liberty hotels
                move deptop-depkod(1:3)   to depkod-kodu  
                read depkod no lock invalid
                    continue 
                not invalid 
                    if depkod-tipi = 5 and DEPKOD-FATURA-TAKIP = "H"  and depkod-adi(1:5) = "KUR F"
                        exit perform cycle 
                    end-if 
                end-read 

              evaluate deptop-ba
              when "B"
                if k < 30 
                   add 1                to k
                end-if
                if k = 16
                   move 1               to fazla-departman-var
                end-if 
                if depart-cikma = 1 
                   move "OTEL HIZMETLERI    "  to bordepadi(k)
                else
                  move deptop-dep-adi  to bordepadi(k)
                end-if
                move deptop-tutar      to bordeptutar(k)
                 
                


                  move deptop-matrah-tutari       to          bordep-kdv-matrah(k) 
                  move  deptop-kdv-tutari         to           bordep-kdv-tutar(k)  
                  move  deptop-kv-tutari          to           bordep-kv-tutar(k)   
                  move  deptop-kv-matrah          to                  bordep-kv-matrah(k)  



                initialize depkod-rec 
                move deptop-depkod(1:3)   to depkod-kodu bordepkodu(k)
                read depkod no lock invalid
                    continue 
                not invalid 
                    move depkod-kdv  to bordep-kdv(k)
                end-read 
              when "A" 
                if p < 30   
                   add 1                to p
                end-if
                move deptop-dep-adi  to aladepadi(p)(1:10)
                if deptop-depkod(4:) not = spaces 
                   if deptop-dovizli = 2
                      move "-"                 to aladepadi(p)(11:1)
                      move deptop-depkod(4:)   to aladepadi(p)(12:) 
                   end-if 
                   if deptop-dovizli = 1
                      move "-"                 to aladepadi(p)(8:1)
                      move deptop-dv-tutar     to z4
                      move z4                  to aladepadi(p)(9:)
                      move deptop-depkod(4:3)  to aladepadi(p)(17:)
                   end-if 
                end-if                 
                move deptop-tutar    to aladeptutar(p)
              end-evaluate
       end-read 
       end-perform
       end-start
       close deptop depkod.
*
 kdv-bul.
       open input kdv
       initialize kdv-rec b kdvler    kv-matrah-toplam   kv-kv-toplam 
                  kdv-matrah-toplam 
                  kdv-kdv-toplam
       start kdv key not < kdv-anah invalid 
             continue 
       not invalid 
       perform with test after until fs-kdv = "10"
       read kdv next no lock end move "10"  to fs-kdv 
       not at end
              if b < 6
               
               add 1              to b
               if kdv-orani = 2 then 

                   compute  kv-matrah-toplam =   kdvler-matrah(b)
                   compute  kv-kv-toplam    =  kdvler-kdv-tutar(b)
                    move  "KV"     to kdvler-kodu(b)
                    else
                     move kdv-orani     to kdvler-kodu(b)
               end-if
              
               move kdv-matrah    to kdvler-matrah(b)
               move kdv-kdv-tutar to kdvler-kdv-tutar(b)
               move kdv-tutar     to kdvler-tutar(b)
              

               compute kdv-matrah-toplam = kdv-matrah-toplam + kdv-matrah
               compute kdv-kdv-toplam    = kdv-kdv-toplam + kdv-kdv-tutar
              end-if 
       end-read 
       end-perform
       end-start
       close kdv.
*
 gd-yaz-Ev-Other.
     evaluate event-type
     when msg-finish-entry
          inquire gd-yaz(event-data-2,1),
                  hidden-data gd-yaz-rec
          open i-o depkod deptop
          initialize depkod-rec
          move gd-yaz-dep   to depkod-anah
          read depkod no lock invalid 
               display message box "Departman Bulunamadi.." new-line
                                   "Islem Yapilamaz.."
                               title "Uyari"
                               icon 1
          not invalid 
              initialize deptop-rec 
              move depkod-ba   to deptop-ba
              move gd-yaz-dep  to deptop-depkod(1:3)
              read deptop no lock invalid 
                   continue 
              not invalid
                      inquire gd-yaz(event-data-2,7), 
                              cell-data in deptop-dep-adi
                      if deptop-dep-adi <> spaces
                         rewrite deptop-rec end-rewrite
                      else
                         display message box "Aciklama Bos Gecilemez.." new-line
                                             "Lutfen Tekrar Deneyiniz.."
                                         title "Uyari"
                                         icon 1
                      end-if                  
              end-read 
          end-read 
          close depkod deptop 
     end-evaluate.
*
 Form2-Ex-Other.
     evaluate key-status
     when 5055
       if tekrar-fat-no not = spaces        
          perform tekrar-fatura-grid-baslik
          perform tekrar-fatura-grid-yukle
       else
        display message box "Fatura Numarasi Giriniz.."
                        title "Uyari"
                        icon 1
               exit paragraph 
       end-if 
     end-evaluate.
*
 tekrar-fatura-grid-baslik.  
     modify gd-dzn, RESET-GRID = 1
                    mass-update = 1
     initialize Gd-dzn-rec
     move "Fat. No"                     to gd-dzn-fat-no
     move "Tarih"                       to gd-dzn-tar
     move "Saat"                        to gd-dzn-zaman
     move "F.Kesen Kullanici Adi"       to gd-dzn-adi
     move "F.Kesen Kullanici Soyadi"    to gd-dzn-soyadi
     move "#"                           to gd-dzn-print
     move "Aciklama"                    to gd-dzn-aciklama
     modify gd-dzn,record-to-add(Gd-dzn-rec).
*
 tekrar-fatura-grid-yukle.
    open i-o fatdokum kllnc
    initialize fatdokum-rec
    move tekrar-fat-no                    to fatdokum-fat-no
    move 1                                to fatdokum-fat-sira kayit-sayi
    start fatdokum key not < fatdokum-anah1 invalid 
       continue 
    not invalid 
    perform with test after until fs-fatdokum = "10"
    read fatdokum next no lock end move "10" to fs-fatdokum
    not at end 
           if fatdokum-fat-no <> tekrar-fat-no or
              fatdokum-fat-sira <> 1
                 exit perform 
           end-if
           add 1 to kayit-sayi
           initialize gd-dzn-rec
           move fatdokum-fat-no   to gd-dzn-fat-no gd-dzn-hidden-fat-no

           move fatdokum-gun      to egun gd-dzn-hidden-gun
           move fatdokum-ay       to eay  gd-dzn-hidden-ay
           move fatdokum-yil      to eyil gd-dzn-hidden-yil
           move etarih            to gd-dzn-tar

           move fatdokum-saat     to esaat  gd-dzn-hidden-saat
           move fatdokum-dakika   to edakika gd-dzn-hidden-dakika
           move fatdokum-saniye   to esaniye  gd-dzn-hidden-saniye
           move fatdokum-aciklama to gd-dzn-aciklama
           move ezaman            to gd-dzn-zaman
           initialize kllnc-rec 
           move fatdokum-staf     to k-kodu
           read kllnc no lock invalid 
               move "Tanimsiz.."  to k-adi
           end-read 
               move k-adi         to gd-dzn-adi
               move k-soyadi      to gd-dzn-soyadi
           modify gd-dzn,
                  record-to-add(gd-dzn-rec)
           modify gd-dzn(kayit-sayi,1),
                  hidden-data(gd-dzn-hidden)
           modify gd-dzn(kayit-sayi,6),
                  bitmap = print-bmp
                  bitmap-width = 16
                  bitmap-number = 1
                  bitmap-trailing = 1
    end-read 
    end-perform
    end-start
    close fatdokum kllnc
    modify gd-dzn,mass-update = 0.
*
 fatura-kopya-goster.
    open i-o genelfis  
    move 1 to genelfis-anahtar
    read genelfis no lock invalid
        accept print-no from time
     not invalid
        add 1 to print-no
        rewrite genelfis-rec end-rewrite
     end-read
     close genelfis
     initialize dokumer-rec dokumer-anah dokumer-ozellikler-rec
               dokumer-dosya 
     set  dokumer-asya-set to true
     move print-no         to dokumer-dosya-adi
     open output dokumer



     add 1 to dokumer-anah
     write dokumer-rec
     initialize dokumer-rec detay
     move "'Tarafiniza Daha Sonra E-Arsiv faturasi veya E-fatura Gonderilecektir.Bu Belgenin Mali Degeri Yoktur.'" 
     to det-filler(15:)
     write dokumer-rec from detay
     
     open i-o fatdokum
     initialize fatdokum-rec
     move gd-dzn-hidden-tar     to fatdokum-tarih
     move gd-dzn-hidden-zaman   to fatdokum-zaman
     move gd-dzn-hidden-fat-no  to fatdokum-fat-no
     start fatdokum key not < fatdokum-anah invalid
         continue 
     not invalid 
     perform with test after until fs-fatdokum = "10"
     read fatdokum next no lock end move "10" to fs-fatdokum
     not at end
          if fatdokum-tarih <> gd-dzn-hidden-tar or
             fatdokum-zaman  <> gd-dzn-hidden-zaman or
             fatdokum-fat-no <> gd-dzn-hidden-fat-no
               exit perform 
          end-if
          initialize dokumer-rec detay
          move fatdokum-diger to det-filler
          write dokumer-rec from detay
     end-read 
     end-perform
     end-start         
     close fatdokum

     set dokumer-yazici-text  to true
     move "H"                 to dokumer-genel-baslik-yaz
     close dokumer  
   
    call dokumer-prog on exception
         perform callerr-proc
    not on exception
         cancel dokumer-prog
    end-call.
*   
 Form1-Pb-2-Link.
     perform Acu-Form2-Routine.
*
 gd-dzn-Ev-Other.
     evaluate event-type
     when msg-begin-entry
            set event-action to event-action-fail 
     when msg-bitmap-clicked
          display message box tekrar-fat-no" 'Nolu Fatura Tekrar Yazdirilacaktir." new-line
                                           "Eminmisiniz?"
                          title "Uyari"
                          icon 1
                          type 2
                          default 2
                          returning return-code
          if return-code = 2
              exit paragraph
          end-if 
          inquire gd-dzn(event-data-2,1),hidden-data in gd-dzn-hidden
          perform fatura-kopya-goster
     end-evaluate.
*
 fatura-data-yaz.
     open i-o romhrk exthrk fatdetay fatura takas kdv  fatdetayek
              depkod genel alsatek yromhrk alsat  
     open input rez konuk earsbil acenta hrk2 depkod2  

        perform fatura-baslik-data-yaz
        perform fatura-romhrk-exthrk-yaz
        perform genel-fatura-no-yaz        
        perform alsatek-odeme-bilgileri-yaz
     close romhrk exthrk fatdetay fatura takas kdv depkod hrk2 depkod2     fatdetayek
           genel alsatek konuk rez earsbil yromhrk acenta alsat .
*
 fatura-baslik-data-yaz.
    initialize takas-rec i ii fatura-rec
    start takas key not < takas-anah invalid 
        continue 
    not invalid 
    perform with test after until fs-takas = "10"
    read takas next no lock end move "10"  to fs-takas
    not at end 
            move rap-fat-no                to fatura-no
            move 999                       to fatura-sira
            move 1                         to ii
            perform varying i
                    from 1
                    by 1
                    until i > 15
                    if takas-folio <> zeroes
                       move takas-folio    to fatura-aciklama(ii:)
                       add 8               to ii
                    end-if
            end-perform
            write fatura-rec invalid
                  rewrite fatura-rec end-rewrite
            end-write
    end-read 
    end-perform
    end-start
  
    initialize fatura-rec
    move rap-fat-no                to fatura-no
    move 0                         to fatura-sira
    
    read fatura no lock invalid
         continue
    end-read

    perform ara-to-fatura
    open i-o gerfat
    move fatura-anah to gerfat-anah
    read gerfat no lock invalid continue end-read
    move fatura-durumu to    gerfat-durumu
    move rap-fat-tar to gerfat-fat-tar

    if bulunan-arsiv-no > 0 then 
        move bulunan-arsiv-no to FATURA-GERCEK-FAT gerfat-gerfatno
         move rap-ger-seri to  fatura-onek  gerfat-onek    
        move 1 to fatura-no-alindi gerfat-no-alindi
    end-if
    write gerfat-rec invalid 
          rewrite gerfat-rec end-rewrite
    end-write.
    close gerfat
    write fatura-rec invalid 
          rewrite fatura-rec end-rewrite
    end-write.
*
 ara-to-fatura.
    move rap-fat-tar              to fatura-tarihi
    move "F"                      to fatura-tipi
    move "D"                      to fatura-durumu
    move takas-folio              to fatura-folio
    move rap-adi                  to fatura-baslik-1 
    move rap-soyadi               to fatura-baslik-2 
    move rap-il                   to fatura-il
    move rap-ilce                 to fatura-ilce
    move rap-adr1                 to fatura-adres-1  
    move rap-adr2                 to fatura-adres-2
    move rap-ulke                 to fatura-ulke     
    move rap-vd                   to fatura-ver-da 
    move rap-e-mail               to fatura-e-mail
    move rap-telefon              to fatura-telefon   
    if efat-degil = 1  
       move "E"                   to fatura-e-tipi         
    end-if 
    move cari-kodu                to fatura-e-cari
    if rap-vno not = spaces 
       move rap-vno               to fatura-ver-no   
    else 
       if rap-tcno not = spaces 
          move rap-tcno                 to fatura-ver-no
       else
          move rap-pasno                to fatura-ver-no
          move gercek-rap-pasno         to fatura-gercek-kimlik-no
       end-if 
    end-if 
    move rap-ack                  to fatura-aciklama 
    move k-kodu-tasi              to fatura-staf

    move genel-toplam             to fatura-toplam fatura-g-toplam
 

    initialize kdv-rec
    fatura-matrah-8 fatura-kdv-8  fatura-matrah-1
    fatura-matrah-18 fatura-kdv-18  fatura-kdv-1
    start kdv key not < kdv-anah invalid 
        continue 
    not invalid 
    perform with test after until fs-kdv = "10"
    read kdv next no lock end move "10" to fs-kdv
    not at end 
           evaluate kdv-anah
           when 01 |fatura datasý uygun olmadýgý için mecburi yapýldý.
               move kdv-matrah    to fatura-matrah-1
               move kdv-kdv-tutar to fatura-kdv-1
           when 08 |fatura datasý uygun olmadýgý için mecburi yapýldý.
               move kdv-matrah    to fatura-matrah-8
               move kdv-kdv-tutar to fatura-kdv-8
           when 18 |fatura datasý uygun olmadýgý için mecburi yapýldý.
               move kdv-matrah    to fatura-matrah-18
               move kdv-kdv-tutar to fatura-kdv-18
           when other 
               move kdv-matrah    to fatura-matrah-8
               move kdv-kdv-tutar to fatura-kdv-8               
           end-evaluate 
           compute fatura-matrah = fatura-matrah-8 + fatura-matrah-18 + fatura-matrah-1 
           compute fatura-kdv = fatura-kdv-8 + fatura-kdv-18 + fatura-kdv-1
    end-read 
    end-perform
    end-start.
*
 fatura-romhrk-exthrk-yaz.
    initialize takas-rec
    start takas key not < takas-anah invalid
         continue 
    not invalid 
    perform with test after until fs-takas = "10"
    read takas next no lock end move "10" to fs-takas
    not at end
             evaluate takas-folio-tipi
             when "R"
                   perform romhrk-data-yaz
             when "E"
                   perform exthrk-data-yaz
             end-evaluate             
    end-read 
    end-perform
    end-start.
*
 romhrk-data-yaz.
    initialize romhrk-rec fatdetay-rec  fatdetayek-rec
    move takas-folio        to romhrk-folio
    start romhrk key not < romhrk-anah invalid 
        continue 
    not invalid 
    perform with test after until fs-romhrk = "10"
    read romhrk next no lock end move "10" to fs-romhrk
    not at end 
           if romhrk-folio <> takas-folio
              exit perform 
           end-if

           if romhrk-ref <> takas-pen
               exit perform cycle 
           end-if 
         initialize depkod-rec depkod2-rec
         move romhrk-depkod     to depkod-anah fatdetay-depkod   depkod2-anah
         read depkod no lock invalid
              display message box romhrk-depkod " 'Nolu Departman Bulunamadi..."
         end-read 
          read depkod2 no lock invalid
              display message box romhrk-depkod " 'Nolu Departman Bulunamadi..."
         end-read 
            if depkod-tipi = 5 and depkod-fatura-takip = "H" and  depkod-adi(1:5) = "KUR F" ||||liberty hotels
                 exit perform cycle 
            end-if 
           if romhrk-fatura-no = 0 or  
              romhrk-fatura-no not numeric 
                move rap-fat-no  to romhrk-fatura-no
                rewrite romhrk-rec end-rewrite 
                perform log-operation-romhrk
           end-if 

         accept fatdetay-kes-tarih from century-date
         accept fatdetay-kes-zaman from time   
          
         move rap-fat-tar       to fatdetay-fat-tar                    
         move rap-fat-no        to fatdetay-fat-no                     
         move romhrk-folio      to fatdetay-folio                      
         move romhrk-islem      to fatdetay-islem                      
         move "R"               to fatdetay-romhrk-exthrk              
         move romhrk-tarih      to fatdetay-isl-tar

         initialize depkod-rec
         move romhrk-depkod     to depkod-anah  
         read depkod no lock invalid
              display message box romhrk-depkod " 'Nolu Departman Bulunamadi..."
         end-read 
         if depkod-turu = 2 and romhrk-corr-depkod not = spaces and 
            romhrk-corr-depkod not = zeroes
               move romhrk-corr-depkod to depkod-anah
                read depkod no lock invalid
                    continue
              end-read 
         end-if

         move fatdetay-anah to fatdetayek-anah

         if (room-kdv-yok = 1 and depkod-tipi = 2) or (extra-kdv-yok = 1 and depkod-tipi = 3)
            move 0  to depkod-kdv
         end-if          
         move depkod-kdv         to  fatdetay-kdv-orani                  

         move romhrk-tl-tutar    to  fatdetay-fatura-toplam 
        
         move fatdetay-anah to fatdetayek-anah 
         

      if romhrk-tarih >= kv-gecis-tar and depkod2-kv-uygula =1  then 

               compute fatdetay-fatura-matrah rounded = 
                 romhrk-tl-tutar / (1+((depkod-kdv + kv-orani) / 100))

         compute fatdetay-fatura-kdv  rounded    =
               fatdetay-fatura-matrah *   ((depkod-kdv ) / 100)


        

          move kv-orani to   fatdetayek-kv-oran


           compute fatdetayek-kv rounded = 
                 fatdetay-fatura-matrah *   ((kv-orani ) / 100)
          
            
             compute fatdetay-fatura-matrah rounded = 
                 romhrk-tl-tutar -  fatdetay-fatura-kdv -  fatdetayek-kv


                   move fatdetay-fatura-matrah to  fatdetayek-kv-matrah  



        else
         
         compute fatdetay-fatura-matrah rounded = 
                 romhrk-tl-tutar / (1+(depkod-kdv / 100))

         compute fatdetay-fatura-kdv =   fatdetay-fatura-matrah * (depkod-kdv / 100)
                
         compute  fatdetay-fatura-matrah  = romhrk-tl-tutar -   fatdetay-fatura-kdv
         

         move 0 to  fatdetayek-kv-matrah   fatdetayek-kv-oran fatdetayek-kv

       end-if
         compute fatdetay-fatura-matrah rounded = 
                 fatdetay-fatura-toplam -   fatdetayek-kv -  fatdetay-fatura-kdv

         write fatdetay-rec invalid 
                 rewrite fatdetay-rec 
         end-write

          write fatdetayek-rec invalid 
                 rewrite fatdetayek-rec 
         end-write


    end-read 
    end-perform
    end-start.
*
 exthrk-data-yaz.
    initialize exthrk-rec fatdetay-rec     fatdetayek-rec
    move takas-folio        to exthrk-folio
    start exthrk key not < exthrk-anah invalid 
        continue 
    not invalid 
    perform with test after until fs-exthrk = "10"
    read exthrk next no lock end move "10" to fs-exthrk
    not at end 
           if exthrk-folio <> takas-folio
              exit perform 
           end-if

           if exthrk-ref <> takas-pen
               exit perform cycle 
           end-if 
         initialize depkod-rec
         move exthrk-depkod     to depkod-anah  
         read depkod no lock invalid
              display message box romhrk-depkod " 'Nolu Departman Bulunamadi..."
         end-read 
            if depkod-tipi = 5 and depkod-fatura-takip = "H" and depkod-adi(1:5) = "KUR F" ||||liberty hotels
                 exit perform cycle 
            end-if 
           if exthrk-fatura-no = 0 or  
              exthrk-fatura-no not numeric 
                move rap-fat-no  to exthrk-fatura-no
                rewrite exthrk-rec end-rewrite 
                perform log-operation-exthrk
           end-if 

         accept fatdetay-kes-tarih from century-date
         accept fatdetay-kes-zaman from time   
          
         move rap-fat-tar       to  fatdetay-fat-tar                    
         move rap-fat-no        to  fatdetay-fat-no                     
         move exthrk-folio      to  fatdetay-folio                      
         move exthrk-islem      to  fatdetay-islem                      
         move "E"               to  fatdetay-romhrk-exthrk              
         move exthrk-tarih      to  fatdetay-isl-tar

         initialize depkod-rec depkod2-rec
         move exthrk-depkod     to depkod-anah fatdetay-depkod   depkod2-anah
         read depkod no lock invalid
              display message box exthrk-depkod " 'Nolu Departman Bulunamadi..."
         end-read 
           read depkod2 no lock invalid
              display message box exthrk-depkod " 'Nolu Departman Bulunamadi..."
         end-read 
         if depkod-turu = 2 and exthrk-corr-depkod not = spaces and   exthrk-corr-depkod not = zeroes
                move exthrk-corr-depkod to depkod-anah
                read depkod no lock invalid
                   continue
              end-read 
         end-if
         if (room-kdv-yok = 1 and depkod-tipi = 2) or (extra-kdv-yok = 1 and depkod-tipi = 3)
            move 0  to depkod-kdv
         end-if
         move depkod-kdv         to fatdetay-kdv-orani   
         
      
         move fatdetay-anah  to  fatdetayek-anah
        
            move exthrk-tl-tutar    to fatdetay-fatura-toplam  

         if exthrk-tarih >= kv-gecis-tar and depkod2-kv-uygula =1  then 


            
               compute fatdetay-fatura-matrah rounded = 
                 exthrk-tl-tutar / (1+((depkod-kdv + kv-orani) / 100))

         compute fatdetay-fatura-kdv  rounded =
               fatdetay-fatura-matrah *   ((depkod-kdv ) / 100)


        

          move kv-orani to   fatdetayek-kv-oran


           compute fatdetayek-kv rounded = 
                 fatdetay-fatura-matrah *   ((kv-orani ) / 100)
          
           
             compute fatdetay-fatura-matrah rounded =    exthrk-tl-tutar -   fatdetayek-kv -  fatdetay-fatura-kdv

            move fatdetay-fatura-matrah to  fatdetayek-kv-matrah  

        else



                         move exthrk-tl-tutar    to fatdetay-fatura-toplam  
                         compute fatdetay-fatura-matrah rounded = 
                                 exthrk-tl-tutar / (1+(depkod-kdv / 100))
                         compute fatdetay-fatura-kdv = 
                                 fatdetay-fatura-toplam - fatdetay-fatura-matrah
                          move 0 to  fatdetayek-kv-matrah   fatdetayek-kv-oran fatdetayek-kv


          end-if
   
              compute fatdetay-fatura-matrah rounded = 
                 fatdetay-fatura-toplam -   fatdetayek-kv -  fatdetay-fatura-kdv
         write fatdetay-rec invalid 
                 rewrite fatdetay-rec 
         end-write

         write fatdetayek-rec invalid 
             rewrite fatdetayek-rec
          end-write
    end-read 
    end-perform
    end-start.
*
 genel-fatura-no-yaz.   
    initialize genel-rec
    move 1                to genel-anahtar
    read genel no lock invalid 
       continue 
    not invalid 
    if efat-degil = 1 
       move rap-fat-no   to genel-efol-fat-no
    else
       move rap-fat-no   to genelde-fol-fat
       evaluate true
         when folfat-seri not > 1 
             move    genelde-fol-fat   to genel-fol-fat-no
         when folfat-seri = 2 
             move    genelde-fol-fat   to genel-fol-fat-no2
        when folfat-seri = 3 
             move    genelde-fol-fat   to genel-fol-fat-no3
        when folfat-seri = 4 
             move    genelde-fol-fat   to genel-fol-fat-no4
        when folfat-seri = 5 
             move    genelde-fol-fat   to genel-fol-fat-no5
       end-evaluate
    end-if
        rewrite genel-rec end-rewrite 
    end-read.
*
 grid-kayit-secim-iptal.
    modify gd-sec(event-data-2,1),
           bitmap = artieksi-bmp
           bitmap-width = 16
           bitmap-number = 1
           bitmap-trailing = 1

    modify gd-sec(event-data-2,2),
           hidden-data = 0
          
         perform takas-sil
    
         perform alt-grid-baslik-yukle
         perform alt-grid-ekle
         
         perform dep-top-grid-yukle

         perform kdv-baslik-yukle
         perform kdv-grid-yukle
         perform fatura-bilgisi-al
         modify gd-sec(event-data-2),
                row-color = 480.
*
 grid-kayit-secildi.
         if event-data-2 < 999 
            modify gd-sec(event-data-2,1),
                   bitmap = artieksi-bmp
                   bitmap-width = 16
                   bitmap-number = 7
                   bitmap-trailing = 1
            modify gd-sec(event-data-2,2),
                   hidden-data = 1
         end-if
         if genel-toplu-folio-faturasi-kesilsin not = 1
            perform dov-gonder
         end-if 
         perform takas-yaz
         perform alt-grid-baslik-yukle
         perform alt-grid-ekle
          
         perform dep-top-grid-yukle

         perform kdv-baslik-yukle
         perform kdv-grid-yukle                        
         perform fatura-bilgisi-al
         if event-data-2 < 999 
                 modify gd-sec(event-data-2),
                        row-color = 176
         end-if.
*
 dov-gonder.
     move link-fol-no   to link2-fol-no     
     move 0             to link2-rez        
     initialize link2-fat
     move link-pencere  to link2-fat-ref               
     call "/asya/ytl/obj/otel/folio.asy" using link2-fol-no link2-rez  link2-fat
                  on exception perform callerr-proc
                  not on exception
                  cancel "/asya/ytl/obj/otel/folio.asy" 
             end-call
        move link2-fat-dv     to e-14 
        move e-14             to dov-tut
        display acc-dov-tut.
*
 fatura-no-kontrol.
     open i-o fatura
     move 1                 to hata
     initialize fatura-rec
     move rap-fat-no        to fatura-no
     move 0                    to fatura-sira
     read fatura no lock invalid
          display message box 
                  rap-fat-no," seri numarali fatura tanimlamasi yapilmamis"
                  icon mb_error_icon
                  title "Hata"
          move 4 to accept-control
          move 5 to control-id
          close fatura
          exit paragraph
     end-read
     evaluate fatura-durumu
     when "I"
        display message box 
                rap-fat-no," numarali fatura iptal edilmis !"
                icon mb_error_icon
                title "Hata"
        move 4 to accept-control
        move 5 to control-id
        close fatura
        exit paragraph

     when "D"
        display message box 
                rap-fat-no," seri numarali fatura daha once kesilmis !",
                new-line,
                new-line,
                "Kesilmis fatura Bilgileri"
                new-line,
                "Fatura Tarihi :",x"09",fatura-gun,"/"fatura-ay,"/",fatura-yil
                new-line,
                "Folio :",x"0909",fatura-folio,
                new-line,
                fatura-baslik-1, new-line,
                fatura-baslik-2, new-line,
                "Adres 1 :", x"09",fatura-adres-1,  new-line,
                "Adres 2 :", x"09",fatura-adres-2,  new-line,
                "Il :",      x"09",fatura-il,       new-line,
                "Ilce :",    x"09",fatura-ilce,     new-line,
                "Ulke :",    x"09",fatura-ulke,     new-line,
                "Vergi D.:", x"09",fatura-ver-da,   new-line,
                "Vergi N. :",x"09",fatura-ver-no    new-line new-line
                "Fatura numaranizi degistiriniz.."
                title "Uyari"
**                type mb_yes_no
**                default 2
**                returning return-code
*        if return-code <> 1
           move 4 to accept-control
           move 15 to control-id
           close fatura
           exit paragraph
*        end-if                
     end-evaluate
     move 0                     to hata
     close fatura.
     perform arsiv-kont.
*
 arsiv-kont.
     if genel-e-arsiv-gecis-tarihi <= rap-fat-tar and
        genel-e-arsiv-gecis-tarihi > "20150101" and e-arsiv-var-mi = 1
        if bu-fat-online = 1 
           move genel-online-onek to fatura-onek

        else
           if genel-online-onek = fatura-onek
              display message box "Bu numaraya online kesilmis bu noya kesemessiniz"
              move 1 to hata
              exit paragraph

           end-if

        end-if
        if fatura-onek(1:1) not = spaces and 
           fatura-onek(2:1) not = spaces and 
           fatura-onek(3:1) not = spaces and 
           function numval( fatura-onek(4:4)) = rap-fat-yil 
           continue

        else
           move 1 to hata
           display message box "Fatura Tanimlamadan Fatura Onserisi tanimlanmalidir"

        end-if
        move gerfat-dosya to mgerfat-dosya
        open i-o gerfat mgerfat
        initialize gerfat-rec bulunan-arsiv-no
        move fatura-onek  to gerfat-onek
        move 1            to gerfat-no-alindi
        move 1 to olmasi-gereken-no
        start gerfat key > gerfat-alinan  invalid 
              continue
        not invalid  
        perform until fs-gerfat = "10"
        read gerfat next no lock end move "10" to fs-gerfat
        not end

            if  FATURA-onek not = gerfat-onek or gerfat-no-alindi not = 1 
                move "10" to fs-gerfat
                exit perform cycle

            end-if
            if olmasi-gereken-no >= dur-no  and debug = 1 and (k-kodu-tasi = "ASYA" or "X   ")
               stop " "

            end-if
            if gerfat-durumu  = "B"
               if  gerfat-fat-tar = rap-fat-tar
                   move gerfat-gerfatno to bos-bulundu

               end-if
               exit perform cycle

            end-if
            if gerfat-gerfatno not = olmasi-gereken-no
               if gerfat-gerfatno < olmasi-gereken-no
                  if gerfat-durumu = "D" or "I"
                     if gerfat-fat-tar >= rap-fat-tar 
                        display message box "Cift no " gerfat-onek gerfat-gerfatno " " gerfat-durumu  new-line
                                             gerfat-anah new-line
                                             "Olmasi gereken " olmasi-gereken-no
                     end-if                   
                  end-if
               else
                  if son-gerfat-tarih > rap-fat-tar  
                    display message box " Uyumsuz tarih : fatura sirasinda bos yok lck"
                    move 1 to hata
                    stop " "
                    exit perform
                  end-if
                  if son-gerfat-tarih < rap-fat-tar 
*                    stop " "
                     perform sonrasi-kontrol 
                     if uyumsuz-fat = 1 
                        display message box olmasi-gereken-no  "nolu fatura atlanmis "
                        compute  olmasi-gereken-no  =  gerfat-gerfatno + 1 
                        exit perform cycle

                     else
                        move olmasi-gereken-no to bulunan-arsiv-no
                        exit perform

                     end-if
                  else                                        
                     move olmasi-gereken-no to bulunan-arsiv-no
                     exit perform

                  end-if
               end-if
            else
               if gerfat-durumu  = "D"  or "I"
                  add 1 to olmasi-gereken-no

               end-if
            end-if 
            if gerfat-durumu  not = "B"
               move gerfat-fat-tar to son-gerfat-tarih

            end-if

        end-read
        end-perform
        end-start
        close gerfat mgerfat
     end-if
     
     if hata = 0 and bulunan-arsiv-no = 0 then
        if son-gerfat-tarih > rap-fat-tar  
           display message box " Uyumsuz tarih : fatura sirasinda bos yok "
           move 1 to hata
           stop " "                           
        end-if
        move  olmasi-gereken-no to bulunan-arsiv-no

     end-if
     if bulunan-arsiv-no > 0  then 
        move    bulunan-arsiv-no  to rap-ger-no
        move    fatura-onek   to  rap-ger-seri   
        display acc-ger-no     acc-ger-seri

     end-if.
*
 sonrasi-kontrol.
       initialize mgerfat-rec  uyumsuz-fat
            move gerfat-rec to mgerfat-rec
            start mgerfat key > mgerfat-alinan  invalid continue
               not invalid  
               perform until fs-mgerfat = "10"
                   read mgerfat next no lock end move "10" to fs-mgerfat
                      not end
                    
                         if  fatura-onek not = mgerfat-onek or mgerfat-no-alindi not = 1 
                          move "10" to fs-mgerfat
                          exit perform cycle
                          end-if
                          if mgerfat-durumu  = "B" or " "
                             exit perform cycle
                          end-if
                         if  mgerfat-fat-tar < rap-fat-tar 
                            move 1 to uyumsuz-fat
                         end-if
                       end-read
                  end-perform 
            end-start
            .


*
 fatura-bakiye-kontrol.
     if hata = 1 
        exit paragraph 
     end-if 
     move 1  to hata
     open input kdv
     initialize kdv-rec hata
     start kdv key not < kdv-anah invalid 
        continue 
     not invalid 
     perform with test after until fs-kdv = "10"
     read kdv next no lock end move "10" to fs-kdv
     not at end 
            if kdv-tutar > zeroes 
                  move 0 to hata
            end-if 
     end-read 
     end-perform
     end-start
     close kdv.

*
 cb-fat-tipi-Ex-Ntf-Selchange.
     evaluate fat-tipi-value(1:1)
     when "O"
         perform ozet-fatura-hazirla
     when "D"
         perform detay-fatura-hazirla
     end-evaluate.
*
 Form1-Aft-Routine.
     delete file takas.
     close odalar2.
*
 vergi-no-kontrol.
      open i-o efatci
      initialize efatci-rec  efatcari efat-degil
      if rap-tcno not = spaces 
         move  rap-tcno   to efatci-kodu           
      end-if 
      if rap-vno not = spaces          
         move  rap-vno    to efatci-kodu 
      end-if
      if genel-efatura-kllnc-degil not = 1
         if genel-e-arsiv-yil  < 2100 
            read efatci no lock invalid 
                move 0 to efatcari
            not invalid 
                if efatci-giris-tarih > rap-fat-tar
                    move 0 to efatcari
                else
                   move 1 to efatcari
                end-if
            end-read
         end-if
*\         close   efatci                       | ilgaz firat 31.10.2017
      end-if
      if efatcari <> 0    
         move 1       to efat-degil
      end-if
      close efatci
      .
             
*
 e-fatura-al-sat-yaz.
    move "S"                        to alsat-tipi   
    move rap-fat-tar                to alsat-tarih
    move rap-fat-no                 to alsat-belge-no 
*/************************e-arsivde musteri fatura isterse
    if e-arsiv-var-mi = 1           
        move rap-ger-no           to alsat-efatura-numarasi(8:9)
        move rap-ger-seri         to alsat-efatura-numarasi(1:7)
        move "K"                  to alsat-earsiv-gonderim-sekli         
    end-if 
*/************************e-arsivde musteri fatura isterse 
    move efat-sira                  to alsat-sira                                                                    
**    e-arsiv geçisinden kapatýldý.move "BS"                       to alsat-belge-tipi              
    if cari-kodu not = spaces and cari-bulundu = 1
       move cari-kodu               to alsat-toplam-hesap-babs alsat-toplam-hesap     
    end-if
    move genel-muha-ref             to alsat-referans   
    
    if ONKPARA-REFERANS-VAR = 1  
       and xkonuk-fiyat-konumu > 0 then 
        move xkonum-ref(xkonuk-fiyat-konumu)  to alsat-referans
        if onkpara-referans-nerden = 2          
           initialize odalar-rec
           move konuk-odano           to odalar-anah
           read odalar no lock invalid    
                move 1                to odalar-referans
           end-read 
               move odalar-referans   to alsat-referans
        end-if 
        initialize kodlar02-rec
            move "r"           to kodlar02-tipi
            move alsat-referans to zz
            move zz           to kodlar02-kodu
            read kodlar02 no lock invalid 
                continue 
            not invalid
            if (kodlar02-ref > 0)
                move kodlar02-ref to ref-z 
                move ref-z to alsat-referans
                end-if
            end-read            




    end-if  
    
    move "Onburo Folio Fatura"      to alsat-fis-aciklama
    move 01                         to alsat-banka                
    move alsat-matrah               to alsat-gercek-matrah
    if rap-pasno not = spaces
       initialize gercek-rap-pasno
       move rap-pasno               to gercek-rap-pasno       
       move "11111111111"           to rap-tcno

       if genel-efatura-kllnc-degil = 1 ||| a4 kaðýtlarda ikinci nüsha pass no ya 11111 atýyordu PUKKA - RAMAZAN
           initialize rap-tcno 
       end-if 
       
    end-if 
    move  rap-vno                   to alsat-adres-vergi-no
    if rap-vno = spaces
       if  rap-tcno not = spaces
           move rap-tcno                  to alsat-adres-vergi-no(1:)            
           move rap-adi                   to alsat-adres-adi
           move rap-soyadi                to alsat-adres-soyadi
           set alsat-kayit-tckn to true
       else
           move rap-adi                   to alsat-adres-adi
           move rap-soyadi                to alsat-adres-soyadi
           move rap-tcno                  to alsat-adres-vergi-no(1:)          
*           move rap-pasno                 to alsat-adres-vergi-no(1:)              
*           move "P"                       to alsat-kayit-turu            
           set alsat-kayit-tckn to true
       end-if
    else
        move rap-adi                   to alsat-adres-unvani(1:40) 
        move rap-soyadi                to alsat-adres-unvani(41:40) 
        set alsat-kayit-vkn to true
    end-if 

*****************************////////// 02.08.2022 Kadir - 7000TL üzeri ödemelerde Pasaport Numarasýnýn faturalarsa görünmesi muhabbetinden sonra
    if rap-pasno not = spaces
       initialize gercek-rap-pasno alsat-adres-vergi-no(1:)
       move rap-pasno               to alsat-adres-vergi-no(1:) gercek-rap-pasno    
       move "11111111111"           to rap-tcno
       set alsat-kayit-pasaport to true

       if genel-efatura-kllnc-degil = 1 ||| a4 kaðýtlarda ikinci nüsha pass no ya 11111 atýyordu PUKKA - RAMAZAN
           initialize rap-tcno 
       end-if 
       
    end-if 
*****************************////////// 02.08.2022 Kadir - 7000TL üzeri ödemelerde Pasaport Numarasýnýn faturalarsa görünmesi muhabbetinden sonra

    move rap-adr1                  to alsat-adres-cadde-adi(1:40)
    move rap-adr2                  to alsat-adres-cadde-adi(41:40)
    move rap-ilce                  to alsat-adres-ilce 
    move rap-il                    to alsat-adres-il  
    move rap-vd                    to alsat-adres-vergi-dairesi  
    move rap-ulke                  to alsat-adres-ulke
    if rap-ack not = spaces
       move rap-ack                to alsat-fis-not  
    else
       move alac-satirlar          to alsat-fis-not
    end-if 
 
    move "D"                       to alsat-kdv-dh              
    move rap-e-mail                to alsat-adres-mail
    move rap-telefon               to alsat-adres-tel
** compute alsat-kdv-tutar = alsat-kdvli - alsat-matrah     
    move 1                          to alsat-miktar           
    move alsat-matrah               to alsat-birim-fiyat
    move "Adet"                     to alsat-birim
    move "O"                        to alsat-kaynak
    if efat-degil = 1
       move "E"                     to alsat-efatura-mi
    else       
       move " "                     to alsat-efatura-mi
    end-if
    move isyeri-adres-tasi          to alsat-kaynak-kutuphane
    move tmp-fat-voucher            to alsat-mis-voucher
************************************************************************************************
*****************************************MATRAH HESAP KODU BULMA 007****************************
    initialize depkod2-rec
    move DEPKOD-KODU to DEPKOD2-KODU
    read depkod2 no lock invalid
            continue
    end-read

    if depkod2-matrah-hesap <> spaces
          move depkod2-matrah-hesap to alsat-matrah-hesap
    else
          move depkod-matrah-hesap  to alsat-matrah-hesap
    end-if

    initialize muh-kodlar-rec
    set muh-kodlar-tipi-kdv to true
    move rap-fat-yil    TO muh-kodlar-yil
    MOVE "S"            TO muh-kodlar-kodu1
    MOVE "O"            TO muh-kodlar-kodu2
    move depkod-kdv     to muh-kodlar-fis 
    read muh-kodlar no lock invalid
            continue
    end-read
    move muh-kodlar-kdv-hesap(rap-fat-ay) to alsat-kdv-hesap
***********************************02.07.2015**********************************************************
*******************************************************************************************************
*****************************Raymar Ankara**********************
    if alsat-kdv-orani = 0    
          move "Kdv Muafiyeti"    to alsat-kdv-bos-aciklama
          move "351"              to alsat-kdv-istisna-kodu
    end-if
    move "E"  to alsat-adres-alsattan-al
****************************************************************
*      if k-kodu-tasi = "ASYA"
*          display message box "alsat-satir-aciklama : " alsat-satir-aciklama(1:50) new-line
*                             "alsat-satir-aciklama : "  alsat-satir-aciklama(51:50)  new-line
*                             "alsat-satir-aciklama : "  alsat-satir-aciklama(101:50) new-line
*                             "alsat-satir-aciklama2: " alsat-satir-aciklama2
*      end-if
**************alba osman bey istek.
    if  link2-fat-dv > 0
            initialize doviz-rec
            move konuk-doviz               to doviz-kodu
            read doviz no lock invalid 
                continue 
            end-read  
*/*****************alacak departmanlarýyla ayný alana atýldýðý için böyle yapýldý.           
            move link2-fat-dv to 11-z
            string alsat-fis-not delimited by "      "                                   
                  11-z delimited by "           " 
                  "-" delimited by size  
                  d-kisa-adi  delimited by size
                  " -" delimited by size   
            into alsat-fis-not

            if acenta-folio-fat-doviz-kes = 1 || liberty fabay istek Serdar KOFTAR 25.08.2021 telefon ile görüþüldü (RAMAZAN)
              if konuk-fol-kodu = "R"
                move link2-fat-dv to alsat-doviz-tutar
                move konuk-doviz to alsat-doviz     
                compute  alsat-doviz-kuru rounded = alsat-kdvli / alsat-doviz-tutar 
              end-if
            end-if 

*/*****************alacak departmanlarýyla ayný alana atýldýðý için böyle yapýldý.     
    end-if
**************alba osman bey istek
     move alsat-matrah to alsat-gercek-matrah
     move alsat-kdvli to alsat-gercek-tutar-kdvli
    | if k-kodu-tasi = "ASYA"  display message box alsat-kdv-tutar end-if
      
    write alsat-rec invalid 
           continue 
    end-write.

    perform log-operation-alsat.  
*
 acuserve-adres-aktar.
    move muhasebe-entegre-sirketi  to 
                         CARI-DOSYA-adres         
                         ISLENEN-DOSYA-adres      
                         HESAP-DOSYA-adres        
                         MAHSUP-DOSYA-adres       
                         alsat-dosya-adres
                         alsatek-dosya-adres
                         REFERANS-DOSYA-adres     
                         Mgenel-DOSYA-adres 
                         muh-kodlar-DOSYa-adres

    move all low-values to      
                           CARI-ACUSERVE-DOSYA       
                           ISLENEN-ACUSERVE-DOSYA    
                           HESAP-ACUSERVE-DOSYA      
                           MAHSUP-ACUSERVE-DOSYA     
                           genelfis-ACUSERVE-DOSYA   
                           REFERANS-ACUSERVE-DOSYA   
                           Mgenel-ACUSERVE-DOSYA     
                           genelfis-ACUSERVE-DOSYA 
                           alsat-ACUSERVE-DOSYA
                           alsatek-ACUSERVE-DOSYA
                           muh-kodlar-ACUSERVE-DOSYA
                           ip-no.

    inspect genel-muha-uzak-ip 
            replacing trailing spaces by low-values.

    if genel-muha-uzak-ip <> low-values
       move all low-values to ip-no
       string ip-no,
              "@" delimited by low-values
              genel-muha-uzak-ip delimited by low-values
              ":" delimited by low-values
              into ip-no
    end-if

    string mgenel-acuserve-dosya,
           ip-no                        delimited by low-values
           mgenel-dosya                    delimited by low-values
           into mgenel-acuserve-dosya.
    string genelfis-acuserve-dosya,
           ip-no                        delimited by low-values
           genelfis-dosya                 delimited by low-values
           into genelfis-acuserve-dosya.

    string alsat-acuserve-dosya,
           ip-no                        delimited by low-values
           alsat-dosya                 delimited by low-values
           into alsat-acuserve-dosya.
    string alsatek-acuserve-dosya,
           ip-no                        delimited by low-values
           alsatek-dosya                 delimited by low-values
           into alsatek-acuserve-dosya.

    string muh-kodlar-ACUSERVE-DOSYA,
           ip-no                        delimited by low-values
           muh-kodlar-DOSYA             delimited by low-values
           into muh-kodlar-ACUSERVE-DOSYA.
    


    string hesap-acuserve-dosya,
           ip-no                        delimited by low-values
           hesap-dosya                 delimited by low-values
           into hesap-acuserve-dosya.
    string mahsup-acuserve-dosya,
           ip-no                        delimited by low-values
           mahsup-dosya                 delimited by low-values
           into mahsup-acuserve-dosya.
    if genel-cari-yerelde  = 1 
     move CARI-DOSYA to cari-acuserve-dosya
     else
    string cari-acuserve-dosya,
           ip-no                        delimited by low-values
           cari-dosya                 delimited by low-values
           into cari-acuserve-dosya
           
    end-if       .
    string islenen-acuserve-dosya,
           ip-no                        delimited by low-values
           islenen-dosya               delimited by low-values
           into islenen-acuserve-dosya.
    string referans-acuserve-dosya,
           ip-no                        delimited by low-values
           referans-dosya                delimited by low-values
           into referans-acuserve-dosya.
    
    inspect CARI-ACUSERVE-DOSYA        replacing  all spaces by low-values
    inspect ISLENEN-ACUSERVE-DOSYA     replacing  all spaces by low-values
    inspect HESAP-ACUSERVE-DOSYA       replacing  all spaces by low-values
    inspect MAHSUP-ACUSERVE-DOSYA      replacing  all spaces by low-values
    inspect genelfis-ACUSERVE-DOSYA    replacing  all spaces by low-values
    inspect REFERANS-ACUSERVE-DOSYA    replacing  all spaces by low-values
    inspect mgenel-ACUSERVE-DOSYA      replacing  all spaces by low-values
    inspect genelfis-ACUSERVE-DOSYA    replacing  all spaces by low-values
    inspect alsat-ACUSERVE-DOSYA       replacing  all spaces by low-values.
    inspect alsatek-ACUSERVE-DOSYA     replacing  all spaces by low-values.
    open input mgenel
        move 1 to mgenel-anahtar
        read mgenel no lock invalid
             display message box 
                     "mgenel parametre tanimsiz ..."
                     icon mb_error_icon
                     title "Hata"
                     close mgenel
                     destroy form1-handle
                     goback
        end-read
        close mgenel.
*
 acc-vno-Aft-Procedure.
    perform cari-ata
    if genel2-uyumsoft-fat-ent-devrede = 1 and
       rap-vd <> spaces 
       open input kodtan
       initialize kodtan-rec 
       move "V"    to kodtan-tipi 
       move uym-vd to kodtan-kodu 
       read kodtan no lock invalid
            move "Tanimsiz.." to kodtan-adi
            display message box "Tanimsiz Vergi Dairesi.."
       end-read 
       move kodtan-adi to rap-vd 
       display acc-vd
       close kodtan 
    end-if
    .
*
 cari-ata.
    move rap-vno         to bakilacak-no
    if bakilacak-no > 0
       perform takcari-kontrol     
            if cari-bulundu = 1
               open input cari
               initialize cari-rec
               move bulunan-cari-kodu  to cari-kodu
               read cari no lock invalid 
                     continue 
               not invalid
                if rap-adi = spaces 
                   perform cbilgi-at
                 else
                  if  rap-adi not =  C-UNVAN-1
                   or C-UNVAN-2 not = rap-soyadi  then 
                   display message box  "Muhasebe Cari Kartlarinde Ayni Vergi Numarasina Ait Asagidaki Fatura Bilgileri Bulunmustur." new-line 
                                             new-line  
                                         "Unvan :" C-UNVAN-1   new-line     
                                         "            " C-UNVAN-2  new-line       
                                         "Adres :" C-ADRES-1  new-line      
                                         "            "  C-ADRES-2   new-line   
                                         "            "  C-IL-ILCE  new-line         
                                         "            "  C-IL-ILCE    new-line   
                                         "            "  C-ULKE       new-line       
                                                      new-line                                   
                                 "Bulunan  cari bilgileri Fatura uzerine yazilsin mi?"
                                  new-line  
                       icon 2 type 2 default 1 giving sonucc
                       if sonucc = 1   then 
                         perform cbilgi-at
                       else
                          move  0 to cari-bulundu
                          initialize cari-kodu 
                       end-if
                  end-if
                end-if               
                   
               end-read
               display acc-adi,acc-soyadi,acc-adr1,acc-adr2,
                       acc-ilce,acc-il,acc-ulke,acc-vd,acc-vno acc-e-mail acc-telefon
               close cari
             end-if
    end-if.
*
 cbilgi-at.
      move C-UNVAN-1                 to rap-adi                
      move C-UNVAN-2                 to rap-soyadi            
      move C-IL-ILCE                 to rap-il                
      move C-IL-ILCE                 to rap-ilce
      move C-ADRES-1                 to rap-adr1              
      move C-ADRES-2                 to rap-adr2              
      move C-ULKE                    to rap-ulke              
      move C-VERGI-DAIRE             to rap-vd                
      move C-VERGI-NO                to rap-vno
      move function numval(rap-vno)  to svno
      move svno                      to rap-vno
      move C-EMAIL                   to rap-e-mail
      move C-TELEFON                 to rap-telefon.
*
 screen1-Aft-Initdata.
      perform takcari-ilk
      set exit-pushed to true.     
*
 Form2-Cm-1-Ex-Ntf-Selchange.
      if cb-yazici-tipi(1:1) = "A"
         move 3  to m
         display acc-kopya-adet
         modify acc-kopya-adet, VISIBLE = 1
         modify la-fat-taraaaaa,visible = 1
      else
         initialize m
         display acc-kopya-adet
         modify acc-kopya-adet, VISIBLE = 0
         modify la-fat-taraaaaa,visible = 0        
      end-if.
*
 e-arsiv-fat-dok. 
     if e-arsiv-var-mi = 1     
        initialize efatr1-lnk
        move alsat-ana-anahtar         to efatr1-lnk
        move k-kodu-tasi               to yedek-k-kodu-tasi
        move isyeri-adres-tasi         to yedek-isyeri-adres-tasi        
        move "ASYA"                    to k-kodu-tasi              
        move muhasebe-entegre-sirketi              to isyeri-adres-tasi  

        if genel-muha-uzak-ip not = spaces
           move "ASYA"             to efatr1-uzak-k-kodu-tasi
           move "E"                to efatr1-uzak-call 
           move isyeri-adres-tasi  to efatr1-uzak-isyeri-adres-tasi
           move genel-muha-uzak-ip to efatr1-uzak-ip       
           call "/asya/ytl/obj/muha/earsivprintmanager.asy" using efatr1-lnk
           on exception 
              move   "/asya/ytl/obj/muha/earsivprintmanager.asy" to  hatali-program-adi
              move yedek-k-kodu-tasi       to k-kodu-tasi
              move yedek-isyeri-adres-tasi to isyeri-adres-tasi
              perform callerr-proc
           not on exception
           cancel "/asya/ytl/obj/muha/earsivprintmanager.asy"
           end-call            
        else 
           call "/asya/ytl/obj/muha/earsivprintmanager.asy" using efatr1-lnk
           on exception 
               move   "/asya/ytl/obj/muha/earsivprintmanager.asy" to  hatali-program-adi
              move yedek-k-kodu-tasi       to k-kodu-tasi
              move yedek-isyeri-adres-tasi to isyeri-adres-tasi
              perform callerr-proc
           not on exception
           cancel "/asya/ytl/obj/muha/earsivprintmanager.asy"
           end-call
        end-if 
        
        move yedek-k-kodu-tasi       to k-kodu-tasi
        move yedek-isyeri-adres-tasi to isyeri-adres-tasi
     end-if.
*
 alsatek-odeme-bilgileri-yaz.       
    initialize alsatek-rec
    move "S"                        to alsatek-tipi   
    move rap-fat-tar                to alsatek-tarih
    move rap-fat-no                 to alsatek-belge-no 

    if cari-kodu not = spaces and cari-bulundu = 1
       move cari-kodu               to alsatek-toplam-hesap     
    end-if
    move "O"                        to alsatek-kaynak

    initialize takas-rec
    start takas key not < takas-anah invalid
         continue 
    not invalid 
    perform with test after until fs-takas = "10"
    read takas next no lock end move "10" to fs-takas
    not at end
             perform yromhrk-start         
    end-read 
    end-perform
    end-start.
*
 yromhrk-start.     
    initialize romhrk-rec odeme-kayit-sayi online-var
    move takas-folio        to romhrk-folio
    start romhrk key not < romhrk-anah invalid 
        continue 
    not invalid 
    perform with test after until fs-romhrk = "10"
    read romhrk next no lock end move "10" to fs-romhrk
    not at end 
           if romhrk-folio <> takas-folio
              exit perform 
           end-if
           if romhrk-ref <> takas-pen
               exit perform cycle 
           end-if 
              perform earsbil-oku            
    end-read 
    end-perform
    end-start


    initialize exthrk-rec    
    move takas-folio        to exthrk-folio
    start exthrk key not < exthrk-anah invalid 
        continue 
    not invalid 
    perform with test after until fs-exthrk = "10"
    read exthrk next no lock end move "10" to fs-exthrk
    not at end 
           if exthrk-folio <> takas-folio
              exit perform 
           end-if
           if exthrk-ref <> takas-pen
               exit perform cycle 
           end-if 
           move exthrk-rec  to romhrk-rec
              perform earsbil-oku            
    end-read 
    end-perform
    end-start


    write alsatek-rec invalid 
        REwrite alsatek-rec
    end-write
    
    if online-var = 1
       initialize yedek-alsat-ana-anahtar
       move alsat-ana-anahtar           to yedek-alsat-ana-anahtar
       initialize alsat-rec
       move alsatek-ana-anahtar(1:49)   to alsat-ana-anahtar(1:49)     
       start alsat key not < alsat-anahtar invalid 
            continue 
       not invalid 
       perform until fs-alsat = "10"
       read alsat next no lock end move "10"  to fs-alsat
       not at end 
               if alsat-ana-anahtar(1:49) <> alsatek-ana-anahtar(1:49)
                   exit perform 
               end-if 
               move "E"             to alsat-earsiv-online-satis
             
               rewrite alsat-rec end-rewrite 
       end-read 
       end-perform
       end-start
       move yedek-alsat-ana-anahtar   to alsat-ana-anahtar
       read alsat no lock invalid 
           continue 
       end-read 
    end-if.
*

 earsbil-oku.
      if romhrk-fatura-no > 0
         initialize depkod-rec
         move romhrk-depkod   to depkod-anah
         read depkod no lock invalid  
             continue  
         not invalid 
           initialize depkod2-rec 
           move depkod-anah to depkod2-anah
           read depkod2 no lock invalid continue end-read
          if depkod-ba = "A"

             add 1               to odeme-kayit-sayi
             initialize konuk-rec
             move takas-folio    to konuk-folio
             read konuk no lock invalid 
                  continue 
             not invalid 
                  initialize acenta-rec kayit-yok-earsbil
                  move konuk-acenta   to acenta-kodu
                  read acenta no lock invalid 
                       continue                                  
                  end-read 
****************       RAMAZAN BURAYAA BA
                  if acenta-online-rez-acentasi = 1 and konuk-fol-kodu = "R" and
                     depkod-turu = "4" |online rezervasyondan gelen bir folio krediye kalktýysa ASYA2WEB , booking , expedia
                       initialize earsbil-rec
                       move "R"                   to earsbil-tip
                       if konuk-fol-kodu = "R"
                          move konuk-rez-no       to earsbil-alt-anah
                       else
                          move konuk-extra-rez-no to earsbil-alt-anah
                       end-if 
                  end-if 
                  if depkod-ba = "A" and depkod-turu not = "4" 
                       initialize earsbil-rec 
                       move "F"              to earsbil-tip
                       move romhrk-anah      to earsbil-alt-anah                          
                  end-if 

                  read earsbil no lock invalid
                        move 1 to kayit-yok-earsbil
                  end-read  
                     if odeme-kayit-sayi < 11    
                        if kayit-yok-earsbil = 1
                           move romhrk-tarih               to earsbil-odeme-tarihi
                           evaluate depkod-turu
                           when 1
                              move 5                       to earsbil-odeme-tipi
                           when 3
                              move 5                       to earsbil-odeme-tipi  
                           when 4
                              move 5                       to earsbil-odeme-tipi  
                           when 5
                              move 1                       to earsbil-odeme-tipi  
                           when other 
                              move 5                       to earsbil-odeme-tipi                              
                           end-evaluate 
                           if depkod2-havale = 1                                      |firt 18/7/2019
                              move 2                       to earsbil-odeme-tipi
                           end-if
*/*****************************not datasý okunacak  earsbil-odeme-notu
                        end-if
 
                        move earsbil-odeme-tarihi          to alsatek-odeme-tarihi(odeme-kayit-sayi)
                        move earsbil-odeme-tipi            to alsatek-online-odeme-yontemi(odeme-kayit-sayi)
                        if earsbil-odeme-tipi = 5
                           move earsbil-odeme-notu         to alsatek-online-odeme-aciklama(odeme-kayit-sayi)                                                            
                        end-if
                        
                        if earsbil-odeme-web-adresi = spaces
                           move acenta-web-adresim         to earsbil-odeme-web-adresi
                        end-if 
                        if earsbil-odeme-web-adresi not = spaces
                           if acenta-online-rez-acentasi = 1  and  konuk-fol-kodu = "R"
                              move earsbil-odeme-web-adresi  to alsatek-online-web-site
                              move 1                         to online-var 
                           end-if 
                        end-if 
                        move earsbil-kredi-karti           to alsatek-kredi-karti(odeme-kayit-sayi)
                        move earsbil-kredi-karti-onay-no   to alsatek-kredi-karti-onay-no(odeme-kayit-sayi) 
                        move depkod-adi                    to alsatek-odeme-departman-adi(odeme-kayit-sayi)
                        move romhrk-tl-tutar               to alsatek-det-odeme-tutar(odeme-kayit-sayi)

                        if alsatek-online-odeme-aciklama(odeme-kayit-sayi) = spaces
                           move depkod-adi                 to alsatek-online-odeme-aciklama(odeme-kayit-sayi) 
                        end-if
                     end-if                                                                                                   
             end-read                  
          end-if 
         end-read 
      end-if.
*
 acc-fat-no-Aft-Procedure.
     open i-o fatura gerfat
     initialize fatura-rec
     move rap-fat-no        to fatura-no
     move 0                    to fatura-sira
     read fatura no lock invalid
          continue
     end-read
     move FATURA-GERCEK-FAT  to rap-ger-no
     move FATURA-onek        to rap-ger-seri
     display   acc-ger-no acc-ger-seri
     close fatura gerfat.
*      
 acc-ger-no-Aft-Procedure.
      open i-o fatura gerfat
       initialize gerfat-rec
         move rap-ger-seri      to gerfat-onek
         move rap-ger-no        to gerfat-gerfatno
         read gerfat no lock key  gerfat-gerfat invalid 
             
            display message box "Bulunamadi"
            close fatura gerfat
             perform acc-fat-no-Aft-Procedure
            not invalid
             close fatura gerfat
             move gerfat-no to rap-fat-no
             display  acc-fat-no
          end-read.
*
 firma-sorgula. 
        if rap-tcno = spaces or zeroes
           exit paragraph
        end-if

        initialize tnb-rec firma-faturasi
        move all low-values    to exe-param-gonder
        move "13324970256"     to vkn-smmm-tc tckn-smmm-tc
        move "24879630"        to vkn-smmm-password tckn-smmm-password
*        move xc-vergi-no       to vkn-query-vkn
        move rap-tcno          to tckn-query-tckn
        move "tnbsorgu"        to vkn-smmm-parameter tckn-smmm-parameter
*        if xc-vergi-no <> spaces                                                               | |daha sonra gerekirse açýlacak silemeyelim
*           inspect islem-anahtar-vkn replacing trailing spaces by low-values
*           string exe-param-gonder
*                  "@[DISPLAY]:C:\acucorp\acucbl701\acugt\bin\bulu.exe " delimited by low-values
*                  islem-anahtar-vkn                                     delimited by low-values
*           into exe-param-gonder
*        end-if
        if rap-tcno <> spaces 
           inspect islem-anahtar-tckn replacing trailing spaces by low-values
           string exe-param-gonder
                  "@[DISPLAY]:C:\acucorp\acucbl701\acugt\bin\bulu.exe " delimited by low-values
                  islem-anahtar-tckn                                    delimited by low-values
           into exe-param-gonder           
        end-if

        inspect exe-param-gonder replacing all low-values by spaces 
    
                       
        call "c$copy"   using "/asya/ytl/exe/bulu.exe.config",
                              "@[DISPLAY]:\acucorp\acucbl701\acugt\bin\bulu.exe.config"

        call "c$copy"   using "/asya/ytl/exe/bulu.exe",
                              "@[DISPLAY]:\acucorp\acucbl701\acugt\bin\bulu.exe"

        call "c$system" using exe-param-gonder, 384                                     || gonder gitsin dayýjým

        call "c$copy"   using "@[DISPLAY]:\acucorp\acucbl701\acugt\bin\tnbsorgu.asya",
                              "/asya/ytl/liste/tnbsorgu.asya"
        open input liste
        perform with test after until 1 = 0
        initialize liste-rec
        read liste next no lock end exit perform
        not at end
         
            unstring liste-rec delimited by "|" into
                     tnb-unvan        
                     tnb-SorguKimlikNO
                     tnb-adi          
                     tnb-soyadi       
                     tnb-baba-adi     
                     tnb-VergiDairesiAdi          
                     tnb-VergiDairesiKodu         
                     tnb-vkn         
                     tnb-SorguKimlikNOTipi        
                     tnb-SirketTuru   
                     tnb-MeslekKodu   
                     tnb-MeslekAdi    
                     tnb-FaalTerkBilgisi          
                     tnb-IlAdi        
                     tnb-IlceAdi      
                     tnb-IlKodu       
                     tnb-MahalleSemt  
                     tnb-CaddeSokak   
                     tnb-KapiNO       
                     tnb-DaireNO      
                     tnb-IkametgahAdresi-IlAdi    
                     tnb-IkametgahAdresi-IlceAdi  
                     tnb-IkametgahAdresi-IlKodu   
                     tnb-IkametgahAdresi-MahalleSemt     
             
            if tnb-MeslekKodu <> "009000"
               move 1 to firma-faturasi
            end-if

        end-read
        end-perform
        close liste
        delete file liste.
*
 acc-tcno-Aft-Procedure. 
      if genel2-e-arsiv-e-fatura-kullanici-degil = 1
         perform firma-sorgula
      end-if
     .
*
 fatura-no-ata.
      move 4 to folfat-seri
      compute rap-fat-no = genel-fol-fat-no4  + 1
      display acc-fat-no
      perform acc-fat-no-Aft-Procedure 
    .
*
 uyumsoft-kodlari-aktar.
     move uym-il   to rap-il 
     move uym-ulke to rap-ulke 
     move uym-vd   to rap-vd
     display acc-il 
             acc-ulke 
             acc-vd
    .
*
 acc-ulke-Aft-Procedure.
    if genel2-uyumsoft-fat-ent-devrede = 1 and 
       rap-ulke <> spaces 
       open input kodtan
       initialize kodtan-rec 
       move "U"      to kodtan-tipi 
       move uym-ulke to kodtan-kodu 
       read kodtan no lock invalid
            move "Tanimsiz.." to kodtan-adi
            display message box "Tanimsiz Ulke.."
            move 4    to accept-control
            move 4071 to control-id
       end-read 
       move kodtan-adi to rap-ulke 
       display acc-ulke
       close kodtan 
    end-if
     .
*
 acc-il-Aft-Procedure.
    if genel2-uyumsoft-fat-ent-devrede = 1 and
       rap-il <> spaces 
       open input kodtan
       initialize kodtan-rec 
       move "P"      to kodtan-tipi 
       move uym-il   to kodtan-kodu 
       read kodtan no lock invalid
            move "Tanimsiz.." to kodtan-adi
            display message box "Tanimsiz il.."
            move 4    to accept-control
            move 4061 to control-id
       end-read 
       move kodtan-adi to rap-il 
       display acc-il
       close kodtan 
    end-if
     .
*
 acc-ilce-Aft-Procedure.
    if genel2-uyumsoft-fat-ent-devrede = 1 and uym-il <> spaces 
       open input kodtan 
       initialize kodtan-rec 
       move "P"      to kodtan-tipi 
       move uym-il   to kodtan-kodu 
       read kodtan no lock invalid
            move "Tanimsiz.." to kodtan-adi
            display message box "Tanimsiz il.."
       end-read 
       move kodtan-adi to rap-il 
       display acc-il
       if kodtan-adi = "Tanimsiz.."
          move 4    to accept-control
          move 4061 to control-id
          exit paragraph 
       end-if

       initialize kodtan-rec devamke
       move "G"      to kodtan-tipi 
       move rap-il   to kodtan-adi
       start kodtan key not < kodtan-anahtar1 invalid
             continue
       not invalid
       perform with test after until fs-kodtan = "10"
       read kodtan next no lock end move "10" to fs-kodtan
       not at end 
           if kodtan-tipi <> "G" 
              exit perform 
           end-if
           if kodtan-adi <> rap-il 
              exit perform 
           end-if
           if kodtan-kodu = rap-ilce 
              move 1 to devamke
              exit perform 
           else          
              move 0 to devamke
           end-if
       end-read 
       end-perform 
       end-start 
       if devamke = 0 
          display message box "Tanimsiz ilce.." 
          move "Tanimsiz.." to rap-ilce 
          display acc-ilce 
          move 4    to accept-control
          move 4051 to control-id
       end-if
       close kodtan 
    end-if
     .

 
