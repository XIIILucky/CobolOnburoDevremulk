* folfat2.evt
* folfat2.evt is generated from D:\asya\acugt.kaya\otel\folfat2.Psf
* This is a generated file. DO NOT modify this file directly.


 Form1-Exception-Proc.
     PERFORM Ex-Oth-Form1
     .

 cb-durum-Exception-Proc.
* 
     IF Event-Occurred
        EVALUATE Event-Type
        WHEN Ntf-Selchange
           PERFORM Ex-Ntf-Sel-Durum
        END-EVALUATE
     ELSE
        PERFORM Ex-Oth-Form1
     END-IF
     .

 acc-oda-no-Exception-Proc.
     PERFORM Ex-Oth-oda-no
     .

 pb-oda-no-Exception-Proc.
     PERFORM Ex-Oth-Oda-No
     .

 cb-tipi-Exception-Proc.
* 
     IF Event-Occurred
        EVALUATE Event-Type
        WHEN Ntf-Selchange
           PERFORM Goster-Gd-Sec
        END-EVALUATE
     ELSE
        PERFORM Ex-Oth-Form1
     END-IF
     .

 acc-acenta-Exception-Proc.
     PERFORM Ex-Oth-Acenta
     .

 pb-acenta-Exception-Proc.
     PERFORM Ex-Oth-Acenta
     .

 cb-doviz-Exception-Proc.
* 
     IF Event-Occurred
        EVALUATE Event-Type
        WHEN Ntf-Selchange
           PERFORM Ex-Ntf-Sel-Doviz
        END-EVALUATE
     ELSE
        PERFORM Ex-Oth-Form1
     END-IF
     .

 gd-sec-Event-Proc.
* 
     EVALUATE Event-Type
     WHEN Msg-Begin-Entry
        PERFORM Msg-Begin-Entry-sec
     WHEN Msg-Bitmap-Clicked
        PERFORM Msg-Bmp-Click-Sec
     WHEN Msg-Goto-Cell
        PERFORM Msg-Goto-Sec
     WHEN Msg-Goto-Cell-Mouse
        PERFORM Msg-Goto-Sec
     END-EVALUATE
     .

 gd-yaz-Event-Proc.
* 
     EVALUATE Event-Type
     WHEN Msg-Begin-Entry
        PERFORM Msg-Begin-Entry-Yaz
     WHEN Msg-Bitmap-Clicked
        PERFORM Msg-Bmp-Click-Yaz
     WHEN Msg-Goto-Cell
        PERFORM Msg-Goto-Yaz
     WHEN Msg-Goto-Cell-Mouse
        PERFORM Msg-Goto-Yaz
     END-EVALUATE
     .

 gd-yaz-Exception-Proc.
     PERFORM gd-yaz-Ex-Other
     .

 acc-kdv-oran-Exception-Proc.
* 
     IF Event-Occurred
        EVALUATE Event-Type
        WHEN Ntf-Changed
           PERFORM Aft-Proc-Oran-Kdv
        END-EVALUATE
     ELSE
        PERFORM Ex-Oth-Form1
     END-IF
     .

 Form2-Event-Proc.
     .

 Form2-Gd-1-Event-Proc.
     PERFORM Form2-Gd-1-Ev-Other
     .
***   start event editor code   ***
*
 Bef-Create-Form1.
     perform adresleri-tasi
       
     call "c$narg" using link-var.
     perform oku-genel
     move muha-sirketi to cari-dosya-adres
     perform oku-doviz
     perform init-rap-vars
     initialize toplamlar
     move 8 to gd-sec-n-x
     move 9 to gd-yaz-n-x
     .
     perform ara-dosya-yarat.
*
 Form1-Aft-Initdata. 
            
     display cb-durum cb-tipi cb-fat-tipi cb-doviz
      if link-var not = 3 then 
*         display message box "Lutfen Folio icerisinden deneyiniz "
*               title " " 
               
*                set exit-pushed to true
*                  exit paragraph           
      else
            if link-pencere = 0 then 
                  display message box "Lutfen Folio icerisinden deneyiniz "
                       title " "
                  set exit-pushed to true
                  exit paragraph
           end-if
     end-if
     if link-var > 0
         open input konuk
         move link-fol-no to konuk-folio
         read konuk no lock
            invalid 
              display message box "Folio Bulunamadi"
              set exit-pushed to true
              exit paragraph
            not invalid
              move konuk-odano to rap-oda-no
              move konuk-durumu to rap-durum
              move konuk-git-tar to rap-ilk-tar
              move konuk-git-tar to rap-son-tar
         end-read 
         display acc-oda-no  cb-durum acc-oda-no acc-ilk-gun acc-ilk-ay
             acc-ilk-yil acc-son-gun acc-son-ay acc-son-yil
*         perform goster-gd-sec
         close konuk
     end-if
     perform init-grid-yaz
     perform goster-gd-sec
      if link-var > 0 
         
             move 2 to event-data-1 
             move 2 to event-data-2 
             perform msg-bmp-click-sec
     end-if
*/-----------------------------\*  
*/---------DIL AYARLA----------\*    
*/-----------------------------\*    
     perform dil-ayarla-proc.
*/-----------------------------\*         
     .
*
 Bef-Proc-gtop-vars.
     move gtop-vars to sakla-gtop-vars
     .
*
 Ex-Oth-Form1.
     evaluate key-status
       when 2 perform yaz-fatura
       when 3 initialize sakla-filtre-vars
              perform init-grid-yaz
              perform goster-gd-sec
       when 4 perform ata-folio-fatura
       when 5 perform ara-cari
              perform ata-cari-fatura
       when 6
*       if hist-oz-fih-tek
*                 display message box
*                   "Bu modul Yapim asamasindadir"
*                   perform ara-fihrist
*                   perform ata-fihrist-fatura
*              else
*                 perform ara-fihrist
*                 perform ata-fihrist-fatura
*              end-if
       when 7 perform ata-ozluk2-fatura
       when 8 perform ata-acenta-fatura
       when 18 perform  ata-baska-acenta-fatura
       when 11 perform gd-yaz-Ex-Other
     end-evaluate
     .
*
 Ex-Oth-oda-no.
     evaluate key-status
       when 1     perform ara-oda-no
       when other perform Ex-Oth-Form1
     end-evaluate
     .
*
 Ex-Oth-acenta.
     evaluate key-status
       when 1     perform ara-acenta
       when other perform Ex-Oth-Form1
     end-evaluate
     .
*
 Ex-Ntf-Sel-durum.
     evaluate true
       when rap-inhouse set status-in  to true
       when rap-history set status-his to true
     end-evaluate
     perform goster-alanlar
     perform goster-gd-sec
     .
*
 Ex-Ntf-Sel-doviz.
     perform init-grid-yaz
     perform goster-gd-sec
     .
*
 msg-Goto-sec.
     set event-action to event-action-fail
     move event-data-1 to gd-sec-x
     move event-data-2 to gd-sec-y
     perform isaretle-gd-sec
     perform oku-gd-sec
     perform bul-konuk-yaz
     .
*
 msg-Goto-yaz.
     set event-action to event-action-fail
     move event-data-1 to gd-yaz-x
     move event-data-2 to gd-yaz-y
     perform isaretle-gd-yaz
     perform oku-gd-yaz
     perform bul-konuk-sec
     .
*
 Msg-Begin-Entry-sec. 
           
     set event-action to event-action-fail
     inquire gd-sec,
       entry-reason in gd-sec-tus
     evaluate gd-sec-tus
       when x"00"
       when x"0D"
       when "+"
       when "-"
       when space 
         perform ekle-cikar-sec
     end-evaluate
     .
*
 Msg-Begin-Entry-yaz.
     set event-action to event-action-fail
     inquire gd-yaz,
       entry-reason in gd-yaz-tus
     evaluate gd-yaz-tus
       when x"00"
       when x"0D"
       when "+"
       when "-"
       when space perform ekle-cikar-yaz
     end-evaluate
     .
*
 Msg-bmp-Click-sec.
     set event-action to event-action-fail
     perform msg-Goto-sec
     perform ekle-cikar-sec
     .
*
 Msg-bmp-Click-yaz.
     set event-action to event-action-fail
     perform msg-Goto-yaz
     perform ekle-cikar-yaz
     .
*
 Aft-Proc-ind-oran.
     if gtop-vars not = sakla-gtop-vars
        perform hesap-ind-yeniden
        move gtop-vars to sakla-gtop-vars
     end-if
     .
*
 Aft-Proc-ind.
     if gtop-vars not = sakla-gtop-vars
        compute oran-ind rounded
              = ( gtop-ind / gtop-top ) * 100
        move gtop-ind to sakla-ind
        perform hesap-ind-yeniden
        compute gtop-net rounded
              = gtop-net - ( gtop-ind - sakla-ind )
        compute gtop-kdv rounded
              = gtop-kdv + ( gtop-ind - sakla-ind )
        compute gtop-ind rounded
              = gtop-ind - ( gtop-ind - sakla-ind )
        move gtop-vars to sakla-gtop-vars
        perform goster-gtop
     end-if
     .
*
 Aft-Proc-net.
     if gtop-vars not = sakla-gtop-vars
        compute gtop-ind rounded
              = gtop-top - gtop-net
        compute oran-ind rounded
              = ( gtop-ind / gtop-top ) * 100
        move gtop-net to sakla-net
        perform hesap-ind-yeniden
        compute gtop-kdv rounded
              = gtop-kdv + ( gtop-net - sakla-net )
        compute gtop-ind rounded
              = gtop-ind - ( gtop-net - sakla-net )
        compute gtop-net rounded
              = gtop-net - ( gtop-net - sakla-net )
        move gtop-vars to sakla-gtop-vars
        perform goster-gtop
     end-if
     .
*
 Aft-Proc-oran-kdv.
    EXIT
    .
*
 Aft-Proc-kdv.
     EXIT
     .
*
 Aft-Proc-gen.
     if gtop-vars not = sakla-gtop-vars
        if sakla-gen = zeroes
           move zero to oran-ind
           move gtop-gen  to sakla-gen
           perform hesap-ind-yeniden
           move sakla-gen to gtop-gen
        end-if
        compute gtop-net rounded
              = ( gtop-net * gtop-gen ) / sakla-gen
        compute gtop-ind rounded
              = gtop-top - gtop-net
        compute oran-ind rounded
              = ( gtop-ind / gtop-top ) * 100
        move gtop-gen to sakla-gen
        perform hesap-ind-yeniden
        compute gtop-ind rounded
              = gtop-ind + ( gtop-gen - sakla-gen )
        compute gtop-net rounded
              = gtop-net - ( gtop-gen - sakla-gen )
        compute gtop-gen rounded
              = gtop-gen - ( gtop-gen - sakla-gen )
        move gtop-vars to sakla-gtop-vars
        perform goster-gtop
     end-if
     .
*
 Aft-Proc-gen-dv.
     if gtop-vars not = sakla-gtop-vars
        if sakla-gen-dv = zeroes
           move zero to oran-ind
           move gtop-gen-dv  to sakla-gen-dv
           perform hesap-ind-yeniden
           move sakla-gen-dv to gtop-gen-dv
        end-if
        compute gtop-net rounded
              = ( gtop-net * gtop-gen-dv ) / sakla-gen-dv
        compute gtop-ind rounded
              = gtop-top - gtop-net
        compute oran-ind rounded
              = ( gtop-ind / gtop-top ) * 100
        move gtop-gen-dv to sakla-gen-dv
        perform hesap-ind-yeniden
        compute gtop-ind rounded
              = gtop-ind + ( gtop-gen-dv - sakla-gen-dv )
        compute gtop-net rounded
              = gtop-net - ( gtop-gen-dv - sakla-gen-dv )
        compute gtop-gen rounded
              = gtop-gen - ( gtop-gen-dv - sakla-gen-dv )
        compute gtop-gen-dv rounded
              = gtop-gen-dv - ( gtop-gen-dv - sakla-gen-dv )
        move gtop-vars to sakla-gtop-vars
        perform goster-gtop
     end-if
     .
*
 aft-proc-acenta.
     open i-o acenta
     initialize acenta-rec
     move rap-acenta to acenta-kodu
     perform oku-acenta
     move acenta-adi to rap-acenta-adi
     close acenta
     display acc-acenta
             lb-acenta-adi
     perform Goster-Gd-Sec
     .
*
 init-rap-vars.
     set rap-inhouse   to true
     set rap-fol-hepsi to true
     set status-in     to true
     move Tarih-Tasi   to rap-fat-tar
                          rap-ilk-tar
     move 1            to rap-ilk-gun
     move Donem-Sonu   to rap-son-tar
     .
*
 init-grid-sec.
     perform ata-gd-sec-baslik
     modify gd-sec,
       reset-grid    = 1
       record-to-add = gd-sec-rec
     .
*
 init-grid-yaz.
     initialize rap-fat-bilgiler
                gtop-vars
     perform ata-gd-yaz-baslik
     modify gd-yaz,
       reset-grid    = 1
       record-to-add = gd-yaz-rec
     perform goster-fatura-bilgileri
     perform goster-gtop
     close ara
      delete file ara.
      open output ara close ara open i-o ara.
     .
*
 start-konuk-inhouse.
     open i-o konuk
     initialize konuk-git-tar
     start konuk key >= konuk-oda
       invalid
         perform hata-kayit-yok
       not invalid
         initialize fs-konuk
         perform with test after
                 until fs-konuk = "10"
           perform oku-konuk-inhouse
         end-perform
     end-start
     close konuk
     .
*
 start-konuk-history.
     open i-o konuk
     move rap-son-tar to konuk-git-tar
     start konuk key <= konuk-git
       invalid
         perform hata-kayit-yok
       not invalid
         initialize fs-konuk
         perform with test after
                 until fs-konuk = "10"
           perform oku-konuk-history
         end-perform
     end-start
     close konuk
     .
*
 start-romhrk.
     open i-o romhrk
              depkod
     initialize romhrk-rec
     move gd-sec-folio to romhrk-folio
     start romhrk key >= romhrk-anah
       invalid
         continue
       not invalid
         initialize fs-romhrk
         perform with test after
                 until fs-romhrk = "10"
           perform oku-romhrk
         end-perform
     end-start
     close romhrk
           depkod
     .
*
 start-exthrk.
     open i-o exthrk
              depkod
     initialize exthrk-rec
     move gd-sec-folio to exthrk-folio
     start exthrk key >= exthrk-anah
       invalid
         continue
       not invalid
         initialize fs-exthrk
         perform with test after
                 until fs-exthrk = "10"
           perform oku-exthrk
         end-perform
     end-start
     close exthrk
           depkod
     .
*
 oku-genel.
     open input genel
     move 1 to genel-anahtar
     read genel no lock
       invalid
         continue
     end-read
     close genel
     .
*
 oku-grid-sec.
     set status-islem to true
     perform goster-kayit
     initialize konuk-rec
     move rap-durum to konuk-durumu
     evaluate true
       when rap-inhouse perform start-konuk-inhouse
       when rap-history perform start-konuk-history
     end-evaluate
     set status-hazir to true
     perform goster-kayit
     .
*
 oku-konuk.
     read konuk no lock
       invalid
         initialize konuk-rec
     end-read
     .
*
 oku-konuk-inhouse.
     read konuk next no lock
       end
         move "10" to fs-konuk
       not end
         perform filtre-konuk-bitir
     end-read
     .
*
 oku-konuk-history.
     read konuk previous no lock
       end
         move "10" to fs-konuk
       not end
         perform filtre-konuk-bitir
     end-read
     .
*
 oku-romhrk.
     read romhrk next no lock
       end
         move "10" to fs-romhrk
       not end
         perform filtre-romhrk-bitir
     end-read
     .
*
 oku-exthrk.
     read exthrk next no lock
       end
         move "10" to fs-exthrk
       not end
         perform filtre-exthrk-bitir
     end-read
     .
*
 oku-depkod.
     read depkod no lock
       invalid
         initialize depkod-rec
         move 18 to oran-kdv
       not invalid
         if oran-kdv = spaces or
            oran-kdv = zeroes
            move depkod-kdv to oran-kdv
         end-if
         if depkod-kdv not = oran-kdv
            move 18 to oran-kdv
         end-if
     end-read
     .
*
 oku-doviz.
     open i-o doviz
     initialize doviz-rec
     move onkpara-doviz to doviz-kodu
     read doviz no lock
       invalid
         initialize doviz-rec
     end-read
     close doviz
     .
*
 oku-ozluk.
     read ozluk no lock
       invalid
         initialize ulke-rec
     end-read
     .
*
 oku-ozluk2.
     read ozluk2 no lock
       invalid
         initialize ozluk2-rec
     end-read
     .
*
 oku-ulke.
     read ulke no lock
       invalid
         initialize ulke-rec
     end-read
     .
*
 oku-cari.
     read cari no lock
       invalid
         perform oku-cari-noktasiz
     end-read
     .
*
 oku-cari-noktasiz.
     move cari-kodu to cari-noktasiz
     initialize cari-kodu
     read cari no lock
       key is cari-noktasiz
       invalid
         initialize cari-rec
     end-read
     .
*
 oku-acenta.
     read acenta no lock
       invalid
         move "Hepsi" to acenta-adi
     end-read
     .
*
 oku-fihrist.
     move fihara-anahtar to fihrist-anahtar
     read fihrist no lock
       invalid
         move "Hepsi" to acenta-adi
     end-read
     .
*
 oku-gd-sec.
     inquire gd-sec(gd-sec-y)
       record-data     in gd-sec-rec
     .
*
 oku-gd-yaz.
     inquire gd-yaz(gd-yaz-y)
       record-data     in gd-yaz-rec
   

     inquire gd-yaz(gd-yaz-y,2)
       hidden-data     in top-top-8
     inquire gd-yaz(gd-yaz-y,3)
       hidden-data     in top-gen-8

     inquire gd-yaz(gd-yaz-y,4)
       hidden-data     in top-kdv-8
     inquire gd-yaz(gd-yaz-y,5)
       hidden-data     in top-top
     inquire gd-yaz(gd-yaz-y,6)
       hidden-data     in top-kdv
     inquire gd-yaz(gd-yaz-y,7)
       hidden-data     in top-gen
     inquire gd-yaz(gd-yaz-y,8)
       hidden-data     in top-gen-dv
     .
*
 yaz-fatura.
     inquire gd-yaz,
       last-row in gd-yaz-n-y
     if gd-yaz-n-y < 2
        perform hata-fatura-bilgi-yok
     else
        perform islem-fatura
     end-if
     .
*
 yaz-grid-sec.
*/ust gride eklenen yer........
     perform ata-konuk-gd-sec
     perform bul-konuk-yaz


*        if konuk-folio =
*        end-if
*      end-if
    
    initialize pencere-toplamlar romhrk-rec exthrk-rec
       open input  romhrk exthrk

    move konuk-folio to romhrk-folio exthrk-folio
     if konuk-fol-kodu = "R"  then
             start romhrk key > romhrk-anah invalid
                continue
                not invalid
                perform until fs-romhrk = "10"
                read romhrk next no lock 
                   end move "10" to fs-romhrk
                   not end
                     if romhrk-folio not = konuk-folio 
                        move "10" to fs-romhrk
                        else
                        move romhrk-rec to hrkgir-rec
                       if link-var = 0
                           perform topla
                       else
                          if link-var > 0 and link-pencere = romhrk-ref
                              perform topla
                          end-if 
                       end-if 
                        
                    end-if
                end-read
                end-perform
             end-start

          else
            start exthrk key > exthrk-anah invalid
                continue
                not invalid
                  perform until fs-exthrk = "10"
                read exthrk next no lock 
                   end move "10" to fs-exthrk
                   not end
                     if exthrk-folio not = konuk-folio 
                        move "10" to fs-exthrk
                        else
                        move exthrk-rec to hrkgir-rec
                       if link-var = 0
                           perform topla
                       else
                          if link-var > 0 and link-pencere = exthrk-ref
                              perform topla
                          end-if 
                       end-if 
                    end-if
                end-read
                end-perform
             end-start

      end-if
     perform pen-yukle
 
      close   romhrk exthrk
 
      .
topla.
    if hrkgir-ref = 0
        move 1 to hrkgir-ref
    end-if 
     move 1 to p-var(hrkgir-ref)
    if hrkgir-ba= "B"
      add hrkgir-tl-tutar to p-bakiye(hrkgir-ref)
      else
      subtract hrkgir-tl-tutar from p-bakiye(hrkgir-ref)
    end-if
    if hrkgir-fatura-no > 0 then
      continue
      else
 
      move 1 to p-fatura(hrkgir-ref)
    end-if
    


      .
*
 pen-yukle.
     
      open input folref 

       move 1 to kayit-sayi   
     
      perform varying ii from 1 by 1 until ii > 10
              if p-var(ii) = 1 then
                               add 1 to kayit-sayi
                      if      p-bakiye(1) = 0  and
                              p-bakiye(2) = 0    and
                              p-bakiye(3) = 0   and
                              p-bakiye(4) = 0   and
                              p-bakiye(5) = 0   and
                              p-bakiye(6) = 0      and
                              p-bakiye(7) = 0    and
                              p-bakiye(8) = 0   and
                              p-bakiye(9) = 0  
                     inquire gd-sec,
                       last-row in gd-sec-n-y 

                                initialize    folref-rec
                                 move konuk-folio to folref-folio
                                 move ii          to folref-ref
                                 read folref no lock invalid
                                     continue
                                 end-read
                                 move folref-ref to gd-sec-pen
                               
                                     add 1 to gd-sec-n-y giving gd-sec-y

                                     modify gd-sec(gd-sec-y,1)
                                       record-to-add   = gd-sec-rec
                                       row-color       = gd-renk-x
                                       bitmap          = artieksi-bmp
                                       bitmap-number   = gd-img-no 
                                       bitmap-width    = 16
                                       bitmap-trailing = 1                          
                       else
                            exit perform cycle 
                       end-if              

      
             end-if
       end-perform
           close folref.    
     .
*
 yaz-grid-yaz.
     perform ata-gd-yaz
     modify gd-yaz(gd-yaz-y,1)
       insertion-index = gd-yaz-y
       record-to-add   = gd-yaz-rec
       bitmap          = artieksi-bmp
       bitmap-number   = 7
       bitmap-width    = 16
       bitmap-trailing = 1
       start-x         = 1
       x               = gd-yaz-n-x
       start-y         = gd-yaz-y
       y               = gd-yaz-y
       region-color    = 493
       modify gd-yaz(gd-yaz-y,2)
       hidden-data     = top-top-8
     modify gd-yaz(gd-yaz-y,3)
       hidden-data     = top-gen-8
      modify gd-yaz(gd-yaz-y,4)
       hidden-data     = top-kdv-8
     modify gd-yaz(gd-yaz-y,5)
       hidden-data     = top-top
     modify gd-yaz(gd-yaz-y,6)
       hidden-data     = top-kdv
     modify gd-yaz(gd-yaz-y,7)
       hidden-data     = top-gen
     modify gd-yaz(gd-yaz-y,8)
       hidden-data     = top-gen-dv
     modify gd-sec(gd-sec-y,1)
       row-color       = 112
       bitmap-number   = 7
     perform hesap-ekle-gtop
     perform Hesap-Ind-Yeniden
     perform goster-gtop
     if rap-adi = spaces
        perform ata-folio-fatura
     end-if
     .
*
 yaz-formyaz.
     write formyaz-rec
       invalid
         rewrite formyaz-rec, end-rewrite
     end-write
     .
*
 cik-grid-yaz.
     perform oku-gd-yaz
     modify gd-yaz(gd-yaz-y)
       record-to-delete = gd-yaz-y
     modify gd-sec(gd-sec-y,1)
       row-color       = 0
       bitmap-number   = 1
     perform hesap-cikar-gtop
     perform Hesap-Ind-Yeniden
     perform goster-gtop
     .
*
 filtre-konuk-bitir.
     if rap-durum not = konuk-durumu or
*****   Konuk durumu degisirse bitir
        (rap-history and
         rap-ilk-tar > konuk-git-tar)
*****    Rapor History ise geriye dogru okundugundan
*****    ilk tarihten kucuk olunca bitir
        move "10" to fs-konuk
     else
        perform filtre-konuk-yaz
     end-if
     .
*
 filtre-konuk-yaz.
     if ( rap-fol-hepsi or
         rap-tipi = konuk-fol-kodu) and
        ( rap-oda-hepsi or
         (rap-oda-no = konuk-odano)) and
        ( rap-acenta-hepsi or
         (rap-acenta = konuk-acenta))
        and ( link-var = 0 or link-fol-no = konuk-folio)
        perform yaz-grid-sec
     end-if
     .
*
 filtre-romhrk-bitir.
     if romhrk-folio not = gd-sec-folio
        move "10" to fs-romhrk
     else
        perform hesap-romhrk-folio
     end-if
     .
*
 filtre-exthrk-bitir.
     if exthrk-folio not = gd-sec-folio
        move "10" to fs-exthrk
     else
        perform hesap-exthrk-folio
     end-if
     .
*
 ata-gd-sec-baslik.
     move "Sec"        to gd-sec-buton
     move "Oda"        to gd-sec-odano
     move "T"          to gd-sec-tipi
     move "Folio"      to gd-sec-folio
     move "Adi"        to gd-sec-adi
     move "Soyadi"     to gd-sec-soyadi
     move "Gir.Tarihi" to gd-sec-gir-tar
     move "Cik.Tarihi" to gd-sec-git-tar
     .
*
 ata-gd-yaz-baslik.
     evaluate true
       when rap-kur-tl
         move "Sec"          to gd-yaz-buton
         move "Oda"          to gd-yaz-odano
         move "T"            to gd-yaz-tipi
         move "Folio"        to gd-yaz-folio
         move "Toplam"       to gd-yaz-top
         move "KDV"          to gd-yaz-kdv
         move "Genel Toplam" to gd-yaz-gen
         move "Doviz Toplam" to gd-yaz-gen-dv
         move "Doviz"        to gd-yaz-dv-adi
       when rap-kur-dv
         move "Sec"          to gd-yaz-buton
         move "Oda"          to gd-yaz-odano
         move "T"            to gd-yaz-tipi
         move "Folio"        to gd-yaz-folio
         move "Doviz Toplam" to gd-yaz-top
         move "Doviz KDV"    to gd-yaz-kdv
         move "Doviz G.Toplam" to gd-yaz-gen
         move "YTL Toplam"   to gd-yaz-gen-dv
         move "Doviz"        to gd-yaz-dv-adi
     end-evaluate
     .
*
 ata-konuk-gd-sec.
     initialize gd-sec-rec
     move konuk-odano    to gd-sec-odano
     move konuk-fol-kodu to gd-sec-tipi

     move konuk-folio    to gd-sec-folio
     move konuk-adi      to gd-sec-adi
     move konuk-soyadi   to gd-sec-soyadi
     move konuk-gel-gun  to z-gun
     move konuk-gel-ay   to z-ay
     move konuk-gel-yil  to z-yil
     move z-tarih        to gd-sec-gir-tar
     move konuk-git-gun  to z-gun
     move konuk-git-ay   to z-ay
     move konuk-git-yil  to z-yil
     move z-tarih        to gd-sec-git-tar
     
     .
*
 ata-gd-yaz.
     initialize gd-yaz-rec
     perform hesap-folio
     move gd-sec-odano   to gd-yaz-odano
     move gd-sec-tipi    to gd-yaz-tipi
     move gd-sec-folio   to gd-yaz-folio
     move gd-sec-pen     to Gd-yaz-pen
     move top-top        to z15v99
     move z15v99         to gd-yaz-top
     move top-kdv        to z15v99
     move z15v99         to gd-yaz-kdv
     move top-gen        to z15v99
     move z15v99         to gd-yaz-gen
     move top-gen-dv     to z15v99
     move z15v99         to gd-yaz-gen-dv
     evaluate true
       when rap-kur-tl
         move d-kisa-adi to gd-yaz-dv-adi
       when rap-kur-dv
         move "YTL"      to gd-yaz-dv-adi
     end-evaluate
     .
*
 ata-folio-fatura.
     initialize rap-vd,
                rap-vno
     open input ozluk2
      open input konuk
                ozluk
                ulke folref musteri
     initialize konuk-rec
                ozluk-rec
                ulke-rec
     perform oku-gd-sec
     move gd-sec-folio to konuk-folio
                          ozluk-folio
     perform oku-konuk
     perform oku-ozluk         
     initialize ozluk2-rec
                
     perform oku-gd-sec
     move gd-sec-folio to ozluk2-folio
                          
     perform oku-ozluk2
     if link-var > 0 and link-pencere > 0 then
           move konuk-folio to folref-folio
           move link-pencere to folref-ref
           read folref no lock invalid
              continue
              not invalid
                move folref-profil-anah  to musteri-anah(2:)
                read musteri no lock invalid  continue
                not invalid
                   move musteri-unvan1     to rap-adi   
                   move musteri-unvan2     to rap-soyadi
                   move musteri-adres1     to rap-adr1  
                   move musteri-adres2     to rap-adr2  
                   move musteri-vdairesi   to rap-vd 
                   move musteri-vno        to rap-vno   
                   move musteri-il         to rap-il
                   move musteri-ilce       to rap-ilce  
                    
                  end-read
           end-read

     end-if
       
     if  ozluk2-fat-unvan-1  = spaces and KONUK-FOL-KODU not = "R" then 
          move gd-sec-folio to ozluk2-folio
         compute ozluk2-folio    =   ozluk2-folio  - 1
          perform oku-ozluk2
     end-if
     if rap-adi = spaces and rap-soyadi = spaces then 
     move ozluk2-fat-unvan-1     to rap-adi
     move ozluk2-fat-unvan-2     to rap-soyadi
     move ozluk2-fat-adres-1     to rap-adr1
     move ozluk2-fat-adres-2     to rap-adr2
     move ozluk2-fat-il-ilce     to rap-ilce
     move ozluk2-fat-ulke        to rap-ulke
     move ozluk2-fat-vergi-daire to rap-vd
     move ozluk2-fat-vergi-no    to rap-vno
      
     
            
     move "Oda/Extra Harcama Bedeli "
                       to rap-ack
     initialize rap-il
     end-if
     close ozluk2
    
     move konuk-ulke   to ulke-anah1
     perform oku-ulke
     if rap-adi = spaces and rap-soyadi = spaces then 
     move konuk-adi    to rap-adi
     move konuk-soyadi to rap-soyadi
     move ozluk-adres1 to rap-adr1
     move ozluk-adres2 to rap-adr2
     move ozluk-ilce   to rap-ilce
     move ozluk-il     to rap-il
     move ozluk-ulke   to rap-ulke
      end-if  
       open input polisxml
       
       move konuk-rez-no  to  polisxml-rezno
       if polisxml-rezno = 0 then 
           move konuk-extra-rez-no   to   polisxml-rezno
       end-if
       move 1 to polisxml-sirano
       read polisxml no lock invalid continue
            not invalid
            if rap-adr1 = spaces then
               move polisxml-adr(01:20) to  rap-adr1
               move polisxml-adr(21:20) to  rap-adr2
            end-if
            if rap-vno  = spaces then 
               if polisxml-tckimlikno not = 0 then
                  move polisxml-tckimlikno to  rap-vno 
                  move "TCkimlik No:"     to  rap-vd 
                  else 

                    move polisxml-kseri to  rap-vno 
                  move "Pasaport No:"     to  rap-vd 
                end-if
            end-if 

       end-read

        close polisxml
    
     move "Oda/Extra Harcama Bedeli   "
                       to rap-ack
     
     close konuk
           ozluk
           ulke  folref musteri
     perform goster-fatura-bilgileri
     .
*
 ata-cari-fatura.
     open input cari
     perform oku-cari
     close cari
     move c-unvan-1     to rap-adi
     move c-unvan-2     to rap-soyadi
     move c-adres-1     to rap-adr1
     move c-adres-2     to rap-adr2
     move c-il-ilce     to rap-ilce
                           rap-il
     move c-ulke        to rap-ulke
     move c-vergi-daire to rap-vd
     move c-vergi-no    to rap-vno
     move "Oda/Extra Harcama Bedeli   "
                        to rap-ack
     perform goster-fatura-bilgileri
     .
*
 ata-fihrist-fatura.
     open input fihrist
     perform oku-fihrist
     close fihrist
     if fihrist-unvani = spaces
        move fihrist-adi     to rap-adi
     else
        move fihrist-unvani  to rap-adi
     end-if
     move fihrist-soyadi  to rap-soyadi
     move fihrist-adres-1 to rap-adr1
     move fihrist-adres-2 to rap-adr2
     move fihrist-ilce    to rap-ilce
     move fihrist-il      to rap-il
     move fihrist-ulke    to rap-ulke
     move fihrist-adres-3 to rap-vd
     move fihrist-not     to rap-vno
     move "Oda/Extra Harcama Bedeli   "
                          to rap-ack
     perform goster-fatura-bilgileri
     .
*
 ata-ozluk2-fatura.
     open input ozluk2
              
     initialize ozluk2-rec
                
     perform oku-gd-sec
     move gd-sec-folio to ozluk2-folio
                          
     perform oku-ozluk2

     move ozluk2-fat-unvan-1     to rap-adi
     move ozluk2-fat-unvan-2     to rap-soyadi
     move ozluk2-fat-adres-1     to rap-adr1
     move ozluk2-fat-adres-2     to rap-adr2
     move ozluk2-fat-il-ilce     to rap-ilce
     move ozluk2-fat-ulke        to rap-ulke
     move ozluk2-fat-vergi-daire to rap-vd
     move ozluk2-fat-vergi-no    to rap-vno

     move "Oda/Extra Harcama Bedeli   "
                       to rap-ack
     initialize rap-il
     close ozluk2
           
     perform goster-fatura-bilgileri
     .
*
*
 ata-baska-acenta-fatura.
   
     open input 
                acenta
    
     
     initialize acenta-cagir
             call "/asya/ytl/obj/otel/acenara.asy" 
                  using acenta-cagir  
                  on exception 
                     perform callerr-proc
                  not on exception
                     if acenta-cagir = spaces
                        exit paragraph
                     end-if
             end-call

     move acenta-cagir to acenta-kodu 
     perform oku-acenta

     move acenta-adi      to rap-adi
     move acenta-unvani   to rap-soyadi
     move acenta-adresim  to rap-adr1
     move acenta-il       to rap-il
     move acenta-ilce     to rap-ilce
     move acenta-ulke     to rap-ulke
     move acenta-v-daire  to rap-vd
     move acenta-v-no     to rap-vno

     move "Oda/Extra Harcama Bedeli   "
                       to rap-ack
*     initialize rap-adr2
     move high-value to rap-adr2
     close 
           acenta
     perform goster-fatura-bilgileri
     .
*
 ata-acenta-fatura.
     open input konuk
                acenta
     initialize konuk-rec
                acenta-rec
     perform oku-gd-sec
     move gd-sec-folio to konuk-folio
     perform oku-konuk
                
     perform oku-gd-sec
     move gd-sec-folio to ozluk2-folio
                    
     move konuk-acenta  to acenta-kodu 
     perform oku-acenta

     move acenta-adi      to rap-adi
     move acenta-unvani   to rap-soyadi
     move acenta-adresim  to rap-adr1
     move acenta-il       to rap-il
     move acenta-ilce     to rap-ilce
     move acenta-ulke     to rap-ulke
     move acenta-v-daire  to rap-vd
     move acenta-v-no     to rap-vno

     move "Oda/Extra Harcama Bedeli   "
                       to rap-ack
*     initialize rap-adr2
     move high-value to rap-adr2
     close konuk
           acenta
     perform goster-fatura-bilgileri
     .
*
 ata-form-dosya-no.
     open i-o genelfis
     move 1 to genelfis-anahtar
     read genelfis no lock
       invalid
         accept print-no from time
       not invalid
         add 1 to print-no
         rewrite genelfis-rec end-rewrite
     end-read
     close genelfis
     .
*
 ara-oda-no.
     initialize oda-cagir
     if rap-inhouse
        move "D" to oda-db-cagir
     end-if
     call "/asya/ytl/obj/otel/odaara.asy"
       using oda-cagir
       on exception 
         initialize odano-cagir
       not on exception 
         cancel "/asya/ytl/obj/otel/odaara.asy"
     end-call
     move odano-cagir to rap-oda-no
     display acc-oda-no
     perform goster-gd-sec
     .
*
 ara-acenta.
     call "/asya/ytl/obj/otel/acenara.asy"
       using rap-acenta
       on exception 
         initialize rap-acenta
       not on exception 
         cancel "/asya/ytl/obj/otel/acenara.asy"
     end-call
     perform Aft-Proc-Acenta
     .
*
 ara-cari.
     initialize cari-rec
     call "/asya/ytl/obj/otel/cariara.asy"
       using cari-kodu
       on exception 
         initialize cari-rec
       not on exception 
         cancel "/asya/ytl/obj/otel/cariara.asy"
     end-call
     .
*
 ara-fihrist.
     initialize fihara-cagir
     call "/asya/ytl/obj/otel/fihara.asy"
       using fihara-cagir
       on exception 
         initialize fihara-cagir
       not on exception 
         cancel "/asya/ytl/obj/otel/fihara.asy"
     end-call
     .
*
 hesap-folio.
    
     initialize top-vars oran-kdv
     evaluate gd-sec-tipi 
       when "R"   perform start-romhrk
       when other perform start-exthrk
     end-evaluate
     .
*
 hesap-romhrk-folio.
     move romhrk-rec    to hrkgir-rec
     initialize depkod-rec
     move romhrk-depkod to depkod-kodu
     perform oku-depkod
     perform fatura-dep-kontrol
     if fatura-dep-donus <> "E"
        exit paragraph.
                                                 
*/   Kontrol ediliyor satir hesaplamaya dahil mi diye
*/    
        
     if not islem-hesap
        initialize ara-rec
        move romhrk-folio         to ara-folio
        move romhrk-islem         to ara-islem
        if romhrk-fatura-no-alfabe = spaces or 
           romhrk-fatura-no = zeroes
           if romhrk-ref = gd-sec-pen 
                     
                            set ara-islem-secildi     to true
              move romhrk-ref  to ara-pen



           end-if               
  
        else
           set ara-once-kesildi      to true
        end-if
                move "R"                  to ara-romhrk-exthrk   
                move rap-fat-tar to ara-fat-tar
                 move rap-ack to ara-rap-ack
                write ara-rec invalid
                      rewrite ara-rec end-rewrite
                end-write

     else
        initialize ara-rec
        move romhrk-folio            to ara-folio
        move romhrk-islem            to ara-islem
        read ara no lock invalid
             display message box 
                     "Beklenmeyen durum ..."
                     icon mb_error_icon
                     title "Hata-8855444"
        end-read
     end-if.
     if not ara-islem-secildi
        exit paragraph
     end-if
  
     initialize hrk-vars
     
     evaluate true
       when rap-kur-tl
            move romhrk-tl-tutar to hrk-gen
            move romhrk-dv-tutar to hrk-gen-dv
       when rap-kur-dv
            move romhrk-dv-tutar to hrk-gen
            move romhrk-tl-tutar to hrk-gen-dv
     end-evaluate
     if fatura-tahsilden-hesapla = 1
         evaluate romhrk-ba
              when "A" 
                 perform hesap-borc
              when "B"
                 perform hesap-alacak
          end-evaluate 
       else
          evaluate romhrk-ba
              when "B" 
                 perform hesap-borc
              when "A"
                 perform hesap-alacak
          end-evaluate 
     end-if

     move  hrk-top      to  ara-matrah   
     move  hrk-kdv      to  ara-kdv      
     move  hrk-gen      to  ara-toplam 
     compute ara-matrah =  ara-toplam - ara-kdv
     move  depkod-kdv   to  ara-kdv-oran 
      move rap-fat-tar to ara-fat-tar
       move rap-ack to ara-rap-ack
     write ara-rec invalid
              rewrite ara-rec end-rewrite
        end-write





     .
*
 hesap-exthrk-folio.

     move exthrk-rec    to hrkgir-rec
     initialize depkod-rec
     move exthrk-depkod to depkod-kodu
     perform oku-depkod
     perform fatura-dep-kontrol
     if fatura-dep-donus <> "E"
        exit paragraph.

*/   Kontrol ediliyor satir hesaplamaya dahil mi diye
*/
     if not islem-hesap
        initialize ara-rec
        move exthrk-folio         to ara-folio
        move exthrk-islem         to ara-islem

        if exthrk-fatura-no-alfabe = spaces or 
           exthrk-fatura-no = zeroes
           
             if exthrk-ref = gd-sec-pen 
                          
                      move exthrk-ref  to ara-pen
                      set ara-islem-secildi     to true
 

             end-if
        
        else
           set ara-once-kesildi      to true 
        end-if
                  move "E"                   to ara-romhrk-exthrk        
                  move rap-fat-tar to ara-fat-tar  
                  move rap-ack to ara-rap-ack
                write ara-rec invalid
                      rewrite ara-rec end-rewrite
                end-write

        
     else
        initialize ara-rec
        move exthrk-folio            to ara-folio
        move exthrk-islem            to ara-islem
        read ara no lock invalid
             display message box 
                     "Beklenmeyen durum ..."
                     icon mb_error_icon
                     title "Hata"
        end-read
     end-if.
     if not ara-islem-secildi
        exit paragraph
     end-if.
    
     initialize hrk-vars
     
     evaluate true
       when rap-kur-tl
            move exthrk-tl-tutar to hrk-gen
            move exthrk-dv-tutar to hrk-gen-dv
       when rap-kur-dv
            move exthrk-dv-tutar to hrk-gen
            move exthrk-tl-tutar to hrk-gen-dv
     end-evaluate
     if fatura-tahsilden-hesapla = 1
         evaluate exthrk-ba
              when "A" 
                 perform hesap-borc
              when "B"
                 perform hesap-alacak
          end-evaluate 
       else
          evaluate exthrk-ba
              when "B" 
                 perform hesap-borc
              when "A"
                 perform hesap-alacak
          end-evaluate 
     end-if
     move  hrk-top      to  ara-matrah   
     move  hrk-kdv      to  ara-kdv      
     move  hrk-gen      to  ara-toplam 
     compute ara-matrah =  ara-toplam - ara-kdv
     move  depkod-kdv   to  ara-kdv-oran 
     move rap-fat-tar   to ara-fat-tar
      move rap-ack to ara-rap-ack
     write ara-rec invalid
              rewrite ara-rec end-rewrite
        end-write




     .
*
 hesap-borc.
     perform hesap-kdv
     add hrk-top    to top-top
     add hrk-top-8  to top-top-8
     add hrk-kdv    to top-kdv
     add hrk-kdv-8  to top-kdv-8

     add hrk-gen    to top-gen
     add hrk-gen-8  to top-gen-8
     add hrk-gen-8  to top-net-8
     subtract top-kdv-8  from top-net-8
     add hrk-gen-dv to top-gen-dv
     .
*
 hesap-alacak.
     perform hesap-kdv
     subtract hrk-top    from top-top
     subtract hrk-top-8    from top-top-8
     subtract hrk-kdv    from top-kdv
     subtract hrk-kdv-8    from top-kdv-8
     subtract hrk-gen    from top-gen
      subtract hrk-gen-8    from top-gen-8
       add hrk-kdv-8  to top-net-8
     subtract top-gen-8  from top-net-8
     subtract hrk-gen-dv from top-gen-dv
     .
*
 hesap-kdv.
     compute hrk-top rounded
           = hrk-gen / (( depkod-kdv + 100) / 100 )
      
     compute hrk-kdv rounded
           = hrk-gen - hrk-top
    
     compute hrk-tmp rounded
           = hrk-top + hrk-kdv

     if hrk-tmp > hrk-gen
        compute hrk-top rounded
              = hrk-top - ( hrk-gen - hrk-tmp )
     end-if                  

     if hrk-tmp < hrk-gen
        compute hrk-kdv rounded
              = hrk-kdv + ( hrk-gen - hrk-tmp )
     end-if
      evaluate depkod-kdv 
         when 8
           move hrk-kdv to hrk-kdv-8
           move hrk-top to hrk-top-8
           move hrk-gen to hrk-gen-8

     end-evaluate
     .
*
 hesap-ekle-gtop.
     perform hesap-ind-top
        
     add top-top    to gtop-top
     add top-top-8  to gtop-top-8
     add top-ind    to gtop-ind
     add top-net    to gtop-net
     add top-net-8    to gtop-net-8
     add top-kdv    to gtop-kdv
     add top-kdv-8    to gtop-kdv-8
     
     add top-gen    to gtop-gen
     add top-gen-8    to gtop-gen-8
     add top-gen-dv to gtop-gen-dv
     perform goster-gtop
     .
*
 hesap-cikar-gtop.
     perform hesap-ind-top
     subtract top-top    from gtop-top
     subtract top-top-8    from gtop-top-8
     subtract top-ind    from gtop-ind
     subtract top-net    from gtop-net
     subtract top-net-8    from gtop-net-8
     subtract top-kdv    from gtop-kdv
     subtract top-kdv-8    from gtop-kdv-8
     subtract top-gen    from gtop-gen
     subtract top-gen-8    from gtop-gen-8

     subtract top-gen-dv from gtop-gen-dv
     perform goster-gtop
     .
*
 hesap-ind-top.
     continue 
     .
     
     compute top-net rounded
           = top-gen - top-kdv
     compute top-net-8 rounded
           = top-gen-8 - top-kdv-8
     compute top-ind rounded
           = top-top - top-net
     compute top-gen-dv rounded
           = top-gen-dv - ( top-gen-dv * ( oran-ind / 100 ))
     .
*
 hesap-ind-yeniden.
       continue
      .


     initialize gtop-top,
                gtop-ind,
                gtop-net,
                gtop-kdv,
                 gtop-kdv-8,
                  gtop-top-8,
                gtop-net-8,
                  gtop-gen-8,
                gtop-gen,
                gtop-gen-dv
     inquire gd-yaz
       last-row in gd-yaz-n-y
     perform varying gd-yaz-y
                from 2
                  by 1
               until gd-yaz-y > gd-yaz-n-y
       perform oku-gd-yaz
       perform Hesap-Ekle-Gtop

     end-perform
     .
*
 ekle-cikar-sec.
     perform oku-gd-sec
     perform bul-konuk-yaz
     if gd-kayit-var
        perform ara-cikar-ust
        perform cik-grid-yaz
     else
        perform yaz-grid-yaz
     end-if
     .
*
 ekle-cikar-yaz.
     perform oku-gd-yaz
     perform bul-konuk-sec
     if gd-kayit-var
        modify gd-sec(gd-sec-y,1)
          row-color       = 0
          bitmap-number   = 1
     end-if
     perform oku-gd-yaz
     if not islem-hesap
        perform ara-cikar-alt
     end-if
     modify gd-yaz(gd-yaz-y)
       record-to-delete = gd-yaz-y
     perform hesap-cikar-gtop
     perform Hesap-Ind-Yeniden
     perform goster-gtop
     .
*
 bul-konuk-yaz.
     set gd-kayit-yok to true
     move 1 to gd-img-no
     move 0 to gd-renk-x
     inquire gd-yaz,
       last-row in gd-yaz-n-y
     perform varying gd-yaz-y
                from 2
                  by 1
               until gd-yaz-y > gd-yaz-n-y or
                     gd-kayit-buyuk or
                     gd-kayit-var
       perform kontrol-kayit-yaz
     end-perform
     if gd-kayit-var or
        gd-kayit-buyuk
        subtract 1 from gd-yaz-y
     end-if
     if gd-kayit-var
        perform isaretle-gd-yaz
     end-if
     .
*
 bul-konuk-sec.
     set gd-kayit-yok to true
     inquire gd-sec,
       last-row in gd-sec-n-y
     perform varying gd-sec-y
                from 2
                  by 1
               until gd-sec-y > gd-sec-n-y or
                     gd-kayit-var
       perform kontrol-kayit-sec
     end-perform
     if gd-kayit-var
        subtract 1 from gd-sec-y
        perform isaretle-gd-sec
     end-if
     .
*
 kontrol-kayit-sec.
     perform oku-gd-sec
     if gd-sec-folio = gd-yaz-folio and
        gd-sec-pen   = Gd-yaz-pen
        set gd-kayit-var to true
     end-if
     .
*
 kontrol-kayit-yaz.
     perform oku-gd-yaz
     if gd-yaz-folio = gd-sec-folio   and
        gd-yaz-pen = Gd-sec-pen
        set gd-kayit-var to true
        move 7   to gd-img-no
        move 112 to gd-renk-x
     end-if
     if gd-yaz-folio > gd-sec-folio 
        
        set gd-kayit-buyuk to true
     end-if
     .
*
 islem-fatura.
    
     perform ata-form-dosya-no
     move print-no to formyaz-dosya-no
     open output formyaz
*     perform ters
     perform islem-modul-bilgi
     perform islem-ozellik
     perform islem-baslik
     perform islem-detay
     perform islem-gen-top
     close formyaz
     perform fatura-bilgileri-yaz.
     perform cagir-formyaz
     delete file formyaz
     if link-var > 0 then 
         set exit-pushed to true
     end-if
     .
*
 islem-modul-bilgi.
**** Cagiran Modul ismi
     initialize formyaz-rec
     set formyaz-modul     to true
     move "PRG"            to formyaz-kodu
     move "folfat"         to formyaz-deger
     perform yaz-formyaz
     .
*
 islem-ozellik.
**** Fatura Detay Tipi
     initialize formyaz-rec
     set formyaz-ozellik   to true
     move "FDT"            to formyaz-kodu
     move rap-fat-tipi     to formyaz-deger
     perform yaz-formyaz
**** Fatura Nakli Yekun Var mi
     initialize formyaz-rec
     set formyaz-ozellik   to true
     move "FNY"            to formyaz-kodu
     move rap-nakil-status to formyaz-deger
     perform yaz-formyaz
     .
*
 islem-baslik.
**** Fatura Tarihi
     initialize formyaz-rec
     set formyaz-baslik    to true
     move "FTT"            to formyaz-kodu
     move rap-fat-tar      to formyaz-deger
     perform yaz-formyaz
**** Musteri Adi
     initialize formyaz-rec
     set formyaz-baslik    to true
     move "MAD"            to formyaz-kodu
     move rap-adi          to formyaz-deger
     perform yaz-formyaz
**** Musteri Soyadi
     initialize formyaz-rec
     set formyaz-baslik    to true
     move "MAS"            to formyaz-kodu
     move rap-soyadi       to formyaz-deger
     perform yaz-formyaz
**** Musteri Adres-1
     initialize formyaz-rec
     set formyaz-baslik    to true
     move "AD1"            to formyaz-kodu
     move rap-adr1         to formyaz-deger
     perform yaz-formyaz
**** Musteri Adres-2
     initialize formyaz-rec
     set formyaz-baslik    to true
     move "AD2"            to formyaz-kodu
     move rap-adr2         to formyaz-deger
     perform yaz-formyaz
**** Musteri ilce
     initialize formyaz-rec
     set formyaz-baslik    to true
     move "ILC"            to formyaz-kodu
     move rap-ilce         to formyaz-deger
     perform yaz-formyaz
**** Musteri il
     initialize formyaz-rec
     set formyaz-baslik    to true
     move "IL"             to formyaz-kodu
     move rap-il           to formyaz-deger
     perform yaz-formyaz
**** Musteri Ulke
     initialize formyaz-rec
     set formyaz-baslik    to true
     move "ULK"            to formyaz-kodu
     move rap-ulke         to formyaz-deger
     perform yaz-formyaz
**** Musteri Vergi Dairesi
     initialize formyaz-rec
     set formyaz-baslik    to true
     move "VD"             to formyaz-kodu
     move rap-vd           to formyaz-deger
     perform yaz-formyaz
**** Musteri Vergi No
     initialize formyaz-rec
     set formyaz-baslik    to true
     move "VN"             to formyaz-kodu
     move rap-vno          to formyaz-deger
     perform yaz-formyaz
**** Aciklama
     initialize formyaz-rec
     set formyaz-baslik    to true
     move "ACK"            to formyaz-kodu
     move rap-ack          to formyaz-deger
     perform yaz-formyaz
     .
*
 islem-detay.
**** Fatura Detayi
     initialize formyaz-rec
     set formyaz-detay     to true
     perform varying gd-yaz-y
                from 2
                  by 1
               until gd-yaz-y > gd-yaz-n-y
       
       initialize top-vars
       perform oku-gd-yaz
       perform hesap-ind-top
       subtract 1 
           from gd-yaz-y giving formyaz-sira
****   Oda No
       move "ODA"            to formyaz-kodu
       move gd-yaz-odano     to formyaz-deger
       perform yaz-formyaz
****   Aciklama mami
       move "FTA"            to formyaz-kodu
       
       move rap-ack to formyaz-deger
       perform yaz-formyaz



****   Folio Tipi
       move "FOT"            to formyaz-kodu
       move gd-yaz-tipi      to formyaz-deger
       perform yaz-formyaz
****   Folio No
       move "FOL"            to formyaz-kodu
       move gd-yaz-folio     to formyaz-deger
       perform yaz-formyaz
****   Toplam ( Matrah )
       move "MAT"            to formyaz-kodu
       move top-top          to z15v99
       move z15v99           to formyaz-deger
       perform yaz-formyaz
****   indirim
       move "IND"            to formyaz-kodu
       move top-ind          to z15v99
       move z15v99           to formyaz-deger
       perform yaz-formyaz
****   Net Deger
       move "NET"            to formyaz-kodu
       move top-net          to z15v99
       move z15v99           to formyaz-deger
       perform yaz-formyaz
****   Net Deger-8
       move "NE8"            to formyaz-kodu
        
       move top-net-8          to z15v99
       move z15v99           to formyaz-deger
       perform yaz-formyaz
****   KDV-8
       move "KD8"            to formyaz-kodu
       move top-kdv-8          to z15v99
       move z15v99           to formyaz-deger
       perform yaz-formyaz
****   KDV
       move "KDV"            to formyaz-kodu
       move top-kdv          to z15v99
       move z15v99           to formyaz-deger
       perform yaz-formyaz
****   Genel Toplam
       move "GEN"            to formyaz-kodu
       move top-gen          to z15v99
       move z15v99           to formyaz-deger
       perform yaz-formyaz

     end-perform
     .
     
*
 islem-gen-top.
      
**** Fatura Detayi
     initialize formyaz-rec
     set formyaz-gen-top   to true
**** Toplam ( Matrah )
     move "MAT"            to formyaz-kodu
     move gtop-top         to z15v99
     move z15v99           to formyaz-deger
     perform yaz-formyaz
**** indirim orani
     move "INO"            to formyaz-kodu
     move oran-ind         to z15v99
     move z15v99           to formyaz-deger
     perform yaz-formyaz
**** indirim
     move "IND"            to formyaz-kodu
     move gtop-ind         to z15v99
     move z15v99           to formyaz-deger
     perform yaz-formyaz

**** KDV orani
     move "KDO"            to formyaz-kodu
     move oran-kdv         to z15v99
     move z15v99           to formyaz-deger
     perform yaz-formyaz
**** KDV-8
     move "KD8"            to formyaz-kodu
     move gtop-kdv-8       to z15v99
     move z15v99           to formyaz-deger
     perform yaz-formyaz
**** KDV
     move "KDV"            to formyaz-kodu
     compute gtop-kdv-18 = gtop-kdv - gtop-kdv-8
     move gtop-kdv-18         to z15v99
     move z15v99              to formyaz-deger
     perform yaz-formyaz
**** Net Deger  % 8
*     move "N08"            to formyaz-kodu
*     move gtop-net-08      to z15v99
*     move z15v99           to formyaz-deger
*     perform yaz-formyaz
**** Net Deger  %18
*     move "N18"            to formyaz-kodu
*     move gtop-net-18      to z15v99
*     move z15v99           to formyaz-deger
*     perform yaz-formyaz
**** Net Deger -8
     move "NET"            to formyaz-kodu
     move gtop-net         to z15v99
     move z15v99           to formyaz-deger
     perform yaz-formyaz
**** Net Deger -8
     move "NE8"            to formyaz-kodu
     move gtop-net-8         to z15v99
     move z15v99           to formyaz-deger
     perform yaz-formyaz
**** Net Deger-18
     move "N18"            to formyaz-kodu
     compute gtop-net-18 = gtop-net - gtop-net-8
     move gtop-net-18         to z15v99
     move z15v99           to formyaz-deger
     perform yaz-formyaz
**** Genel Toplam
     move "GEN"            to formyaz-kodu
     move gtop-gen         to z15v99
     move z15v99           to formyaz-deger
     perform yaz-formyaz
     initialize depler
     open output deptop  close deptop open i-o deptop .
     perform deptop-bul.

      close deptop.
     
     if  aladeptutar(01) > 0 then  
     move "M01"            to formyaz-kodu
     move aladeptutar(1)       to z6v99
     move z6v99           to formyaz-deger (15:)
     move aladepadi(1)(1:15)       to formyaz-deger (1:15)
       perform yaz-formyaz

     end-if
     
     if  aladeptutar(02) > 0 then  
     move "M02"            to formyaz-kodu
     move aladeptutar(2)       to z6v99
     move z6v99           to formyaz-deger (15:)
     move aladepadi(2)(1:15)       to formyaz-deger (1:15)
       perform yaz-formyaz
     end-if

     if  aladeptutar(03) > 0 then  
     move "M03"            to formyaz-kodu
     move aladeptutar(3)       to z6v99
     move z6v99           to formyaz-deger (15:)
     move aladepadi(3)(1:15)       to formyaz-deger (1:15)
       perform yaz-formyaz

     end-if
     
     if  aladeptutar(04) > 0 then  
     move "M04"            to formyaz-kodu
     move aladeptutar(4)       to z6v99
     move z6v99           to formyaz-deger (15:)
     move aladepadi(4)(1:15)       to formyaz-deger (1:15)
       perform yaz-formyaz

     end-if
     
     if  aladeptutar(05) > 0 then  
     move "M05"            to formyaz-kodu
     move aladeptutar(5)       to z6v99
     move z6v99           to formyaz-deger (15:)
     move aladepadi(5)(1:15)       to formyaz-deger (1:15)
       perform yaz-formyaz

     end-if
     
     if  aladeptutar(06) > 0 then  
     move "M06"            to formyaz-kodu
     move aladeptutar(6)       to z6v99
     move z6v99           to formyaz-deger (15:)
     move aladepadi(6)(1:15)       to formyaz-deger (1:15)
       perform yaz-formyaz

     end-if
     
     if  aladeptutar(07) > 0 then  
     move "M07"            to formyaz-kodu
     move aladeptutar(7)       to z6v99
     move z6v99           to formyaz-deger (15:)
     move aladepadi(7)(1:15)       to formyaz-deger (1:15)
       perform yaz-formyaz

     end-if
     
     if  aladeptutar(08) > 0 then  
     move "M08"                to formyaz-kodu
     move aladeptutar(8)       to z6v99
     move z6v99                to formyaz-deger (15:)
     move aladepadi(8)(1:15)       to formyaz-deger (1:15)
       perform yaz-formyaz

     end-if
     
     if  aladeptutar(09) > 0 then  
     move "M09"            to formyaz-kodu
     move aladeptutar(9)       to z6v99
     move z6v99           to formyaz-deger (15:)
     move aladepadi(9)(1:15)       to formyaz-deger (1:15)
       perform yaz-formyaz

     end-if
     
     if  aladeptutar(10) > 0 then  
     move "M10"            to formyaz-kodu
     move aladeptutar(10)       to z6v99
     move z6v99           to formyaz-deger (15:)
     move aladepadi(10)(1:15)       to formyaz-deger (1:15)
       perform yaz-formyaz
     end-if
     
     if  bordeptutar(01) > 0 then  
     move "L01"                to formyaz-kodu
     move bordeptutar(1)       to z6v99
     move z6v99                to formyaz-deger (25:)
     move bordepadi(1)(1:25)       to formyaz-deger (1:25)
         perform yaz-formyaz
     
     end-if
     
     if  bordeptutar(02) > 0 then  
     move "L02"            to formyaz-kodu
     move bordeptutar(2)       to z6v99
     move z6v99           to formyaz-deger (25:)
     move bordepadi(2)(1:25)       to formyaz-deger (1:25)
         perform yaz-formyaz
     
     end-if
     
     if  bordeptutar(03) > 0 then  
     move "L03"            to formyaz-kodu
     move bordeptutar(3)       to z6v99
     move z6v99           to formyaz-deger (25:)
     move bordepadi(3)(1:25)       to formyaz-deger (1:25)
         perform yaz-formyaz
     
     end-if
     
     if  bordeptutar(04) > 0 then  
     move "L04"            to formyaz-kodu
     move bordeptutar(4)       to z6v99
     move z6v99           to formyaz-deger (25:)
     move bordepadi(4)(1:25)       to formyaz-deger (1:25)
         perform yaz-formyaz
     
     end-if
     
     if  bordeptutar(05) > 0 then  
     move "L05"            to formyaz-kodu
     move bordeptutar(5)       to z6v99
     move z6v99           to formyaz-deger (25:)
     move bordepadi(5)(1:25)       to formyaz-deger (1:25)
         perform yaz-formyaz
     
     end-if
     
     if  bordeptutar(06) > 0 then  
     move "L06"            to formyaz-kodu
     move bordeptutar(6)       to z6v99
     move z6v99           to formyaz-deger (25:)
     move bordepadi(6)(1:25)       to formyaz-deger (1:25)
         perform yaz-formyaz
     
     end-if
     
     if  bordeptutar(07) > 0 then  
     move "L07"            to formyaz-kodu
     move bordeptutar(7)       to z6v99
     move z6v99           to formyaz-deger (25:)
     move bordepadi(7)(1:25)       to formyaz-deger (1:25)
         perform yaz-formyaz
     
     end-if
     
     if  bordeptutar(08) > 0 then  
     move "L08"            to formyaz-kodu
     move bordeptutar(8)       to z6v99
     move z6v99           to formyaz-deger (25:)
     move bordepadi(8)(1:25)       to formyaz-deger (1:25)
         perform yaz-formyaz
     
     end-if
     
     if  bordeptutar(09) > 0 then  
     move "L09"            to formyaz-kodu
     move bordeptutar(9)       to z6v99
     move z6v99           to formyaz-deger (25:)
     move bordepadi(9)(1:25)       to formyaz-deger (1:25)
         perform yaz-formyaz
     
     end-if
     
     if  bordeptutar(10) > 0 then  
     move "L10"            to formyaz-kodu
     move bordeptutar(10)       to z6v99
     move z6v99           to formyaz-deger (25:)
     move bordepadi(10)(1:25)       to formyaz-deger (1:25)
         perform yaz-formyaz
     
     end-if
     
     if  bordeptutar(11) > 0 then  
     move "L11"            to formyaz-kodu
     move bordeptutar(11)       to z6v99
     move z6v99           to formyaz-deger (25:)
     move bordepadi(11)(1:25)       to formyaz-deger (1:25)
         perform yaz-formyaz
     
     end-if
     
     if  bordeptutar(12) > 0 then  
     move "L12"            to formyaz-kodu
     move bordeptutar(12)       to z6v99
     move z6v99           to formyaz-deger (25:)
     move bordepadi(12)(1:25)       to formyaz-deger (1:25)
         perform yaz-formyaz
     
     end-if
     
     if  bordeptutar(13) > 0 then  
     move "L13"            to formyaz-kodu
     move bordeptutar(13)       to z6v99
     move z6v99           to formyaz-deger (25:)
     move bordepadi(13)(1:25)       to formyaz-deger (1:25)
         perform yaz-formyaz
     
     end-if
     
     if  bordeptutar(14) > 0 then  
     move "L14"            to formyaz-kodu
     move bordeptutar(14)       to z6v99
     move z6v99           to formyaz-deger (25:)
     move bordepadi(14)(1:25)       to formyaz-deger (1:25)
         perform yaz-formyaz
     
     end-if
     
     if  bordeptutar(15) > 0 then  
     move "L15"            to formyaz-kodu
     move bordeptutar(15)       to z6v99
     move z6v99           to formyaz-deger (25:)
     move bordepadi(15)(1:25)       to formyaz-deger (1:25)
         perform yaz-formyaz
     
     end-if
     
     if  bordeptutar(16) > 0 then  
     move "L16"            to formyaz-kodu
     move bordeptutar(16)       to z6v99
     move z6v99           to formyaz-deger (25:)
     move bordepadi(16)(1:25)       to formyaz-deger (1:25)
         perform yaz-formyaz
     
     end-if
     
     if  bordeptutar(17) > 0 then  
     move "L17"            to formyaz-kodu
     move bordeptutar(17)       to z6v99
     move z6v99           to formyaz-deger (25:)
     move bordepadi(17)(1:25)       to formyaz-deger (1:25)
         perform yaz-formyaz
     end-if
     
     if  bordeptutar(18) > 0 then  
     move "L18"            to formyaz-kodu
     move bordeptutar(18)       to z6v99
     move z6v99           to formyaz-deger (25:)
     move bordepadi(18)(1:25)       to formyaz-deger (1:25)
         perform yaz-formyaz
     end-if
     
     if  bordeptutar(19) > 0 then  
     move "L19"            to formyaz-kodu
     move bordeptutar(19)       to z6v99
     move z6v99           to formyaz-deger (25:)
     move bordepadi(19)(1:25)       to formyaz-deger (1:25)
         perform yaz-formyaz
     end-if
     if  bordeptutar(20) > 0 then 

     move "L20"            to formyaz-kodu
     move bordeptutar(20)       to z6v99
     move z6v99           to formyaz-deger (25:)
     move bordepadi(20)(1:25)       to formyaz-deger (1:25)
         perform yaz-formyaz
     end-if
   
    
     .

*
 deptop-bul.
      open i-o exthrk romhrk depkod   
      initialize ara-rec son-folio son-pen
      start ara key > ara-anah
        invalid
         continue
        not invalid 
         perform until fs-ara = "10"
          read ara next
            end move "10" to fs-ara
            not end
              if ara-islem-secildi and             
                 ara-pen   not = son-pen or
                 ara-folio <> son-folio

                  
                  move ara-folio  to son-folio
                  move ara-pen    to son-pen
                   perform fol-toplam-al               
              end-if
          end-read
         end-perform 
       end-start
        close  exthrk romhrk  
        initialize deptop-rec son-ala son-bor  depler
        start deptop key > deptop-anah
          invalid
           continue
          not invalid
          perform until fs-deptop = "10"
            read deptop next no lock
              end move "10" to fs-deptop
              not end 
               move deptop-depkod to depkod-anah
               read depkod no lock invalid
                 move all "*" to depkod-adi
               end-read
               inspect depkod-adi replacing all "  " by ".."
             
               if deptop-ba = "B"
                  if son-bor < 30 then 
                     add 1 to son-bor
                  end-if
                 move deptop-depkod to bordepkodu(son-bor)
                  move depkod-adi  to bordepadi(son-bor)
                  move "%"         to bordepadi(son-bor)(23:1)
                  move depkod-kdv  to  bordepadi(son-bor)(24:2)
                 move deptop-tutar  to bordeptutar(son-bor)

                 else
                  if son-ala < 30 then 
                    add 1 to son-ala
                  end-if
                 move depkod-adi    to aladepadi(son-ala)
                 move deptop-depkod to aladepkodu(son-ala)
                 move deptop-tutar  to aladeptutar(son-ala)

               end-if
            end-read  
          end-perform
        end-start
       close depkod
     .
*
 fol-toplam-al.
      open input folref
      initialize romhrk-rec exthrk-rec
      move ara-folio to romhrk-folio exthrk-folio
      start romhrk key > romhrk-anah1
         invalid continue
         not invalid 
           perform until fs-romhrk = "10"
             read romhrk next 
                 end move "10" to fs-romhrk
                 not end 
                   if romhrk-folio not = ara-folio  
                     
                        move "10" to fs-romhrk
                   else
                    
                     initialize deptop-rec
                     move romhrk-ba to deptop-ba
                     move romhrk-depkod to deptop-depkod depkod-anah
                     if ROMHRK-FATURA-NO > 0 then 
                      exit perform cycle
                     
                     else 
                        if romhrk-ref <> ara-pen
                            exit perform cycle 
                        end-if 
                                          
                     end-if
                     read deptop no lock invalid 
                          continue
                     end-read
                       read depkod no lock invalid continue
                          end-read
                      if DEPKOD-TURU = 2 then 
                        initialize deptop-rec
                        move ROMHRK-CORR-DEPKOD to depkod-anah  deptop-depkod
                          read depkod no lock invalid continue
                          end-read
                           move depkod-ba to deptop-ba
                          read deptop no lock invalid continue
                           end-read
                             subtract romhrk-tl-tutar from deptop-tutar
                             else
                         add romhrk-tl-tutar to deptop-tutar
                     end-if
                     rewrite deptop-rec invalid write deptop-rec end-rewrite
                   end-if
             end-read
           end-perform
      end-start
         move ara-folio to romhrk-folio exthrk-folio
      start exthrk key > exthrk-anah1
         invalid continue
         not invalid 
           perform until fs-exthrk = "10"
             read exthrk next 
                 end move "10" to fs-exthrk
                 not end 
                   if exthrk-folio not = ara-folio  
                      
                         move "10" to fs-exthrk
                     else

                     initialize deptop-rec
                     move exthrk-ba to deptop-ba
                     move exthrk-depkod to deptop-depkod  depkod-anah
                     if extHRK-FATURA-NO > 0 then 
                      exit perform cycle
                     
                     else 
                       if exthrk-ref <> ara-pen
                          exit perform cycle 
                       end-if 

                     
                     end-if
                     read deptop no lock invalid continue
                     end-read
                     read depkod no lock invalid continue
                     end-read
                     if DEPKOD-TURU = 2 then 
                        initialize deptop-rec
                        move extHRK-CORR-DEPKOD to depkod-anah  deptop-depkod 
                          read depkod no lock invalid continue
                          end-read
                            move depkod-ba to deptop-ba
                          read deptop no lock invalid continue
                           end-read
                             subtract exthrk-tl-tutar from deptop-tutar
                             else
                         add exthrk-tl-tutar to deptop-tutar
                     end-if
                     rewrite deptop-rec invalid write deptop-rec end-rewrite
                   end-if
             end-read
           end-perform
      end-start
      close folref 
    .
*
 goster-alanlar.
     display acc-oda-no,
             pb-oda-no,
             lb-ilk-tar,
             acc-ilk-gun,
             acc-ilk-ay,
             acc-ilk-yil,
             lb-son-tar
             acc-son-gun,
             acc-son-ay,
             acc-son-yil
     .
*
 goster-kayit.
     display pb-fatura,
             lb-sec,
*             gd-sec,
             lb-yaz,
*             gd-yaz
     .
*
 goster-gd-sec.
     if rap-filtre-vars not = sakla-filtre-vars
        perform init-grid-sec
        modify gd-sec,
          mass-update = 1
        perform oku-grid-sec
        modify gd-sec,
          mass-update = 0
        move rap-filtre-vars to sakla-filtre-vars
     end-if
     modify gd-sec,
       start-x      = 1
       x            = gd-sec-n-x
       start-y      = 2
       y            = 2
       cursor-y     = 2
       region-color = 493
     inquire gd-sec(2),
       record-data in gd-sec-rec
     perform Bul-Konuk-Yaz
     .
*
 goster-gtop.
     display acc-top,
             acc-ind-oran,
             acc-ind,
             acc-net,
             acc-kdv-oran,
             acc-kdv,
             acc-gen,
             acc-gen-dv
     .
*
 goster-fatura-bilgileri.
     display acc-adi,
             acc-soyadi,
             acc-adr1,
             acc-adr2,
             acc-ilce,
             acc-il,
             acc-ulke,
             acc-vd,
             acc-vno,
             acc-ack
     .
*
 isaretle-gd-sec.
     modify gd-sec,
       start-x      = 1
       x            = gd-sec-n-x
       start-y      = gd-sec-y
       y            = gd-sec-y
       cursor-x     = gd-sec-x
       cursor-y     = gd-sec-y
       region-color = 493
     .
*
 isaretle-gd-yaz.
     modify gd-yaz,
       start-x      = 1
       x            = gd-yaz-n-x
       start-y      = gd-yaz-y
       y            = gd-yaz-y
       cursor-x     = gd-yaz-x
       cursor-y     = gd-yaz-y
       region-color = 493
     .
*
 hata-kayit-yok.
     display message box
       "Sectiginiz kriterlerde kayit bulunamadi"
       icon  = mb-error-icon
       title = "Kayit Bulunamadi"
     .
*
 hata-fatura-bilgi-yok.
     display message box
       "Yazdirilacak Fatura icin folio seciniz..."
       icon  = mb-error-icon
       title = "Folio Secilmedi..."
     .
*
 cagir-formyaz.
     call "/asya/ytl/obj/otel/formyaz2.asy"
       using formyaz-dosya-no ara-no gtop-gen
       on exception 
         perform callerr-proc
       not on exception 

         cancel "/asya/ytl/obj/otel/formyaz2.asy"
     end-call
     .
*
 ara-dosya-yarat.
     perform ata-form-dosya-no.
     move print-no         to ara-no deptop-no.
     open output ara  close ara open i-o ara .
     
*
 Form1-Aft-Routine.
     close ara .
     delete file ara deptop.
     
     .
*
 Form2-Aft-Initdata.
     perform grid-reset.
     perform grid-doldur.
*/-----------------------------\*  
*/---------DIL AYARLA----------\*    
*/-----------------------------\*    
     perform dil-ayarla-proc.
*/-----------------------------\*         
*
 grid-reset.
     modify form2-gd-1,
            reset-grid = 1
            mass-update = 1
     initialize form2-gd-1-record
     move "*"                        to gd-1-col-0
     move "Tarih"                    to gd-1-col-1
     move "D.K"                      to gd-1-col-2
     move "Departman"                to gd-1-col-3
     move "Aciklama"                 to gd-1-col-4
     move "Tutar TL"                 to gd-1-col-5
     move "Tutar Dv"                 to gd-1-col-6
     move "Zaman"                    to gd-1-col-7
     move "Islem"                    to gd-1-col-8
     move "T"                        to gd-1-col-9
     move "Cek No"                   to gd-1-col-10
     move "Kart"                     to gd-1-col-11
     move "Kullanici"                to gd-1-col-12
     move "Aciklama"                 to gd-1-col-13
     move "Fat No  "                 to gd-1-col-15
     modify form2-gd-1,
            record-to-add(form2-gd-1-record)
     modify form2-gd-1,
            mass-update = 0.
   
     .
*
 gd-yaz-Ex-Other.
     if key-status <> 11 
        exit paragraph.
     inquire gd-yaz,
             cursor-y in satir
             cursor-x in sutun
     move gd-sec-y         to yukari-satir
     if satir < 2
        exit paragraph.

     inquire gd-yaz(satir),
             record-data in gd-yaz-rec
     move Gd-yaz-folio(1:8)   to konuk-folio
     open input konuk.
     read konuk no lock invalid
          display message box
                  Gd-yaz-folio, " nolu folio bulunamadi !"
                  icon mb_error_icon
                  title "Hata"
                  close konuk
                  exit paragraph
     end-read


     close konuk.
     perform acu-form2-routine.
     
     .
*
 grid-doldur.
     move 1 to grid-kayit-sayi
     modify form2-gd-1,
            mass-update = 1
     if konuk-fol-kodu = "R"
        perform grid-doldur-romhrk
     else
        perform grid-doldur-exthrk
     end-if.
     modify form2-gd-1,
            mass-update = 0.
*
 grid-doldur-romhrk.
     
     open input romhrk depkod kllnc
     initialize romhrk-rec
     move konuk-folio          to romhrk-folio
     start romhrk key not < romhrk-anah invalid
           continue
     not invalid
     initialize fs-romhrk
     perform with test after until fs-romhrk = "10"
     read romhrk next no lock end move "10" to fs-romhrk
     not at end
          if romhrk-folio <> konuk-folio
             exit perform
          end-if

          move romhrk-rec    to hrkgir-rec
          initialize depkod-rec
          move romhrk-depkod to depkod-kodu
          perform oku-depkod
          perform fatura-dep-kontrol
          if fatura-dep-donus <> "E"
            exit perform cycle
          end-if


          move romhrk-rec         to hrkgir-rec
          perform grid-kayit-ekle

     end-read
     end-perform
     end-start
     close romhrk depkod kllnc.
*
 grid-doldur-exthrk.
     open input exthrk depkod kllnc
     initialize exthrk-rec
     move konuk-folio          to exthrk-folio
     start exthrk key not < exthrk-anah invalid
           continue
     not invalid
     initialize fs-exthrk
     perform with test after until fs-exthrk = "10"
     read exthrk next no lock end move "10" to fs-exthrk
     not at end
          if exthrk-folio <> konuk-folio
             exit perform
          end-if

          move exthrk-rec    to hrkgir-rec
          initialize depkod-rec
          move exthrk-depkod to depkod-kodu
          perform oku-depkod
          perform fatura-dep-kontrol
          if fatura-dep-donus <> "E"
            exit perform cycle
          end-if

          move exthrk-rec         to hrkgir-rec
          perform grid-kayit-ekle

     end-read
     end-perform                       
     end-start
     close exthrk depkod kllnc.
*
 grid-kayit-ekle.
     add 1 to grid-kayit-sayi.
     initialize form2-gd-1-record
     move hrkgir-gun               to egun.
     move hrkgir-ay                to eay.
     move hrkgir-yil               to eyil.
     move etarih                   to gd-1-col-1.
     move hrkgir-depkod            to gd-1-col-2 depkod-anah
     read depkod no lock invalid
          move "Tanimsiz ...."     to depkod-adi
     end-read
     move depkod-adi               to gd-1-col-3
*     move hrkgir-aciklama          to gd-1-col-4
     move hrkgir-tl-tutar          to etutar
     evaluate hrkgir-ba
     when "B" move etutar          to gd-1-col-5
     when "A" move etutar          to gd-1-col-6
     end-evaluate
     move hrkgir-saat              to esaat
     move hrkgir-dakika            to edakika
     move hrkgir-saniye            to esaniye
     move ezaman                   to gd-1-col-7
     move hrkgir-islem             to gd-1-col-8
     move hrkgir-islem-tipi        to gd-1-col-9
     move hrkgir-cekno             to gd-1-col-10
     move hrkgir-kart-no           to gd-1-col-11
     move hrkgir-staf              to k-kodu
     move hrkgir-fatura-no to z-fat
     move z-fat to  gd-1-col-15
     read kllnc no lock invalid
          move "Tanimsiz"          to k-adi k-soyadi
     end-read
     move all low-values to gd-1-col-12
     inspect k-adi replacing trailing spaces by low-values
     inspect k-soyadi replacing trailing spaces by low-values
     string gd-1-col-12
            k-adi         delimited by low-values
            " "           delimited by low-values
            k-soyadi      delimited by low-values
            into gd-1-col-12
     inspect gd-1-col-12 replacing all low-values by spaces
     modify form2-gd-1,
            record-to-add(form2-gd-1-record).
     
     initialize ara-rec grid-res-no
     move hrkgir-folio            to ara-folio
     move hrkgir-islem            to ara-islem
     read ara no lock invalid
          move 0 to grid-res-no
     end-read
     if ara-islem-secildi
        move 1 to grid-res-no
     else
        move 0 to grid-res-no
     end-if
     perform grid-parlat.

*
 grid-parlat.
     evaluate grid-res-no
     when 1
          modify form2-gd-1(grid-kayit-sayi,1),
                 hidden-data = "E"
                 bitmap = yes-bmp
                 bitmap-width = 16
                 bitmap-number = 1
     when 0
          modify form2-gd-1(grid-kayit-sayi,1),
                 hidden-data = "H"
                 bitmap = null
     end-evaluate.
            
*
 Form2-Gd-1-Ev-Other.
     if link-var > 0  and link-pencere > 0 then 
       exit paragraph
      end-if
        
     evaluate event-type
     when msg-begin-entry
     when msg-bitmap-clicked
     when msg-bitmap-dblclick
          move event-action-fail    to event-action
          inquire form2-gd-1(event-data-2,1)
                  hidden-data in eh
          inquire form2-gd-1(event-data-2)
                  record-data in form2-gd-1-record
          initialize ara-rec
          move gd-1-col-8(1:8) to ara-islem
          move konuk-folio     to ara-folio
          read ara no lock invalid
               display message box 
                       "Kayit bulunamadi !"
                       icon  mb_error_icon
                       title "Hata"
                  exit paragraph
          end-read
          if eh = "E"
             initialize ara-islem-durumu
          else
             if ara-once-kesildi
                display message box 
                        "Bu harekete daha once fatura kesilmis !",new-line
                        "Tekrar kesmek istiyor musunuz ?"
                        icon mb_error_icon
                        title "Bilginize"
                        type mb_yes_no
                        default 2
                        returning return-code
                if return-code <> 1
                   exit paragraph
                end-if
             end-if
             set ara-islem-secildi    to true
          end-if
           move rap-fat-tar to ara-fat-tar
           move rap-ack to ara-rap-ack
          rewrite ara-rec invalid
                  write ara-rec end-write
          end-rewrite

          if eh = "E"
             move 0           to grid-res-no
          else
             move 1           to grid-res-no
          end-if
          move event-data-2   to grid-kayit-sayi
          perform grid-parlat

          set islem-hesap      to true
          move satir           to event-data-2
          move sutun           to event-data-1
          perform Msg-bmp-Click-yaz
          move yukari-satir      to event-data-2
          perform ekle-cikar-sec
          initialize islem-turu
     end-evaluate
     
     .
*
 ara-cikar-alt.
     initialize ara-rec
     inquire gd-yaz(gd-yaz-y,4),
             cell-data in ara-folio
     inquire gd-yaz(gd-yaz-y,10),
             cell-data in ara-pen
    
     move gd-yaz-folio      to ara-folio
     start ara key not < ara-anah invalid
           continue
     not invalid
     initialize fs-ara
     perform with test after until fs-ara = "10"
     read ara next no lock end move "10" to fs-ara
     not at end
          if ara-folio <> gd-yaz-folio 
             
             exit perform
          end-if
          if ara-pen   <> Gd-yaz-pen
             exit perform cycle 
          end-if 
          delete ara end-delete
     end-read
     end-perform
     end-start.
*
 ara-cikar-ust.
     initialize ara-rec
     inquire gd-sec(gd-sec-y,4)
             cell-data in ara-folio
     inquire gd-sec(gd-sec-y,9)
             cell-data in ara-pen

     move gd-yaz-folio      to ara-folio
     start ara key not < ara-anah invalid
           continue
     not invalid
     initialize fs-ara
     perform with test after until fs-ara = "10"
     read ara next no lock end move "10" to fs-ara
     not at end
          if ara-folio <> gd-yaz-folio  
             
             exit perform
          end-if
          if ara-pen <> Gd-yaz-pen 
             exit perform cycle 
          end-if 
          delete ara end-delete
     end-read
     end-perform
     end-start.
*
 fatura-bilgileri-yaz.
     initialize ara-rec
     move rap-fat-bilgiler to ara-fatura-bilgiler
     move rap-fat-tar      to ara-fat-tar
      move rap-ack to ara-rap-ack
     move gtop-top         to ara-fatura-toplam
     move gtop-ind         to ara-fatura-indirim
     move gtop-net         to ara-fatura-matrah
     move gtop-net-8         to ara-fatura-matrah-8
     move gtop-net-18         to ara-fatura-matrah-18

     move gtop-kdv         to ara-fatura-kdv
     move gtop-kdv-8        to ara-fatura-kdv-8
     move gtop-kdv-18       to ara-fatura-kdv-18

     
     move gtop-gen         to ara-fatura-g-toplam
     inquire gd-yaz,
             last-row in ii
     perform varying i
             from 2
             by 1
             until i > ii
             inquire gd-yaz(i),
                     record-data in gd-yaz-rec
             move gd-yaz-folio       to ara-folio-no(i - 1)

     end-perform
      move rap-fat-tar to ara-fat-tar
       move rap-ack to ara-rap-ack
     write ara-rec invalid
           rewrite ara-rec end-rewrite
     end-write.

************> DEPARTMAN KODLARINDAN FATURA TAKIP KONTROL<********
*
 fatura-dep-kontrol.
     initialize fatura-dep-donus.
     if depkod-fatura-takip <> "E"
        exit paragraph.
     if hrkgir-Islem-Tipi = "Y"
        exit paragraph.
     if depkod-turu = 2 | CORRECTION ISE tekrar oku
        initialize depkod-rec
        move  depkod-kdv  to buffer-kdv 
        move hrkgir-corr-depkod    to depkod-kodu
        perform oku-depkod
        if depkod-fatura-takip = "E"
           move "E" to fatura-dep-donus 
           move depkod-kdv to buffer-kdv
        end-if
        initialize depkod-rec
        move hrkgir-depkod         to depkod-kodu
        perform oku-depkod
        move buffer-kdv to depkod-kdv
     else
        move "E"    to fatura-dep-donus
     end-if.
 ters.
         compute  ttop-top = top-top * top-top / top-top       
         compute  ttop-top-8 =    top-top-8  *  top-top-8  / top-top-8      
         compute  ttop-ind   =    top-ind    *  top-ind    / top-ind        
         compute  ttop-net   =    top-net    *  top-net    / top-net        
         compute  ttop-net-8 =    top-net-8  *  top-net-8  / top-net-8      
         compute  ttop-kdv   =    top-kdv    *  top-kdv    / top-kdv        
         compute  ttop-kdv-8 =    top-kdv-8  *  top-kdv-8  / top-kdv-8      
         compute  ttop-gen   =    top-gen    *  top-gen    / top-gen        
         compute  ttop-gen-8 =    top-gen-8  *  top-gen-8  / top-gen-8      
         compute  ttop-gen-dv =   top-gen-dv *  top-gen-dv / top-gen-dv     
                                                                       
         compute  tgtop-top    =   gtop-top   *  gtop-top   / gtop-top       
         compute  tgtop-top-8  =   gtop-top-8 *  gtop-top-8 / gtop-top-8     
         compute  tgtop-ind    =   gtop-ind   *  gtop-ind   / gtop-ind       
         compute  tgtop-net    =   gtop-net   *  gtop-net   / gtop-net       
         compute  tgtop-net-8  =   gtop-net-8 *  gtop-net-8 / gtop-net-8     
         compute  tgtop-net-18 =   gtop-net-18 *  gtop-net-18 / gtop-net-18    
         compute  tgtop-kdv    =   gtop-kdv    * gtop-kdv   / gtop-kdv       
         compute  tgtop-kdv-8  =   gtop-kdv-8  * gtop-kdv-8 / gtop-kdv-8     
         compute  tgtop-kdv-18  =  gtop-kdv-18 * gtop-kdv-18 / gtop-kdv-18    
         compute  tgtop-gen    =   gtop-gen    * gtop-gen   / gtop-gen       
         compute  tgtop-gen-8  =   gtop-gen-8  * gtop-gen-8 / gtop-gen-8     
         compute  tgtop-gen-dv =   gtop-gen-dv * gtop-gen-dv / gtop-gen-dv    
                                                                       
                             .

 
