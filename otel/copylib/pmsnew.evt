* pmsnew.evt
* pmsnew.evt is generated from D:\asya\acugt.ytl\otel\pmsnew.Psf
* This is a generated file. DO NOT modify this file directly.


 Acu-Form1-Event-Extra.
     EVALUATE Event-Type
     WHEN Msg-Close
        PERFORM Acu-Form1-Msg-Close
     END-EVALUATE
     .

 Acu-Form1-Msg-Close.
     ACCEPT Quit-Mode-Flag FROM ENVIRONMENT "QUIT_MODE"
     IF Quit-Mode-Flag = ZERO
        PERFORM Acu-Form1-Exit
        PERFORM Acu-Exit-Rtn
     END-IF
     .

 Acu-Form1-Ef-1-Cmd-Goto.
     EVALUATE Event-Type
* set focus for toolbar
     WHEN CMD-GOTO
        ACCEPT Form1-Ef-1
     END-EVALUATE
     .

 Acu-Form1-Ef-1a-Cmd-Goto.
     EVALUATE Event-Type
* set focus for toolbar
     WHEN CMD-GOTO
        ACCEPT Form1-Ef-1a
     END-EVALUATE
     .

 Acu-Form1-Ef-1aa-Cmd-Goto.
     EVALUATE Event-Type
* set focus for toolbar
     WHEN CMD-GOTO
        ACCEPT Form1-Ef-1aa
     END-EVALUATE
     .

 Acu-Form1-Ef-1aaa-Cmd-Goto.
     EVALUATE Event-Type
* set focus for toolbar
     WHEN CMD-GOTO
        ACCEPT Form1-Ef-1aaa
     END-EVALUATE
     .

 Acu-acc-tarih-Cmd-Goto.
     EVALUATE Event-Type
* set focus for toolbar
     WHEN CMD-GOTO
        ACCEPT acc-tarih
     END-EVALUATE
     .

 Acu-acc-zaman-Cmd-Goto.
     EVALUATE Event-Type
* set focus for toolbar
     WHEN CMD-GOTO
        ACCEPT acc-zaman
     END-EVALUATE
     .

 Form1-Event-Proc.
* 
     PERFORM Acu-Form1-Event-Extra
     .

 Form1-Exception-Proc.
     PERFORM Form1-Ex-Other
     .

 Form1-Ef-1-Event-Proc.
* 
     EVALUATE Event-Control-Id
     WHEN 3
        PERFORM Acu-Form1-Ef-1-Cmd-Goto
     WHEN 5
        PERFORM Acu-Form1-Ef-1a-Cmd-Goto
     WHEN 7
        PERFORM Acu-Form1-Ef-1aa-Cmd-Goto
     WHEN 9
        PERFORM Acu-Form1-Ef-1aaa-Cmd-Goto
     WHEN 13
        PERFORM Acu-acc-tarih-Cmd-Goto
     WHEN 14
        PERFORM Acu-acc-zaman-Cmd-Goto
     END-EVALUATE
     .
***   start event editor code   ***
*
*27/02/2013 tarihinde yeni güncelleme yapildi.
*05/05/2013 tarihinde kaya belek için güncellendi.
*28.08.2013 tarihinde kaya belek için güncelleme yapaýldý.
*30.05.2013 tarihinde folref ata paragraflarý kaya belek için düeltildi.
*30.05.2013 tarihinde sadece rooma atýyordu önce extra bulamazsa room oalrak senromeçlendi ....
*06.03.2014 tarihinde yeni liblere göre compile + telerr-dosya 
*17.03.2014 tarihinde yeni liblere göre compile ( konuk.lib 
*25.03.2014 tarihinde yeni liblere göre compile ( konuk.lib  ( for KAYA RAMADA )
 Form1-Bef-Create.

     accept komut-satiri from command-line



     call "/asya/ytl/obj/tcp-ip/killet.asy" 
          on exception continue
          not on exception
     cancel "/asya/ytl/obj/tcp-ip/killet.asy" 
     end-call.

     move 0 to gonderilen-adet.
     accept emir-no from time.
     open output emir close emir open i-o emir.

     accept pms-log-dosya-date from century-date
     open extend pms-log.

     set environment "RENEW_TIMEOUT" to 1.
     set environment "EXTEND_CREATES" to 1.
     perform acilis-kontrol.
     perform adresleri-tasi.
     move 0 to tay-adette islem-adette.


     move isyeri-adres-tasi          to telerr-dosya-adres.

 acilis-kontrol.
     initialize k-kodu-tasi isyeri-adres-tasi itv-port-ayar itv-port
     accept k-kodu-tasi from environment "ITV-KULLANICI".
     accept isyeri-adres-tasi from environment "ITV-SIRKET".
     accept itv-port-ayar from environment "ITV-PORT-AYAR".
     accept itv-port      from environment "ITV-PORT".
*YURI
*     MOVE "ASYA"                   to k-kodu-tasi
*     move "12345678"               to isyeri-adres-tasi
*     move "9600,N,8,1"             to itv-port-ayar
*     move "4"                      to itv-port
*YURI
     if k-kodu-tasi = spaces or 
        isyeri-adres-tasi = spaces
               move "Kullanici Yada Tanimli Isyeri Tanimsiz ...."  to pms-log-paket
               perform pms-log-yaz
               close emir pms-log

               display message box
                       "Pms2Asya programinin calismasi icin gerekli",new-line,
                       "Kullanici kodu sirket parametresi ve port ayarlari eksik !",new-line
                       "Server' da cblconfig dosyasina ekleyiniz" new-line
                       new-line,
                       "Ornek :",new-line
                       "ITV-KULLANICI",x"09","ITV ",new-line,
                       "ITV-SIRKET",x"09","otel2007",new-line,
                       "ITV-PORT",x"0909","1",new-line,
                       "ITV-PORT-AYAR",x"09","9600,n,8,1",new-line,
                       new-line
                       "Port Ayarlari",new-line
                       "ITV-PORT",x"0909","[1-Com1 2-Com2 3-Com3 ...]",new-line
                       "ITV-PORT-AYAR",x"09","a,b,c,d",new-line,
                       "a-Baud rate",x"09","[2400-9600-14400-19200-28800-...]",new-line,
                       "b-Parity",x"0909","[e-even n-none o-odd s-space]",new-line,
                       "c-Data bit",x"0909","[4-5-6-7-8]",new-line,
                       "d-Stop bit",x"0909","[1-1.5-2]"
                       icon mb_error_icon
                       title "Parametre tanimsiz"
                       goback.

     open input kllnc
     move k-kodu-tasi      to k-kodu
     read kllnc no lock invalid
          move "Kullanici Tanimsiz ...."  to pms-log-paket
          perform pms-log-yaz
          close emir pms-log

          close kllnc
          display message box 
                  "Server' da yer alan cblconfig dosyasi icindeki",new-line,
                  "ITV-KULLANICI",x"09",k-kodu-tasi,new-line,
                  "olarak belirtilmis ve kullanici kodu tanimlamasinda bulunamadi !"
                  icon mb_error_icon
                  title "Kullanici Tanimsiz .."
                  goback
     end-read
     close kllnc.

     set islem-hatali to true
     open input isyeri
     initialize isyeri-rec
     start isyeri key not < isyeri-no invalid
           continue
     not invalid
     initialize fs-isyeri
     perform with test after until fs-isyeri = "10"
     read isyeri next no lock end move "10" to fs-isyeri
     not at end
          if isyeri-adres = isyeri-adres-tasi
             set islem-bitti to true
             exit perform
          end-if
     end-read
     end-perform
     end-start
     close isyeri.

     if islem-hatali
        move "Sirket Tanimsiz ...."  to pms-log-paket
        perform pms-log-yaz
        close emir pms-log
        display message box 
                  "Server' da yer alan cblconfig dosyasi icindeki",new-line,
                  "ITV-SIRKET",x"09",isyeri-adres-tasi,new-line,
                  "olarak belirtilmis ve sirket tanimlamasinda bulunamadi !"
                  icon mb_error_icon
                  title "Sirket Tanimsiz .."
                  goback.

     if itv-port-ayar = spaces
        move "Port ayarlari belirsiz "  to pms-log-paket
        perform pms-log-yaz
        close emir pms-log
          display message box 
                  "Server' da yer alan cblconfig dosyasi icindeki",new-line,
                  "ITV-PORT-AYAR dizesi belirtilmemis",new-line,
                  new-line
                  "Kullanimi",new-line
                  "ITV-PORT-AYAR",x"09","a,b,c,d",new-line,
                  "a-Baud rate",x"09","[2400-9600-14400-19200-28800-...]",new-line,
                  "b-Parity",x"0909","[e-even n-none o-odd s-space]",new-line,
                  "c-Data bit",x"0909","[4-5-6-7-8]",new-line,
                  "d-Stop bit",x"0909","[1-1.5-2]"
                  icon mb_error_icon
                  title "Port ayarlari tanimsiz ..."
                  goback
     end-if.

     if itv-port = spaces or 
        itv-port < 1 or 
        itv-port > 9
        move "Port Belirsiz ...."  to pms-log-paket
        perform pms-log-yaz
        close emir pms-log

          display message box 
                  "Server' da yer alan cblconfig dosyasi icindeki",new-line,
                  "ITV-PORT dizesi belirtilmemis",new-line,
                  new-line
                  "Port Ayarlari",new-line
                  "ITV-PORT",x"0909","[1-Com1 2-Com2 3-Com3 ...]",new-line
                  title "Port belirsiz"
                  icon mb_error_icon
                  goback
     end-if.     
     .

**********************************************
**************** LRC HESAP START ****************
**********************************************
 lrc-hesapla.
       initialize xor_deg
       inspect out-buffer tallying xor-boy
                          for trailing low-values.
       compute xor-boy = function length(out-buffer) - xor-boy
       move out-buffer(2:1)     to xor-dest

       perform varying xor-i
               from 3
               by 1
               until xor-i > xor-boy
               move out-buffer(xor-i:1)  to xor-source
               call "cbl_xor" using xor-source
                                    xor-dest
                                    1
               end-call
       end-perform.

*
 lrc-yerlestir.
       add 1 to xor-boy.
       move xor-dest       to out-buffer(xor-boy:).
       move xor-boy        to out-buffer-size.

**********************************************
**************** LRC HESAP END ****************
**********************************************


**************
 open-port.
     modify port,   @CommPort(itv-port),
     modify port,   @Settings(itv-port-ayar),
     modify port,   @Handshaking(@XonXoff),
     modify port,   @RThreshold(0), | Her gelen karakterde event oluÐtur
     modify port,   @SThreshold(0), | Her giden karakterde event oluÐtur
     modify port,   @DtrEnable(1)
     modify port,   @RtsEnable(1)
     modify port,   @inputmode(@comInputModeText)
     modify port,   @InputLen(1)
     modify port,   @PortOpen(1).
     display "Port Aciliyor ......".

*
 close-port.
     modify port,
            @portopen(0).
     display "Port Kapatiliyor ......".
*
 send-port.
    modify port, @Output(out-buffer(1:out-buffer-size)).
    perform send-port-2-grid.
    initialize pms-log-rec
    move out-buffer(1:out-buffer-size)    to pms-log-paket
    move "ASYA->"                         to pms-log-from
    perform pms-log-yaz.
*
 send-port-2-grid.
    initialize form1-gd-1-record
    move "ASYA->"                                to gd-1-col-0
    accept gd-1-col-1 from century-date
    accept gd-1-col-2 from time
    evaluate out-buffer-size
    when 1
         evaluate out-buffer(1:1)
         when pms-paket-ok
              move "ACK"                         to gd-1-col-3
         when pms-paket-hata
              move "NAK"                         to gd-1-col-3
         end-evaluate
    when other
         move out-buffer                         to gd-1-col-3
    end-evaluate.
    inspect form1-gd-1-record replacing all low-values by spaces

    display form1-gd-1-record col 1 color 3 high.
    display " ".



    add  1 to gonderilen-adet.
    if gonderilen-adet > 150
        close pms-log emir
        stop run
    end-if.

    display gonderilen-adet col 1 color 5 high.
    display " ".
   




*
 read-port-2-grid.
    initialize form1-gd-1-record
    move "PMS->"                                to gd-1-col-0
    accept gd-1-col-1 from century-date
    accept gd-1-col-2 from time
    evaluate in-buffer(1:1)
      when pms-paket-ok
           move "ACK"                         to gd-1-col-3
      when pms-paket-hata
           move "NAK"                         to gd-1-col-3
      when other
           move in-buffer                     to gd-1-col-3
    end-evaluate.
    inspect form1-gd-1-record replacing all low-values by spaces
    display form1-gd-1-record col 1 color 4 high.
    display " ".

 read-port-by-size.
    move 0 to in-buffer-size  
    move all low-values to in-buffer
    perform with test after until 1 = 0
            inquire port, 
                    @inbuffercount in in-buffer-size

            if in-buffer-size < read-boy
               accept eh col 1 auto no advancing before time 1 on exception
                      accept key-status from escape
               end-accept  
               if key-status = 5
                  perform cikis-yaz
                  close pms-log emir
                  goback
               end-if
               add 1 to read-retry
            else
               perform varying read-i
                       from 1
                       by 1
                       until read-i > read-boy
                       inquire port, 
                               @input in in-buffer(read-i:1)
               end-perform
               subtract 1 from read-i
               display "read-port-by-size .....",sis-date,"-",sis-zaman,in-buffer upon debug

               exit perform
            end-if
            if max-read-retry
               exit perform
            end-if
    end-perform.
    if read-i > 0 
       perform read-port-2-grid
       initialize pms-log-rec
       move in-buffer(1:read-i)     to pms-log-paket
       move "PMS->"                 to pms-log-from
       perform pms-log-yaz
    end-if.



*
 read-port-by-paket.
    move 0 to in-buffer-size  
    move all low-values to in-buffer
    perform with test after until 1 = 0
            inquire port, 
                    @inbuffercount in in-buffer-size

            if in-buffer-size = 0
               accept eh col 1 auto no advancing before time 1 on exception
                      accept key-status from escape
               end-accept  
               if key-status = 5
                  perform cikis-yaz
                  close pms-log emir
                  goback
               end-if

               add 1 to read-retry
               if max-read-retry
                  exit perform
               else
                  exit perform cycle
               end-if

            end-if

            move 0 to read-retry
            add 1 to read-i
            inquire port, 
                    @input in in-buffer(read-i:1)

            if in-buffer(read-i - 1:1) = pms-paket-bit
               display "read-port-by-paket .....",sis-date,"-",sis-zaman,in-buffer upon debug

               exit perform
            end-if
    end-perform.
    if read-i > 0 
       perform read-port-2-grid
       initialize pms-log-rec
       move in-buffer(1:read-i)     to pms-log-paket
       move "PMS->"                 to pms-log-from
       perform pms-log-yaz
    end-if.

*
 send-ok-port.
    move all low-values to out-buffer
    move pms-paket-ok   to out-buffer(1:1)
    move 1              to out-buffer-size.
    perform send-port.

*
 send-ver-port.
      move all low-values to paket-filler out-buffer
*      move "M"            to paket-trid-tanýmlayici
      move pms-paket-bit  to paket-filler(1:1)
      set paket-komut-ver to true
      string out-buffer,
             paket delimited by low-values
             into out-buffer
      perform lrc-hesapla
      perform lrc-yerlestir
      perform send-port.

*
 send-strt.
     initialize emir-rec
     move "000"            to emir-anah
     move 15               to emir-beklenen-boy
     move all low-values   to out-buffer
     string out-buffer
            pms-paket-bas delimited by low-values
            "M0009999STRT" delimited by low-values
            pms-paket-bit delimited by low-values 
            into out-buffer.

     move out-buffer       to emir-paket
     write emir-rec invalid
           rewrite emir-rec end-rewrite
     end-write 

     perform lrc-hesapla
     perform lrc-yerlestir
     perform send-port.

     initialize read-deg.
     move 1 to read-boy.
     perform read-port-by-size.
     if read-boy <> read-i
        set send-hata to true
        exit paragraph
     end-if.

     initialize read-deg
     perform read-port-by-paket.
     if max-read-retry
        set send-cevap-hata to true
        exit paragraph
     end-if.

send-err-port.
     move all low-values       to paket-filler out-buffer
     move pms-err-rec          to paket-filler(1:2)
     move pms-paket-bit        to paket-filler(3:1)
     set paket-komut-err       to true
     string out-buffer,
            paket delimited by low-values
            into out-buffer
     perform lrc-hesapla
     perform lrc-yerlestir
     perform send-port.

     initialize read-deg.
     move 1 to read-boy.
     perform read-port-by-size.
     if read-boy <> read-i
        set send-hata to true
        exit paragraph
     end-if.

*
 send-name-port.
    initialize pms-name-rec konuk-rec bilgi-durum pms-look-room-number
    move paket-filler                 to pms-look-room-number
    open input konuk
    move "I"                                       to konuk-durumu
    move function numval-c(pms-look-room-number)   to 4hane
    move 4hane                                     to konuk-odano
    start konuk key not < konuk-oda invalid
            continue
    not invalid
    initialize fs-konuk
    perform with test after until fs-konuk = "10"
    read konuk next no lock end move "10" to fs-konuk
    not at end
         if konuk-durumu <> "I" or
            konuk-odano <> 4hane
                  exit perform
         end-if

         if konuk-fol-kodu <> "R"
            exit perform cycle
         end-if

         move "E"                     to bilgi-durum

         initialize pms-name-rec 
         if pms-look-room-number(1:1) = "0"
            move pms-look-room-number(2:)   to pms-name-room-number
         else
            move pms-look-room-number       to pms-name-room-number
         end-if 
         move konuk-rez-no            to 6hane
         move 6hane                   to pms-name-account-number

         move konuk-soyadi            to pms-name-guest-name
         move "N"                     to pms-name-message-waiting
         exit perform
 
      end-read
      end-perform
      end-start
      close konuk.

      if bilgi-durum <> "E"
         move "3 "  to pms-err-error-code
         exit paragraph
      end-if


      if function upper-case(komut-satiri) = "DOGUMTARIHI"
         perform dogumtarihi-al
         initialize pms-name-guest-name
         move dog-tar               to pms-name-guest-name
      end-if

      if function upper-case(komut-satiri) = "REZNO"
         initialize pms-name-guest-name
         move konuk-rez-no          to pms-name-guest-name
         
      end-if

      inspect pms-name-rec replacing all low-values by spaces
      perform name2trk2eng.

      move all low-values to out-buffer
      string out-buffer
             pms-paket-bas               delimited by low-values
             "M"                         delimited by low-values
             paket-trid-numara           delimited by low-values
             "9999"                      delimited by low-values
             "NAME"                      delimited by low-values
             pms-name-rec                delimited by low-values
             pms-paket-bit               delimited by low-values 
             into out-buffer.
      perform lrc-hesapla
      perform lrc-yerlestir
      perform send-port.

      initialize read-deg.
      move 1 to read-boy.
      perform read-port-by-size.
      if read-boy <> read-i
         set send-hata to true
         exit paragraph
      end-if.

*

 Form1-Aft-Initdata.
     perform open-port.
     perform send-strt.

     if send-ok
        move in-buffer    to paket
        perform emir-sil
     end-if.

     perform  islem-yonet.

*
 islem-yonet.
     perform with test after until key-status = 5
             accept eh col 1 auto no advancing before time 1 on exception
                    accept key-status from escape
             end-accept  
             if key-status = 5
                perform cikis-yaz
                close pms-log emir
                goback
             end-if
             accept sis-zaman from time
             accept sis-date from century-date
             modify acc-tarih value = sis-date
             modify acc-zaman value = sis-zaman

             initialize read-deg
             perform read-port-by-paket
             if max-read-retry | paket yok
                perform emir-kontrol
             end-if
             
             perform paket-kontrol
             display "islem yonet .....",sis-date,"-",sis-zaman upon debug
     end-perform.

*
 paket-kontrol.
     move in-buffer                 to paket.
     evaluate true
     when paket-komut-TEST
          perform send-ok-port
          perform send-ver-port
          initialize read-deg
          move 1 to read-boy
          perform read-port-by-size
          if read-boy <> read-i
             set send-hata to true
             exit paragraph
          end-if
     when paket-komut-VER
          perform send-ok-port
          move in-buffer          to paket
          perform emir-sil
     when paket-komut-LOOK
          perform send-ok-port
          perform send-name-port
          if bilgi-durum <> "E"
             perform send-err-port
          end-if
     when paket-komut-INIT
          perform send-ok-port
*          perform send-ver-port
          
*          initialize read-deg
*          move 1 to read-boy
*          perform read-port-by-size
*          if read-boy <> read-i
*             set send-hata to true
*             exit paragraph
*          end-if
     when paket-komut-err
          perform send-ok-port

     when paket-komut-strt
          perform send-ok-port
          perform send-ver-port
          initialize read-deg
          move 1 to read-boy
          perform read-port-by-size
          if read-boy <> read-i
             set send-hata to true
             exit paragraph
          end-if

     when paket-komut-post
           perform folio-isle
           if folio-isle-durum = "E"
              perform send-ver-port
           else
              perform send-err-port
           end-if
           initialize read-deg
           move 1 to read-boy
           perform read-port-by-size
           if read-boy <> read-i
              set send-hata to true
              exit paragraph
           end-if
     when other
          if paket(1:1) = pms-paket-ok or
             paket(1:1) = pms-paket-hata or
             paket-komut = spaces or
             paket-komut = low-values
                  continue
          else
*             perform send-err-port
             move "Tanimsiz Paket ...."      to pms-log-aciklama
             perform pms-log-yaz

          end-if
     end-evaluate.
     initialize in-buffer paket.

*
 emir-kontrol.
     perform tay-kontrol.
     perform emir-gonder.
 
*
 emir-gonder.
     initialize emir-rec
     start emir key not < emir-anah invalid
           continue
     not invalid
     initialize fs-emir
     perform with test after until fs-emir = "10"
     read emir next no lock end move "10" to fs-emir
     not at end
          move 0 to in-buffer-size
          inquire port, 
                  @inbuffercount in in-buffer-size
          if in-buffer-size <> 0 
             exit perform
          end-if

          move emir-paket                 to out-buffer
          inspect out-buffer replacing trailing spaces by low-values
          perform lrc-hesapla
          perform lrc-yerlestir
          perform send-port

          initialize read-deg
          move 1 to read-boy
          perform read-port-by-size
          if read-boy <> read-i
             set send-hata to true
             exit paragraph
          end-if

*/ VER bekliyorum
*          initialize read-deg
*          perform read-port-by-paket
*          if max-read-retry
*             set send-cevap-hata to true
*             exit paragraph
*          end-if
*/ paket icerigini kontrol ediyorum
*          move in-buffer              to paket
*          if paket-komut-ver
*             if paket-trid-numara = emir-anah
*                perform emir-sil
*             else
*                exit perform | benim iþlemim deðil
*             end-if
*          else
*             exit perform | Istedigim cevap gelmedi
*          end-if
           exit perform
          
     end-read
     end-perform
     end-start.


*
 tay-kontrol.
     add 1 to tay-adette islem-adette

     if tay-adette > 10
        open i-o onbkodlar10
        initialize onbkodlar10-rec
        move "EE"                 to onbkodlar10-tipi
        read onbkodlar10 no lock invalid
             initialize onbkodlar10-rec
             initialize onbkodlar10-entegrasyonlar
             move "EE"            to onbkodlar10-tipi
        end-read

        accept onbkodlar10-pms-tarih from century-date
        accept onbkodlar10-pms-zaman from time
        rewrite onbkodlar10-rec invalid
                write onbkodlar10-rec end-write
        end-rewrite
        close onbkodlar10
        move 0 to tay-adette
     end-if

     if function upper-case(komut-satiri) = "DOGUMTARIHI"
        display "**************DOGUMTARIHI SIFRESINE GORE**************************" col 1 color 7 high
             display " "
     end-if
     if function upper-case(komut-satiri) = "REZNO"
        display "**************REZERVASYON NUMARASI SIFRESINE GORE**************************" col 1 color 7 high
             display " "
     end-if
     display "Tay kontrol -> Islem No :" col 1 color 7 high
     display islem-adette col 12 color 4 high
     display "Tay kontrol ->  Log Dosyasi :  " col 19 color 7 high.
     display pms-log-dosya col 35 color 4 high.
     display " "


     if islem-adette > 150
        close pms-log emir
        stop run
     end-if
     
     initialize pms-log-paket
     move "Tay kontrol(2) -> Islem No :"          to pms-log-paket  
     move islem-adette          to pms-log-paket(12:) 
     move "Tay kontrol(2) ->  Log Dosyasi :  "    to pms-log-paket(19:) 
     move pms-log-dosya         to pms-log-paket(35:) 
     perform pms-log-yaz


     move isyeri-adres-tasi              to telayarq-dosya-adres
     initialize tay-deg
     
     move all low-values to tay-klasor
     string tay-klasor,
            "/asya/ytl/log/otel/" delimited by low-values
             isyeri-adres-tasi delimited by low-values
            into tay-klasor.
            
     call "c$list-directory" using 
                             listdir-open, 
                             tay-klasor,
                             "*". 

    move return-code to tay-handle.
    if tay-handle = 0
       call "c$list-directory" using listdir-close tay-handle
       initialize event-bekle
       exit paragraph
    end-if.

    initialize tay-filename

    perform with test after until tay-filename = spaces
    call "c$list-directory" using listdir-next, 
                                  tay-handle, 
                                  tay-filename,
                                  listdir-file-information


    if tay-filename <> spaces and 
       listdir-file-type-regular-file
       inspect tay-filename replacing trailing spaces by low-values
  
       move zeroes to tay-i
       inspect tay-filename tallying tay-i for all ".may"
                    
       if tay-i = zeroes
          exit perform cycle 
       end-if

       move all low-values to tay-dosya
             
       string "/asya/ytl/log/otel/" delimited by low-values
              isyeri-adres-tasi delimited by low-values
              "/" delimited by low-values
              tay-filename   delimited by low-values
              into tay-dosya

       move tay-filename      to telayarq-dosya-adi
       open input telayarq
       initialize telayarq-rec
       read telayarq next no lock end-read
       close telayarq  
       if telayarq-rec = spaces  
           call "CBL_DELETE_FILE" using telayarq-dosya
           exit perform cycle
       end-if

*/ daha once emir varmýydi
       initialize emir-rec
       set emir-tip-tay to true
       start emir key not < emir-anah invalid
             move "10"     to fs-emir
       not invalid
       initialize fs-emir
       perform with test after until fs-emir = "10"
       read emir next no lock end move "10" to fs-emir
       not at end
            if not emir-tip-tay
               move "10" to fs-emir
            else
               if emir-tay-icerik = telayarq-rec
                  exit perform
               end-if
            end-if
       end-read
       end-perform
       end-start

       if fs-emir = "10"
          perform bos-emir-bul
          set emir-tip-tay         to true
          move all low-values      to emir-paket
          move tay-dosya           to emir-tay-dosya
          move telayarq-rec        to emir-tay-icerik
          if telayarq-odano(1:1) = "0" 
             move telayarq-odano(2:)    to ziver
          else
             move telayarq-odano        to ziver
          end-if
*          inspect ziver replacing all spaces by low-values

          evaluate telayarq-islem
          when "A "
          string emir-paket
                 pms-paket-bas       delimited by low-values
                 "M"                 delimited by low-values
                 emir-anah           delimited by low-values
                 "9999"              delimited by low-values
                 "CHKI"              delimited by low-values
                 ziver      delimited by low-values
                 "  "                delimited by low-values
                 pms-paket-bit       delimited by low-values 
                 into emir-paket
          when "K "
          string emir-paket
                 pms-paket-bas       delimited by low-values
                 "M"                 delimited by low-values
                 emir-anah           delimited by low-values
                 "9999"              delimited by low-values
                 "CHKO"              delimited by low-values
                 ziver      delimited by low-values
                 "  "                delimited by low-values
                 pms-paket-bit       delimited by low-values 
                 into emir-paket
          end-evaluate

          write emir-rec end-write

       end-if
    end-if

    end-perform.

    call "c$list-directory" using listdir-close tay-handle.

*
 bos-emir-bul.
    perform varying i
            from 1
            by 1
            until i > 999
                  initialize emir-rec
                  move i to emir-anah 
                  read emir no lock invalid
                       initialize emir-rec
                       move i     to emir-anah
                       exit perform
                  end-read
    end-perform.

*
 emir-sil.
*/ errr olursa emir silinmeyecek UNUTMAAAAAAAAAAAA !!!!     
     initialize emir-rec
     move paket-trid-numara          to emir-anah
     read emir no lock invalid
          continue
     not invalid
          if emir-tip-tay
             call "CBL_DELETE_FILE" using emir-tay-dosya
          end-if
          delete emir invalid
                 continue
          end-delete
     end-read.   

      

     
     .
*
 cikis-yaz.
     initialize pms-log-paket
     move "F5- Tusu ile Cikildi "   to pms-log-paket
     perform pms-log-yaz.
*
 pms-log-yaz.
     accept sis-date from century-date.
     if sis-date <> pms-log-dosya-date 
        close pms-log
        move sis-date    to pms-log-dosya-date
        open extend pms-log
     end-if.

     accept pms-log-date from century-date
     accept pms-log-time from time
     evaluate pms-log-paket(1:1)
     when pms-paket-ok
          move "ACK"                to pms-log-paket
     when pms-paket-hata
          move "NAK"                to pms-log-paket
     end-evaluate
     write pms-log-rec.
     
*
 name2trk2eng.
    inspect pms-name-guest-name            
            converting x"98" to x"49"
*x9e => büyük s 
    inspect pms-name-guest-name
            converting x"9E" to x"53"
*x99 => Ö
    inspect pms-name-guest-name
            converting x"99" to x"4F"
*x9A => Ü
    inspect pms-name-guest-name
            converting x"9A" to x"55"
*x9A => Ç
    inspect pms-name-guest-name
            converting x"80" to x"43"
*x9A => yumusak G
    inspect pms-name-guest-name
            converting x"A6" to x"47"
****** KUCUK KARAKTERLER
*x9A => yumusak G
    inspect pms-name-guest-name
            converting x"A7" to x"67"
* kucuk i noktasizi
    inspect pms-name-guest-name
            converting x"8D" to x"69"
* kucuk ü 
    inspect pms-name-guest-name
            converting x"81" to x"75"
* kucuk ç 
    inspect pms-name-guest-name
            converting x"87" to x"63"
* kucuk s  
    inspect pms-name-guest-name
            converting x"9F" to x"73"
* kucuk s  
    inspect pms-name-guest-name
            converting x"94" to x"6F".    
*
 Form1-Ex-Other.
    if key-status <> 5
       initialize key-status
    else 
       perform cikis-yaz
       set exit-pushed to true
    end-if.


*
 folio-isle.
    move paket-filler     to pms-post-rec
    move pms-post-charge-amount         to x250
    move function numval-c(x250)          to  pms-post-charge-amount
    if pms-post-charge-amount numeric and pms-post-charge-amount > 0  and pms-post-charge-amount < 10000
       continue
    else
       move "E" to folio-isle-durum
       exit paragraph
    end-if

      if pms-post-revenue-code <> "01" and 
         pms-post-revenue-code <> "42" and 
         pms-post-revenue-code <> "83"
         move "01" to pms-post-revenue-code
      end-if
      initialize folio-isle-durum

***********
      if pms-post-room-number(4:1) = spaces
         move pms-post-room-number(1:3) to pms-post-room-number(2:3)
         move "0"                       to pms-post-room-number(1:1)
      end-if
***********

      perform genel-oku.

      open i-o ciftleme.
      move calisma-tarihi         to ciftleme-tarih
      move paket-trid             to ciftleme-numara
      move pms-post-room-number   to ciftleme-oda.
      read ciftleme no lock invalid
           continue
      not invalid
           move "E"         to folio-isle-durum
           close ciftleme
           exit paragraph
      end-read
      close ciftleme.



      open input depkod kodlar02
      initialize kodlar02-rec depkod-rec
      move "W"                           to kodlar02-tipi
      move pms-post-revenue-code         to kodlar02-kodu
      read kodlar02 no lock invalid
           initialize telerr-rec
           string telerr-rec
                  "Oda :[",pms-post-room-number,"] "
                  "Paket : [",pms-post-rec,"] ",
                  "Gelir kodu tanimsiz ..."
                  into telerr-rec
           perform itv-errorlog
           close depkod kodlar02
           exit paragraph
      end-read
      move itv-onb-dep                   to depkod-anah
      read depkod no lock invalid
           initialize telerr-rec
           string telerr-rec
                  "Oda :[",pms-post-room-number,"] "
                  "Paket : [",pms-post-rec,"] ",
                  "Gelir Departmani tanimsiz ..."
                  into telerr-rec
           perform itv-errorlog
           close depkod kodlar02
           exit paragraph
      end-read
      if depkod-ba <> "B"
           initialize telerr-rec
           string telerr-rec
                  "Oda :[",pms-post-room-number,"] "
                  "Paket : [",pms-post-rec,"] ",
                  "Gelir Alacak Olamaz ..."
                  into telerr-rec
           perform itv-errorlog
           close depkod kodlar02
           exit paragraph
      end-if

      if itv-onb-banka = zeroes
           initialize telerr-rec
           string telerr-rec
                  "Oda :[",pms-post-room-number,"] "
                  "Paket : [",pms-post-rec,"] ",
                  "Itv Banka Tanimlamasi Bos ..."
                  into telerr-rec
           perform itv-errorlog
           close depkod kodlar02
           exit paragraph
      end-if

      if itv-onb-doviz = zeroes
           initialize telerr-rec
           string telerr-rec
                  "Oda :[",pms-post-room-number,"] "
                  "Paket : [",pms-post-rec,"] ",
                  "Itv Doviz Tanimlamasi Bos ..."
                  into telerr-rec
           perform itv-errorlog
           close depkod kodlar02
           exit paragraph
      end-if

      if itv-onb-doviz-efektif = spaces or 
         itv-onb-alis-satis = spaces
           initialize telerr-rec
           string telerr-rec
                  "Oda :[",pms-post-room-number,"] "
                  "Paket : [",pms-post-rec,"] ",
                  "Itv Doviz/Efektif-Alis/Satis Tanimlamasi Bos ..."
                  into telerr-rec
           perform itv-errorlog
           close depkod kodlar02
           exit paragraph
             
      end-if

      close depkod kodlar02

      initialize hrkgir-rec
      perform exthrk-islem-no-al.

      perform folio-bul.
      if bilgi-durum = "X"
           initialize telerr-rec
           string telerr-rec
                  "Oda :[",pms-post-room-number,"] "
                  "Paket : [",pms-post-rec,"] ",
                  "Room/Extra Folio bulunamadi ..."
                  into telerr-rec
           perform itv-errorlog
           exit paragraph
      end-if
         
      perform kur-al.
      if bilgi-durum = "X"
         exit paragraph
      end-if

      if kur-deger = 0 
           initialize telerr-rec
           string telerr-rec
                  "Oda :[",pms-post-room-number,"] "
                  "Paket : [",pms-post-rec,"] ",
                  "Kur degeri 0"
                  into telerr-rec
           perform itv-errorlog
           move "X" to bilgi-durum
           exit paragraph
      end-if


      move depkod-anah              to hrkgir-depkod
      move "I"                      to hrkgir-islem-tipi | Itv kaydi
      move calisma-tarihi           to hrkgir-tarih
      move depkod-ba                to hrkgir-ba
      move pms-post-charge-amount   to hrkgir-dv-tutar hrkgir-cekno

      compute hrkgir-dv-tutar = (hrkgir-dv-tutar / 100) 

****/ KDV VARSA
      compute hrkgir-dv-tutar rounded = hrkgir-dv-tutar + (hrkgir-dv-tutar / 100 * ITV-ONB-KDV)
****/

      compute hrkgir-tl-tutar rounded = hrkgir-dv-tutar * kur-deger
      accept hrkgir-zaman from time

      move "MAGI"                   to hrkgir-staf

********************kopyalanacak
      open input route konu2 rez kodlar02 
      open i-o yromhrk onkasa konuk

      move hrkgir-rec  to yromhrk-rec
      move hrk2-data to yromhrk-data
      write yromhrk-rec invalid
            close yromhrk route konu2 rez kodlar02 konuk onkasa
            initialize telerr-rec
            string telerr-rec
                   "Oda :[",pms-post-room-number,"] "
                   "Paket : [",pms-post-rec,"] ",
                   "Write Yromhrk->Hata"
                   into telerr-rec
            perform itv-errorlog
            move "X" to bilgi-durum
            exit paragraph 
      end-write 
      close yromhrk
    
      perform folref-bul
      perform folref-ata
      close route konu2 rez kodlar02

      open i-o hrk2
      move hrkgir-anah to hrk2-anah
      move yromhrk-folio to hrk2-kaynak-folio
      write hrk2-rec end-write
      close hrk2
      move hrkgir-rec       to romhrk-rec exthrk-rec
**************** kopyalanacak
      open i-o romhrk exthrk
      if  konu2-fol-kodu = "R" 
          write romhrk-rec invalid
              close onkasa konuk romhrk exthrk
              initialize telerr-rec
              string telerr-rec
                     "Oda :[",pms-post-room-number,"] "
                     "Paket : [",pms-post-rec,"] ",
                     "Write romhrk->Hata",
                     "* Romhrk Islemno : ",romhrk-islem 
                     into telerr-rec
              perform itv-errorlog
              move "X" to bilgi-durum
              exit paragraph 
          end-write
      else  
          write exthrk-rec invalid
              close onkasa konuk romhrk exthrk
              initialize telerr-rec
              string telerr-rec
                     "Oda :[",pms-post-room-number,"] "
                     "Paket : [",pms-post-rec,"] ",
                     "Write exthrk->Hata",
                     "* Exthrk Islemno : ",exthrk-islem 
                     into telerr-rec
              perform itv-errorlog
              move "X" to bilgi-durum
              exit paragraph 
          end-write
      end-if
 
      close romhrk exthrk

      initialize onkasa-rec
      move hrkgir-tarih              to onkasa-tarih
      move hrkgir-depkod             to onkasa-dep
      read onkasa no lock invalid
           initialize onkasa-tutar-tl onkasa-tutar-dv
      end-read
      initialize onkasa-tutar-tl onkasa-tutar-dv 
      compute onkasa-tutar-tl = onkasa-tutar-tl + hrkgir-tl-tutar
      compute onkasa-tutar-dv rounded = onkasa-tutar-dv + 
              hrkgir-dv-tutar
      write onkasa-rec invalid 
            rewrite onkasa-rec end-rewrite  
      end-write 
   
      move hrkgir-folio                 to konuk-folio
      read konuk no lock invalid
              initialize telerr-rec
              string telerr-rec
                     "Oda :[",pms-post-room-number,"] "
                     "Paket : [",pms-post-rec,"] ",
                     "Read Konuk->Hata",
                     "* Folio Islemno : ",hrkgir-folio
                     into telerr-rec
              perform itv-errorlog
      end-read

      compute konuk-top-borc = konuk-top-borc + hrkgir-tl-tutar
      rewrite konuk-rec invalid  
              initialize telerr-rec
              string telerr-rec
                     "Oda :[",pms-post-room-number,"] "
                     "Paket : [",pms-post-rec,"] ",
                     "Read Konuk->Hata",
                     "* Folio Islemno : ",hrkgir-folio
                     into telerr-rec
              perform itv-errorlog
      end-rewrite.     
      close konuk onkasa. 


      move "E" to folio-isle-durum.

      open i-o ciftleme.
      move calisma-tarihi         to ciftleme-tarih
      move paket-trid             to ciftleme-numara
      move pms-post-room-number   to ciftleme-oda.
      read ciftleme no lock invalid
           move hrkgir-tl-tutar   to ciftleme-tutar
           write ciftleme-rec
      end-read
      close ciftleme.



*
 exthrk-islem-no-al.
    open i-o genelfis
    move 1 to genelfis-anahtar
    read genelfis no lock invalid
         initialize genelfis-rec 
         move 1 to genelfis-anahtar
         not invalid continue 
    end-read
    add 1 to cekgir-oto
    move cekgir-oto to hrkgir-islem
    rewrite genelfis-rec invalid 
            write genelfis-rec 
            end-write continue
    end-rewrite
    close genelfis.

*
 genel-oku.
       open input genel
       move 1 to genel-anahtar
       read genel no lock invalid
            move "Onburo calisma parametreleri tanimsiz ...."   to pms-log-paket
            perform pms-log-yaz
            close emir pms-log
            display message box 
                    "Onburo calisma parametreleri tanimsiz ...."
                    icon mb_error_icon
                    title "Hata"
                    close genel
                    goback
       end-read
       close genel.
*
 folio-bul.
    initialize konuk-rec bilgi-durum extra-folio-no room-folio-no
    open input konuk
    move "I"                         to konuk-durumu
    move pms-post-room-number(1:4)   to konuk-odano
    start konuk key not < konuk-oda invalid
          continue                     
    not invalid
    initialize fs-konuk
    perform with test after until fs-konuk = "10"
    read konuk next no lock end move "10" to fs-konuk
    not at end
         if konuk-durumu <> "I" or
            konuk-odano <> pms-post-room-number(1:4)
                  exit perform
         end-if

         if cinpara-ext-fol-ac <> "E"
            if konuk-fol-kodu <> "R"
               exit perform cycle
            end-if
            move konuk-folio      to room-folio-no
            exit perform
         end-if

         if cinpara-ext-fol-ac = "E" 
            if konuk-fol-kodu <> "E"
               exit perform cycle
            end-if
            move konuk-folio      to extra-folio-no
            exit perform
         end-if

         move konuk-folio         to room-folio-no
         exit perform


    end-read
    end-perform
    end-start

    close konuk.

    evaluate true
    when extra-folio-no <> zeroes
         move extra-folio-no        to hrkgir-folio
         move "E"                   to bilgi-durum hangi-folio
    when room-folio-no <> zeroes
         move room-folio-no         to hrkgir-folio
         move "R"                   to bilgi-durum hangi-folio
    when other 
         move "X"                   to bilgi-durum
    end-evaluate.
*
 kur-al.
    initialize bilgi-durum kur-deger
    open input kur
    initialize kur-rec
    move calisma-tarihi             to kur-tarih
    move ITV-ONB-BANKA              to kur-banka
    move ITV-ONB-DOVIZ              to kur-doviz
    read kur no lock invalid
           initialize telerr-rec
           string telerr-rec
                  "Tarih :[",calis-gun,"/",calis-ay,"/",calis-yil,"] "
                  "Paket : [",pms-post-rec,"] ",
                  "Kur bulunamadi ..."
                  into telerr-rec
           perform itv-errorlog
           close kur
           move "X"        to bilgi-durum
           exit paragraph
    end-read
    evaluate true
    when ITV-ONB-DOVIZ-EFEKTIF = "D" and ITV-ONB-ALIS-SATIS = "A"
         move doviz-alis            to kur-deger
    when ITV-ONB-DOVIZ-EFEKTIF = "D" and ITV-ONB-ALIS-SATIS = "S"
         move doviz-satis           to kur-deger
    when ITV-ONB-DOVIZ-EFEKTIF = "E" and ITV-ONB-ALIS-SATIS = "A"
         move efektif-alis          to kur-deger
    when ITV-ONB-DOVIZ-EFEKTIF = "E" and ITV-ONB-ALIS-SATIS = "S"
         move efektif-satis         to kur-deger
    when other
         move doviz-alis   to kur-deger
    end-evaluate
    close kur.
*
*extradan geldi olmadýðý için yýldýzlandý
*30052013 folref-bul.
*30052013       initialize aroute-anah routtur routyazma routbulundu
*30052013       if konuk-fol-kodu = "R" then 
*30052013          move konuk-rez-no to aroute-rezno
*30052013         else
*30052013          if konuk-extra-rez-no  > 0 
*30052013              move konuk-extra-rez-no to aroute-rezno
*30052013           else
*30052013              
*30052013              move konuk-folio to aroute-folio
*30052013          end-if
*30052013       end-if
*30052013
*30052013     
*30052013       perform until routbulundu = 1 or routtur > 10 
*30052013       add 1 to routtur
*30052013       initialize route-rec
*30052013        move aroute-anah to route-anah
*30052013       move hrkgir-depkod   to route-depkod
*30052013       read route no lock invalid
*30052013           
*30052013           perform rout-folio-kontrol
*30052013           perform def-pen-bul
*30052013            move 1 to routbulundu
*30052013         not invalid
*30052013         if route-tip = "P"
*30052013
*30052013            perform rout-folio-kontrol
*30052013            move 1 to routbulundu
*30052013          else
*30052013            if route-tip = "F"
*30052013               if route-no <> route-folio
*30052013                        initialize aroute-anah
*30052013                        move route-no to  aroute-folio
*30052013                   else
*30052013                     perform rout-folio-kontrol
*30052013                     perform def-pen-bul
*30052013                  move 1 to routbulundu
*30052013
*30052013                end-if
*30052013              else
*30052013                if route-no <> route-rezno
*30052013                      initialize aroute-anah
*30052013                      move route-no  to aroute-rezno
*30052013                         else
*30052013                       perform rout-folio-kontrol
*30052013                     perform def-pen-bul
*30052013                  move 1 to routbulundu
*30052013               end-if
*30052013            end-if
*30052013        end-if
*30052013        end-read
*30052013
*30052013
*30052013           
*30052013       
*30052013       end-perform 
*30052013
*30052013       
*30052013        .
*30052013 rout-folio-kontrol.
*30052013     initialize konu2-rec
*30052013     if route-rezno = 0 then
*30052013       move route-folio to konu2-folio
*30052013       else
*30052013        move route-rezno to rez-no
*30052013        read rez no lock invalid
*30052013         move 1 to routyazma
*30052013        end-read
*30052013
*30052013        move rez-folio to konu2-folio
*30052013
*30052013    end-if
*30052013       read konu2 no lock 
*30052013          invalid
*30052013           move 1 to routyazma
*30052013          not invalid
*30052013          if KONU2-ACIK-KAPALI    = "C" 
*30052013            move 2 to routyazma
*30052013          end-if
*30052013          if KONU2-DURUMU not = "I" then
*30052013              move 3 to routyazma
*30052013          end-if
*30052013       end-read
*30052013          .
*30052013 def-pen-bul.
*30052013       initialize konu2-rec
*30052013      if route-rezno = 0 then
*30052013       move route-folio to konu2-folio
*30052013       else
*30052013        initialize rez-rec
*30052013        move route-rezno to rez-no
*30052013        read rez no lock invalid
*30052013         move 1 to routyazma
*30052013        end-read
*30052013        move rez-folio to konu2-folio
*30052013
*30052013     end-if
*30052013       read konu2 no lock 
*30052013          invalid
*30052013           move 1 to routyazma
*30052013          not invalid
*30052013             move "B"               to kodlar02-tipi
*30052013               move konu2-odeme-tipi  to kodlar02-kodu 
*30052013              read kodlar02 no lock invalid
*30052013                    move 1 to route-no
*30052013             
*30052013                  not invalid
*30052013                     if ode-tipi  = "B"  | KREDI ISE
*30052013                          if depkod-tipi = 2 then 
*30052013                                 move 1 to route-no
*30052013                             else
*30052013                                move 2 to route-no
*30052013                          end-if
*30052013                      else
*30052013                         move 1 to route-no
*30052013
*30052013                   end-if
*30052013             end-read
*30052013
*30052013         
*30052013       end-read
*30052013
*30052013          .
*30052013


 folref-bul.
*       if k-kodu-tasi = "ASYA" then stop " " end-if
       initialize aroute-anah routtur routyazma routbulundu  extradan-geldi
       if konuk-fol-kodu = "R" then 
          move konuk-rez-no to aroute-rezno
         else
          if konuk-extra-rez-no  > 0 
              move 1 to extradan-geldi
              move konuk-extra-rez-no to aroute-rezno
           else
              move konuk-folio to aroute-folio
          end-if
       end-if

     
       perform until routbulundu = 1 or routtur > 10 
       add 1 to routtur
       initialize route-rec
       move aroute-anah to route-anah
       move hrkgir-depkod   to route-depkod
       if hrkgir-corr-depkod not = spaces and hrkgir-corr-depkod not = zeroes 
         move  hrkgir-corr-depkod to route-depkod
       end-if
       read route no lock invalid
           
           perform rout-folio-kontrol
           perform def-pen-bul
            move 1 to routbulundu
         not invalid
         if route-tip = "P"

            perform rout-folio-kontrol
            move 1 to routbulundu
          else
            if route-tip = "F"
               if route-no <> route-folio
                        initialize aroute-anah
                        move route-no to  aroute-folio
                   else
                     perform rout-folio-kontrol
                     perform def-pen-bul
                  move 1 to routbulundu

                end-if
              else
                if route-no <> route-rezno
                      initialize aroute-anah
                      move route-no  to aroute-rezno
                         else
                       perform rout-folio-kontrol
                       perform def-pen-bul
                       move 1 to routbulundu

               end-if
            end-if
        end-if
        end-read
       end-perform 
        .
 rout-folio-kontrol.
     initialize konu2-rec
     if route-rezno = 0 then
       move route-folio to konu2-folio
       else
        move route-rezno to rez-no
        read rez no lock invalid
         move 1 to routyazma
        end-read
          
            if extradan-geldi = 1 then 
            
               compute konu2-folio = rez-folio + 1
               read konu2 no lock invalid 
                   move 1 to routyazma
                   move konuk-folio to konu2-folio
                     read konu2 no lock invalid 
                        continue
                      end-read

                   not invalid
                   if konu2-extra-rez-no = rez-no then 
                      continue
                      else
                      move 1 to routyazma
                      move konuk-folio to konu2-folio
                      read konu2 no lock invalid 
                        continue
                      end-read
                  end-if
               end-read
               else
                move rez-folio to konu2-folio
                read konu2 no lock invalid
                       continue
                      end-read
           end-if

    end-if
       read konu2 no lock 
          invalid
           move 1 to routyazma
          not invalid
          if KONU2-ACIK-KAPALI    = "C" 
            move 2 to routyazma
          end-if
          if KONU2-DURUMU not = "I" then
              move 3 to routyazma
          end-if
       end-read
          .
 def-pen-bul.
        
       initialize konu2-rec
      if route-rezno = 0 then
       move route-folio to konu2-folio
       else
        initialize rez-rec
        move route-rezno to rez-no
        read rez no lock invalid
         move 1 to routyazma
        end-read
          if extradan-geldi = 1 then 
               compute konu2-folio = rez-folio + 1
               read konu2 no lock invalid 
                   move 1 to routyazma
                   move konuk-folio to konu2-folio
                   read konu2 no lock invalid
                       continue
                      end-read
                   not invalid
                   if konu2-extra-rez-no = rez-no then 
                      continue
                      else
                      move 1 to routyazma
                      move konuk-folio to konu2-folio
                      read konu2 no lock invalid
                       continue
                      end-read
                  end-if
               end-read
               else
                move rez-folio to konu2-folio
                read konu2 no lock invalid
                       continue
                      end-read
           end-if

     end-if
       read konu2 no lock 
          invalid
           move 1 to routyazma
           move konuk-folio to konu2-folio
           read konu2 no lock invalid continue
           end-read
          not invalid
             move "B"               to kodlar02-tipi
               move konu2-odeme-tipi  to kodlar02-kodu 
              read kodlar02 no lock invalid
                    move 1 to route-no
             
                  not invalid
                     if ode-tipi  not =  "A"  | KREDI ISE
                        if hrkgir-corr-depkod not = spaces and hrkgir-corr-depkod not = zeroes
                                    move  hrkgir-corr-depkod to depkod-anah
                                    read depkod no lock invalid continue
                                    end-read
                        end-if
                          if depkod-tipi = 2 then 
                                 move 1 to route-no
                             else
                                move 2 to route-no
                                

                                  
                               
                          end-if
                          if hrkgir-corr-depkod not = spaces and hrkgir-corr-depkod not = zeroes

                                    move  hrkgir-depkod to depkod-anah
                                    read depkod no lock invalid continue
                                    end-read
                          end-if
                      else
                         move 1 to route-no
                   end-if
             end-read
       end-read
          .
*
 folref-ata.
     if routyazma = 0 and routbulundu = 1 
        move konu2-folio to hrkgir-folio
        if vis-pen = 1 then
           move odemepen to hrkgir-ref
        else
           move route-no to hrkgir-ref
        end-if
     else
       if vis-pen = 1 then
           move odemepen to hrkgir-ref
       else
          move 1 to hrkgir-ref
       end-if
    end-if .


*
*30052013 folref-ata.
*30052013     if routyazma = 0 and routbulundu = 1 
*30052013      move konu2-folio to hrkgir-folio
*30052013      move route-no to hrkgir-ref
*30052013     else | ROUTE HATASI 18/05/2013 RAMAZAN DÜZELTTÝRDÝ
*30052013      move konuk-folio    to konu2-folio
*30052013      read konu2 no lock invalid
*30052013           continue
*30052013      end-read
*30052013    end-if.




















*
 itv-errorlog.
    open extend telerr.
    write telerr-rec.
    close telerr.

    move telerr-rec         to pms-log-aciklama
    perform pms-log-yaz.
*
 dogumtarihi-al.
    initialize dog-tar polisxml-rec
    open input polisxml
    move konuk-rez-no         to polisxml-rezno
    start polisxml key not < polisxml-anah invalid
          continue
    not invalid
    initialize fs-polisxml
    perform with test after until fs-polisxml = "10"
    read polisxml next no lock end exit perform 
    not at end 
         if polisxml-rezno = konuk-rez-no
            move polisxml-dog-yil    to dog-yil
            move polisxml-dog-ay     to dog-ay
            move polisxml-dog-gun    to dog-gun

         end-if
         exit perform

    end-read
    end-perform
    end-start

    close polisxml.

 
