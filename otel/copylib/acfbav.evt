* acfbav.evt
* acfbav.evt is generated from D:\asya\acugt.ytl\otel\acfbav.Psf
* This is a generated file. DO NOT modify this file directly.


 Form2-Exception-Proc.
     PERFORM Form2-Ex-Other
     .

 Form1-Event-Proc.
     PERFORM Form2-Gd-1-Ev-Other
     .

 Form2-Gd-1-Exception-Proc.
     PERFORM Form2-Gd-1-Ex-Other
     .
***   start event editor code   ***

*
 acc-ilk-yil-Aft-Procedure.
     initialize gec-gecme.
     open input takvim.
     move ilk-tarih   to takvim-anah
     read takvim no lock invalid
          move 1 to gec-gecme
     end-read
     close takvim.
*
 acc-son-yil-Aft-Procedure.
     initialize gec-gecme.
     open input takvim.
     move son-tarih   to takvim-anah
     read takvim no lock invalid
          move 1 to gec-gecme
     end-read
     close takvim.
     
     .
*
 acc-acenta-Aft-Procedure.
     initialize gec-gecme.
     if rapor-acenta = spaces
        move "Tum acentalar ..." to acenta-adi
        display lb-acenta-adi
        exit paragraph
     end-if
     open input acenta.
     move rapor-acenta to acenta-kodu                
     read acenta no lock invalid
          move "Tanimsiz ..." to acenta-adi
          move 1 to gec-gecme
     end-read
     close acenta.
     display lb-acenta-adi.


 raporla.
       open i-o genelfis.
       move 1 to genelfis-anahtar.
        read genelfis no lock invalid move 1 to ekran-fis-1.
        add 1 to ekran-fis-1.

        move ekran-fis-1 to tacenfat-no takasf-no.
      rewrite genelfis-rec invalid write genelfis-rec.
      close genelfis.
     move k-kodu-tasi to tacenfat-k
        open input acenfat
       
       
       open output tacenfat takasf close tacenfat takasf open i-o tacenfat takasf
     
     open input konuk konu2 acenta acebavel acesch
                musteri firma doviz cari konum hesayr kodlar02 rez .
     open i-o tlucky
     initialize acenfat-rec  oda-top
     move ilk-tarih   to acenfat-tarih
     start acenfat key not < acenfat-anah invalid 
                    initialize mesaj-link
                    move 04 to mesaj-no
                    perform mesaj-ver
                    not invalid
        perform with test after until fs-acenfat = "10"
         read acenfat next no lock end move "10" to fs-acenfat
            not at end


              if acenfat-tarih > son-tarih
                move "10" to fs-acenfat
                  exit perform
              end-if
     
             if rapor-acenta = spaces or 
                rapor-acenta = acenfat-acenta 
                      continue
             else 
                exit perform cycle
             end-if
             initialize acebavel-rec acesch-rec
             move acenfat-acenta      to acebavel-acenta-kodu  acesch-acenta-kodu
               if bav-tip(1:5) = "Bavel" then 
                  read acebavel no lock invalid
                          exit perform cycle
                  end-read 
                 if acebavel-client-id = spaces then 
                        exit perform cycle
                 end-if
                 else
                 read acesch no lock invalid
                          exit perform cycle
                  end-read 
                 if acesch-client-id = spaces then 
                        exit perform cycle
                 end-if

               end-if
             
               if acenfat-fat-no not > 0 then 
                  exit perform cycle
               end-if
              move acenfat-rec to tacenfat-rec
              write tacenfat-rec invalid stop " " end-write

              initialize takasf-rec 
              move acenfat-fat-no  to takasf-fat-no
              read takasf no lock invalid 
                   move acenfat-ger-dv-tutar to takasf-dov-tutar
                   write takasf-rec end-write 
              not invalid 
                  add acenfat-ger-dv-tutar to takasf-dov-tutar
                  rewrite takasf-rec end-rewrite 
              end-read
                
              if acebavel-kb-ekle = 1 or acebavel-kkp-ekle = 1
                 perform eklenecek-kayit-bul

                 initialize takasf-rec 
                 move acenfat-fat-no  to takasf-fat-no
                 read takasf no lock invalid 
                      continue 
                 not invalid                
                     compute takasf-dov-tutar = takasf-dov-tutar + l-basekle
                     rewrite takasf-rec end-rewrite 
                 end-read

              end-if

           end-read
        end-perform
     end-start.
     close rez  hesayr
    
     initialize fat-sira son-profil  oda-top
     initialize fat-sat
     initialize fs-acenfat toplamlar tacenfat-rec
     start tacenfat key not < tacenfat-fat-anah invalid 
                    continue
                    not invalid
     perform with test after until fs-tacenfat = "10"
         read tacenfat next no lock end move "10" to fs-tacenfat
         not at end
             if tacenfat-tarih > son-tarih
                move "10" to fs-tacenfat
                exit perform
             end-if
     
             if rapor-acenta = spaces or 
                rapor-acenta = tacenfat-acenta 
                      continue
             else 
                exit perform cycle
             end-if
               if tacenfat-fat-no not > 0 then 
                  exit perform cycle
               end-if
                initialize form2-gd-1-record
                move tacenfat-gun         to egun
                move tacenfat-ay          to eay
                move tacenfat-yil         to eyil
                 move tacenfat-acenta      to acenta-kodu 
*                move etarih              to gd-1-col-1
                read acenta no lock invalid
                     move "Tanimsiz acenta"  to acenta-adi
                end-read
               
                       
                move tacenfat-per-geceleme    to 3-hane
                move 3-hane              to gd-1-col-9
                move tacenfat-kfolio to konu2-folio
                read konu2 no lock invalid
                          initialize konu2-rec
                end-read
                move tacenfat-folio       to  konuk-folio
*                if acenfat-folio = 34630 
*                 | and k-kodu-tasi = "X   " 
*                  then stop " " end-if
                read konuk no lock invalid
                     initialize konuk-rec
                end-read
               
                string konu2-adi delimited by "  " 
                      " " delimited by size
                       konu2-soyadi  delimited by "  "
                         into gd-1-col-3
                if konuk-eb = "E" then
                   move " E/B"        to gd-1-col-3(12:)
                end-if     
                 initialize musteri-rec

*                move tACENFAT-PROFIL  to m-profil          |firat m-profil bos geliyordu 17/08/2020
                move tacenfat-p-sirket to musteri-sirket 
                move tacenfat-p-no     to musteri-no

                move konu2-odano       to gd-1-col-2
                if musteri-no not numeric
                      move "999999992" to musteri-no
                   end-if
                   read musteri no lock invalid
                   move konu2-acenta to acenta-kodu
                   read acenta no lock invalid
                      continue
                      not invalid
                            if ACENTA-MUHNO2 = spaces
                               move acenta-muhno to cari-kodu  musteri-muhasebe-kodu
                                else
                              move acenta-muhno2 to cari-kodu  musteri-muhasebe-kodu
                          end-if
                         read cari no lock invalid
                          initialize cari-rec
                        end-read,
                            perform varying ix from 1 by 1 until ix > 18
                               if c-vergi-no(ix:1) = spaces then 
                                   move  c-vergi-no(ix + 1 :) to c-vergi-no(ix :) 
                                   move  " "                  to c-vergi-no(20:1)
                               end-if
                          end-perform 
                      move c-unvan-1          to  musteri-unvan1(1:40)       
                     move  c-unvan-2         to  musteri-unvan2(1:40)       
                     move  c-adres-1         to  musteri-adres1 (1:40)      
                     move  c-adres-2         to  musteri-adres2 (1:40)      
                     move  c-il-ilce         to  musteri-ilce(1:20)         
                     move  c-ulke(1:14)      to  musteri-il(1:14)           
                     move  c-vergi-daire     to musteri-vdairesi (1:20)    
                     move  c-vergi-no          to musteri-vno
                               
                        
                        
                        
                        
                        
                        end-read
                        not invalid
                      move   musteri-vno    to  c-vergi-no    
                  end-read

                 move  musteri-unvan1 to gd-1-col-6 
                 move  musteri-muhasebe-kodu to gd-1-col-7
                  move tacenfat-acenta to acenta-kodu 
                read acenta no lock invalid
                     move "Tanimsiz acenta"  to acenta-adi
                end-read
                move acenta-kodu   to gd-1-col-1(1:4) 
                move "-" to   gd-1-col-1(5:1) 
                move acenta-adi          to gd-1-col-1(6:)
                initialize firma-rec
                move konuk-firma      to firma-kodu 
                read firma no lock invalid
                    continue
                end-read
                move firma-adi          to gd-1-col-4
                 if tacenfat-tip = "2" then 
                   move "ROOM" to  gd-1-col-8
                   else
                   move "EXTRA" to  gd-1-col-8
                 end-if
                 move konuk-doviz to doviz-kodu
                 read doviz no lock invalid continue
                 end-read
                 move d-kisa-adi to gd-1-col-11
                
                move tacenfat-tl-tutar    to z-8
                move z-8             to gd-1-col-13
                move tacenfat-ger-dv-tutar    to z-8
                move z-8         to gd-1-col-10
                move tacenfat-ger-tl-tutar  to z-8
                move z-8         to gd-1-col-12
                add 1 to oda-top
                add tacenfat-tl-tutar         to tl-top
                add tacenfat-ger-dv-tutar     to dv-top
                add tacenfat-ger-tl-tutar     to ger-tl-top



                 move tacenfat-fat-no to acenfat-fat-no

                 move tACENFAT-TARIH to ACENFAT-TARIH
                 perform tacenfat-ger-fat-bul
                 if e-m-fatura > spaces then 
                       move e-m-fatura        to gd-1-col-17
                 end-if


                 move tacenfat-fat-no     to gd-1-col-14
                 move konuk-gel-tar(7:2)  to gd-1-col-16(1:2)
                 move "-"                 to gd-1-col-16(3:1)  
                                             gd-1-col-16(9:1) 
                 move konuk-gel-tar(5:2)  to gd-1-col-16(4:2)
                 move konuk-git-tar(7:2)  to gd-1-col-16(7:2)
                 move konuk-git-tar(5:2)  to gd-1-col-16(10:2)
                 move tacenfat-geceleme   to zzz 
                 move zzz                 to gd-1-col-16(12:)
*********************************tlucky bas    

                 initialize tlucky-rec
                 move tacenfat-fat-no   to tlucky-fat-no
                 read tlucky no lock invalid
                      continue
                 end-read
                 move acenta-kodu           to tlucky-acenta
                 move konu2-odano           to tlucky-odano
                 move konu2-adi             to tlucky-mis-adi
                 move konu2-soyadi          to tlucky-mis-soyadi
                 move tacenfat-ger-dv-tutar to tlucky-bas-dov
                 move d-kisa-adi            to tlucky-dov-kod 
                 move tacenfat-tl-tutar     to tlucky-fat-tut
                 move konuk-gel-tar         to tlucky-gir-tar
                 move konuk-git-tar         to tlucky-cik-tar
               accept tlucky-fat-gon-tar  from century-date
                 move k-kodu-tasi           to tlucky-staff
                 write tlucky-rec invalid
                       rewrite tlucky-rec end-rewrite
                 end-write

                 modify form2-gd-1,
                        record-to-add(form2-gd-1-record)
                       
                 modify form2-gd-1(oda-top + 1, 2),
                        hidden-data = tacenfat-anah
                 modify form2-gd-1(oda-top + 1, 1),
                        hidden-data = 1    
               
                 modify form2-gd-1(oda-top + 1) row-color = 176
                 modify form2-gd-1(oda-top  + 1, 1),
                        bitmap = yes-bmp
                        bitmap-number = 1
                        bitmap-width = 16
                        bitmap-trailing = 0
               
        
         end-read
     end-perform
     end-start
     move 0 to lucky-bos
     close acenfat tlucky
*/*-*\**/*-*\**/*-*\**/*-*\**/*-*\**/*-*\**/*-*\*
     close acenta konuk acebavel  acesch konu2 musteri firma doviz cari tacenfat takasf konum kodlar02.

*
 Form2-Aft-Initdata.
    if ONKPARA-REFERANS-VAR = 1
        modify acc-acentaa, visible = false 
       continue
    end-if.

 grid-doldur.     
     initialize duz-yapildi
      modify form2-gd-1,
            reset-grid = 1 mass-update = 0 .
        initialize     form2-gd-1-record tlucky-rec
     move "FSira"               to gd-1-col-0
     move "Acenta/Rate"         to gd-1-col-1
     move "Oda "                to gd-1-col-2
     move "Mis. Adi"            to gd-1-col-3
     move "Sirket"              to gd-1-col-4
     move "Odem"                to gd-1-col-5
     move "Cari Adi"            to gd-1-col-6
     move "Cari Kodu"           to gd-1-col-7
     move "Tip"                 to gd-1-col-8
     move "Geceleme"            to gd-1-col-9 
     move "Bas Doviz"           to gd-1-col-10
     move "Doviz"               to gd-1-col-11
     move "Bas TL"              to gd-1-col-12
     move "Tutar   "            to gd-1-col-13
     move "Fat No"              to gd-1-col-14
     
     modify form2-gd-1,
            record-to-add(form2-gd-1-record).
     perform tlucky-dosya-olustur
     perform raporla
      modify form2-gd-1,
             mass-update = 0 .

*
 isaret-kaldir.
       modify  form2-gd-1(di,1) hidden-data = 0
                 modify form2-gd-1(di) row-color = 296
                     modify form2-gd-1(di, 1),
                       bitmap = spaces
                       bitmap-number = 1
                       bitmap-width = 16
                       bitmap-trailing = 0
                 .
 isaret-koy.
         modify  form2-gd-1(di,1) hidden-data = 1
                  modify form2-gd-1(di) row-color = 176
                     modify form2-gd-1(di, 1),
                       bitmap = yes-bmp
                       bitmap-number = 1
                       bitmap-width = 16
                       bitmap-trailing = 0
                 
         .
*
 Form2-Gd-1-Ev-Other.
     initialize acenfat-rec
              inquire form2-gd-1,
                      y in i
                      x in ii
     evaluate event-type

         when msg-begin-entry
           inquire form2-gd-1(i,1) hidden-data in hdata  
             inquire form2-gd-1(i,15) cell-data in satir-fat
                 move function numval(satir-fat) to isaret-fat
            if function numval(hdata) > 0 then 
                

              perform varying di from i  by 1 until di > oda-top  + 1
               inquire form2-gd-1(di,15) cell-data in satir-fat
                if  function numval(satir-fat) = isaret-fat
                 
                 perform isaret-kaldir
                 else
                 exit perform
               end-if
               end-perform 
               compute oncei = i - 1
               perform varying di from oncei  by -1 until di < 1
               inquire form2-gd-1(di,15) cell-data in satir-fat
                if  function numval(satir-fat) = isaret-fat
                 
                 perform isaret-kaldir
                 else
                 exit perform
               end-if
               end-perform 
              else
               perform varying di from i  by 1 until di > oda-top  + 1
               inquire form2-gd-1(di,15) cell-data in satir-fat
                if  function numval(satir-fat) = isaret-fat
                 
                 perform isaret-koy
                 else
                 exit perform
               end-if
               end-perform 
               compute oncei = i - 1
               perform varying di from oncei  by -1 until di < 1
               inquire form2-gd-1(di,15) cell-data in satir-fat
                if  function numval(satir-fat) = isaret-fat
                 
                 perform isaret-koy
                 else
                 exit perform
               end-if
               end-perform 



               

            end-if
          
           move event-action-fail to event-action        
            
     end-evaluate.

 
           .
*
 Form2-Gd-1-Ex-Other.
                  inquire form2-gd-1,
                      cursor-y in i
                      
                    inquire form2-gd-1(i,2),
                                 hidden-data in acenfat-anah
      evaluate key-status 
               when 3 
               when 2
                 perform Form2-Ex-Other
               WHEN 12 
               DiSPLAY MESSAGE BOX acenfat-anah
                 when 6
                 
                
                   if acenfat-folio > 0 then 
                    call "/asya/ytl/obj/otel/folio.asy" 
                    using  acenfat-folio
                    on exception 
                     perform callerr-proc
                     exit paragraph
                    not on exception 
                     cancel "/asya/ytl/obj/otel/folio.asy"
                  end-call
                    end-if
              when 11
                   if acenfat-kfolio > 0 then 
                    call "/asya/ytl/obj/otel/kfolio.asy" 
                    using  acenfat-kfolio
                    on exception 
                     perform callerr-proc
                     exit paragraph
                    not on exception 
                     cancel "/asya/ytl/obj/otel/kfolio.asy"
                  end-call
                    end-if
              when 18
                   if acenfat-kfolio > 0 then 
                     move acenfat-kfolio to konuk-folio
                     open input konuk
                     read konuk no lock invalid continue
                        not invalid
                          if konuk-rez-no > 0 then 
                        call "/asya/ytl/obj/otel/rez.asy" 
                          using  konuk-rez-no
                        on exception 
                              perform callerr-proc
                             exit paragraph
                          not on exception 
                        cancel "/asya/ytl/obj/otel/rez.asy"
                        end-call
                        end-if
                      end-read
                      close konuk
                    end-if
               when 16
                   if acenfat-kfolio > 0 then 
                     move acenfat-kfolio to konuk-folio
                     open input konuk
                     read konuk no lock invalid continue
                        not invalid
                          if konuk-rez-no > 0 then 
                        call "/asya/ytl/obj/otel/profat.asy" 
                          using   konuk-folio   konuk-rez-no
                        on exception 
                              perform callerr-proc
                             exit paragraph
                          not on exception 
                        cancel "/asya/ytl/obj/otel/profat.asy"
                        end-call
                        end-if
                      end-read
                      close konuk
                    end-if
            end-evaluate
     .
*
 Form2-Bef-Create.
    initialize lucky-bos
    perform adresleri-tasi.
    open input genel
    move 1 to genel-anahtar
    read genel no lock invalid continue
         not invalid continue
    end-read
    close genel.



    move genel-printer-filtre to text-oku-filtre.
    perform acuserve-adres-aktar.
    open i-o acesch close acesch.
     move tarih-tasi  to ilk-tarih son-tarih.
     move 01 to ilk-gun son-gun.
*
 Form2-Aft-Routine.
     perform tlucky-data-bas
     exit paragraph .

 
 acenta-ara.
      initialize acenta-cagir.
      call "/asya/ytl/obj/otel/acenara.asy" using acenta-cagir
            on exception perform callerr-proc
               not on exception
               cancel "/asya/ytl/obj/otel/acenara.asy" 
       end-call.
       move acenta-cagir     to rapor-acenta.
       display  acc-acenta.
 acenta-oku.
       initialize gec-gecme.
       move "Tum Acentalar"      to adi-goster
       display lb-acenta-adi.
       if rapor-acenta not = spaces
          open input acenta
          initialize acenta-rec
          move rapor-acenta   to acenta-kodu
          read acenta        no lock invalid 
               move 1        to gec-gecme
               display message box "Acenta Kodu Tanimsiz.."
               move 4    to accept-control
               move 12 to control-id
               not invalid continue 
          end-read
          close acenta
          move acenta-adi     to adi-goster
          display lb-acenta-adi
       end-if.



     .
*
 Form2-Ex-Other. 
    evaluate key-status
      when 1
    
           perform acenta-ara  

      when 1313
           evaluate cb-gonderilmeyen
               when 1
                    perform gonderilmeyen-raporla-lucky
               when 0
                    perform gonerilen-raporla-lucky      |||  lucky 5/7/2018
           end-evaluate
      when 2002
             if bav-sir = spaces
                display message box "Sirket Kodu Bos Gecilemez.."
                                title "Uyari"
                                icon 1
                  exit paragraph 
             end-if 
             perform acc-ilk-yil-Aft-Procedure
             if gec-gecme = 1
                move 4 to accept-control
                move 6 to control-id
                exit paragraph
             end-if
     
             perform acc-son-yil-Aft-Procedure
             if gec-gecme = 1
                move 4 to accept-control
                move 9 to control-id
                exit paragraph
             end-if

             perform acc-acenta-Aft-Procedure
             if gec-gecme = 1 
                move 4 to accept-control
                move 12 to control-id
                exit paragraph
             end-if
             call "/asya/ytl/obj/otel/fatolus.asy" 
                    using  ilk-tarih  son-tarih
                         on exception 
                     perform callerr-proc
                     exit paragraph
                    not on exception 
                     cancel "/asya/ytl/obj/otel/fatolus.asy"
                  end-call
    
                
            perform grid-doldur


         when 3
           perform csv-olustur
         when 2
           perform xml-olustur

      end-evaluate
     .

*
 gonerilen-raporla-lucky.

     open i-o genelfis gidenbav
     move 1 to genelfis-anahtar
     read genelfis no lock invalid
          accept print-no from time
     not invalid
          add 1 to print-no
          rewrite genelfis-rec end-rewrite
     end-read
     close genelfis
**************************
     initialize dokumer-rec dokumer-anah dokumer-ozellikler-rec
                dokumer-dosya

     set  dokumer-asya-set to true
     move print-no         to dokumer-dosya-adi
     open output dokumer
*/WINDOW TITLE
     initialize dokumer-rec detay
     move "W"                  to det-dokumer-20(1:)
     move "Bavel Gonderilenler Raporu" to det-filler
     write dokumer-rec from detay
*/ BASLIKLAR
     initialize dokumer-rec detay
     move "1"          to det-dokumer-20(10:1)
     move "B"                  to det-dokumer-20(1:1)
     move "Bavel Gonderilenler Raporu" to det-filler
     write dokumer-rec from detay

     initialize dokumer-rec detay
     move "B"                  to det-dokumer-20(1:1)
     write dokumer-rec from detay

*/ DOKUMER OZELLIKLER-REC
     initialize dokumer-rec detay
     move "O" to det-dokumer-20(1:)
     move "E" to dokumer-oto-sayfa-basi
     move 56  to dokumer-oto-sayfa-satir
     move "|" to dokumer-detay-kolon-ayirici
     move "RRRLLRRRRRRLLRRR" to dokumer-align-occ
     move dokumer-ozellikler-rec     to det-filler
     write dokumer-rec from detay
*/ BASLIKLAR  

     initialize dokumer-rec detay 
     move "1"                           to det-dokumer-20(10:1)
     move "D1"                          to det-dokumer-20(1:2)     
     move "Faruta No"                   to det-1
     move "Acenta"                      to det-2
     move "Durumu"                      to det-3 
     move "Oda No"                      to det-4 
     move "Misafir Adi"                 to det-5 
     move "Misafir Soyadi"              to det-6 
     move "Basilan Tutar"               to det-7 
     move "Doviz Kodu"                  to det-8 
     move "Fatura Tutar"                to det-9  
     move "Giris Tarihi"                to det-10
     move "Cikis Tarihi"                to det-11
     move "Islem Tarihi"                to det-12
     move "Staff"                       to det-13

     move "|" to fil-1 fil-2 fil-3 fil-4 fil-5
                 fil-6 fil-7 fil-8 fil-9 fil-10 
                 fil-11 fil-12 fil-13  
     write dokumer-rec from detay
                                                           
     initialize dokumer-rec detay
     move "D2"           to det-dokumer-20(1:2)
     move "-"            to det-dokumer-20(5:1)
     move all "-" to det-1 det-2 det-3 det-4 det-5 
                     det-6 det-7 det-8 det-9 det-10 
                     det-11 det-12 det-13
     write dokumer-rec from detay
**************************              
              perform tarih-duzenle
              initialize fs-gidenbav xiii-sira
              perform with test after until fs-gidenbav = "10"
                    read gidenbav next no lock end move "10" to fs-gidenbav
                    not at end
                           |if gidenbav-cik-tar < xtar or
                           |   gidenbav-cik-tar > ytar
                           |   exit perform cycle
                           |end-if

                            if not (gidenbav-cik-tar >= ilk-tarih and gidenbav-cik-tar <= son-tarih)
                              exit perform cycle
                           end-if

                           initialize dokumer-rec detay           |17/10/2017 lckxiii
                           move gidenbav-fat-no      to det-1
                           move gidenbav-acenta      to det-2
                           evaluate gidenbav-durumu
                               when "C"
                                    move "CSV Gonderim"      to det-3 
                               when "X"
                                    move "XML Gonderim"      to det-3 
                               when "I"
                                    move "Gonderim Iptal"    to det-3 
                           end-evaluate
                           move gidenbav-odano            to z-oda
                           move z-oda                     to det-4
                           move gidenbav-Adi              to det-5
                           move gidenbav-soyadi           to det-6
                           move gidenbav-bas-dov          to z-tutar
                           move z-tutar                   to det-7
                           move gidenbav-dov-kod          to det-8
                           move gidenbav-fat-tut          to z-tutar
                           move z-tutar                   to det-9
                           move gidenbav-gir-tar(1:4)     to det-10(7:4)
                           move gidenbav-gir-tar(5:2)     to det-10(4:2)
                           move gidenbav-gir-tar(7:2)     to det-10(1:2)
                           move gidenbav-cik-tar(1:4)     to det-11(7:4)
                           move gidenbav-cik-tar(5:2)     to det-11(4:2)
                           move gidenbav-cik-tar(7:2)     to det-11(1:2)
                           move gidenbav-fat-gon-tar(1:4) to det-12(7:4)
                           move gidenbav-fat-gon-tar(5:2) to det-12(4:2)
                           move gidenbav-fat-gon-tar(7:2) to det-12(1:2)
                           move "/" to det-10(3:1)
                                       det-10(6:1)
                                       det-11(3:1)
                                       det-11(6:1)
                                       det-12(3:1)
                                       det-12(6:1)
                           move gidenbav-staff            to det-13
                           move "|" to fil-1 fil-2 fil-3 fil-4 fil-5 
                                       fil-6 fil-7 fil-8 fil-9 fil-10
                                       fil-11 fil-12 fil-13                
                           write dokumer-rec from detay
                           add 1 to xiii-sira

                    end-read
              end-perform
              initialize dokumer-rec detay
              move "Toplam :" to det-1
              move xiii-sira  to det-2
              write dokumer-rec from detay
              
              close dokumer
              call dokumer-prog on exception
                   perform callerr-proc
              not on exception
                   cancel dokumer-prog
              end-call
              close gidenbav
              delete file dokumer
*    end-evaluate    
    .
*
 tarih-duzenle.
     open input takvim
     move ilk-tarih to xtar
     move function integer-of-date(xtar) to xtar
     add 1 to xtar
     move function date-of-integer(xtar) to xtar
     initialize takvim-rec
     move xtar to takvim-anah 
     read takvim no lock invalid
          if xiii = 1 stop " " end-if
     end-read
     move son-tarih to ytar
     move function integer-of-date(ytar) to ytar
     add 1 to ytar
     move function date-of-integer(ytar) to ytar
     initialize takvim-rec
     move ytar to takvim-anah 
     read takvim no lock invalid
          if xiii = 1 stop " " end-if
     end-read
     close takvim
      .
*
 Form1-Aft-Initdata.
*/-----------------------------\*  
*/---------DIL AYARLA----------\*    
*/-----------------------------\*    
     perform dil-ayarla-proc.
*/-----------------------------\*         

        
         .





*
 acuserve-adres-aktar.
    move muha-sirketi of genel-rec to CARI-DOSYA-adres  
                         efat2onb-dosya-adres   
                         ISLENEN-DOSYA-adres      
                         HESAP-DOSYA-adres        
                         MAHSUP-DOSYA-adres       
                          
                         REFERANS-DOSYA-adres     
                         Mgenel-DOSYA-adres       
                        
                       
                

    move all low-values to      
                           CARI-ACUSERVE-DOSYA
                           efat2onb-acuserve-dosya
                           ISLENEN-ACUSERVE-DOSYA    
                           HESAP-ACUSERVE-DOSYA      
                           MAHSUP-ACUSERVE-DOSYA     
                           genelfis-ACUSERVE-DOSYA   
                           REFERANS-ACUSERVE-DOSYA   
                           Mgenel-ACUSERVE-DOSYA     
                           genelfis-ACUSERVE-DOSYA  
                           ip-no.


    inspect genel-muha-uzak-ip 
            replacing trailing spaces by low-values.

    if genel-muha-uzak-ip <> low-values
       move all low-values to ip-no
       string ip-no,
              "@" delimited by low-values
              genel-muha-uzak-ip delimited by low-values
              ":" delimited by low-values
              into ip-no
    end-if

    string mgenel-acuserve-dosya,
           ip-no                        delimited by low-values
           mgenel-dosya                    delimited by low-values
           into mgenel-acuserve-dosya.
    string genelfis-acuserve-dosya,
           ip-no                        delimited by low-values
           genelfis-dosya                 delimited by low-values
           into genelfis-acuserve-dosya.

    
    string hesap-acuserve-dosya,
           ip-no                        delimited by low-values
           hesap-dosya                  delimited by low-values
           into hesap-acuserve-dosya.
    string mahsup-acuserve-dosya,
           ip-no                        delimited by low-values
           mahsup-dosya                 delimited by low-values
           into mahsup-acuserve-dosya.
    string cari-acuserve-dosya,
           ip-no                        delimited by low-values
           cari-dosya                   delimited by low-values
           into cari-acuserve-dosya.
    string islenen-acuserve-dosya,
           ip-no                         delimited by low-values
           islenen-dosya                 delimited by low-values
           into islenen-acuserve-dosya.
    string referans-acuserve-dosya,
           ip-no                         delimited by low-values
           referans-dosya                delimited by low-values
           into referans-acuserve-dosya.

     string efat2onb-acuserve-dosya,
           ip-no                        delimited by low-values
           efat2onb-dosya                delimited by low-values
           into efat2onb-acuserve-dosya.
       

    inspect CARI-ACUSERVE-DOSYA        replacing  all spaces by low-values
    inspect efat2onb-acuserve-dosya    replacing  all spaces by low-values
     
    inspect ISLENEN-ACUSERVE-DOSYA     replacing  all spaces by low-values
    inspect HESAP-ACUSERVE-DOSYA       replacing  all spaces by low-values
    inspect MAHSUP-ACUSERVE-DOSYA      replacing  all spaces by low-values
    inspect genelfis-ACUSERVE-DOSYA    replacing  all spaces by low-values
    inspect REFERANS-ACUSERVE-DOSYA    replacing  all spaces by low-values
    inspect mgenel-ACUSERVE-DOSYA      replacing  all spaces by low-values
    inspect genelfis-ACUSERVE-DOSYA    replacing  all spaces by low-values.



    .
****
*
*
*
 xml-olustur.   
         open input acenfat kodlar02 konuk rez konum cast 
            hesayr  takvim doviz acenta   bavelsir acebavel acesch fatura 
        initialize son-fat   fat-adet gidecekler 
         
          initialize  acebavel-rec 

 
            perform varying i from 1 by 1 until i > oda-top  + 1
               inquire form2-gd-1(i,1) hidden-data in hdata  
                inquire form2-gd-1(i,15) cell-data in satir-fat
                 move function numval(satir-fat) to isaret-fat
                 if function numval(hdata) > 0 then 
                    inquire form2-gd-1(i,1) hidden-data in hdata  
                    inquire form2-gd-1(i,2) hidden-data in acenfat-anah
                    read acenfat no lock invalid 
                      stop " "
                    end-read
                    initialize extrami
                     inquire form2-gd-1(i,9) CELL-data in EXTRAMI
                    | display message box extrami
                    initialize fatura-rec
                    move acenfat-fat-no           to fatura-no
                    move 0                        to fatura-sira
                    read fatura no lock invalid
                    display message box "fatura bulunamadi HATA !"
                          icon 3
                    end-read

                    move acenfat-kfolio to konuk-folio
                    read konuk no lock invalid stop " "
                    end-read
                     move konuk-fiyat-konumu to konum-anahtar 
                    read konum no lock invalid continue
                    end-read

                    move konuk-rez-no to rez-anah
                    move konuk-doviz to doviz-kodu
                    read doviz no lock invalid continue
                    end-read

                    read rez no lock invalid 
                      move konuk-acenta to rez-acenta 
                      move konum-adi  to rez-adi
                      move konuk-soyadi to rez-soyadi
                      move konuk-oda-konumu to rez-oda-konumu
                      move konuk-fiyat-konumu to rez-fiyat-konumu,
                      move konuk-voucher to rez-voucher
                    end-read
                    move rez-acenta to acenta-kodu 
                    read acenta no lock invalid stop " "
                    end-read
*/*********************************************************************
                    if onkpara-referans-var not = 1
                       initialize bavelsir-rec
                       move bav-sir          to bavelsir-sirket-kodu
                       if bavelsir-sirket-kodu not > "00" then 
                           move "01"         to bavelsir-sirket-kodu
                       end-if
                       read bavelsir no lock invalid 
                              continue 
                       end-read
                    else  
*/***********************referanslý olupta tek þirket kullanan oteller ve id leri farklý oteller için ramazan              
                       initialize kodlar02-rec okunamadi
                       move "r"                            to kodlar02-tipi
                       move "0"                            to kodlar02-kodu(1:1)
                       move konum-ref                      to kodlar02-kodu(2:1)                 
                       read kodlar02 no lock invalid                            
                           move 1        to okunamadi
                       end-read 
                       if okunamadi not = 1
                          initialize bavelsir-rec
                          move kodlar02-bavel-kodu         to bavelsir-sirket-kodu
                          read bavelsir no lock invalid 
                               continue 
                          end-read
                       else
                          initialize bavelsir-rec
                          move "01"                        to bavelsir-sirket-kodu
                          read bavelsir no lock invalid 
                               continue 
                          end-read                          
                       end-if 
                    end-if 
*/*/*******************************************************************
                    if isaret-fat  = son-fat
                       perform line-at 
                    else
                       if son-fat > 0 
                          perform fat-KAPAT
                       end-if
                        move isaret-fat to son-fat
                        PERFORM  FAT-AC
                        PERFORM line-AT
                    end-if
                    modify form2-gd-1(i) row-color = 156
                 end-if                 
            end-perform .
            perform tlucky-data-bas                                             | 5/7/2018 xiiilucky  (firatt)
          close acenfat  kodlar02 konuk rez doviz takvim 
                cast hesayr  acenta konum   bavelsir acebavel acesch fatura 
            if son-fat > 0 then 
              perform fat-kapat
            end-if
            move fat-adet to z-adet
            string "Asagidaki " delimited by size 
                    z-adet    delimited by size
                    " dosya olusturudu " delimited by size 
                   new-line delimited by size
                     new-line delimited by size
                    gidecekler delimited by   "    "
                    
                       new-line delimited by size
                       into gidecekler


            display message box gidecekler
            .
*
 fat-kapat.
       
           perform line-items-kapa
***          perform payment-terms-ac
****              perform term-ac-kapa
******          perform payment-terms-kapa
          perform total-summary-ac-kapa
          perform invoice-kapat
          close xml-DOSYA
          perform xml-kopyala.
         .
*
 xml-kopyala.
          string
              "@[DISPLAY]:" delimited by size
             genel-bavel-adres delimited by "\ "              
              "\"  delimited by size
              xml-dosya-adi into gidecek-adres
            end-string

            if os-is-unix then
               CALL "C$COPY" using xml-dosya-adres, 
               gidecek-adres giving sonuccopy
      
               if sonuccopy = 1 then 
                  
                  display message box 
                  "Dosya kopyalanamadi", NEW-LINE 
                  xml-dosya-adres,  NEW-LINE, gidecek-adres
               else
                  add 1 to fat-adet
                  string  gidecekler delimited by   "    "
                       gidecek-adres(12:) delimited by "    "
                       new-line delimited by size
                       into gidecekler
                  
           
               end-if
             else
                call "c$copy" using xml-dosya-adres,gidecek-adres

            end-if.



       
* *
 fat-ac.
     initialize f-deg acebavel-rec acesch-rec

     move acenta-kodu      to acebavel-acenta-kodu  
                              acesch-acenta-kodu

     if bav-tip(1:5) = "Bavel" then 
        read acebavel no lock invalid
           continue 
        end-read
     else
        read acesch no lock invalid
           continue 
        end-read
     end-if
          

     move isaret-fat        to xml-dosya-adres-fat-no 
     move isyeri-adres-tasi to xml-dosya-sirket
     move tarih-tasi        to xml-tarih

     open output xml-DOSYA 
     perform ilk-satir-ac
     perform invoice-ac
     perform header-ac-kapa
     perform suplier-ac-kapa
     perform client-ac-kapa
     perform remarks-ac
     perform remarks-body
     perform remarks-kapa
     perform line-items-ac
     
       .
*
 line-at.
        initialize l-bastar l-bittar l-bastut l-adi  line-deg   hes-acik
        move "999999999" to l-bastar
        string rez-soyadi delimited by "   " 
                ", " delimited by size
                rez-adi delimited by "   "
                into l-adi

        
      
        initialize hesayr-rec l-basekle
        move rez-no to hesayr-rez-no
        start hesayr key > hesayr-anah


            invalid continue
            not invalid
              perform until fs-hesayr = "10"
                   read hesayr next no lock  
                      end move "10" to fs-hesayr
                      not end
                        if hesayr-rez-no not = rez-no 
                           move "10" to fs-hesayr
                           exit perform cycle
                        end-if
                        if hesayr-per - 1 = acenfat-peryod
                           add 1 to l-gece
                           if l-bastar > hesayr-tarih 
                             move hesayr-tarih to l-bastar
                           end-if
                            if l-bittar < hesayr-tarih 
                             move hesayr-tarih to l-bittar
                           end-if
                            add hesayr-basilacak-tut   to l-bastut
                            if acebavel-kb-ekle = 1 
                               add hesayr-kb-tut       to l-basekle
                            end-if
                            if acebavel-kkp-ekle = 1 
                               add hesayr-kkp-tut      to l-basekle
                            end-if
 
                        end-if
                   end-read
              end-perform
         end-start 
 
         
        if l-bastut not = acenfat-GER-DV-TUTAR
*           display message box rez-no "    " acenfat-fat-no
               continue
        end-if  .
        move l-bastar(1:4) to tar1yil
        move l-bastar(5:2) to tar1ay
        move l-bastar(7:2) to tar1gun
        initialize takvim-rec
        move l-bittar   to takvim-anah
        start takvim key > takvim-anah invalid 
             continue
        not invalid
        read takvim next no lock end continue
        not at end 
              move takvim-anah  to l-bittar
              
        end-read
        end-start
        move l-bittar(1:4) to tar2yil
        move l-bittar(5:2) to tar2ay
        move l-bittar(7:2) to tar2gun
        
         if acebavel-pp3-ekle = 1  and extrami(1:3) not = "EXT"
           
           compute l-bastut = l-bastut + ((rez-buyuk + rez-kucuk + rez-free) * 3 * l-gece)
         end-if

        compute bavel-toplam rounded =
                acenfat-GER-DV-TUTAR + (l-basekle / 1)
          if acebavel-pp3-ekle = 1   and extrami(1:3) not = "EXT"
           compute bavel-toplam rounded =
                acenfat-GER-DV-TUTAR + (l-basekle / 1)   + ((rez-buyuk + rez-kucuk + rez-free) * 3 * l-gece)
         end-if
        move   bavel-toplam to l-bastut

***        compute l-kdvsiz rounded =  bavel-toplam / 1.08
        compute l-kdvsiz rounded =  bavel-toplam / ((100 + acenfat-kdv) / 100)
        compute l-kdv = bavel-toplam - l-kdvsiz

        add  l-bastut to f-bastut
        add  l-kdvsiz to f-kdvsiz
        add l-kdv to f-kdv.

       

*            move rez-no to bavfat-rez  
*           move  bavfat-fat-no 
*           
*            move suan-zaman  to  bavfat-gon-zaman
*            read bavfat no lock invalid continue
*            end-read
*            add f-bastut to  bavfat-dv-tut
          
           

        compute l-gunluk rounded = l-bastut / l-gece
        perform items-ac
*        perform line-discount-ac 
*        perform line-discount
*        perform line-discount-kapa
        perform line-taxes-ac
        perform tax-ac-kapa
        perform line-taxes-kapa
        perform service-data-ac
        perform service-ac-kapa
        perform service-data-kapa
        perform items-kapa
            .


     .
*
 ilk-satir-ac.
     initialize xml-DOSYA-REC
     move ilksatir        to xml-dosya-rec
     perform apo-kobra write xml-dosya-rec end-write .
*
 remarks-ac.
     initialize xml-DOSYA-REC
     string xml-dosya-rec delimited by spaces
            "<Remarks>" delimited by size 
     into xml-dosya-rec

     perform apo-kobra write xml-dosya-rec end-write 
     .
*
 items-ac.
     initialize xml-DOSYA-REC
     move l-gece to z-tam
     move l-gunluk to z-para
     move l-bastut to z-para2
     move l-bastut to z-para3
     inspect z-para3 replacing all "," by "."
     inspect z-para2 replacing all "," by "."
     inspect z-para  replacing all "," by "."
     if acenta-bavel-no = 1 then
        move rez-bavel to yastik-voucher 
     else
        move konuk-voucher to yastik-voucher 
     end-if
     string xml-dosya-rec delimited by spaces
            "<Item ClientBookingRef=" delimited by size
            tirnak delimited by size 
            yastik-voucher delimited by "   "
           
            tirnak delimited by size 
            " SupplierBookingRef=" delimited by size 
            tirnak delimited by size 
            rez-no delimited by size
            tirnak delimited by size
            " Description=" delimited by size
            tirnak delimited by size 
            "Accomodation" delimited by size 
            tirnak delimited by size 
            " Quantity=" delimited by size 
            tirnak delimited by size 
            z-tam delimited by size 
            tirnak delimited by size 
            " UnitPrice=" delimited by size 
            tirnak delimited by size 
            z-para delimited by size 
            tirnak delimited by size 
            " GrossTotal=" delimited by size 
            tirnak delimited by size 
            z-para2 delimited by size 
            tirnak delimited by size 
            " LineTotal="delimited by size
            tirnak delimited by size 
            z-para3 delimited by size 
            tirnak delimited by size
            ">" delimited by spaces 
     into xml-dosya-rec

     perform apo-kobra write xml-dosya-rec end-write
     .
*
 line-discount-ac.
     initialize xml-DOSYA-REC
     string xml-dosya-rec delimited by spaces
            "<LineDiscounts>" delimited by size 
     into xml-dosya-rec

     perform apo-kobra write xml-dosya-rec end-write
     .     
*
 line-discount.
     initialize xml-DOSYA-REC
     string xml-dosya-rec delimited by spaces
            "<Discount Type=" delimited by size
            tirnak delimited by size 
            "EarlyPayment" delimited by size 
            tirnak delimited by size 
            " Rate=" delimited by size
            tirnak delimited by size 
            "10"   delimited by size 
            tirnak delimited by size 
            " Amount=" delimited by size 
            tirnak delimited by size
            "15" delimited by size 
            tirnak delimited by size
            "/>" delimited by size 
     into xml-dosya-rec

     perform apo-kobra write xml-dosya-rec end-write
     
     .


*
 line-discount-kapa.
     initialize xml-DOSYA-REC
     string xml-dosya-rec delimited by spaces
            "</LineDiscounts>" delimited by size 
     into xml-dosya-rec

     perform apo-kobra write xml-dosya-rec end-write
     .     
      .
*
 line-taxes-ac.
     initialize xml-DOSYA-REC
     string xml-dosya-rec delimited by spaces
            "<LineTaxes>" delimited by size 
     into xml-dosya-rec

     perform apo-kobra write xml-dosya-rec end-write
     . 
*
 tax-ac-kapa.
      move l-kdvsiz to z-para
      move l-kdv   to z-para2
      initialize kdv-text
*     if acenfat-kdv = 1 
*         move "1.00" to kdv-text
*     else
*         move "8.00" to kdv-text      
*     end-if
      initialize kdv-text  kdv-textz
              move   acenfat-kdv to kdv-textz
              move  kdv-textz to kdv-text
     inspect z-para2 replacing all "," by "."
     inspect z-para replacing all "," by "."
   
     initialize xml-DOSYA-REC
     string xml-dosya-rec delimited by spaces
            "<Tax Type=" delimited by size 
            tirnak delimited by size 
            "VAT" delimited by size 
            tirnak delimited by size 
            " TaxableAmount=" delimited by size 
            tirnak delimited by size 
            z-para delimited by size 
            tirnak delimited by size 
            " Rate=" delimited by size 
            tirnak delimited by size 
**            "8.00" delimited by size 
            kdv-text delimited by size
            tirnak delimited by size 
            " Amount=" delimited by size 
            tirnak delimited by size 
            z-para2 delimited by size
            tirnak delimited by size 
            " />" delimited by size 
     into xml-dosya-rec

     perform apo-kobra write xml-dosya-rec end-write
     .     

*
 line-taxes-kapa.
     initialize xml-DOSYA-REC
     string xml-dosya-rec delimited by spaces
            "</LineTaxes>" delimited by size 
     into xml-dosya-rec

     perform apo-kobra write xml-dosya-rec end-write.
*
 service-data-ac.
     initialize xml-DOSYA-REC
     string xml-dosya-rec delimited by spaces
            "<ServicesData>" delimited by size 
     into xml-dosya-rec

     perform apo-kobra write xml-dosya-rec end-write
     .     
*
 service-ac-kapa.
     initialize xml-DOSYA-REC
     move konuk-buyuk to z-tam
     move konuk-kucuk to z-tam2
     compute l-paxtop =  konuk-buyuk + konuk-kucuk + konuk-free + konuk-bebek
     move l-paxtop to z-tam3
     string xml-dosya-rec delimited by spaces
            "<Service ClientAgentID=" delimited by size 
            tirnak delimited by size
            "xxx" delimited by size 
            tirnak delimited by size
            " PaxLeader=" delimited by size 
            tirnak delimited by size 
            l-adi delimited by "    "
            tirnak delimited by size 
            " PaxNumber=" delimited by size 
            tirnak delimited by size 
            z-tam3 delimited by size 
            tirnak delimited by size 
            " AdultsNumber=" delimited by size 
            tirnak delimited by size 
            z-tam delimited by size 
            tirnak delimited by size
            " KidsNumber=" delimited by size 
            tirnak delimited by size 
            z-tam2 delimited by size 
            tirnak delimited by size
            " BeginDate=" delimited by size
            tirnak delimited by size 
            tar1 delimited by size 
            tirnak delimited by size
            " EndDate=" delimited by size 
            tirnak delimited by size 
            tar2 delimited by size
            tirnak delimited by size 
            " RoomCategory=" delimited by size 
            tirnak delimited by size 
            KONUM-ADI delimited by "   "
            tirnak delimited by size 
            " />" delimited by size 
     into xml-dosya-rec

     perform apo-kobra write xml-dosya-rec end-write.
*
 service-data-kapa.
     initialize xml-DOSYA-REC
     string xml-dosya-rec delimited by spaces
            "</ServicesData>" delimited by size 
     into xml-dosya-rec

     perform apo-kobra write xml-dosya-rec end-write
     .    
     .
*
 items-kapa.
     initialize xml-DOSYA-REC
     string xml-dosya-rec delimited by spaces
            "</Item>" delimited by size 
     into xml-dosya-rec

     perform apo-kobra write xml-dosya-rec end-write
     . 
*
 apo-kobra.
*****
   
     
     initialize convert-from convert-to
     move xml-dosya-rec            to convert-from

*     &#304;&#305;&#214;&#246;&#220;&#252;&#199;&#231;&#286;&#287;&#350;&#351;
*     UTF-8 DONUSUM TABLOSU
*  
*Harf: Istanbul (BUYUK)    Numerik Kodu: &#304;
*Harf: irak (KUCUK)        Numerik Kodu: &#305;
*Harf: Omur (BUYUK)        Numerik Kodu: &#214;
*Harf: omur (KUCUK)        Numerik Kodu: &#246;
*Harf: Urdun (BUYUK)       Numerik Kodu: &#220;
*Harf: urdun (KUCUK)       Numerik Kodu: &#252;
*Harf: Canakkale (BUYUK)   Numerik Kodu: &#199;
*Harf: Canakkale (KUCUK)   Numerik Kodu: &#231;
*Harf: G yimisah g (BUYUK) Numerik Kodu: &#286;
*Harf: g yimisah g (KUCUK) Numerik Kodu: &#287;
*Harf: Sanliurfa (BUYUK)   Numerik Kodu: &#350;
*Harf: sanliurfa (KUCUK)   Numerik Kodu: &#351;

     move 1 to convert-ii
     perform varying convert-i
             from 1
             by 1
             until convert-i > 3000

             evaluate convert-from(convert-i:1)
*/Buyuk Sanliurfa
              when x"9E"
                   move "&#350;" to convert-to(convert-ii:)
                   add 6 to convert-ii
*/Buyuk Yimisah G
              when x"A6"
                   move "&#286;" to convert-to(convert-ii:) 
                   add 6 to convert-ii
*/Buyuk Istanbul
              when x"98"
                   move "&#304;" to convert-to(convert-ii:) 
                   add 6 to convert-ii
*/Buyuk Omur
              when x"99"
                   move "&#214;" to convert-to(convert-ii:) 
                   add 6 to convert-ii
*/Buyuk Urdun
              when x"9A"
                   move "&#220;" to  convert-to(convert-ii:) 
                   add 6 to convert-ii
*/Buyuk Canakkale
              when x"80"
                   move "&#199;" to  convert-to(convert-ii:) 
                   add 6 to convert-ii
*/Kucuk yimisah g
              when x"A7"
                   move "&#287;" to  convert-to(convert-ii:) 
                   add 6 to convert-ii
*/Kucuk i
              when x"8D"
                   move "&#305;" to  convert-to(convert-ii:) 
                   add 6 to convert-ii
*/Kucuk urdun
              when x"81"            
                   move "&#252;" to  convert-to(convert-ii:) 
                   add 6 to convert-ii
*/Kucuk ömür
              when x"94"            
                   move "&#246;" to  convert-to(convert-ii:) 
                   add 6 to convert-ii
*/Kucuk canakkala
              when x"87"
                   move "&#231;" to  convert-to(convert-ii:) 
                   add 6 to convert-ii
*/Kucuk sanliurfa
              when x"9F"
                   move "&#351;" to  convert-to(convert-ii:) 
                   add 6 to convert-ii
*/& amperstand
              when x"26"
                   move "&amp;" to  convert-to(convert-ii:) 
                   add 5 to convert-ii
              when other | ozel karakter haric
                   move convert-from(convert-i:1)     to convert-to(convert-ii:1)
                   add 1 to convert-ii
          end-evaluate
       end-perform.

       move convert-to                                to xml-dosya-rec.


 

 
 
      .
*
 line-items-ac.
     initialize xml-DOSYA-REC
     string xml-dosya-rec delimited by spaces
            "<LineItems>" delimited by size 
     into xml-dosya-rec

     perform apo-kobra write xml-dosya-rec end-write
     .
*
 line-items-kapa.
     initialize xml-DOSYA-REC
     string xml-dosya-rec delimited by spaces
            "</LineItems>" delimited by size 
     into xml-dosya-rec

     perform apo-kobra write xml-dosya-rec end-write
     .
*
 payment-terms-ac.
     initialize xml-DOSYA-REC
     string xml-dosya-rec delimited by spaces
            "<PaymentTerms>" delimited by size 
     into xml-dosya-rec

     perform apo-kobra write xml-dosya-rec end-write 
     .
*
 term-ac-kapa.
     initialize xml-DOSYA-REC
     string xml-dosya-rec delimited by spaces
            "<Term DueDate=" delimited by size 
            tirnak delimited by size 
            "2009-11-04" delimited by size 
            tirnak delimited by size 
            " Amount=" delimited by size
            tirnak delimited by size 
            "135.00" delimited by size
            tirnak delimited by size 
            " PaymentID=" delimited by size 
            tirnak delimited by size 
            "WireTransfer" delimited by size 
            tirnak delimited by size
            " BankAccount=" delimited by size 
            tirnak delimited by size 
            "0000-0000-00-00000000" delimited by size 
            tirnak delimited by size 
            " />" delimited by size 
     into xml-dosya-rec

     perform apo-kobra write xml-dosya-rec end-write 
     .
*
 payment-terms-kapa.
     initialize xml-DOSYA-REC
     string xml-dosya-rec delimited by spaces
            "</PaymentTerms>" delimited by size 
     into xml-dosya-rec

     perform apo-kobra write xml-dosya-rec end-write 
     .
*
 total-summary-ac-kapa.
     initialize xml-DOSYA-REC
     move f-kdvsiz to z-para
     move f-kdv    to z-para2
     move f-bastut  to z-para3
     inspect z-para3 replacing all "," by "."
     inspect z-para2 replacing all "," by "."
     inspect z-para replacing all "," by "."

     string xml-dosya-rec delimited by spaces
            "<TotalSummary GrossTotal=" delimited by size 
            tirnak delimited by size 
            z-para delimited by size 
            tirnak delimited by size
            " Discounts=" delimited by size 
            tirnak delimited by size 
            "0.00" delimited by size 
            tirnak delimited by size 
            " SubTotal=" delimited by size
            tirnak delimited by size 
            z-para delimited by size 
            tirnak delimited by size 
            " Tax=" delimited by size
            tirnak delimited by size 
            z-para2 delimited by size 
            tirnak delimited by size 
            " InvoiceTotal=" delimited by size 
            tirnak delimited by size 
            z-para3 delimited by size 
            tirnak delimited by size
            "/>" delimited by size 
     into xml-dosya-rec

     perform apo-kobra write xml-dosya-rec end-write 
     .
*
 remarks-body.
     initialize xml-DOSYA-REC
     string xml-dosya-rec delimited by spaces
            "<Remark Body=" delimited by size
            tirnak delimited by size
            "All taxes inclusive" delimited by size
            tirnak delimited by size
            " />" delimited by size 
     into xml-dosya-rec

     perform apo-kobra write xml-dosya-rec end-write 
     .  
     .
*
 remarks-kapa.
     initialize xml-DOSYA-REC
     string xml-dosya-rec delimited by spaces
            "</Remarks>" delimited by size 
     into xml-dosya-rec

     perform apo-kobra write xml-dosya-rec end-write 
     .
*
 invoice-ac.
     initialize xml-DOSYA-REC
     string xml-dosya-rec delimited by spaces
            "<Invoice>" delimited by size 
     into xml-dosya-rec

     perform apo-kobra write xml-dosya-rec end-write 
     .
*
 suplier-ac-kapa.     
     initialize xml-DOSYA-REC
     string xml-dosya-rec delimited by spaces
            "<Supplier SupplierID=" delimited by size
            tirnak delimited by size 
            bavelsir-suplier-id delimited by "     " 
            tirnak delimited by size
            " Company=" delimited by size 
            tirnak delimited by size 
            bavelsir-company delimited by "     "
            tirnak delimited by size 
            " TaxID=" delimited by size 
            tirnak delimited by size
            bavelsir-tax-id delimited by "     " 
            tirnak delimited by size 
            " Address=" delimited by size
            tirnak delimited by size 
            bavelsir-adress delimited by "     "
            tirnak      delimited by size 
            " City="    delimited by size 
            tirnak      delimited by size 
            bavelsir-city delimited by "     "
            tirnak      delimited by size
            " ZIP="     delimited by size 
            tirnak      delimited by size 
            bavelsir-zip     delimited by "     "
            tirnak      delimited by size 
            " Province=" delimited by size
            tirnak      delimited by size
            bavelsir-province  delimited by "     "
            tirnak      delimited by size
            " Country=" delimited by size
            tirnak      delimited by size 
            bavelsir-country       delimited by "     " 
            tirnak      delimited by size 
            " UnitName=" delimited by size 
            tirnak       delimited by size
            bavelsir-unit-name     delimited by "     "
            tirnak       delimited by size
            " UnitAddr=" delimited by size 
            tirnak       delimited by size
            bavelsir-unit-adress  delimited by "     "
            tirnak         delimited by size
            " Email="      delimited by size 
            tirnak         delimited by size
            bavelsir-email  delimited by "     "
            tirnak                   delimited by size
            " />" delimited by size 
     into xml-dosya-rec

     perform apo-kobra write xml-dosya-rec end-write 


    .
*
 client-ac-kapa.
     initialize xml-DOSYA-REC
     string xml-dosya-rec delimited by spaces
            "<Client ClientID=" delimited by size 
            tirnak delimited by size 
            acebavel-client-id delimited by "     "
            tirnak delimited by size 
            " Company=" delimited by size 
            tirnak delimited by size 
            acebavel-company    delimited by "     " 
            tirnak delimited by size 
            " TaxID=" delimited by size 
            tirnak delimited by size 
            acebavel-tax-id  delimited by "     " 
            tirnak delimited by size 
            " Address=" delimited by size 
            tirnak delimited by size 
            acebavel-adress delimited by "     " 
            tirnak delimited by size 
            " City=" delimited by size 
            tirnak delimited by size 
            acebavel-city delimited by "     " 
            tirnak delimited by size 
            " ZIP=" delimited by size 
            tirnak delimited by size 
            acebavel-zip delimited by "     " 
            tirnak delimited by size
            " Province=" delimited by size 
            tirnak delimited by size 
            acebavel-province delimited by "     " 
            tirnak delimited by size 
            " Country=" delimited by size 
            tirnak delimited by size 
            acebavel-country delimited by "     " 
            tirnak delimited by size
            " Email=" delimited by size 
            tirnak delimited by size 
            acebavel-email delimited by "     " 
            tirnak delimited by size 
            " />" delimited by size 
     into xml-dosya-rec

     perform apo-kobra write xml-dosya-rec end-write 
    
    .
*
 header-ac-kapa.
     initialize xml-dosya-rec 
     move acenfat-yil to tar3yil
     move acenfat-ay  to tar3ay
     move acenfat-gun to tar3gun
     if genel-bavel-fat-kes-tar = 1
                move fatura-yil   to tar3yil
                move fatura-ay    to tar3ay
                move fatura-gun   to tar3gun
     end-if


 
     perform acenfat-ger-fat-bul

     string xml-dosya-rec delimited by spaces
            "<Header OnlyArchive=" delimited by size 
            tirnak delimited by size
            "false" delimited by size 
            tirnak delimited by size 
            " TaxIncluded=" delimited by size 
            tirnak delimited by size 
            "true" delimited by size 
            tirnak delimited by size 
            " Currency=" delimited by size 
            tirnak delimited by size             
            D-MERKEZ-BANKA-KODU delimited by size 
            tirnak delimited by size 
            " Date=" delimited by size 
            tirnak delimited by size 
            tar3 delimited by size 
            tirnak delimited by size
            " Type=" delimited by size 
            tirnak delimited by size 
            "DebitInvoice" delimited by size 
            tirnak delimited by size 
            " Ref=" delimited by size 
            tirnak delimited by size 
            gercek-fat-no delimited by size 
            tirnak delimited by size 
            "/>" delimited by size
     into xml-dosya-rec

     perform apo-kobra write xml-dosya-rec end-write 

     .
*
 invoice-kapat.
     initialize xml-DOSYA-REC
     string xml-dosya-rec delimited by spaces
            "</Invoice>" delimited by size 
     into xml-dosya-rec

     perform apo-kobra write xml-dosya-rec end-write 
     .


*
 csv-olustur.  
         if bav-tip(1:5) not = "Bavel" then
           move    x"09" to virgul 
            else
              move    x"2C" to virgul  

              end-if
     
         open input acenfat kodlar02 konuk rez konum cast 
            hesayr  takvim doviz acenta   bavelsir acebavel acesch takasf fatura 
        initialize son-fat   fat-adet gidecekler 
         
          initialize acebavel-rec 
            perform varying i from 1 by 1 until i > oda-top  + 1
               inquire form2-gd-1(i,1) hidden-data in hdata  
                inquire form2-gd-1(i,15) cell-data in satir-fat
                 move function numval(satir-fat) to isaret-fat
                 if function numval(hdata) > 0 then 
                    inquire form2-gd-1(i,1) hidden-data in hdata  
                    inquire form2-gd-1(i,2) hidden-data in acenfat-anah
                    read acenfat no lock invalid 
                         stop " "
                    end-read
                      
          
                    initialize fatura-rec
                    move acenfat-fat-no           to fatura-no
                    move 0                        to fatura-sira
                    read fatura no lock invalid
                    display message box "fatura bulunamadi HATA !"
                          icon 3
                    end-read

                    move acenfat-kfolio to konuk-folio
                    read konuk no lock invalid 
                         stop " "
                    end-read
                     move konuk-fiyat-konumu to konum-anahtar 
                    read konum no lock invalid 
                         continue
                    end-read

                    move konuk-rez-no to rez-anah
                    move konuk-doviz to doviz-kodu
                    read doviz no lock invalid continue
                    end-read

                    read rez no lock invalid 
                         move konuk-acenta to rez-acenta 
                         move konuk-acenta to rez-acenta 
                      move konum-adi  to rez-adi
                      move konuk-soyadi to rez-soyadi
                      move konuk-oda-konumu to rez-oda-konumu
                      move konuk-fiyat-konumu to rez-fiyat-konumu,
                      move konuk-voucher to rez-voucher
                    end-read
                    move rez-acenta to acenta-kodu 
                    read acenta no lock invalid 
                         stop " "
                    end-read
*/*********************************************************************
                    if onkpara-referans-var not = 1
                       initialize bavelsir-rec
                       move bav-sir          to bavelsir-sirket-kodu
                       if bavelsir-sirket-kodu not > "00" then 
                           move "01"         to bavelsir-sirket-kodu
                       end-if
                       read bavelsir no lock invalid 
                             
                              continue 
                       end-read
                    else  
*/***********************referanslý olupta tek þirket kullanan oteller ve id leri farklý oteller için ramazan              
                       initialize kodlar02-rec okunamadi
                       move "r"                            to kodlar02-tipi
                       move "0"                            to kodlar02-kodu(1:1)
                       move konum-ref                      to kodlar02-kodu(2:1)                                   
                       read kodlar02 no lock invalid                            
                           move 1        to okunamadi
                       end-read 
                       if okunamadi not = 1
                          initialize bavelsir-rec
                          move kodlar02-bavel-kodu         to bavelsir-sirket-kodu
                          read bavelsir no lock invalid 
                               continue 
                          end-read
                       else
                          initialize bavelsir-rec
                          move "01"                        to bavelsir-sirket-kodu
                          read bavelsir no lock invalid 
                               continue 
                          end-read                          
                       end-if 
                    end-if 
*/*/*******************************************************************
                    if isaret-fat = son-fat
                         perform line-at-csv 
                    else
                      if son-fat > 0
                        initialize eklemeli-toplam
                        perform fat-KAPAT-csv
                      end-if
                         move isaret-fat to son-fat
                          perform fat-ac-csv
                          PERFORM line-AT-csv
                    end-if
                     modify form2-gd-1(i) row-color = 156
                 end-if
                 
            end-perform .
            perform tlucky-data-bas      | 5/7/2018 xiiilucky
          close acenfat  kodlar02 konuk rez doviz takvim  
                cast hesayr  acenta konum   bavelsir takasf acebavel acesch fatura 
            if son-fat > 0 then 
              perform fat-kapat-csv
            end-if
            move fat-adet to z-adet
            string "Asagidaki "          delimited by size 
                    z-adet               delimited by size
                    " dosya olusturudu " delimited by size 
                    new-line             delimited by size
                    new-line             delimited by size
                    gidecekler           delimited by   "    "
                    new-line             delimited by size
               into gidecekler


            display message box gidecekler
            .
* 
 tlucky-data-bas.
      if lucky-bos = 1 
         exit paragraph 
      end-if
      open i-o gidenbav tlucky
      initialize tlucky-rec old-durum-kodu
      start tlucky key not < tlucky-anah invalid
            continue
      not invalid
      perform with test after until fs-tlucky = "10"
      read tlucky next no lock end move "10" to fs-tlucky
      not at end 
          initialize gidenbav-rec
          move tlucky-fat-no to gidenbav-fat-no
          read gidenbav no lock invalid
               continue
          not invalid
              move gidenbav-durumu to gidenbav-eski-durumu
          end-read
          move tlucky-acenta to gidenbav-acenta
          evaluate key-status
              when 2                         
                   set gidenbav-xml-olustu   to true
              when 3
                   set gidenbav-csv-olustu   to true
              when 27 
                   set gidenbav-iptal-edildi to true
          end-evaluate                        
          move tlucky-odano        to gidenbav-odano
          move tlucky-mis-adi      to gidenbav-adi
          move tlucky-mis-soyadi   to gidenbav-soyadi
          move tlucky-bas-dov      to gidenbav-bas-dov
          move tlucky-dov-kod      to gidenbav-dov-kod
          move tlucky-fat-tut      to gidenbav-fat-tut
          move tlucky-gir-tar      to gidenbav-gir-tar    
          move tlucky-cik-tar      to gidenbav-cik-tar    
          move tlucky-fat-gon-tar  to gidenbav-fat-gon-tar
          move tlucky-staff        to gidenbav-staff     
          write gidenbav-rec invalid
                rewrite gidenbav-rec end-rewrite
          end-write
      end-read
      end-perform 
      end-start
      close gidenbav tlucky
      delete file tlucky
      move 1 to lucky-bos.


*
 fat-kapat-csv.
     if bav-tip(1:5) not = "Bavel" then
       if t-bastut > 0 or t-gece > 0
             perform line-at-csv-sch
           initialize t-bastut t-gece t-hesacik eski-rez
       end-if
     end-if


          close csv-DOSYA
          perform csv-kopyala.
*
 fat-ac-csv.
     initialize f-deg acebavel-rec acesch-rec  
                eski-rez t-bastut t-gece t-hesacik
     
     move acenta-kodu  to acebavel-acenta-kodu  
                          acesch-acenta-kodu

     if bav-tip(1:5) = "Bavel" then 
        read acebavel no lock invalid
             continue 
        end-read
     else
        read acesch no lock invalid
             continue 
        end-read
     end-if

     if bav-tip(1:5) = "Bavel" then 
        continue
     else
        move "Sch"   to csv-dosya-adi(1:3)
     end-if

     move acenta-adi to csv-dosya-no

     inspect csv-dosya-no converting x"DDD6DC989EA6A78D9F94"
                                  to x"494F554953476769736F"

     inspect csv-dosya-no 
              replacing trailing spaces by low-values                  | vurmayýn yapamadým vurmayýn :(((
     inspect csv-dosya-no 
              replacing all " " by "_"
     inspect csv-dosya-no 
              replacing all "." by "_"
     inspect csv-dosya-no 
              replacing all "/" by "_"
     inspect csv-dosya-no 
              replacing all "\" by "_"
     inspect csv-dosya-no 
              replacing all "-" by "_"
     inspect csv-dosya-no 
              replacing all "'" by "_"
     
     string csv-dosya-no delimited by low-values 
            ".csv"       delimited by size
       into csv-dosya-no                                     |acenta adi eklenip 30 hane arttýrýldý wrk da. frt 20/02/2020


     move   isaret-fat        to  csv-dosya-adres-fat-no 
     move   isyeri-adres-tasi to  csv-dosya-sirket
     move   tarih-tasi        to  csv-tarih

     open output csv-DOSYA 

     if bav-tip(1:5) = "Bavel" then 
        continue
     else
        if baslikli = 1 
           perform schilksatir
        end-if
     end-if

    .



*
 line-at-csv.
     if eski-rez = 0  and  bav-tip(1:5) not = "Bavel" 
      initialize t-bastut t-gece t-hesacik
       move  rez-no to eski-rez
      

       else


     if bav-tip(1:5) not = "Bavel" then
      if eski-rez = rez-no then

           continue

          else
         
          
           perform line-at-csv-sch
           initialize t-bastut t-gece t-hesacik
              move  rez-no to eski-rez
       end-if
     end-if
     end-if
       perform csv-ortak-hesap
       add l-bastut  to t-bastut
       add l-gece to t-gece 
       string t-hesacik delimited by "            "
               hesacik delimited by    size
               into t-hesacik
      if bav-tip(1:5)  = "Bavel" then
           perform line-at-csv-bav
      end-if  .
       
*
  csv-ortak-hesap.
              initialize l-bastar l-bittar l-bastut l-adi  line-deg
        move "999999999" to l-bastar
        string rez-soyadi delimited by "   " 
                "  " delimited by size
                rez-adi delimited by "   "
                into l-adi
      
        initialize hesayr-rec l-basekle
        move rez-no to hesayr-rez-no
        start hesayr key > hesayr-anah
            invalid continue
            not invalid
              perform until fs-hesayr = "10"
                   read hesayr next no lock  
                      end move "10" to fs-hesayr
                      not end
                        if hesayr-rez-no not = rez-no 
                           move "10" to fs-hesayr
                           exit perform cycle
                        end-if
                        if hesayr-per - 1 = acenfat-peryod
                           add 1 to l-gece
                           if l-bastar > hesayr-tarih 
                             move hesayr-tarih to l-bastar
                           end-if
                            if l-bittar < hesayr-tarih 
                             move hesayr-tarih to l-bittar
                           end-if
*                            add hesayr-basilacak-tut to l-bastut  
                                 
                               if acenfat-kdv = 1
                                  if acenfat-tarih > "20210930"
                                     exit perform cycle
                                  end-if 
                               end-if 
                               if acenfat-kdv = 8
                                  if acenfat-tarih < "20211001"
                                     exit perform cycle
                                  end-if 
                               end-if 

               
                            if acebavel-kb-ekle = 1 
                               add hesayr-kb-tut       to l-basekle 
                            end-if
                            if acebavel-kkp-ekle = 1 
                               add hesayr-kkp-tut      to l-basekle
                            end-if
                            compute eklemeli-toplam = hesayr-basilacak-tut + l-basekle
                        end-if
                   end-read
              end-perform
         end-start
          if t-hesacik = spaces move "=" to ilk-kar
            else
                move "+" to ilk-kar
         end-if
         open input formulhes
           initialize formulhes-rec hesayr-rec
           move  l-bastar  to hesayr-tarih
             move rez-no to hesayr-rez-no
           move hesayr-anah to formulhes-anah
          read formulhes no lock invalid
             continue
            not invalid
          continue
           end-read
          close formulhes
          move l-gece               to z-gece 
          initialize hesacik
          string ilk-kar delimited by size
                 z-gece  delimited by size
                 " X (" delimited by size
                 formulhes-tum-formul(13:) delimited by "         "
                 " )" delimited by size
                 into hesacik
        if l-bastut not = acenfat-GER-DV-TUTAR
               continue
        end-if  .
        move l-bastar(1:4) to tar1yil
        move l-bastar(5:2) to tar1ay
        move l-bastar(7:2) to tar1gun
        if bav-tip(1:5)  = "Bavel" then
            move l-bastar(1:4) to tar1yil
        move l-bastar(5:2) to tar1ay
        move l-bastar(7:2) to tar1gun
         else
          move rez-gir-tar(1:4) to tar1yil
        move rez-gir-tar(5:2) to tar1ay
        move rez-gir-tar(7:2) to tar1gun


        end-if
        initialize takvim-rec
        move l-bittar   to takvim-anah
        start takvim key > takvim-anah invalid 
             continue
        not invalid
        read takvim next no lock end continue
        not at end 
              move takvim-anah  to l-bittar
              
        end-read
        end-start
        move l-bittar(1:4) to tar2yil
        move l-bittar(5:2) to tar2ay
        move l-bittar(7:2) to tar2gun

*/** crown palace kaldýrýldý
*        move   acenfat-GER-DV-TUTAR to l-bastut

*        compute l-kdvsiz rounded =  acenfat-GER-DV-TUTAR / 1.08
*        compute l-kdv = acenfat-GER-DV-TUTAR - l-kdvsiz
*/** crown palace kaldýrýldý

        compute bavel-toplam rounded =
                acenfat-GER-DV-TUTAR + (l-basekle / 1)

        move   bavel-toplam to l-bastut
         



***        compute l-kdvsiz rounded =  bavel-toplam / 1.08
        compute l-kdvsiz rounded =  bavel-toplam / ((100 + acenfat-kdv) / 100)         
        
        compute l-kdv = bavel-toplam - l-kdvsiz


        add l-bastut  to f-bastut
        add l-kdvsiz  to f-kdvsiz
        add l-kdv     to f-kdv
        if l-gece = 0 then 
          compute l-gunluk rounded = l-bastut
        else
           compute l-gunluk rounded = l-bastut / l-gece
        end-if 
           move l-gunluk to z-para 
        move acenfat-yil   to tar3yil
        move acenfat-ay    to tar3ay
        move acenfat-gun   to tar3gun


        if genel-bavel-fat-kes-tar = 1
                move fatura-yil   to tar3yil
                move fatura-ay    to tar3ay
                move fatura-gun   to tar3gun
        end-if

        move l-bastut             to z-para
        move l-gece               to z-gece
     
     initialize takasf-rec
     move acenfat-fat-no       to takasf-fat-no
     read takasf no lock invalid 
          continue 
     not invalid 
*          move takasf-dov-tutar  to z-para-son
          compute bavel-toplam rounded = takasf-dov-tutar 
          |+ (l-basekle / 1)   
          move bavel-toplam  to z-para-son

         || move eklemeli-toplam to z-para-son

     end-read 
      move rez-buyuk to z-pax
     perform acenfat-ger-fat-bul
       
     inspect z-para3    replacing all "," by "."
     inspect z-para2    replacing all "," by "."
     inspect z-para     replacing all "," by "."
     inspect z-para-son replacing all "," by "."
        if acenta-bavel-no = 1 then
           move rez-bavel to yastik-voucher 
        else
           move konuk-voucher to yastik-voucher 
        end-if
       initialize csv-DOSYA-REC
       move rez-no to zrez-no.


**
 schilksatir.
      initialize  csv-dosya-rec
       string csv-dosya-rec delimited by spaces
              "agency"  delimited by "     " 
              virgul delimited by size
               "invoice_number" delimited by "     "
               virgul delimited by size
              "invoice_date" delimited by "     "
               virgul delimited by size
                "booking_number" delimited by "     "
               virgul delimited by size
            "reservation_number" delimited by "     "
                virgul delimited by size
                "destination"  delimited by "     "
                 virgul delimited by size
                  "hotel_code"  delimited by "     "
                 virgul delimited by size
                  "hotel_name" delimited by "     "
                 virgul delimited by size
                 "room_board" delimited by "     "
                 virgul delimited by size
                 "client_name"   delimited by "        "
                 virgul delimited by size
                 "date_arrival" delimited by "     "
                  virgul delimited by size
                 "nights" delimited by "     "
                  virgul delimited by size
                  "number_of_paxe" delimited by "     "
                  virgul delimited by size
                   "number_of_rooms"    delimited by "     "
                    virgul delimited by "     "
                    "unit_price" delimited by "       "
                   virgul delimited by size
                    "hotel_amount" delimited by "       "
                    virgul delimited by size,
                    "extras_amount" delimited by "       "
                      virgul delimited by size
                     "handling_amount" delimited by "       "
                     virgul delimited by size
                     "transfer_amount" delimited by "       "
                      virgul delimited by size
                      "guide_amount" delimited by "       "
                      virgul delimited by size
                    "total_amount" delimited by "       "
                    virgul delimited by size
                    "comment" delimited by "       "
                    virgul delimited by size
                     "currency" delimited by "       "
              into csv-dosya-rec
       write csv-dosya-rec end-write .

*
 line-at-csv-sch.
     

         move t-bastut             to z-para
            move t-gece               to z-gece
      if l-gece = 0 then 
          compute l-gunluk rounded = l-bastut
        else
           compute l-gunluk rounded = l-bastut / l-gece
        end-if 
           move l-gunluk to z-para-gun
           initialize zt-hesacik
          string z-para delimited by size
                 t-hesacik delimited by "                  "
                 into zt-hesacik
      initialize csv-dosya-rec
     string 
              acesch-client-id  delimited by "     " 
              virgul delimited by size
               gercek-fat-no delimited by "     "
               virgul delimited by size
              tar3 delimited by "     "
               virgul delimited by size
                 yastik-voucher delimited by "     "
               virgul delimited by size
               zrez-no delimited by "     "
                virgul delimited by size
                bavelsir-destination  delimited by "     "
                 virgul delimited by size
                  bavelsir-hotel-code  delimited by "     "
                 virgul delimited by size
                  bavelsir-hotel-name  delimited by "     "
                 virgul delimited by size
                 REZ-PAN-TIPI delimited by "     "
                 virgul delimited by size
                 l-adi   delimited by "        "
                 virgul delimited by size
                 tar1 delimited by "     "
                  virgul delimited by size
                 z-gece delimited by "     "
                  virgul delimited by size
                  z-pax delimited by "     "
                  virgul delimited by size
                   "1"    delimited by "     "
                    virgul delimited by "     "
                    z-para-gun delimited by "       "
                   virgul delimited by size
                    z-para delimited by "       "
                    virgul delimited by size
                      virgul delimited by size
                      virgul delimited by size
                      virgul delimited by size
                      virgul delimited by size
                    z-para delimited by "       "
                    virgul delimited by size
                    zt-hesacik  delimited by "          "
                    virgul delimited by size
                     D-MERKEZ-BANKA-KODU delimited by "     "
              into csv-dosya-rec  
     write csv-dosya-rec end-write .  
*
 line-at-csv-bav.
              initialize kdv-text  kdv-textz
              move   acenfat-kdv to kdv-textz
              move  kdv-textz to kdv-text
*             if acenfat-kdv = 1 
*                 move "1" to kdv-text
*             else
*                 move "8" to kdv-text      
*             end-if
             string csv-dosya-rec delimited by spaces
              bavelsir-suplier-id delimited by "     "   
              virgul delimited by size
              "D" delimited by "     "
              virgul delimited by size
              gercek-fat-no delimited by "     "
              virgul delimited by size
              virgul delimited by size 
              tar3 delimited by "     "
              virgul delimited by size 
              yastik-voucher delimited by "     "
              virgul delimited by size 
              "KONAKLAMA" delimited by "     "
              virgul delimited by size
              l-adi delimited by "     "
              virgul delimited by size
              tar1 delimited by "     "
              virgul delimited by size 
              z-gece delimited by "     "
              virgul delimited by size 
              "1"    delimited by "     "
              virgul delimited by "     "
              z-para delimited by "       "
              virgul delimited by size 
              D-MERKEZ-BANKA-KODU delimited by "     "
              virgul delimited by size 

              virgul delimited by size
              z-para delimited by "       "
              virgul delimited by size
              kdv-text    delimited by size
              virgul delimited by size
              z-para-son delimited by "       "

       into csv-dosya-rec

        write csv-dosya-rec end-write .

*
 csv-kopyala.
           initialize   gidecek-adres
        if bav-tip(1:5) = "Bavel" then
          string
              "@[DISPLAY]:" delimited by size
             genel-bavel-adres delimited by "\ "              
              "\"  delimited by size
              csv-dosya-adi 
              into gidecek-adres
            end-string
            else
           string 
           
              "@[DISPLAY]:" delimited by size
             "C:\" delimited by "   "              
              "sch\"  delimited by size
              csv-dosya-adi into gidecek-adres
            end-string

            end-if

            if os-is-unix then
               CALL "C$COPY" using csv-dosya-adres, 
               gidecek-adres giving sonuccopy
                                                                    
               if sonuccopy = 1 then 
                  
                  display message box 
                  "Dosya kopyalanamadi", NEW-LINE 
                  csv-dosya-adres,  NEW-LINE, gidecek-adres
               else
                  add 1 to fat-adet
                  string  gidecekler delimited by   "    "
                       gidecek-adres(12:) delimited by "    "
                       new-line delimited by size
                       into gidecekler
                  
                            
               end-if
             else
          
                call "c$copy" using csv-dosya-adres,gidecek-adres  giving sonuccopy
      
               if sonuccopy = 1 then 
                  
                  display message box 
                  "Dosya kopyalanamadi", NEW-LINE 
                  csv-dosya-adres,  NEW-LINE, gidecek-adres
               else
                  add 1 to fat-adet
                  string  gidecekler delimited by   "    "
                       gidecek-adres(12:) delimited by "    "
                       new-line delimited by size
                       into gidecekler
                   end-if
            end-if.
* 
 efatura-gercek-bul.


////********************************
                open input genel
                move 1 to genel-anahtar
                read genel no lock invalid continue
                     not invalid continue
                end-read
                close genel
     
                if muha-sirketi(7:2) <> acenfat-yil(3:2) and 
                   function numval(muha-sirketi(7:2)) > 0  and 
                   function numval(muha-sirketi(7:2)) >= function numval(acenfat-yil(3:2))
                     move acenfat-yil(3:2) to muha-sirketi of genel-rec(7:2)
                end-if

                move muha-sirketi of genel-rec to efat2onb-dosya-adres
        
                move all low-values to efat2onb-acuserve-dosya
                
                inspect genel-muha-uzak-ip 
                         replacing trailing spaces by low-values
        
                if genel-muha-uzak-ip <> low-values
                     move all low-values to ip-no
                     string ip-no,
                           "@" delimited by low-values
                           genel-muha-uzak-ip delimited by low-values
                           ":" delimited by low-values
                           into ip-no
                 end-if
                 string efat2onb-acuserve-dosya,
                           ip-no                        delimited by low-values
                           efat2onb-dosya                delimited by low-values
                           into efat2onb-acuserve-dosya
        
                 inspect efat2onb-acuserve-dosya        replacing  all spaces by low-values
        

//?*********************************
        open input efat2onb
        initialize efat2onb-rec  e-m-fatura
        set efat2onb-tipi-onburo to true
        move  e-ref      to  efat2onb-referans 
        initialize kodlar02-rec
        move "r"           to kodlar02-tipi
        move e-ref   to zz
        move zz           to kodlar02-kodu
        read kodlar02 no lock invalid 
            continue 
        not invalid 
            move kodlar02-ref to efat2onb-referans
        end-read              
         | if k-kodu-tasi = "X   " or "ASYA" then

        move e-ref      to  efat2onb-referans 
        |  end-if 
        move ACENFAT-TARIH to  efat2onb-fatura-tarihi
        move all "0" to   efat2onb-onburo-fatura-no
        move e-o-fatura to efat2onb-onburo-fatura-no2           
        if isyeri-adres-tasi = "jadore18"
           if efat2onb-referans = spaces
              move "000" to efat2onb-referans
           end-if 
        end-if                                   

        read efat2onb no lock invalid  
              |   if k-kodu-tasi = "X   " or "ASYA" then
                     
             move 1 to  efat2onb-referans 
             read efat2onb  no lock invalid  
                  move 3 to  efat2onb-referans 
                  read efat2onb no lock invalid 
                       continue
                  not invalid 
                      if function numval (efat2onb-muhasebe-fatura-no(8:))  > 0 
                         move efat2onb-muhasebe-fatura-no to   e-m-fatura
                      end-if   
                  end-read
             not invalid 
                 if function numval (efat2onb-muhasebe-fatura-no(8:))  > 0 
                    move efat2onb-muhasebe-fatura-no to   e-m-fatura
                 end-if   
             end-read
            |     end-if
        not invalid 
            if function numval(efat2onb-muhasebe-fatura-no(8:))  > 0 
               move efat2onb-muhasebe-fatura-no  to e-m-fatura
            end-if
        end-read
        close efat2onb.


* 
 tefatura-gercek-bul.


////********************************
                open input genel
                move 1 to genel-anahtar
                read genel no lock invalid continue
                     not invalid continue
                end-read
                close genel

*                if muha-sirketi(7:2) <> tacenfat-yil(3:2) and 
*                   function numval(muha-sirketi(7:2)) > 0  and 
*                   function numval(muha-sirketi(7:2)) >= function numval(acenfat-yil(3:2))
*                     move tacenfat-yil(3:2) to muha-sirketi of genel-rec(7:2)
*                end-if

                move muha-sirketi of genel-rec to efat2onb-dosya-adres
        
                move all low-values to efat2onb-acuserve-dosya
                
                inspect genel-muha-uzak-ip 
                         replacing trailing spaces by low-values
        
                if genel-muha-uzak-ip <> low-values
                     move all low-values to ip-no
                     string ip-no,
                           "@" delimited by low-values
                           genel-muha-uzak-ip delimited by low-values
                           ":" delimited by low-values
                           into ip-no
                 end-if
                 string efat2onb-acuserve-dosya,
                           ip-no                        delimited by low-values
                           efat2onb-dosya                delimited by low-values
                           into efat2onb-acuserve-dosya
        
                 inspect efat2onb-acuserve-dosya        replacing  all spaces by low-values
        

//?*********************************
        open input efat2onb
        initialize efat2onb-rec  e-m-fatura
        set efat2onb-tipi-onburo to true
        move  e-ref      to  efat2onb-referans 
        initialize kodlar02-rec
        move "r"           to kodlar02-tipi
        move e-ref   to zz
        move zz           to kodlar02-kodu
        read kodlar02 no lock invalid 
            continue 
        not invalid 
            move kodlar02-ref to efat2onb-referans
        end-read              
         | if k-kodu-tasi = "X   " or "ASYA" then

        move e-ref      to  efat2onb-referans 
        |  end-if 
        move tACENFAT-TARIH to  efat2onb-fatura-tarihi
        move all "0" to   efat2onb-onburo-fatura-no
        move e-o-fatura to efat2onb-onburo-fatura-no2           
        if isyeri-adres-tasi = "jadore18"
           if efat2onb-referans = spaces
              move "000" to efat2onb-referans
           end-if 
        end-if                                   

        read efat2onb no lock invalid  
              |   if k-kodu-tasi = "X   " or "ASYA" then
                     
             move 1 to  efat2onb-referans 
             read efat2onb  no lock invalid  
                  move 3 to  efat2onb-referans 
                  read efat2onb no lock invalid 
                       continue
                  not invalid 
                      if function numval (efat2onb-muhasebe-fatura-no(8:))  > 0 
                         move efat2onb-muhasebe-fatura-no to   e-m-fatura
                      end-if   
                  end-read
             not invalid 
                 if function numval (efat2onb-muhasebe-fatura-no(8:))  > 0 
                    move efat2onb-muhasebe-fatura-no to   e-m-fatura
                 end-if   
             end-read
            |     end-if
        not invalid 
            if function numval(efat2onb-muhasebe-fatura-no(8:))  > 0 
               move efat2onb-muhasebe-fatura-no  to e-m-fatura
            end-if
        end-read
        close efat2onb.


* 
 acenfat-ger-fat-bul.
     move acenfat-fat-no    to e-o-fatura

     if onkpara-referans-var = 1 

                   initialize konuk-rec
                   move acenfat-kfolio  to konuk-folio
                   read konuk no lock invalid 
                        continue 
                   end-read 
*/*alba side için deðiþtirildi eskiden konuk-oda-konumu yazýyordu.....ramazan aþkýn
                   move konuk-fiyat-konumu     to rez-fiyat-konumu
                   initialize konum-rec
                   move konuk-fiyat-konumu to KONUM-ANAHTAR
                   read konum no lock invalid
                            continue
                   end-read

                   if  konum-ref > 0
                          move konum-ref    to e-ref 
                          perform efatura-gercek-bul
                   end-if

     else
        if genel-muha-ref > 0
            move genel-muha-ref    to e-ref 
            perform efatura-gercek-bul
        else
           perform efatura-gercek-bul
        end-if
     end-if
    
            
     if e-m-fatura > spaces then 
          move e-m-fatura     to gercek-fat-no
**/****adalya ocean
             if genel-bavel-on-ek > 0 
                move genel-bavel-on-ek   to gercek-fat-no(4:4)
             end-if
**/****adalya ocean
     else
          move acenfat-fat-no to gercek-fat-no
          perform on-ek-yerlestir
     end-if.
* 
 tacenfat-ger-fat-bul.
     move tacenfat-fat-no    to e-o-fatura

     if onkpara-referans-var = 1 

                   initialize konuk-rec
                   move tacenfat-kfolio  to konuk-folio
                   read konuk no lock invalid 
                        continue 
                   end-read 
*/*alba side için deðiþtirildi eskiden konuk-oda-konumu yazýyordu.....ramazan aþkýn
                   move konuk-fiyat-konumu     to rez-fiyat-konumu
                   initialize konum-rec
                   move konuk-fiyat-konumu to KONUM-ANAHTAR
                   read konum no lock invalid
                            continue
                   end-read

                   if  konum-ref > 0
                          move konum-ref    to e-ref 
                          perform tefatura-gercek-bul
                   end-if

     else
*        if genel-muha-ref > 0
            move genel-muha-ref    to e-ref 
            perform tefatura-gercek-bul
*        else
*           perform tefatura-gercek-bul
*        end-if
     end-if
    
            
     if e-m-fatura > spaces then 
          move e-m-fatura     to gercek-fat-no
**/****adalya ocean
             if genel-bavel-on-ek > 0 
                move genel-bavel-on-ek   to gercek-fat-no(4:4)
             end-if
**/****adalya ocean
     else
          move tacenfat-fat-no to gercek-fat-no
          perform on-ek-yerlestir
     end-if.

*
 on-ek-yerlestir.
     if genel-bavel-on-ek > 0 
        initialize yedek-gercek-fat-no
        move gercek-fat-no       to yedek-gercek-fat-no
        move genel-bavel-on-ek   to gercek-fat-no(1:4)

        move yedek-gercek-fat-no to gercek-fat-no(5:)
     end-if.
*
 tlucky-dosya-olustur.
    open i-o genelfis
    move 1 to genelfis-anahtar
    read genelfis no lock invalid
         accept print-no from time
    not invalid
         add 1 to print-no
         rewrite genelfis-rec end-rewrite
    end-read
    close genelfis
    move print-no to tlucky-print
    open output tlucky
    close tlucky
       .
*
 gonderilmeyen-raporla-lucky.
     open i-o genelfis 
     move 1 to genelfis-anahtar
     read genelfis no lock invalid
          accept print-no from time
     not invalid
          add 1 to print-no
          rewrite genelfis-rec end-rewrite
     end-read
     close genelfis
**************************
     initialize dokumer-rec dokumer-anah dokumer-ozellikler-rec
                dokumer-dosya

     set  dokumer-asya-set to true
     move print-no         to dokumer-dosya-adi
     open output dokumer
*/WINDOW TITLE
     initialize dokumer-rec detay
     move "W"                  to det-dokumer-20(1:)
     move "Bavel Gonderilenler Raporu" to det-filler
     write dokumer-rec from detay
*/ BASLIKLAR
     initialize dokumer-rec detay
     move "1"          to det-dokumer-20(10:1)
     move "B"                  to det-dokumer-20(1:1)
     move "Bavel Gonderilenler Raporu" to det-filler
     write dokumer-rec from detay

     initialize dokumer-rec detay
     move "B"                  to det-dokumer-20(1:1)
     write dokumer-rec from detay

*/ DOKUMER OZELLIKLER-REC
     initialize dokumer-rec detay
     move "O" to det-dokumer-20(1:)
     move "E" to dokumer-oto-sayfa-basi
     move 56  to dokumer-oto-sayfa-satir
     move "|" to dokumer-detay-kolon-ayirici
     move "RRRLLRRRRRRLLRRR" to dokumer-align-occ
     move dokumer-ozellikler-rec     to det-filler
     write dokumer-rec from detay
*/ BASLIKLAR  

     initialize dokumer-rec detay 
     move "1"                           to det-dokumer-20(10:1)
     move "D1"                          to det-dokumer-20(1:2)     
     move "Faruta No"                   to det-1
     move "Acenta"                      to det-2
     move "Durumu"                      to det-3 
     move "Oda No"                      to det-4 
     move "Misafir Adi"                 to det-5 
     move "Misafir Soyadi"              to det-6 
     move "Basilan Tutar"               to det-7 
     move "Doviz Kodu"                  to det-8 
     move "Fatura Tutar"                to det-9  
     move "Giris Tarihi"                to det-10
     move "Cikis Tarihi"                to det-11
     move "Islem Tarihi"                to det-12
     move "Staff"                       to det-13

     move "|" to fil-1 fil-2 fil-3 fil-4 fil-5
                 fil-6 fil-7 fil-8 fil-9 fil-10 
                 fil-11 fil-12 fil-13  
     write dokumer-rec from detay
                                                           
     initialize dokumer-rec detay
     move "D2"           to det-dokumer-20(1:2)
     move "-"            to det-dokumer-20(5:1)
     move all "-" to det-1 det-2 det-3 det-4 det-5 
                     det-6 det-7 det-8 det-9 det-10 
                     det-11 det-12 det-13
     write dokumer-rec from detay      
     open i-o genelfis
      move 1 to genelfis-anahtar
      read genelfis no lock invalid 
           move 1 to ekran-fis-1
      end-read
       add 1 to ekran-fis-1
      move ekran-fis-1 to tacenfat-no takasf-no.
      rewrite genelfis-rec invalid write genelfis-rec.
      close genelfis.
      move k-kodu-tasi to tacenfat-k
      open output tacenfat takasf close tacenfat takasf open i-o tacenfat takasf
      open input konuk konu2 acenta acebavel acesch musteri 
                 firma doviz cari konum kodlar02 acenfat
      open i-o gidenbav
      initialize acenfat-rec  oda-top
      move ilk-tarih   to acenfat-tarih
      start acenfat key not < acenfat-anah invalid 
            initialize mesaj-link
            move 04 to mesaj-no
            perform mesaj-ver
      not invalid
      perform with test after until fs-acenfat = "10"
      read acenfat next no lock end move "10" to fs-acenfat
      not at end
              if acenfat-tarih > son-tarih
                move "10" to fs-acenfat
                  exit perform
              end-if
             if rapor-acenta = spaces or 
                rapor-acenta = acenfat-acenta 
                continue
             else 
                exit perform cycle
             end-if
             initialize acebavel-rec acesch-rec
             move acenfat-acenta      to acebavel-acenta-kodu  acesch-acenta-kodu
               if bav-tip(1:5) = "Bavel" then 
                  read acebavel no lock invalid
                          exit perform cycle
                  end-read 
                 if acebavel-client-id = spaces then 
                        exit perform cycle
                 end-if
                 else
                 read acesch no lock invalid
                          exit perform cycle
                  end-read 
                 if acesch-client-id = spaces then 
                        exit perform cycle
                 end-if

               end-if
             
               if acenfat-fat-no not > 0 then 
                  exit perform cycle
               end-if
              move acenfat-rec to tacenfat-rec
              write tacenfat-rec invalid stop " " end-write
                
              initialize takasf-rec 
              move acenfat-fat-no  to takasf-fat-no
              read takasf no lock invalid 
                   move acenfat-ger-dv-tutar to takasf-dov-tutar
                   write takasf-rec end-write 
              not invalid 
                  add acenfat-ger-dv-tutar to takasf-dov-tutar
                  rewrite takasf-rec end-rewrite 
              end-read

           end-read
        end-perform
     end-start.
    
    
     initialize fat-sira son-profil  oda-top
     initialize fat-sat xiii-sira
     initialize fs-acenfat toplamlar tacenfat-rec
     start tacenfat key not < tacenfat-fat-anah invalid 
                    continue
                    not invalid
     perform with test after until fs-tacenfat = "10"
         read tacenfat next no lock end move "10" to fs-tacenfat
         not at end
             if tacenfat-tarih > son-tarih
                move "10" to fs-tacenfat
                exit perform
             end-if
     
             if rapor-acenta = spaces or 
                rapor-acenta = tacenfat-acenta 
                      continue
             else 
                exit perform cycle
             end-if
               if tacenfat-fat-no not > 0 then 
                  exit perform cycle
               end-if
                initialize form2-gd-1-record
                move tacenfat-gun         to egun
                move tacenfat-ay          to eay
                move tacenfat-yil         to eyil
                move tacenfat-acenta      to acenta-kodu 
                read acenta no lock invalid
                     move "Tanimsiz acenta"  to acenta-adi
                end-read
               
                       
                move tacenfat-kfolio to konu2-folio
                read konu2 no lock invalid
                          initialize konu2-rec
                end-read
                move tacenfat-folio       to  konuk-folio
                read konuk no lock invalid
                     initialize konuk-rec
                end-read
               
                 initialize musteri-rec

*                move tACENFAT-PROFIL  to m-profil          |firat m-profil bos geliyordu 17/08/2020
                move tacenfat-p-sirket to musteri-sirket 
                move tacenfat-p-no     to musteri-no

                if musteri-no not numeric
                   move "999999992" to musteri-no
                end-if
                read musteri no lock invalid
                     move konu2-acenta to acenta-kodu
                     read acenta no lock invalid
                          continue
                     not invalid
                         if ACENTA-MUHNO2 = spaces
                            move acenta-muhno to cari-kodu  musteri-muhasebe-kodu
                         else
                            move acenta-muhno2 to cari-kodu  musteri-muhasebe-kodu
                         end-if
                         read cari no lock invalid
                              initialize cari-rec
                         end-read
                         perform varying ix from 1 by 1 until ix > 18
                                 if c-vergi-no(ix:1) = spaces then 
                                    move  c-vergi-no(ix + 1 :) to c-vergi-no(ix :) 
                                    move  " "                  to c-vergi-no(20:1)
                                 end-if
                         end-perform 
                         move c-unvan-1          to musteri-unvan1(1:40)       
                         move  c-unvan-2         to musteri-unvan2(1:40)       
                         move  c-adres-1         to musteri-adres1 (1:40)      
                         move  c-adres-2         to musteri-adres2 (1:40)      
                         move  c-il-ilce         to musteri-ilce(1:20)         
                         move  c-ulke(1:14)      to musteri-il(1:14)           
                         move  c-vergi-daire     to musteri-vdairesi (1:20)    
                         move  c-vergi-no        to musteri-vno
                     end-read
                not invalid
                    move musteri-vno to c-vergi-no    
                end-read
                move tacenfat-acenta        to acenta-kodu 
                read acenta no lock invalid
                     continue
                end-read
                initialize firma-rec
                move konuk-firma      to firma-kodu 
                read firma no lock invalid
                    continue
                end-read
                move konuk-doviz to doviz-kodu
                read doviz no lock invalid 
                     continue
                end-read
                add 1 to oda-top
                add tacenfat-tl-tutar         to tl-top
                add tacenfat-ger-dv-tutar     to dv-top
                add tacenfat-ger-tl-tutar     to ger-tl-top



                 move tacenfat-fat-no to acenfat-fat-no

                 move tACENFAT-TARIH to ACENFAT-TARIH
                 perform acenfat-ger-fat-bul

*********************************tlucky bas    
*                 stop " "
                 initialize gidenbav-rec dokumer-rec detay
                 move tacenfat-fat-no   to gidenbav-fat-no
                                           det-1
                 read gidenbav no lock invalid
                     accept e-tar  from century-date
                      move acenta-kodu           to det-2
                      move "Yeni.."              to det-3
                      move konu2-odano           to det-4
                      move konu2-adi             to det-5
                      move konu2-soyadi          to det-6
                      move tacenfat-ger-dv-tutar to z-tutar
                      move z-tutar               to det-7
                      move d-kisa-adi            to det-8
                      move tacenfat-tl-tutar     to z-tutar
                      move z-tutar               to det-9
                      move konuk-gel-tar(1:4)    to det-10(7:4)
                      move konuk-gel-tar(5:2)    to det-10(4:2)
                      move konuk-gel-tar(7:2)    to det-10(1:2)
                      move konuk-git-tar(1:4)    to det-11(7:4)
                      move konuk-git-tar(5:2)    to det-11(4:2)
                      move konuk-git-tar(7:2)    to det-11(1:2)
                      move e-tar(1:4)            to det-12(7:4)
                      move e-tar(5:2)            to det-12(4:2)
                      move e-tar(7:2)            to det-12(1:2)
                      move "/" to det-10(3:1)
                                  det-10(6:1)
                                  det-11(3:1)
                                  det-11(6:1)
                                  det-12(3:1)
                                  det-12(6:1)
                      move k-kodu-tasi           to det-13
                      add 1 to xiii-sira
                      write dokumer-rec from detay
                 not invalid
                     if gidenbav-durumu <> "I"
                        exit perform cycle
                     end-if
                 end-read

         end-read
     end-perform
     end-start
     move 0 to lucky-bos
     close acenfat gidenbav
*/*-*\**/*-*\**/*-*\**/*-*\**/*-*\**/*-*\**/*-*\*
     close acenta konuk acebavel acesch konu2 musteri firma doviz cari tacenfat takasf konum kodlar02
     initialize dokumer-rec detay
     move "Toplam :" to det-1
     move xiii-sira  to det-2
     write dokumer-rec from detay
     close dokumer
     call dokumer-prog on exception
          perform callerr-proc
     not on exception
          cancel dokumer-prog
     end-call
     delete file dokumer
             .

*
  eklenecek-kayit-bul.
     initialize konuk-rec 
     move acenfat-folio to konuk-folio
     read konuk no lock invalid 
         continue 
     not invalid 
         initialize rez-rec
         move konuk-rez-no to rez-no
         read rez no lock invalid 
            continue 
         not invalid 
             perform hesayr-start
         end-read 
     end-read.
*
 hesayr-start.
     initialize hesayr-rec l-basekle
     move rez-no to hesayr-rez-no
     start hesayr key > hesayr-anah invalid 
        continue
     not invalid
     perform until fs-hesayr = "10"
     read hesayr next no lock end 
           move "10" to fs-hesayr
     not end
       if hesayr-rez-no not = rez-no 
          move "10" to fs-hesayr
          exit perform cycle
       end-if
 
       if acenfat-kdv = 1
          if acenfat-tarih > "20210930"
             exit perform cycle
          end-if 
       end-if 
       if acenfat-kdv = 8
          if acenfat-tarih < "20211001"
             exit perform cycle
          end-if 
       end-if 


       if hesayr-per - 1 = acenfat-peryod           
           if acebavel-kb-ekle = 1 
              add hesayr-kb-tut       to l-basekle
           end-if
           if acebavel-kkp-ekle = 1 
              add hesayr-kkp-tut      to l-basekle
           end-if 
       end-if
     end-read
     end-perform
     end-start. 
 

 
