* manager4.evt
* manager4.evt is generated from D:\asya\acugt.ytl\otel\manager4.Psf
* This is a generated file. DO NOT modify this file directly.


 Form1-Event-Proc.
     .

 Form1-Exception-Proc.
     PERFORM Form1-Ex-Other
     .
***   start event editor code   ***
*
 Form1-Bef-Create.
    perform adresleri-tasi.
    open input genel
    move 1 to genel-anahtar
    read genel no lock invalid continue
         not invalid continue
    end-read
    close genel.
    move 1 to dis-haric
    move onkpara-doviz to butce-cev-doviz .
    move 1 to reel-gecmis
**********************************************************************pdf conv
    call "c$narg" using link-var
**********************************************************************pdf conv
    move 1 to tumu
    move 0 to ychild
     .
*
 Form1-Aft-Initdata.
    perform Form1-Ef-1-Aft-Procedure

    initialize rap-tar-yazi rap-tar-sayi
    move tarih-tasi to rap-tar-sayi r-ilk-tarih r-son-tarih

    perform rapor-tar-doldur

    move r-ilk-tarih to ilk-tarih
    move r-son-tarih to son-tarih
    move "N"         to rap-tip

    display acc-01 acc-02 acc-03 acc-04 acc-05
            acc-06 acc-07 com-01

*/-----------------------------\*  
*/---------DIL AYARLA----------\*    
*/-----------------------------\*    
     perform dil-ayarla-proc.
*/-----------------------------\*         
     .
*
 Form1-Ex-Other. 
    evaluate key-status
        when 1 
             evaluate control-id
                 when 17
                      initialize acn-grup-kod
                      call "/asya/ytl/obj/otel/grupara.asy" 
                           using "A", acn-grup-kod  
                           on exception 
                              perform callerr-proc
                           not on exception
                              display acc-08
                      end-call
                      move 4 to accept-control
                      move 17 to control-id
                      exit paragraph
                 when 12
                 when 2001
                      initialize acenta-cagir
                      call "/asya/ytl/obj/otel/acenara.asy" 
                           using acenta-cagir  
                           on exception 
                              perform callerr-proc
                           not on exception
                              if acenta-cagir <> spaces
                                 move acenta-cagir to acn-kod
                                 display acc-07
                              end-if
                      end-call
                      move 4 to accept-control
                      move 12 to control-id
                      exit paragraph
             end-evaluate 
        when 33 
             call "/asya/ytl/obj/otel/rezfilt.asy" 
                  using filtre-tasi  
                  on exception 
                     perform callerr-proc
                  not on exception
                     continue
             end-call
             display l-filtre

        when 1301
             if r-ilk-ay = 1 
                move 12      to r-ilk-ay 
                subtract 1 from r-ilk-yil
             else
                subtract 1 from r-ilk-ay
             end-if

             initialize acc-rapor-tar rap-tar-sayi rap-tar-yazi 
             move r-ilk-tarih      to rap-tar-sayi

             perform rapor-tar-doldur

             move r-ilk-tarih      to ilk-tarih
             move r-son-tarih      to son-tarih

             display acc-01 acc-02 acc-03 acc-04 acc-05
                     acc-06 acc-07

        when 1302
             if r-ilk-ay = 12 
                move 1 to r-ilk-ay 
                add  1 to r-ilk-yil
             else
                add  1 to r-ilk-ay
             end-if

             initialize acc-rapor-tar rap-tar-sayi rap-tar-yazi 
             move r-ilk-tarih      to rap-tar-sayi

             perform rapor-tar-doldur

             move r-ilk-tarih      to ilk-tarih
             move r-son-tarih      to son-tarih

             display acc-01 acc-02 acc-03 acc-04 acc-05
                     acc-06 acc-07
        when 2
             perform takas-dosya-ac

             perform takas-doldur 

             perform takas-raporla

             perform takas-dosya-kapat

    end-evaluate 
    .
    
*
 pdf-olustur.
    initialize pdf-link-tum
    move dokumer-dosya               to pdf-dokumer-adres
    call "/asya/ytl/obj/otel/dok2pdf.asy" using  pdf-link-tum 
       on exception 
          perform callerr-proc
          exit paragraph
    not on exception
    cancel "/asya/ytl/obj/otel/dok2pdf.asy"
    end-call.

* 
 cast-oku.
    initialize cast-rec var-yok.
    move takvim-anah to cast-tarih.
    start cast key not < cast-tarih invalid continue
      not invalid
        perform with test after until var
          read cast next no lock end move "V" to var-yok
            not end
              if cast-tarih > takvim-anah
                move "V" to var-yok
               else
                initialize rez-rec
                move cast-rez-no to rez-no
                read rez no lock invalid  if k-kodu-tasi = "ASYA" then stop " " end-if
                  not invalid
                    if filtre-var = 1 then 
                        perform filtre
                        if filtre-gecti = 1 then                           
                           perform takas-kaydet thru takas-kaydet-exit
                        end-if
                      else
                           perform takas-kaydet thru takas-kaydet-exit 
                    end-if                    
                end-read
              end-if
          end-read
        end-perform
    end-start.
 cast-oku-exit.
    exit.
*
*
 gruplari-takasa-ekle2.
    if takas-blok-konumlu = 1 then 
       move takas-blok-konum to rez-oda-konumu rez-fiyat-konumu
       if onkpara-referans-var = 1 then 
          perform ref-filtre
          if not ref-gecti then 
             exit paragraph
          end-if
       end-if
    end-if
  
    
   
    if acn-kod not = spaces and 
       gruplar-acenta not = acn-kod, 
       exit paragraph
    end-if
    
    
    if tumu > 1 then
       move "B" to kodlar02-tipi
       move gruplar-odeme  to kodlar02-kodu
       read kodlar02 no lock invalid 
            move spaces to kodlar02-adi
       end-read
       if (ode-tipi = "D" or  ode-tipi = "F" or  ode-tipi = "O")   and tumu = 2 then
          exit paragraph
       end-if
       if ( ode-tipi not = "D" and ode-tipi not = "F" and ode-tipi not = "O") and tumu = 3 then
          exit paragraph
       end-if
    end-if
   

*** Grup Filtresi

    if acn-grup-kod not = spaces
       initialize grup-rec
       set grup-acenta       to true
       move acn-grup-kod     to grup-kodu
       move gruplar-acenta   to grup-alt
       read grup no lock invalid
            exit paragraph
       end-read
    end-if


    move takas-blok-tarih to takas3-tarih
    read takas3 no lock invalid stop " " end-read 
    compute geklenecek-oda = takas-blok-ayrilan-oda  - takas-blok-satilan-oda
    if geklenecek-oda < 0 then 
       move 0 to geklenecek-oda
    end-if
    compute geklenecek-pax = takas-blok-ayrilan-pax - takas-blok-satilan-pax 
    if gruplar-kalanlar-double = 1 then 
      compute geklenecek-pax = takas-blok-kalan-oda * 2
    end-if
    if geklenecek-pax < 0 then 
       move 0 to geklenecek-pax
    end-if
    compute geklenecek-chi = takas-blok-ayrilan-child - takas-blok-satilan-child
    if geklenecek-chi < 0
       move 0 to geklenecek-chi
    end-if 
                                          
******** ara pazar toplamlari
    compute g-takas3-oda   = g-takas3-oda  +  geklenecek-oda
    compute g-takas3-pax   = g-takas3-pax  +  geklenecek-pax
    compute g-takas3-child = g-takas3-child  +  geklenecek-chi 

    evaluate gruplar-grup-statu                
        when "2"                                     
             add geklenecek-oda  to sS-TAKAS3-O                                            
        when "3"                                   
             add geklenecek-oda  to sS-TAKAS3-t     
        when other
             add geklenecek-oda  to sS-TAKAS3-d   
    end-evaluate

    add geklenecek-pax       to sS-TAKAS3-tpax 
    add geklenecek-chi       to sS-TAKAS3-p

    if takas-blok-gir-oda > 0
       add takas-blok-gir-oda to sS-TAKAS3-giroda
       add takas-blok-gir-pax to sS-TAKAS3-girpax
    end-if
    if gruplar-doviz = butce-cev-doviz  then 
       move takas-blok-kalan-tutar to cevrilmis-deger
    else
       move tarih-tasi to kur-tarih
       move "01" to kur-banka
       move gruplar-doviz to kur-doviz
       read kur no lock invalid
          move 1 to doviz-alis
       end-read
        compute cevrilmis-deger rounded = takas-blok-kalan-tutar * 
              doviz-alis / cevrim-kur-sayisal

     end-if
     add cevrilmis-deger to g-takas3-tutar

     rewrite takas3-rec invalid write takas3-rec end-rewrite.
       .
*
 TAKAS-KAYDET.


    evaluate true
    when rap-tip = "N"
          if rez-durumu not = "I"
                       go takas-kaydet-exit,
         end-if,
         if rez-k-g-b  not = "K" and  not = "O"
               go takas-kaydet-exit,
         end-if,
         if rez-k-g-b   = "O" and info-dahil = 0
                go takas-kaydet-exit,
         end-if
        
    when rap-tip = "W"
         if rez-durumu not = "I"
                       go takas-kaydet-exit,
         end-if,
         if rez-k-g-b      = "K"
                       go takas-kaydet-exit,
         end-if,
    when rap-tip = "S"
         if rez-durumu not = "S"
                       go takas-kaydet-exit,
         end-if.
    if acn-kod not = spaces and 
       rez-acenta not = acn-kod
         go takas-kaydet-exit.

*** Grup Filtresi

    if acn-grup-kod not = spaces
      initialize grup-rec
      set grup-acenta to true
      move acn-grup-kod to grup-kodu
      move rez-acenta   to grup-alt
      read grup no lock
        invalid
          go takas-kaydet-exit
      end-read
    end-if

*** Grup Filtresi
    if tumu > 1 then
          
          move "B" to kodlar02-tipi
          move rez-odeme-tipi to kodlar02-kodu
          read kodlar02 no lock invalid 
              move spaces to kodlar02-adi
          end-read
          if ( ode-tipi = "D" or  ode-tipi = "F" or  ode-tipi = "O")   and tumu = 2 then
              go takas-kaydet-exit
          end-if
          if ( ode-tipi not = "D" and ode-tipi not = "F" and ode-tipi not = "O") and tumu = 3 then
             go takas-kaydet-exit
          end-if

    
    end-if
       move 1 to eklenecek-oda
   
*   TRACE Uygulamasi Acik ise kisi sayilari cast'tan alinacak
   
    if rezpara-trace = 1
       if rez-kisi not = cast-kisi
          move cast-kisi        to rez-kisi
       end-if
         move cast-share        to rez-share
         move cast-oda-no       to rez-odano
         move cast-fiyat-konumu to rez-fiyat-konumu
         move cast-oda-konumu   to rez-oda-konumu


       if rez-share = 1 then 
             move 0 to eklenecek-oda 
            else
              move 1 to eklenecek-oda
          end-if
      else 
          move 1 to eklenecek-oda
    end-if

    if onkpara-referans-var = 1 then 
       perform ref-filtre
       if  not ref-gecti then 
           exit paragraph
       end-if
    end-if

    if rez-odano not = spaces and  ( hayali-haric = 1 or dis-haric = 1 ) then 
              move rez-odano to odalar-anah
              read odalar no lock invalid continue
              not invalid
              if ( odalar-hayali = "H" and hayali-haric = 1 )  then
                       move 0 to eklenecek-oda 
              end-if
               if ( dis-haric = 1 and odalar-dis = 1 )  then
                          go takas-kaydet-exit
              end-if 
              end-read
    end-if  

    if REZ-FOLIO > zeroes
         initialize konuk-rec
         move rez-folio to konuk-folio
         read konuk no lock invalid
                 continue
         not invalid
               if konuk-duzeltme = 1
                   go takas-kaydet-exit
               end-if
         end-read
    end-if

      if fiyat-cik = 1
***************************************
             move rez-no  to takasfiyat-rez-no
             move takvim-anah to takasfiyat-tarih
*               if k-kodu-tasi = "X   " and rez-no = 96 and takvim-anah = "20110609" then stop " " end-if

*             if rez-no = 4172 then 
*               if f= 1 then stop " " end-if
*             end-if
             read takasfiyat no lock 
                invalid
               
                   perform  peryot-fiyat-bul
                   
                    initialize cevrilmis-tl  cevrilmis-deger         
              perform varying jj from 1 by 1 until  jj > 399 
*                if k-kodu-tasi = "X   " and (fiyatt-fiy(jj) not numeric   or fiyatt-fiy(jj) not numeric
*                             or fiyatt-fiy(jj) > 2000   or fiyatt-fiy(jj) > 2000 ) 
*                             stop " "
*                             end-if      
                if fiyatt-tar(jj) = takvim-anah
                
                  if gercek-cin-kuru = 1 then 
                      
                       compute cevrilmis-tl rounded =  fiyatt-fiy(jj) * 
                       fiyatt-kur(jj)
                   
                         if rez-doviz = butce-cev-doviz  then 
                                move  fiyatt-fiy(jj) to cevrilmis-deger
                           else
                              compute cevrilmis-deger rounded =  fiyatt-fiy(jj) * 
                                  fiyatt-kur(jj) / fiyatt-kurcev(jj)

                         end-if
                         
                    else
                       
                       compute cevrilmis-tl rounded =  fiyatt-fiy(jj) * 
                                    fiyatt-kur(jj)  
                      
                         if rez-doviz = butce-cev-doviz  then 
                             move  fiyatt-fiy(jj) to cevrilmis-deger
                           else
                              compute cevrilmis-deger rounded =  fiyatt-fiy(jj) * 
                                   fiyatt-kur(jj) / fiyatt-kurcev(jj)

                         end-if
                       
                  end-if
                     move fiyatt-fiy(jj) to  takasfiyat-fiyat
                  
                end-if
              end-perform  
             
              
              not invalid 
*          if k-kodu-tasi = "X   " and (takasfiyat-fiyat not numeric   or takasfiyat-fiyat not numeric
*                             or takasfiyat-fiyat > 2000   or takasfiyat-fiyat > 2000 )
*                               stop " " 
*                               end-if
                 
                  if gercek-cin-kuru = 1 then 
                      compute cevrilmis-deger rounded =  takasfiyat-fiyat * 
                       takasfiyat-kur / takasfiyat-kurcev 
                       compute cevrilmis-tl rounded =  takasfiyat-fiyat * 
                       takasfiyat-kur
                     
                         if rez-doviz = butce-cev-doviz 
                           move  takasfiyat-fiyat to cevrilmis-deger
                           else
                          compute cevrilmis-deger rounded =  takasfiyat-fiyat * 
                             takasfiyat-kur / takasfiyat-kurcev 

                         end-if

                
                    else
                       
                       compute cevrilmis-deger =  takasfiyat-fiyat *  
                       takasfiyat-kur / takasfiyat-kurcev 
                       compute cevrilmis-tl rounded =  takasfiyat-fiyat *  
                          takasfiyat-kur
                      
                         if rez-doviz = butce-cev-doviz
                           move  takasfiyat-fiyat to cevrilmis-deger
                           else
                          compute cevrilmis-deger rounded =  takasfiyat-fiyat * 
                             takasfiyat-kur / takasfiyat-kurcev 

                         end-if

                   
                  end-if
                    
             end-read
           end-if 

*
****evaluate true
****when takvim-anah = rez-gir-tar,
    if   takvim-anah = rez-gir-tar,
         compute d-takas3-oda   = d-takas3-oda   + eklenecek-oda,
         compute d-takas3-pax   = d-takas3-pax   + rez-buyuk,
         compute d-takas3-child = d-takas3-child + rez-kucuk,
         compute d-takas3-free  = d-takas3-free  + rez-free,
         compute d-takas3-bebek = d-takas3-bebek + rez-bebek,
    end-if.
****when takvim-anah = rez-cik-tar
    if   takvim-anah = rez-cik-tar
         compute t-takas3-oda   = t-takas3-oda   + eklenecek-oda,
         compute t-takas3-pax   = t-takas3-pax   + rez-buyuk,
         compute t-takas3-child = t-takas3-child + rez-kucuk,
         compute t-takas3-free  = t-takas3-free  + rez-free,
         compute t-takas3-bebek = t-takas3-bebek + rez-bebek,
    end-if.

    if   takvim-anah = rez-cik-tar and
         takvim-anah not = rez-gir-tar 
         compute s-takas3-oda   = s-takas3-oda   + eklenecek-oda,
         compute s-takas3-pax   = s-takas3-pax   + rez-buyuk,
         compute s-takas3-child = s-takas3-child + rez-kucuk,
         compute s-takas3-free  = s-takas3-free  + rez-free,
         compute s-takas3-bebek = s-takas3-bebek + rez-bebek,
    end-if.
****when other,
    if   takvim-anah not = rez-gir-tar and 
         takvim-anah not = rez-cik-tar 
         compute s-takas3-oda   = s-takas3-oda   + eklenecek-oda,
         compute s-takas3-pax   = s-takas3-pax   + rez-buyuk,                                        
         compute s-takas3-child = s-takas3-child + rez-kucuk,
         compute s-takas3-free  = s-takas3-free  + rez-free,
         compute s-takas3-bebek = s-takas3-bebek + rez-bebek,
    end-if.
    
    compute g-takas3-oda   = ((s-takas3-oda   + d-takas3-oda)   - t-takas3-oda)
    compute g-takas3-pax   = ((s-takas3-pax   + d-takas3-pax)   - t-takas3-pax)
    compute g-takas3-child = ((s-takas3-child + d-takas3-child) - t-takas3-child)
    compute g-takas3-free  = ((s-takas3-free  + d-takas3-free)  - t-takas3-free)
    compute g-takas3-bebek = ((s-takas3-bebek + d-takas3-bebek) - t-takas3-bebek).
    compute g-takas3-tutar =  g-takas3-tutar +  cevrilmis-deger
    .
 
 takas-kaydet-exit.
                if fiyat-ref > 0 then 
                     move takvim-ref-hazir-oda (fiyat-ref) to  takvim-hazir-oda
                     
                      move takvim-ref-hazir-yatak (fiyat-ref) to  takvim-hazir-yatak
                  end-if
                  if oda-ref > 0 then 
                      move takvim-ref-hazir-oda (oda-ref) to  takvim-hazir-oda  
                      move takvim-ref-hazir-yatak (oda-ref) to  takvim-hazir-yatak
                  end-if
     move takvim-hazir-oda to takas3-hazir-oda.
       
 toplam-al.
    if gruplari-yansit = 0 
       compute top1-oda = top1-oda + sS-TAKAS3-p  
       compute top1-pax = top1-pax +  sS-TAKAS3-O 
       compute top1-chi = top1-chi + sS-TAKAS3-t
       compute top1-fre = top1-fre + sS-TAKAS3-d
       compute top1-beb = top1-beb + sS-TAKAS3-tpax 
    end-if 
    compute top2-oda = top2-oda + d-takas3-oda 
    compute top2-pax = top2-pax + d-takas3-pax
    compute top2-chi = top2-chi + d-takas3-child
    compute top2-fre = top2-fre + d-takas3-free
    compute top2-beb = top2-beb + d-takas3-bebek

    compute top3-oda = top3-oda + t-takas3-oda 
    compute top3-pax = top3-pax + t-takas3-pax
    compute top3-chi = top3-chi + t-takas3-child
    compute top3-fre = top3-fre + t-takas3-free
    compute top3-beb = top3-beb + t-takas3-bebek

    compute top4-oda = top4-oda + g-takas3-oda 
    compute top4-pax = top4-pax + g-takas3-pax
    compute top4-chi = top4-chi + g-takas3-child
    compute top4-fre = top4-fre + g-takas3-free
    compute top4-beb = top4-beb + g-takas3-bebek.

*
 acc-07-Aft-Procedure.
     open input acenta
     if acn-kod = spaces
        move "Tum Acentalar"   to acenta-adi
     else
        move acn-kod    to acenta-kodu
        read acenta no lock invalid
             move "Tanimsiz Acenta ..." to acenta-adi
             move 4 to accept-control
             move 12 to control-id
        end-read
     end-if
     display lb-acenadi.
     close acenta. 
     
     .
*
 acc-08-Aft-Procedure.
     open input grup
     if acn-grup-kod = spaces
        if acn-kod = spaces
           move "Tum Gruplar"   to grup-adi
        end-if
     else
        initialize grup-rec
        set grup-acenta to true
        move acn-grup-kod    to grup-kodu
        read grup no lock invalid
             move "Tanimsiz Acenta Grubu..." to grup-adi
             move 4 to accept-control
             move 17 to control-id
        end-read
        initialize acn-kod
        move "Grup Filtresi" to acenta-adi
        display acc-07 lb-acenadi
     end-if
     display lb-acngrupadi
     close grup
     . 
*
 Form1-Ef-1-Aft-Procedure.
     open input kur doviz 
     move butce-cev-doviz  to doviz-kodu
     read doviz no lock invalid
          display message box  "Tanimsiz Doviz Girdiniz"
          move "Tanimsiz " to d-kisa-adi
     end-read
     move d-kisa-adi       to kur-adi
     move tarih-tasi       to kur-tarih
     move "87"             to kur-banka
     if merkez = 1 then 
        move "01"          to kur-banka
     end-if
     move doviz-kodu       to kur-doviz
     read kur no lock invalid
          move 1           to merkez
          display Form1-Cb-1
          move "01"        to kur-banka
          read kur no lock invalid
               move 1      to doviz-alis
          end-read
     end-read
     move doviz-alis       to cevrim-kuru cevrim-kur-sayisal
     display kdov adov ikur
     close kur doviz.
*
 rapor-tar-doldur.
     open input takvim
     evaluate rap-tar-sayi-ay 
         when 1
              move "OCAK"    to rap-tar-yazi rap-ay-adi
         when 2
              move "SUBAT"   to rap-tar-yazi rap-ay-adi
         when 3
              move "MART"    to rap-tar-yazi rap-ay-adi
         when 4
              move "NISAN"   to rap-tar-yazi rap-ay-adi
         when 5
              move "MAYIS"   to rap-tar-yazi rap-ay-adi
         when 6
              move "HAZIRAN" to rap-tar-yazi rap-ay-adi
         when 7
              move "TEMMUZ"  to rap-tar-yazi rap-ay-adi
         when 8
              move "AGUSTOS" to rap-tar-yazi rap-ay-adi
         when 9
              move "EYLUL"   to rap-tar-yazi rap-ay-adi
         when 10
              move "EKIM"    to rap-tar-yazi rap-ay-adi
         when 11
              move "KASIM"   to rap-tar-yazi rap-ay-adi
         when 12
              move "ARALIK"  to rap-tar-yazi rap-ay-adi
     end-evaluate

     inspect acc-rapor-tar replacing all spaces by low-values 
     inspect rap-tar-yazi  replacing all spaces by low-values 

      string rap-tar-yazi     delimited by low-values
             " - "            delimited by size 
             rap-tar-sayi-yil delimited by size
        into acc-rapor-tar

     inspect acc-rapor-tar replacing all low-values by spaces 

     display acc-1301

     initialize takvim-rec 
     move r-ilk-tarih  to takvim-anah
     start takvim key not < takvim-anah invalid
           continue
     not invalid
     perform with test after until fs-takvim = "10" 
     read takvim next no lock end move "10" to fs-takvim
     not at end 

         if takvim-ay > r-ilk-ay or
            (r-ilk-ay = 12 and
             takvim-ay = 1)
            exit perform
         end-if

         move takvim-anah to r-son-tarih

     end-read 
     end-perform 
     end-start 

     move 1            to r-ilk-gun
     close takvim
     .  
*
 takas-dosya-ac.
     open i-o genelfis
     initialize genelfis-rec 
     move 1 to genelfis-anahtar

     read genelfis no lock invalid 
          move 1 to ekran-fis-1
     end-read
     
     add 1 to ekran-fis-1
     
     move ekran-fis-1(2:) to takyon-no 
     write genelfis-rec invalid 
           rewrite genelfis-rec end-rewrite
     end-write
     close genelfis
     open output takyon close takyon open i-o takyon
     .
*
 takas-doldur. 
     open input takvim cast rez kodlar02 odalar konuk 
                onkasa depkod depkod2 romhrk exthrk merkod
     initialize takvim-rec 
     move ilk-tarih  to takvim-anah 
     start takvim key not < takvim-anah invalid
           continue
     not invalid
     perform with test after until fs-takvim = "10" 
     read takvim next no lock end move "10" to fs-takvim
     not at end 

            if takvim-anah > son-tarih
               exit perform 
            end-if
            
            perform hazir-oda-bilgi-al
            perform cast-bilgi-al
            perform romhrk-bilgi-al
            perform exthrk-bilgi-al
*            perform onkasa-bilgi-al

            perform bos-oda-hesapla                  
            perform doluluk-hesapla
            perform oda-ortalama-hesapla
*            perform gelir-hesapla

     end-read 
     end-perform 
     end-start 


     close takvim cast rez kodlar02 odalar konuk 
           onkasa depkod depkod2 romhrk exthrk merkod
     .
*
 romhrk-bilgi-al.
     initialize romhrk-rec 
     move takvim-anah to romhrk-tarih
     start romhrk key not < romhrk-anah2 invalid
           continue
     not invalid
     perform with test after until fs-romhrk = "10" 
     read romhrk next no lock end move "10" to fs-romhrk
     not at end
        
*         if romhrk-depkod = 101 stop " " end-if
        
 
         if romhrk-tarih <> takvim-anah 
            exit perform 
         end-if

         initialize depkod2-rec 
         move romhrk-depkod   to depkod2-kodu 
         read depkod2 no lock invalid
              exit perform cycle
         end-read 

         if depkod2-alt-kate = "01"
            exit perform cycle
         end-if

         initialize merkod-rec 
         move "DP"                to merkod-tipi
         move depkod2-merkez-kodu to merkod-dep-anah-kodu

         read merkod no lock invalid
              exit perform cycle
         end-read 

         compute ekle-tl-tutar = romhrk-tl-tutar

         initialize takyon-rec 
         move 2                    to takyon-rap-sira 
         move merkod-dep-anah-kodu to takyon-rap-anah2
          add takyon-rap-sira      to takyon-rap-anah2

         read takyon no lock invalid continue end-read 

         compute takyon-gelir(takvim-gun) = 
                 takyon-gelir(takvim-gun) + ekle-tl-tutar 
         compute takyon-gelir(32)         = 
                 takyon-gelir(32)         + ekle-tl-tutar 
         
         write takyon-rec invalid        
               rewrite takyon-rec end-rewrite 
         end-write


     end-read 
     end-perform  
     end-start 
     .
*
 exthrk-bilgi-al.
     initialize exthrk-rec 
     move takvim-anah to exthrk-tarih
     start exthrk key not < exthrk-anah2 invalid
           continue
     not invalid
     perform with test after until fs-exthrk = "10" 
     read exthrk next no lock end move "10" to fs-exthrk
     not at end
 
         if exthrk-tarih <> takvim-anah 
            exit perform 
         end-if

         initialize depkod2-rec 
         move exthrk-depkod   to depkod2-kodu 
         read depkod2 no lock invalid
              exit perform cycle
         end-read 

         if depkod2-alt-kate <> "01"
            exit perform cycle
         end-if

         initialize merkod-rec 
         move "DP"                to merkod-tipi
         move depkod2-merkez-kodu to merkod-dep-anah-kodu

         read merkod no lock invalid
              exit perform cycle
         end-read 

         compute ekle-tl-tutar = exthrk-tl-tutar

         initialize takyon-rec 
         move 2                    to takyon-rap-sira 
         move merkod-dep-anah-kodu to takyon-rap-anah2
          add takyon-rap-sira      to takyon-rap-anah2

         read takyon no lock invalid continue end-read 

         compute takyon-gelir(takvim-gun) = 
                 takyon-gelir(takvim-gun) + ekle-tl-tutar 
         compute takyon-gelir(32)         = 
                 takyon-gelir(32)         + ekle-tl-tutar 
         
         write takyon-rec invalid        
               rewrite takyon-rec end-rewrite 
         end-write


     end-read 
     end-perform  
     end-start 
     .
*
 onkasa-bilgi-al.
    initialize onkasa-rec                               
    move takvim-anah to onkasa-tarih
    start onkasa key not > onkasa-anah invalid
          continue
    not invalid
    perform with test after until fs-onkasa = "10" 
    read onkasa next no lock end move "10" to fs-onkasa
    not at end

        if onkasa-tarih > takvim-anah 
           exit perform  
        end-if
 
        initialize depkod-rec depkod2-rec
        move onkasa-dep to depkod-kodu depkod2-kodu
        read depkod  invalid continue end-read
        read depkod2 invalid continue end-read

        compute ekle-tl-tutar = onkasa-tutar-tl

        evaluate depkod2-alt-kate   
            when "01"
                 initialize takyon-rec 
                 move 2 to takyon-rap-sira
                 move 1 to takyon-rap-anah

                 read takyon no lock invalid continue end-read

                 compute takyon-gelir(takvim-gun) = 
                         takyon-gelir(takvim-gun) + ekle-tl-tutar 
                 compute takyon-gelir(32)         = 
                         takyon-gelir(32)         + ekle-tl-tutar 
             
                 write takyon-rec invalid        
                       rewrite takyon-rec end-rewrite 
                 end-write

            when "02"
            when "03"
                 initialize takyon-rec 
                 move 2 to takyon-rap-sira
                 move 2 to takyon-rap-anah

                 read takyon no lock invalid continue end-read

                 compute takyon-gelir(takvim-gun) = 
                         takyon-gelir(takvim-gun) + ekle-tl-tutar 
                 compute takyon-gelir(32)         = 
                         takyon-gelir(32)         + ekle-tl-tutar 
             
                 write takyon-rec invalid        
                       rewrite takyon-rec end-rewrite 
                 end-write

        end-evaluate

    end-read 
    end-perform 
    end-start   
    .
*
 cast-bilgi-al.
     initialize cast-rec  
     move takvim-anah to cast-tarih

     start cast key not < cast-tarih invalid 
           continue
     not invalid
     perform with test after until fs-cast = "10"
     read cast next no lock end move "10" to fs-cast
     not at end

         if cast-tarih > takvim-anah
            exit perform 
         end-if

         initialize rez-rec
         move cast-rez-no to rez-no

         read rez no lock invalid  

              if k-kodu-tasi = "ASYA" then stop " " end-if

         end-read 

         if filtre-var = 1  
            perform filtre

            if filtre-gecti = 0                            
               exit perform cycle 
            end-if
         end-if   
         
         perform kaydet-kontrol 

         if gecme = 1 
            exit perform cycle
         end-if

         initialize oda-ekle-tutar pan-ekle-tutar
         compute oda-ekle-tutar = cast-basilan-fiyat

         perform varying xiii from 2 by 1 until xiii > 15
            if cast-br-malzeme-tut(xiii) = 0 
               exit perform 
            end-if
            compute pan-ekle-tutar = pan-ekle-tutar + cast-br-malzeme-tut(xiii)
         end-perform 


         initialize takyon-rec
         move 1           to takyon-rap-sira
         move 3           to takyon-rap-anah

         read takyon no lock invalid continue end-read 

         if takvim-anah = rez-gir-tar
            compute takyon-oda-sayi-d(takvim-gun)
                  = takyon-oda-sayi-d(takvim-gun)  + eklenecek-oda 
            compute takyon-oda-sayi-d(32)
                  = takyon-oda-sayi-d(32)          + eklenecek-oda 
         end-if

         if takvim-anah = rez-cik-tar
            compute takyon-oda-sayi-t(takvim-gun)
                  = takyon-oda-sayi-t(takvim-gun)  + eklenecek-oda
            compute takyon-oda-sayi-t(32)
                  = takyon-oda-sayi-t(32)          + eklenecek-oda 
         end-if

         if takvim-anah not = rez-gir-tar and
            takvim-anah     = rez-cik-tar 
            compute takyon-oda-sayi-s(takvim-gun)
                  = takyon-oda-sayi-s(takvim-gun)  + eklenecek-oda 
            compute takyon-oda-sayi-s(32)
                  = takyon-oda-sayi-s(32)          + eklenecek-oda 
         end-if 

         if takvim-anah not = rez-gir-tar and 
            takvim-anah not = rez-cik-tar 
            compute takyon-oda-sayi-s(takvim-gun)
                  = takyon-oda-sayi-s(takvim-gun)  + eklenecek-oda 
            compute takyon-oda-sayi-s(32)
                  = takyon-oda-sayi-s(32)          + eklenecek-oda 
         end-if
    
         compute takyon-oda-sayi(takvim-gun)   
               = ((takyon-oda-sayi-s(takvim-gun) + takyon-oda-sayi-d(takvim-gun)) - takyon-oda-sayi-t(takvim-gun))
         compute takyon-oda-sayi(32)   
               = ((takyon-oda-sayi-s(32)         + takyon-oda-sayi-d(32))         - takyon-oda-sayi-t(32))

         write takyon-rec invalid
               rewrite takyon-rec end-rewrite 
         end-write 




         initialize takyon-rec
         move 1           to takyon-rap-sira
         move 4           to takyon-rap-anah

         read takyon no lock invalid continue end-read 

         evaluate ychild(1:1)
             when 0
                  compute eklenecek-kisi = rez-buyuk
             when 1
                  compute eklenecek-kisi = rez-buyuk + rez-kucuk
             when 2
                  compute eklenecek-kisi = rez-buyuk + rez-kucuk + rez-free
             when 3
                  compute eklenecek-kisi = rez-buyuk + rez-kucuk + rez-free + rez-bebek
         end-evaluate

         if takvim-anah = rez-gir-tar

            compute takyon-kisi-sayi-d(takvim-gun)
                  = takyon-kisi-sayi-d(takvim-gun) + eklenecek-kisi
            compute takyon-p-sayi-d(takvim-gun)
                  = takyon-p-sayi-d(takvim-gun)    + rez-buyuk 
            compute takyon-c-sayi-d(takvim-gun)
                  = takyon-c-sayi-d(takvim-gun)    + rez-kucuk 
            compute takyon-f-sayi-d(takvim-gun)
                  = takyon-f-sayi-d(takvim-gun)    + rez-free 
            compute takyon-b-sayi-d(takvim-gun)
                  = takyon-b-sayi-d(takvim-gun)    + rez-bebek
            compute takyon-kisi-sayi-d(32)
                  = takyon-kisi-sayi-d(32)         + eklenecek-kisi
            compute takyon-p-sayi-d(32)
                  = takyon-p-sayi-d(32)            + rez-buyuk 
            compute takyon-c-sayi-d(32)
                  = takyon-c-sayi-d(32)            + rez-kucuk 
            compute takyon-f-sayi-d(32)
                  = takyon-f-sayi-d(32)            + rez-free 
            compute takyon-b-sayi-d(32)
                  = takyon-b-sayi-d(32)            + rez-bebek 
         end-if

         if takvim-anah = rez-cik-tar
            compute takyon-kisi-sayi-t(takvim-gun)
                  = takyon-kisi-sayi-t(takvim-gun) + eklenecek-kisi
            compute takyon-p-sayi-t(takvim-gun)
                  = takyon-p-sayi-t(takvim-gun)    + rez-buyuk 
            compute takyon-c-sayi-t(takvim-gun)
                  = takyon-c-sayi-t(takvim-gun)    + rez-kucuk 
            compute takyon-f-sayi-t(takvim-gun)
                  = takyon-f-sayi-t(takvim-gun)    + rez-free 
            compute takyon-b-sayi-t(takvim-gun)
                  = takyon-b-sayi-t(takvim-gun)    + rez-bebek
            compute takyon-kisi-sayi-t(32)              
                  = takyon-kisi-sayi-t(32)         + eklenecek-kisi
            compute takyon-p-sayi-t(32)
                  = takyon-p-sayi-t(32)            + rez-buyuk 
            compute takyon-c-sayi-t(32)
                  = takyon-c-sayi-t(32)            + rez-kucuk 
            compute takyon-f-sayi-t(32)
                  = takyon-f-sayi-t(32)            + rez-free 
            compute takyon-b-sayi-t(32)
                  = takyon-b-sayi-t(32)            + rez-bebek 
         end-if

         if takvim-anah     = rez-cik-tar and
            takvim-anah not = rez-gir-tar 
            compute takyon-kisi-sayi-s(takvim-gun)
                  = takyon-kisi-sayi-s(takvim-gun) + eklenecek-kisi
            compute takyon-p-sayi-s(takvim-gun)
                  = takyon-p-sayi-s(takvim-gun)    + rez-buyuk 
            compute takyon-c-sayi-s(takvim-gun)
                  = takyon-c-sayi-s(takvim-gun)    + rez-kucuk 
            compute takyon-f-sayi-s(takvim-gun)
                  = takyon-f-sayi-s(takvim-gun)    + rez-free 
            compute takyon-b-sayi-s(takvim-gun)
                  = takyon-b-sayi-s(takvim-gun)    + rez-bebek 
            compute takyon-kisi-sayi-s(32)             
                  = takyon-kisi-sayi-s(32)         + eklenecek-kisi
            compute takyon-p-sayi-s(32)
                  = takyon-p-sayi-s(32)            + rez-buyuk 
            compute takyon-c-sayi-s(32)
                  = takyon-c-sayi-s(32)            + rez-kucuk 
            compute takyon-f-sayi-s(32)
                  = takyon-f-sayi-s(32)            + rez-free 
            compute takyon-b-sayi-s(32)
                  = takyon-b-sayi-s(32)            + rez-bebek 
         end-if 

         if takvim-anah not = rez-gir-tar and 
            takvim-anah not = rez-cik-tar 
            compute takyon-kisi-sayi-s(takvim-gun)
                  = takyon-kisi-sayi-s(takvim-gun) + eklenecek-kisi
            compute takyon-p-sayi-s(takvim-gun)
                  = takyon-p-sayi-s(takvim-gun)    + rez-buyuk 
            compute takyon-c-sayi-s(takvim-gun)
                  = takyon-c-sayi-s(takvim-gun)    + rez-kucuk 
            compute takyon-f-sayi-s(takvim-gun)
                  = takyon-f-sayi-s(takvim-gun)    + rez-free 
            compute takyon-b-sayi-s(takvim-gun)
                  = takyon-b-sayi-s(takvim-gun)    + rez-bebek 
            compute takyon-kisi-sayi-s(32)
                  = takyon-kisi-sayi-s(32)         + eklenecek-kisi
            compute takyon-p-sayi-s(32)
                  = takyon-p-sayi-s(32)            + rez-buyuk 
            compute takyon-c-sayi-s(32)
                  = takyon-c-sayi-s(32)            + rez-kucuk 
            compute takyon-f-sayi-s(32)
                  = takyon-f-sayi-s(32)            + rez-free 
            compute takyon-b-sayi-s(32)
                  = takyon-b-sayi-s(32)            + rez-bebek 
         end-if
    
         compute takyon-kisi-sayi(takvim-gun)   
               = ((takyon-kisi-sayi-s(takvim-gun) + takyon-kisi-sayi-d(takvim-gun)) - takyon-kisi-sayi-t(takvim-gun))
         compute takyon-p-sayi(takvim-gun)      
               = ((takyon-p-sayi-s(takvim-gun)    + takyon-p-sayi-d(takvim-gun))    - takyon-p-sayi-t(takvim-gun))
         compute takyon-c-sayi(takvim-gun)      
               = ((takyon-c-sayi-s(takvim-gun)    + takyon-c-sayi-d(takvim-gun))    - takyon-c-sayi-t(takvim-gun))
         compute takyon-f-sayi(takvim-gun)      
               = ((takyon-f-sayi-s(takvim-gun)    + takyon-f-sayi-d(takvim-gun))    - takyon-f-sayi-t(takvim-gun))
         compute takyon-b-sayi(takvim-gun)      
               = ((takyon-b-sayi-s(takvim-gun)    + takyon-b-sayi-d(takvim-gun))    - takyon-b-sayi-t(takvim-gun))
         compute takyon-kisi-sayi(32)   
               = ((takyon-kisi-sayi-s(32)         + takyon-kisi-sayi-d(32))         - takyon-kisi-sayi-t(32))
         compute takyon-p-sayi(32)      
               = ((takyon-p-sayi-s(32)            + takyon-p-sayi-d(32))            - takyon-p-sayi-t(32))
         compute takyon-c-sayi(32)      
               = ((takyon-c-sayi-s(32)            + takyon-c-sayi-d(32))            - takyon-c-sayi-t(32))
         compute takyon-f-sayi(32)      
               = ((takyon-f-sayi-s(32)            + takyon-f-sayi-d(32))            - takyon-f-sayi-t(32))
         compute takyon-b-sayi(32)      
               = ((takyon-b-sayi-s(32)            + takyon-b-sayi-d(32))            - takyon-b-sayi-t(32))

         write takyon-rec invalid
               rewrite takyon-rec end-rewrite 
         end-write 


         initialize takyon-rec                                                            
         move 2         to takyon-rap-sira
         move 1         to takyon-rap-anah2
        
         read takyon no lock invalid continue end-read 
        
         compute takyon-gelir(takvim-gun)   
               = takyon-gelir(takvim-gun) + oda-ekle-tutar
         compute takyon-gelir(32)   
               = takyon-gelir(32) + oda-ekle-tutar
 
         write takyon-rec invalid
               rewrite takyon-rec end-rewrite 
         end-write 

         initialize takyon-rec 
         move 2         to takyon-rap-sira
         move 2         to takyon-rap-anah2
        
         read takyon no lock invalid continue end-read 
        
         compute takyon-gelir(takvim-gun)   
               = takyon-gelir(takvim-gun) + pan-ekle-tutar
         compute takyon-gelir(32)   
               = takyon-gelir(32) + pan-ekle-tutar
 
         write takyon-rec invalid
               rewrite takyon-rec end-rewrite 
         end-write 



         initialize takyon-rec 
         move 3         to takyon-rap-sira
         move rez-pazar to takyon-rap-anah
        
         read takyon no lock invalid continue end-read 
        
         compute takyon-oda-sayi(takvim-gun)   
               = takyon-oda-sayi(takvim-gun) + eklenecek-oda
         compute takyon-oda-sayi(32)   
               = takyon-oda-sayi(32) + eklenecek-oda
 
         write takyon-rec invalid
               rewrite takyon-rec end-rewrite 
         end-write 



         initialize takyon-rec
         move 4         to takyon-rap-sira 
         evaluate rez-buyuk
             when 1
                  move 1           to takyon-rap-anah
             when 2
                  move 2           to takyon-rap-anah
         end-evaluate 

         read takyon no lock invalid continue end-read 
         
         if takvim-anah = rez-gir-tar
            compute takyon-oda-sayi-d(takvim-gun)
                  = takyon-oda-sayi-d(takvim-gun)  + eklenecek-oda 
            compute takyon-oda-sayi-d(32)
                  = takyon-oda-sayi-d(32)          + eklenecek-oda 
         end-if
         
         if takvim-anah = rez-cik-tar
            compute takyon-oda-sayi-t(takvim-gun)
                  = takyon-oda-sayi-t(takvim-gun)  + eklenecek-oda
            compute takyon-oda-sayi-t(32)
                  = takyon-oda-sayi-t(32)          + eklenecek-oda 
         end-if
         
         if takvim-anah     = rez-cik-tar and
            takvim-anah not = rez-gir-tar 
            compute takyon-oda-sayi-s(takvim-gun)
                  = takyon-oda-sayi-s(takvim-gun)  + eklenecek-oda 
            compute takyon-oda-sayi-s(32)
                  = takyon-oda-sayi-s(32)          + eklenecek-oda 
         end-if 
         
         if takvim-anah not = rez-gir-tar and 
            takvim-anah not = rez-cik-tar 
            compute takyon-oda-sayi-s(takvim-gun)
                  = takyon-oda-sayi-s(takvim-gun)  + eklenecek-oda 
            compute takyon-oda-sayi-s(32)
                  = takyon-oda-sayi-s(32)          + eklenecek-oda 
         end-if
         
         compute takyon-oda-sayi(takvim-gun)   
               = ((takyon-oda-sayi-s(takvim-gun) + takyon-oda-sayi-d(takvim-gun)) - takyon-oda-sayi-t(takvim-gun))
         compute takyon-oda-sayi(32)   
               = ((takyon-oda-sayi-s(32)         + takyon-oda-sayi-d(32))         - takyon-oda-sayi-t(32))
         
         write takyon-rec invalid
               rewrite takyon-rec end-rewrite 
         end-write 

     end-read
     end-perform
     end-start
     .
*
 hazir-oda-bilgi-al.
     initialize takyon-rec                                                   
     move 1           to takyon-rap-sira
     move 1           to takyon-rap-anah
     read takyon no lock invalid continue end-read 
          

     if fiyat-ref > 0   
        move takvim-ref-hazir-oda (fiyat-ref)   to takvim-hazir-oda                     
        move takvim-ref-hazir-yatak (fiyat-ref) to takvim-hazir-yatak
     end-if
     if oda-ref > 0   
        move takvim-ref-hazir-oda (oda-ref)     to takvim-hazir-oda  
        move takvim-ref-hazir-yatak (oda-ref)   to takvim-hazir-yatak
     end-if
       
     compute takyon-oda-sayi(takvim-gun) 
           = takyon-oda-sayi(takvim-gun) + takvim-hazir-oda
     compute takyon-oda-sayi(32)      
           = takyon-oda-sayi(32)         + takvim-hazir-oda

     write takyon-rec invalid
           rewrite takyon-rec end-rewrite 
     end-write       
     .
*
 kaydet-kontrol.
     initialize gecme
     evaluate true
         when rap-tip = "N"
              if rez-durumu not = "I"
                 move 1 to gecme
              end-if
              if rez-k-g-b not = "K" and  
                 rez-k-g-b not = "O"
                 move 1 to gecme
              end-if,
              if rez-k-g-b  = "O" and 
                 info-dahil = 0
                 move 1 to gecme
              end-if
        
         when rap-tip = "W"
              if rez-durumu not = "I"
                 move 1 to gecme
              end-if 
              if rez-k-g-b = "K"
                 move 1 to gecme
              end-if 

         when rap-tip = "S"
              if rez-durumu not = "S"
                 move 1 to gecme
              end-if 
     end-evaluate
     if acn-kod    not = spaces and 
        rez-acenta not = acn-kod
        move 1 to gecme
     end-if

*** Grup Filtresi
     if acn-grup-kod not = spaces
        initialize grup-rec
        set grup-acenta to true
        move acn-grup-kod to grup-kodu
        move rez-acenta   to grup-alt

        read grup no lock invalid
             move 1 to gecme
        end-read
     end-if
*** Grup Filtresi

     if tumu > 1 then
        move "B"            to kodlar02-tipi
        move rez-odeme-tipi to kodlar02-kodu

        read kodlar02 no lock invalid 
            move spaces to kodlar02-adi
        end-read

        if (ode-tipi = "D" or  
            ode-tipi = "F" or  
            ode-tipi = "O") and 
            tumu     = 2 
            move 1 to gecme
        end-if
        if (ode-tipi not = "D" and 
            ode-tipi not = "F" and 
            ode-tipi not = "O") and 
            tumu         = 3 
           move 1 to gecme
        end-if
     end-if

     move 1 to eklenecek-oda
   
*   TRACE Uygulamasi Acik ise kisi sayilari cast'tan alinacak
   
     if rezpara-trace = 1
        if rez-kisi not = cast-kisi
           move cast-kisi        to rez-kisi
        end-if

        move cast-share        to rez-share
        move cast-oda-no       to rez-odano
        move cast-fiyat-konumu to rez-fiyat-konumu
        move cast-oda-konumu   to rez-oda-konumu

        if rez-share = 1 then 
           move 0 to eklenecek-oda 
        else
           move 1 to eklenecek-oda
        end-if
     else 
        move 1 to eklenecek-oda
     end-if

     if onkpara-referans-var = 1 then 
        perform ref-filtre
        if not ref-gecti then 
           move 1 to gecme
        end-if
     end-if

     if rez-odano not = spaces and  ( hayali-haric = 1 or dis-haric = 1 ) then 
        move rez-odano to odalar-anah
        read odalar no lock invalid 
             continue
        not invalid
            if (odalar-hayali = "H" and 
                hayali-haric  = 1 )  
                move 0 to eklenecek-oda 
            end-if
    
            if (dis-haric  = 1 and 
                odalar-dis = 1 )  
                move 1 to gecme
            end-if 
        end-read
     end-if  
    
     if rez-folio > zeroes
        initialize konuk-rec
        move rez-folio to konuk-folio
    
        read konuk no lock invalid
             continue
        not invalid
            if konuk-duzeltme = 1
               move 1 to gecme
            end-if
        end-read
     end-if
    
     if fiyat-cik = 1
        move rez-no      to takasfiyat-rez-no
        move takvim-anah to takasfiyat-tarih
    
        read takasfiyat no lock invalid
             perform  peryot-fiyat-bul
             initialize cevrilmis-tl  cevrilmis-deger         
             perform varying jj from 1 by 1 until  jj > 399 
                if fiyatt-tar(jj) = takvim-anah
                   if gercek-cin-kuru = 1   
                      compute cevrilmis-tl rounded 
                            = fiyatt-fiy(jj) * fiyatt-kur(jj)
                    
                      if rez-doviz = butce-cev-doviz    
                         move fiyatt-fiy(jj) to cevrilmis-deger
 
                      else
                         compute cevrilmis-deger rounded 
                               = fiyatt-fiy(jj) * fiyatt-kur(jj) / fiyatt-kurcev(jj)
                      end-if
 
                   else
                      compute cevrilmis-tl rounded 
                            = fiyatt-fiy(jj) * fiyatt-kur(jj)  
                       
                      if rez-doviz = butce-cev-doviz    
                         move fiyatt-fiy(jj) to cevrilmis-deger
 
                      else
                         compute cevrilmis-deger rounded 
                               = fiyatt-fiy(jj) * fiyatt-kur(jj) / fiyatt-kurcev(jj)
                      end-if
                   end-if
 
                   move fiyatt-fiy(jj) to  takasfiyat-fiyat
                end-if
             end-perform  
 
        not invalid 
            if gercek-cin-kuru = 1   
               compute cevrilmis-deger rounded 
                     = takasfiyat-fiyat * takasfiyat-kur / takasfiyat-kurcev 
               compute cevrilmis-tl rounded 
                     = takasfiyat-fiyat * takasfiyat-kur
                      
               if rez-doviz = butce-cev-doviz 
                  move  takasfiyat-fiyat to cevrilmis-deger
                            
               else
                  compute cevrilmis-deger rounded 
                        = takasfiyat-fiyat * takasfiyat-kur / takasfiyat-kurcev 
               end-if
 
            else
               compute cevrilmis-deger 
                     = takasfiyat-fiyat * takasfiyat-kur / takasfiyat-kurcev 
               compute cevrilmis-tl rounded 
                     = takasfiyat-fiyat * takasfiyat-kur
                       
               if rez-doviz = butce-cev-doviz
                  move takasfiyat-fiyat to cevrilmis-deger
 
               else
                  compute cevrilmis-deger rounded 
                        = takasfiyat-fiyat * takasfiyat-kur / takasfiyat-kurcev 
               end-if
            end-if
        end-read
     end-if 
     .
*
 takas-raporla.
     open i-o genelfis kodlar02 merkod
     move 1 to genelfis-anahtar
     read genelfis no lock invalid
          accept print-no from time
     not invalid
          add 1 to print-no
          rewrite genelfis-rec end-rewrite
     end-read
     close genelfis
     initialize dokumer-rec dokumer-anah dokumer-ozellikler-rec
                dokumer-dosya

     set  dokumer-asya-set to true
     move print-no         to dokumer-dosya-adi
     open output dokumer

*/WINDOW TITLE
     initialize dokumer-rec detay
     move "W"                    to det-dokumer-20(1:)
     move "Yonetim Raporu" to det-filler
     write dokumer-rec from detay
*/ BASLIKLAR
     initialize dokumer-rec detay
     move "B"                    to det-dokumer-20(1:)
     move "Yonetim Raporu" to det-filler
     write dokumer-rec from detay
     initialize dokumer-rec detay
     move "B"                    to det-dokumer-20(1:)
     write dokumer-rec from detay

*/ DOKUMER OZELLIKLER-REC
     initialize dokumer-rec detay
     move "O"                    to det-dokumer-20(1:)
     move "E" to dokumer-oto-sayfa-basi
     move 56  to dokumer-oto-sayfa-satir
     move "|" to dokumer-detay-kolon-ayirici
     move "LRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRR" to dokumer-align-occ
     move dokumer-ozellikler-rec     to det-filler
     write dokumer-rec from detay
*/ BASLIKLAR 
     initialize dokumer-rec detay
     move "D1"                      to det-dokumer-20(1:) 

     perform baslik-at

     initialize dokumer-rec detay
     move "D2"         to det-dokumer-20(1:)     
     move "-"          to det-dokumer-20(5:1)
     move all "-" to det-1 det-2 det-3
     write dokumer-rec from detay

*     stop " " 
     initialize takyon-rec 
     move 1  to ilk-deger
     start takyon key not < takyon-anah invalid
           continue
     not invalid
     perform with test after until fs-takyon = "10" 
     read takyon next no lock end move "10" to fs-takyon 
     not at end

         initialize dokumer-rec detay
         evaluate takyon-rap-sira
             when 1
                  evaluate takyon-rap-anah
                      when 1
                           move "Toplam Oda"               to det-1 
                      when 2 
                           move "Bos Oda"                  to det-1 
                      when 3 
                           move "Satilan Oda"              to det-1 
                      when 4 
                           move "Kisi Sayisi"              to det-1 
                      when 5 
                           move "Doluluk Orani (%)"        to det-1 
                      when 6 
                           move "Oda Ort. Kisi Sayisi"     to det-1
                      when 7
                           move "Ort. Oda Satis Fiyati"    to det-1
                  end-evaluate
             when 2
                  if takyon-rap-anah2 = 1 
                     perform baslik-at
                     initialize dokumer-rec detay 
                  end-if
                  evaluate takyon-rap-anah2
                      when 1
                           move "Oda Konaklama"          to det-1 
                      when 2 
                           move "Pansiyon"               to det-1 
                      when other
                           initialize merkod-rec 
                           move "DP"                     to merkod-tipi 
                           move takyon-rap-anah2         to merkod-dep-anah-kodu
                           subtract 2                  from merkod-dep-anah-kodu
                           read merkod no lock invalid 
                                move "Tanimzsiz.."       to merkod-dep-dig-adi
                           end-read 
                           move merkod-dep-dig-adi       to det-1
                  end-evaluate
             when 3
                  if ilk-deger = 1 
                     perform baslik-at
                     initialize dokumer-rec detay 
                     move 0 to ilk-deger
                  end-if
                  initialize kodlar02-rec
                  move "E"                                 to kodlar02-tipi
                  move takyon-rap-anah(1:2)                to kodlar02-kodu

                  read kodlar02 no lock invalid 
                       move "Tanimsiz Pazar"               to kodlar02-adi 
                  end-read

                  move kodlar02-adi                        to det-1 
             when 4
                  if takyon-rap-anah = 1 
                     perform baslik-at
                     initialize dokumer-rec detay 
                  end-if
                  evaluate takyon-rap-anah
                      when 1
                           move "Tek Kisilik Oda"          to det-1 
                      when 2 
                           move "Cift Kisilik Oda"         to det-1 
                  end-evaluate

             when other
                  exit perform cycle
         end-evaluate

         evaluate takyon-rap-sira
             when 1
                  evaluate takyon-rap-anah
                      when 1
                      when 2 
                      when 3 
                           move takyon-oda-sayi(32) to z-5
                           move z-5                 to det-2
                           move 1                   to sutun-say
                           
                           perform varying xiii from 1 by 1 until xiii > 31
                              move takyon-oda-sayi(xiii) to z-5
                              move z-5                   to det-3(sutun-say:12)
                           
                              compute sutun-say = sutun-say + 12
                           
                              if xiii < 31 
                                 move "|"    to det-3(sutun-say:1) 
                                 compute sutun-say = sutun-say + 1 
                              end-if
                           
                           end-perform
                      when 4 
                           move takyon-kisi-sayi(32) to z-6
                           move z-6                  to det-2
                           move 1                    to sutun-say
                           
                           perform varying xiii from 1 by 1 until xiii > 31
                              move takyon-kisi-sayi(xiii) to z-6
                              move z-6                    to det-3(sutun-say:12)
                           
                              compute sutun-say = sutun-say + 12
                           
                              if xiii < 31 
                                 move "|"    to det-3(sutun-say:1) 
                                 compute sutun-say = sutun-say + 1 
                              end-if
                           
                           end-perform
                      when 5 
                           move "Doluluk Orani (%)"        to det-1 
                      when 6 
                           move "Oda Ort. Kisi Sayisi"     to det-1
                      when 7
                           move takyon-yuzde(32)       to z-yuzde
                           move z-yuzde                to det-2
                           move 1                      to sutun-say
                        
                           perform varying xiii from 1 by 1 until xiii > 31
                              move takyon-yuzde(xiii)   to z-yuzde
                              move z-yuzde              to det-3(sutun-say:12)
                           
                              compute sutun-say = sutun-say + 12
                           
                              if xiii < 31 
                                 move "|"    to det-3(sutun-say:1) 
                                 compute sutun-say = sutun-say + 1 
                              end-if
                           
                           end-perform
                  end-evaluate
             when 2
                  move takyon-gelir(32)       to z-tutar
                  move z-tutar                to det-2
                  move 1                      to sutun-say
               
                  perform varying xiii from 1 by 1 until xiii > 31
                     move takyon-gelir(xiii)   to z-tutar
                     move z-tutar              to det-3(sutun-say:12)
                  
                     compute sutun-say = sutun-say + 12
                  
                     if xiii < 31 
                        move "|"    to det-3(sutun-say:1) 
                        compute sutun-say = sutun-say + 1 
                     end-if
                  
                  end-perform
             when 3 
             when 4
                  move takyon-oda-sayi(32) to z-5
                  move z-5                 to det-2
                  move 1                   to sutun-say
                  
                  perform varying xiii from 1 by 1 until xiii > 31
                     move takyon-oda-sayi(xiii) to z-5
                     move z-5                   to det-3(sutun-say:12)
                  
                     compute sutun-say = sutun-say + 12
                  
                     if xiii < 31 
                        move "|"    to det-3(sutun-say:1) 
                        compute sutun-say = sutun-say + 1 
                     end-if
                  
                  end-perform
         end-evaluate

         write dokumer-rec from detay

     end-read 
     end-perform
     end-start 

     initialize dokumer-rec detay
     move "-"          to det-dokumer-20(5:1)
     move all "-"      to det-1 det-2 det-3 
     write dokumer-rec from detay

     close dokumer kodlar02 merkod
     call dokumer-prog on exception
          perform callerr-proc
     not on exception
          cancel dokumer-prog
     end-call
     delete file dokumer.
     .
*
 baslik-at.   
     initialize det-1 det-2 det-3
     evaluate takyon-rap-sira 
         when 2
              move "MISAFIR GELIR DAGILIMLARI" to det-1 

         when 3
              move "MISAFIR PAZAR DAGILIMLARI" to det-1 

         when 4
              move "MISAFIR ODA DAGILIMLARI"   to det-1 

         when other
              move "DAGILIM \ TARIH"           to det-1 
     end-evaluate

     inspect det-2         replacing all spaces by low-values 
     inspect rap-ay-adi    replacing all spaces by low-values 
      string rap-ay-adi    delimited by low-values
             " TOPLAM"     delimited by size 
        into det-2
     inspect det-2         replacing all low-values by spaces 

     move 1 to sutun-say

     perform varying xiii from 1 by 1 until xiii > 31
        inspect det-3(sutun-say:12)     replacing all spaces by low-values 
        inspect rap-ay-adi              replacing all spaces by low-values 
         string xiii                    delimited by size
                " - "                   delimited by size 
                rap-ay-adi(1:3)         delimited by low-values 
           into det-3(sutun-say:12)
        inspect det-3(sutun-say:12)     replacing all low-values by spaces 

        compute sutun-say = sutun-say + 12

        if xiii < 31 
           move "|"    to det-3(sutun-say:1) 
           compute sutun-say = sutun-say + 1 
        end-if

     end-perform

     move all "|"     to fil-1 fil-2 fil-3
     move "A"         to det-dokumer-20(3:1)
     move 257         to det-renk1
     move "1"         to det-dokumer-20(10:1)
     write dokumer-rec from detay
     .
*
 takas-dosya-kapat.
     close takyon
     delete file takyon
     .
*
 bos-oda-hesapla.
     initialize takyon-rec hes-1 hes-2                       || bos oda 
     move 1           to takyon-rap-sira
     move 1           to takyon-rap-anah
     read takyon no lock invalid continue end-read 
     move takyon-oda-sayi(takvim-gun) to hes-1
     
*     initialize takyon-rec
     move 3           to takyon-rap-anah
     read takyon no lock invalid continue end-read 
     move takyon-oda-sayi(takvim-gun) to hes-2
     
*     initialize takyon-rec
     move 2           to takyon-rap-anah
     read takyon no lock invalid continue end-read 
     compute takyon-oda-sayi(takvim-gun) = hes-1 - hes-2
     write takyon-rec invalid
           rewrite takyon-rec end-rewrite 
     end-write 
     
     initialize takyon-rec hes-1 hes-2
     move 1           to takyon-rap-sira
     move 1           to takyon-rap-anah
     read takyon no lock invalid continue end-read 
     move takyon-oda-sayi(32) to hes-1
     
*     initialize takyon-rec
     move 3           to takyon-rap-anah
     read takyon no lock invalid continue end-read 
     move takyon-oda-sayi(32) to hes-2
     
*     initialize takyon-rec
     move 2           to takyon-rap-anah
     read takyon no lock invalid continue end-read 
     compute takyon-oda-sayi(32) = hes-1 - hes-2
     write takyon-rec invalid
           rewrite takyon-rec end-rewrite 
     end-write 
     .
*
 doluluk-hesapla.
     initialize takyon-rec hes-1 hes-2                       || doluluk 
     move 1           to takyon-rap-sira
     move 3           to takyon-rap-anah
     read takyon no lock invalid continue end-read 
     move takyon-oda-sayi(takvim-gun) to hes-1
     
*     initialize takyon-rec
     move 1           to takyon-rap-anah
     read takyon no lock invalid continue end-read 
     move takyon-oda-sayi(takvim-gun) to hes-2
     
*     initialize takyon-rec
     move 5           to takyon-rap-anah
     read takyon no lock invalid continue end-read 
     compute takyon-yuzde(takvim-gun) = (hes-1 / hes-2) * 100
     write takyon-rec invalid
           rewrite takyon-rec end-rewrite 
     end-write 
     
     initialize takyon-rec hes-1 hes-2
     move 1           to takyon-rap-sira
     move 3           to takyon-rap-anah
     read takyon no lock invalid continue end-read 
     move takyon-oda-sayi(32) to hes-1
     
*     initialize takyon-rec
     move 1           to takyon-rap-anah
     read takyon no lock invalid continue end-read 
     move takyon-oda-sayi(32) to hes-2
     
*     initialize takyon-rec
     move 5           to takyon-rap-anah
     read takyon no lock invalid continue end-read 
     compute takyon-yuzde(32) = (hes-1 / hes-2) * 100
     write takyon-rec invalid
           rewrite takyon-rec end-rewrite 
     end-write 
     .
*
 oda-ortalama-hesapla.
     initialize takyon-rec hes-1 hes-2                       || oda ortalama kisi sayisi 
     move 1           to takyon-rap-sira
     move 4           to takyon-rap-anah
     read takyon no lock invalid continue end-read 
     move takyon-kisi-sayi(takvim-gun) to hes-1
     
*     initialize takyon-rec
     move 3           to takyon-rap-anah
     read takyon no lock invalid continue end-read 
     move takyon-oda-sayi(takvim-gun) to hes-2
     
*     initialize takyon-rec
     move 6           to takyon-rap-anah
     read takyon no lock invalid continue end-read 
     compute takyon-yuzde(takvim-gun) = hes-1 / hes-2 
     write takyon-rec invalid
           rewrite takyon-rec end-rewrite 
     end-write 
     
     initialize takyon-rec hes-1 hes-2
     move 1           to takyon-rap-sira
     move 4           to takyon-rap-anah
     read takyon no lock invalid continue end-read 
     move takyon-kisi-sayi(32) to hes-1
     
*     initialize takyon-rec
     move 3           to takyon-rap-anah
     read takyon no lock invalid continue end-read 
     move takyon-oda-sayi(32) to hes-2
     
*     initialize takyon-rec
     move 6           to takyon-rap-anah
     read takyon no lock invalid continue end-read 
     compute takyon-yuzde(32) = hes-1 / hes-2 
     write takyon-rec invalid
           rewrite takyon-rec end-rewrite 
     end-write 

     initialize takyon-rec hes-1 hes-2                       || oda ortalama gelir
     move 2           to takyon-rap-sira
     move 1           to takyon-rap-anah
     read takyon no lock invalid continue end-read 
     move takyon-gelir(takvim-gun) to hes-1
     
     initialize takyon-rec
     move 1           to takyon-rap-sira
     move 3           to takyon-rap-anah
     read takyon no lock invalid continue end-read 
     move takyon-oda-sayi(takvim-gun) to hes-2
     
*     initialize takyon-rec
     move 7           to takyon-rap-sira
     read takyon no lock invalid continue end-read 
     compute takyon-gelir(takvim-gun) = hes-1 / hes-2 
     write takyon-rec invalid
           rewrite takyon-rec end-rewrite 
     end-write 
     
     initialize takyon-rec hes-1 hes-2
     move 2           to takyon-rap-sira
     move 1           to takyon-rap-anah
     read takyon no lock invalid continue end-read 
     move takyon-gelir(32) to hes-1
     
     initialize takyon-rec
     move 1           to takyon-rap-sira
     move 3           to takyon-rap-anah
     read takyon no lock invalid continue end-read 
     move takyon-oda-sayi(32) to hes-2
     
*     initialize takyon-rec
     move 7           to takyon-rap-sira
     read takyon no lock invalid continue end-read 
     compute takyon-gelir(32) = hes-1 / hes-2 
     write takyon-rec invalid
           rewrite takyon-rec end-rewrite 
     end-write 
     .
*
 gelir-hesapla.
     initialize takyon-rec hes-1 hes-2                       || oda + rest gelir
     move 7           to takyon-rap-sira
     read takyon no lock invalid continue end-read 
     move takyon-gelir(takvim-gun) to hes-1
     
     initialize takyon-rec
     move 9           to takyon-rap-sira
     read takyon no lock invalid continue end-read 
     move takyon-gelir(takvim-gun) to hes-2
     
     initialize takyon-rec
     move 10           to takyon-rap-sira
     read takyon no lock invalid continue end-read 
     compute takyon-gelir(takvim-gun) = hes-1 + hes-2 
     write takyon-rec invalid
           rewrite takyon-rec end-rewrite 
     end-write 
     
     initialize takyon-rec hes-1 hes-2
     move 7           to takyon-rap-sira
     read takyon no lock invalid continue end-read 
     move takyon-gelir(32) to hes-1
     
     initialize takyon-rec
     move 9           to takyon-rap-sira
     read takyon no lock invalid continue end-read 
     move takyon-gelir(32) to hes-2
     
     initialize takyon-rec
     move 10           to takyon-rap-sira
     read takyon no lock invalid continue end-read 
     compute takyon-gelir(32) = hes-1 + hes-2 
     write takyon-rec invalid
           rewrite takyon-rec end-rewrite 
     end-write 
     .

 
