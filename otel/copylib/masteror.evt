* masteror.evt
* masteror.evt is generated from D:\asya\acugt.ytl\otel\masteror.Psf
* This is a generated file. DO NOT modify this file directly.


 Form1-Event-Proc.
     .

 Form1-Exception-Proc.
     PERFORM Form1-Ex-Other
     .

 form2-Exception-Proc.
     PERFORM form2-Ex-Other
     .

 screen1-Gd-1-Event-Proc.
     .

 GD-1-Exception-Proc.
     PERFORM GD-1-Ex-Other
     .

 screen2-Event-Proc.
     .

 screen2-Gd-1-Event-Proc.
     .
***   start event editor code   ***
*
 Form1-Bef-Create.
     perform adresleri-tasi.
     move tarih-tasi  to ilk-tarih son-tarih.
     open input genel genel2
     move 1 to genel-anahtar
     read genel no lock invalid continue
          not invalid continue
     end-read
     initialize genel2-rec 
     move 1 to genel2-anah          |||X firat ekleme 12/2/2021
     read genel2 no lock invalid
          continue
     end-read 
     close genel genel2             |||X
     perform acuserve-adres-aktar.
*
 acc-ilk-yil-Aft-Procedure.
     initialize gec-gecme.
     open input takvim.
     move ilk-tarih   to takvim-anah
     read takvim no lock invalid
          move 1 to gec-gecme
     end-read
     close takvim.
*
 acc-son-yil-Aft-Procedure.
     initialize gec-gecme.
     open input takvim.
     move son-tarih   to takvim-anah
     read takvim no lock invalid
          move 1 to gec-gecme
     end-read
     close takvim.
*
 acc-acenta-Aft-Procedure.
     initialize gec-gecme.
     if rapor-acenta = spaces
        move "Tum acentalar ..." to acenta-adi
        display lb-acenta-adi
        exit paragraph
     end-if
     open input acenta.
     move rapor-acenta to acenta-kodu
     read acenta no lock invalid
          move "Tanimsiz ..." to acenta-adi
          move 1 to gec-gecme
     end-read
     close acenta.
     display lb-acenta-adi.
*
 Form1-Ex-Other.
     if  key-status = 1   and  control-id = 12 then
           perform acenta-ara  
     end-if      
     if  key-status = 33
            call "/asya/ytl/obj/otel/rezfilt.asy" 
                  using filtre-tasi  
                  on exception 
                     perform callerr-proc
                  not on exception
                     continue
             end-call
             display l-filtre
     end-if
     if key-status = 2 or 3
        continue
     else
        exit paragraph
     end-if.
     perform acc-ilk-yil-Aft-Procedure.
     if gec-gecme = 1
        move 4 to accept-control
        move 6 to control-id
        exit paragraph
     end-if.
     
     perform acc-son-yil-Aft-Procedure.
     if gec-gecme = 1
        move 4 to accept-control
        move 9 to control-id
        exit paragraph
     end-if.

     perform acc-acenta-Aft-Procedure.
     if gec-gecme = 1 
        move 4 to accept-control
        move 12 to control-id
        exit paragraph
     end-if.
      if key-status = 2 perform raporla
        end-if.
      if key-status = 3 perform muhasebe-at
        end-if.
 takas-aktar.
     

       open input rez grup konuk ozluk  acenta kur  aceanlas takvim kodlar02 takvim2 cari
       |open i-o efat2onb
       open i-o genelfis 
       open i-o mbill-borc
        move 1 to genelfis-anahtar
        read genelfis no lock invalid
             accept print-no from time
        not invalid
             add 1 to print-no of genelfis-rec
             rewrite genelfis-rec end-rewrite
        end-read
        close genelfis
        move print-no to takas-no takas2-no takas5-no takas-dov-no .

       open output takas takas2  takas-dov takas5.
       close takas takas2  takas-dov takas5.
       open i-o takas takas2  takas-dov takas5.
       initialize acenfat-rec
       open input acenfat
       move ilk-tarih to acenfat-tarih
    start acenfat key not < acenfat-anah 
      invalid 
          continue
      not invalid
       perform until fs-acenfat = "10" 
           read acenfat next no lock 
                end move "10" to fs-acenfat
                not end
                  if acenfat-tarih > son-tarih 
                      move "10" to fs-acenfat
                   else 

                     initialize rez-rec konuk-rec
                   if kaynak-ver = 1
                        move acenfat-kfolio to konuk-folio ozluk-folio 
                   else
                        move acenfat-folio to konuk-folio ozluk-folio 
                   end-if
                   
                   read konuk no lock invalid  continue
                   end-read
                   move konuk-rez-no to rez-anah
                   read rez no lock invalid continue
                   end-read
                   read ozluk no lock invalid continue
                   end-read
                   if konuk-gec-giris = 1 then
                        move rez-gir-tar to takvim-anah
                        start takvim key <= takvim-anah  
                         invalid
                           move takvim-anah to rez-gir-tar
                        
                        not invalid
                        read takvim previous no lock end-read
                        read takvim previous no lock 
                          at end
                            move takvim-anah to rez-gir-tar
                          not end
                           move takvim-anah to rez-gir-tar
                         end-read
                        end-start
                                     
                     
                     end-if
                   
                 
                 
                    move "B" to kodlar02-tipi
                    move rez-odeme-tipi to kodlar02-kodu
                    read kodlar02 no lock invalid
                     move spaces to kodlar02-REC
                    end-read
                    if ode-posting not = "H" 
                      if (rapor-acenta = spaces or rapor-acenta = rez-acenta )
                        and ( rapor-master = spaces or rapor-master = ozluk-master-order) 
               
                             if filtre-var = 1 then 
                                       perform filtre
                                   if filtre-gecti  = 1 then 
                                       perform  tek-rez-yaz
                                   end-if
                                 else
                                       perform  tek-rez-yaz
                              end-if
                        end-if
                    end-if
              
                  end-if
                  
                  end-read
           end-perform
    end-start.

         close acenfat 

       initialize takas2-rec fs-takas2
       start takas2 key > takas2-anah 
            invalid continue
            not invalid
             perform until fs-takas2 = "10"  
                   read takas2 next no lock
                     end move "10" to fs-takas2
                     not end
                       perform muha-aktar-mas
                      initialize takas-rec
                      move takas2-master   to  takas-master  
                      if voucher-ayir = 1 or key-status = 3  then 
                            move takas2-voucher    to  takas-anah-voucher
                      end-if
                      if rez-ayir = 1 or key-status = 3  then 
                            move takas2-rez-no    to  takas-anah-rez-no
                      end-if
                      if peryod-ayir = 1 or  key-status  = 3  then 
                            move takas2-peryod   to  takas-anah-peryod
                      end-if
                     
                      
                      move takas2-rez-no to rez-anah 
                      read rez no lock invalid   
                                    continue
                      end-read

                      move rez-acenta to takas-acenta
                      read takas no lock invalid continue
                      end-read

          
                      move  takas2-rez-no     to takas-rez-no
             
         
                        move  takas2-fat-no        to takas-fat-no
                        add   takas2-per-gece      to takas-gece 
                        move  takas2-voucher       to takas-voucher
                        move  takas2-gir-tar       to takas-gir-tar
                        move  takas2-kur           to takas-kur
                        add   takas2-city-tl       to takas-son-tl 
                        add   takas2-city-dov      to takas-son-dov 
                        add   takas2-odenen        to takas-odenen 
                        add   takas2-indirim       to takas-indirim
                        add   takas2-katalog       to takas-katalog
                        add   takas2-reklam        to takas-reklam
                        add   takas2-avans         to takas-avans
                        add   takas2-fark          to takas-fark

                       write takas-rec invalid rewrite takas-rec end-write

                   end-read
             end-perform 
       end-start
        close rez konuk ozluk   grup kur aceanlas acenta  cari takvim kodlar02  takvim2  mbill-borc
        |close efat2onb
        close takas takas2 takas5  takas-dov
     .
*
 muha-aktar-mas.
    
        initialize takas5-rec.
        move  takas2-rez-no  to  takas5-rez-no  rez-no
        read rez no lock invalid continue
        end-read
        read takas5 no lock invalid continue
        end-read
             if function numval (takas2-fat-no) not = 0 and  function numval (takas5-fat-no)  =   0
                    move takas2-fat-no to takas5-fat-no
              end-if
              
              if function numval (takas2-fat-no) not = 0 and  takas2-fat-no not =   takas5-fat-no   
                    move takas2-fat-no to takas5-fat-no2
              end-if
                
                move  takas2-gir-tar   to     takas5-gir-tar
                add takas2-per-gece     to   takas5-per-gece
                move  takas2-voucher   to    takas5-voucher
                move  takas5-master    to     takas5-master 
                move  takas2-kur       to    takas5-kur
                add takas2-city-tl     to     takas5-city-tl

                add takas2-city-dov    to     takas5-city-dov 
                add takas2-ilk-tl      to     takas5-ilk-tl    
                add takas2-ilk-dov     to     takas5-ilk-dov 
                add takas2-eb-tl       to     takas5-eb-tl     
                add takas2-eb-dov      to     takas5-eb-dov    
                move takas2-city-dov to takas5-son-dov
                move 0 to takas5-eb-dov
                move rez-acenta to acenta-kodu
                read acenta no lock invalid continue
                end-read
                if acenta-muhno2 not = spaces 
                   move  acenta-muhno2 to takas5-cari
                   else
                   move acenta-muhno to takas5-cari
               end-if
               initialize cari-rec
               move takas5-cari to cari-kodu
               read cari no lock invalid continue
               end-read
               move c-unvan-1 to takas5-cari-adi

                string rez-adi delimited by "  "
                          " " delimited by size 
                          rez-soyadi delimited by "  "
                          into takas5-adi
                string rez-acenta delimited by size 
                    "-" delimited by size
                    acenta-adi delimited by "   "
                    into takas5-acenta


              move rez-eb to takas5-eb
                if rez-eb = "1" or rez-eb = "E" then  
                   perform odemetar-at
                  if aceanlas-bulundu = 1 
                     compute  takas5-eb-dov  =  takas5-city-dov * aceanlas-eb-odeme-orani / 100
                     compute takas5-son-dov =  takas5-city-dov - takas5-eb-dov
                  end-if

            end-if  .                             
               
                                                               
                add takas2-aks-tl      to     takas5-aks-tl    
                add takas2-aks-dov     to     takas5-aks-dov   
                                                               
                add takas2-spc-tl      to     takas5-spc-tl    
                add takas2-spc-dov     to     takas5-spc-dov   
                                                               
                add takas2-ozl-tl     to      takas5-ozl-tl    
                add takas2-ozl-dov    to      takas5-ozl-dov   
                                                               
                add takas2-kkp-tl     to      takas5-kkp-tl    
                add takas2-kkp-dov    to      takas5-kkp-dov   
                                                               
                add takas2-kick-tl    to      takas5-kick-tl   
                add takas2-kick-dov   to      takas5-kick-dov  
                                                               

            write takas5-rec  invalid rewrite takas5-rec end-write .
           
               


       


      
        .
*
             
 odemetar-at.
        move rez-acenta  to acenta-kodu 
        read acenta no lock invalid 
             continue
        end-read

        if acenta-rate-acenta > spaces
           move acenta-rate-acenta to acenta-kodu 
           read acenta no lock invalid
                move rez-acenta to rez-rate-acenta
           not invalid 
                move acenta-kodu to rez-rate-acenta
           end-read 
        else
           move rez-acenta to rez-rate-acenta
        end-if

        move rez-acenta  to acenta-kodu 
        read acenta no lock invalid 
             continue
        end-read
      
        initialize aceanlas-rec 
        move rez-rate-acenta       to aceanlas-acenta
        move rez-anlasma to aceanlas-anlasma
        move 0 to aceanlas-bulundu
        start aceanlas key >= aceanlas-anah invalid continue
              not invalid 
        perform until fs-aceanlas = "10" 
        read aceanlas next no lock end move "10" to fs-aceanlas
        not end 
            if rez-rate-acenta = aceanlas-acenta and  
               rez-anlasma = aceanlas-anlasma

               if genel2-aceanlas-referansli = 1    |||X firat ekleme 12/2/2021
                  if onkpara-referans-var = 1 
                     evaluate onkpara-referans-nerden
                         when 1 
                              open input konum 
                              initialize konum-rec 
                              move rez-fiyat-konumu to konum-anahtar 
                              read konum no lock invalid
                                   continue
                              end-read 
                              close konum
                              if aceanlas-referans not = spaces and aceanlas-referans not = 0
                                 if konum-ref not = aceanlas-referans
                                    exit perform cycle
                                 end-if
                              end-if 
                         when 2
                              open input odalar 
                              initialize odalar-rec 
                              move rez-odano to odalar-rec 
                              read odalar no lock invalid
                                   continue
                              end-read 
                              close odalar 
                              if aceanlas-referans not = spaces and aceanlas-referans not = 0
                                 if odalar-referans not = aceanlas-referans
                                    exit perform cycle
                                 end-if
                              end-if
                     end-evaluate 
                  end-if
               end-if   |||X        
               
               if aceanlas-kabul-bas <= rez-al-tar and  
                  aceanlas-kabul-bit >= rez-al-tar and  
                  aceanlas-donem-bas <= rez-gir-tar and  
                  aceanlas-donem-bit >= rez-gir-tar 
                  move 1 to aceanlas-bulundu
                  move "10" to fs-aceanlas
               end-if
        
            else
               move "10" to fs-aceanlas
            end-if
        end-read
        end-perform 
        end-start
            .


*
 form2-Aft-Initdata.
           modify gd-1(mb-sira) reset-grid = 1 mass-update = 1
         initialize gd-1-rec
         move  "Rez-no  " to  Gd-1-rezno 
         move "Doviz Tutar"         to  Gd-1-dov-tut     
         move "Tl Tutar   "      to Gd-1-tl-tut 
     
         move "EB Doviz    "           to Gd-1-eb-tut 
            
         move "Onburo Kalan"       to  Gd-1-son-tut    
         move "Voucher "       to  Gd-1-voucher 

         move"Muha Doviz" to Gd-1-muh-dov-tut
         move"Muha EB" to Gd-1-muh-eb-tut
         move"Muha Kalan" to Gd-1-muh-son-tut
         move "Cari kodu " to gd-1-cari
        move "Cari Adi " to gd-1-cari-adi
        move "Acenta   " to gd-1-acenta
        move "Rez Adi   " to gd-1-adi
        move "Fatura No   " to gd-1-fat-no
        move "Fatura No2   " to gd-1-fat-no2
        modify gd-1 record-to-add gd-1-rec
        move  1 to mb-sira



      initialize takas5-rec
      start takas5   key > takas5-anah2 invalid continue
         not invalid 
         perform until fs-takas5 = "10"
             read takas5 next no lock end move "10" to fs-takas5
                not end 
                   initialize gd-1-rec
                   initialize mbill-borc-rec
                   move  takas5-rez-no to  Gd-1-rezno  
                       move isyeri-adres-tasi to  mbill-borc-onb-sirket          
                       move takas5-rez-no to mbill-borc-rez-no      
                    read mbill-borc no lock 
                      invalid move 0 to mb-var
                       not invalid 
                      move 1 to  mb-var
                    end-read
                    MOVE TAKAS5-VOUCHER    TO GD-1-VOUCHER
                    MOVE TAKAS5-CARI       TO GD-1-CARI
                       MOVE TAKAS5-CARI-adi       TO GD-1-CARI-adi
                    MOVE TAKAS5-ADI        TO GD-1-ADI
                    MOVE TAKAS5-ACENTA     TO GD-1-ACENTA

                    move takas5-city-dov   to z-para 
                    move z-para            to  Gd-1-dov-tut     
                    move takas5-city-tl    to z-para 
                    move z-para            to Gd-1-tl-tut 
 
                    move takas5-eb-dov     to  z-para 
                    move z-para            to Gd-1-eb-tut 
                     
                    move takas5-son-dov    to  z-para 
                    move z-para            to  Gd-1-son-tut    
                      move takas5-fat-no    to  Gd-1-fat-no   
                     move takas5-fat-no2    to  Gd-1-fat-no2  
                    move mbill-borc-eb-odeme  to z-para 
                    move z-para to Gd-1-muh-eb-tut
                    move mbill-borc-dv-tutar  to z-para 
                    move z-para to Gd-1-muh-dov-tut
                    move mbill-borc-eb-kalan-odenecek to z-para 
                    move z-para to Gd-1-muh-son-tut



                   if  takas5-city-dov not =  mbill-borc-dv-tutar or takas5-fat-no not = mbill-borc-fatno
                   or  takas5-fat-no2 not = mbill-borc-fatno2  or takas5-cari not = mbill-cari-kodu
                      move 1 to mb-uyumsuz 
                      else
                      move 0 to mb-uyumsuz 
                   end-if
                   move mb-var to takas5-mb-var
                   move mb-uyumsuz to takas5-mb-uyumsuz
                   rewrite takas5-rec invalid continue end-rewrite
                   modify gd-1 record-to-add gd-1-rec
                   add 1 to mb-sira
                   
                   if mb-var =0 
                       modify gd-1(mb-sira) row-color = 176

                   else
                     if mb-uyumsuz = 1 
                          modify gd-1(mb-sira) row-color = 80

                     end-if
                   end-if
                   if takas5-eb = "1" or "E" 
                      modify gd-1(mb-sira,5) cell-color = 112
                         modify gd-1(mb-sira,8) cell-color = 112
                   end-if
              end-read
        end-perform
    end-start
      modify gd-1  mass-update = 0

     .

*



*
 tek-rez-yaz.
  
    initialize takas2-rec
    move konuk-rez-no          to  rez-anah     takas2-rez-no 
    
    move acenfat-peryod        to  takas2-peryod 
    move acenfat-anah          to  takas2-acenfat-anah
    move acenfat-per-geceleme  to  takas2-per-gece
    move ACENFAT-TL-TUTAR      to  takas2-city-tl
    


    move konuk-voucher     to takas2-voucher
    move konuk-gel-tar to takas2-gir-tar 
    if acenfat-per-geceleme = 0 then 
      move 1 to acenfat-per-geceleme
    end-if
    compute mami rounded  =   acenfat-tl-tutar / acenfat-per-geceleme / konuk-kur-degeri
*    if  KONUK-REZ-NO   = 178034 then stop " " end-if
    move ozluk-master-order to takas2-master
    if takas2-peryod not > 0 then
            
            move ozluk-master-tut    to takas2-odenen
            move ozluk-master-ind    to takas2-indirim
            move ozluk-master-eb     to takas2-avans
            move ozluk-master-katalog    to takas2-katalog
            move ozluk-master-reklam    to takas2-reklam
     end-if


    compute  takas2-city-dov = mami *  acenfat-per-geceleme 
    move acenfat-fat-no        to  takas2-fat-no 
       move acenfat-fat-no to e-o-fatura


          move genel-muha-ref to e-ref 
          perform efatura-gercek-bul
          if e-m-fatura > spaces then 
            
              move e-m-fatura to  takas2-fat-no 
          end-if



    move konuk-kur-degeri      to  takas2-kur
     compute takas2-fark = takas2-city-dov - takas2-odenen - takas2-avans - 
                       takas2-katalog - takas2-reklam  

    write takas2-rec invalid
           continue 
             if k-kodu-tasi = "ASYA" or "X   " then stop " " end-if 
           
           end-write



             .
 muhasebe-at.
     perform takas-aktar.
     open i-o takas5 mbill-borc 
       perform acu-form2-routine
     close takas5 mbill-borc 
      .
 raporla.

     call "/asya/ytl/obj/otel/fatolus.asy" 
     using  ilk-tarih  son-tarih
          on exception 
      perform callerr-proc
      exit paragraph
     not on exception 
      cancel "/asya/ytl/obj/otel/fatolus.asy"
     end-call

     perform takas-aktar.
     open i-o takas5 mbill-borc 
      
     open input konuk rez konum takas acenta ulke doviz.
     open i-o takas-dov
        open i-o genelfis
        move 1 to genelfis-anahtar
        read genelfis no lock invalid
             accept print-no from time
        not invalid
             add 1 to print-no
             rewrite genelfis-rec end-rewrite
        end-read
        close genelfis

**************************
     initialize dokumer-rec dokumer-anah dokumer-ozellikler-rec
                dokumer-dosya

     set  dokumer-asya-set to true
     move print-no         to dokumer-dosya-adi
     open output dokumer
*/WINDOW TITLE
     initialize dokumer-rec detay
     move "W"                  to det-dokumer-20(1:)
     move " Master Order Kontrol Raporu"   to det-filler
     write dokumer-rec from detay
*/ BASLIKLAR
     initialize dokumer-rec detay
     move "B"                  to det-dokumer-20(1:1)
     move "1"          to det-dokumer-20(10:1)
     move " Master Order Kontrol Raporu"   to det-filler
     move "Tarih..:"     to det-filler(41:10)
     move ilk-gun        to det-filler(51:02)
     move "/"            to det-filler(53:01)
     move ilk-ay         to det-filler(54:02)
     move "/"            to det-filler(56:01)
     move ilk-yil        to det-filler(57:04)
     move "-"            to det-filler(61:01)
     move son-gun        to det-filler(62:02)
     move "/"            to det-filler(64:01)
     move son-ay         to det-filler(65:02)
     move "/"            to det-filler(67:01)
     move son-yil        to det-filler(68:04)
     write dokumer-rec from detay
     initialize dokumer-rec detay

     initialize dokumer-rec detay
     move "B"                  to det-dokumer-20(1:1)
     move "1"          to det-dokumer-20(10:1)
     move "Acenta.:"           to det-filler(01:10)
     move acenta-adi           to det-filler(11:)
     write dokumer-rec from detay

     initialize dokumer-rec detay
     move "B"                  to det-dokumer-20(1:)
     write dokumer-rec from detay

*/ DOKUMER OZELLIKLER-REC
     initialize dokumer-rec detay
     move "O" to det-dokumer-20(1:)
     move "E" to dokumer-oto-sayfa-basi
     move 56  to dokumer-oto-sayfa-satir
     move "|" to dokumer-detay-kolon-ayirici
     move "LLLRRLLRRLL" to dokumer-align-occ
     move dokumer-ozellikler-rec     to det-filler
     write dokumer-rec from detay
*/ BASLIKLAR  
     initialize dokumer-rec detay 
     move "D1"          to det-dokumer-20(1:2)
     move "1"           to det-dokumer-20(10:1)
     move "Master Ord"  to det-1
     move "Voucher   "  to det-2
     move "Rez No    "  to det-3
     move "Kodu      "  to det-19
     move "Acenta    "  to det-4
     move "Adi       "  to det-5   
     move "Soyadi    "  to det-6   
     move "Gece"        to det-7
     move "Giris Tar"   to det-8
     move "Cikis Tar"   to det-9
     move "Pax"         to det-10
     move "Chi"         to det-11
     move "Fre"         to det-12
     move "Beb"         to det-13
     move "Fat. Tut TL"    to det-14
     move "Fat. Tut Dov" to det-15
     move "Odenen     "   to det-30
     move "Indirim    "  to det-31
     move "Katalog    "  to det-32
     move "Reklamasyon" to det-33
     move "E/B den Mahsup " to det-34
     move "Fark           " to det-35
     move "Isl Tar  "   to det-16
     move "Fiyat Konum" to det-17
     move "Fatura "     to det-18
     move "Fatura2 "     to det-18-1
     move "Doviz"        to det-20
     move "EB"           to det-22
     move "Cari Kodu"    to det-21
     move "Ulke"         to det-23

     move "|" to fil-1 fil-2 fil-3 fil-4 fil-5 fil-6
                 fil-7 fil-8 fil-9  fil-10 fil-11 fil-12 
                 fil-13 fil-14 fil-15 fil-16 fil-17 fil-18 fil-18-1
                   fil-30 fil-31 fil-32 fil-33 fil-34  fil-35  fil-19  fil-20 fil-21 fil-22 fil-23
     write dokumer-rec from detay


     initialize dokumer-rec detay
     move "D2"           to det-dokumer-20(1:2)
     move "-"            to det-dokumer-20(5:1)
     move all "-" to det-1 det-2 det-3 det-4 det-5 det-6
                 det-7 det-8 det-9  det-10 det-11 det-12 
                 det-13 det-14 det-15 det-16 det-17 det-18 det-18-1
                   det-30 det-31 det-32 det-33 det-34  det-35 det-19 det-20 det-21 det-22 det-23
     move "|" to fil-1 fil-2 fil-3 fil-4 fil-5 fil-6
                 fil-7 fil-8 fil-9  fil-10 fil-11 fil-12 
                 fil-13 fil-14 fil-15 fil-16 fil-17 fil-18 fil-18-1
                  fil-30 fil-31 fil-32 fil-33 fil-34  fil-35  fil-19 fil-20  fil-21 fil-22 fil-23
     write dokumer-rec from detay
  

     initialize fs-takas5 toplamlar  takas5-rec  ilk-kayit
     initialize  toplam-tl toplam-doviz toplam-indirim  toplam-katolog toplam-odenen toplam-reklam toplam-avans toplam-fark

     if acenta-grupla not = 1  then
             start takas5 key >= takas5-anah2 invalid
                     continue
             display message box "Aranilan Kriterde Kayit Bulunamadi !"
             close dokumer takas acenta rez  konuk konum  ulke takas-dov  doviz mbill-borc takas5
             delete file dokumer takas takas2   takas-dov
              exit paragraph
             end-start
     else
             start takas5 key >= takas5-anah3 invalid 
                     continue
             display message box "Aranilan Kriterde Kayit Bulunamadi !"   
             close dokumer takas acenta rez ulke konuk konum takas-dov doviz mbill-borc takas5
             delete file dokumer takas takas2     takas-dov
              exit paragraph
             end-start
     end-if
     move  1 to ilk-kayit
  
         perform until fs-takas5 = "10"
         read takas5 next no lock end move "10" to fs-takas5
         not end
***********sy 17 11 2012 ***********************************
           if takas5-rez-no = zeroes 
              exit perform cycle 
           end-if 
           if acenta-grupla not = 1 then
                perform takasi-dete-yaz
           else
                 if takas5-acenta not = eski-acenta and ilk-kayit not = 1 then 
                       perform takas-ara-toplam-yaz
                       initialize  tl-top dv-top ODE-TOP  IND-TOP  KAT-TOP REK-TOP AVA-TOP   FAR-TOP
                       perform takasi-dete-yaz
                 else
                       perform takasi-dete-yaz 
                 end-if
              
              initialize ilk-kayit
              move takas-acenta to eski-acenta
           end-if

             move "|" to fil-1 fil-2 fil-3 fil-4 fil-5 fil-6
             fil-7 fil-8 fil-9  fil-10 fil-11 fil-12 
             fil-13 fil-14 fil-15 fil-16 fil-17 fil-18 fil-18-1 fil-19 fil-20 fil-21 fil-22 fil-23
             write dokumer-rec from detay
            
         end-read
     end-perform

     close takas takas-dov
        
     if acenta-grupla = 1 then
          perform takas-ara-toplam-yaz
     end-if
          perform takas-alt-toplam-yaz

         close  takas5 mbill-borc 
        close dokumer
        call dokumer-prog on exception
             perform callerr-proc
        not on exception
             cancel dokumer-prog
        end-call
        delete file dokumer takas takas2 takas5  takas-dov
   
        
     close acenta rez ulke konuk konum doviz .

takas-ara-toplam-yaz.
 
     
         initialize dokumer-rec detay
         move "-"            to det-dokumer-20(5:1)
         move all "-" to det-1 det-2 det-3 det-4 det-5 det-6
                 det-7 det-8 det-9  det-10 det-11 det-12 
                 det-13 det-14 det-15 det-16 det-17 det-18 det-18-1
                 det-30 det-31 det-32 det-33 det-34  det-35  det-19 det-20 det-21 det-22 det-23
        write dokumer-rec from detay
        initialize dokumer-rec detay
        move "A"          to det-dokumer-20(3:1)
        move 481          to det-renk1
        move "1"          to det-dokumer-20(10:1)
        if acenta-grupla not = 1 then
                move "Toplam =>"             to det-1
                move oda-top                 to 3-hane
                move 3-hane                  to det-1
        end-if
        move eski-acenta            to det-19
        move dv-top                  to zpara
        move zpara               to det-15  
        move tl-top                  to zpara
        move zpara                  to det-14
         move ODE-TOP     to zpara
                move zpara             to det-30
                move IND-TOP     to zpara
                move zpara             to det-31
                move KAT-TOP     to zpara
                move zpara             to det-32
                move REK-TOP      to zpara
                move zpara             to det-33
                move AVA-TOP      to zpara
                move zpara             to det-34
                move FAR-TOP        to zfark
                move zfark            to det-35


         move "|" to fil-1 fil-2 fil-3 fil-4 fil-5 fil-6
                 fil-7 fil-8 fil-9  fil-10 fil-11 fil-12 
                 fil-13 fil-14 fil-15 fil-16 fil-17 fil-18 fil-18-1 fil-23
                   fil-30 fil-31 fil-32 fil-33 fil-34  fil-35  fil-19   fil-20  fil-21 fil-22
        write dokumer-rec from detay 
        initialize dokumer-rec detay
        move "-"            to det-dokumer-20(5:1)
         move all "-" to det-1 det-2 det-3 det-4 det-5 det-6
                 det-7 det-8 det-9  det-10 det-11 det-12 
                 det-13 det-14 det-15 det-16 det-17 det-18 det-18-1 det-23
                   det-30 det-31 det-32 det-33 det-34  det-35   det-19  det-20  det-21 fil-21
        write dokumer-rec from detay.
*
takas-alt-toplam-yaz.
 
     
         initialize dokumer-rec detay
         move "-"            to det-dokumer-20(5:1)
         move all "-" to det-1 det-2 det-3 det-4 det-5 det-6
                 det-7 det-8 det-9  det-10 det-11 det-12 
                 det-13 det-14 det-15 det-16 det-17 det-18 det-18-1 det-23
                 det-30 det-31 det-32 det-33 det-34  det-35  det-19 det-20 det-21 det-22
        write dokumer-rec from detay
        initialize dokumer-rec detay
        move "A"          to det-dokumer-20(3:1)
        move 112          to det-renk1
        move "1"          to det-dokumer-20(10:1)
        move "Toplam =>"             to det-1
        move oda-top                 to 3-hane
        move 3-hane                  to det-1

        move toplam-doviz                  to zpara
        move zpara               to det-15  
        move toplam-tl                  to zpara
        move zpara                  to det-14
                move toplam-odenen     to zpara
                move zpara             to det-30
                move toplam-indirim     to zpara
                move zpara             to det-31
                move toplam-katolog     to zpara
                move zpara             to det-32
                move toplam-reklam      to zpara
                move zpara             to det-33
                move toplam-avans      to zpara
                move zpara             to det-34
                move toplam-fark        to zfark
                move zfark            to det-35

         move "|" to fil-1 fil-2 fil-3 fil-4 fil-5 fil-6
                 fil-7 fil-8 fil-9  fil-10 fil-11 fil-12 
                 fil-13 fil-14 fil-15 fil-16 fil-17 fil-18 fil-18-1  fil-23
                   fil-30 fil-31 fil-32 fil-33 fil-34  fil-35  fil-19 fil-20 fil-21  fil-22
        write dokumer-rec from detay 
        initialize dokumer-rec detay
        move "-"            to det-dokumer-20(5:1)
         move all "-" to det-1 det-2 det-3 det-4 det-5 det-6
                 det-7 det-8 det-9  det-10 det-11 det-12 
                 det-13 det-14 det-15 det-16 det-17 det-18 det-18-1 det-23
                   det-30 det-31 det-32 det-33 det-34  det-35   det-19  det-20 fil-21  det-22
         write dokumer-rec from detay 
*************doviz alt toplam yazýdýrlýyor 

                initialize dokumer-rec detay
                move "A"          to det-dokumer-20(3:1)

                move 481          to det-renk1
                move "1"          to det-dokumer-20(10:1)
                move "*"   to det-1
                
                move "|" to fil-1 fil-2 fil-3 fil-4 fil-5 fil-6
                fil-7 fil-8 fil-9  fil-10 fil-11 fil-12 
                fil-13 fil-14 fil-15 fil-16 fil-17 fil-18 fil-18-1 fil-23
                fil-30 fil-31 fil-32 fil-33 fil-34  fil-35  fil-19 fil-20 fil-21 fil-22
                write dokumer-rec from detay

          open input takas-dov
          move 1 to ilk-kayit
          initialize takas-dov-rec fs-takas-dov
          start takas-dov key not < takas-dov-kodu
                   invalid continue
          not invalid
          perform until fs-takas-dov = "10"
          read takas-dov next no lock end move "10" to fs-takas-dov
          not end
                
                initialize dokumer-rec detay
                move "A"          to det-dokumer-20(3:1)
                move 481          to det-renk1
                move "1"          to det-dokumer-20(10:1)
                move takas-dov-kodu to doviz-kodu
                read doviz no lock
                        invalid continue
                not invalid
                move  D-KISA-ADI     to det-20
                move takas-dov-tutar to zpara 
                move zpara           to det-15
                end-read
                
                move "|" to fil-1 fil-2 fil-3 fil-4 fil-5 fil-6
                fil-7 fil-8 fil-9  fil-10 fil-11 fil-12 
                fil-13 fil-14 fil-15 fil-16 fil-17 fil-18 fil-18-1 fil-23
                fil-30 fil-31 fil-32 fil-33 fil-34  fil-35  fil-19 fil-20 fil-21 fil-22
                write dokumer-rec from detay 
                
          end-read
          end-perform
          end-start

          close takas-dov


*******************************        
        .
*
takasi-dete-yaz.
               initialize detay
               move takas5-master to det-1
               move takas5-rez-no to rez-anah det-3
               read rez no lock invalid   
                    continue
               end-read
                move rez-acenta      to acenta-kodu 
                read acenta no lock invalid
                     move "Tanimsiz acenta"  to acenta-adi
                end-read

                move acenta-kodu             to det-19
                move acenta-adi              to det-4

                move rez-folio       to konuk-folio
                read konuk no lock invalid
                     initialize konuk-rec
                end-read
                move konuk-voucher to det-2
                move konuk-adi           to det-5
                move konuk-soyadi        to det-6
                move takas-gece    to 3-hane
                move 3-hane              to det-7
                move rez-gir-gun   to egun
                move rez-gir-ay    to eay
                move rez-gir-yil   to eyil
                move etarih        to det-8
                move rez-cik-gun   to egun
                move rez-cik-ay    to eay
                move rez-cik-yil   to eyil
                move etarih        to det-9
                move rez-buyuk     to z-3
                move  z-3        to det-10
                move rez-kucuk     to z-3
                move  z-3        to det-11
                move rez-free     to z-3 3-hane
                move  z-3        to det-12
                move rez-bebek     to z-3
                move  z-3       to det-13
                
                initialize doviz-rec  takas-dov-rec
                move rez-doviz to DOVIZ-KODU
                read doviz no lock invalid 
                        continue
                not invalid
            
*************************************************************************
                   move D-KISA-ADI to det-20
                   move DOVIZ-KODU to takas-dov-kodu
                   read takas-dov no lock invalid
                         move doviz-kodu     to takas-dov-kodu
                         move takas5-city-dov  to takas-dov-tutar
                         write takas-dov-rec 
                                 invalid stop "ilkkayit hata"
                         end-write
                         continue
                   not invalid
                        add takas5-city-dov to takas-dov-tutar
                        rewrite takas-dov-rec  
                                invalid stop "tekrari hata"
                        end-rewrite
                   end-read
********************************************************************
                end-read
   

                if rez-eb = "E" then
                      move "E" to det-22
                end-if
                initialize ulke-rec 
                move rez-ulke to ulke-anah
                read ulke no lock invalid 
                     move "Tanimsiz" to ulke-adi
                end-read 
                move rez-ulke        to det-23
                move "-"             to det-23(4:)
                move ulke-adi        to det-23(5:)
                move takas5-city-tl      to zpara
                move zpara             to det-14 
                move takas5-city-dov     to zpara
                move zpara             to det-15
                move takas5-odenen      to zpara
                move zpara             to det-30
                move takas5-indirim     to zpara
                move zpara             to det-31
                move takas5-katalog     to zpara
                move zpara             to det-32
                move takas5-reklam      to zpara
                move zpara             to det-33
                move takas5-avans       to zpara
                move zpara             to det-34
                move takas5-fark        to zfark
                move zfark            to det-35

                move rez-isl-gun   to egun
                move rez-isl-ay    to eay
                move rez-isl-yil   to eyil
                move etarih        to det-16
                move rez-fiyat-konumu to konum-anahtar
                read konum no lock invalid
                continue
                end-read
                move konum-adi to det-17
               move  takas5-fat-no  to   det-18
               move  takas5-fat-no2  to   det-18-1 
               move takas5-cari to det-21
                add 1 to oda-top
                |add takas5-son-tl     to tl-top  toplam-tl
                |add takas5-son-dov    to dv-top  toplam-doviz

                add takas5-city-tl     to tl-top  toplam-tl
                add takas5-city-dov    to dv-top  toplam-doviz

                  ADD takas5-odenen      to ODE-TOP  toplam-odenen 
                  ADD takas5-indirim     to IND-TOP  toplam-indirim
                  ADD takas5-katalog     to KAT-TOP  toplam-katolog
                  ADD takas5-reklam      to REK-TOP  toplam-reklam
                  ADD takas5-avans       to AVA-TOP  toplam-avans  
                  ADD takas5-fark        to FAR-TOP  toplam-fark.
* 
 acenta-ara.
      initialize acenta-cagir.
      call "/asya/ytl/obj/otel/acenara.asy" using acenta-cagir
            on exception perform callerr-proc
               not on exception
               cancel "/asya/ytl/obj/otel/acenara.asy" 
       end-call.
       move acenta-cagir     to rapor-acenta.
       display  acc-acenta.
 acenta-oku.
       initialize gec-gecme.
       move "Tum Acentalar"      to adi-goster
       display lb-acenta-adi.
       if rapor-acenta not = spaces
          open input acenta
          initialize acenta-rec
          move rapor-acenta   to acenta-kodu
          read acenta        no lock invalid 
               move 1        to gec-gecme
               display message box "Acenta Kodu Tanimsiz.."
               move 4    to accept-control
               move 12 to control-id
               not invalid continue 
          end-read
          close acenta
          move acenta-adi     to adi-goster
          display lb-acenta-adi
       end-if.
*************
*
 acuserve-adres-aktar.

    move muha-sirketi of genel-rec to CARI-DOSYA-adres         
                         ISLENEN-DOSYA-adres      
                         HESAP-DOSYA-adres        
                         MAHSUP-DOSYA-adres       
                       
                         REFERANS-DOSYA-adres     
                         mgenel-DOSYA-adres       
                    
                         alsat-dosya-adres
                         efat2onb-dosya-adres
                          mbill-borc-dosya-adres
                   
            

    move all low-values to  alsat-acuserve-dosya
                           efat2onb-acuserve-dosya
                           CARI-ACUSERVE-DOSYA       
                           ISLENEN-ACUSERVE-DOSYA    
                           HESAP-ACUSERVE-DOSYA      
                           MAHSUP-ACUSERVE-DOSYA     
                           genelfis-ACUSERVE-DOSYA   
                           REFERANS-ACUSERVE-DOSYA   
                           Mgenel-ACUSERVE-DOSYA     
                       
                            mbill-borc-acuserve-dosya
                           ip-no.


    inspect genel-muha-uzak-ip 
            replacing trailing spaces by low-values.

    if genel-muha-uzak-ip <> low-values
       move all low-values to ip-no
       string ip-no,
              "@" delimited by low-values
              genel-muha-uzak-ip delimited by low-values
              ":" delimited by low-values
              into ip-no
    end-if

    string mgenel-acuserve-dosya,
           ip-no                        delimited by low-values
           mgenel-dosya                    delimited by low-values
           into mgenel-acuserve-dosya.
    string genelfis-acuserve-dosya,
           ip-no                        delimited by low-values
           genelfis-dosya                 delimited by low-values
           into genelfis-acuserve-dosya.

    string mbill-borc-acuserve-dosya,
           ip-no                        delimited by low-values
           mbill-borc-dosya                 delimited by low-values
           into mbill-borc-acuserve-dosya.
    string hesap-acuserve-dosya,
           ip-no                        delimited by low-values
           hesap-dosya                 delimited by low-values
           into hesap-acuserve-dosya.
    string mahsup-acuserve-dosya,
           ip-no                        delimited by low-values
           mahsup-dosya                 delimited by low-values
           into mahsup-acuserve-dosya.
    string cari-acuserve-dosya,
           ip-no                        delimited by low-values
           cari-dosya                 delimited by low-values
           into cari-acuserve-dosya.
    string islenen-acuserve-dosya,
           ip-no                        delimited by low-values
           islenen-dosya               delimited by low-values
           into islenen-acuserve-dosya.
    string referans-acuserve-dosya,
           ip-no                        delimited by low-values
           referans-dosya                delimited by low-values
           into referans-acuserve-dosya.
     string efat2onb-acuserve-dosya,
           ip-no                        delimited by low-values
           efat2onb-dosya                delimited by low-values
           into efat2onb-acuserve-dosya.
     string alsat-acuserve-dosya,
           ip-no                        delimited by low-values
           alsat-dosya                delimited by low-values
           into alsat-acuserve-dosya.
    inspect mbill-borc-acuserve-dosya        replacing  all spaces by low-values 
    inspect cari-acuserve-dosya        replacing  all spaces by low-values
    inspect alsat-acuserve-dosya        replacing  all spaces by low-values
    inspect efat2onb-acuserve-dosya        replacing  all spaces by low-values
    inspect islenen-acuserve-dosya     replacing  all spaces by low-values
    inspect hesap-acuserve-dosya       replacing  all spaces by low-values
    inspect mahsup-acuserve-dosya      replacing  all spaces by low-values
    inspect genelfis-acuserve-dosya    replacing  all spaces by low-values
    inspect referans-acuserve-dosya    replacing  all spaces by low-values
    inspect mgenel-acuserve-dosya      replacing  all spaces by low-values
    inspect genelfis-acuserve-dosya    replacing  all spaces by low-values.

     .
*
 muhat-artik.
      

       move 1 to mb-sira
      initialize takas5-rec
      start takas5   key > takas5-anah2 invalid continue
         not invalid 
         perform until fs-takas5 = "10"
             read takas5 next no lock end move "10" to fs-takas5
                not end 
                add 1 to mb-sira

                if key-status = 8
                    if  takas5-mb-var = 1 
                           exit perform cycle
                    end-if
                 end-if
                 if key-status = 9 
                        if takas5-mb-var = 1   and takas5-mb-uyumsuz = 0
                              exit perform cycle
                         end-if
                 end-if
                  modify gd-1 record-to-delete(mb-sira)      
                   subtract 1 from mb-sira
                 
                   initialize mbill-borc-rec
                   move  takas5-rez-no to  Gd-1-rezno  
                       move isyeri-adres-tasi to  mbill-borc-onb-sirket          
                       move takas5-rez-no to mbill-borc-rez-no      
                    read mbill-borc no lock invalid move 0 to mb-var
                       not invalid 
                      move 1 to  mb-var
                    end-read

   
  
         if takas5-eb = "1" or "E" 
           move "E" to mbill-borc-eb
        end-if
       move takas5-master   to mbill-borc-masterno                  
       move takas5-voucher  to mbill-borc-voucher                   
       move takas5-city-dov to mbill-borc-dv-tutar 
       move takas5-city-tl  to mbill-borc-tl-tutar                           
                 

       MOVE  takas5-eb-dov TO mbill-borc-eb-odeme                  
       move takas5-cari  to  mbill-cari-kodu          

           
       MOVE  takas5-fat-no TO    mbill-borc-FATNO
       MOVE  takas5-fat-no2 TO    mbill-borc-FATNO2
       MOVE takas5-son-dov TO  mbill-borc-eb-kalan-odenecek  
       




             delete takas5 invalid continue end-delete

                    write   mbill-borc-rec invalid  rewrite   mbill-borc-rec
                           end-write

                   
              end-read
        end-perform
    end-start
  



            .
*
 form2-Ex-Other.
    evaluate key-status
            when 7
            when 8
            when 9
               perform muhat-artik




    end-evaluate
     .
*
 GD-1-Ex-Other.
    if key-status= 7 or 8 or 9
        perform form2-ex-other

    end-if
          inquire gd-1,
                      cursor-y in i
                      
                    inquire gd-1(i,13),
                                 cell-data in srez
                                 initialize rez-rec
                                   move function numval(srez) to rez-no 
     evaluate key-status
           when 18
               open input rez
                 read rez no lock invalid 
                   display message box "Rezervasyona ulasilamadi"
                   not invalid
                               if rez-no > 0 then 
                                call "/asya/ytl/obj/otel/rez.asy" 
                                  using  rez-no
                                on exception 
                                      perform callerr-proc
                                     exit paragraph
                                  not on exception 
                                cancel "/asya/ytl/obj/otel/rez.asy"
                                end-call
                               end-if  
                   end-read
                close rez  
                when 6
                   open input rez
                 read rez no lock invalid 
                   display message box "Rezervasyona ulasilamadi"
                   not invalid
                               if rez-folio > 0 then 
                                call "/asya/ytl/obj/otel/folio.asy" 
                                  using  rez-folio
                                on exception 
                                      perform callerr-proc
                                     exit paragraph
                                  not on exception 
                                cancel "/asya/ytl/obj/otel/folio.asy"
                                end-call
                               end-if  
                   end-read
                close rez  

      end-evaluate   
     .


**

 efatura-gercek-bul.

        open input genel
        move 1 to genel-anahtar
        read genel no lock invalid continue
             not invalid continue
        end-read
        close genel


        if muh-2016 = 1
            move ACENFAT-YIL to muha-sirketi of genel-rec(5:4) 
        end-if
        move muha-sirketi of genel-rec to efat2onb-dosya-adres

        move all low-values to efat2onb-acuserve-dosya
        
        inspect genel-muha-uzak-ip 
                 replacing trailing spaces by low-values.

         if genel-muha-uzak-ip <> low-values
             move all low-values to ip-no
             string ip-no,
                   "@" delimited by low-values
                   genel-muha-uzak-ip delimited by low-values
                   ":" delimited by low-values
                   into ip-no
         end-if
         string efat2onb-acuserve-dosya,
                   ip-no                        delimited by low-values
                   efat2onb-dosya                delimited by low-values
                   into efat2onb-acuserve-dosya.

         inspect efat2onb-acuserve-dosya        replacing  all spaces by low-values


        open input efat2onb

        initialize efat2onb-rec  e-m-fatura
        set efat2onb-tipi-onburo to true
        move  e-ref      to  efat2onb-referans 
        initialize kodlar02-rec
            move "r"           to kodlar02-tipi
            move e-ref   to zz
            move zz           to kodlar02-kodu
            read kodlar02 no lock invalid 
                continue 
            not invalid 
                move kodlar02-ref to efat2onb-referans
            end-read              
*          if k-kodu-tasi = "X   " or "ASYA" then
                move  e-ref      to  efat2onb-referans 
*          end-if
        move acenfat-tarih to  efat2onb-fatura-tarihi
        move all "0" to   efat2onb-onburo-fatura-no
        move e-o-fatura to efat2onb-onburo-fatura-no2           
          
             read efat2onb  no lock invalid  
*                 if k-kodu-tasi = "X   " or "ASYA" then
                     
                       move 1 to  efat2onb-referans 
                       read efat2onb  no lock invalid  
                              move 3 to  efat2onb-referans 
                           read efat2onb  no lock 
                             invalid  
                                 move 2 to  efat2onb-referans 
                                   read efat2onb  no lock invalid 
                                      continue                                
                                   not invalid 
                                       if  function numval (efat2onb-muhasebe-fatura-no(8:))  > 0 
                                          move  efat2onb-muhasebe-fatura-no to   e-m-fatura
                                       end-if   
                                   end-read                                
                             not invalid 
                               if  function numval (efat2onb-muhasebe-fatura-no(8:))  > 0 
                               move  efat2onb-muhasebe-fatura-no to   e-m-fatura
                             end-if   

                           end-read
                         not invalid 
                         if  function numval (efat2onb-muhasebe-fatura-no(8:))  > 0 
                             move  efat2onb-muhasebe-fatura-no to   e-m-fatura
                          end-if   
                     end-read
*                 end-if
             
            
                not invalid 
                if  function numval (efat2onb-muhasebe-fatura-no(8:))  > 0 
                 move  efat2onb-muhasebe-fatura-no to   e-m-fatura
                 end-if
                 
            end-read
            close efat2onb.

 
