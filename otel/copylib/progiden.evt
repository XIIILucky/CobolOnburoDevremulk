* progiden.evt
* progiden.evt is generated from D:\asya\acugt.ytl\otel\progiden.Psf
* This is a generated file. DO NOT modify this file directly.


 Form1-Event-Proc.
     .

 Form1-Exception-Proc.
     PERFORM Form1-Ex-Other
     .

 Form1-Cb-1ab-Exception-Proc.
     PERFORM Form1-Cb-1ab-Ex-Cmd-Clicked
     .
***   start event editor code   ***
*
 Form1-Bef-Create.
    perform adresleri-tasi.
    open input genel genel2
    move 1 to genel-anahtar
    read genel no lock invalid continue
         not invalid continue
    end-read
    initialize genel2-rec
    move 1 to genel2-anah 
    read genel2 no lock invalid continue
         not invalid continue
    end-read
    close genel genel2.
    call "c$narg" using link-var.
    if link-var > 0 then move 0 to vis-lab end-if
    move genel-printer-filtre to text-oku-filtre.
    move tarih-tasi to fatt-tarih
    perform acuserve-adres-aktar.

     .
*
 Form1-Aft-Initdata.
    move tarih-tasi to ilk-tarih son-tarih.
    move yil-tasi to ilk-yil son-yil
    add 1 to son-yil
    move 1 to ilk-ay ilk-gun
    move 31 to son-gun
    move 12 to son-ay
    display acc-01 acc-02 acc-03 acc-04 acc-05 acc-06
            acc-01a acc-02a acc-03a acc-04a acc-05a acc-06a.
  
    if link-var > 0 then 
       move 2 to key-status
       perform form1-ex-other
*       set exit-pushed to true
    end-if. 
*/-----------------------------\*  
*/---------DIL AYARLA----------\*    
*/-----------------------------\*    
     perform dil-ayarla-proc.
*/-----------------------------\*         
*
 Form1-Ex-Other.
    evaluate key-status
      when 1
        evaluate control-id
        when 12
        when 2001
             initialize acenta-cagir
             call "/asya/ytl/obj/otel/acenara.asy" 
                  using acenta-cagir  
                  on exception 
                     perform callerr-proc
                  not on exception
                     if acenta-cagir <> spaces
                        move acenta-cagir to acn-kod
                        display acc-07
                     end-if
             end-call
             move 4 to accept-control
             move 12 to control-id
        end-evaluate
        exit paragraph
      when 33 
            call "/asya/ytl/obj/otel/rezfilt.asy" 
                  using filtre-tasi  
                  on exception 
                     perform callerr-proc
                  not on exception
                     continue
             end-call
             display l-filtre
              
      when 2
            
           
            if link-var = 0 then
             open input takvim
            move ilk-tarih  to takvim-anah
           
            move son-tarih to ay-basi takvim-anah   
            move 01 to ay-basi(7:2) 
            move 32 to  takvim-gun
            start takvim key < takvim-anah invalid continue
              not invalid read takvim previous end continue end-read end-start
            move takvim-anah to ay-sonu

            move son-tarih  to takvim-anah
            
            close takvim
           end-if
        open input konuk kur cast doviz konum rez  takvim kodlar02  grup yanrez hesayr
          open input  aksiyhrk fiyat fiyatana  odalar
        initialize konuk-rec toplam ara-toplam
        evaluate link-var 
            when  1 
               display message box "Hatali lik"
            when  2 
               perform tek-rez-takas
            when other
               initialize genel-share
               perform takas-aktar thru takas-aktar-exit 
                 open output takasdov close takasdov open i-o takasdov
        end-evaluate
              initialize takas-rec toplam kont-eb-ayrisayfa 
                         kont-git-tar gece-say doviz-kontrol kont-donem
              move "F" to kont-eb-ayrisayfa
              start takas key not < takas-kodu invalid
                    initialize mesaj-link
                    move 04 to mesaj-no
                    perform mesaj-ver
                    close konuk  takas kur doviz kodlar02 grup yanrez odalar
                   close aksiyhrk fiyat fiyatana takvim rez  konum hesayr cast
                    exit paragraph
              end-start

              open i-o genelfis
              move 1 to genelfis-anahtar
              read genelfis no lock invalid
                   accept print-no from time
              not invalid
                   add 1 to print-no
                   rewrite genelfis-rec end-rewrite
              end-read
              close genelfis
**************************
     initialize dokumer-rec dokumer-anah dokumer-ozellikler-rec
                dokumer-dosya gt-toplam

     set  dokumer-asya-set to true
     move print-no         to dokumer-dosya-adi
     open output dokumer
*/WINDOW TITLE
     initialize dokumer-rec detay
     move "W"                  to det-dokumer-20(1:)
     move "Acenta Proforma  Raporu"   to det-filler
     write dokumer-rec from detay
*/ BASLIKLAR
     initialize dokumer-rec detay
     move "1"            to det-dokumer-20(10:1)
     move "B"            to det-dokumer-20(1:1)
     move "Acenta Proforma  Raporu"   to det-filler
     move "Tarih..:"     to det-filler(41:10)
     move ilk-gun        to det-filler(51:02)
     move "/"            to det-filler(53:01)
     move ilk-ay         to det-filler(54:02)
     move "/"            to det-filler(56:01)
     move ilk-yil        to det-filler(57:04)
     move "-"            to det-filler(61:01)
     move son-gun        to det-filler(62:02)
     move "/"            to det-filler(64:01)
     move son-ay         to det-filler(65:02)
     move "/"            to det-filler(67:01)
     move son-yil        to det-filler(68:04)
     write dokumer-rec from detay


     initialize dokumer-rec detay
     move "1"          to det-dokumer-20(10:1)
     move "B"                  to det-dokumer-20(1:1)
     move "Acenta....:"           to det-filler(01:)
     move acn-kod                 to det-filler(15:04)
     move "<->"                   to det-filler(20:03)
     if acn-kod       = spaces
        move "Tum Acentalar.."    to det-filler(25:20)
     else
        open input acenta
        initialize acenta-rec  
        move acn-kod        to acenta-kodu
        read acenta no lock invalid 
             move all "*" to acenta-adi  
                        not invalid continue
        end-read
        close acenta
        move acenta-adi           to det-filler(25:20)
     end-if

     write dokumer-rec from detay

     initialize dokumer-rec detay
     move "B"                  to det-dokumer-20(1:1)
     write dokumer-rec from detay


*/ DOKUMER OZELLIKLER-REC
     initialize dokumer-rec detay
     move "O" to det-dokumer-20(1:)
     move "E" to dokumer-oto-sayfa-basi
     move 56  to dokumer-oto-sayfa-satir
     move "|" to dokumer-detay-kolon-ayirici
     move "RRLLRRRRRRRRRRRRRRRRRRRRR" to dokumer-align-occ
     move dokumer-ozellikler-rec     to det-filler
     write dokumer-rec from detay
*/ BASLIKLAR  

     initialize dokumer-rec detay 
     move "1"          to det-dokumer-20(10:1)
     move "D1"         to det-dokumer-20(1:2)
     move "Oda "               to det-1
     move "#"                  to det-1-1
     move "Rez No "           to det-2
     if link-var = 2 then 
        move "Rez.No  "           to det-2
     end-if
     move "Adi       "         to det-3
     move "Soyadi    "         to det-4
     move "Pax "               to det-5
     move "Chi."               to det-6
     move "Free"               to det-7
     move "Beb "               to det-77
     move "Check/In  "         to det-8
     move "Check/Out "         to det-9
     move "Gece"               to det-10
     move "Aksiyon"                to det-100
     move "EB"                 to det-101
     move "Kic"                to det-102
     move "KKP"                to det-104
     move "Spc"                to det-105
     move "Ozl"                to det-106
     move "An"                 to det-200
     move "F.Kon"              to det-201
     move "O.Kon"              to det-okonum
     move "D.Anl"              to det-202
     move "UG"                 to det-103
     move "Voucher "           to det-11
     move "Ham Fiyat"          to det-ham
     move "TL.  Tutar     "    to det-12
     move "DV.  Tutar    "     to det-13
     move "TL.  Toplam    "    to det-14 
     move "DV.  Toplam   "     to det-15
     move "Dvz"                to det-16
     move "DV.  Toplam   "     to det-15
     move "DV. Top REEL   "     to det-bas
     move "Doviz degeri"       to det-17
     move "SatT"               to det-49
     move "G"                   to det-59
     move "Aciklama     "      to det-50
     move "|" to fil-1 fil-1-1 fil-2 fil-3 fil-4 fil-5 fil-6
                 fil-7 fil-77 fil-8 fil-9 fil-10 fil-11 fil-ham fil-12 
                 fil-13 fil-14 fil-15 fil-bas fil-16 fil-17 fil-49 fil-59 fil-50 
                 fil-100 fil-101 fil-102 fil-103 fil-202
                 fil-104 fil-105 fil-106 fil-200 fil-201 fil-okonum
     write dokumer-rec from detay

     initialize dokumer-rec detay
     move "D2"           to det-dokumer-20(1:2)
     move "-"            to det-dokumer-20(5:1)
     move all "-" to det-1 det-1-1 det-2 det-3 det-4 det-5 det-6
                  det-7 det-77 det-8 det-9 det-10 det-11 det-ham det-12 
                  det-13 det-14 det-15 det-bas det-16 det-17 det-49 det-59 det-50
                  det-100 det-101 det-102 det-103 det-202
                  det-104 det-105 det-106 det-200 det-201 det-okonum
     write dokumer-rec from detay
*********************************
              
              initialize fs-takas doviz-kontrol gece-say kont-git-tar
                         kont-gel-tar kont-acenta kont-eb-ayrisayfa  kont-donem kont-firma
                            move "F" to kont-eb-ayrisayfa
              perform with test after until fs-takas = "10"
                    
                    read takas next no lock end move "10" to fs-takas
                    not at end
                      if takas-konuk-duzeltme = 1 and
                         cl-cikma = 1
                           exit perform cycle 
                      end-if 

                      if doviz-kontrol = zeroes 
                         move takas-doviz to doviz-kontrol,
                      end-if
                      if gece-say      = zeroes 
                         move takas-gece  to gece-say,
                      end-if
                      if kont-git-tar      = zeroes 
                         move takas-git-tar  to kont-git-tar,
                      end-if
                      if kont-gel-tar      = zeroes 
                         move takas-gel-tar  to kont-gel-tar,
                      end-if
                       if kont-donem       = zeroes 
                         move takas-donem  to kont-donem,
                      end-if
                      if kont-acenta      = spaces 
                         move takas-acenta  to kont-acenta
                      end-if
                      if kont-firma = spaces
                         move takas-firma to kont-firma
                      end-if
                      if kont-referans    = spaces  or 0
                          move  takas-referans to kont-referans
                      end-if
*                      stop " "

                      if kont-eb-ayrisayfa     = "F"  
                         move takas-eb-ayrisayfa  to kont-eb-ayrisayfa
                      end-if
                      if  kont-gel-tar = takas-gel-tar and kont-acenta = takas-acenta  and
                         takas-referans = kont-referans  and kont-firma = takas-firma
                      if  kont-git-tar = takas-git-tar and doviz-kontrol = takas-doviz 

                        and takas-eb-ayrisayfa = kont-eb-ayrisayfa 
                        then continue
                        else 
                          if sayfa-basi-v = 1 
                        perform liste-ara-toplam,
                        end-if
                             initialize ara-toplam,
                             if ( kont-git-tar not = takas-git-tar and cout-ayri-v  = 1) or 
                                (takas-eb-ayrisayfa not = kont-eb-ayrisayfa and eb-ayri-v =1) then 
                               initialize dokumer-rec detay
                               move "-" to det-1
                               move "P" to det-dokumer-20(5:1)
                              if sayfa-basi-v = 1  then 
                                write dokumer-rec from detay
                             end-if
                             end-if
                             move takas-eb-ayrisayfa to kont-eb-ayrisayfa
                             move takas-git-tar   to kont-git-tar
                             move takas-doviz   to doviz-kontrol,
                       end-if
                      else
                      if sayfa-basi-v = 1 
                           perform liste-ara-toplam,

                             initialize ara-toplam

                              perform liste-toplam
                           else
                            add t-oda to gt-oda
                            add t-pax to gt-pax
                            add t-chi to gt-chi
                            add t-fre to gt-fre
                            add t-beb to gt-beb
                            add t-tl-tutar  to gt-tl-tutar
                            add t-dv-tutar  to gt-dv-tutar
                            add t-tl-toplam to gt-tl-toplam
                            add t-dv-toplam to gt-dv-toplam
                              add t-dv-toplam-reel to gt-dv-toplam-reel



                       end-if
                              initialize toplam,
                              initialize dokumer-rec detay
                               move "-" to det-1
                               move "P" to det-dokumer-20(5:1)
                             if sayfa-basi-v = 1  then 
                               write dokumer-rec from detay                          
                             end-if
                             move takas-eb-ayrisayfa to kont-eb-ayrisayfa
                             move takas-gel-tar to kont-gel-tar
                             move takas-acenta to  kont-acenta,
                             move takas-firma to kont-firma
                             move takas-referans to kont-referans
                             move takas-git-tar to kont-git-tar 
                             move takas-doviz   to doviz-kontrol
                       end-if
                      
                      perform detay-ata
                      write dokumer-rec from detay
                      if yan-goster = 1
                         perform yan-detay-ata
                      end-if
                    end-read
              end-perform
              if sayfa-basi-v = 1 
                 perform liste-ara-toplam
                 perform liste-toplam
                 else
                    add t-oda to gt-oda
                    add t-pax to gt-pax
                    add t-chi to gt-chi
                    add t-fre to gt-fre
                    add t-beb to gt-beb
                    add t-tl-tutar  to gt-tl-tutar
                    add t-dv-tutar  to gt-dv-tutar
                    add t-tl-toplam to gt-tl-toplam
                    add t-dv-toplam to gt-dv-toplam
                      add t-dv-toplam-reel to gt-dv-toplam-reel
              end-if
              perform g-liste-toplam 
              close dokumer
              if link-var > 0 then 
                        set dokumer-grid to true
              end-if
              call dokumer-prog on exception
                   perform callerr-proc
              not on exception
                   cancel dokumer-prog
              end-call
              close konuk takas cast kur doviz rez  takvim kodlar02 grup  yanrez hesayr odalar
              close konum aksiyhrk fiyat fiyatana   takasdov 
              delete file dokumer
***********************************************
******  f7 ile fatura basacak isallah
***************************************
    when 7      
           
            
        open input konuk  kur doviz konum rez  takvim kodlar02  grup yanrez
          open input  aksiyhrk fiyat fiyatana hesayr   cast  odalar
        initialize konuk-rec toplam ara-toplam ilk-sayfa
        
             perform takas-aktar thru takas-aktar-exit 
            
              initialize takas-rec toplam kont-eb-ayrisayfa 
                         kont-git-tar gece-say doviz-kontrol kont-referans
              move "F" to kont-eb-ayrisayfa
              start takas key not < takas-kodu2 invalid
                    initialize mesaj-link
                    move 04 to mesaj-no
                    perform mesaj-ver
                    close konuk takas kur doviz kodlar02 hesayr
                    close aksiyhrk  fiyat fiyatana takvim rez  konum    cast  odalar
                    exit paragraph
              end-start

              open i-o genelfis
              move 1 to genelfis-anahtar
              read genelfis no lock invalid
                   accept print-no from time
              not invalid
                   add 1 to print-no
                   rewrite genelfis-rec end-rewrite
              end-read
              close genelfis
**************************
     initialize dokumer-rec dokumer-anah dokumer-ozellikler-rec
                dokumer-dosya gt-toplam
        
      open output takasdov close takasdov open i-o takasdov
     set  dokumer-asya-set to true
     move print-no         to dokumer-dosya-adi
     open output dokumer




            add 1 to dokumer-anah
            write dokumer-rec


              initialize fs-takas doviz-kontrol gece-say kont-git-tar
                         kont-gel-tar kont-acenta kont-eb-ayrisayfa kont-folio
                         kont-donem  kont-firma
                            move "F" to kont-eb-ayrisayfa
              perform with test after until fs-takas = "10"
                    
                    read takas next no lock end move "10" to fs-takas
                    not at end
                      if kont-donem = zeroes 
                         move takas-donem to kont-donem,
                      end-if 
                      if doviz-kontrol = zeroes 
                         move takas-doviz to doviz-kontrol,
                      end-if
                      if gece-say      = zeroes 
                         move takas-gece  to gece-say,
                      end-if
                      if kont-git-tar      = zeroes 
                         move takas-git-tar  to kont-git-tar,
                      end-if
                      if kont-gel-tar      = zeroes 
                         move takas-gel-tar  to kont-gel-tar,
                      end-if
                      if kont-folio = spaces then 
                          move takas-folio to kont-folio
                      end-if
                      if kont-acenta      = spaces 
                         move takas-acenta  to kont-acenta
                      end-if
                      if kont-firma      = spaces 
                         move takas-firma  to kont-firma
                      end-if
*                      stop " "
                      if kont-eb-ayrisayfa     = "F"  
                         move takas-eb-ayrisayfa  to kont-eb-ayrisayfa
                      end-if
                      if  kont-gel-tar = takas-gel-tar and kont-acenta = takas-acenta 
                         and takas-referans = kont-referans and kont-firma = takas-firma 
                      if  kont-git-tar = takas-git-tar and doviz-kontrol = takas-doviz 
                        and takas-eb-ayrisayfa = kont-eb-ayrisayfa and munferit = 0
                        then continue
                        else 
                             initialize ara-toplam,
                             if (( kont-git-tar not = takas-git-tar and cout-ayri-v  = 1) or 
                                (takas-eb-ayrisayfa not = kont-eb-ayrisayfa and eb-ayri-v =1)) 
                                or ( munferit = 1 and takas-folio not = kont-folio )  then 
                                 if sayfa-basi-v = 1  then 
                                    perform fatura-kapat
                                 end-if
                             end-if
                              move takas-eb-ayrisayfa to kont-eb-ayrisayfa
                             move takas-gel-tar to kont-gel-tar
                             move takas-acenta to  kont-acenta,
                             move takas-firma to  kont-firma,
                             move takas-referans to kont-referans
                             move takas-git-tar to kont-git-tar 
                             move takas-doviz   to doviz-kontrol
                             move takas-folio to kont-folio
                             move takas-donem to kont-donem
                       end-if
                      else
                             if sayfa-basi-v = 1  then
                                 perform fatura-kapat
                              end-if
                              move takas-eb-ayrisayfa to kont-eb-ayrisayfa
                             move takas-gel-tar to kont-gel-tar
                             move takas-acenta to  kont-acenta,
                              move takas-firma to  kont-firma,
                            
                             move takas-referans to kont-referans
                             move takas-git-tar to kont-git-tar 
                             move takas-doviz   to doviz-kontrol
                             move takas-folio to kont-folio
                             move takas-donem to kont-donem
                       end-if
                      if son-voucher not = takas-voucher then 
                        add 1 to voucher-say
                        move takas-voucher to son-voucher
                      end-if
                      if acenta-faturada-voucher = 0 or acenta-faturada-voucher not numeric
                        move 99 to acenta-faturada-voucher
                      end-if
                      if  ( ay-ayir = 1 and takas-donem not = kont-donem )
                             perform fatura-kapat
                             move takas-eb-ayrisayfa to kont-eb-ayrisayfa
                             move takas-gel-tar to kont-gel-tar
                             move takas-acenta to  kont-acenta,
                              move takas-firma to  kont-firma,
                            
                             move takas-referans to kont-referans
                             move takas-git-tar to kont-git-tar 
                             move takas-doviz   to doviz-kontrol
                             move takas-folio to kont-folio
                             move takas-donem to kont-donem
                       end-if
                       
                       if voucher-say > acenta-faturada-voucher then
                                 perform fatura-kapat
                              
                             move takas-eb-ayrisayfa to kont-eb-ayrisayfa
                             move takas-gel-tar to kont-gel-tar
                             move takas-acenta to  kont-acenta,
                               move takas-firma to  kont-firma,
                            
                             move takas-referans to kont-referans
                             move takas-git-tar to kont-git-tar 
                             move takas-doviz   to doviz-kontrol
                             move takas-folio to kont-folio
                             move takas-donem to kont-donem
                           move 1 to voucher-say
                       end-if

                      perform fatura-detaylar
                      
                    end-read
              end-perform
              if fatura-acik = 1 then 
                 perform fatura-kapat
               end-if
              
              set dokumer-yazici-text to true
            move "H"                to dokumer-genel-baslik-yaz
            close dokumer

              call dokumer-prog on exception
                   perform callerr-proc
              not on exception
                   cancel dokumer-prog
              end-call
              close konuk takas takasdov  kur doviz  cast kodlar02 konum, 
              close aksiyhrk fiyat fiyatana takvim rez  grup hesayr  yanrez  odalar
              delete file dokumer takas takasdov
    end-evaluate.
     .

 takas-aktar.

    move fatt-tarih to ilk-cik-tarih
    move fatt-tarih to son-cik-tarih
    display acc-01 acc-02 acc-03 acc-04 acc-05 acc-06
            acc-01a acc-02a acc-03a acc-04a acc-05a acc-06a.

    perform takas-dosya-ac.
    move "I" to rez-durumu
  
    move ilk-tarih to takvim-anah
    start takvim key <= takvim-anah  
     invalid
           move takvim-anah to ilk-start-tarih
     not invalid
        read takvim previous no lock end-read
        read takvim previous no lock 
          at end
            move takvim-anah to ilk-start-tarih
          not end
           move takvim-anah to ilk-start-tarih
         end-read
    end-start
    
    move son-tarih to takvim-anah
    start takvim key >= takvim-anah
        invalid
           move takvim-anah to son-start-tarih
        
        not invalid
        read takvim next no lock end-read
        read takvim next no lock 
          at end
            move takvim-anah to son-start-tarih
          not end
           move takvim-anah to son-start-tarih
         end-read
    end-start
    



    move ilk-start-tarih   to rez-gir-tar
    
    start rez key not < rez-gir 
      invalid 
          continue
      not invalid
          read rez next no lock
          end-read    
          perform until fs-rez = "10" or rez-durumu not  = "I" 
             or rez-gir-tar > son-start-tarih

                 if rez-folio > 0 then 
                   move rez-folio to konuk-folio
                   read konuk no lock 
                     invalid continue
                   not invalid
                     if konuk-duzeltme = 1
                        move 1 to takas-konuk-duzeltme
                     end-if 
                     if konuk-gec-giris = 1 then
                        move rez-gir-tar to takvim-anah
                        start takvim key <= takvim-anah  
                         invalid
                           move takvim-anah to rez-gir-tar
                        
                        not invalid
                        read takvim previous no lock end-read
                        read takvim previous no lock 
                          at end
                            move takvim-anah to rez-gir-tar
                          not end
                           move takvim-anah to rez-gir-tar
                         end-read
                        end-start
                                     
                     
                     end-if
                    end-read    
                  end-if
                  
                 if ( rez-acenta = acn-kod or acn-kod = spaces ) 
                    and rez-gir-tar >= ilk-tarih 
                     
                    and rez-gir-tar <= son-tarih
                    and rez-cik-tar >= ilk-cik-tarih
                    and rez-cik-tar <= son-cik-tarih
                    move "B" to kodlar02-tipi
                    move rez-odeme-tipi to kodlar02-kodu
                    read kodlar02 no lock invalid
                     move spaces to kodlar02-REC
                    end-read
                  if ode-posting not = "H" and 
                  ( rez-odano = rapor-odano or rapor-odano = spaces )
*                          if rapor-ref not = 0 
*                             perform ref-bul
*                           end-if
*                           if rapor-ref = 0 or rapor-ref = konum-ref then  
                             if onkpara-referans-var = 1 then 
                                perform ref-filtre
                                if   ref-gecti then 
                                    if filtre-var = 1 then
                                       perform filtre
                                          if filtre-gecti  = 1 then 
                                              perform  tek-rez-yaz
                                           end-if
                                         else
                                      perform  tek-rez-yaz
                                     end-if

                                end-if
                                else
                                    if filtre-var = 1 then 
                                       perform filtre
                                          if filtre-gecti  = 1 then 
                                              perform  tek-rez-yaz
                                           end-if
                                         else
                                      perform  tek-rez-yaz
                                     end-if
                             end-if
                             
*                           end-if
                  end-if
                 end-if
              read rez next no lock
                  end move "10" to fs-rez
              end-read
           end-perform
    end-start.
           .
 takas-aktar-exit.
    exit.

*
 ref-bul.
     MOVE rez-ODA-KONUMU TO KONUM-ANAHTAR
       READ KONUM NO LOCK INVALID
         DISPLAY MESSAGE BOX "kasa-KONUK-23644"
       END-READ.

*
 gece-al.
    initialize takas-gece takvim-rec.
    move rez-gir-tar to takvim-anah.
*    open input takvim
    start takvim key not < takvim-anah invalid move 1 to takas-gece continue,

        not invalid,
        move spaces to var-yok,
        perform with test after until var,
            read takvim next no lock end move "V" to var-yok,

                not end,

                evaluate true
                    when takvim-anah = rez-cik-tar move "V" to var-yok,
                    when takvim-anah > rez-cik-tar move "V" to var-yok,
                    when takvim-anah not > rez-cik-tar,
                         add 1 to takas-gece,
                end-evaluate,
            end-read,
        end-perform,
    end-start
*    close takvim
    .

 gece-al-exit.
    exit.
 takas-dosya-ac.
    open i-o genelfis.
    move 1 to genelfis-anahtar.
    read genelfis no lock invalid move 1 to ekran-fis-1.
 
    add 1 to ekran-fis-1.
   
    move ekran-fis-1(2:) to takas-no takasdov-no.
    move k-kodu-tasi to takasdov-k
    rewrite genelfis-rec invalid write genelfis-rec.
    close genelfis.
    
    open output takas 
    close takas 
    open i-o takas with mass-update.
    initialize takas-rec.
 liste-ara-toplam.
    initialize dokumer-rec detay
    move "-"            to det-dokumer-20(5:1)
    move all "-" to det-1 det-1-1 det-2 det-3 det-4 det-5 det-6
                 det-7 det-77 det-8 det-9 det-10 det-11 det-ham det-12 
                 det-13 det-14 det-15 det-bas det-bas det-16 det-17  det-49 det-59 det-50
                 det-100 det-101 det-103 det-102 det-202
                 det-104 det-105 det-106 det-200 det-201 det-okonum
    write dokumer-rec from detay
    initialize dokumer-rec detay
    move "- Toplam -" to det-3.
    move a-oda        to z-goster.
    move z-goster     to det-1.
    move a-pax        to z-goster.
    move z-goster     to det-5.
    move a-chi        to z-goster.
    move z-goster     to det-6.
    move a-fre        to z-goster.
    move z-goster     to det-7.
    move a-beb        to z-goster.
    move z-goster     to det-77.
    move a-tl-tutar   to z-2.
    move z-2          to det-12.
    move a-dv-tutar   to z-2.
    move z-2          to det-13.
    move a-tl-toplam  to z-1.
    move z-1          to det-14.
    move a-dv-toplam  to z-1.
    move z-1          to det-15.
     move a-dv-toplam-reel  to z-1.
    move z-1          to det-bas.
    move "A"          to det-dokumer-20(3:1)
    move 481          to det-renk1
    move "1"          to det-dokumer-20(10:1)
    move "|" to fil-1 fil-1-1 fil-2 fil-3 fil-4 fil-5 fil-6
                fil-7 fil-77 fil-8 fil-9 fil-10 fil-11 fil-ham  fil-12 
                fil-13 fil-14 fil-15 fil-bas fil-16 fil-17 fil-49 fil-59 fil-50
                fil-100 fil-101 fil-102 fil-103 fil-202

                fil-104 fil-105 fil-106 fil-200 fil-201  fil-okonum

    perform acenta-yaz
    write dokumer-rec from detay.
    initialize dokumer-rec detay
    move "-"            to det-dokumer-20(5:1)
    move all "-" to det-1 det-1-1 det-2 det-3 det-4 det-5 det-6
                 det-7 det-77 det-8 det-9 det-10 det-11 det-ham det-12 
                 det-13 det-14 det-15 det-bas det-bas  det-16 det-17 det-49 det-59 det-50
                 det-100 det-101 det-103 det-104 det-105 det-106
                 det-102 det-200 det-201 det-202 det-okonum
    write dokumer-rec from detay.
 detay-ata.
    initialize dokumer-rec detay
    if takas-peryod = 0 or (takas-peryod =  1 and eski-tip = 0 ) then
    move takas-oda           to det-1
    move takas-folio         to det-2
    move takas-adi           to det-3
    move takas-soyadi        to det-4
    move takas-pax           to z-goster
    move z-goster            to det-5
    move takas-chi           to z-goster
    move z-goster            to det-6
    move takas-fre           to z-goster
    move z-goster            to det-7
    move takas-beb           to z-goster
    move z-goster            to det-77
    move takas-gec-giris     to det-59 
    move takas-isl(1:2)      to det-49(4:2)
    move "/"                to det-49(3:1)
    move takas-isl(3:2)      to det-49(1:2)
    move takas-anlasma to det-200
    move takas-konum   to det-201
    move takas-okonum  to det-okonum
    move takas-def-anlasma      to det-202
    move takas-gel-gun       to xgun
    move takas-gel-ay        to xay
    move takas-gel-yil       to xyil
    move xtarih to det-8
    move takas-git-gun       to xgun
    move takas-git-ay        to xay
    move takas-git-yil       to xyil
    move xtarih to det-9
    end-if
    
    move takas-gece          to det-10.
    move takas-ode           to det-100.
    move takas-eb             to det-101.
    move takas-kick          to det-102.
    move takas-kick2          to det-104.
    move takas-special       to det-105.
    move takas-ozel          to det-106.
    move takas-ug            to det-103.
    move takas-ham           to z-2.
    move z-2                 to det-ham.
    move takas-gercek-oda    to det-1-1
    move takas-voucher       to det-11.
    move takas-tl-tutar      to z-2.
    move z-2                 to det-12.
    move takas-dv-tutar      to z-2.
    move z-2                 to det-13.   

    initialize doviz-rec.
    move takas-doviz         to doviz-kodu.   
         read doviz no lock invalid move all "*******" to d-kisa-adi. 
              move d-kisa-adi   to det-16.
    move takas-dv-degeri     to z-22.
    move z-22                to det-17.
    move takas-not           to det-50.
**** Düzelt !!!

*    initialize takas-tl-toplam takas-dv-toplam.
*    compute takas-tl-toplam = takas-tl-tutar * takas-gece.
*    compute takas-dv-toplam = takas-dv-tutar * takas-gece.
    move takas-tl-toplam     to z-1.
    move z-1                 to det-14.
    move takas-dv-toplam     to z-1.
    move z-1                 to det-15.
    move takas-dv-reel     to z-1.
    move z-1                 to det-bas.
    if takas-peryod = 0 or (takas-peryod =  1 and eski-tip = 0 ) then
    compute t-oda       = t-oda       + 1
    compute t-pax       = t-pax       + takas-pax
    compute t-chi       = t-chi       + takas-chi
    compute t-fre       = t-fre       + takas-fre
    compute t-beb       = t-beb       + takas-beb
    end-if
    compute t-tl-tutar  = t-tl-tutar  + takas-tl-tutar.
    compute t-dv-tutar  = t-dv-tutar  + takas-dv-tutar.
    compute t-tl-toplam = t-tl-toplam + takas-tl-toplam.
    compute t-dv-toplam = t-dv-toplam + takas-dv-toplam.
       compute t-dv-toplam-reel = t-dv-toplam-reel + takas-dv-reel.
    if  takas-peryod = 0 or (takas-peryod =  1 and eski-tip = 0 )  then 
    compute a-oda       = a-oda       + 1
    compute a-pax       = a-pax       + takas-pax
    compute a-chi       = a-chi       + takas-chi
    compute a-fre       = a-fre       + takas-fre
    compute a-beb       = a-beb       + takas-beb
    end-if
    compute a-tl-tutar  = a-tl-tutar  + takas-tl-tutar.
    compute a-dv-tutar  = a-dv-tutar  + takas-dv-tutar.
    compute a-tl-toplam = a-tl-toplam + takas-tl-toplam.
    compute a-dv-toplam = a-dv-toplam + takas-dv-toplam.
     compute a-dv-toplam-reel = a-dv-toplam-reel + takas-dv-reel.
       if takas-dv-reel <> takas-dv-toplam
    move "A"          to det-dokumer-20(3:1)
    move 176          to det-renk1
    move "1"          to det-dokumer-20(10:1)
    end-if
    move "|" to fil-1 fil-1-1 fil-2 fil-3 fil-4 fil-5 fil-6
                fil-7 fil-77 fil-8 fil-9 fil-10 fil-11 fil-ham  fil-12 
                fil-13 fil-14 fil-15 fil-bas fil-16 fil-17 fil-49 fil-59 fil-50
                fil-100 fil-101 fil-102 fil-103 fil-202
                fil-104 fil-105 fil-106 fil-200 fil-201 fil-okonum
                       .
*
 acenta-yaz.
       open input acenta
       move kont-acenta to acenta-kodu 
       read acenta no lock invalid continue
       end-read
       move acenta-adi(1:10) to det-8
       move acenta-adi(11:1) to fil-8
       move acenta-adi(12:)  to det-9
       close acenta
       open input firma
       if acenta-tipi = 3 then 
         move kont-firma to firma-kodu
         read firma no lock invalid continue
         end-read
           move firma-adi(1:10) to det-8
           move firma-adi(11:1) to fil-8
           move firma-adi(12:)  to det-9
        end-if
        close firma
        .


 liste-toplam.
    
    initialize dokumer-rec detay

    move "Acenta Top" to det-3.
    if kont-firma not = spaces then 
        move "Firma Top" to det-3
  
    end-if
    add t-oda to gt-oda
    add t-pax to gt-pax
    add t-chi to gt-chi
    add t-fre to gt-fre
    add t-beb to gt-beb
    add t-tl-tutar  to gt-tl-tutar
    add t-dv-tutar  to gt-dv-tutar
    add t-tl-toplam to gt-tl-toplam
    add t-dv-toplam to gt-dv-toplam
      add t-dv-toplam-reel to gt-dv-toplam-reel

    move t-oda        to z-goster.
    move z-goster     to det-1.
    move t-pax        to z-goster.
    move z-goster     to det-5.
    move t-chi        to z-goster.
    move z-goster     to det-6.
    move t-fre        to z-goster.
    move z-goster     to det-7.
    move t-beb        to z-goster.
    move z-goster     to det-77.
    move t-tl-tutar   to z-2.
    move z-2          to det-12.
    move t-dv-tutar   to z-2.
    move z-2          to det-13.
    move t-tl-toplam  to z-1.
    move z-1          to det-14.
    move t-dv-toplam  to z-1.
    move z-1          to det-15.
       move t-dv-toplam-reel  to z-1.
    move z-1          to det-bas.
    move "A"          to det-dokumer-20(3:1)
    move 481          to det-renk1
    move "1"          to det-dokumer-20(10:1)
    move "|" to fil-1 fil-1-1 fil-2 fil-3 fil-4 fil-5 fil-6
                fil-7 fil-77 fil-8 fil-9 fil-10 fil-11 fil-ham  fil-12 
                fil-13 fil-14 fil-15 fil-bas fil-16 fil-17 fil-49 fil-59 fil-50
                fil-100 fil-101 fil-102 fil-103 fil-202
                fil-104 fil-105 fil-106 fil-200 fil-201 fil-okonum.
    perform acenta-yaz     
    write dokumer-rec from detay.
    initialize dokumer-rec detay
*****************************************
    initialize dokumer-rec detay
    move "-"            to det-dokumer-20(5:1)
    move all "-" to det-1 det-1-1 det-2 det-3 det-4 det-5 det-6
                 det-7 det-77 det-8 det-9 det-10 det-11 det-ham  det-12 
                 det-13 det-14 det-15 det-bas det-16 det-17 det-49 det-50 det-59 
                 det-100 det-101 det-102 det-103
                 det-104 det-105 det-106 det-202 det-okonum
    write dokumer-rec from detay.

*
 g-liste-toplam.
    
    initialize dokumer-rec detay

    move "Genel Top." to det-3.
    move gt-oda        to z-goster.
    move z-goster     to det-1.
    move gt-pax        to z-goster.
    move z-goster     to det-5.
    move gt-chi        to z-goster.
    move z-goster     to det-6.
    move gt-fre        to z-goster.
    move z-goster     to det-7.
    move gt-beb        to z-goster.
    move z-goster     to det-77.
    move gt-tl-tutar   to z-2.
    move z-2          to det-12.
    move gt-dv-tutar   to z-2.
    move z-2          to det-13.
    move gt-tl-toplam  to z-1.
    move z-1          to det-14.
    move gt-dv-toplam  to z-1.
    move z-1          to det-15.
    move genel-share  to z-goster
    move z-goster     to det-2
      move gt-dv-toplam-reel  to z-1.
    move z-1          to det-bas.
    
    move "A"          to det-dokumer-20(3:1)
    move 481          to det-renk1
    move "1"          to det-dokumer-20(10:1)
    move "|" to fil-1 fil-1-1 fil-2 fil-3 fil-4 fil-5 fil-6
                fil-7 fil-77 fil-8 fil-9 fil-10 fil-11 fil-ham  fil-12 
                fil-13 fil-14 fil-15 fil-bas fil-16 fil-17 fil-49 fil-59 fil-50
                fil-100 fil-101 fil-102 fil-103 fil-202
                fil-104 fil-105 fil-106 fil-200 fil-201 fil-okonum.

    write dokumer-rec from detay.
    initialize dokumer-rec detay
*****************************************
    initialize dokumer-rec detay
    move "-"            to det-dokumer-20(5:1)
    move all "-" to det-1 det-1-1 det-2 det-3 det-4 det-5 det-6
                 det-7 det-77 det-8 det-9 det-10 det-11 det-ham  det-12 
                 det-13 det-14 det-15 det-16 det-17  det-49 det-50 det-59 
                 det-100 det-101 det-102 det-103 det-202
                 det-104 det-105 det-106 det-okonum
    write dokumer-rec from detay.
    
*
 acc-07-Aft-Procedure.
      open input acenta
      if acn-kod = spaces 
        move "Tum Acentalar" to acenta-adi
      else 
      move acn-kod    to acenta-kodu
      read acenta no lock invalid
           move "Tanimsiz Acenta ..." to acenta-adi
           move 4 to accept-control
           move 12 to control-id
      end-read
      end-if.
      display lb-acenadi.
      close acenta. 
     
     .

*
 fiyat-bul.
     
     move 0 to oda-fiyati
     move rez-acenta        to fiyat-acenta
     move takvim-anah       to fiyat-tarih
     move rez-tipi          to fiyat-rez-tipi
     move rez-pan-tipi      to fiyat-pan-tipi
     move rez-banka         to fiyat-banka
     move rez-doviz         to fiyat-doviz
     move rez-anlasma       to fiyat-anlasma
     move rez-buyuk         to fiyat-buyuk
     move rez-kucuk         to fiyat-kucuk
     read fiyat no lock
       invalid
         go fiyat-bulundu
     end-read
     move fiyat-acenta    to fiyatana-acenta
     move fiyat-bas-tarih to fiyatana-ilk-tarih
     move fiyat-bit-tarih to fiyatana-son-tarih
     move fiyat-rez-tipi  to fiyatana-rez-tipi
     move fiyat-pan-tipi  to fiyatana-pan-tipi
     move fiyat-banka     to fiyatana-banka
     move fiyat-doviz     to fiyatana-doviz
     move fiyat-anlasma   to fiyatana-anlasma
     move fiyat-buyuk     to fiyatana-buyuk
     move fiyat-kucuk     to fiyatana-kucuk
     read fiyatana no lock
       invalid 
         go fiyat-bulundu
     end-read
     if rez-fiyat-fix = "E"
        go fiyat-bulundu
     end-if
 
     move fiyatana-oda-fiyati(rez-oda-konumu) to oda-fiyati
     
     if rez-fiyat-konumu not = spaces and
        rez-fiyat-konumu not = zeroes
        move fiyatana-oda-fiyati(rez-fiyat-konumu) to oda-fiyati
     end-if
     move oda-fiyati to takas-ham
*/********* 
     if rez-nor-indirim not = 0 
        compute oda-fiyati rounded = 
              (((oda-fiyati * rez-nor-indirim) / 100) - oda-fiyati)
     end-if
*/Early booking orani var ve early booking uygulanacak ise 
      
     if rez-eb = "E" and fiyatana-eb-oran not = 0         
        move fiyatana-eb-oran to takas-eb(1:2)
        move fiyatana-eb-kusur to takas-eb(3:2)
     compute oda-fiyati rounded = 
            (((oda-fiyati * (fiyatana-eb-oran +( fiyatana-eb-kusur / 100) )) / 100) - oda-fiyati)
     end-if
     if  fiyatana-ug-oran not = 0 and gun-s >= fiyatana-ug-geceleme 
           and rez-ug-ind = 1 then  
            move fiyatana-ug-oran to takas-ug
       compute oda-fiyati rounded = 
              (((oda-fiyati * (fiyatana-ug-oran + (fiyatana-ug-kusur / 100))) / 100) - oda-fiyati)
       end-if.
*         if k-kodu-tasi = "X   " then stop " " end-if
        if rez-ozel-durum-car > 0
       move rez-ozel-durum to takas-ozel
         
        evaluate rez-ozel-tip 
         
             when "T"
                if aksiyon-var and aksiyhrk-sondan = 1 
                compute oda-fiyati rounded =   oda-fiyati - 
                 rez-ozel-durum-car / aksiyhrk-ode
                else
                 compute oda-fiyati rounded =   oda-fiyati - 
                 rez-ozel-durum-car / gun-s 
               end-if    
             when "S"
                compute oda-fiyati rounded = 
                       oda-fiyati - rez-ozel-durum-car

             when "E" 
                  compute oda-fiyati rounded = 
                       oda-fiyati + rez-ozel-durum-car
             when other
                  compute oda-fiyati rounded = 
                       (oda-fiyati * rez-ozel-durum-car) / 100
         end-evaluate
       end-if.
*/Kick back
     if fiyatana-kick-back not = 0 
        move fiyatana-kick-back to takas-kick
        compute oda-fiyati rounded = 
            (((oda-fiyati * fiyatana-kick-back) / 1000) - oda-fiyati)
     end-if
     .      
      
       if fiyatana-kick-back2 <> 0
        move fiyatana-kick-back2 to takas-kick2
       compute oda-fiyati rounded = 
              (((oda-fiyati * fiyatana-kick-back2) / 1000) - oda-fiyati)
       end-if.
       

 aksiyonlu-uyar. 
     if rez-aksiyon-eh = "H" 
        set aksiyon-yok to true
        initialize takas-ode
*     else
*        if rez-eb = "E" and fiyatana-eb-oran not = 0
*           set aksiyon-yok to true
*        end-if
     end-if

     if aksiyon-var
        if aksiyhrk-sondan not = 1 then 
          compute oda-fiyati rounded = ((oda-fiyati * aksiyhrk-ode) / aksiyhrk-gecele)          
          end-if   
        end-if
      if rez-special-eh = 1 
        set special-yok to true
        initialize special-tahsil
*     else
*        if rez-eb = "E" and fiyatana-eb-oran not = 0
*           set aksiyon-yok to true
*        end-if
     end-if

     if special-var

         if special-ekle = 1 then move -1 to special-eksi-car
             else move 1 to special-eksi-car
             end-if
             evaluate special-hes-tipi
               when 1
                   compute oda-fiyati rounded = oda-fiyati - 
                         (((special-tahsil) * (rez-buyuk + ( rez-kucuk / 2 ) ) / special-gece)
                         * special-eksi-car )
               when 2
                   compute oda-fiyati rounded = oda-fiyati - 
                         (((special-tahsil) * (rez-buyuk + ( rez-kucuk ) ) / special-gece)
                          * special-eksi-car )
               when 3
                   compute oda-fiyati rounded = oda-fiyati - 
                         (((special-tahsil) / special-gece)
                          * special-eksi-car )
               when 4
                   compute oda-fiyati rounded = oda-fiyati - 
                         (((special-tahsil) * rez-buyuk)
                          * special-eksi-car )
               when 5
                   compute oda-fiyati rounded = oda-fiyati - 
                         (((special-tahsil) * (rez-buyuk + ( rez-kucuk / 2 ) ) )
                          * special-eksi-car )
               when 6
                   compute oda-fiyati rounded = oda-fiyati - 
                         (((special-tahsil) * (rez-buyuk + ( rez-kucuk ) ) )
                          * special-eksi-car )
               when 7
                   compute oda-fiyati rounded = oda-fiyati - 
                         (((special-tahsil))
                          * special-eksi-car )

               when other
                   compute oda-fiyati rounded = oda-fiyati - 
                         (((special-tahsil) * rez-buyuk / special-gece)
                          * special-eksi-car )
              end-evaluate 
          
               move  special-tahsil to zz
               move zz to takas-special
     end-if

*****if oda-fiyati <> rez-fiyati 
     move oda-fiyati  to ilk-rez-fiyati.
     .
 aksiyonlu-uyar-exit. 
     exit.
 fiyat-bulundu. 
        if rez-eb = "E" and fiyatana-eb-oran not = 0 
             move fiyatana-eb-oran  to takas-eb(1:2)
             move fiyatana-eb-kusur to takas-eb(3:2)
        END-if.
        if  fiyatana-ug-oran not = 0 and gun-s >= fiyatana-ug-geceleme 
            and rez-ug-ind = 1 then  
            move fiyatana-ug-oran to takas-ug       
       end-if. 
     
 fiyat-bul-exit. 
     exit
     .
*
 gun-bul2.
     initialize gun-s

     move rez-gir-tar to takvim-anah
     start takvim key not < takvim-anah
         invalid 
             continue
          not invalid
             perform until fs-takvim = "10"
                read takvim next no lock
                    end move "10" to fs-takvim
                    not end
                      if takvim-anah >= rez-cik-tar
                          move "10" to fs-takvim
                        else
                          add 1 to gun-s                      end-if 
                end-read


              end-perform  
      end-start.
     .

*
 Tek-Rez-Takas.
 
    perform takas-dosya-ac.
    
    initialize rez-rec.

      move gelen-rez to rez-anah
*      open input rez
      
      read rez  no lock 
        invalid 
*         close rez
         display message box "Rezervasyon Bulunamadi"
         not invalid 
*                         close rez
                      perform tek-rez-yaz               
         end-read.
               .
 
*
 Form1-Cb-1ab-Ex-Cmd-Clicked.
       display Form1-Cb-1aa Form1-Cb-1a
     .
*
 tek-rez-yaz.
             initialize takas-rec
                 move rez-gir-tar  to takas-gel-tar konuk-gel-tar
                         move rez-cik-tar  to takas-git-tar konuk-git-tar
                         move rez-no    to takas-folio konuk-rez-no
                         move rez-acenta to takas-acenta konuk-acenta
                           move rez-firma to takas-firma
                         if ONKPARA-REFERANS-VAR   = 1 
                           move  xkonum-ref(rez-fiyat-konumu)  to takas-referans
                         end-if
                         if rez-folio > 0 
                                 initialize konuk-rec 
                                 move rez-folio   to konuk-folio
                                 read konuk no lock invalid 
                                     continue 
                                 not invalid 
                                     if konuk-duzeltme = 1
                                        move 1 to takas-konuk-duzeltme
                                     end-if                            
                                 end-read 
                         end-if 
                         if rez-eb = "E" then 
                             move rez-eb      to takas-eb-ayrisayfa
                         end-if

                         read takas no lock invalid continue,end-read
                         move rez-odano    to takas-oda konuk-odano
                        
                      
                         move rez-anlasma  to takas-anlasma konuk-anlasma
                         move REZ-AL-TAR(5:4)  to takas-isl
                      
                         if function numval (rez-al-tar(1:6)) < 200100 then
                            move REZ-isl-TAR(5:4)  to takas-isl
                         end-if

                         move rez-fiyat-konumu to konum-anahtar
                         perform anlasma-bul
                         if def-anl-bulundu = 1
                            move aceanlas-anlasma  to takas-def-anlasma
                         end-if
                         read konum no lock invalid 
                            initialize konum-adi
                           
                         end-read

                         move rez-not1 to takas-not 
                         move rez-not2 to takas-not(21:)
                         move konum-adi to takas-konum
                         initialize konum-rec
                         move rez-oda-konumu   to konum-anahtar
                         read konum no lock invalid 
                             move "*****"   to konum-adi
                         end-read 
                            move konum-adi  to takas-okonum

                          if rez-gel-sirket  = spaces then 
                              move rez-adi      to takas-adi konuk-adi
                           else
                              move "*" to    takas-adi(1:) konuk-adi(1:)
                              move rez-adi      to takas-adi(2:) konuk-adi(2:)
                         end-if
                          if rez-git-sirket  = spaces then 
                                move rez-soyadi   to takas-soyadi konuk-soyadi
                           else
                              move "*" to   takas-soyadi(2:) konuk-soyadi(2:)
                              move rez-soyadi   to takas-soyadi(2:) konuk-soyadi(2:)
                         end-if
                      
                         move rez-buyuk    to takas-pax konuk-buyuk
                         move rez-kucuk    to takas-chi konuk-kucuk
                         move rez-free     to takas-fre konuk-free
                         move rez-bebek    to takas-beb konuk-bebek
                         move rez-voucher  to takas-voucher konuk-voucher
**************************************kaya istanbul share start block******************************
                            initialize cast-rec
                            move rez-gir-tar         to cast-tarih
                            move rez-no              to cast-rez-no
                            read cast no lock invalid
                                 continue 
                            not invalid 
                                 if cast-share = 1
                                    move 0           to takas-gercek-oda
                                 else
                                    move 1           to takas-gercek-oda            
                                    compute genel-share = genel-share + 1
                                 end-if
                         
                                 move cast-sharenum   to takas-sharenum   
                            end-read 
**************************************kaya istanbul share end block  ******************************                         
                       if rez-gec = 1 then 
                          move "*"  to takas-gec-giris
                          else
                          move " " to takas-gec-giris
                       end-if
                         perform gece-al thru gece-al-exit
                         compute takas-tl-tutar = konuk-oda-tutar          +
                                 konuk-extbed-tutar + konuk-kahvalti-tutar +
                                 konuk-ogle-tutar   + konuk-aksam-tutar    +
                                 konuk-icecek-tutar + konuk-extra-tutar
                         move rez-doviz        to takas-doviz konuk-doviz 
        
         move konuk-gel-yil      to kur-yil takvim-yil 
         move konuk-gel-ay       to kur-ay  takvim-ay 
         move konuk-gel-gun      to kur-gun takvim-gun 
         move rez-banka          to kur-banka konuk-banka  
         move Rez-Doviz          to kur-doviz konuk-doviz

         if rez-cin-kuru > 0 and rez-cin-kuru < 100 then 
             move rez-cin-kuru to doviz-alis ,
         else
         
                 if rez-kur-aygun = "A" 
                    move 01 to kur-gun 
                 end-if 
                 start takvim key <= takvim-anah 
                  invalid continue
                  not invalid
                   move 0 to doviz-bulundu
                   perform until doviz-bulundu = 1 or fs-takvim= "10"
                    read takvim previous 
                      at end move "10" to fs-takvim
                      not end
                       move takvim-anah to kur-tarih
                       read kur no lock 
                           invalid continue
                       not invalid 
                              move 1 to doviz-bulundu                   
                       end-read
                     end-read
                    end-perform
                 end-start
        
         end-if
           if doviz-alis = 0       
               move 1 to doviz-alis  
           end-if
          move doviz-alis         to takas-dv-degeri
          MOVE doviz-alis         to KONUK-KUR-DEGERI  TAKAS-DV-DEGERI
          compute takas-dv-tutar rounded = takas-tl-tutar / takas-dv-degeri

          move rez-gir-tar to ay-basi  ay-sonu
           move 99 to ay-sonu-gun
           move 01 to ay-basi-gun
           move ay-sonu to takvim-anah
             start takvim key < takvim-anah invalid continue
                not invalid 
                 read takvim previous no lock end continue 
                 end-read 
             end-start
             move takvim-anah to ay-sonu

         if ay-ayir = 1 then 
          perform until ay-basi >= rez-cik-tar
                                              
             move ay-sonu to takas-donem
            perform peryot-fiyat-bul

            move  g-bul-gun-sayisi to takas-gece
            compute takas-dv-tutar rounded = top-rez-fiyati / g-bul-gun-sayisi
            compute takas-tl-tutar rounded = takas-dv-tutar * takas-dv-degeri
            move top-rez-fiyati to  takas-dv-toplam
            compute takas-tl-toplam rounded = takas-dv-toplam * takas-dv-degeri
             write takas-rec invalid 
               rewrite takas-rec,
              end-write 
           
           move ay-sonu to takvim-anah
           move 99 to takvim-gun
           start takvim key > takvim-anah invalid continue
             not invalid read takvim next no lock end continue end-read end-start
             move takvim-anah to ay-basi
             move ay-basi to ay-sonu
           move 99 to ay-sonu-gun
           move ay-sonu to takvim-anah
             start takvim key < takvim-anah invalid continue
             not invalid read takvim previous no lock end continue end-read end-start
             move takvim-anah to ay-sonu



          end-perform
          else
              if eski-tip = 1 
                    continue
                  else
                    initialize hesayr-rec
                    move rez-no to hesayr-rez-no
                    start hesayr key > hesayr-anah
                     invalid
                      write takas-rec invalid 
                       rewrite takas-rec,
                      end-write 
                    not invalid
                         move 9 to son-peryot 
                          perform until fs-hesayr = "10"
                               read hesayr next no lock 
                                  end move "10" to fs-hesayr
                                  not end
                                   if hesayr-rez-no not = rez-no then 
                                         move "10" to fs-hesayr
                                         else
                                            if son-peryot = 9 then
                                               if hesayr-tarih < rez-gir-tar then 
                                                  move hesayr-tarih to takas-gel-tar

                                               end-if
                                               move hesayr-per to son-peryot takas-peryod

                                                    move hesayr-aks1-acik    to takas-ode 
                                                    move hesayr-eb-acik      to takas-eb                  
                                                    move hesayr-ug-acik      to takas-ug                  
                                                    move hesayr-kb-acik      to takas-kick                
                                                    move hesayr-kkp-acik     to takas-kick2               
                                                    move hesayr-so1-acik     to takas-special
                                                   if hesayr-so2-acik not = spaces
                                                       move hesayr-so2-acik     to takas-special
                                                   end-if
                                                    move hesayr-ozl-acik     to takas-ozel
                                                    move hesayr-ham-fiyat    to takas-ham
                                                  



                                                    if rez-gel-sirket  = spaces then 
                                                      move rez-adi      to takas-adi konuk-adi
                                                   else
                                                      move "*" to    takas-adi(1:) konuk-adi(1:)
                                                      move rez-adi      to takas-adi(2:) konuk-adi(2:)
                                                 end-if
                                                  if rez-git-sirket  = spaces then 
                                                        move rez-soyadi   to takas-soyadi konuk-soyadi
                                                   else
                                                      move "*" to   takas-soyadi(2:) konuk-soyadi(2:)
                                                      move rez-soyadi   to takas-soyadi(2:) konuk-soyadi(2:)
                                                 end-if     
                                                   move rez-buyuk    to   takas-pax                 
                                                   move rez-kucuk    to   takas-chi                 
                                                   move rez-free      to   takas-fre                 
                                                   move  rez-bebek    to   takas-beb                 
                                                              
                                                   move rez-voucher to takas-voucher             
                                                   compute   takas-tl-tutar rounded = KONUK-KUR-DEGERI
                                                        *  hesayr-basilacak-tut
                                                   move hesayr-basilacak-tut to  takas-dv-tutar            
                                                   move rez-banka            to   takas-banka               
                                                   move rez-doviz            to   takas-doviz               
                                                   move KONUK-KUR-DEGERI     to   takas-dv-degeri           
                                                   add  takas-tl-tutar to  takas-tl-toplam           
                                                   add  takas-dv-tutar to  takas-dv-toplam           
                                                   move rez-anlasma     to   takas-anlasma
                                                   move 1 to takas-gece

                                                       initialize cast-rec
                                                   move hesayr-rez-no to cast-rez-no
                                                   move hesayr-tarih to cast-tarih
                                                   read cast no lock invalid continue
                                                   end-read
                                           
                                                   evaluate true
                                                       when hesayr-tarih < tarih-tasi
                                                          add CAST-BASILAN-FIYAT to takas-dv-reel
                                                       when hesayr-tarih = tarih-tasi
                                                          add cast-fiyati CAST-BASILAN-FIYAT to  takas-dv-reel 
                                                       when hesayr-tarih > tarih-tasi 
                                                          add cast-fiyati  to  takas-dv-reel 
                                                   end-evaluate
                                            
                                                    compute takas-tl-reel rounded =  takas-dv-reel * konuk-kur-degeri

                                                   if REZ-OZEL-DURUM > 0
                                                      move REZ-OZEL-DURUM to takas-ozel
                                                   end-if 



                                                   else
                                                 if  hesayr-per = son-peryot  or  cl-peryot-ayirma  = 1
                                                         if     cl-peryot-ayirma  = 1
                                                           compute   takas-tl-tutar rounded = KONUK-KUR-DEGERI
                                                                *  hesayr-basilacak-tut
                                                           move hesayr-basilacak-tut to  takas-dv-tutar  
                                                         end-if
                                                     add  takas-tl-tutar to  takas-tl-toplam           
                                                     add  takas-dv-tutar to  takas-dv-toplam 
                                                     add 1 to takas-gece
                                                     initialize cast-rec
                                                   move hesayr-rez-no to cast-rez-no
                                                   move hesayr-tarih to cast-tarih
                                                   read cast no lock invalid continue
                                                   end-read
                                           
                                                   evaluate true
                                                       when hesayr-tarih < tarih-tasi
                                                          add CAST-BASILAN-FIYAT to takas-dv-reel
                                                       when hesayr-tarih = tarih-tasi
                                                          add cast-fiyati CAST-BASILAN-FIYAT to  takas-dv-reel 
                                                       when hesayr-tarih > tarih-tasi 
                                                          add cast-fiyati  to  takas-dv-reel 
                                                   end-evaluate
                                            
                                                    compute takas-tl-reel rounded =  takas-dv-reel * konuk-kur-degeri

                                                   if REZ-OZEL-DURUM > 0
                                                      move REZ-OZEL-DURUM to takas-ozel
                                                   end-if 
                                                      else
                                                    
                                                    write takas-rec invalid stop " " end-write
                                                   move 1 to takas-gece
                                                    initialize takas-tl-toplam takas-dv-toplam takas-dv-reel takas-tl-reel
                                                      move hesayr-per to son-peryot takas-peryod
                                                    move hesayr-aks1-acik    to takas-ode 
                                                    move hesayr-eb-acik      to takas-eb                  
                                                    move hesayr-ug-acik      to takas-ug                  
                                                    move hesayr-kb-acik      to takas-kick                
                                                    move hesayr-kkp-acik     to takas-kick2               
                                                    move hesayr-so1-acik     to takas-special             
                                                    move hesayr-ozl-acik     to takas-ozel 
                                                    move hesayr-ham-fiyat    to takas-ham
                                                    move hesayr-ham-fiyat    to takas-ham

                                                   compute   takas-tl-tutar rounded = KONUK-KUR-DEGERI
                                                        *  hesayr-basilacak-tut
                                                   move hesayr-basilacak-tut to  takas-dv-tutar            
                                                   move rez-banka            to   takas-banka               
                                                   move rez-doviz            to   takas-doviz               
                                                   move KONUK-KUR-DEGERI     to   takas-dv-degeri           
                                                   add  takas-tl-tutar to  takas-tl-toplam           
                                                   add  takas-dv-tutar to  takas-dv-toplam           
                                                   move rez-anlasma     to   takas-anlasma        
                                                    initialize cast-rec
                                                   move hesayr-rez-no to cast-rez-no
                                                   move hesayr-tarih to cast-tarih
                                                   read cast no lock invalid continue
                                                   end-read
                                           
                                                   evaluate true
                                                       when hesayr-tarih < tarih-tasi
                                                          add CAST-BASILAN-FIYAT to takas-dv-reel
                                                       when hesayr-tarih = tarih-tasi
                                                          add cast-fiyati CAST-BASILAN-FIYAT to  takas-dv-reel 
                                                       when hesayr-tarih > tarih-tasi 
                                                          add cast-fiyati  to  takas-dv-reel 
                                                   end-evaluate
                                            
                                                    compute takas-tl-reel rounded =  takas-dv-reel * konuk-kur-degeri

                                                   if REZ-OZEL-DURUM > 0
                                                      move REZ-OZEL-DURUM to takas-ozel
                                                   end-if 


                                                 end-if
                                            end-if

                                    end-if
                               end-read
                          end-perform 

                    end-start
                    write takas-rec  invalid rewrite takas-rec end-write
              end-if

          end-if




 
 


        .
*
*
 peryot-fiyat-bul.
*     open input rez
*     initialize rez-rec
     
*     move konuk-rez-no to rez-no
*     read rez no lock
*       invalid
*         continue
*     end-read
*     close rez
      move rez-odeme-tipi          to kodlar02-kodu
        move "B"                     to kodlar02-tipi
        read kodlar02 no lock invalid
             move "Tanimsiz"  to kodlar02-adi
        end-read
       
      if ode-posting = "H" then        
          initialize top-rez-fiyati    takas-dv-tutar
                      takas-tl-tutar   takas-dv-toplam takas-dv-reel takas-tl-reel
                        takas-tl-toplam
                       
          exit paragraph
      end-if 
     move rez-gir-tar             to g-bul-ilk-tarih
     move rez-cik-tar             to g-bul-son-tarih
     perform G-BUL-ILK-TAR-OKU thru islem-bitti

     perform gun-bul2.
          initialize aksiyhrk-rec aksiyon-durumu special-varsa
     if rez-special-eh = 1
       set special-yok to true
       else


     initialize aksiyhrk-rec special-var-yok
     move "O"              to aksiyhrk-tipi
     move rez-acenta       to aksiyhrk-acenta
     move rez-gir-tar      to aksiyhrk-tarih
     move rez-pan-tipi     to aksiyhrk-pan-tipi
     move g-bul-gun-sayisi to aksiyhrk-gecele

     read aksiyhrk no lock
       invalid
         continue
       not invalid
         set special-var to true
         move aksiyhrk-gecele   to special-gece 
         move aksiyhrk-hes-tipi to special-hes-tipi
            move aksiyhrk-ekle     to special-ekle
         move aksiyhrk-ode      to special-tahsil 
     end-read
      end-if

      initialize aksiyhrk-rec aksiyon-durumu
     if rez-aksiyon-eh = "H" 
       set aksiyon-yok to true
       else

    
     move "A"              to aksiyhrk-tipi
     move rez-acenta       to aksiyhrk-acenta
     move rez-gir-tar      to aksiyhrk-tarih
     move rez-pan-tipi     to aksiyhrk-pan-tipi
     move g-bul-gun-sayisi to aksiyhrk-gecele

     read aksiyhrk no lock
       invalid
         continue
       not invalid
         set aksiyon-var to true
     end-read
     move aksiyhrk-ode  to zz 
     move zz to takas-ode
     end-if
     move rez-fiyati    to ilk-rez-fiyati son-rez-fiyati

     initialize g-bul-gun-sayisi kacinci-gece
                     takvim-rec
                top-rez-fiyati
                fiyatana-rec
     move rez-gir-tar   to takvim-anah
     start takvim key >= takvim-anah
       invalid
         move 1 to g-bul-gun-sayisi
       not invalid
         initialize fs-takvim
         perform with test after
                 until fs-takvim = "10"
           read takvim next no lock
             end
               move "10" to fs-takvim
             not at end
               if takvim-anah = rez-cik-tar
                  move "10" to fs-takvim
                  exit perform cycle
               end-if
*               if rez-no = 114851  then stop " " end-if
               if takvim-anah < rez-cik-tar  and (  ay-ayir = 0  or 
                    ( ay-sonu >= takvim-anah and ay-basi <= takvim-anah ) )
                  
*                  if rez-no = 116567 then stop  " " end-if   
                  perform fiyat-bul thru fiyat-bul-exit

                  if takvim-anah = rez-gir-tar 
                      and fiyatana-fiks = 1 then
                           move "E" to rez-fiyat-fix 
                  end-if
                  if son-rez-fiyati not  = ilk-rez-fiyati and g-bul-gun-sayisi > 0
                       move  g-bul-gun-sayisi to takas-gece
                       compute takas-dv-tutar rounded = top-rez-fiyati / g-bul-gun-sayisi
                       compute takas-tl-tutar rounded = takas-dv-tutar * takas-dv-degeri
                       move top-rez-fiyati to  takas-dv-toplam
                       compute takas-tl-toplam rounded = takas-dv-toplam * takas-dv-degeri
                       
                     write takas-rec invalid 
                            rewrite takas-rec,
                     end-write

                       add 1 to takas-peryod             
                        initialize g-bul-gun-sayisi top-rez-fiyati
                  end-if
                  move ilk-rez-fiyati to son-rez-fiyati
                  add 1 to g-bul-gun-sayisi  kacinci-gece
                  
                  if kacinci-gece > aksiyhrk-ode and aksiyon-var and aksiyhrk-sondan = 1 then
                  if special-var
                     if special-ekle = 1 then move -1 to special-eksi-car
                     else move 1 to special-eksi-car
                     end-if
                     evaluate special-hes-tipi
                       when 1
                           compute top-rez-fiyati rounded = top-rez-fiyati - 
                                 (((special-tahsil) * (rez-buyuk + ( rez-kucuk / 2 ) ) / special-gece)
                                 * special-eksi-car )
                       when 2
                           compute top-rez-fiyati rounded = top-rez-fiyati - 
                                 (((special-tahsil) * (rez-buyuk + ( rez-kucuk ) ) / special-gece)
                                  * special-eksi-car )
                       when 3
                           compute top-rez-fiyati rounded = top-rez-fiyati - 
                                 (((special-tahsil) / special-gece)
                                  * special-eksi-car )
                       when 4
                           compute top-rez-fiyati rounded = top-rez-fiyati - 
                                 (((special-tahsil) * rez-buyuk)
                                  * special-eksi-car )
                       when 5
                           compute top-rez-fiyati rounded = top-rez-fiyati - 
                                 (((special-tahsil) * (rez-buyuk + ( rez-kucuk / 2 ) ) )
                                  * special-eksi-car )
                       when 6
                           compute top-rez-fiyati rounded = top-rez-fiyati - 
                                 (((special-tahsil) * (rez-buyuk + ( rez-kucuk ) ) )
                                  * special-eksi-car )
                       when 7
                           compute top-rez-fiyati rounded = top-rez-fiyati - 
                                 (((special-tahsil))
                                  * special-eksi-car )
        
                       when other
                           compute top-rez-fiyati rounded = top-rez-fiyati - 
                                 (((special-tahsil) * rez-buyuk / special-gece)
                                  * special-eksi-car )
                      end-evaluate 



                     
      
                   end-if
                  else
                      compute top-rez-fiyati
                        = top-rez-fiyati + ilk-rez-fiyati
                  end-if
               else
                 if  takvim-anah > rez-cik-tar  
                  move "10" to fs-takvim
                  end-if
               end-if                
           end-read
         end-perform
     end-start
     
     
     if top-rez-fiyati <> zeroes
        continue
     else
        if  takas-peryod = 0 or (takas-peryod =  1 and eski-tip = 0 )  then 
        compute top-rez-fiyati rounded 
              = g-bul-gun-sayisi * rez-fiyati
         end-if
     end-if
     .

*
 Fatura-Baslik-At.
       move 1 to fatura-acik
      move fatt-gun to f-gun
      move fatt-ay  to f-ay
      move fatt-yil to f-yil
      initialize dokumer-rec formatlar text-oku-rec
       open input text-oku,
       perform with test after until fs-text-oku = "10"  
       initialize text-oku-2
       read text-oku next no lock end move "10" to fs-text-oku
          not end
          if text-oku-1 = "2" 
             exit perform
          end-if
          initialize dokumer-rec
          if text-oku-1  = "0"
             initialize text-oku-2
          end-if
          if text-oku-1  = "A"

             open input acenta
             move takas-acenta to acenta-kodu
             read acenta no lock invalid
                  initialize acenta-rec
             end-read
             close acenta,

             move muha-sirketi    to cari-dosya-adres
             if munferit = 1 then 
               perform munferit-fat-adres-al
             else
             open input cari
             
             move acenta-muhno to cari-kodu
             if  acenta-muhno2  not = spaces 
             move acenta-muhno2 to cari-kodu
             end-if
             read cari no lock invalid
                  initialize cari-rec
             end-read,
             close cari,
             end-if
          end-if

          if text-oku-1 = "1"
             inspect text-oku-2 replacing all "[ACENADI_______________________________]"  by c-unvan-1(1:40)
             inspect text-oku-2 replacing all "[ACENUNV_______________________________]"  by c-unvan-2(1:40)
             inspect text-oku-2 replacing all "[ACENADR1______________________________]"  by c-adres-1(1:40)
             inspect text-oku-2 replacing all "[ACENADR2______________________________]"  by c-adres-2(1:40)
             inspect text-oku-2 replacing all "[ACEN-IL-ILCE______]"                      by c-il-ilce(1:20)
             inspect text-oku-2 replacing all "[ACENULKE____]"                            by c-ulke(1:14)
             inspect text-oku-2 replacing all "[ACENVDA___________]"                      by c-vergi-daire
             inspect text-oku-2 replacing all "[ACENVNO__________]"                       by c-vergi-no(1:19)
             inspect text-oku-2 replacing all "[FATTAR__]"                                by f-tarihi
          end-if

         
          if text-oku-1 = "8"  
            if ilk-sayfa = "E"
                 move "P" to det-dokumer-20(5:1)
                 write dokumer-rec from detay
                 move " " to det-dokumer-20(5:1)
                 write dokumer-rec from detay
                 write dokumer-rec from detay
                  else
                 move "E" to ilk-sayfa
            end-if
          end-if,
          move text-oku-2   to det-filler
          write dokumer-rec from detay
       end-read
       end-perform.
       

*****************************************
 munferit-fat-adres-al.
     initialize ozluk2-rec
     move takas-folio to rez-no
     read rez no lock invalid 
             move 0 to ozluk2-folio
         not invalid
             move rez-folio to ozluk2-folio 
     end-read
     open input ozluk2
     read ozluk2 no lock invalid continue end-read
     close ozluk2
     move OZLUK2-FAT-UNVAN-1 to  c-UNVAN-1  
     move OZLUK2-FAT-UNVAN-2 to  c-UNVAN-2  
     move OZLUK2-FAT-ADRES-1 to  c-ADRES-1  
     move OZLUK2-FAT-ADRES-2 to  c-ADRES-2  
     move OZLUK2-FAT-IL-ILCE to  c-IL-ILCE  
     move OZLUK2-FAT-ULKE    to   c-ULKE     
     move OZLUK2-FAT-VERGI-DAIRE to c-VERGI-DAIRE 
     move OZLUK2-FAT-VERGI-NO    to c-VERGI-NO    
     if ozluk2-fat-unvan-1 = spaces then 
         move takas-adi to c-unvan-1 
         move takas-soyadi to c-unvan-1 (21:)

     end-if.
*
 fatura-detaylar.
           if takas-tl-tutar not = zeroes
               if fatura-acik not = 1 then 
                  perform fatura-baslik-at
               end-if
            
**                 initialize takas-tl-toplam takas-dv-toplam
                
**          compute takas-dv-toplam rounded = takas-dv-tutar * takas-gece
**         compute takas-tl-toplam rounded = takas-tl-tutar * takas-gece
                compute tdv-tut = tdv-tut + takas-dv-toplam 
                compute ttl-tut = ttl-tut + takas-tl-toplam
                if acenta-fatalti-ind > 0 then
                    
                    compute takas-dv-tutar rounded = 
                          (takas-dv-tutar / (100 - acenta-fatalti-ind )) * 100
                    compute  takas-dv-toplam rounded = takas-dv-tutar *  takas-gece
                    compute takas-tl-toplam rounded =  takas-dv-tutar * 
                                             takas-dv-degeri * takas-gece
                    compute tdv-tut-mat = tdv-tut-MAT + takas-dv-toplam
                    compute ttl-tut-mat = ttl-tut-MAT + takas-tl-toplam
                end-if
                



                inspect text-oku-2 replacing all "QQ"         by takas-gece(2:2)

                inspect text-oku-2 replacing all "[VOUCHER_]" by takas-voucher(1:10) 
                inspect text-oku-2 replacing all "[VOUCHER__]" by takas-voucher(1:11) 
                inspect text-oku-2 replacing all "[VOUCHER___]" by takas-voucher(1:12) 
                inspect text-oku-2 replacing all "[VOUCHER____]" by takas-voucher(1:13) 
                inspect text-oku-2 replacing all "[VOUCHER_____]" by takas-voucher(1:14)  
                inspect text-oku-2 replacing all "[VOUCHER______]" by takas-voucher(1:15)

                move takas-gel-yil  to cin-yil
                move takas-gel-ay   to cin-ay
                move takas-gel-gun  to cin-gun
                if takas-gel-yil = zeroes
                   inspect text-oku-2 replacing all "[GIRTAR__]" by spaces
                    else  
                  inspect text-oku-2 replacing all "[GIRTAR__]" by d03-detay
                end-if
                inspect text-oku-2 replacing all "[MUSADI__]" by takas-adi(1:10)
                move takas-git-yil  to cout-yil
                move takas-git-ay   to cout-ay
                move takas-git-gun  to cout-gun
                if takas-git-yil = zeroes
                   inspect text-oku-2 replacing all "[CIKTAR__]"  by spaces
                   else
                   inspect text-oku-2 replacing all "[CIKTAR__]"  by d04-detay
                end-if   
                    if takas-eb-ayrisayfa = "E" then
                     move " E/B"        to takas-soyadi(7:4)
                 end-if
             
                inspect text-oku-2 replacing all "[MUSSOY__]"  by takas-soyadi(1:10)
                inspect text-oku-2 replacing all "[OD]"        by takas-oda
                if  takas-pax = zeroes and takas-chi = zeroes  
                  inspect text-oku-2 replacing all "[B]"         by  spaces
                  inspect text-oku-2 replacing all "[K]"         by  spaces
                  inspect text-oku-2 replacing all "[ADET]"      by  spaces
                
                  inspect text-oku-2 replacing all "[BK]"        by  spaces
                
                  inspect text-oku-2 replacing all "[CK]"        by  spaces
                
                  else
                  move takas-pax       to 3-z
                  inspect text-oku-2 replacing all "[B]"         by  3-z
                  move takas-chi       to 3-z
                  inspect text-oku-2 replacing all "[K]"         by  3-z
                  inspect text-oku-2 replacing all "[ADET]"      by  spaces
                
                  inspect text-oku-2 replacing all "[BK]"        by  space
                
                  inspect text-oku-2 replacing all "[CK]"        by  space
                end-if 
****                move det-ara-pan-kod(i)    to 2-x,
****                inspect text-oku-2 replacing all "PP"          by  2-x

                
                move takas-doviz    to doviz-kodu
                read doviz no lock invalid
                     initialize d-kisa-adi
                end-read
                
                move d-kisa-adi       to 5-x,
                inspect text-oku-2 replacing all "[DOV]"       by  5-x
*->
                move takas-dv-degeri        to 10-z
                inspect text-oku-2 replacing all "[KURU____]"        by  10-z

                initialize dv-tut tl-tut  
                move takas-tl-tutar to tl-tut
                
                move takas-dv-toplam        to 11-z
                inspect text-oku-2 replacing all "[DVTUTAR__]"    by  11-z
                move takas-tl-toplam      to 13-z
                inspect text-oku-2 replacing all "[TLTUTAR____]"  by  13-z
                move takas-dv-tutar       to 8-z
                inspect text-oku-2 replacing all "[GUNFIY]"       by  8-z

             
               
                    
            
            move text-oku-2   to det-filler
            write dokumer-rec from detay
            initialize text-oku-2
            read text-oku next no lock 
                end move "10" to fs-text-oku
            end-read
           if  text-oku-1 not = "2" or fs-text-oku = "10" then
               perform fatura-kapat
           end-if
           else 
            continue

         end-if.










*
 fatura-kapat.
        if fatura-acik not = 1 then exit paragraph end-if
         if ay-ayir = 1 then 
               move kont-yil        to ay-notu(1:4)
                move "-"       to ay-notu(5:1)
               move ay-adi(kont-ay) to ay-notu(6:10) 
               move "ayi icerisindeki gecelemeleri kapsamaktadir." to ay-notu(20:) 

             end-if
        initialize voucher-say
        perform with test before until 
               fs-text-oku = "10" 
     
          evaluate text-oku-1 
          when "2" 
               initialize text-oku-2
          when "5"
          when "3"
             if ay-ayir = 1 then 
             inspect text-oku-2 replacing all
                "[NOT..........................................................................................]"
              by ay-notu(1:95)
              else
              inspect text-oku-2 replacing all
                "[NOT..........................................................................................]"
              by spaces
             end-if

             move d-kisa-adi       to 5-x,
             inspect text-oku-2 replacing all "[DOV]"       by  5-x

             move tdv-tut         to 11-z
             inspect text-oku-2 replacing all "[GDVTUTAR_]"       by  11-z

             move ttl-tut         to 13-z
             inspect text-oku-2 replacing all "[TTLTUTAR___]"     by  13-z
             initialize tlnet tlkdv tlbrt
             move ttl-tut      to  tlbrt

             compute tlnet = ( tlbrt * 100 ) / ( cinpara-mus-kdv + 100 )
             compute tlkdv = tlbrt - tlnet

             move tlnet         to 13-z
             inspect text-oku-2 replacing all "[TTLKDVNET__]"     by  13-z

             move tlkdv         to 13-z
             inspect text-oku-2 replacing all "[TTLKDVSI___]"     by  13-z

             move tlbrt         to 13-z
             inspect text-oku-2 replacing all "[TTLBRUT____]"     by  13-z

             inspect text-oku-2 replacing all "[T18KDVNET__]"     by  spaces
             inspect text-oku-2 replacing all "[T18KDVSI___]"     by  spaces


               if text-oku-1 =  "5"
                
                if acenta-fatalti-ind > 0 then
                   compute ttl-tut-mat-net  rounded 
                   = ( ttl-tut-mat * 100 ) /  ( cinpara-mus-kdv + 100 ) 
                   compute ind-mat = tlnet - ttl-tut-mat-net
                   move ttl-tut-mat-net         to 13-z
                  inspect text-oku-2 replacing all "[TTLINDSIZ__]"     by  13-z
                    move ind-mat         to 13-z
                  inspect text-oku-2 replacing all "[IND-TUTAR__]"     by  13-z
                
                  move acenta-fatalti-ind         to ind-z
                  inspect text-oku-2 replacing all "[IND]"     by  ind-z

              
                 else
                 initialize text-oku-2
                end-if
             end-if
          
          

          when "4"
             initialize rakam yaziile
             move tlbrt to rakam
             call "/asya/ytl/obj/otel/yaziile.asy" using rakam yaziile
                  on exception perform callerr-proc
                  not on exception
                  cancel "/asya/ytl/obj/otel/yaziile.asy" 
             end-call

             inspect text-oku-2 replacing all
             "[YAZI.........................................................................................]"
                                                      by yaziile(1:95)
          
          when "9"
             move text-oku-2 to yaziile(10:85)
          when other 
              continue
        end-evaluate
           move text-oku-2   to det-filler
            write dokumer-rec from detay
            initialize text-oku-2
            read text-oku next no lock 
                end move "10" to fs-text-oku
            end-read
          end-perform .

          close text-oku .
          initialize toplam fatura-acik.



**
 acuserve-adres-aktar.
    move muha-sirketi of genel-rec to CARI-DOSYA-adres         
                         ISLENEN-DOSYA-adres      
                         HESAP-DOSYA-adres        
                         MAHSUP-DOSYA-adres       
                          
                         REFERANS-DOSYA-adres     
                         Mgenel-DOSYA-adres       
                        
                       
                

    move all low-values to      
                           CARI-ACUSERVE-DOSYA       
                           ISLENEN-ACUSERVE-DOSYA    
                           HESAP-ACUSERVE-DOSYA      
                           MAHSUP-ACUSERVE-DOSYA     
                           genelfis-ACUSERVE-DOSYA   
                           REFERANS-ACUSERVE-DOSYA   
                           Mgenel-ACUSERVE-DOSYA     
                           genelfis-ACUSERVE-DOSYA  
                           ip-no.


    inspect genel-muha-uzak-ip 
            replacing trailing spaces by low-values.

    if genel-muha-uzak-ip <> low-values
       move all low-values to ip-no
       string ip-no,
              "@" delimited by low-values
              genel-muha-uzak-ip delimited by low-values
              ":" delimited by low-values
              into ip-no
    end-if

    string mgenel-acuserve-dosya,
           ip-no                        delimited by low-values
           mgenel-dosya                    delimited by low-values
           into mgenel-acuserve-dosya.
    string genelfis-acuserve-dosya,
           ip-no                        delimited by low-values
           genelfis-dosya                 delimited by low-values
           into genelfis-acuserve-dosya.

    
    string hesap-acuserve-dosya,
           ip-no                        delimited by low-values
           hesap-dosya                 delimited by low-values
           into hesap-acuserve-dosya.
    string mahsup-acuserve-dosya,
           ip-no                        delimited by low-values
           mahsup-dosya                 delimited by low-values
           into mahsup-acuserve-dosya.
    string cari-acuserve-dosya,
           ip-no                        delimited by low-values
           cari-dosya                 delimited by low-values
           into cari-acuserve-dosya.
    string islenen-acuserve-dosya,
           ip-no                        delimited by low-values
           islenen-dosya               delimited by low-values
           into islenen-acuserve-dosya.
    string referans-acuserve-dosya,
           ip-no                        delimited by low-values
           referans-dosya                delimited by low-values
           into referans-acuserve-dosya.
    

    inspect CARI-ACUSERVE-DOSYA        replacing  all spaces by low-values
    inspect ISLENEN-ACUSERVE-DOSYA     replacing  all spaces by low-values
    inspect HESAP-ACUSERVE-DOSYA       replacing  all spaces by low-values
    inspect MAHSUP-ACUSERVE-DOSYA      replacing  all spaces by low-values
    inspect genelfis-ACUSERVE-DOSYA    replacing  all spaces by low-values
    inspect REFERANS-ACUSERVE-DOSYA    replacing  all spaces by low-values
    inspect mgenel-ACUSERVE-DOSYA      replacing  all spaces by low-values
    inspect genelfis-ACUSERVE-DOSYA    replacing  all spaces by low-values.
*
 yan-detay-ata.
     initialize yanrez-rec
     move takas-folio          to yanrez-rezno
     start yanrez key not < yanrez-anah invalid
           continue
     not invalid
     perform with test after until fs-yanrez = "10"
     read yanrez next no lock end move "10"  to fs-yanrez
     not at end
            initialize dokumer-rec detay
            if yanrez-rezno <> takas-folio
               exit perform
            end-if

            if yanrez-sirano > 1 then 
                move yanrez-adi       to det-3
                move yanrez-soyadi    to det-4
                write dokumer-rec from detay
                initialize dokumer-rec detay
                   move "-"            to det-dokumer-20(5:1)
                   move all "-" to det-1 det-1-1 det-2 det-3 det-4 det-5 det-6
                 det-7 det-77 det-8 det-9 det-10 det-11 det-ham  det-12 
                 det-13 det-14 det-15 det-16 det-17  det-49 det-59 det-50
                 det-100 det-101 det-102 det-103
                 det-104 det-105 det-106 det-202  det-okonum
                write dokumer-rec from detay
           end-if


     end-read
     end-perform
     end-start
     .
*
*
 ace-takvim.
        initialize     ace-sart-gece  ace-hs-var  ace-top-gece
        move rez-gir-tar to takvim-anah 
        start takvim key >= takvim-anah invalid continue
           not invalid 
           perform until fs-takvim  = "10" 
                 read takvim next no lock end move "10" to fs-takvim
                     not end 
                       if takvim-anah >=  rez-cik-tar
                         move "10" to fs-takvim
                         else
                            add 1 to ace-top-gece 
                            if takvim-gun-adi = 5 or 6 then 
                               move 1 to ace-hs-var 
                            end-if
                            if takvim-anah >= aceanlas-sart-bas and 
                               takvim-anah <= aceanlas-sart-bit
                               add 1 to ace-sart-gece
                            end-if
                       end-if
                 end-read
           end-perform
            if aceanlas-sart-haric = 1 then 
               compute ace-top-gece =  ace-top-gece  -  ace-sart-gece

           end-if

    .

*
 anlasma-bul.
    
     open input aceanlas
     initialize aceanlas-rec
     move rez-acenta        to aceanlas-acenta
     move high-values       to aceanlas-anlasma-tar
     start aceanlas key not > aceanlas-bul invalid
           continue
     not invalid
     perform with test after until fs-aceanlas = "10"
     read aceanlas previous no lock end move "10" to fs-aceanlas
     not at end

         if genel2-aceanlas-referansli = 1    |||X firat ekleme 12/2/2021
            if onkpara-referans-var = 1 
               evaluate onkpara-referans-nerden
                   when 1 
                        open input konum 
                        initialize konum-rec 
                        move rez-fiyat-konumu to konum-anahtar 
                        read konum no lock invalid
                             continue
                        end-read 
                        close konum
                        if aceanlas-referans not = spaces and aceanlas-referans not = 0
                           if konum-ref not = aceanlas-referans
                              exit perform cycle
                           end-if
                        end-if 
                   when 2
                        open input odalar 
                        initialize odalar-rec 
                        move rez-odano to odalar-rec 
                        read odalar no lock invalid
                             continue
                        end-read 
                        close odalar 
                        if aceanlas-referans not = spaces and aceanlas-referans not = 0
                           if odalar-referans not = aceanlas-referans
                              exit perform cycle
                           end-if
                        end-if
               end-evaluate 
            end-if
         end-if   |||X

           if rez-acenta not =  aceanlas-acenta then
               move "10" to fs-aceanlas 
           else
            if aceanlas-sart-var = 1 or aceanlas-hs = 1 or 
               aceanlas-min-max-var = 1 then 
                    perform ace-takvim
             end-if


            if rez-al-tar <= aceanlas-kabul-bit and 
                rez-al-tar >= aceanlas-kabul-bas and
                rez-gir-tar >= aceanlas-donem-bas and
                rez-gir-tar <= aceanlas-donem-bit and 
                (aceanlas-min-max-var not = 1 or 
                  (ace-top-gece >= aceanlas-min-gece and 
                    ace-top-gece <= aceanlas-max-gece )) and 
                ( aceanlas-hs not = 1  or ace-hs-var = 1  ) and 
                 (aceanlas-sart-var not = 1 or 
                  (ace-sart-gece >= aceanlas-sart-min-gece and 
                    ace-SART-gece <= aceanlas-sart-max-gece )) 

       

                
                then 
                move 1 to def-anl-bulundu
                move "10" to fs-aceanlas 
             end-if
           end-if
     end-read
     end-perform
     end-start
     close aceanlas.


 
