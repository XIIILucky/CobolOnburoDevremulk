*
 Bef-Create-Form1.
        perform adresleri-tasi
        open input genel
        initialize genel-rec 
        move 1   to genel-anahtar
        read genel no lock invalid 
             display message box "Genel Parametre Tanimsiz.."
                             title "Uyari"
                             icon 1
              close genel
              exit paragraph 
        end-read 
        close genel
        move genel-printer-filtre to text-oku-filtre
        perform acuserve-adres-aktar
        move muha-sirketi         to alsat-dosya-adres   
        move tarih-tasi           to rap-fat-tar.
*
 Form1-Aft-Initdata.
        call "c$narg" using link-var.
        compute rap-fat-no = genel-fol-fat-no  + 1        
        display acc-fat-no
        perform takcari-ilk
        perform takas-dosya-ac.

        perform konuk-bul
           
        if link-var = 3               
              initialize toplam-kdv-tutari matrah-tutari alt-toplam genel-toplam
              move 1  to kayit-sayi kdv-toplam-sayi

*              if link-pencere = kac-adet
*                 compute event-data-2 = link-pencere + 1                
*              else
*                 move link-pencere to event-data-2
*                 if link-pencere = 1
*                    move 2   to event-data-2
*                 end-if 
*              end-if 
              perform varying ii 
                      from 1 
                      by 1 
                      until ii > 10
                         if penler(ii) = link-pencere 
                            move penler(ii) to event-data-2
                            exit perform 
                         end-if 
                         
              end-perform
              inquire gd-sec(event-data-2,1),
                      hidden-data gd-sec-rec

              inquire gd-sec(event-data-2,2)
                      hidden-data in gd-sec-secildi

              if gd-sec-bakiye > 0
                 display message box "Bakiyeli Folio'ya Fatura Kesilemez..." new-line
                                     "Bakiye : "gd-sec-bakiye
                                 title "Uyari"
                                 icon 1
                     exit paragraph 
              end-if
 
                 perform grid-kayit-secildi

        end-if. 
        
         
*
 takas-dosya-ac.
     open i-o genelfis
     initialize genelfis-rec 
     move 1        to genelfis-anahtar
     read genelfis no lock invalid 
          continue 
     not invalid
           add 1 to ekran-fis-1
           move ekran-fis-1   to takas-no deptop-no kdv-no 
           rewrite genelfis-rec end-rewrite 
     end-read 
     close genelfis

     open output takas deptop kdv close kdv takas deptop .
        
*
 Ex-Oth-Form1.
        evaluate key-status
        when 1
           evaluate control-id
           when 1021
           when 1022
                     initialize oda-cagir
                     if rap-inhouse
                        move "D" to oda-db-cagir
                     end-if
                     call "/asya/ytl/obj/otel/odaara.asy"
                       using oda-cagir
                       on exception 
                         initialize odano-cagir
                       not on exception 
                         cancel "/asya/ytl/obj/otel/odaara.asy"
                     end-call
                     move odano-cagir to rap-oda-no
                     display acc-oda-no
           when 1071
           when 1072
                    
                     initialize acenta-cagir
                     call "/asya/ytl/obj/otel/acenara.asy"
                       using acenta-cagir
                       on exception 
                         initialize acenta-cagir
                       not on exception 
                         cancel "/asya/ytl/obj/otel/acenara.asy"
                     end-call               
                     move acenta-cagir to rap-acenta
                     display acc-acenta
                     perform acenta-oku
           when 90
           when 91
                      initialize firma-cagir
                      call "/asya/ytl/obj/otel/firmara.asy" using firma-cagir
                            on exception perform callerr-proc
                               not on exception
                               cancel "/asya/ytl/obj/otel/firmara.asy" 
                       end-call
                       move firma-cagir     to rap-firma
                       display acc-firma
                       perform firma-oku
           when 8
           when 9
                    initialize gruplar-cagir
                    call "/asya/ytl/obj/otel/gruplara.asy" using gruplar-cagir  
                         on exception perform callerr-proc
                         not on exception
                    cancel "/asya/ytl/obj/otel/gruplara.asy" 
                    end-call
                    if gruplar-cagir > 0 then 
                       move gruplar-cagir   to rap-grup
                       display acc-grup                    
                    end-if                    
                    perform grup-oku
           end-evaluate
        when 2
           if rap-vno = spaces and rap-tcno = spaces and rap-pasno = spaces
              display message box "Zorunlu Alanlarda Eksik Bilgi " new-line new-line
                                  "Vergi No / TC Kimlik No veya Pasaport No Alanlarindan bir tanesinin dogru girilmis olmasi gereklidir."
                                  "Fatura Kesilemez.."
                              title "Uyari"
                              icon 1
                    exit paragraph 
           end-if
           
           if rap-vno not = spaces               
              move function numval(rap-vno)   to s-vno
              if s-vno not = rap-vno
                 display message box "Hatali Vergi Numarasi Girisi Yapildi.." new-line
                                     "Lutfen Kontrol Ediniz."
                                 title "Uyari"
                                 icon 1
                    exit paragraph 
              end-if 
              if s-vno < 1000
                 display message box "Hatali Vergi Numarasi Girisi Yapildi.." new-line
                                     "Lutfen Kontrol Ediniz."
                                 title "Uyari"
                                 icon 1
                    exit paragraph                 
              end-if 
           end-if
 
           if rap-tcno not = spaces
              move function numval(rap-tcno)   to stc
              if stc not = rap-tcno
                 display message box "Hatali TC Kimlik Numarasi Girisi Yapildi.." new-line
                                     "Lutfen Kontrol Ediniz."
                                 title "Uyari"
                                 icon 1
                    exit paragraph 
              end-if 
              if stc < 1000
                 display message box "Hatali TC Kimlik Numarasi Girisi Yapildi.." new-line
                                     "Lutfen Kontrol Ediniz."
                                 title "Uyari"
                                 icon 1
                    exit paragraph                 
              end-if                
           end-if

           if rap-vno not = spaces and 
              rap-tcno not = spaces 
                 display message box "Zorunlu alanlardan sadece bir tanesi dolu olmali"
                                 title "Uyari"
                                 icon 1
                   exit paragraph 
           end-if
           
           perform cari-ata

           if rap-vno not = spaces
              perform vergi-no-kontrol
              if efat-degil = 1
                  display message box "!!!!          E-FATURA Kesilecektir          !!!!" new-line new-line new-line
                                      "              Eminmisiniz?                       " new-line new-line new-line
                                      "Not:E-FATURA Sisteminde Cikti Verilmeyecektir."
                                  title "Dikkat"
                                  icon 2
                                  type 2 
                                  default 2
                                  returning return-code 
                 if return-code = 2
                    exit paragraph 
                 end-if 
              end-if 
           end-if
 
           if rap-tcno not = spaces
              perform vergi-no-kontrol
              if efat-degil = 1
                  display message box "!!!!          E-FATURA Kesilecektir          !!!!" new-line new-line new-line
                                      "              Eminmisiniz?                       " new-line new-line new-line
                                      "Not:E-FATURA Sisteminde Cikti Verilmeyecektir."
                                  title "Dikkat"
                                  icon 2
                                  type 2 
                                  default 2
                                  returning return-code 
                 if return-code = 2
                    exit paragraph 
                 end-if 
              end-if 
           end-if

           perform fatura-no-kontrol
           
           if hata = 1
              exit paragraph
           end-if
           
           perform fatura-bakiye-kontrol
           if hata = 1
              display message box "Sifir [0] veya eksi  Tutarli Fatura Kesilemez.."
                              title "Uyari"
                              icon 1
              exit paragraph 
           end-if 
           if efat-degil not = 1
              evaluate fat-turu-value(1:1)
              when "F"
                      display message box rap-fat-no " 'Nolu Fatura Kesilecektir." new-line
                                                     "Eminmisiniz?"
                                      title "Uyari"
                                      icon 1
                                      type 2
                                      default 2
                                      returning return-code 
                      if return-code = 2
                         exit paragraph
                      end-if 
              when "T"
                      display message box "                      !!! DIKKAT !!!" new-line new-line
                                          "        !!! TEST !!!  !!! TEST !!!  !!! TEST !!!" new-line new-line
                                          rap-fat-no " 'Nolu Fatura !!! TEST !!! Olarak Kesilecektir." new-line                                                  
                                                     "Eminmisiniz?"
                                      title "Dikkat"
                                      icon 3
                                      type 2
                                      default 2
                                      returning return-code 
                      if return-code = 2
                         exit paragraph
                      end-if 
              end-evaluate
           end-if 
           initialize det-ara-rec
           perform max-satir-bul
           perform dep-bul
           perform kdv-bul

           open input takas musteri konuk 
           open i-o fatdokum
           initialize fatdokum-rec
           accept fatdokum-tarih from century-date
           accept fatdokum-zaman from time
           move rap-fat-no       to fatdokum-fat-no
           initialize takas-rec fat-sat i top-TL-TUTAR
           start takas key not < takas-anah invalid 
                 continue 
           not invalid 
           perform with test after until fs-takas = "10"
           read takas next no lock end move "10" to fs-takas
           not at end
*                   if takas-folio <> link-fol-no |alakasiz folio geliyor
*                      exit perform cycle  |alakasiz folio geliyor
*                   end-if |alakasiz folio geliyor
                   add 1             to i
                   move takas-adi    to det-ara-adi(i)
                   move takas-soy    to det-ara-soy(i)
                   move takas-oda    to det-ara-oda(i)                
                   move takas-tutar  to det-ara-tl-tut(i)
                    
                   compute top-TL-TUTAR = top-TL-TUTAR + takas-tutar 

                   initialize konuk-rec 
                   move takas-folio  to konuk-folio
                   read konuk no lock invalid 
                        continue  
                   not invalid 
                        move konuk-gel-tar    to det-ara-girtar(i)
                        move konuk-git-tar    to det-ara-ciktar(i)
                        move konuk-buyuk      to det-ara-buyuk(i)
                        move konuk-kucuk      to det-ara-kucuk(i)
                        move konuk-pan-tipi   to det-ara-pan-kod(i)
                        if konuk-onay-kodu not = spaces
                           move konuk-onay-kodu  to det-ara-onay-kodu(i)
                        end-if 
                   end-read 

                   if i >= max-satir                       
                      perform fat-bas
                      initialize i
                   end-if 

           end-read 
           end-perform
           end-start
           close takas musteri konuk 
           if i < max-satir              
              perform fat-bas                                
           end-if
           close fatdokum
           evaluate fat-turu-value(1:1)
           when "F"
                perform fatura-data-yaz
           end-evaluate
           if efat-degil = 1
              display message box "E-FATURA Kesildi."
                              title "Uyari"
                              icon 1
              set exit-pushed to true 
           end-if 
        when 5
           perform fatura-hazirla
        when 5005
           move 1   to sahis-fat
           perform fatura-bilgisi-al
           move 0   to sahis-fat
        when 5006
           move 1   to kurum-fat
           perform fatura-bilgisi-al
           move 0   to kurum-fat

        end-evaluate.
*
 konuk-bul.
     perform acenta-oku
     perform firma-oku
     perform grup-oku
     modify gd-sec, reset-grid = 1
                    mass-update = 1
     initialize gd-sec-rec
     move "Sec"                to gd-sec-buton
     move "Oda"                to gd-sec-odano
     move "T"                  to gd-sec-tipi
     move "Folio"              to gd-sec-folio
     move "Adi"                to gd-sec-adi
     move "Soyadi"             to gd-sec-soyadi
     move "Gir.Tarihi"         to gd-sec-gir-tar
     move "Cik.Tarihi"         to gd-sec-git-tar
     move "Folio Bakiyesi"     to gd-sec-bakiye
     move "P"                  to gd-sec-pen
     move "Profil"             to gd-sec-profil
     move "Fatura Tutari"      to gd-sec-tutar
     modify gd-sec,
            record-to-add(gd-sec-rec)
     move 1                    to i
        
     open input konuk folref musteri depkod
     if link-var = 3 |gelen folionun inhouse mu history mi olduðunu buluyor baska bir ise yaramýyor...
        initialize konuk-rec yedek-konuk-firma
        move link-fol-no    to konuk-folio
        read konuk no lock invalid 
             display message box "Register Karti Bulunamadi..."
                             title "Uyari"
                             icon 1
              set exit-pushed to true 
        not invalid 
            move konuk-durumu  to rap-durum(1:1)
            move konuk-firma   to yedek-konuk-firma
            if rap-durum(1:1) = "H"
               move konuk-git-tar to rap-cout-tarihi
               move 1             to vis-1
               display cb-durum acc-cout-gun acc-cout-ay 
                       acc-cout-yil lb-durumb cb-gir-cik
            else
              display cb-durum
            end-if 
        end-read 
     end-if 
     initialize konuk-rec 

     evaluate rap-durum(1:1)
     when "I" 
        if link-var not = 3 
           move rap-durum(1:1)      to konuk-durumu         
           start konuk key not < konuk-oda invalid 
                 continue 
           end-start
        else
           move rap-durum(1:1)      to konuk-durumu         
           move link-fol-no         to konuk-folio
           start konuk key not < konuk-anah invalid 
                 continue 
           end-start           
        end-if 
     when "H"
        evaluate gir-cik-durum(1:1)
        when "C"
          if link-var not = 3
                move rap-durum(1:1)      to konuk-durumu
                move rap-cout-tarihi     to konuk-git-tar
                start konuk key not < konuk-git invalid 
                      continue 
                end-start
          else
              move rap-durum(1:1)        to konuk-durumu
              move link-fol-no           to konuk-folio
              start konuk key not < konuk-anah invalid 
                    continue 
              end-start             
          end-if 
        when "G"
                move rap-durum(1:1)      to konuk-durumu
                move rap-cout-tarihi     to konuk-gel-tar
                start konuk key not < konuk-gel invalid 
                      continue 
                end-start
        end-evaluate 
     end-evaluate  
     perform with test after until fs-konuk = "10"
     read konuk next no lock end move "10" to fs-konuk
     not at end
            if link-var = 3
                if konuk-folio <> link-fol-no
                    exit perform 
                end-if 
            end-if 
            if konuk-durumu <> rap-durum(1:1)
                exit perform 
            end-if
            if konuk-fol-kodu not = rap-tipi(1:1) and
               rap-tipi(1:1)  not = "X"
                 exit perform cycle 
            end-if 
            if konuk-acenta not = rap-acenta and
               rap-acenta not = spaces
                  exit perform cycle 
            end-if 
            if konuk-firma not = rap-firma and
               rap-firma not = spaces
                  exit perform cycle 
            end-if
            if konuk-odano not = rap-oda-no and
               rap-oda-no not = spaces
                 exit perform cycle 
            end-if
            if konuk-grup-no not = rap-grup and
               rap-grup not = zeroes 
                  exit perform cycle 
            end-if

            evaluate rap-durum(1:1) 
            when "H"
               evaluate gir-cik-durum(1:1)
               when "C"
                 if konuk-git-tar <> rap-cout-tarihi
                      exit perform 
                 end-if 
               when "G"
                 if konuk-gel-tar <> rap-cout-tarihi
                      exit perform 
                 end-if 
               end-evaluate 
            end-evaluate

            initialize pencere-toplamlar
            perform bakiye-bul
            perform grid-kayit-ekle

     end-read 
     end-perform
     close konuk folref musteri depkod 
     modify gd-sec,mass-update = 0.
*
 grid-kayit-ekle. |penceredeki bakiyeler bulunuyor..
     initialize ii  kac-adet penler-ust 
     perform varying ii 
               from 1
               by 1
               until ii > 10
                  if p-var(ii) not = 0 and
                     p-var(ii) not = spaces
                       if p-var(ii) = 1
                          add 1 to kac-adet
                          move ii       to penler(kac-adet)
                          initialize gd-sec-rec
                          perform grid-satir-ekle |pencerelere göre grid yükleniyor.
                       end-if 
                  end-if 
     end-perform.
*
 grid-satir-ekle.        
     move konuk-odano    to gd-sec-odano  
     move konuk-fol-kodu to gd-sec-tipi
     move konuk-folio    to gd-sec-folio 
     move konuk-adi      to gd-sec-adi   
     move konuk-soyadi   to gd-sec-soyadi 
     
     move konuk-gel-gun  to egun
     move konuk-gel-ay   to eay
     move konuk-gel-yil  to eyil
     move etarih         to gd-sec-gir-tar
     
     move konuk-git-gun  to egun
     move konuk-git-ay   to eay
     move konuk-git-yil  to eyil
     move etarih         to gd-sec-git-tar
     add 1               to i
     
     move p-bakiye(ii)   to stutar
     move stutar         to gd-sec-bakiye  
     move ii             to gd-sec-pen

     move p-tutar(ii)      to 13-z
     move 13-z              to gd-sec-tutar
        
     modify gd-sec(i,1)
        record-to-add   = gd-sec-rec
        row-color       = 480
        bitmap          = artieksi-bmp
        bitmap-number   = 1 
        bitmap-width    = 16
        bitmap-trailing = 1
        hidden-data     = gd-sec-rec.
*
 fatura-hazirla.
     evaluate rap-durum
     when "I"
             perform konuk-bul
     when "H"
             perform konuk-bul
     end-evaluate.
*
 gd-sec-Ev-Other.
     evaluate event-type
     when msg-begin-entry
            set event-action to event-action-fail 
            inquire gd-sec(event-data-2,1),
                       hidden-data gd-sec-rec                         
     when msg-bitmap-clicked         
         set event-action to event-action-fail 
         evaluate event-data-1
         when 1               
              initialize toplam-kdv-tutari matrah-tutari alt-toplam genel-toplam
              move 1  to kayit-sayi kdv-toplam-sayi

              inquire gd-sec(event-data-2,1),
                      hidden-data gd-sec-rec

              inquire gd-sec(event-data-2,2)
                      hidden-data in gd-sec-secildi

              if gd-sec-bakiye <> spaces
                 display message box "Bakiyeli Folio'ya Fatura Kesilemez..." new-line
                                     "Bakiye : "gd-sec-bakiye
                                 title "Uyari"
                                 icon 1
                     exit paragraph 
              end-if 
              
              if gd-sec-secildi = 1
                 perform grid-kayit-secim-iptal
              else
                 perform grid-kayit-secildi   
              end-if                             
         end-evaluate 
     end-evaluate.
*
 kdv-baslik-yukle.
     modify form1-gd-1,reset-grid = 1
                       mass-update = 1
     initialize form1-gd-1-record
     move "Kdv"           to gd-1-col-1
     move "Matrah"        to gd-1-col-2
     move "Kdv Tutari"    to gd-1-col-3
     move "Tutar"         to gd-1-col-4
     modify form1-gd-1,record-to-add(form1-gd-1-record).
*
 kdv-grid-yukle.
     open input kdv
     initialize kdv-rec 
     start kdv key not < kdv-anah invalid 
          continue 
     not invalid 
     perform with test after until fs-kdv = "10"
     read kdv next no lock end move "10" to fs-kdv
     not at end              
              initialize form1-gd-1-record
              move kdv-orani      to gd-1-col-1
              move kdv-matrah     to etutar
              move etutar         to gd-1-col-2

              move kdv-kdv-tutar  to etutar
              move etutar         to gd-1-col-3

              move kdv-tutar      to etutar
              move etutar         to gd-1-col-4

              add 1 to kdv-toplam-sayi
              compute genel-toplam = genel-toplam + kdv-tutar
              modify form1-gd-1,
                      record-to-add(form1-gd-1-record)
     end-read 
     end-perform
     end-start
     close kdv
     modify form1-gd-1,mass-update = 0

     if genel-toplam > 0
        initialize form1-gd-1-record
        move "T"              to gd-1-col-1
        move genel-toplam     to etutar
        move etutar           to gd-1-col-4
        modify form1-gd-1(kdv-toplam-sayi+ 1 ,1),
                   record-to-add(form1-gd-1-record)
                   row-color = 480
     end-if. 
*
 dep-top-grid-yukle.
     open input deptop depkod
     open i-o kdv
     initialize deptop-rec 
     start deptop key not < deptop-anah invalid 
          continue 
     not invalid 
     perform with test after until fs-deptop = "10"
     read deptop next no lock end move "10" to fs-deptop
     not at end 
             initialize  depkod-rec
             move deptop-depkod(1:3)                 to  depkod-anah
             read depkod no lock invalid 
                  move "Tanimsiz..."            to depkod-adi
             end-read 
             if DEPKOD-FATURA-TAKIP <> "E"
                 exit perform cycle 
             end-if 
             if depkod-ba <> "B"
                exit perform cycle 
             end-if 
             initialize kdv-rec
             move depkod-kdv                 to kdv-orani
             read kdv no lock invalid  
                  move deptop-tutar          to kdv-tutar
                  move deptop-matrah-tutari  to kdv-matrah
                  move deptop-kdv-tutari     to kdv-kdv-tutar
                  write kdv-rec end-write 
             not invalid 
                  add deptop-tutar           to kdv-tutar
                  add deptop-matrah-tutari   to kdv-matrah
                  add deptop-kdv-tutari      to kdv-kdv-tutar
                  rewrite kdv-rec end-rewrite 
             end-read              
     end-read 
     end-perform
     end-start
     close deptop depkod kdv.
*
 alt-grid-baslik-yukle.
     modify gd-yaz,reset-grid = 1
                   mass-update = 1
     initialize gd-yaz-rec
     move "#"                     to gd-yaz-buton
     move "Tarih"                 to gd-yaz-tarih
     move "Oda"                   to gd-yaz-odano
     move "Folio"                 to gd-yaz-folio
     move "Dep"                   to gd-yaz-dep
     move "Departman Adi"         to gd-yaz-dep-adi
     move "Matrah(KDV'siz)"       to gd-yaz-matrah
     move "KDV"                   to gd-yaz-kdv
     move "Tutar(KDV'li)"         to gd-yaz-tutar
     modify gd-yaz,record-to-add(gd-yaz-rec).
*
 takas-sil.
     open i-o takas
     initialize takas-rec 
     move gd-sec-folio        to takas-folio
     move gd-sec-odano        to takas-oda
     move gd-sec-pen          to takas-pen
     read takas no lock invalid
         continue 
     not invalid 
         delete takas end-delete 
     end-read 
     close takas.
*
 takas-yaz.
     open i-o takas.
     initialize takas-rec 
     move gd-sec-folio   to takas-folio
     move gd-sec-odano   to takas-oda
     move gd-sec-adi     to takas-adi
     move gd-sec-soyadi  to takas-soy
     move gd-sec-pen     to takas-pen
     move function numval(gd-sec-tutar)   to takas-tutar
     move gd-sec-tipi    to takas-folio-tipi 
     write takas-rec invalid 
         rewrite takas-rec end-rewrite 
     end-write 
     close takas.
*
 alt-grid-ekle.| alt grid ve tab sekmesindeki grid için yapýldý.!!!!!! Dikkat !!!en önemli paragraf.
    delete file deptop kdv
    open input romhrk depkod doviz 
              takas yromhrk hrk2 exthrk 
    open i-o kdv deptop
    initialize takas-rec 
    move 1    to kayit-sayi   
    start takas key not < takas-anah invalid 
         continue 
    not invalid 
    perform with test after until fs-takas = "10"
    read takas next no lock end move "10"  to fs-takas
    not at end          
               evaluate takas-folio-tipi
               when "R"
                  perform romhrk-bul
               when "E"
                  perform exthrk-bul
               end-evaluate                    
    end-read 
    end-perform
    end-start

     initialize deptop-rec 
     start deptop key > deptop-anah invalid 
        continue
          not invalid
          perform until fs-deptop = "10"
              read deptop next no lock end move "10" to fs-deptop 
                   not end
                      if  deptop-tutar  < 0 then 
                            display message box "Toplam Eksi Gelire Fatura Kesemessiniz " new-line
                                                "Lutfen duzeltiniz"                      new-line
                                                deptop-depkod  " " deptop-dep-adi     
                      end-if
              end-read
          end-perform
     end-start
         

    close romhrk depkod takas doviz 
          deptop exthrk kdv yromhrk hrk2
    modify gd-yaz,mass-update = 0.
*
 romhrk-bul.     
    initialize romhrk-rec cor-var
    move takas-folio     to romhrk-folio
    start romhrk key not < romhrk-anah invalid 
         continue 
    not invalid 
    perform with test after until fs-romhrk = "10"
    read romhrk next no lock end move "10"  to fs-romhrk
    not at end 
          if romhrk-folio <> takas-folio
              exit perform 
          end-if
          if romhrk-fatura-no not = zeroes
             exit perform cycle 
          end-if
          if romhrk-ref not = takas-pen
             exit perform cycle 
          end-if 

          initialize depkod-rec 
          move romhrk-depkod       to depkod-anah
          read depkod no lock invalid
               move "Tanimsiz.."   to depkod-adi
          end-read 
  
          add 1                    to kayit-sayi
          initialize gd-yaz-rec
          move romhrk-gun          to egun
          move romhrk-ay           to eay
          move romhrk-yil          to eyil
          move etarih              to gd-yaz-tarih

          move takas-oda           to gd-yaz-odano
          move takas-folio         to gd-yaz-folio
          move gd-sec-tipi         to gd-yaz-tipi
          move romhrk-depkod       to gd-yaz-dep

          initialize depkod-rec 
          move romhrk-depkod       to depkod-anah
          read depkod no lock invalid
               move "Tanimsiz.."   to depkod-adi
          end-read 
               move depkod-adi     to gd-yaz-dep-adi

            initialize hrk2-rec
            move romhrk-anah      to hrk2-anah
            read hrk2 no lock invalid
                 continue
            end-read
            initialize yromhrk-rec 
            move hrk2-kaynak-folio     to yromhrk-folio
            move romhrk-islem          to yromhrk-islem
            read yromhrk no lock invalid
                 continue 
            end-read 
           
          initialize deptop-rec 
          move romhrk-depkod     to deptop-depkod(1:3)
                if yromhrk-kk-onay-kodu not = spaces 
                   move yromhrk-kk-onay-kodu  to deptop-depkod(4:)
                   move 2                     to deptop-dovizli|onay kodu
                else
                   if yromhrk-doviz-kodu > 0
                      initialize doviz-rec 
                      move yromhrk-doviz-kodu to doviz-kodu
                      read doviz no lock invalid 
                           continue 
                      not invalid 
                           move d-kisa-adi    to deptop-depkod(4:)
                           move 1             to deptop-dovizli
                      end-read                        
                   end-if 
                end-if 
          move romhrk-ba                      to deptop-ba
          read deptop no lock invalid 
              if DEPKOD-TURU = 2 then             
                 initialize depkod-rec deptop-rec 
                 move ROMHRK-CORR-DEPKOD to depkod-anah deptop-depkod   
                 read depkod no lock invalid
                     continue
                 end-read
                     move depkod-ba  to deptop-ba
                     read deptop no lock invalid 
                        continue                     
                     end-read 
                     move -1 to carpan
                     else 
                     move 1 to carpan
              end-if

              compute matrah-tutari rounded = 
                      (romhrk-tl-tutar  / (100 + depkod-kdv ) ) * 100

              compute toplam-kdv-tutari rounded = 
                      romhrk-tl-tutar - matrah-tutari 

              
               move depkod-adi             to deptop-dep-adi

                  if carpan = 1 
                       add romhrk-tl-tutar         to deptop-tutar
                       if yromhrk-doviz-kodu > 0
                          add yromhrk-doviz-tut       to deptop-dv-tutar
                       end-if 
                       add matrah-tutari           to deptop-matrah-tutari
                       add toplam-kdv-tutari       to deptop-kdv-tutari
                  else
                      subtract romhrk-tl-tutar         from deptop-tutar
                      subtract matrah-tutari           from deptop-matrah-tutari
                      subtract toplam-kdv-tutari       from deptop-kdv-tutari
                       if yromhrk-doviz-kodu > 0
                          subtract yromhrk-doviz-tut       from deptop-dv-tutar
                       end-if
                 end-if

               write deptop-rec invalid 
                  rewrite deptop-rec end-rewrite 
               end-write 
          not invalid 
              if DEPKOD-TURU = 2 then             
                 initialize depkod-rec deptop-rec 
                 move ROMHRK-CORR-DEPKOD to depkod-anah deptop-depkod   
                 read depkod no lock invalid
                     exit perform cycle
                 end-read
                     move depkod-ba  to deptop-ba
                     read deptop no lock invalid 
                        continue                             
                     not invalid 
                         compute deptop-tutar = deptop-tutar - romhrk-tl-tutar
                         if deptop-tutar < 0
                             continue
                         end-if
                     end-read
                     move -1 to carpan
              else 
                     move 1 to carpan
              end-if

              compute matrah-tutari rounded = 
                      (romhrk-tl-tutar  / (100 + depkod-kdv ) ) * 100

              compute toplam-kdv-tutari rounded = 
                      romhrk-tl-tutar - matrah-tutari 

              compute deptop-tutar = 
                      deptop-tutar + ( romhrk-tl-tutar  * carpan )

              compute deptop-matrah-tutari = 
                      deptop-matrah-tutari + ( matrah-tutari * carpan )

              compute deptop-kdv-tutari = 
                      deptop-kdv-tutari +  ( toplam-kdv-tutari * carpan )
              if yromhrk-doviz-kodu > 0                       
                     compute deptop-dv-tutar = deptop-dv-tutar + (yromhrk-doviz-tut * carpan)
              end-if 
              rewrite deptop-rec end-rewrite 
          end-read
                 
          move matrah-tutari       to etutar
          move etutar              to gd-yaz-matrah

          move toplam-kdv-tutari   to etutar
          move etutar              to gd-yaz-kdv

          move romhrk-tl-tutar     to etutar
          move etutar              to gd-yaz-tutar
          compute alt-toplam = alt-toplam + romhrk-tl-tutar  

          modify gd-yaz(kayit-sayi,1)
               record-to-add   = gd-yaz-rec
               bitmap          = artieksi-bmp
               bitmap-number   = 2 
               bitmap-width    = 16
               bitmap-trailing = 1
               hidden-data     = gd-yaz-rec
        
    end-read 
    end-perform
    end-start.
*
 exthrk-bul.   
    initialize exthrk-rec 
    move takas-folio     to exthrk-folio
    start exthrk key not < exthrk-anah invalid 
         continue 
    not invalid 
    perform with test after until fs-exthrk = "10"
    read exthrk next no lock end move "10"  to fs-exthrk
    not at end 
          if exthrk-folio <> takas-folio
              exit perform 
          end-if
          if exthrk-fatura-no not = zeroes
             exit perform cycle 
          end-if

          if exthrk-ref not = takas-pen
             exit perform cycle 
          end-if 

          initialize depkod-rec 
          move exthrk-depkod  to depkod-anah
          read depkod no lock invalid
               move "Tanimsiz.." to depkod-adi
          end-read 

          add 1               to kayit-sayi          
          initialize gd-yaz-rec
          move takas-oda      to gd-yaz-odano
          move takas-folio    to gd-yaz-folio
          move gd-sec-tipi    to gd-yaz-tipi
          move exthrk-depkod  to gd-yaz-dep

          move exthrk-gun     to egun
          move exthrk-ay      to eay
          move exthrk-yil     to eyil
          move etarih         to gd-yaz-tarih

          initialize depkod-rec 
          move exthrk-depkod  to depkod-anah
          read depkod no lock invalid
               move "Tanimsiz.." to depkod-adi
          end-read 
                   
          move depkod-adi    to gd-yaz-dep-adi

            initialize hrk2-rec
            move exthrk-anah      to hrk2-anah
            read hrk2 no lock invalid
                 continue
            end-read
            initialize yromhrk-rec 
            move hrk2-kaynak-folio     to yromhrk-folio
            move romhrk-islem          to yromhrk-islem
            read yromhrk no lock invalid
                 continue 
            end-read

          initialize deptop-rec 
          move exthrk-depkod     to deptop-depkod(1:3)
                if yromhrk-kk-onay-kodu not = spaces 
                   move yromhrk-kk-onay-kodu  to deptop-depkod(4:)
                   move 2                     to deptop-dovizli|onay kodu
                else
                   if yromhrk-doviz-kodu > 0
                      initialize doviz-rec 
                      move yromhrk-doviz-kodu to doviz-kodu
                      read doviz no lock invalid 
                           continue 
                      not invalid 
                           move d-kisa-adi    to deptop-depkod(4:)
                           move 1             to deptop-dovizli
                      end-read                        
                   end-if 
                end-if 

          move exthrk-ba         to deptop-ba
          read deptop no lock invalid 
                  if DEPKOD-TURU = 2 then             
                     initialize depkod-rec deptop-rec 
                     move extHRK-CORR-DEPKOD to depkod-anah deptop-depkod   
                     read depkod no lock invalid
                         continue
                     end-read
                         move depkod-ba  to deptop-ba
                         read deptop no lock invalid 
                            continue
                                                
                         end-read 
                           move -1 to carpan
                  else 
                           move 1 to carpan
                  end-if

                  compute matrah-tutari rounded = 
                          (exthrk-tl-tutar  / (100 + depkod-kdv ) ) * 100
                  compute toplam-kdv-tutari rounded = 
                          exthrk-tl-tutar - matrah-tutari 


                 if carpan = 1 
                       add exthrk-tl-tutar          to deptop-tutar
                       add matrah-tutari           to deptop-matrah-tutari
                       add toplam-kdv-tutari       to deptop-kdv-tutari
                       if yromhrk-doviz-kodu > 0
                          add yromhrk-doviz-tut       to deptop-dv-tutar
                       end-if 
                 else
                      subtract exthrk-tl-tutar          from deptop-tutar
                      subtract matrah-tutari           from deptop-matrah-tutari
                      subtract toplam-kdv-tutari       from deptop-kdv-tutari
                       if yromhrk-doviz-kodu > 0
                          subtract yromhrk-doviz-tut       from deptop-dv-tutar
                       end-if                       
                 end-if
            
               move depkod-adi             to deptop-dep-adi
              
               write deptop-rec invalid 
               rewrite deptop-rec end-rewrite 
               end-write 
          not invalid        
                  if DEPKOD-TURU = 2 then             
                     initialize depkod-rec deptop-rec 
                     move extHRK-CORR-DEPKOD to depkod-anah deptop-depkod   
                     read depkod no lock invalid
                         continue
                     end-read
                         move depkod-ba  to deptop-ba
                         read deptop no lock invalid 
                             continue
                                                
                         end-read 
                          move -1 to carpan
                      else 
                           move 1 to carpan
                  end-if

                  compute matrah-tutari rounded = 
                          (exthrk-tl-tutar  / (100 + depkod-kdv ) ) * 100
                  compute toplam-kdv-tutari rounded = 
                          exthrk-tl-tutar - matrah-tutari       

               compute deptop-tutar = 
                       deptop-tutar + ( exthrk-tl-tutar * carpan )

               compute deptop-matrah-tutari = 
                       deptop-matrah-tutari + (matrah-tutari * carpan )

               compute deptop-kdv-tutari = 
                       deptop-kdv-tutari + (toplam-kdv-tutari * carpan )
              if yromhrk-doviz-kodu > 0                       
                     compute deptop-dv-tutar = deptop-dv-tutar + (yromhrk-doviz-tut * carpan)
              end-if
               rewrite deptop-rec end-rewrite 
          end-read 
          move matrah-tutari     to etutar
          move etutar            to gd-yaz-matrah

          move toplam-kdv-tutari        to etutar
          move etutar            to gd-yaz-kdv

          move exthrk-tl-tutar   to etutar
          move etutar            to gd-yaz-tutar
          compute alt-toplam = alt-toplam + exthrk-tl-tutar  

          modify gd-yaz(kayit-sayi,1)
               record-to-add   = gd-yaz-rec
               bitmap          = artieksi-bmp
               bitmap-number   = 2 
               bitmap-width    = 16
               bitmap-trailing = 1
               hidden-data     = gd-yaz-rec
 
    end-read 
    end-perform
    end-start.
*
 acenta-oku.
    if rap-acenta not = spaces
       open input acenta
       initialize acenta-rec
       move rap-acenta   to acenta-kodu
       read acenta no lock invalid 
            move "Tanimsiz Acenta" to rap-acenta-adi
            MOVE 4    to accept-control
            move 1071 to control-id
       not invalid 
           move acenta-adi  to rap-acenta-adi
       end-read 
       close acenta 
    else
       move "Hepsi"         to rap-acenta-adi
    end-if 
    display lb-acenta-adi.
*
 firma-oku.     
    if rap-firma not = spaces
       open input firma
       initialize firma-rec
       move rap-firma   to firma-kodu
       read firma no lock invalid 
            move "Tanimsiz Firma" to rap-firma-adi
            MOVE 4    to accept-control
            move 90   to control-id
       not invalid 
           move firma-adi  to rap-firma-adi
       end-read 
       close firma 
    else
       move "Hepsi"   to rap-firma-adi
    end-if 
    display lb-firma-adi.
*
 grup-oku.
    if rap-grup not = zeroes
       open input gruplar
       initialize gruplar-rec
       move rap-grup   to gruplar-kodu
       read gruplar no lock invalid 
            move "Tanimsiz Firma" to rap-grup-adi
            MOVE 4    to accept-control
            move 90   to control-id
       not invalid 
           move gruplar-adi  to rap-grup-adi
       end-read 
       close gruplar 
    else
       move "Hepsi"   to rap-grup-adi
    end-if 
    display lb-grup-adi.
*
 cb-durum-Ex-Ntf-Selchange.
    if rap-durum(1:1) = "H"
       move tarih-tasi   to rap-cout-tarihi
       move 1 to vis-1
       display acc-cout-gun acc-cout-ay acc-cout-yil
               lb-duruma lb-durumb cb-gir-cik
    else
       initialize rap-cout-tarihi
       move 0 to vis-1
       display acc-cout-gun acc-cout-ay acc-cout-yil
               lb-duruma lb-durumb cb-gir-cik   
    end-if.
*
 bakiye-bul.
    evaluate konuk-fol-kodu
    when "R"
       perform romhrk-bakiye-bul
    when "E"
       perform exthrk-bakiye-bul
    end-evaluate.
*
 romhrk-bakiye-bul.
    open input romhrk
    initialize romhrk-rec bakiye
    move konuk-folio              to romhrk-folio
    start romhrk key not < romhrk-anah invalid 
         continue 
    not invalid 
    perform with test after until fs-romhrk = "10"
    read romhrk next no lock end move "10" to fs-romhrk
    not at end  
           if romhrk-folio <> konuk-folio
               exit perform 
           end-if
           if romhrk-fatura-no not = zeroes
               exit perform cycle 
           end-if
           if link-var = 3
               if romhrk-ref <> link-pencere
                 continue 
*                  exit perform cycle 
               end-if 
           end-if


           initialize folref-rec
           move konuk-folio       to folref-folio
           move romhrk-ref        to folref-ref
           read folref no lock invalid 
                continue 
           end-read                
                move folref-profil-anah to p-profil-anah(folref-ref)
                move 1                  to p-var(folref-ref)
                evaluate romhrk-ba
                when "B"
                        initialize depkod-rec
                        move romhrk-depkod     to depkod-anah
                        read depkod no lock invalid 
                             continue 
                        end-read 
 
                        if depkod-turu = 2  
                           initialize depkod-rec
                           move romhrk-corr-depkod to depkod-anah
                           read depkod no lock invalid 
                              continue 
                           not invalid 
                               compute borc-bakiye(folref-ref) = borc-bakiye(folref-ref) - romhrk-tl-tutar
                           end-read 
                        else
                           compute borc-bakiye(folref-ref) = borc-bakiye(folref-ref) + romhrk-tl-tutar 
                        end-if 

                        if depkod-turu = 3                         
                               compute borc-bakiye(folref-ref) = borc-bakiye(folref-ref) - romhrk-tl-tutar
                        end-if
                when "A"
                        initialize depkod-rec
                        move romhrk-depkod     to depkod-anah
                        read depkod no lock invalid 
                             continue 
                        end-read 
 
                        if depkod-turu = 2
                           initialize depkod-rec
                           move romhrk-corr-depkod to depkod-anah
                           read depkod no lock invalid 
                              continue 
                           not invalid 
                               compute borc-bakiye(folref-ref) = borc-bakiye(folref-ref) - romhrk-tl-tutar
                           end-read 
                        else
                           compute alacak-bakiye(folref-ref) = alacak-bakiye(folref-ref) + romhrk-tl-tutar 
                        end-if
                end-evaluate
                compute fark(folref-ref) = borc-bakiye(folref-ref) - alacak-bakiye(folref-ref) 
                move fark(folref-ref)          to p-bakiye(folref-ref)
                move borc-bakiye(folref-ref)   to p-tutar(folref-ref)
          

    end-read 
    end-perform
    end-start
    close romhrk
    .
*
 exthrk-bakiye-bul.
    open input exthrk  
    initialize exthrk-rec bakiye  
    move konuk-folio              to exthrk-folio
    start exthrk key not < exthrk-anah invalid 
         continue 
    not invalid 
    perform with test after until fs-exthrk = "10"
    read exthrk next no lock end move "10" to fs-exthrk
    not at end  
           if exthrk-folio <> konuk-folio
               exit perform 
           end-if 
           if exthrk-fatura-no not = zeroes
               exit perform cycle 
           end-if 
           if link-var = 3
               if exthrk-ref <> link-pencere
                 continue
*                  exit perform cycle 
               end-if 
           end-if 

           initialize folref-rec
           move konuk-folio       to folref-folio
           move exthrk-ref        to folref-ref
           read folref no lock invalid 
                continue 
           end-read  
                move folref-profil-anah to p-profil-anah(folref-ref)
                move 1                  to p-var(folref-ref)
                evaluate exthrk-ba
                when "B"
                        initialize depkod-rec
                        move exthrk-depkod         to depkod-anah
                        read depkod no lock invalid 
                             continue 
                        end-read 
 
                        if depkod-turu = 2   
                           initialize depkod-rec
                           move exthrk-corr-depkod to depkod-anah
                           read depkod no lock invalid 
                              continue 
                           not invalid 
                               compute borc-bakiye(folref-ref) = borc-bakiye(folref-ref) - exthrk-tl-tutar
                           end-read 
                        else
                           compute borc-bakiye(folref-ref) = borc-bakiye(folref-ref) + exthrk-tl-tutar 
                        end-if
                        if depkod-turu = 3                         
                           compute borc-bakiye(folref-ref) = borc-bakiye(folref-ref) - romhrk-tl-tutar
                        end-if 
 
                when "A"
                        initialize depkod-rec
                        move exthrk-depkod     to depkod-anah
                        read depkod no lock invalid 
                             continue 
                        end-read 
 
                        if depkod-turu = 2
                           initialize depkod-rec
                           move exthrk-corr-depkod to depkod-anah
                           read depkod no lock invalid 
                              continue 
                           not invalid 
                               compute borc-bakiye(folref-ref) = borc-bakiye(folref-ref) - exthrk-tl-tutar
                           end-read 
                        else
                           compute alacak-bakiye(folref-ref) = alacak-bakiye(folref-ref) + exthrk-tl-tutar
                        end-if 
                end-evaluate
                compute fark(folref-ref) = borc-bakiye(folref-ref) - alacak-bakiye (folref-ref)
                move fark(folref-ref)                            to p-bakiye(folref-ref)
                move borc-bakiye(folref-ref)                     to p-tutar(folref-ref)
            

    end-read 
    end-perform
    end-start
    close exthrk  .
*
 gd-sec-Ex-Other.
    evaluate key-status
     when 6|ctrl - f folio
          inquire gd-sec,cursor-y in sayac
          inquire gd-sec(sayac,4),
               cell-data in ydk-konuk-folio
           perform folio-cagir
    end-evaluate.
*
 folio-cagir.
     initialize dokcagir-tasi
     set dokcagir-tasi-call-folio1      to true
     move ydk-konuk-folio               to dokcagir-konuk-folio
     perform dokcagir-call
     move dokcagir-konuk-folio          to konuk-folio.
*
 dokcagir-call.
     call "/asya/ytl/obj/otel/dokcagir.asy" using dokcagir-tasi
          on exception 
             perform callerr-proc
          not on exception
             cancel "/asya/ytl/obj/otel/dokcagir.asy"
     end-call.
*
 ozet-fatura-hazirla.   
     perform alt-grid-baslik-yukle
     perform alt-grid-ekle
     perform alt-grid-baslik-yukle      
     perform dep-top-grid-yukle

     open input deptop depkod
     initialize deptop-rec etutar 
     move 1   to kayit-sayi
     start deptop key not < deptop-anah invalid 
          continue 
     not invalid 
     perform with test after until fs-deptop = "10"
     read deptop next no lock end move "10" to fs-deptop
     not at end 
          initialize  depkod-rec
          move deptop-depkod                 to  depkod-anah
          read depkod no lock invalid 
               move "Tanimsiz..."            to depkod-adi
          end-read
          add 1 to kayit-sayi
          initialize gd-yaz-rec
          move gd-sec-tipi         to gd-yaz-tipi
          move deptop-depkod       to gd-yaz-dep

          initialize depkod-rec 
          move deptop-depkod       to depkod-anah
          read depkod no lock invalid
               move "Tanimsiz.."   to depkod-adi
          end-read 
               move depkod-adi     to gd-yaz-dep-adi
                
          move deptop-matrah-tutari       to etutar
          move etutar              to gd-yaz-matrah

          move deptop-kdv-tutari   to etutar
          move etutar              to gd-yaz-kdv

          move deptop-tutar     to etutar
          move etutar              to gd-yaz-tutar
           
          modify gd-yaz(kayit-sayi,1)
               record-to-add   = gd-yaz-rec
               bitmap          = artieksi-bmp
               bitmap-number   = 2 
               bitmap-width    = 16
               bitmap-trailing = 1
               hidden-data     = gd-yaz-rec
     end-read 
     end-perform
     end-start
     close deptop depkod
     modify gd-yaz,mass-update = 0
     .
*
 detay-fatura-hazirla.
     initialize toplam-kdv-tutari matrah-tutari alt-toplam genel-toplam  
     perform alt-grid-baslik-yukle
     perform alt-grid-ekle.
*
 fatura-bilgisi-al.  
     initialize rap-adi rap-soyadi rap-adr1 rap-adr2 rap-il rap-ilce rap-pasno rap-vno rap-tcno rap-vd rap-ulke
     open input musteri folref polisxml konuk firma
     initialize musteri-rec 
     move gd-sec-folio  to folref-FOLIO
     move link-pencere    to folref-ref
     read folref no lock invalid 
          initialize konuk-rec
          move gd-sec-folio to konuk-folio
          read konuk no lock invalid 
               continue 
          not invalid 
              if konuk-rez-no > 0  or konuk-extra-rez-no > 0                
                 initialize polisxml-rec
                 if konuk-extra-rez-no > 0
                    move konuk-extra-rez-no to polisxml-rezno
                 else 
                   move konuk-rez-no   to polisxml-rezno
                 end-if 
                 move 1              to polisxml-sirano
                 read polisxml no lock invalid 
                      move konuk-adi    to rap-adi
                      move konuk-soyadi to rap-soyadi
                 not invalid 
                      move polisxml-adi        to rap-adi
                      move polisxml-soyadi     to rap-soyadi
                      initialize rap-vno
                      if polisxml-uyruk(1:2) = "TC"
                         move polisxml-tckimlikno to stc
                         move stc                 to rap-tcno
                         initialize rap-pasno
                      else
                         move polisxml-kseri      to rap-pasno
                         initialize rap-tcno
                      end-if 
                      move polisxml-adr           to rap-adr1
                      move polisxml-nil           to rap-il
                      move polisxml-nilce         to rap-ilce
                      
                 end-read 
              end-if 
          end-read 
     not invalid
          initialize musteri-rec 
          move folref-profil-sirket  to musteri-sirket
          move folref-profil-no      to musteri-no
          read musteri no lock invalid 
                  initialize konuk-rec
                  move gd-sec-folio to konuk-folio
                  read konuk no lock invalid 
                       continue 
                  not invalid         
                      move konuk-adi     to rap-adi
                      move konuk-soyadi  to rap-soyadi
                  end-read
          not invalid
           if musteri-unvan1 not = spaces or 
              musteri-vno not = spaces or 
              musteri-vdairesi not = spaces
                    move musteri-unvan1     to rap-adi   
                    move musteri-unvan2     to rap-soyadi
                    move musteri-adres1     to rap-adr1  
                    move musteri-adres2     to rap-adr2  
                    move musteri-vdairesi   to rap-vd 
                    if musteri-vno not = spaces
                       move function numval(musteri-vno)        to svno
                       move svno                                to rap-vno
                       if svno = 0
                          move musteri-vno    to rap-vno
                       end-if 
                       initialize rap-tcno
                    else 
                       move musteri-kim-tcno   to stc
                       move stc                to rap-tcno 
                       initialize rap-vno
                    end-if 
                    move musteri-il         to rap-il
                    move musteri-ilce       to rap-ilce
                    move musteri-fat-ulke   to rap-ulke
           else
                  initialize konuk-rec
                  move gd-sec-folio to konuk-folio
                  read konuk no lock invalid 
                       continue 
                  not invalid 
                      if konuk-rez-no > 0  or konuk-extra-rez-no > 0                
                         initialize polisxml-rec
                         if konuk-extra-rez-no > 0
                            move konuk-extra-rez-no       to polisxml-rezno
                         else 
                           move konuk-rez-no              to polisxml-rezno
                         end-if 
                         move 1                           to polisxml-sirano
                         read polisxml no lock invalid 
                              move konuk-adi              to rap-adi
                              move konuk-soyadi           to rap-soyadi
                         not invalid 
                              move polisxml-adi           to rap-adi
                              move polisxml-soyadi        to rap-soyadi
                              initialize rap-vno
                              if polisxml-uyruk(1:2) = "TC"
                                 move polisxml-tckimlikno to stc
                                 move stc                 to rap-tcno
                                 initialize rap-pasno 
                              else
                                 move polisxml-kseri      to rap-pasno
                                 initialize rap-tcno
                              end-if 
                              move polisxml-adr           to rap-adr1
                              move polisxml-nil           to rap-il
                              move polisxml-nilce         to rap-ilce
                         end-read 
                      end-if 
                  end-read 
           end-if 
          end-read 
     end-read
     
     if (rap-vno = spaces or kurum-fat = 1) and 
        yedek-konuk-firma not = spaces and 
        (link-pencere = 1  or kurum-fat = 1 ) and sahis-fat = 0      
         initialize firma-rec
         move yedek-konuk-firma   to firma-kodu
         read firma no lock invalid 
              continue 
         not invalid 
             initialize musteri-rec 
             move firma-profil-anah  to m-profil
             read musteri no lock invalid 
                  continue 
             not invalid 
                  if (musteri-vno not = spaces and musteri-no > 0) or kurum-fat = 1
                    move musteri-unvan1     to rap-adi   
                    move musteri-unvan2     to rap-soyadi
                    move musteri-adres1     to rap-adr1  
                    move musteri-adres2     to rap-adr2  
                    move musteri-vdairesi   to rap-vd 
                    if musteri-vno not = spaces                                              
                       move function numval(musteri-vno)        to svno
                       move svno               to rap-vno   
                       initialize rap-tcno rap-pasno
                    else 
                       move musteri-kim-tcno   to stc
                       move stc                to rap-tcno                       
                    end-if 
                    move musteri-il         to rap-il
                    move musteri-ilce       to rap-ilce
                    move musteri-fat-ulke   to rap-ulke                      
                  end-if 
             end-read 
         end-read 
     end-if 
     close musteri folref polisxml konuk firma
 
     display acc-adi,acc-soyadi,acc-adr1,acc-adr2,acc-ilce,acc-il,acc-ulke,acc-vd,acc-vno acc-tcno acc-pasno
        
     perform cari-ata.
*
 Form1-Ta-1-Aft-Tabchg-Display.
     evaluate Form1-Ta-1-Value
     when 2                    
        perform ozet-fatura-hazirla        
     end-evaluate.
*
 fat-bas. 
     open i-o genelfis doviz alsat
     move 1 to genelfis-anahtar
     read genelfis no lock invalid
       accept print-no from time
      not invalid
       add 1 to print-no
       rewrite genelfis-rec end-rewrite
     end-read
     close genelfis


     initialize dokumer-rec dokumer-anah dokumer-ozellikler-rec
                dokumer-dosya 
     set  dokumer-asya-set to true
     move print-no         to dokumer-dosya-adi
     open output dokumer
     add 1 to dokumer-anah
     write dokumer-rec
       
        perform  fat-dok
      
     set dokumer-yazici-text to true
       move "H"                to dokumer-genel-baslik-yaz
       move "E"                to faturaya-gonder

     close dokumer doviz alsat 
     if efat-degil not = 1     
        call dokumer-prog on exception
                initialize faturaya-gonder
             perform callerr-proc
        not on exception
                initialize faturaya-gonder
             cancel dokumer-prog
        end-call
     end-if.
*
 fat-dok.   
                   
       move 1 to i efat-sira 
       initialize dokumer-rec  text-oku-rec
       open input text-oku ,
       perform with test after until fs-text-oku = "10"
       initialize text-oku-2
       read text-oku next no lock end move "10" to fs-text-oku
          not end
          if text-oku-1(1:1) = "#"
            exit perform cycle 
          end-if
 
          add 1 to fatdokum-fat-sira
          initialize dokumer-rec
          if text-oku-1  = "0"
             initialize text-oku-2
          end-if


          if text-oku-1 = "1"
             move rap-fat-yil to eyil
             move rap-fat-ay  to eay
             move rap-fat-gun to egun
              
             inspect text-oku-2 replacing all "[ACENADI_______________________________]" 
                   by rap-adi(1:40) 
             inspect text-oku-2 replacing all "[ACENUNV_______________________________]"  
                   by rap-soyadi(1:40)  
             inspect text-oku-2 replacing all "[ACENADR1______________________________]"  
                   by rap-adr1 (1:40) 
             inspect text-oku-2 replacing all "[ACENADR2______________________________]"  
                   by rap-adr2 (1:40) 
             inspect text-oku-2 replacing all "[ACEN-IL___________]"                     
                   by rap-il(1:20) 
             inspect text-oku-2 replacing all "[ACEN-ILCE_________]"                     
                   by rap-ilce(1:20) 
             inspect text-oku-2 replacing all "[ACENULKE____]"                            
                   by rap-ulke(1:14)  
             inspect text-oku-2 replacing all "[ACENVDA___________]"                      
                   by rap-vd (1:20) 

             if rap-vno not = spaces
             inspect text-oku-2 replacing all "[ACENVNO__________]"                       
                   by rap-vno(1:19)
             else
               if rap-tcno not = spaces
                  move "T.C. No:"     to rap-tcno2(1:8)
                  move rap-tcno       to rap-tcno2(9:)
                  inspect text-oku-2 replacing all "[ACENVNO__________]"                       
                        by rap-tcno2(1:19)
               else
                  move "Pas. No:"      to rap-tcno2(1:8)
                  move rap-pasno       to rap-tcno2(9:)
                  inspect text-oku-2 replacing all "[ACENVNO__________]"                       
                        by rap-tcno2(1:19)                
               end-if 
             end-if 

             inspect text-oku-2 replacing all "[FATTAR__]"                                
                   by etarih
             accept zaman from time
             move zaman(1:2)   to esaat
             move zaman(3:2)   to edakika
             move zaman(5:2)   to esaniye 

             inspect text-oku-2 replacing all "[FATZ__]"                                
                   by ezaman
             
             inspect text-oku-2 replacing all "[FATNO_]"                                
                   by rap-fat-no
                inspect text-oku-2 replacing all "[ACIKLAMA____________________]"                                
                   by rap-ack

          end-if
          if text-oku-1 = "2"            
             if det-ara-tl-tut(i) not = zeroes                
                move det-ara-giryil(i)  to cin-yil
                move det-ara-giray(i)   to cin-ay
                move det-ara-girgun(i)  to cin-gun
                if det-ara-giryil(i) = zeroes
                   inspect text-oku-2 replacing all "[GIRTAR__]" by spaces
                 else  
                  inspect text-oku-2 replacing all "[GIRTAR__]" by d03-detay
                end-if
              
                move det-ara-cikyil(i)  to cout-yil
                move det-ara-cikay(i)   to cout-ay
                move det-ara-cikgun(i)  to cout-gun
                if det-ara-cikyil(i) = zeroes
                   inspect text-oku-2 replacing all "[CIKTAR__]"  by spaces
                else
                   inspect text-oku-2 replacing all "[CIKTAR__]"  by d04-detay
                end-if   
                inspect text-oku-2 replacing all "[OD]"        by det-ara-oda(i)

                move det-ara-buyuk(i)       to 3-z
                inspect text-oku-2 replacing all "[B]"         by  3-z

                move det-ara-kucuk(i)       to 3-z
                inspect text-oku-2 replacing all "[K]"         by  3-z

                move det-ara-pan-kod(i)    to 2-x,
                inspect text-oku-2 replacing all "PP"          by  2-x

                inspect text-oku-2 replacing all "[MUSADI__]" by det-ara-adi(i)
                inspect text-oku-2 replacing all "[MUSSOY__]" by det-ara-soy(i)

                initialize tl-tut  
                move det-ara-tl-tut(i) to tl-tut
                move tl-tut            to 13-z
                inspect text-oku-2 replacing all "[TLTUTAR____]"  by  13-z 
                if det-ara-onay-kodu(i) not = spaces
                   inspect text-oku-2 replacing all "[ONAY_KODU____]" by det-ara-onay-kodu(i)
                else
                   move spaces  to det-ara-onay-kodu(i)
                   inspect text-oku-2 replacing all "[ONAY_KODU____]" by det-ara-onay-kodu(i)
                end-if
                  if efat-degil = 1                  
                     initialize alsat-rec
                     move text-oku-2(5:)   to alsat-satir-aciklama
                     perform e-fatura-al-sat-yaz
                     add 1 to efat-sira 
                   end-if 
             else
                initialize text-oku-2
             end-if
             add 1 to i
             
          end-if
            
             if text-oku-1 = "3" and efat-degil = 1  and detaylar-atildi = 0
                move 1  to detaylar-atildi
                perform varying iii 
                        from 1 
                        by 1 
                        until iii > 10 
                           if bordeptutar(iii) > 0
                               
                              initialize alsat-rec                                
                              move bordeptutar(iii)   to 13-z
                              move 13-z               to alsat-satir-aciklama(40:)
                              move bordepadi(iii)     to alsat-satir-aciklama(20:19)
                              move bordep-kdv(iii)    to alsat-kdv-orani
                              move bordeptutar(iii)   to alsat-kdvli
                              compute   alsat-matrah rounded =    alsat-kdvli / ((100 + alsat-kdv-orani) /100)
                              perform e-fatura-al-sat-yaz
                              add 1 to efat-sira
                           end-if 
                 end-perform 
               
             end-if

             if text-oku-1 = "3"  
                if depart-cikma not = 1                  
                  inspect text-oku-2 replacing all "[BORC_ADI_1_______]"                                
                  by bordepadi(1)                  
                  move bordeptutar(1) to 13-z
                  inspect text-oku-2 replacing all "[B1TUTAR____]"                                
                  by 13-z
                 
                  inspect text-oku-2 replacing all "[BORC_ADI_2_______]"                                
                  by bordepadi(2)                  
                  move bordeptutar(2) to 13-z
                  inspect text-oku-2 replacing all "[B2TUTAR____]"                                
                  by 13-z                                
                  inspect text-oku-2 replacing all "[BORC_ADI_3_______]"                                
                  by bordepadi(3)                  
                  move bordeptutar(3) to 13-z
                  inspect text-oku-2 replacing all "[B3TUTAR____]"                                
                  by 13-z
                   
                  inspect text-oku-2 replacing all "[BORC_ADI_4_______]"                                
                  by bordepadi(4)                  
                  move bordeptutar(4) to 13-z
                  inspect text-oku-2 replacing all "[B4TUTAR____]"                                
                  by 13-z

                  inspect text-oku-2 replacing all "[BORC_ADI_5_______]"                                
                  by bordepadi(5)                  
                  move bordeptutar(5) to 13-z
                  inspect text-oku-2 replacing all "[B5TUTAR____]"                                
                  by 13-z

                  inspect text-oku-2 replacing all "[BORC_ADI_6_______]"                                
                  by bordepadi(6)                  
                  move bordeptutar(6) to 13-z
                  inspect text-oku-2 replacing all "[B6TUTAR____]"                                
                  by 13-z

                  inspect text-oku-2 replacing all "[BORC_ADI_7_______]"                                
                  by bordepadi(7)                  
                  move bordeptutar(7) to 13-z
                  inspect text-oku-2 replacing all "[B7TUTAR____]"                                
                  by 13-z

                  inspect text-oku-2 replacing all "[BORC_ADI_8_______]"                                
                  by bordepadi(8)                  
                  move bordeptutar(8) to 13-z
                  inspect text-oku-2 replacing all "[B8TUTAR____]"                                
                  by 13-z

                  inspect text-oku-2 replacing all "[BORC_ADI_9_______]"                                
                  by bordepadi(9)                  
                  move bordeptutar(9) to 13-z
                  inspect text-oku-2 replacing all "[B9TUTAR____]"                                
                  by 13-z

                  inspect text-oku-2 replacing all "[BORC_ADI_10______]"                                
                  by bordepadi(10)
                  move bordeptutar(10) to 13-z
                  inspect text-oku-2 replacing all "[B10TUTAR___]"                                
                  by 13-z
*/alacak departmanlarý yukleniyor                  
                  inspect text-oku-2 replacing all "[ALAC_ADI_1_______]"                                
                  by aladepadi(1)                  
                  move aladeptutar(1) to 13-z
                  inspect text-oku-2 replacing all "[A1TUTAR____]"                                
                  by 13-z

                  inspect text-oku-2 replacing all "[ALAC_ADI_2_______]"                                
                  by aladepadi(2)                  
                  move aladeptutar(2) to 13-z
                  inspect text-oku-2 replacing all "[A2TUTAR____]"                                
                  by 13-z

                  inspect text-oku-2 replacing all "[ALAC_ADI_3_______]"                                
                  by aladepadi(3)                  
                  move aladeptutar(3) to 13-z
                  inspect text-oku-2 replacing all "[A3TUTAR____]"                                
                  by 13-z

                  inspect text-oku-2 replacing all "[ALAC_ADI_4_______]"                                
                  by aladepadi(4)                  
                  move aladeptutar(4) to 13-z
                  inspect text-oku-2 replacing all "[A4TUTAR____]"                                
                  by 13-z

                  inspect text-oku-2 replacing all "[ALAC_ADI_5_______]"                                
                  by aladepadi(5)                  
                  move aladeptutar(5) to 13-z
                  inspect text-oku-2 replacing all "[A5TUTAR____]"                                
                  by 13-z
                 else
                   initialize text-oku-2
                 end-if
              end-if 
          if text-oku-1(1:1) = "B" 
             if depart-cikma not = 1
                continue 
             else
                initialize text-oku-2
             end-if 
          end-if 
          if text-oku-1 = "4" 
                  inspect text-oku-2 replacing all "K1"                                
                  by kdvler-kodu(1)                  
                  move kdvler-matrah(1) to 13-z
                  inspect text-oku-2 replacing all "[TTLKDVNET1_]"                                
                  by 13-z
                  move kdvler-kdv-tutar(1) to 13-z
                  inspect text-oku-2 replacing all "[TTLKDVSI1__]"                                
                  by 13-z
                  move kdvler-tutar(1) to 13-z
                  inspect text-oku-2 replacing all "[TTLBRUT1___]"                                
                  by 13-z

                  inspect text-oku-2 replacing all "K2"                                
                  by kdvler-kodu(2)                  
                  move kdvler-matrah(2) to 13-z
                  inspect text-oku-2 replacing all "[TTLKDVNET2_]"                                
                  by 13-z
                  move kdvler-kdv-tutar(2) to 13-z
                  inspect text-oku-2 replacing all "[TTLKDVSI2__]"                                
                  by 13-z
                  move kdvler-tutar(2) to 13-z
                  inspect text-oku-2 replacing all "[TTLBRUT2___]"                                
                  by 13-z
             

                  inspect text-oku-2 replacing all "K3"                                
                  by kdvler-kodu(3)                  
                  move kdvler-matrah(3) to 13-z
                  inspect text-oku-2 replacing all "[TTLKDVNET3_]"                                
                  by 13-z
                  move kdvler-kdv-tutar(3) to 13-z
                  inspect text-oku-2 replacing all "[TTLKDVSI3__]"                                
                  by 13-z
                  move kdvler-tutar(3) to 13-z
                  inspect text-oku-2 replacing all "[TTLBRUT3___]"                                
                  by 13-z


                  inspect text-oku-2 replacing all "K4"                                
                  by kdvler-kodu(4)                  
                  move kdvler-matrah(4) to 13-z
                  inspect text-oku-2 replacing all "[TTLKDVNET4_]"                                
                  by 13-z
                  move kdvler-kdv-tutar(4) to 13-z
                  inspect text-oku-2 replacing all "[TTLKDVSI4__]"                                
                  by 13-z
                  move kdvler-tutar(4) to 13-z
                  inspect text-oku-2 replacing all "[TTLBRUT4___]"                                
                  by 13-z


                  inspect text-oku-2 replacing all "K5"                                
                  by kdvler-kodu(5)                  
                  move kdvler-matrah(5) to 13-z
                  inspect text-oku-2 replacing all "[TTLKDVNET5_]"                                
                  by 13-z
                  move kdvler-kdv-tutar(5) to 13-z
                  inspect text-oku-2 replacing all "[TTLKDVSI5__]"                                
                  by 13-z
                  move kdvler-tutar(5) to 13-z
                  inspect text-oku-2 replacing all "[TTLBRUT5___]"                                
                  by 13-z

              
             move  kdv-matrah-toplam        to 13-z
             inspect text-oku-2 replacing all "[TTLKDVNET__]"     by  13-z

             move  kdv-kdv-toplam           to 13-z
             inspect text-oku-2 replacing all "[TTLKDVSIT__]"     by  13-z

             move  top-TL-TUTAR             to 13-z
             inspect text-oku-2 replacing all "[TTLBRUTT___]"     by  13-z
             
           end-if

          if text-oku-1 = "5"
             initialize rakam yaziile
             move top-TL-TUTAR to rakam
             call "/asya/ytl/obj/otel/yaziile.asy" using rakam yaziile
                  on exception perform callerr-proc
                  not on exception
                  cancel "/asya/ytl/obj/otel/yaziile.asy" 
             end-call

             inspect text-oku-2 replacing all
             "[YAZI.........................................................................................]"
                                                      by yaziile(1:95)
          end-if,
*          if text-oku-1 = "9"
*             move text-oku-2 to yaziile(1:95)
*          end-if
         
              move text-oku-2   to det-filler
              write dokumer-rec from detay
           
          move det-filler   to fatdokum-detay
          move k-kodu-tasi  to fatdokum-staf
          evaluate fat-turu-value(1:1)
          when "F"
             move "FATURA"       to fatdokum-aciklama
          when "T"
             move "TEST FATURA"  to fatdokum-aciklama
          end-evaluate
          if efat-degil = 1
              move "E-FATURA"   to fatdokum-aciklama
          end-if 
          write fatdokum-rec invalid 
              rewrite fatdokum-rec end-rewrite 
          end-write 

       end-read
       end-perform
       close text-oku.
*    
 max-satir-bul.
       open input text-oku,
       initialize max-satir
       perform with test after until fs-text-oku = "10"
       read text-oku next no lock end move "10" to fs-text-oku
            not end
              if text-oku-1 = "2"
                  initialize  apo
                  inspect text-oku-2 tallying apo for   all "[TLTUTAR____]" 
                   if apo > 0
                     add 1 to max-satir
                  end-if
              end-if
       end-read
       end-perform,
       close text-oku.
*
 dep-bul.
       open input deptop depkod
       initialize deptop-rec depler k  p
       start deptop key not < deptop-anah invalid 
            continue 
       not invalid 
       perform with test after until fs-deptop = "10"
       read deptop next no lock end move "10" to fs-deptop
       not at end         
              evaluate deptop-ba
              when "B"
                add 1                to k
                move deptop-dep-adi  to bordepadi(k)
                move deptop-tutar    to bordeptutar(k)
                initialize depkod-rec 
                move deptop-depkod(1:3)   to depkod-kodu
                read depkod no lock invalid
                    continue 
                not invalid 
                    move depkod-kdv  to bordep-kdv(k)
                end-read 
              when "A"                 
                add 1                to p
                move deptop-dep-adi  to aladepadi(p)(1:10)
                if deptop-depkod(4:) not = spaces 
                   if deptop-dovizli = 2
                      move "-"                 to aladepadi(p)(11:1)
                      move deptop-depkod(4:)   to aladepadi(p)(12:) 
                   end-if 
                   if deptop-dovizli = 1
                      move "-"                 to aladepadi(p)(8:1)
                      move deptop-dv-tutar     to z4
                      move z4                  to aladepadi(p)(9:)
                      move deptop-depkod(4:3)  to aladepadi(p)(17:)
                   end-if 
                end-if 
                
                move deptop-tutar    to aladeptutar(p)
              end-evaluate
       end-read 
       end-perform
       end-start
       close deptop depkod.
*
 kdv-bul.
       open input kdv
       initialize kdv-rec b kdvler 
                  kdv-matrah-toplam 
                  kdv-kdv-toplam
       start kdv key not < kdv-anah invalid 
             continue 
       not invalid 
       perform with test after until fs-kdv = "10"
       read kdv next no lock end move "10"  to fs-kdv 
       not at end
              if b < 6
               add 1              to b
               move kdv-orani     to kdvler-kodu(b)
               move kdv-matrah    to kdvler-matrah(b)
               move kdv-kdv-tutar to kdvler-kdv-tutar(b)
               move kdv-tutar     to kdvler-tutar(b)
               compute kdv-matrah-toplam = kdv-matrah-toplam + kdv-matrah
               compute kdv-kdv-toplam    = kdv-kdv-toplam + kdv-kdv-tutar
              end-if 
       end-read 
       end-perform
       end-start
       close kdv.
*
 gd-yaz-Ev-Other.
     evaluate event-type
     when msg-finish-entry
          inquire gd-yaz(event-data-2,1),
                  hidden-data gd-yaz-rec
          open i-o depkod deptop
          initialize depkod-rec
          move gd-yaz-dep   to depkod-anah
          read depkod no lock invalid 
               display message box "Departman Bulunamadi.." new-line
                                   "Islem Yapilamaz.."
                               title "Uyari"
                               icon 1
          not invalid 
              initialize deptop-rec 
              move depkod-ba   to deptop-ba
              move gd-yaz-dep  to deptop-depkod(1:3)
              read deptop no lock invalid 
                   continue 
              not invalid
                      inquire gd-yaz(event-data-2,7), 
                              cell-data in deptop-dep-adi
                      if deptop-dep-adi <> spaces
                         rewrite deptop-rec end-rewrite
                      else
                         display message box "Aciklama Bos Gecilemez.." new-line
                                             "Lutfen Tekrar Deneyiniz.."
                                         title "Uyari"
                                         icon 1
                      end-if                  
              end-read 
          end-read 
          close depkod deptop 
     end-evaluate.
*
 Form2-Ex-Other.
     evaluate key-status
     when 5055
       if tekrar-fat-no not = spaces        
          perform tekrar-fatura-grid-baslik
          perform tekrar-fatura-grid-yukle
       else
        display message box "Fatura Numarasi Giriniz.."
                        title "Uyari"
                        icon 1
               exit paragraph 
       end-if 
     end-evaluate.
*
 tekrar-fatura-grid-baslik.  
     modify gd-dzn, RESET-GRID = 1
                    mass-update = 1
     initialize Gd-dzn-rec
     move "Fat. No"                     to gd-dzn-fat-no
     move "Tarih"                       to gd-dzn-tar
     move "Saat"                        to gd-dzn-zaman
     move "F.Kesen Kullanici Adi"       to gd-dzn-adi
     move "F.Kesen Kullanici Soyadi"    to gd-dzn-soyadi
     move "#"                           to gd-dzn-print
     move "Aciklama"                    to gd-dzn-aciklama
     modify gd-dzn,record-to-add(Gd-dzn-rec).
*
 tekrar-fatura-grid-yukle.
    open i-o fatdokum kllnc
    initialize fatdokum-rec
    move tekrar-fat-no                    to fatdokum-fat-no
    move 1                                to fatdokum-fat-sira kayit-sayi
    start fatdokum key not < fatdokum-anah1 invalid 
       continue 
    not invalid 
    perform with test after until fs-fatdokum = "10"
    read fatdokum next no lock end move "10" to fs-fatdokum
    not at end 
           if fatdokum-fat-no <> tekrar-fat-no or
              fatdokum-fat-sira <> 1
                 exit perform 
           end-if
           add 1 to kayit-sayi
           initialize gd-dzn-rec
           move fatdokum-fat-no   to gd-dzn-fat-no gd-dzn-hidden-fat-no

           move fatdokum-gun      to egun gd-dzn-hidden-gun
           move fatdokum-ay       to eay  gd-dzn-hidden-ay
           move fatdokum-yil      to eyil gd-dzn-hidden-yil
           move etarih            to gd-dzn-tar

           move fatdokum-saat     to esaat  gd-dzn-hidden-saat
           move fatdokum-dakika   to edakika gd-dzn-hidden-dakika
           move fatdokum-saniye   to esaniye  gd-dzn-hidden-saniye
           move fatdokum-aciklama to gd-dzn-aciklama
           move ezaman            to gd-dzn-zaman
           initialize kllnc-rec 
           move fatdokum-staf     to k-kodu
           read kllnc no lock invalid 
               move "Tanimsiz.."  to k-adi
           end-read 
               move k-adi         to gd-dzn-adi
               move k-soyadi      to gd-dzn-soyadi
           modify gd-dzn,
                  record-to-add(gd-dzn-rec)
           modify gd-dzn(kayit-sayi,1),
                  hidden-data(gd-dzn-hidden)
           modify gd-dzn(kayit-sayi,6),
                  bitmap = print-bmp
                  bitmap-width = 16
                  bitmap-number = 1
                  bitmap-trailing = 1
    end-read 
    end-perform
    end-start
    close fatdokum kllnc
    modify gd-dzn,mass-update = 0.
*
 fatura-kopya-goster.
    open i-o genelfis  
    move 1 to genelfis-anahtar
    read genelfis no lock invalid
        accept print-no from time
     not invalid
        add 1 to print-no
        rewrite genelfis-rec end-rewrite
     end-read
     close genelfis
     initialize dokumer-rec dokumer-anah dokumer-ozellikler-rec
               dokumer-dosya 
     set  dokumer-asya-set to true
     move print-no         to dokumer-dosya-adi
     open output dokumer
     add 1 to dokumer-anah
     write dokumer-rec
     initialize dokumer-rec detay
     move "!!!! KOPYA FATURA !!!    !!!! KOPYA FATURA !!!    !!!! KOPYA FATURA !!!" 
     to det-filler(15:)
     write dokumer-rec from detay
     
     open i-o fatdokum
     initialize fatdokum-rec
     move gd-dzn-hidden-tar     to fatdokum-tarih
     move gd-dzn-hidden-zaman   to fatdokum-zaman
     move gd-dzn-hidden-fat-no  to fatdokum-fat-no
     start fatdokum key not < fatdokum-anah invalid
         continue 
     not invalid 
     perform with test after until fs-fatdokum = "10"
     read fatdokum next no lock end move "10" to fs-fatdokum
     not at end
          if fatdokum-tarih <> gd-dzn-hidden-tar or
             fatdokum-zaman  <> gd-dzn-hidden-zaman or
             fatdokum-fat-no <> gd-dzn-hidden-fat-no
               exit perform 
          end-if
          initialize dokumer-rec detay
          move fatdokum-diger to det-filler
          write dokumer-rec from detay
     end-read 
     end-perform
     end-start         
     close fatdokum

     set dokumer-yazici-text  to true
     move "H"                 to dokumer-genel-baslik-yaz
     close dokumer  
   
    call dokumer-prog on exception
         perform callerr-proc
    not on exception
         cancel dokumer-prog
    end-call.
*   
 Form1-Pb-2-Link.
     perform Acu-Form2-Routine.
*
 gd-dzn-Ev-Other.
     evaluate event-type
     when msg-begin-entry
            set event-action to event-action-fail 
     when msg-bitmap-clicked
          display message box tekrar-fat-no" 'Nolu Fatura Tekrar Yazdirilacaktir." new-line
                                           "Eminmisiniz?"
                          title "Uyari"
                          icon 1
                          type 2
                          default 2
                          returning return-code
          if return-code = 2
              exit paragraph
          end-if 
          inquire gd-dzn(event-data-2,1),hidden-data in gd-dzn-hidden
          perform fatura-kopya-goster
     end-evaluate.
*
 fatura-data-yaz.
     open i-o romhrk exthrk fatdetay fatura takas kdv depkod genel 
        perform fatura-baslik-data-yaz
        perform fatura-romhrk-exthrk-yaz
        perform genel-fatura-no-yaz
     close romhrk exthrk fatdetay fatura takas kdv depkod genel 
     .
*
 fatura-baslik-data-yaz.
    initialize takas-rec i ii
    start takas key not < takas-anah invalid 
        continue 
    not invalid 
    perform with test after until fs-takas = "10"
    read takas next no lock end move "10"  to fs-takas
    not at end 
            move rap-fat-no                to fatura-no
            move 999                       to fatura-sira
            move 1                         to ii
            perform varying i
                    from 1
                    by 1
                    until i > 15
                    if takas-folio <> zeroes
                       move takas-folio    to fatura-aciklama(ii:)
                       add 8               to ii
                    end-if
            end-perform
            write fatura-rec invalid
                  rewrite fatura-rec end-rewrite
            end-write
    end-read 
    end-perform
    end-start
  
    move rap-fat-no                to fatura-no
    move 0                         to fatura-sira
    
    read fatura no lock invalid
         continue
    end-read

    perform ara-to-fatura

    write fatura-rec invalid 
          rewrite fatura-rec end-rewrite
    end-write.
*
 ara-to-fatura.
    move rap-fat-tar              to fatura-tarihi
    move "F"                      to fatura-tipi
    move "D"                      to fatura-durumu
    move takas-folio              to fatura-folio
    move rap-adi                  to fatura-baslik-1 
    move rap-soyadi               to fatura-baslik-2 
    move rap-il                   to fatura-il
    move rap-ilce                 to fatura-ilce
    move rap-adr1                 to fatura-adres-1  
    move rap-adr2                 to fatura-adres-2
    move rap-ulke                 to fatura-ulke     
    move rap-vd                   to fatura-ver-da 
    if efat-degil = 1
       move "E"                   to fatura-e-tipi
       move cari-kodu             to fatura-e-cari  
    end-if 
    if rap-vno not = spaces 
       move rap-vno                  to fatura-ver-no   
    else 
       if rap-tcno not = spaces 
          move rap-tcno                 to fatura-ver-no
       else
          move rap-pasno                to fatura-ver-no
       end-if 
    end-if 
    move rap-ack                  to fatura-aciklama 
    move k-kodu-tasi              to fatura-staf

    move genel-toplam             to fatura-toplam fatura-g-toplam

    initialize kdv-rec 
    start kdv key not < kdv-anah invalid 
        continue 
    not invalid 
    perform with test after until fs-kdv = "10"
    read kdv next no lock end move "10" to fs-kdv
    not at end 
           evaluate kdv-anah
           when 08 |fatura datasý uygun olmadýgý için mecburi yapýldý.
               move kdv-matrah    to fatura-matrah-8
               move kdv-kdv-tutar to fatura-kdv-8
           when 18 |fatura datasý uygun olmadýgý için mecburi yapýldý.
               move kdv-matrah    to fatura-matrah-18
               move kdv-kdv-tutar to fatura-kdv-18
           end-evaluate 
           compute fatura-matrah = fatura-matrah + kdv-matrah  
           compute fatura-kdv = fatura-kdv + kdv-kdv-tutar
    end-read 
    end-perform
    end-start.
*
 fatura-romhrk-exthrk-yaz.
    initialize takas-rec
    start takas key not < takas-anah invalid
         continue 
    not invalid 
    perform with test after until fs-takas = "10"
    read takas next no lock end move "10" to fs-takas
    not at end
             evaluate takas-folio-tipi
             when "R"
                   perform romhrk-data-yaz
             when "E"
                   perform exthrk-data-yaz
             end-evaluate             
    end-read 
    end-perform
    end-start.
*
 romhrk-data-yaz.
    initialize romhrk-rec fatdetay-rec
    move takas-folio        to romhrk-folio
    start romhrk key not < romhrk-anah invalid 
        continue 
    not invalid 
    perform with test after until fs-romhrk = "10"
    read romhrk next no lock end move "10" to fs-romhrk
    not at end 
           if romhrk-folio <> takas-folio
              exit perform 
           end-if

           if romhrk-ref <> takas-pen
               exit perform cycle 
           end-if 

           if romhrk-fatura-no = 0 or  
              romhrk-fatura-no not numeric 
                move rap-fat-no  to romhrk-fatura-no
                rewrite romhrk-rec end-rewrite 
           end-if 

         accept fatdetay-kes-tarih from century-date
         accept fatdetay-kes-zaman from time   
          
         move rap-fat-tar       to  fatdetay-fat-tar                    
         move rap-fat-no        to  fatdetay-fat-no                     
         move romhrk-folio      to  fatdetay-folio                      
         move romhrk-islem      to  fatdetay-islem                      
         move "R"               to  fatdetay-romhrk-exthrk              
         move romhrk-tarih      to  fatdetay-isl-tar
         initialize depkod-rec
         move romhrk-depkod     to depkod-anah fatdetay-depkod
         read depkod no lock invalid
              display message box romhrk-depkod " 'Nolu Departman Bulunamadi..."
         end-read 

         move depkod-kdv        to  fatdetay-kdv-orani                  

         move romhrk-tl-tutar    to  fatdetay-fatura-toplam  
         compute fatdetay-fatura-matrah rounded = romhrk-tl-tutar / (1+(depkod-kdv / 100))
         compute fatura-kdv = fatdetay-fatura-toplam - fatdetay-fatura-matrah

         write fatdetay-rec invalid 
                 rewrite fatdetay-rec 
         end-write

    end-read 
    end-perform
    end-start.
*
 exthrk-data-yaz.
    initialize exthrk-rec fatdetay-rec
    move takas-folio        to exthrk-folio
    start exthrk key not < exthrk-anah invalid 
        continue 
    not invalid 
    perform with test after until fs-exthrk = "10"
    read exthrk next no lock end move "10" to fs-exthrk
    not at end 
           if exthrk-folio <> takas-folio
              exit perform 
           end-if

           if exthrk-ref <> takas-pen
               exit perform cycle 
           end-if 

           if exthrk-fatura-no = 0 or  
              exthrk-fatura-no not numeric 
                move rap-fat-no  to exthrk-fatura-no
                rewrite exthrk-rec end-rewrite 
           end-if 

         accept fatdetay-kes-tarih from century-date
         accept fatdetay-kes-zaman from time   
          
         move rap-fat-tar       to  fatdetay-fat-tar                    
         move rap-fat-no        to  fatdetay-fat-no                     
         move exthrk-folio      to  fatdetay-folio                      
         move exthrk-islem      to  fatdetay-islem                      
         move "E"               to  fatdetay-romhrk-exthrk              
         move exthrk-tarih      to  fatdetay-isl-tar
         initialize depkod-rec
         move exthrk-depkod     to depkod-anah fatdetay-depkod
         read depkod no lock invalid
              display message box exthrk-depkod " 'Nolu Departman Bulunamadi..."
         end-read 

         move depkod-kdv        to  fatdetay-kdv-orani                  

*         move fatura-matrah     to  fatdetay-fatura-matrah              
*         move fatura-kdv        to  fatdetay-fatura-kdv                 
*         move genel-toplam      to  fatdetay-fatura-toplam  

         move exthrk-tl-tutar    to  fatdetay-fatura-toplam  
         compute fatdetay-fatura-matrah rounded = exthrk-tl-tutar / (1+(depkod-kdv / 100))
         compute fatura-kdv = fatdetay-fatura-toplam - fatdetay-fatura-matrah
            
         write fatdetay-rec invalid 
                 rewrite fatdetay-rec 
         end-write
    end-read 
    end-perform
    end-start.
*
 genel-fatura-no-yaz.   
    initialize genel-rec
    move 1                to genel-anahtar
    read genel no lock invalid 
       continue 
    not invalid 
        move rap-fat-no   to genel-fol-fat-no
        rewrite genel-rec end-rewrite 
    end-read.
*
 grid-kayit-secim-iptal.
    modify gd-sec(event-data-2,1),
           bitmap = artieksi-bmp
           bitmap-width = 16
           bitmap-number = 1
           bitmap-trailing = 1

    modify gd-sec(event-data-2,2),
           hidden-data = 0
          
         perform takas-sil
    
         perform alt-grid-baslik-yukle
         perform alt-grid-ekle
         
         perform dep-top-grid-yukle

         perform kdv-baslik-yukle
         perform kdv-grid-yukle
         perform fatura-bilgisi-al
         modify gd-sec(event-data-2),
                row-color = 480.
*
 grid-kayit-secildi.
    modify gd-sec(event-data-2,1),
           bitmap = artieksi-bmp
           bitmap-width = 16
           bitmap-number = 7
           bitmap-trailing = 1
    modify gd-sec(event-data-2,2),
           hidden-data = 1

         perform takas-yaz
         perform alt-grid-baslik-yukle
         perform alt-grid-ekle
          
         perform dep-top-grid-yukle

         perform kdv-baslik-yukle
         perform kdv-grid-yukle                        
         perform fatura-bilgisi-al
         modify gd-sec(event-data-2),
                row-color = 176.
*
 fatura-no-kontrol.
     open i-o fatura
     move 1                 to hata
     initialize fatura-rec
     move rap-fat-no        to fatura-no
     move 0                    to fatura-sira
     read fatura no lock invalid
          display message box 
                  rap-fat-no," seri numarali fatura tanimlamasi yapilmamis"
                  icon mb_error_icon
                  title "Hata"
          move 4 to accept-control
          move 5 to control-id
          close fatura
          exit paragraph
     end-read
     evaluate fatura-durumu
     when "I"
        display message box 
                rap-fat-no," numarali fatura iptal edilmis !"
                icon mb_error_icon
                title "Hata"
        move 4 to accept-control
        move 5 to control-id
        close fatura
        exit paragraph

     when "D"
        display message box 
                rap-fat-no," seri numarali fatura daha once kesilmis !",
                new-line,
                new-line,
                "Kesilmis fatura Bilgileri"
                new-line,
                "Fatura Tarihi :",x"09",fatura-gun,"/"fatura-ay,"/",fatura-yil
                new-line,
                "Folio :",x"0909",fatura-folio,
                new-line,
                fatura-baslik-1, new-line,
                fatura-baslik-2, new-line,
                "Adres 1 :", x"09",fatura-adres-1,  new-line,
                "Adres 2 :", x"09",fatura-adres-2,  new-line,
                "Il :",      x"09",fatura-il,       new-line,
                "Ilce :",    x"09",fatura-ilce,     new-line,
                "Ulke :",    x"09",fatura-ulke,     new-line,
                "Vergi D.:", x"09",fatura-ver-da,   new-line,
                "Vergi N. :",x"09",fatura-ver-no    new-line new-line
                "Fatura tekrar kesilsin mi ?"
                title "Uyari"
                type mb_yes_no
                default 2
                returning return-code
        if return-code <> 1
           move 4 to accept-control
           move 5 to control-id
           close fatura
           exit paragraph
        end-if                
     end-evaluate
     move 0                     to hata
     close fatura.
*
 fatura-bakiye-kontrol.
     if hata = 1 
        exit paragraph 
     end-if 
     move 1  to hata
     open input kdv
     initialize kdv-rec hata
     start kdv key not < kdv-anah invalid 
        continue 
     not invalid 
     perform with test after until fs-kdv = "10"
     read kdv next no lock end move "10" to fs-kdv
     not at end 
            if kdv-tutar > zeroes 
                  move 0 to hata
            end-if 
     end-read 
     end-perform
     end-start
     close kdv.
*
 cb-fat-tipi-Ex-Ntf-Selchange.
     evaluate fat-tipi-value(1:1)
     when "O"
         perform ozet-fatura-hazirla
     when "D"
         perform detay-fatura-hazirla
     end-evaluate.
*
 Form1-Aft-Routine.
     delete file takas.
*
 vergi-no-kontrol.
      open i-o efatci
      initialize efatci-rec  efatcari efat-degil
      if rap-tcno not = spaces 
         move  rap-tcno   to efatci-kodu           
      end-if 
      if rap-vno not = spaces          
         move  rap-vno    to efatci-kodu 
      end-if
      read efatci no lock invalid 
          move 0 to efatcari
      not invalid 
          if efatci-giris-tarih > rap-fat-tar
              move 0 to efatcari
          else
             move 1 to efatcari
          end-if
      end-read
      close efatci
      if efatcari <> 0    
         move 1       to efat-degil
      end-if.                  
*
 e-fatura-al-sat-yaz.
    move "S"                        to alsat-tipi   
    move rap-fat-tar                to alsat-tarih
    move rap-fat-no(3:)             to alsat-belge-no         
    move efat-sira                  to alsat-sira                                                                    
    move "BS"                       to alsat-belge-tipi              
    if cari-kodu not = spaces
       move cari-kodu               to alsat-toplam-hesap-babs alsat-toplam-hesap     
    end-if
    move genel-muha-ref             to alsat-referans         
    move "Onburo Folio Fatura"      to alsat-fis-aciklama
    move 01                         to alsat-banka                
    move alsat-matrah               to alsat-ham-fiyat
    move  rap-vno                   to alsat-adres-vergi-no
    move  rap-adi                   to alsat-adres-unvani(1:40) 
    move  rap-soyadi                to alsat-adres-unvani(41:40) 
    move  rap-adr1                  to alsat-adres-cadde-adi(1:40)
    move  rap-adr2                  to alsat-adres-cadde-adi(41:40)
    move  rap-ilce                  to alsat-adres-ilce 
    move  rap-il                    to alsat-adres-il  
    move  rap-vd                    to alsat-adres-vergi-dairesi  
    move  rap-ulke                  to alsat-adres-ulke        
    move "D"                        to alsat-kdv-dh              

    compute alsat-kdv-tutar = alsat-kdvli - alsat-matrah     
    move 1                          to alsat-miktar           
    move alsat-matrah               to alsat-birim-fiyat
    move "Adet"                     to alsat-birim
    move "O"                        to alsat-kaynak
    move "E"                        to alsat-efatura-durum
    move isyeri-adres-tasi          to alsat-kaynak-kutuphane
    write alsat-rec invalid 
        display message box "E-Fatura Kaydi Olusturulamadi..!!!" new-line new-line new-line       
                            "Kesilen Fatura E-Fatura Sistemine Dusmeyecektir."                  
                        title "Uyari"
                        icon 1
    end-write.      
*
 acuserve-adres-aktar.
    move muha-sirketi of genel-rec to CARI-DOSYA-adres         
                         ISLENEN-DOSYA-adres      
                         HESAP-DOSYA-adres        
                         MAHSUP-DOSYA-adres       
                         alsat-dosya-adres  
                         REFERANS-DOSYA-adres     
                         Mgenel-DOSYA-adres       

    move all low-values to      
                           CARI-ACUSERVE-DOSYA       
                           ISLENEN-ACUSERVE-DOSYA    
                           HESAP-ACUSERVE-DOSYA      
                           MAHSUP-ACUSERVE-DOSYA     
                           genelfis-ACUSERVE-DOSYA   
                           REFERANS-ACUSERVE-DOSYA   
                           Mgenel-ACUSERVE-DOSYA     
                           genelfis-ACUSERVE-DOSYA 
                           alsat-ACUSERVE-DOSYA
                           ip-no.


    inspect genel-muha-uzak-ip 
            replacing trailing spaces by low-values.

    if genel-muha-uzak-ip <> low-values
       move all low-values to ip-no
       string ip-no,
              "@" delimited by low-values
              genel-muha-uzak-ip delimited by low-values
              ":" delimited by low-values
              into ip-no
    end-if

    string mgenel-acuserve-dosya,
           ip-no                        delimited by low-values
           mgenel-dosya                    delimited by low-values
           into mgenel-acuserve-dosya.
    string genelfis-acuserve-dosya,
           ip-no                        delimited by low-values
           genelfis-dosya                 delimited by low-values
           into genelfis-acuserve-dosya.

    string alsat-acuserve-dosya,
           ip-no                        delimited by low-values
           alsat-dosya                 delimited by low-values
           into alsat-acuserve-dosya.
    
    string hesap-acuserve-dosya,
           ip-no                        delimited by low-values
           hesap-dosya                 delimited by low-values
           into hesap-acuserve-dosya.
    string mahsup-acuserve-dosya,
           ip-no                        delimited by low-values
           mahsup-dosya                 delimited by low-values
           into mahsup-acuserve-dosya.
    string cari-acuserve-dosya,
           ip-no                        delimited by low-values
           cari-dosya                 delimited by low-values
           into cari-acuserve-dosya.
    string islenen-acuserve-dosya,
           ip-no                        delimited by low-values
           islenen-dosya               delimited by low-values
           into islenen-acuserve-dosya.
    string referans-acuserve-dosya,
           ip-no                        delimited by low-values
           referans-dosya                delimited by low-values
           into referans-acuserve-dosya.
    

    inspect CARI-ACUSERVE-DOSYA        replacing  all spaces by low-values
    inspect ISLENEN-ACUSERVE-DOSYA     replacing  all spaces by low-values
    inspect HESAP-ACUSERVE-DOSYA       replacing  all spaces by low-values
    inspect MAHSUP-ACUSERVE-DOSYA      replacing  all spaces by low-values
    inspect genelfis-ACUSERVE-DOSYA    replacing  all spaces by low-values
    inspect REFERANS-ACUSERVE-DOSYA    replacing  all spaces by low-values
    inspect mgenel-ACUSERVE-DOSYA      replacing  all spaces by low-values
    inspect genelfis-ACUSERVE-DOSYA    replacing  all spaces by low-values
    inspect alsat-ACUSERVE-DOSYA       replacing  all spaces by low-values.
*
 acc-vno-Aft-Procedure.
     perform cari-ata.
*
 cari-ata.
    move function numval(rap-vno)          to svno
    move svno                              to bakilacak-no
    if bakilacak-no > 0
       perform takcari-kontrol     
            if cari-bulundu = 1
               open input cari
               initialize cari-rec
               move bulunan-cari-kodu  to cari-kodu
               read cari no lock invalid 
                     continue 
               not invalid
                    move C-UNVAN-1                 to rap-adi                
                    move C-UNVAN-2                 to rap-soyadi            
                    move C-IL-ILCE                 to rap-il                
                    move C-IL-ILCE                 to rap-ilce
                    move C-ADRES-1                 to rap-adr1              
                    move C-ADRES-2                 to rap-adr2              
                    move C-ULKE                    to rap-ulke              
                    move C-VERGI-DAIRE             to rap-vd                
                    move C-VERGI-NO                to rap-vno
                    move function numval(rap-vno)  to svno
                    move svno                      to rap-vno
               end-read
               display acc-adi,acc-soyadi,acc-adr1,acc-adr2,acc-ilce,acc-il,acc-ulke,acc-vd,acc-vno 
               close cari
             end-if
    end-if 
     .