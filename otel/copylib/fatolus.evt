* fatolus.evt
* fatolus.evt is generated from D:\asya\acugt.ytl\otel\fatolus.Psf
* This is a generated file. DO NOT modify this file directly.


 Form1-Event-Proc.
     .

 Form1-Exception-Proc.
     PERFORM Form1-Ex-Other
     .

 Form1-Ef-1b-Exception-Proc.
     PERFORM Form1-Ef-1b-Ex-Other
     .
***   start event editor code   ***
*
 Form1-Bef-Create.
     perform adresleri-tasi.
     initialize degiskenler.
     move tarih-tasi   to rapor-tarih.
     open input genel.
     move 1 to genel-anahtar
     read genel no lock invalid
          display message box "Genel parametre tanimsiz ..."
          icon mb_error_icon
          title "Hata ..."
          goback
     end-read
      move donem-basi of genel-rec to kv-gecis-tar
     call "c$narg" using link-var
     close genel.
     move onkpara-city-ledger     to rapor-depkod.
     .
*
 Form1-Ef-1b-Aft-Procedure.
      open output acenfat2
      close acenfat2.
     initialize gec-gecme.
     open input depkod
     move rapor-depkod      to depkod-anah.
     read depkod no lock invalid
          move 1 to gec-gecme
          move 4 to accept-control
          move 4 to control-id
          move "Tanimsiz ..." to depkod-adi
     end-read
     if depkod-ba = "A" 
        continue
     else 
        move 4 to accept-control 
        move 8 to control-id
        move 1 to gec-gecme
     end-if.
     close depkod.
     display lb-depkod-adi.
     
     .
*
 Form1-Ex-Other.
     if key-status = 2001 
        continue
     else
        exit paragraph
     end-if.
     perform Form1-Ef-1aa-Aft-Procedure.
     if gec-gecme = 1 
        move 4 to accept-control control-id
        exit paragraph.

     perform Form1-Ef-1b-Aft-Procedure.
     if gec-gecme = 1 
        move 4 to accept-control
        move 8 to control-id
        exit paragraph.
        

     perform veri-olustur .
     if link-var = 0 then 
     display message box "Islem tamamlanmistir  ..."
     end-if
     set exit-pushed to true.
     exit paragraph.

 VERI-OLUSTUR.
     
    OPEN I-O ACENFAT acenfat2
    OPEN INPUT romhrk exthrk  yanrez kodlar02 TAKVIM ACENTA musteri 
               rez kur hrk2  depkod depkod2 hesayr konu2 konu3 odalar.
    open i-o konuk folref
    PERFORM ACENFAT-BOSALT 
     start depkod key >= depkod-anah invalid continue 
        not invalid 
          perform until fs-depkod = "10" 
             read depkod next no lock end move "10" to fs-depkod
                not end 
                  if depkod-ba = "A" and depkod-turu = 4 then 
                     move depkod-anah to rapor-depkod
                     perform tek-dep
                  end-if
              end-read
          end-perform
     end-start
    

     perform  acenfat2-per-ayir
     perform veri-olus2.
   
     perform acenfat-per-ayir

    CLOSE romhrk EXTHRK ACENFAT yanrez kodlar02 KONUK kur TAKVIM ACENTA rez 
          musteri hrk2 acenfat2 folref depkod depkod2 hesayr konu2 konu3 odalar.
    
*
 tek-dep.
       INITIALIZE ROMHRK-REC.
    MOVE RAPOR-TARIH  TO ROMHRK-TARIH.
    MOVE RAPOR-DEPKOD TO ROMHRK-DEPKOD.
    START ROMHRK KEY NOT < ROMHRK-ANAH2 INVALID CONTINUE,
        NOT INVALID,
        MOVE SPACES TO EVET-HAYIR,
        PERFORM WITH TEST AFTER UNTIL EVET,
            READ ROMHRK NEXT NO LOCK END MOVE "E" TO EVET-HAYIR,
                NOT END,
                
                IF ROMHRK-TARIH > RAPOR2-TARIH,
                          MOVE "E" TO EVET-HAYIR,
                          exit perform cycle
                END-IF,
                IF ROMHRK-DEPKOD > RAPOR-DEPKOD
                     
                          exit perform cycle
                END-IF,
                IF ROMHRK-TARIH >= RAPOR-TARIH and ROMHRK-TARIH <= RAPOR2-TARIH,
                    IF ROMHRK-DEPKOD = RAPOR-DEPKOD,
                       INITIALIZE ACENFAT2-REC,
        
                       move romhrk-tarih    to  ACENFAT2-TARIH
                       move romhrk-folio    to  ACENFAT2-FOLIO   
                       move romhrk-ref      to  ACENFAT2-PENCERE    
                       move romhrk-tl-tutar to  ACENFAT2-TL-TUTAR
                       move "R"             to  acenfat2-re  
                         
                       write acenfat2-rec 
                          invalid 
                           
*                          display message box acenfat2-folio " nolu folioda cift cityledger" romhrk-islem
                          add  romhrk-tl-tutar to  ACENFAT2-TL-TUTAR
                           rewrite acenfat2-rec end-rewrite
                       end-write
                    END-IF,
                END-IF,
            END-READ,
        END-PERFORM,
    END-START.
    
    INITIALIZE EXTHRK-REC.
    MOVE RAPOR-TARIH  TO EXTHRK-TARIH.
    MOVE RAPOR-DEPKOD TO EXTHRK-DEPKOD.
  
    START EXTHRK KEY NOT < EXTHRK-ANAH2 INVALID CONTINUE,
        NOT INVALID,
        MOVE SPACES TO EVET-HAYIR,
        PERFORM WITH TEST AFTER UNTIL EVET,
            READ EXTHRK NEXT NO LOCK END MOVE "E" TO EVET-HAYIR,
                NOT END,
                IF EXTHRK-TARIH > RAPOR2-TARIH,
                          MOVE "E" TO EVET-HAYIR,
                          exit perform cycle
                END-IF,
                  IF exthrk-DEPKOD not = RAPOR-DEPKOD
                         exit perform cycle
                END-IF,
                IF EXTHRK-TARIH >= RAPOR-TARIH and  EXTHRK-TARIH <= RAPOR2-TARIH,
                    IF EXTHRK-DEPKOD = RAPOR-DEPKOD,
                         
                       INITIALIZE ACENFAT2-REC,
                       move EXTHRK-DEPKOD to acenfat2-har-depkod
                       move exthrk-tarih     to  ACENFAT2-TARIH
                       move exthrk-folio    to  ACENFAT2-FOLIO   
                       move exthrk-ref      to  ACENFAT2-PENCERE 
   
                       move "E"             to  acenfat2-re  
 
                       move exthrk-tl-tutar to  ACENFAT2-TL-TUTAR
                       write acenfat2-rec invalid
***                          display message box acenfat2-folio " nolu folioda cift cityledger" exthrk-islem
                          add  exthrk-tl-tutar to  ACENFAT2-TL-TUTAR
                           rewrite acenfat2-rec end-rewrite
                       end-write
                    END-IF,
                END-IF,
            END-READ,
        END-PERFORM,
    END-START.
*
 veri-olus2. 
     || if k-kodu-tasi = "ASYA"   stop " " end-if.
     initialize acenfat2-rec
     MOVE RAPOR-TARIH  TO acenfat2-tarih
     start acenfat2 key > acenfat2-anah 
          invalid continue
          not invalid
          perform until fs-acenfat2 = "10"
            read acenfat2 next no lock  
               end move "10" to fs-acenfat2
               not end
                 if acenfat2-tarih >= RAPOR-TARIH and  acenfat2-tarih <= RAPOR2-TARIH
                    initialize romhrk-rec exthrk-rec
                    move acenfat2-folio to romhrk-folio exthrk-folio 
                 
                   if acenfat2-re = "R" 
                        start romhrk key > romhrk-anah  invalid continue
                           not invalid
                         perform until fs-romhrk = "10"
                            read romhrk next no lock 
                               end move "10" to fs-romhrk
                               not end
                                if romhrk-folio not = acenfat2-folio 
                                    move "10" to fs-romhrk
                                    else
                                      if romhrk-ref not = acenfat2-pencere
                                          exit perform cycle
                                        else
                                       
                                        perform  acenfata-ekle
                                     end-if
                                 end-if
                           end-read
                         end-perform 
                        end-start
                       else
                         start exthrk key > exthrk-anah  invalid continue
                           not invalid
                         perform until fs-exthrk = "10"
                            read exthrk next no lock 
                               end move "10" to fs-exthrk
                               not end
                                if exthrk-folio not = acenfat2-folio 
                                    move "10" to fs-exthrk
                                    else
                                      if exthrk-ref not = acenfat2-pencere
                                          exit perform cycle
                                        else
                                         move exthrk-rec to romhrk-rec
                                        perform  acenfata-ekle
                                     end-if
                                 end-if
                           end-read
                         end-perform 
                        end-start
                       end-if
                    else
                    move "10" to fs-acenfat2
                 end-if
             end-read
          end-perform
    end-start.
*
 acenfata-ekle.
      
         initialize depkod-rec depkod2-rec
        move romhrk-depkod to depkod-anah  depkod2-anah
          move 1 to carpan
          read depkod no lock invalid continue
          end-read
*          if k-kodu-tasi = "ASYA" and romhrk-depkod = 47 then stop " " end-if

          if romhrk-corr-depkod not = spaces and romhrk-corr-depkod not = zeroes 
               move romhrk-corr-depkod to depkod-anah  depkod2-anah
               move -1 to carpan
            |   if k-kodu-tasi = "ASYA" then stop " " end-if
          end-if

          read depkod no lock invalid continue
          end-read
            read depkod2 no lock invalid continue
          end-read
          if DEPKOD-FATURA-TAKIP not = "E" then 
                   exit paragraph
          end-if
            initialize hrk2-rec
             move romhrk-anah to hrk2-anah
             read hrk2 no lock invalid continue
             end-read

           perform acenfat-def-at
          move depkod-kdv to ACENFAT-KDV
          move  depkod-tipi to acenfat-tip

            if romhrk-tarih >= kv-gecis-tar and depkod2-kv-uygula =1  then 

             move kv-orani to acenfat-kv-orani
             else
             initialize  acenfat-kv-orani
             end-if

           
**          if k-kodu-tasi = "ASYA" and acenfat-tip not = 2 then stop " " end-if
            move konuk-voucher to acenfat-voucher
*            if konuk-voucher = spaces then 
*               move konuk-folio to  acenfat-voucher
*            end-if
          read acenfat no lock
             invalid
                initialize acenfat-gerisi
                move depkod-adi(1:15) to acenfat-har-depkod(1:15)
                   move konuK-acenta to acenfat-acenta
                   move konuk-firma to acenfat-sirket
                   move konuk-voucher to acenfat-voucher
                move gun-sayi to acenfat-geceleme
               move acenfat2-hesler to acenfat-hesler
               not invalid 
                if  depkod-adi(1:15) not = acenfat-har-depkod(1:15) then
                  move high-values to acenfat-har-depkod
                end-if
          end-read                       
*          if depkod-tipi not = 2 then   | LATANYA ICIN KALDIRIPDI 1 DEN FAZLA EXTRA DEPARTMANDA ACIKLAMA SORUN YAPIYORDU
*                move depkod-adi to acenfat-bos
*          end-if
          if konu2-duzeltme = 1 then
          
         if acenfat-ger-islem > 0 then 
          
           display message box acenfat-folio " nolu folioda 2 duzeltme kaydi var ---------------"
          
          
         end-if
         
           move acenfat-Kfolio       to acenfat-folio
           move acenfat2-folio       to acenfat-ger-folio
           move romhrk-islem         to acenfat-ger-islem
           move konu2-fol-kodu       to acenfat-ger-f
      end-if     
                 
            compute  ACENFAT-TL-TUTAR  rounded = ACENFAT-TL-TUTAR    
                     + ( romhrk-tl-tutar * carpan )
     
*                     if depkod-tipi = 2 or (depkod-adi(1:3) = "GAL" or "Gal" or "gal" ) 
                        if konuk-kur-degeri > 0 then 
                          compute    hrk2-ger-DV-TUTAR rounded = romhrk-tl-tutar / konuk-kur-degeri
                        end-if
*                     end-if
              if DEPKOD-TIPI = 3 then 
                  move konuk-banka to kur-banka
                  move konuk-doviz to kur-doviz
                  move  romhrk-tarih to kur-tarih
                  read kur no lock invalid continue
                    not invalid 
                       compute    hrk2-ger-DV-TUTAR rounded = romhrk-tl-tutar / doviz-alis
                  end-read
               end-if
           if hrk2-ger-DV-TUTAR > 0 then      
                    compute  ACENFAT-GER-DV-TUTAR  rounded = ACENFAT-GER-DV-TUTAR   
                                + ( hrk2-ger-DV-TUTAR * carpan )
                   else
                    compute  ACENFAT-GER-TL-TUTAR  rounded = ACENFAT-GER-TL-TUTAR   
                                + ( romhrk-tl-tutar * carpan )
                   
           end-if
           compute matrah rounded = romhrk-tl-tutar /
           ((100  + acenfat-kdv + acenfat-kv-orani ) / 100 )
           compute  ara-kv  rounded =     matrah * (( acenfat-kv-orani ) / 100 )
           compute  ara-kdv  rounded =     matrah * (( acenfat-kdv ) / 100 )

            compute matrah =   romhrk-tl-tutar - ara-kv - ara-kdv

            if  acenfat-kv-orani = 0
               compute  acenfat-kv-matrah = acenfat-kv-matrah + 0
               else
               compute  acenfat-kv-matrah = acenfat-kv-matrah + ( matrah  * carpan)
             end-if

            compute  acenfat-kv = acenfat-kv + ( ara-kv * carpan)

           if  acenfat-kdv < 10
                compute  ACENFAT-MATRAH8  rounded = ACENFAT-MATRAH8    
                             + ( matrah * carpan )
                 compute  ACENFAT-kdv8  rounded = ACENFAT-kdv8    
                             + ( ara-kdv * carpan )
                else
                  compute  ACENFAT-MATRAH18  rounded = ACENFAT-MATRAH18    
                             + ( matrah * carpan )
                  compute  ACENFAT-kdv18  rounded = ACENFAT-kdv18    
                             + ( ara-kdv * carpan )
           end-if
          
            move romhrk-fatura-no to acenfat-fat-no
       |     if   ACENFAT-MATRAH8 < 0 then stop " " end-if
           write acenfat-rec invalid rewrite acenfat-rec end-write.
          
 acenfat-def-at.    
**     if k-kodu-tasi = "X   " then stop " " end-if     
      initialize ACENFAT-REC
       initialize folref-rec
        move hrk2-kaynak-folio           to acenfat-kfolio  konuk-folio
        read konuk no lock invalid
          move acenfat2-folio      to  konuk-folio
          
          read konuk no lock invalid
             continue
             not invalid

             if konuk-voucher not > spaces then 
                     move konuk-folio to konuk-voucher
                     rewrite konuk-rec invalid stop " "  end-rewrite
             end-if
             perform gece-bul
          end-read
       not invalid
         read konuk no lock invalid
             continue
         not invalid
             if konuk-voucher not > spaces then 
                     move konuk-folio to konuk-voucher
                     rewrite konuk-rec invalid stop " "  end-rewrite
             end-if
             perform gece-bul
        end-read

          .
          move   acenfat2-folio      to  konu2-folio
           read konu2 no lock invalid continue end-read
         move konuK-acenta to acenfat-acenta
        move gun-sayi to acenfat-geceleme
       initialize folref-rec
       move acenfat2-folio      to folref-folio 
       move acenfat2-pencere    to folref-ref
       read folref no lock invalid 
            perform folref-def-at
      end-read
      if folref-profil-no not > 0 then 
          move konuk-acenta to acenta-kodu
           read acenta no lock invalid continue
           end-read
           if acenta-sdep > "001" then 
  
           if acenta-profil-no > 0 then 
                move  acenta-profil-anah to  ACENFAT-PROFIL folref-profil-anah
                rewrite folref-rec invalid write folref-rec end-rewrite
            
           end-if
           end-if
      end-if
      move acenfat2-tarih       to acenfat-tarih
       initialize musteri-rec
      move folref-profil-anah   to acenfat-profil  
      move folref-profil-sirket to musteri-sirket    
      move folref-profil-no     to musteri-no 

      read musteri no lock invalid
        initialize folref-profil-anah
      not invalid
        if musteri-muhasebe-kodu(1:3) not = "120" 
          initialize folref-profil-anah
        end-if
     end-read
      if folref-profil-no = spaces or zeroes 
             
            initialize acenfat-profil
            move "ASYA"       to ACENFAT-PROFIL(1:4)
            move konuk-acenta to ACENFAT-PROFIL(5:4)
            move spaces to   acenfat-profil(9:8)           
         
      end-if
      read konuk no lock invalid
         continue
      end-read
      if konuk-eb = "E" then 
        move konuk-eb to acenfat-eb
      end-if
      move KONUK-OPERATOR to acenfat-op
       if ONKPARA-REFERANS-VAR = 1  then 
          if  konuk-fiyat-konumu > 0 and konuk-fiyat-konumu < 40 then
            continue
            else
            move 1 to konuk-fiyat-konumu
          end-if
           evaluate   onkpara-referans-nerden 
                when 2
                  move konuk-odano to odalar-anah
                  read odalar no lock invalid
                   move 1 to  odalar-referans
                   not invalid 
                   if odalar-referans < 1 then  
                      move 1 to odalar-referans
                   end-if
                  end-read
                      move odalar-referans  to acenfat-op
        
                  
                 when other
                      move xkonum-ref(konuk-fiyat-konumu)  to acenfat-op
          end-evaluate
           initialize kodlar02-rec
            move "r"           to kodlar02-tipi
            move function numval(acenfat-op) to zz
            move zz           to kodlar02-kodu
            read kodlar02 no lock invalid 
                continue 
            not invalid 
              if (kodlar02-ref > 0)
                move kodlar02-ref to ref-z 
                move ref-z to acenfat-op
                end-if
            end-read        
    end-if


      move konuk-pan-tipi to acenfat-pan
      if konuk-grup-no > 0 and konuk-grup-no is numeric then 
         move konuk-grup-no to Acenfat-Grup
      end-if
      move acenfat2-folio       to acenfat-folio
      if konu2-duzeltme = 1 then
           if acenfat-ger-islem > 0 then 
             display message box acenfat-folio "nolu folioda 2 duzeltme kaydi var "
           end-if
           move konuk-acenta to acenta-kodu
           read acenta no lock invalid continue
           end-read
           if acenta-profil-no > 0 then 
                move  acenta-profil-anah to  ACENFAT-PROFIL
           else
              move "ASYA"       to ACENFAT-PROFIL(1:4)
               move konuK-acenta to ACENFAT-PROFIL(5:4)
              move spaces to   acenfat-profil(9:8)
           end-if
            if konuK-eb = "E" then 
                 move konuK-eb to acenfat-eb
            end-if
           move KONUK-OPERATOR to acenfat-op
            if ONKPARA-REFERANS-VAR = 1  then 
              
               evaluate   onkpara-referans-nerden 
                when 2
                  move konuk-odano to odalar-anah
                  read odalar no lock invalid
                   move 1 to  odalar-referans
                   not invalid 
                   if odalar-referans < 1 then  
                      move 1 to odalar-referans
                   end-if
                  end-read
                      move odalar-referans  to acenfat-op
        
                  
                 when other
                      move xkonum-ref(konuk-fiyat-konumu)  to acenfat-op
               end-evaluate
               initialize kodlar02-rec
            move "r"           to kodlar02-tipi
            move function numval(acenfat-op) to zz
            move zz           to kodlar02-kodu
            read kodlar02 no lock invalid 
                continue 
            not invalid 
              if (kodlar02-ref > 0)
                move kodlar02-ref to ref-z 
                move ref-z to acenfat-op
                end-if
            end-read     
           end-if

           move konuK-pan-tipi to acenfat-pan
           if konuK-grup-no > 0 and konuK-grup-no is numeric then 
                  move konuK-grup-no to acenfat-grup
           end-if


           move acenfat-Kfolio       to acenfat-folio
           move acenfat2-folio       to acenfat-ger-folio
           move romhrk-islem         to acenfat-ger-islem
           move konuK-fol-kodu       to acenfat-ger-f
           else
           if konuk-git-tar not = acenfat-tarih              
*                move konuk-gel-tar(5:4) to acenfat-grup
*                move konuk-git-tar(5:2) to acenfat-grup(5:2)
                if konuk-grup-no not > 0 
                    move konuk-git-tar(3:) to acenfat-grup
                 end-if

           end-if
      end-if     
      move acenfat2-pencere     to acenfat-pencere
     
        .

 gece-bul.
      initialize gun-sayi
        move konuk-gel-tar to takvim-anah. 
          start takvim key not < takvim-anah invalid 
                continue
                not invalid
                 if konuk-gec-giris > 0 then
        read  TAKVIM  backward NO LOCK END 
           continue
        end-read
        read  TAKVIM  backward NO LOCK END continue
        end-read
        read  TAKVIM  backward NO LOCK END continue
        end-read
       end-if 



                perform until fs-takvim = "10"
                  
         read takvim   next no lock end move "10" to fs-takvim
           not end
           if takvim-anah >= konuk-git-tar 
             move "10" to fs-takvim
             else
                add 1 to gun-sayi
           end-if
         end-read
         end-perform
         end-start
        .
 ACENFAT-BOSALT.
      INITIALIZE ACENFAT-REC.
      MOVE RAPOR-TARIH   TO ACENFAT-TARIH.
      START ACENFAT KEY NOT < ACENFAT-ANAH 
              INVALID continue
         not invalid
         perform until fs-acenfat = "10"
            READ ACENFAT NEXT NO LOCK 
                END move "10" to fs-acenfat
                not end
                   IF ACENFAT-TARIH > RAPOR2-TARIH 
                      move "10" to fs-acenfat
                      else
                        IF ACENFAT-TARIH >= RAPOR-TARIH  and ACENFAT-TARIH <= RAPOR2-TARIH
                               
                               DELETE ACENFAT INVALID CONTINUE end-delete
                                INITIALIZE ACENFAT2-REC
                              
                            move ACENFAT-folio to acenfat2-folio 
                            move ACENFAT-pencere to acenfat2-pencere
                              START ACENFAT2 KEY NOT < ACENFAT2-ANAH2 
                                  INVALID continue
                                not invalid
                                  perform until fs-acenfat2 = "10"
                                    READ ACENFAT2 NEXT NO LOCK 
                                        END move "10" to fs-acenfat2
                                        not end
                                           IF ACENFAT2-folio not = acenfat-folio or
                                              ACENFAT2-pencere not = acenfat-pencere
                                                   move "10" to fs-acenfat2
                                              else
                                               
                                                       DELETE ACENFAT2 INVALID CONTINUE end-delete
                                                
                                          end-if
                                    end-read
                                 end-perform
                              end-start 

                               if acenfat-ger-folio > 0 then 
                                         INITIALIZE ACENFAT2-REC
                                      
                                    move  ACENFAT-ger-folio  to acenfat2-folio 
                                    move  ACENFAT-pencere    to acenfat2-pencere
                                      START ACENFAT2 KEY NOT < ACENFAT2-ANAH2 
                                          INVALID continue
                                        not invalid
                                          perform until fs-acenfat2 = "10"
                                            READ ACENFAT2 NEXT NO LOCK 
                                                END move "10" to fs-acenfat2
                                                not end
                                                   IF ACENFAT2-folio not = acenfat-ger-folio or
                                                      ACENFAT2-pencere not = acenfat-pencere
                                                           move "10" to fs-acenfat2
                                                      else
                                                             
                                                               DELETE ACENFAT2 INVALID CONTINUE end-delete
                                                             move acenfat-anah to veri1
                                                  end-if
                                            end-read
                                         end-perform
                                      end-start  
                                      end-if 
                        end-if
                  end-if
            end-read
         end-perform
      end-start .
      


*
 Form1-Ef-1b-Ex-Other.
     if key-status <> 001 exit paragraph.
     initialize link-depkodara.
     move "A" to link-tipi
     call "/asya/ytl/obj/otel/depara.asy" using link-depkodara
          on exception 
             perform callerr-proc
          not on exception 
             cancel "/asya/ytl/obj/otel/depara.asy"
     end-call.
     if link-kodu <> zeroes
        move link-kodu to rapor-depkod
        display acc-depkod
     end-if.
     
     .
*
 Form1-Ef-1aa-Aft-Procedure.
     initialize gec-gecme.
     open input takvim
     move rapor-tarih   to takvim-anah
     read takvim no lock invalid
          move 1 to gec-gecme
          move 4 to accept-control
          move 4 to control-id
     end-read
     close takvim.
     
     .
*
 



                                
*
 Form1-Aft-Initdata.
*/-----------------------------\*  
*/---------DIL AYARLA----------\*    
*/-----------------------------\*    
     perform dil-ayarla-proc.
*/-----------------------------\*   
    if link-var > 0 then 
       move link-tarih(1:4) to rapor-yil
       move link-tarih(5:2) to rapor-ay
       move link-tarih(7:2) to rapor-gun
        display gun ay yil acc-depkod
       if link-var > 1 then 
        move   link-tarih2 to rapor2-tarih

       else
       move rapor-tarih to rapor2-tarih
       end-if
         move 2001 to key-status
         perform Form1-Ex-Other
         set exit-pushed to true
      end-if
     .
*
 acenfat2-per-ayir.
      initialize acenfat2-rec
      start acenfat2 key > acenfat2-anah invalid
        continue
        not invalid

          perform until fs-acenfat2 = "10"
            read acenfat2 next no lock 
              end move "10" to fs-acenfat2
              not end
              if acenfat2-re not = "R" 
                exit perform cycle
              end-if
              
               move acenfat2-folio to konuk-folio
               read konuk no lock invalid
                  continue
                  not invalid
                     initialize hesayr-rec
                    move konuk-rez-no  to hesayr-rez-no
                    move 0 to sonper
                    move 0 to gerper
                    start hesayr key > hesayr-anah invalid
                     continue
                      not invalid
                      perform until fs-hesayr = "10"
                         read hesayr next no lock end move "10" to fs-hesayr
                            not end
                               if hesayr-rez-no not = konuk-rez-no
                                   move "10" to fs-hesayr
                                   else
                                   if hesayr-tarih < konuk-gel-tar and KONUK-GEC-GIRIS not = 1 exit perform cycle end-if 
                                      if hesayr-tarih > konuk-git-tar  exit perform cycle end-if 
                                    if gerper = 0 then 
                                      move 1 to gerper
                                      move hesayr-per to sonper
                                      else
                                        if hesayr-per not = sonper
                                         if gerper < 10
                                         if genel-peryot-ayirma not = 1 
                                              add 1 to gerper
                                          end-if

                                         end-if
                                         move hesayr-per to sonper
                                       end-if
                                    end-if
                                    compute hesayr-basilacak-tut rounded = hesayr-basilacak-tut *
                                       konuk-kur-degeri
                                    add hesayr-basilacak-tut to acenfat2-per-tut(gerper)
                                    add hesayr-basilacak-tut to acenfat2-anl-tut
                                    add 1 to acenfat2-per-gece(gerper)
                              end-if
                         end-read
                       end-perform
                   end-start
                     
                   rewrite acenfat2-rec invalid stop " " end-rewrite
             end-read
         end-read
       end-perform
     end-start.

*
 acenfat-per-ayir.
    
     move 1 to  carpan 
     initialize acenfat-rec
     move rapor-tarih to acenfat-tarih
      start acenfat key > acenfat-anah invalid
        continue
        not invalid
          perform until fs-acenfat = "10"
            read acenfat next no lock 
              end move "10" to fs-acenfat
              not end  
              if acenfat-tarih > rapor2-tarih 
                move "10" to fs-acenfat
                 exit paragraph
              end-if
              if acenfat-tip not = 2
                  exit perform cycle
              end-if
              move acenfat-kfolio to konuk-folio
              read konuk no lock invalid 
                 if k-kodu-tasi not = "X   "
                    stop " "
                 end-if
              end-read
                
              if acenfat-per-gece(2) > 0 then 
                 move ACENFAT-TL-TUTAR to toplam-tut kalan-tut
                 perform varying i from 1 by 1 until i > 9 or acenfat-per-gece(i) = 0
                    compute acenfat-tl-tutar rounded = acenfat-per-tut(i) 
                    * toplam-tut 
                    / acenfat-anl-tut
                    compute kalan-tut = kalan-tut - acenfat-tl-tutar
                 

                     
            compute matrah rounded = ACENFAT-TL-TUTAR / ((100  + acenfat-kdv + acenfat-kv-orani ) / 100 )
           compute  ara-kv  rounded =     matrah * (( acenfat-kv-orani ) / 100 )
           compute  ara-kdv  rounded =     matrah * (( acenfat-kdv ) / 100 )

            compute matrah =   ACENFAT-TL-TUTAR - ara-kv - ara-kdv

            if  acenfat-kv-orani = 0
               compute  acenfat-kv-matrah = acenfat-kv-matrah + 0
               else
               compute  acenfat-kv-matrah = || acenfat-kv-matrah + 
               ( matrah  * carpan)
             end-if

            compute  acenfat-kv = ||acenfat-kv + 
                  ( ara-kv * carpan)

           if  acenfat-kdv < 10
                compute  ACENFAT-MATRAH8  rounded = ||ACENFAT-MATRAH8 +   
                                ( matrah * carpan )
                 compute  ACENFAT-kdv8  rounded = ||ACENFAT-kdv8   + 
                              ( ara-kdv * carpan )
                else
                  compute  ACENFAT-MATRAH18  rounded = ||ACENFAT-MATRAH18    +
                              ( matrah * carpan )
                  compute  ACENFAT-kdv18  rounded = || ACENFAT-kdv18    +
                              ( ara-kdv * carpan )
           end-if



*                         compute matrah rounded = ACENFAT-TL-TUTAR / ((100  + acenfat-kdv ) / 100 )
*                           if  acenfat-kdv < 10
*                                compute  ACENFAT-MATRAH8  rounded =  matrah 
*                                compute  ACENFAT-kdv8  rounded = ( ACENFAT-TL-TUTAR - matrah)
**                               else
*                                compute  ACENFAT-MATRAH18  rounded =  matrah 
*                                compute  ACENFAT-kdv18  rounded = ( ACENFAT-TL-TUTAR - matrah)
*                           end-if
                          
                           if acenfat-per-gece(i) > 0 
                           compute g-tl  rounded  =  acenfat-tl-tutar /  acenfat-per-gece(i)
                           if  konuk-kur-degeri   > 0
                              compute g-dv   rounded = acenfat-tl-tutar /  acenfat-per-gece(i) / konuk-kur-degeri
                              compute ACENFAT-GER-DV-TUTAR  rounded = g-dv * acenfat-per-gece(i)
                              initialize ACENFAT-GER-TL-TUTAR
                          end-if
                           else
                                 compute g-tl  rounded  =  acenfat-tl-tutar 
                                  if  konuk-kur-degeri   > 0
                          
                                 compute g-dv   rounded = g-tl / konuk-kur-degeri
                                   compute ACENFAT-GER-DV-TUTAR  rounded = g-dv 
                                     initialize ACENFAT-GER-TL-TUTAR
                                end-if
                           end-if
                         
                           move acenfat-per-gece(i) to acenfat-per-geceleme
                           if i > 1 then 
                             add 1 to acenfat-peryod
                           end-if
                            
  |                        if   ACENFAT-MATRAH8 < 0 then stop " " end-if  
                   write acenfat-rec invalid rewrite acenfat-rec end-write

                 end-perform
                if i > 1 then 
                    add kalan-tut to ACENFAT-TL-TUTAR

                      
                                     compute matrah rounded = ACENFAT-TL-TUTAR / ((100  + acenfat-kdv + acenfat-kv-orani ) / 100 )
                           compute  ara-kv  rounded =     matrah * (( acenfat-kv-orani ) / 100 )
                           compute  ara-kdv  rounded =     matrah * (( acenfat-kdv ) / 100 )
                
                            compute matrah =   ACENFAT-TL-TUTAR - ara-kv - ara-kdv
                
                            if  acenfat-kv-orani = 0
                               compute  acenfat-kv-matrah = acenfat-kv-matrah + 0
                               else
                               compute  acenfat-kv-matrah = ||acenfat-kv-matrah + 
                                     ( matrah  * carpan)
                             end-if
                
                            compute  acenfat-kv = ||acenfat-kv + 
                                      ( ara-kv * carpan)
                
                           if  acenfat-kdv < 10
                                compute  ACENFAT-MATRAH8  rounded = ||ACENFAT-MATRAH8  +  
                                              ( matrah * carpan )
                                 compute  ACENFAT-kdv8  rounded = ||ACENFAT-kdv8   + 
                                              ( ara-kdv * carpan )
                                else
                                  compute  ACENFAT-MATRAH18  rounded = ||ACENFAT-MATRAH18   + 
                                              ( matrah * carpan )
                                  compute  ACENFAT-kdv18  rounded = ||ACENFAT-kdv18  +   
                                              ( ara-kdv * carpan )
                           end-if
                



*                    compute matrah rounded = ACENFAT-TL-TUTAR / ((100  + acenfat-kdv ) / 100 )
*                          if  acenfat-kdv < 10
*                                compute  ACENFAT-MATRAH8  rounded =  matrah 
*                                 compute  ACENFAT-kdv8  rounded = ( ACENFAT-TL-TUTAR - matrah)
*                                else
*                                 compute  ACENFAT-MATRAH18  rounded =  matrah 
*                                 compute  ACENFAT-kdv18  rounded = ( ACENFAT-TL-TUTAR - matrah)
*                           end-if




                            if acenfat-per-geceleme > 0 
                                   compute g-tl  rounded  =  acenfat-tl-tutar /  acenfat-per-geceleme
                                     if  konuk-kur-degeri   > 0
                                  compute g-dv   rounded = acenfat-tl-tutar /  acenfat-per-geceleme / konuk-kur-degeri
                                   compute ACENFAT-GER-DV-TUTAR  rounded = g-dv * acenfat-per-geceleme
                                    initialize ACENFAT-GER-TL-TUTAR
                                    end-if
                           else
                          
                                 compute g-tl  rounded  =  acenfat-tl-tutar 
                                if  konuk-kur-degeri   > 0
                                 compute g-dv   rounded = g-tl / konuk-kur-degeri
                                   compute ACENFAT-GER-DV-TUTAR  rounded = g-dv 
                                    initialize ACENFAT-GER-TL-TUTAR
                              end-if
                           end-if
                          
                           |            if   ACENFAT-MATRAH8 < 0 then stop " " end-if
                         
                          rewrite acenfat-rec  invalid stop " "  end-rewrite
                          
                end-if
                else
                             
                     compute matrah rounded = ACENFAT-TL-TUTAR / ((100  + acenfat-kdv + acenfat-kv-orani ) / 100 )
           compute  ara-kv  rounded =     matrah * (( acenfat-kv-orani ) / 100 )
           compute  ara-kdv  rounded =     matrah * (( acenfat-kdv ) / 100 )

            compute matrah =   ACENFAT-TL-TUTAR - ara-kv - ara-kdv

            if  acenfat-kv-orani = 0
               compute  acenfat-kv-matrah = || acenfat-kv-matrah + 
                      0
               else
               compute  acenfat-kv-matrah = ||acenfat-kv-matrah + 
               ( matrah  * carpan)
             end-if

            compute  acenfat-kv = || acenfat-kv + 
                      ( ara-kv * carpan)

           if  acenfat-kdv < 10
                compute  ACENFAT-MATRAH8  rounded = || ACENFAT-MATRAH8    
                              ( matrah * carpan )
                 compute  ACENFAT-kdv8  rounded = ||ACENFAT-kdv8    
                              ( ara-kdv * carpan )
                else
                  compute  ACENFAT-MATRAH18  rounded = ||ACENFAT-MATRAH18    
                              ( matrah * carpan )
                  compute  ACENFAT-kdv18  rounded = ||ACENFAT-kdv18    
                              ( ara-kdv * carpan )
           end-if






*                          compute matrah rounded = ACENFAT-TL-TUTAR / ((100  + acenfat-kdv ) / 100 )
*                          if  acenfat-kdv < 10
*                                compute  ACENFAT-MATRAH8  rounded =  matrah 
*                                 compute  ACENFAT-kdv8  rounded = ( ACENFAT-TL-TUTAR - matrah)
*                                else
*                                 compute  ACENFAT-MATRAH18  rounded =  matrah 
*                                 compute  ACENFAT-kdv18  rounded = ( ACENFAT-TL-TUTAR - matrah)
*                           end-if
                             move acenfat-geceleme to acenfat-per-geceleme
                           if acenfat-per-geceleme  > 0

                               compute g-tl  rounded  =  acenfat-tl-tutar /  acenfat-per-geceleme
                             if  konuk-kur-degeri   > 0
                                    compute g-dv   rounded = acenfat-tl-tutar /  acenfat-per-geceleme / konuk-kur-degeri
                                   compute ACENFAT-GER-DV-TUTAR  rounded = g-dv * acenfat-per-geceleme
                                initialize ACENFAT-GER-TL-TUTAR
                              end-if
                           else
                                 compute g-tl  rounded  =  acenfat-tl-tutar 
                                 if  konuk-kur-degeri   > 0
                                      compute g-dv   rounded = g-tl / konuk-kur-degeri
                                       compute ACENFAT-GER-DV-TUTAR  rounded = g-dv 
                                        initialize ACENFAT-GER-TL-TUTAR
                              end-if
                           end-if
                          
                                             | if   ACENFAT-MATRAH8 < 0 then stop " " end-if
                          
                           rewrite acenfat-rec  invalid stop " "  end-rewrite
              end-if
               start acenfat key > acenfat-anah invalid move "10" to fs-acenfat end-start
           end-read
        end-perform
      end-start.        




          .
*
 folref-def-at.
       move folref-ref to t 
       if konuk-fol-kodu = "R" then
        
        move konuk-rez-no to yanrez-rezno
        move 1           to yanrez-sirano
        read yanrez no lock invalid 
            continue
        end-read  
        else
        exit paragraph
       end-if 
           move "B" to kodlar02-tipi
              move konuk-odeme-tipi  to kodlar02-kodu 
            read kodlar02 no lock invalid
                     move "Tanimsiz"   to kodlar02-adi
                end-read
              move ode-tipi to fol-pes
       

                initialize folref-data
             if  t = 1 or 5 then
               if fol-pes not = "A" 
                 move 1 to folref-ode
                 if acenta-tipi = 3
                    if konuk-firma > spaces 
                         move firma-profil-anah to folref-profil-anah
                      else
                         move acenta-profil-anah to folref-profil-anah
                   end-if
                   else
                   move acenta-profil-anah to folref-profil-anah
               end-if
                 write folref-rec invalid  rewrite folref-rec end-write
                 else
                 if yanrez-profil-no > 0 then
                  move yanrez-profil-anah to folref-profil-anah
                   end-if
                   move 0 to folref-ode
                 
                   
                   write folref-rec invalid   rewrite folref-rec  end-write
                
                  

               end-if
               else
               if yanrez-profil-no > 0 then 
                    move yanrez-profil-anah to folref-profil-anah
                end-if
                    move 0 to folref-ode
                    write folref-rec invalid  rewrite folref-rec   end-write
             

             end-if
          .


 


 
