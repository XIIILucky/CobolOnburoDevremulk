* for06.evt
* for06.evt is generated from D:\asya\acugt.ytl\otel\for06.Psf
* This is a generated file. DO NOT modify this file directly.


 Form1-Event-Proc.
     .

 Form1-Exception-Proc.
     PERFORM Form1-Ex-Other
     .
***   start event editor code   ***
*
 Form1-Bef-Create.
        
    perform adresleri-tasi.
    open input genel
    move 1 to genel-anahtar
    read genel no lock invalid continue
         not invalid continue
    end-read
    close genel.
    open input genel2
    move 1 to genel2-anah
    read genel2 no lock invalid continue
         not invalid continue
    end-read
    close genel2.
    perform birlesik-ref-bul
**********************************************************************pdf conv
    call "c$narg" using link-var
**********************************************************************pdf conv
    move ONKPARA-DOVIZ to butce-cev-doviz  
    MOVE 1 TO reel-gecmis
    if genel-br-ayir-cikma = 1
       move 0 to br-ayir-visible
    end-if
    if genel2-rapor-comp-durumu = spaces 
       move 2 to tumu
    else 
       move genel2-rapor-comp-durumu to tumu
    end-if
    move 1  to hayali-haric(1:1).

*
 Form1-Aft-Initdata.
    move tarih-tasi to ilk-tarih son-tarih.
    if son-ay < 12 then 
       add 1 to son-ay
       else
       move 1 to son-ay
       add 1 to son-yil
    end-if
    move "N" to rap-tip.
    display acc-01 acc-02 acc-03 acc-04 acc-05 acc-06 acc-07 com-01.
    perform Form1-Ef-1-Aft-Procedure
    move 2 to xx
    move 28 to sut-yer sutun(xx)
    perform varying eski-i from 1 by 1 until eski-i > 7
         add 1 to xx      add 7 to sut-yer      move sut-yer to sutun(xx)
         add 1 to xx      add 5 to sut-yer      move sut-yer to sutun(xx)
         add 1 to xx      add 9 to sut-yer      move sut-yer to sutun(xx)
         add 1 to xx      add 10 to sut-yer     move sut-yer to sutun(xx)
         add 1 to xx      add 10 to sut-yer     move sut-yer to sutun(xx)
         add 1 to xx      add 16 to sut-yer     move sut-yer to sutun(xx)
         add 1 to xx      add 8  to sut-yer     move sut-yer to sutun(xx)           | firat 20/02/2020 ekleme
    end-perform.
**********************************************************************pdf conv
    if link-var > 0 
        move 0 to oda-ref fiyat-ref
        move forlink-bas-tarih to ilk-tarih
        move forlink-bit-tarih to son-tarih
        move 2 to key-status
        perform Form1-Ex-Other       
    end-if 
**********************************************************************pdf conv
*/-----------------------------\*  
*/---------DIL AYARLA----------\*    
*/-----------------------------\*    
     perform dil-ayarla-proc.
*/-----------------------------\*         
     .
*
 Form1-Ex-Other.
    evaluate key-status
      when 1
        evaluate control-id
        when 12
        when 2001
             initialize acenta-cagir
             call "/asya/ytl/obj/otel/acenara.asy" 
                  using acenta-cagir  
                  on exception 
                     perform callerr-proc
                  not on exception
                     if acenta-cagir <> spaces
                        move acenta-cagir to acn-kod
                        display acc-07
                     end-if
             end-call
             move 4 to accept-control
             move 12 to control-id
        when 16
        when 17
             initialize acn-grup-kod
             call "/asya/ytl/obj/otel/grupara.asy" 
                  using "A", acn-grup-kod  
                  on exception 
                     perform callerr-proc
                  not on exception
                     display acc-08
             end-call
             move 4 to accept-control
             move 17 to control-id
        end-evaluate
        exit paragraph
      when 33 
            call "/asya/ytl/obj/otel/rezfilt.asy" 
                  using filtre-tasi  
                  on exception 
                     perform callerr-proc
                  not on exception
                     continue
             end-call
             display l-filtre 
      when 2
           perform Form1-Ef-1-Aft-Procedure

           open input doviz
           initialize alt-toplam-dizi rez-adet

           perform takas-dosya-yaz thru takas-dosya-yaz-exit

           close doviz

           initialize takas6-rec
           start takas6 key not < takas6-tarih invalid
                 initialize mesaj-link
                 move 04 to mesaj-no
                 perform mesaj-ver
                 close takas6 takas7
                 exit paragraph
           end-start

           open i-o genelfis
           move 1 to genelfis-anahtar
           read genelfis no lock invalid
                accept print-no from time
           not invalid
               add 1 to print-no
               rewrite genelfis-rec end-rewrite
           end-read
           close genelfis

**************************
           initialize dokumer-rec dokumer-anah dokumer-ozellikler-rec
                      dokumer-dosya
*****      display message box rez-adet " adet rezervasyon tarandi"
           set  dokumer-asya-set to true
           move print-no         to dokumer-dosya-adi
           open output dokumer
*/WINDOW TITLE
           initialize dokumer-rec detay
           move "W"                  to det-dokumer-20(1:)
           move "Fiyat Bazinda Forecast"   to det-filler
           write dokumer-rec from detay
*/ BASLIKLAR
           initialize dokumer-rec detay
           move "1"          to det-dokumer-20(10:1)
           move "B"                  to det-dokumer-20(1:1)
           move "Fiyat Bazinda Forecast"   to det-filler
           move "Tarih..:"     to det-filler(41:10)
           move ilk-gun        to det-filler(51:02)
           move "/"            to det-filler(53:01)
           move ilk-ay         to det-filler(54:02)
           move "/"            to det-filler(56:01)
           move ilk-yil        to det-filler(57:04)
           move "-"            to det-filler(61:01)
           move son-gun        to det-filler(62:02)
           move "/"            to det-filler(64:01)
           move son-ay         to det-filler(65:02)
           move "/"            to det-filler(67:01)
           move son-yil        to det-filler(68:04)
           write dokumer-rec from detay
         
           initialize dokumer-rec detay
           move "1"          to det-dokumer-20(10:1)
           move "B"                  to det-dokumer-20(1:1)
           move "Rapor Tipi..:"          to det-filler(01:15)
         
           evaluate rap-tip
               when "N" move "Normal Rezervasyonlar"       to det-filler(15:25)
               when "W" move "Bekle. Rezervasyonlar"       to det-filler(15:25)
               when "S" move "Silinmis Rezervasyonlar"     to det-filler(15:25)
           end-evaluate
           move "Acenta....:"           to det-filler(40:)
           move acn-kod                 to det-filler(55:04)
           move "<->"                   to det-filler(60:03)
           if acn-kod       = spaces
              move "Tum Acentalar.."    to det-filler(63:15)
           else
              open input acenta
              initialize acenta-rec  
              move acn-kod        to acenta-kodu
              read acenta no lock invalid 
                   move all "*" to acenta-adi  
              not invalid 
                  continue
              end-read
              close acenta
              move acenta-adi           to det-filler(63:15)
           end-if
           write dokumer-rec from detay
           if onkpara-referans-var = 1 then 
              initialize dokumer-rec detay
              move "1"            to det-dokumer-20(10:1)
              move "B"            to det-dokumer-20(1:1)
              if oda-ref = 0 then 
                 move "TUM KOMPLEX " TO DET-FILLER
              else
                 move ref-adi(oda-ref)to det-filler
                 move "OTEL "  to det-filler(16:)
                 move "KONAKLAMALARI" to det-filler(25:)
              end-if
              if fiyat-ref not = 0 
                 move ref-adi(fiyat-ref)to det-filler(40:)
                 move "OTEL "  to det-filler(50:)
                 move "SATISLARI" to det-filler(58:)
              end-if
              write dokumer-rec from detay
           end-if
           initialize dokumer-rec detay
           move "B"                  to det-dokumer-20(1:)
           write dokumer-rec from detay


*/ DOKUMER OZELLIKLER-REC
           initialize dokumer-rec detay
           move "O" to det-dokumer-20(1:)
           move "E" to dokumer-oto-sayfa-basi
           move 56  to dokumer-oto-sayfa-satir
           move "|" to dokumer-detay-kolon-ayirici
           move "LRRRRRRRRRRRRRRRRRRRRRRRRRR" to dokumer-align-occ
           move "2"  to dokumer-align-occ(50:1)
           move dokumer-ozellikler-rec     to det-filler
           write dokumer-rec from detay
*/ BASLIKLAR  
      
           initialize dokumer-rec detay  
           move "D1"          to det-dokumer-20(1:2)

           perform varying xx from 2   by 1 until  xx > 51 or sutun(xx) < 5,
              move "|"        to det-1(sutun(xx) - 1:1),
           end-perform 

           move "|"           to det-1(482:1),                |det-1(364:1),  firat 20/02/2020 degistirme

           open input doviz
           perform varying xx from 1 by 1 until xx > 7,
               compute yy =  7 * (xx - 1)                                                |compute yy =  6 * (xx - 1) firat 20/02/2020 degistirme
               initialize doviz-rec
               move doviz-kodu2(xx) to doviz-kodu
               read doviz no lock invalid 
                    initialize d-adi-1,
               end-read
               if xx = 7 then 
                  move "TOP."       to det-1(sutun(yy + 2):4)   
                  move "TOP."       to det-1(sutun(yy + 3):4),,  
                  move "TOP."       to det-1(sutun(yy + 4):4),,              
                  move "TOPLAM"     to det-1(sutun(yy + 5):4),,  
                  move "TOPLAM"     to det-1(sutun(yy + 6):4),,  
                  move d-adi-1      to det-1(sutun(yy + 7):11),, 
                  move "Doluluk"    to det-1(sutun(yy + 8):7),,                      | firat 20/02/2020 ekleme
               else
                  move d-adi-1       to det-1(sutun(yy + 2) :4)   
                  move d-adi-1       to det-1(sutun(yy + 3):4),,  
                  move d-adi-1       to det-1(sutun(yy + 4):4),,  
                  move d-adi-1       to det-1(sutun(yy + 5):4),,  
                  move d-adi-1       to det-1(sutun(yy + 6):4),,  
                  move d-adi-1       to det-1(sutun(yy + 7):11),,                     
                  move "Doluluk"     to det-1(sutun(yy + 8):7),,                    | firat 20/02/2020 ekleme
               end-if
           end-perform
           close doviz
           move "---------------Doviz:" to det-1(1:23)
           write dokumer-rec from detay


           initialize dokumer-rec detay  
           move "D2"           to det-dokumer-20(1:2)

           perform varying xx from 2 by 1 until  xx > 51 or sutun(xx) < 5,
               move "|"       to det-1(sutun(xx) - 1:1),
           end-perform 

           move "|"           to det-1(482:1),                |det-1(364:1),  firat 20/02/2020 degistirme

           open input doviz
           perform varying xx from 1 by 1 until xx > 7,
               compute yy =  7 * (xx - 1)                                                |compute yy =  6 * (xx - 1) firat 20/02/2020 degistirme
               initialize doviz-rec
               move doviz-kodu2(xx) to doviz-kodu
               read doviz no lock invalid 
                    initialize d-adi-1,
               end-read
               move "Oda"           to det-1(sutun(yy + 2):4)
               move "DOcc"          to det-1(sutun(yy + 3):4),,
               move "Pax"           to det-1(sutun(yy + 4):4),,
               move "Oda Ort."      to det-1(sutun(yy + 5):8),,
               move "Pax Ort."      to det-1(sutun(yy + 6):8),,
               move "Tutar      "   to det-1(sutun(yy + 7):11),,
               move "   %   "       to det-1(sutun(yy + 8):7),,              | firat 20/02/2020 ekleme
           end-perform
           close doviz
           move "Tarih.:--------------" to det-1(01:23)
           move "1"                     to det-dokumer-20(10:1)
           write dokumer-rec from detay
                   
           initialize dokumer-rec detay
           move "D3"           to det-dokumer-20(1:2)
           move "-"            to det-dokumer-20(5:1)
           move all "-"        to det-1(01:481)                 |det-1(01:364),  firat 20/02/2020 degistirme

           write dokumer-rec from detay
*********************************
           open input takvim
           initialize fs-takas6
           perform with test after until fs-takas6 = "10"
           read takas6 next no lock end move "10" to fs-takas6
           not at end
               initialize dokumer-rec detay
               move takas6-gun       to det-1(01:02)
               move takas6-ay        to det-1(04:02)
               move takas6-yil       to det-1(07:04)
               if takas6-gun not = zeroes 
                  move "/" to det-1(03:01) det-1(06:01),
               end-if
               move takas6-tarih to takvim-anah
               read takvim no lock invalid
                    continue
               end-read
               move gun-gun(takvim-gun-adi) to det-1(13:10)
               perform varying xx from 1 by 1 until xx > 7,
                   compute yy =  7 * (xx - 1)                                                |compute yy =  6 * (xx - 1) firat 20/02/2020 degistirme
                   move takas6-oda(xx)    to z4,
                   move z4          to det-1(sutun(yy + 2):6)
                   compute docc rounded =
                           takas6-pax(xx) / takas6-oda(xx)
                   move docc   to z4k,
                   move z4k         to det-1(sutun(yy + 3) :4)
                   move takas6-pax(xx)    to zpax,
                   move zpax         to det-1(sutun(yy + 4) :8)
                   compute ort2 rounded =
                     takas6-tut(xx) / takas6-oda(xx) 
                   move ort2   to z8k2,
                   
                   move z8k2          to det-1(sutun(yy + 5) :10)
                    compute ort2 rounded =
                     takas6-tut(xx) / takas6-pax(xx) 
                   move ort2     to z8k2,
                   move z8k2          to det-1(sutun(yy + 6) :10)
                   move takas6-tut(xx)    to z-goster,
                   move z-goster          to det-1(sutun(yy + 7) :14)
               
                   compute yuzde-dol = (takas6-oda(xx) * 100) / takas6-haz-oda                | firat 20/02/2020 ekleme
                   move yuzde-dol              to 3zk2z
                   move 3zk2z                  to det-1(sutun(yy + 8) :7)                     
               
               end-perform
               perform varying xx from 2 by 1 until  xx > 51 or sutun(xx) < 5,
                   move "|"       to det-1(sutun(xx) - 1:1),
               end-perform 
               move "|"       to det-1(sutun(xx - 1) - 1:1),
               inspect det-1(12:) replacing all space by high-values
               if takvim-gun-adi = 7
                  move 289  to det-1(sutun(xx - 1) :3)     
                  move "A"  to det-dokumer-20(3:1)
                  move "1"  to det-dokumer-20(10:1)
               else
                  move spaces to det-1(sutun(xx - 1 ):3)   
               end-if
               write dokumer-rec from detay
           end-read
           end-perform
           close takvim
           initialize dokumer-rec detay
           move "-"       to det-dokumer-20(5:1)
           move "|"           to det-1(482:1),                |det-1(364:1),  firat 20/02/2020 degistirme
           write dokumer-rec from detay


           initialize dokumer-rec detay
           move "Toplam:" to det-1(1:10)
           perform varying xx from 1 by 1 until xx > 7
               compute yy =  7 * (xx - 1)                                                |compute yy =  6 * (xx - 1) firat 20/02/2020 degistirme
               move alt-oda(xx)    to z4,
               move z4          to det-1(sutun(yy + 2):6)
               compute docc rounded =
                     alt-pax(xx) / alt-oda(xx)
               move docc   to z4k,
               move z4k         to det-1(sutun(yy + 3) :4)
               move alt-pax(xx)    to zpax,
               move zpax         to det-1(sutun(yy + 4) :8)
               compute ort2 rounded =
                       alt-tut(xx) / alt-oda(xx) 
               move ort2   to z8k2,
               move z8k2          to det-1(sutun(yy + 5) :10)
               compute ort2 rounded =
                       alt-tut(xx) / alt-pax(xx) 
               move ort2     to z8k2,
               move z8k2          to det-1(sutun(yy + 6) :10)
        
               move alt-tut(xx) to z-goster
               move z-goster          to det-1(sutun(yy + 7) :14)
        
               compute yuzde-dol = (alt-oda(xx) * 100) / alt-hazir-oda                | firat 20/02/2020 ekleme
               move yuzde-dol              to 3zk2z
               move 3zk2z                  to det-1(sutun(yy + 8) :7)                     
        
           end-perform
           perform varying xx from 2 by 1 until  xx > 51 or sutun(xx) < 5 ,
               move "|"       to det-1(sutun(xx) - 1:1),
           end-perform 
           move "|"       to det-1(sutun(xx - 1 ):1),
           move "A"          to det-dokumer-20(3:1)
           move 481          to det-1(sutun(xx - 1)  :3)
           
           move "1"          to det-dokumer-20(10:1)
           inspect det-1(12:) replacing all space by high-values
           write dokumer-rec from detay
           initialize dokumer-rec detay
           move "-"            to det-dokumer-20(5:1)
           move all "-"        to det-1(01:481)                 |det-1(01:364),  firat 20/02/2020 degistirme
           write dokumer-rec from detay
        
           close dokumer takas6 takas7 takasfiyat
**********************************************************************pdf conv
           if link-var > 0 
              perform pdf-olustur                  
             string             
                 dokumer-dosya(17:4) delimited by "    "
                 ".pdf" delimited by size     
             into forlink-donus-dosya-adi
           else
              call  dokumer-prog on exception
                   perform callerr-proc
              not on exception
                   cancel dokumer-prog
              end-call
           end-if
**********************************************************************pdf conv
           delete file dokumer takas6 takas7 takasfiyat
**********************************************************************pdf conv
           if link-var > 0 
              set exit-pushed to true
           end-if 
**********************************************************************pdf conv
    end-evaluate.
     .
*
 pdf-olustur.
    initialize pdf-link-tum
    move dokumer-dosya               to pdf-dokumer-adres
    call "/asya/ytl/obj/otel/dok2pdf.asy" using  pdf-link-tum 
       on exception 
          perform callerr-proc
          exit paragraph
    not on exception
    cancel "/asya/ytl/obj/otel/dok2pdf.asy"
    end-call.
*
 takas-dosya-yaz.
    initialize doviz-tablo
    perform varying xx from 1 by 1 until xx > 7
        move xx         to doviz-sira(xx)
        move spaces     to doviz-kodu2(xx)
    end-perform.

    open i-o genelfis.
    move 1 to genelfis-anahtar.
    read genelfis no lock invalid 
         move 1 to ekran-fis-1
    end-read.
   
    add 1 to ekran-fis-1.
   
    move ekran-fis-1(2:) to takas6-no takas7-no takasfiyat-no.
    rewrite genelfis-rec invalid 
            write genelfis-rec invalid continue
            end-write
    end-rewrite.
    close genelfis.

    open output takas6 close takas6
    open output takas7 close takas7
    open output takasfiyat close takasfiyat
    open i-o takas6 with mass-update.
    open i-o takas7 with mass-update.
    open i-o takasfiyat.
    open input takvim takvim2.
    initialize takvim-rec alt-hazir-oda.
    move ilk-tarih to takvim-anah kur-tarih.
     
       

        move ilk-tarih to takvim-anah
    start takvim key not < takvim-anah invalid 
          close takvim go takas-dosya-yaz-exit,
          not invalid,
          open input rez cast grup aksiyhrk gruplar grupfiy acenta formul fiyat
          aceanlas fiyatana kur konuk romhrk kodlar02 cast3 odalar konum konumek ,
          open i-o fiyatind
          move spaces to eh,
                initialize takas6-rec
                 move butce-cev-doviz      to doviz-kodu2(7),
                 
                 move tarih-tasi          to kur-tarih
                 move "87"       to kur-banka
                 if merkez = 1 then move "01" to kur-banka end-if
                 move butce-cev-doviz     to kur-doviz
                 read kur no lock invalid 
                    move "01" to   kur-banka
                    read kur no lock invalid 
                         move 1 to doviz-alis
                     end-read
                 end-read
                 move doviz-alis to doviz-kuru(7)
          
          perform with test after until evet,
              read takvim next no lock end move "E" to eh,
                   not end,
                   if takvim-anah > son-tarih,
                      move "E" to eh,
                   else,
                      if takvim-anah not > son-tarih
                         initialize takas6-rec,
                         move takvim-anah to takas6-tarih,
                
                         if rapor-ref2-kullan = 1 
                            perform hazir-bul-alt2
                         else
                            if fiyat-ref > 0 then 
                                 move takvim-ref-hazir-oda (fiyat-ref) to  takvim-hazir-oda                     
                                 move takvim-ref-hazir-yatak (fiyat-ref) to  takvim-hazir-yatak
                            end-if
                            if oda-ref > 0 then 
                               move takvim-ref-hazir-oda (oda-ref) to  takvim-hazir-oda  
                               move takvim-ref-hazir-yatak (oda-ref) to  takvim-hazir-yatak
                            end-if
                         end-if 
                         move takvim-hazir-oda to takas6-haz-oda
                         compute alt-hazir-oda = alt-hazir-oda + takvim-hazir-oda
                                                  
                         write takas6-rec invalid
                             
                               rewrite takas6-rec invalid continue
                               end-rewrite,
                         end-write,
                         perform cast-oku thru cast-oku-exit,
                         perform kaydet,
                      end-if,
                   end-if,
              end-read,
          end-perform,
    end-start.
    move ilk-tarih to takas-blok-bas-tar
    move son-tarih to takas-blok-bit-tar
    move 1 to takas-blok-fiyatli
    move 1 to takas-blok-konumlu
     if beklenen-grup    =  1
        perform grup-takas-al
        perform gruplari-takasa-ekle
     end-if

           
                          move CINPARA-MUS-KDV to depkod-kdv  
                    move 0 to oran-top   oran2-top

                    add   depkod-kdv to   oran-top
                    if   kv-gecis-tar <= takas6-tarih
                       add kv-orani to oran-top
                     end-if
                     
                     if kdv-haric = 0 
                          add  depkod-kdv to     oran2-top
                     end-if
                     if kv-haric = 0   and  (  kv-gecis-tar <= takas6-tarih )
                          add  kv-orani to     oran2-top
                     end-if

                   
                      compute carpankv = (100 + oran2-top) / (oran-top + 100 )




       if kdv-haric   = 1 or kv-haric = 1  then 
             initialize alt-toplam-dizi
            initialize takas6-rec 
             start takas6 key > takas6-tarih  invalid
              continue
                not invalid
                 perform until fs-takas6 = "10"
                    read takas6 next no lock end move "10" to fs-takas6
                       not end
                         
                          move takas6-tarih to kdv-rap-tarih 
                          perform genel2-cinkdv-ayarla

                          perform varying iid from 1 by 1 until iid > 7
                                 compute TAKAS6-TUT(iid) rounded =   TAKAS6-TUT(iid) * carpankv     
                                   add TAKAS6-TUT(iid) to  alt-tut(iid) 
                                   add TAKAS6-oda(iid) to  alt-oda(iid)    
                                     
                                   compute alt-pax(iid) = alt-pax(iid) + TAKAS6-pax(iid) + TAKAS6-chi(iid)
                           end-perform 
                          rewrite takas6-rec invalid write takas6-rec end-rewrite
                   end-read
                end-perform
            end-start
       end-if 
    close takvim takvim2 rez cast fiyatind grup aksiyhrk grupfiy kodlar02 konum konumek
      odalar formul konuk gruplar acenta romhrk fiyat  aceanlas  fiyatana kur cast3  .
 takas-dosya-yaz-exit.
    exit.
 cast-oku.
    if merkez = 1 then 
      move "01" to kur-banka
      move butce-cev-doviz  to kur-doviz
      move cast-tarih to kur-tarih
      read kur no lock invalid
         move tarih-tasi to kur-tarih
         read kur no lock invalid 
          move 1 to doviz-alis
         end-read
      end-read
      move doviz-alis to mer-cev
    end-if
    initialize cast-rec.
    move takvim-anah to cast-tarih.
    start cast key not < cast-tarih invalid continue,
        not invalid,
        move spaces to var-yok,
        perform with test after until var,
            read cast next no lock end move "V" to var-yok,
                 not end,
                 if cast-tarih > takvim-anah move "V" to var-yok,
                     else,
                     if cast-tarih not > takvim-anah,
                        initialize rez-rec,
                        move cast-rez-no to rez-no,
                        read rez no lock invalid continue,
                                     not invalid
                      if filtre-var = 1 then 
                        perform filtre
                        if filtre-gecti = 1 then 
                          perform takas-kaydet thru takas-kaydet-exit
                        end-if
                      else
                        perform takas-kaydet thru takas-kaydet-exit 
                    end-if
                        end-read,
                     end-if,
                 end-if,
            end-read,
        end-perform,
    end-start.
 cast-oku-exit.
    exit.
*
 gruplari-takasa-ekle2.
  
     if takas-blok-konumlu = 1 then 
        move takas-blok-konum to rez-oda-konumu rez-fiyat-konumu
      if onkpara-referans-var = 1 then 
         perform ref-filtre
       if  not ref-gecti then 
           exit paragraph
       end-if
      end-if
     end-if
  
    
   
    if acn-kod not = spaces and gruplar-acenta not = acn-kod, exit paragraph
    end-if
   
    
    if tumu > 1 then
          move "B" to kodlar02-tipi
          move gruplar-odeme  to kodlar02-kodu
          read kodlar02 no lock invalid 
              move spaces to kodlar02-adi
          end-read
         if ( ode-tipi = "D" or  ode-tipi = "F" or  ode-tipi = "O")   and tumu = 2 then
          exit paragraph
          end-if
          if ( ode-tipi not = "D" and ode-tipi not = "F" and ode-tipi not = "O") and tumu = 3 then
            exit paragraph
          end-if
    end-if
   

*** Grup Filtresi

    if acn-grup-kod not = spaces
      initialize grup-rec
      set grup-acenta to true
      move acn-grup-kod to grup-kodu
      move gruplar-acenta   to grup-alt
      read grup no lock
        invalid
         exit paragraph
      end-read
    end-if

      initialize xx sira-sakla.
    move "H" to eh.
    perform varying xx from 1 by 1 until xx > 6 or evet,
        if doviz-kodu2(xx) not = spaces
              if gruplar-doviz = doviz-kodu2(xx),
                 move doviz-sira(xx) to sira-sakla,
                 move "E" to eh,
              end-if,
          else
              if not evet
                 move gruplar-doviz      to doviz-kodu2(xx),
                 move doviz-sira(xx) to sira-sakla,
                 move tarih-tasi to kur-tarih
                 move gruplar-banka to kur-banka
                 move gruplar-doviz     to kur-doviz
                 read kur no lock invalid 
                     move 1 to doviz-alis
                 end-read
                 move doviz-alis to doviz-kuru(xx) butce-kurlari(butce-cev-doviz)
                 move "E" to eh,
              end-if
        end-if,
    end-perform.
    
                 move tarih-tasi to kur-tarih
                 move gruplar-banka to kur-banka
                 move gruplar-doviz     to kur-doviz
                 read kur no lock invalid 
                     move 1 to doviz-alis
                 end-read
                 move doviz-alis to doviz-kuru(xx) butce-kurlari(butce-cev-doviz)
    
    if hayir 
    move 6 to sira-sakla xx
    move "E" to eh
    end-if.
   
      compute geklenecek-oda = takas-blok-ayrilan-oda  - takas-blok-satilan-oda
     if geklenecek-oda < 0 then 
         move 0 to geklenecek-oda
     end-if
       compute geklenecek-pax = takas-blok-ayrilan-pax - takas-blok-satilan-pax
       compute geklenecek-chi = takas-blok-ayrilan-child - takas-blok-satilan-child
       if geklenecek-chi < 0 
          move 0 to geklenecek-chi
       end-if 

       if   gruplar-kalanlar-double = 1 then 
             compute geklenecek-pax = takas-blok-kalan-oda * 2
        end-if

      if geklenecek-pax < 0 then 
         move 0 to geklenecek-pax
      end-if
      
      
       initialize takas7-rec   takas6-rec
       move takas-blok-tarih to takas7-tarih takas6-tarih

       move rez-no     to takas7-rez
       
         read takas6 no lock invalid stop " " end-read





         
           

        
****************************
        move    sira-sakla to xx
        move    doviz-kodu2(xx) to takas6-kod(xx)
        move  takas-blok-kalan-tutar to takas7-tut  rez-fiyati
      
        compute takas6-tut(xx) = takas6-tut(xx) + takas-blok-kalan-tutar
        add geklenecek-oda        to takas6-oda(xx)       
        compute takas6-pax(xx) = takas6-pax(xx) + geklenecek-pax + geklenecek-chi        
        compute alt-tut(xx)   rounded = alt-tut(xx)     + takas-blok-kalan-tutar
        
        add geklenecek-oda           to alt-oda(xx)
      
        compute alt-pax(xx) = alt-pax(xx) + geklenecek-pax + geklenecek-chi
      
           if gruplar-doviz = butce-cev-doviz  then 
                           move  takas-blok-kalan-tutar to cevrilmis-deger
                  else
                           move tarih-tasi to kur-tarih
                           move "01" to kur-banka
                           move gruplar-doviz to kur-doviz
                           read kur no lock invalid
                              move 1 to doviz-alis
                           end-read
                          
                              compute cevrilmis-deger rounded = takas-blok-kalan-tutar * 
                                  doviz-alis / cevrim-kur-sayisal

              end-if


         compute takas6-tut(7) rounded = takas6-tut(7) + 
                                   cevrilmis-deger 
         compute takas6-oda(7) rounded = takas6-oda(7) + 
                                   geklenecek-oda 
         compute takas6-pax(7) rounded = takas6-pax(7) + 
                                  geklenecek-pax  + geklenecek-chi


         compute alt-tut(7)    rounded = alt-tut(7)     +
                                   cevrilmis-deger 
         compute alt-oda(7)    rounded = alt-oda(7)     +
                                   geklenecek-oda 
         compute alt-pax(7)    rounded = alt-pax(7)     +
                                  geklenecek-pax   + geklenecek-chi
        
    rewrite takas6-rec invalid write takas6-rec end-rewrite
    move "H" to eh.

 takas-kaydet.
       
       initialize kodlar02-rec.
       move "B"                to kodlar02-tipi.
       move rez-odeme-tipi    to kodlar02-kodu
       read kodlar02         no lock invalid 
       
           go takas-kaydet-exit
         
       end-read
     
         if ( ode-tipi = "D" or  ode-tipi = "F" or  ode-tipi = "O")   and tumu = 2 then
        
           go takas-kaydet-exit
          end-if
          if ( ode-tipi not = "D" and ode-tipi not = "F" and ode-tipi not = "O") and tumu = 3 then
           
             go takas-kaydet-exit
          end-if
        

    evaluate true
        when rap-tip = "N"
             if rez-durumu not = "I" 
                go takas-kaydet-exit,
             end-if,
             if rez-k-g-b  not = "K" 
                go takas-kaydet-exit,
             end-if,
        when rap-tip = "W"
             if rez-durumu not = "I" 
                go takas-kaydet-exit,
             end-if,
             if rez-k-g-b      = "K" 
                go takas-kaydet-exit,
             end-if,
        when rap-tip = "S"
             if rez-durumu not = "S" 
                go takas-kaydet-exit,
             end-if
    end-evaluate

    if acn-kod not = spaces and rez-acenta not = acn-kod,
                                 go takas-kaydet-exit.

*** Grup Filtresi

    if acn-grup-kod not = spaces
      initialize grup-rec
      set grup-acenta to true
      move acn-grup-kod to grup-kodu
      move rez-acenta   to grup-alt
      read grup no lock
        invalid
          go takas-kaydet-exit
      end-read
    end-if

*** Grup Filtresi
*   TRACE Uygulamasi Acik ise kisi sayilari cast'tan alinacak
    move 1 to eklenecek-oda
    if rezpara-trace = 1
       if rez-kisi not = cast-kisi
          move cast-kisi to rez-kisi
         
       end-if
         move cast-share to rez-share
           move cast-oda-no to rez-odano
                              move cast-fiyat-konumu to rez-fiyat-konumu
                              move cast-oda-konumu to rez-oda-konumu
       if rez-share = 1 then 
         
             move 0 to eklenecek-oda 
            else
              move 1 to eklenecek-oda
          end-if
      else 
          move 1 to eklenecek-oda
    end-if

        if onkpara-referans-var = 1 then 
           perform ref-filtre
           if  not ref-gecti then 
              go takas-kaydet-exit
           end-if
        end-if
     if (rez-odano not = spaces and hayali-haric(1:1) = 2)
          initialize odalar-rec
              move rez-odano to odalar-anah
              read odalar no lock invalid 
                 continue
              not invalid
                  if (odalar-hayali not = "H" and hayali-haric(1:1) = 2)
                     go takas-kaydet-exit 
                  end-if 
              end-read
     else
        if hayali-haric(1:1) = 2
            go takas-kaydet-exit
        end-if 
     end-if 
     if rez-odano not = spaces and 
       ( hayali-haric(1:1) = 1 or dis-haric = 1 ) then 
              move rez-odano to odalar-anah
              read odalar no lock invalid continue
              not invalid
              if ( odalar-hayali = "H" and hayali-haric(1:1) = 1 )  then
                       move 0 to eklenecek-oda
              end-if
               if ( dis-haric = 1 and odalar-dis = 1 )  then
                          go takas-kaydet-exit
              end-if 
              end-read
    end-if  

    initialize xx sira-sakla.
    move "H" to eh.
    perform varying xx from 1 by 1 until xx > 6 or evet,
        if doviz-kodu2(xx) not = spaces
              if rez-doviz = doviz-kodu2(xx),
                 move doviz-sira(xx) to sira-sakla,
                 move "E" to eh,
              end-if,
          else
              if not evet
                 move rez-doviz      to doviz-kodu2(xx),
                 move doviz-sira(xx) to sira-sakla,
                 move tarih-tasi to kur-tarih
                 move rez-banka to kur-banka
                 move rez-doviz     to kur-doviz
                 read kur no lock invalid 
                     move 1 to doviz-alis
                 end-read
                 move doviz-alis to doviz-kuru(xx) butce-kurlari(butce-cev-doviz)
                 move "E" to eh,
              end-if
        end-if,
    end-perform.
    
      if hayir 
    move 6 to sira-sakla xx
    move "E" to eh
    end-if.
       evaluate ychild(1:1)
       when 1 
           compute pax-sayisi = rez-buyuk + ( rez-kucuk / 2 )
       when 0
           compute pax-sayisi = rez-buyuk
       when 2 
           compute pax-sayisi = rez-buyuk +  rez-kucuk  + rez-free
       when 3
           compute pax-sayisi = rez-buyuk +  rez-kucuk  + rez-free + rez-bebek
       when 4
           compute pax-sayisi = rez-buyuk +  rez-kucuk 
       when other
            compute pax-sayisi = rez-buyuk + ( rez-kucuk / 2 )   
      end-evaluate
      if rez-cik-tar    = takvim-anah 
      
         initialize eklenecek-oda pax-sayisi
      
      end-if
       initialize takas7-rec
       move cast-tarih to takas7-tarih
       move rez-no     to takas7-rez
       
***************************************
             move rez-no  to takasfiyat-rez-no
             move takvim-anah to takasfiyat-tarih
*               if k-kodu-tasi = "X   " and rez-no = 96 and takvim-anah = "20110609" then stop " " end-if

*             if rez-no = 4172 then 
*               if f= 1 then stop " " end-if
*             end-if
             read takasfiyat no lock 
                invalid
               
                   perform  peryot-fiyat-bul
                   if  rez-cik-tar  = takvim-anah then 
                     initialize pax-sayisi
                  end-if
                    initialize cevrilmis-tl  cevrilmis-deger         
              perform varying jj from 1 by 1 until  jj > 399
*                if k-kodu-tasi = "X   " and (fiyatt-fiy(jj) not numeric   or fiyatt-fiy(jj) not numeric
*                             or fiyatt-fiy(jj) > 2000   or fiyatt-fiy(jj) > 2000 ) 
*                             stop " "
*                             end-if      
                if fiyatt-tar(jj) = takvim-anah
                
                  if gercek-cin-kuru = 1 then 
                      
                       compute cevrilmis-tl rounded =  fiyatt-fiy(jj) * 
                       fiyatt-kur(jj)
                   
                         if rez-doviz = butce-cev-doviz  then 
                                move  fiyatt-fiy(jj) to cevrilmis-deger
                           else
                              compute cevrilmis-deger rounded =  fiyatt-fiy(jj) * 
                                  fiyatt-kur(jj) / fiyatt-kurcev(jj)

                         end-if

                 
                    else
                       
                       compute cevrilmis-tl rounded =  fiyatt-fiy(jj) * 
                                    fiyatt-kur(jj)  
                      
                         if rez-doviz = butce-cev-doviz  then 
                             move  fiyatt-fiy(jj) to cevrilmis-deger
                           else
                              compute cevrilmis-deger rounded =  fiyatt-fiy(jj) * 
                                   fiyatt-kur(jj) / fiyatt-kurcev(jj)

                         end-if

                      
                  end-if
                     move fiyatt-fiy(jj) to  takasfiyat-fiyat

                       

                      
                end-if
              end-perform  
             
              
              not invalid 
*          if k-kodu-tasi = "X   " and (takasfiyat-fiyat not numeric   or takasfiyat-fiyat not numeric
*                             or takasfiyat-fiyat > 2000   or takasfiyat-fiyat > 2000 )
*                               stop " " 
*                               end-if
                  if  rez-cik-tar  = takvim-anah then 
                     initialize pax-sayisi
                  end-if
                  if gercek-cin-kuru = 1 then 
                      compute cevrilmis-deger rounded =  takasfiyat-fiyat * 
                       takasfiyat-kur / takasfiyat-kurcev 
                       compute cevrilmis-tl rounded =  takasfiyat-fiyat * 
                       takasfiyat-kur
                     
                         if rez-doviz = butce-cev-doviz 
                           move  takasfiyat-fiyat to cevrilmis-deger
                           else
                          compute cevrilmis-deger rounded =  takasfiyat-fiyat * 
                             takasfiyat-kur / takasfiyat-kurcev 

                         end-if

                
                    else
                       
                       compute cevrilmis-deger =  takasfiyat-fiyat *  
                       takasfiyat-kur / takasfiyat-kurcev 
                       compute cevrilmis-tl rounded =  takasfiyat-fiyat *  
                          takasfiyat-kur
                      
                         if rez-doviz = butce-cev-doviz
                           move  takasfiyat-fiyat to cevrilmis-deger
                           else
                          compute cevrilmis-deger rounded =  takasfiyat-fiyat * 
                             takasfiyat-kur / takasfiyat-kurcev 

                         end-if
                  end-if
             end-read
****************  salih koy
        if dis-kom-dus = 1 then 
              initialize acenta-rec
              move rez-acenta to acenta-kodu
              read acenta no lock invalid continue
              end-read
               if  acenta-merkez-carpan  > 0 then 
                     
                  compute cevrilmis-deger  rounded = 
                  cevrilmis-deger  * (( 1000 - acenta-merkez-carpan )/1000)

                  compute takasfiyat-fiyat rounded = 
                  takasfiyat-fiyat * (( 1000 - acenta-merkez-carpan )/1000)

               end-if
        end-if


****************************
        move    sira-sakla to xx
        move    doviz-kodu2(xx) to takas6-kod(xx)
        move  takasfiyat-fiyat to takas7-tut  rez-fiyati
      
        compute takas6-tut(xx) = takas6-tut(xx) + takasfiyat-fiyat
        add pax-sayisi to takas6-pax(xx)
        add eklenecek-oda         to takas6-oda(xx)
        compute alt-tut(xx)   rounded = alt-tut(xx)     + takas7-tut
        add pax-sayisi to alt-pax(xx)
        add eklenecek-oda          to alt-oda(xx)
      

         
         compute takas6-tut(7) rounded = takas6-tut(7) + 
                                   cevrilmis-deger 
         compute takas6-oda(7) rounded = takas6-oda(7) + 
                                   eklenecek-oda
         compute takas6-pax(7) rounded = takas6-pax(7) + 
                                   pax-sayisi

         compute alt-tut(7)    rounded = alt-tut(7)     +
                                   cevrilmis-deger 
         compute alt-oda(7)    rounded = alt-oda(7)     +
                                   eklenecek-oda 
         compute alt-pax(7)    rounded = alt-pax(7)     +
                                   pax-sayisi

        
    rewrite takas6-rec invalid write takas6-rec end-rewrite
    move "H" to eh.
 takas-kaydet-exit.
    exit.
 kaydet.
    rewrite takas6-rec invalid 
            write takas6-rec invalid continue
            end-write
    end-rewrite.
*
 takas7-doldur.
       perform peryot-fiyat-bul.
*
 acc-07-Aft-Procedure.
     open input acenta
     if acn-kod = spaces
        if acn-grup-kod = spaces
           move "Tum Acentalar"   to acenta-adi
        end-if
     else
        move acn-kod    to acenta-kodu
        read acenta no lock invalid
             move "Tanimsiz Acenta ..." to acenta-adi
             move 4 to accept-control
             move 12 to control-id
        end-read
        initialize acn-grup-kod
        move "Acenta Filtresi" to grup-adi
        display acc-08 lb-acngrupadi
     end-if
     display lb-acenadi
     close acenta
     .
*
 acc-08-Aft-Procedure.
     open input grup
     if acn-grup-kod = spaces
        if acn-kod = spaces
           move "Tum Gruplar"   to grup-adi
        end-if
     else
        initialize grup-rec
        set grup-acenta to true
        move acn-grup-kod    to grup-kodu
        read grup no lock invalid
             move "Tanimsiz Acenta Grubu..." to grup-adi
             move 4 to accept-control
             move 17 to control-id
        end-read
        initialize acn-kod
        move "Grup Filtresi" to acenta-adi
        display acc-07 lb-acenadi
     end-if
     display lb-acngrupadi
     close grup
     .
*
 gun-sayisi-bul.
      initialize g-bul-gun-sayisi
                takvim2-rec 
     move rez-gir-tar   to takvim2-anah
     start takvim2 key not < takvim2-anah
           invalid
                move 1 to g-bul-gun-sayisi
     not invalid
     initialize fs-takvim2
     perform with test after until fs-takvim2 = "10"
     read takvim2 next no lock end move "10" to fs-takvim2
     not at end
          if takvim2-anah = rez-cik-tar
             move "10" to fs-takvim2
             exit perform cycle
          end-if
          if takvim2-anah not > rez-cik-tar
             add 1 to g-bul-gun-sayisi
          else
             move "10" to fs-takvim2
          end-if
     end-read
     end-perform
     end-start.

*
 Form2-Ex-Other.
       evaluate key-status
          when 2 
            set exit-pushed to true
       end-evaluate
     .
*
 Form2-Bef-Create.
     .
*
 Form1-Ef-1-Aft-Procedure.
          open input kur doviz 
         move butce-cev-doviz to DOVIZ-KODU
         read doviz no lock invalid
            display message box  "Tanimsiz Doviz Girdiniz"
            move "Tanimsiz " to d-kisa-adi
         end-read
         move  d-kisa-adi to kur-adi

        move tarih-tasi to kur-tarih
        move "87" to kur-banka
        if merkez = 1 then 
          move "01" to kur-banka
        end-if
        move doviz-kodu to kur-doviz
           read kur no lock invalid
                move 1 to merkez
                display Form1-Cb-1
                move "01" to kur-banka
                read kur no lock invalid
                  move 1 to doviz-alis
                end-read
            end-read
           move doviz-alis to cevrim-kuru cevrim-kur-sayisal
         display kdov adov ikur
        close kur doviz
     .



*
 genel2-cinkdv-ayarla. 
     if genel2-kdv-gecerlilik-tar not = spaces and genel2-kdv-gecerlilik-tar not = zeroes
*             if kdv-rap-tarih < genel2-kdv-gecerlilik-tar or kdv-rap-tarih > 20201231  |firat 15/12/2020 düzeltme
*             if kdv-rap-tarih < genel2-kdv-gecerlilik-tar or kdv-rap-tarih >= 20210601 |firat 26/04/2021 düzeltme
*             if kdv-rap-tarih < genel2-kdv-gecerlilik-tar or kdv-rap-tarih >= 20210630
            if genel2-kdv-bit-tar = spaces or genel2-kdv-bit-tar = zeroes then
                   move 20210731 to genel2-kdv-bit-tar
            end-if
            if kdv-rap-tarih < genel2-kdv-gecerlilik-tar or kdv-rap-tarih >= genel2-kdv-bit-tar 
                  move 8 to CINPARA-MUS-KDV
             else
                  move 1 to CINPARA-MUS-KDV
             end-if
             if  kdv-rap-tarih >= 20230710
                   move 10 to CINPARA-MUS-KDV
                end-if
      end-if.
              move CINPARA-MUS-KDV to depkod-kdv  
                    move 0 to oran-top   oran2-top

                    add   depkod-kdv to   oran-top
                    if   kv-gecis-tar <= takas6-tarih
                       add kv-orani to oran-top
                     end-if
                     
                     if kdv-haric = 0 
                          add  depkod-kdv to     oran2-top
                     end-if
                     if kv-haric = 0   and  (  kv-gecis-tar <= takas6-tarih )
                          add  kv-orani to     oran2-top
                     end-if

                   
                      compute carpankv = (100 + oran2-top) / (oran-top + 100 )
                      .


 
