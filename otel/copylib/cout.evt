* cout.evt
* cout.evt is generated from D:\asya\acugt.ytl\otel\cout.Psf
* This is a generated file. DO NOT modify this file directly.


 Form1-Exception-Proc.
     PERFORM Exception-Procedure
     .

 Form1-Gd-1-Event-Proc.
     PERFORM Form1-Gd-1-Ev-Other
     .

 pen-gd-Event-Proc.
     PERFORM pen-gd-Ev-Other
     .
***   start event editor code   ***
*
 Form1-Bef-Create.
     call "c$narg" using link-var.
     perform adresleri-tasi.
     open input genel genel2
     move 1 to genel-anahtar
     read genel no lock invalid continue
          not invalid
          move calis-yil    to yil title-yil
          move calis-ay     to  ay title-ay
          move calis-gun    to gun title-gun
     end-read
     move 1 to genel2-anah 
     read genel2 no lock invalid
          continue
     end-read 
     close genel genel2.
     
     move cost-sirketi of genel to kart-dosya-adres skart-dosya-adres
                                
     perform kur-bul thru kur-bul-exit.
     open i-o romhrk exthrk konuk ozluk onkasa odalar2 yromhrk.
     open input  kodlar02 depkod.
     initialize gec-gecme f1-oda islkilit-acik-kapali.
     .
*
 kur-bul.
    open input kur
    initialize islem-kuru
    move calisma-tarihi  to kur-tarih
    move onkpara-banka   to kur-banka
    move onkpara-doviz   to kur-doviz
    read kur no lock invalid 
         close kur 
         display message box 
         "Gunluk Kur Kaydi Bulunamadi  Islem Yapilamaz.."
          new-line,
         "Onburo Calisma Tarihi..:" calis-gun   "/" calis-ay   "/" calis-yil   
          new-line,
         "Banka-Doviz Kodu.......:" onkpara-banka   "-" onkpara-doviz
         title = " [ Kurlar Tanimsiz ] "
         goback
    end-read
    move doviz-alis to islem-kuru
    if onkpara-d-e = "D" and onkpara-a-s = "A" 
       move doviz-alis    to islem-kuru
    end-if 
    if onkpara-d-e = "D" and onkpara-a-s = "S" 
       move doviz-satis   to islem-kuru
    end-if 
    if onkpara-d-e = "E" and onkpara-a-s = "A" 
       move efektif-alis  to islem-kuru
    end-if 
    if onkpara-d-e = "E" and onkpara-a-s = "S" 
       move efektif-satis to islem-kuru
    end-if 

    if islem-kuru = 0 
       close kur
       display message box 
       "Kur Tutari [0] Olamaz, Islem Yapamazsiniz.."
        new-line,
       "Onburo Calisma Tarihi..:" calis-gun   "/" calis-ay   "/" calis-yil   
        new-line,
       "Banka-Doviz Kodu.......:" onkpara-banka   "-" onkpara-doviz
       title = " [ Kurlar Tanimsiz ] "
       goback
    end-if.
    close      kur.
 kur-bul-exit.
    exit.
*
 accept-odano-Bef-Procedure.
     initialize hrkgir-rec folara-cagir cout-tutar dep-dep
                cout-fatura-eh cout-folio-eh cout-okey-eh bakiye-tipi.
     initialize hrkgir-rec folara-cagir erken-cikis.
 
     initialize hrkgir-rec secilen-oda grid-islemno
                depkod-adi of depkod.
     
     if key-status   = 1 or key-status   = 5
        move f1-oda to o-kisa
        perform oda-uzat
        move o-uzun to secilen-oda
        modify accept-odano
     end-if.

     move dep-dep    to hrkgir-depkod.
     modify button-odaara enabled = true.

     modify lb-foliono-e   title = spaces
     modify fr-foliotipi-e title = spaces
     modify lb-adi-e       title = spaces
     modify lb-soyadi-e    title = spaces
     modify lb-girtar-e    title = spaces
     modify lb-ciktar-e    title = spaces
     modify fr-pansiyon-e  title = spaces
     modify lb-pansiyon-e  title = spaces
     modify fr-odeme-e     title = spaces
     modify lb-odeme-e     title = spaces
     modify lb-topborc-e   title = spaces
     modify lb-topalacak-e title = spaces
     modify lb-bakiye-e    title = spaces
     modify accept-depkodu enabled = true
     modify accept-tltutar enabled = true
     modify button-kaydet  enabled = false
*     display form1.
     if oto-gec not = 1 then 
       perform not-goster
     end-if.

     perform grid-baslik-at thru grid-baslik-at-exit.
     perform bef-procedure.
*/-----------------------------\*  
*/---------DIL AYARLA----------\*    
*/-----------------------------\*    
     perform dil-ayarla-proc.
*/-----------------------------\*         
*                                  
 bef-procedure.
     move control-value    to sonraki-kontrol
     move control-id       to sonraki-id
*     display message box "o-k->" onceki-kontrol, new-line
*                         "S-k->" sonraki-kontrol, new-line
*                         "O-id->" onceki-id, new-line
*                         "S-Id->" sonraki-id, new-line
*                         "key-->" key-status new-line
*                         "gec-gecme-->" gec-gecme.
***>Onceki Kontrole gidebildin ama sonrakine gidemesin....
*     if gecmez
*        if sonraki-kontrol not = 2
*           if sonraki-kontrol > onceki-kontrol
*              move 4         to accept-control
*              move onceki-id to control-id
*              exit paragraph
*           end-if
*        end-if
*     end-if
     evaluate control-id
          when 1001
                modify button-odaara enabled = true
          when 1002
                modify button-depara enabled = true
          when 1004
                modify button-kaydet  enabled = false
     end-evaluate.

     initialize mesaj.
     evaluate control-id
          when 1001
              evaluate true
                  when turkce
                       move "Oda Numarasi Giriniz F1->Oda No Ara... F5->Cikmasi Beklenenler Listeler" to mesaj
                  when almanca
                       move "Oda Numarasi Giriniz F1->Oda No Ara..." to mesaj
                  when ingilizce
                       move "Oda Numarasi Giriniz F1->Oda No Ara..." to mesaj
              end-evaluate
          when 1002
              evaluate true
                  when turkce
                       move "Departman Kodu Giriniz... F1->Departman Kodu Ara..." to mesaj
                  when almanca
                       move "Departman Kodu Giriniz... F1->Departman Kodu Ara..." to mesaj
                  when ingilizce
                       move "Departman Kodu Giriniz... F1->Departman Kodu Ara..." to mesaj
              end-evaluate

          when 1004
              evaluate true
                  when turkce
                       move "Check-Out Icin Gerekli Rakami Giriniz" to mesaj
                  when ingilizce
                       move " " to mesaj
                  when almanca
                       move " " to mesaj
              end-evaluate
          when 1005
              evaluate true
                  when turkce
                       move "Fatura Istiyorsaniz Check Ediniz..... " to mesaj
                  when ingilizce
                       move "Fatura Istiyorsaniz Check Ediniz..... " to mesaj
                  when almanca
                       move "Fatura Istiyorsaniz Check Ediniz..... " to mesaj
              end-evaluate
          when 1006
              evaluate true
                  when turkce
                       move "Folio Listesi Istiyorsaniz Check Ediniz..... " to mesaj
                  when ingilizce
                       move "Fatura Istiyorsaniz Check Ediniz..... " to mesaj
                  when almanca
                       move "Fatura Istiyorsaniz Check Ediniz..... " to mesaj
              end-evaluate
          when 1009
              evaluate true
                  when turkce
                       move "Check-out Islemini Baslat " to mesaj
                  when ingilizce
                       move "Check-out Islemini Baslat " to mesaj
                  when almanca
                       move "Check-out Islemini Baslat " to mesaj
              end-evaluate
     end-evaluate.

     modify form1-st-1-handle,
            panel-index = 2 
            panel-text = mesaj.
     .
 cek-gire-gonder.
     
            if cout-tutar not = 0
**************************> cekgir.asy
              initialize dokcagir-tasi
              set dokcagir-tasi-call-cekgir3   to true
              move konuk-folio                 to dokcagir-konuk-folio
              move dep-dep                     to dokcagir-dep-kodu
              move cout-tutar                  to dokcagir-cout-tutar
              perform dokcagir-call

              move dokcagir-konuk-folio        to konuk-folio
              move dokcagir-dep-kodu           to dep-dep
              move dokcagir-cout-tutar         to cout-tutar

               initialize hrk-borc-tl hrk-alac-tl hrk-bakiye-tl
                          hrk-borc-dv hrk-alac-dv hrk-bakiye-dv
               if konuk-fol-kodu = "R" 
                  perform romhrk-bul thru romhrk-bul-exit
               else
                  perform exthrk-bul thru exthrk-bul-exit
               end-if
               initialize bakiye-tipi
               move hrk-borc-tl   to konuk-top-borc
               move hrk-alac-tl   to konuk-top-alac
               rewrite konuk-rec invalid continue
               end-rewrite
                    perform log-operation-konuk
               if hrk-borc-tl > hrk-alac-tl 
                  move "B" to bakiye-tipi
               end-if
               if hrk-alac-tl > hrk-borc-tl 
                  move "A" to bakiye-tipi
               end-if
               move konuk-top-borc     to top-borc-z
               move konuk-top-alac     to top-alac-z
              compute bakiye  = konuk-top-borc - konuk-top-alac
              move bakiye      to bakiye-z
               display lb-topborc-e
               display lb-topalacak-e
               display lb-bakiye-e

               move hrk-bakiye-tl   to cout-tutar




               display accept-tltutar
               perform grid-yukle thru grid-yukle-exit
            end-if 
            if hrk-bakiye-tl  = 0
               modify button-kaydet  enabled = true
                move 4 to accept-control
               move 1009 to control-id
            end-if

            if konuk-top-borc not = konuk-top-alac
               initialize mesaj-degiskenler
               move "[ Hatali ]" to mmesaj-title
               move " Odanin Balansi Esitlenemedi  ...." to mmesaj-1
               move " Kontrol Ediniz........!!!!!..... " to mmesaj-2
               move 1           to mmesaj-type
               move 1           to mmesaj-icon
               move 1           to mmesaj-default
               perform mmesaj-ver

               move konuk-top-borc     to top-borc-z
               move konuk-top-alac     to top-alac-z
               compute bakiye  = konuk-top-borc - konuk-top-alac
               move    bakiye    to bakiye-z
               display lb-topborc-e
               display lb-topalacak-e
               display lb-bakiye-e

               move 4 to accept-control
               move 1004 to control-id
            end-if .
            .
*
 Aft-Procedure.
      move control-value    to onceki-kontrol
      move control-id       to onceki-id
      move control-id to gidis-id.
      evaluate control-id
       when 1001
         modify button-odaara enabled = false
         if key-status = 52
            exit paragraph
         end-if 
         initialize gec-gecme
         open input odalar
         move secilen-oda to o-uzun
         perform oda-kisalt
         move o-kisa to odalar-anah
         read odalar no lock invalid 
              move 1 to gec-gecme
              close odalar
              initialize secilen-oda
              display accept-odano
              exit paragraph
              not invalid continue 
         end-read
         close odalar
              initialize folara-cagir hrkgir-folio
              move "I"    to folara-cagri-tipi
              move secilen-oda  to o-uzun
              perform oda-kisalt
              move o-kisa to folara-odano
                   call "/asya/ytl/obj/otel/folara.asy" using folara-cagir
                         on exception perform callerr-proc
                         not on exception
                   cancel "/asya/ytl/obj/otel/folara.asy" 
                   end-call
                   move folara-no-cagir    to hrkgir-folio

              move hrkgir-folio to konuk-folio
     
              read konuk no lock invalid 
                   move 1 to gec-gecme
                   exit paragraph                    
                   not invalid continue 
                   if konuk-durumu not = "I"
                      move 1 to gec-gecme
                      exit paragraph
                   end-if
              end-read
                if oto-gec not = 1 then 
                if genel-minibar-devrede = "E" and konuk-mini-ok not = 1 
*                  display message box "MINIBAR KONTROL EDILMEMIS ODA COUT ETMEKTESINIZ" title "DIKKAT" icon 2
                       continue
                  end-if
                end-if
              perform musteri-oku thru musteri-oku-exit
              move hrk-bakiye-tl   to cout-tutar
              display accept-tltutar
              if hrk-bakiye-tl  = 0
                 modify button-kaydet  enabled = true
                 modify accept-depkodu enabled = false
                 modify accept-tltutar enabled = false
                 move hrk-bakiye-tl   to cout-tutar
              end-if
              perform pen-kont
               move 44 to control-id 
               move 4 to accept-control
              if gecmez
                 exit paragraph
                 else
                 move 44 to control-id 
                 move 4 to accept-control
              end-if
*              perform grid-yukle thru grid-yukle-exit
            if oto-gec not = 1 then 
              perform not-goster
            end-if

       when 1002
         modify button-depara enabled = false
         if key-status = 52
            exit paragraph
         end-if 
         initialize gec-gecme
         perform depkod-oku thru depkod-oku-exit
         modify lb-depadi-e, title = depkod-adi of depkod
         modify button-depara enabled = false
         if gecmez
            exit paragraph
         end-if
         if hrk-bakiye-tl  = 0
            modify button-kaydet  enabled = true
            modify accept-tltutar enabled = false
            move hrk-bakiye-tl   to cout-tutar
         end-if 
         perform pen-kont
         
       when 1004
         if key-status = 52
            exit paragraph
         end-if
         perform pen-kont
         
       when 1005
         if key-status = 52
            exit paragraph
         end-if 
         initialize gec-gecme
*         inquire fatura-list-cb, value in cb-sayi
*         if cb-sayi = 1 
*            move "E" to cout-fatura-eh
*         else
*            move "H" to cout-fatura-eh
*         end-if

       when 1006
         if key-status = 52
            exit paragraph
         end-if 
         initialize gec-gecme
*         inquire folio-list-cb, value in cb-sayi
*         if cb-sayi = 1 
*            move "E" to cout-folio-eh
*         else
*            move "H" to cout-folio-eh
*         end-if
      end-evaluate.
*
 exception-procedure.
     move control-id to gidis-id
     evaluate key-status          
         when 3289
              perform kredi-karti-cagir
         when 1 
              evaluate control-id
                  when 1001 
                       modify button-odaara enabled = false
                       perform oda-ara thru oda-ara-exit
                  when 1002 
                       modify button-depara enabled = false
                       perform depkod-ara thru depkod-ara-exit
              end-evaluate
            
         when 2 
         when 156
*/************kilit kontrol*************************
              move konuk-rez-no     to xrez-no
              perform dosya-kilit-kontrol
              if link-islkilit-durum <> spaces
                 exit paragraph 
              end-if 
*/************kilit kontrol*************************

              if key-status = 2
                 inquire button-kaydet, enabled in sayi
                 if sayi = 0 
                    exit paragraph
                 end-if
              end-if
              if gecmez
                 initialize gec-gecme
                 move 4        to accept-control
                 move gidis-id to control-id
                 exit paragraph
              end-if

              if cinpara-ext-fol-ac = "E"
                   
                   initialize extra-var
                   move secilen-oda   to o-uzun
                   perform oda-kisalt
                   move o-kisa to konuk-odano | link-oda
                   perform extra-var-mi-kontrol
                   if extra-var = 1
                        display message box link-oda " 'Nolu Odaya ait ekstra bulundu..." new-line 
                                                     "Oncelikle ekstra folio bakiyesini kapatiniz..."
                                        title "Uyari"
                                        icon 1
                        move 4 to accept-control
                        exit paragraph
                   end-if 
              end-if 

              open i-o konu2 rez
              perform Sonraki-Gun-Kontrol                       |||||firat 18/03/2020 Þehitlerimize Rahmett..   
              if cek-var-cout-yok = 1                           |||||tum gunler posting yapip e-cout yapilirsa diye konuldu
                 display message box secilen-oda " 'Nolu Odada sonraki gunlere ait ekstra bulundu..." new-line 
                                     "Oncelikle bu bakiyeleri siliniz..."
                               title "Uyari"          
                                icon 1
                 move 4 to accept-control
                 close konu2
                 exit paragraph
              end-if

              if genel2-cout-late-ve-upg-kontrolu-devrede = 1 and    | firat 10/05/2021 byKuscu
                 konuk-fol-kodu = "E"
                 
                 initialize rez-rec 
                 move konuk-extra-rez-no to rez-no 
                 read rez no lock invalid
                      continue
                 end-read 

                 initialize konu2-rec 
                 move rez-folio   to konu2-folio
                 read konu2 no lock invalid 
                      continue
                 end-read

                 if konu2-late-zaman > 0000
                    perform late-kontrol
                    if late-var = 0 
                       display message box secilen-oda " 'nolu oda Late-Cout olmasina ragmen bakiye tespit edilemedi..." new-line 
                                           "Lutfen kontrol ediniz..." new-line 
                                           "Islem iptal edilmistir..."
                                     title "Late C-out Uyarisi"          
                                      icon 1
                       move 4 to accept-control
                       close konu2 rez
                       exit paragraph
                    end-if
                 end-if
                 
                 if konuk-oda-konumu <> konuk-fiyat-konumu
                    open i-o blokupg 
                    initialize blokupg-rec upg-var
                    move rez-no to blokupg-rezno 
                    start blokupg key not < blokupg-reze-gore invalid
                          continue
                    not invalid
                    perform with test after until fs-blokupg = "10" 
                    read blokupg next no lock end move "10" to fs-blokupg
                    not at end 
                    
                        if rez-no <> blokupg-rezno
                           exit perform
                        end-if
                    
                        perform upg-kontrol
                        if upg-var = 0 
                           display message box secilen-oda " 'nolu oda Upgrade olmasina ragmen bakiye tespit edilemedi..." new-line 
                                               "Lutfen kontrol ediniz..." new-line 
                                               "Islem iptal edilmistir..."
                                         title "Oda Upgrade Uyarisi"          
                                          icon 1
                           move 4 to accept-control
                           close konu2 rez blokupg
                           exit paragraph
                        end-if
                    end-read
                    end-perform 
                    end-start    
                    close blokupg
                 end-if

              end-if
              close konu2 rez

              if oto-gec = 0 then                   
                      initialize mesaj-degiskenler
                      move "CHECK-OUT ISLEMI Baslasin MI?"  to mmesaj-1
                      move " [ Check-Out Okeyle ] " to mmesaj-title
                      move 2           to mmesaj-type
                      move 1           to mmesaj-icon
                      move 1           to mmesaj-default
                      perform mmesaj-ver
              else
                      move 1 to donus-kodu
              end-if
              if donus-kodu = 2
                 move 4        to accept-control
                 move gidis-id to control-id
                 exit paragraph
              end-if
              


              perform kaydet thru kaydet-exit
  

              if konuk-fol-kodu = "R" and cinpara-extra-manuel = 1
                   perform extra-kont
                   if kart-dosya-adres not = spaces
                      move exthrk-folio   to konuk-folio
                      perform kart-kontrol
                   end-if
              end-if
               
              initialize top-borc-z top-alac-z bakiye-z
              perform grid-baslik-at thru grid-baslik-at-exit
*              if k-kodu-tasi = "X   "
*                 perform polis-bul 
*              end-if 
              if link-var = 2 or 3 and oto-gec > 0 then 
*               if konuk-fol-kodu = "R" 
*                display message box "ODA FOLIO C/Out islemi Basariyla Tamamlandi..."
*                                title "[ Uyari ]"
*                                icon 1

*                else
*                    display message box "EXTRA FOLIO C/Out islemi Basariyla Tamamlandi..."
*                                title "[ Uyari ]"
*                                icon 1
*
*               end-if
                  set exit-pushed to true 
                  call "w$keybuf" using 1,x"1B" end-call                 
              else
*                if cinpara-extra-manuel = 1
                  set exit-pushed to true   | kamelya için eklendi Ramazan
                  call "w$keybuf" using 1,x"1B" end-call | kamelya için eklendi Ramazan                
*                end-if
                move 4    to accept-control
                move 1001 to control-id
              end-if
           
         when 5
            evaluate control-id
              when  1001 
               modify button-odaara enabled = false
               perform cout-ara thru cout-ara-exit
              when other
                 if cout-tutar > 0 then
**************************> dov-boz
                    move cout-tutar                    to cout-tutar2
                    initialize dokcagir-tasi
                    set dokcagir-tasi-call-dovboz2     to true
                    move konuk-folio                   to dokcagir-konuk-folio
                    move cout-tutar2                   to dokcagir-cout-tutar2
                    perform dokcagir-call
                    move dokcagir-konuk-folio          to konuk-folio
                    move dokcagir-cout-tutar2          to cout-tutar2
                end-if
           end-evaluate
     end-evaluate.
*
 upg-kontrol.
     open input depkod2 
*     initialize konu2-rec upg-var
*     move "I"         to konu2-durumu
*     move secilen-oda to konu2-odano
*     read konu2 key is konu2-oda invalid
*          exit paragraph
*     end-read

     initialize yromhrk-rec 
     move konuk-folio to yromhrk-folio
     start yromhrk key not < yromhrk-anah invalid
           continue
     not invalid
     perform with test after until fs-yromhrk = "10" 
     read yromhrk next no lock end move "10" to fs-yromhrk 
     not at end

         if yromhrk-folio <> konuk-folio 
            exit perform 
         end-if

         initialize depkod-rec 
         move yromhrk-depkod to depkod-kodu
         read depkod no lock invalid
              exit perform cycle
         end-read 

         initialize depkod2-rec 
         move yromhrk-depkod to depkod2-kodu
         read depkod2 no lock invalid
              exit perform cycle
         end-read 

         if depkod2-upgrade = 1 
            move 1 to upg-var
            exit perform 
         end-if
         
     end-read 
     end-perform 
     end-start 
     close depkod2
     .
*
 late-kontrol.
     open input depkod2 
*     initialize konu2-rec late-var
*     move "I"         to konu2-durumu
*     move secilen-oda to konu2-odano
*     read konu2 key is konu2-oda invalid
*          exit paragraph
*     end-read

     initialize yromhrk-rec 
     move konuk-folio to yromhrk-folio
     start yromhrk key not < yromhrk-anah invalid
           continue
     not invalid
     perform with test after until fs-yromhrk = "10" 
     read yromhrk next no lock end move "10" to fs-yromhrk 
     not at end

         if yromhrk-folio <> konuk-folio 
            exit perform 
         end-if

         initialize depkod-rec 
         move yromhrk-depkod to depkod-kodu
         read depkod no lock invalid
              exit perform cycle
         end-read 

         initialize depkod2-rec 
         move yromhrk-depkod to depkod2-kodu
         read depkod2 no lock invalid
              exit perform cycle
         end-read 

         if depkod2-late-cout = 1 
            move 1 to late-var
            exit perform 
         end-if
         
     end-read 
     end-perform 
     end-start 
     close depkod2
     .
*
 sonraki-gun-kontrol.
     initialize konu2-rec cek-var-cout-yok
     move "I"         to konu2-durumu
     move secilen-oda to konu2-odano
     read konu2 key is konu2-oda invalid
          exit paragraph
     end-read

     initialize yromhrk-rec 
     move konu2-folio to yromhrk-folio
     start yromhrk key not < yromhrk-anah invalid
           continue
     not invalid
     perform with test after until fs-yromhrk = "10" 
     read yromhrk next no lock end move "10" to fs-yromhrk 
     not at end

         if yromhrk-folio <> konu2-folio 
            exit perform 
         end-if
         
         if yromhrk-tarih > tarih-tasi 
            move 1 to cek-var-cout-yok 
            exit perform
         end-if

     end-read 
     end-perform 
     end-start 
     .
*
 kaydet.
    PERFORM PEN-KONT 
    if key-status not = 156
       if gecmez 
          exit paragraph
       end-if 
    end-if
    .
      
***********>Check-Out Basliyor.....
   
 hadi-bakalim.
    perform kolbant-c-out-yap

    if genel2-acenta-puan-devrede = 1 
       perform api-calistir
    end-if

        perform konuk-cout-et thru konuk-cout-et-exit.
        inquire fatura-list-cb, value in cb-sayi
        if cb-sayi = 1 
            move "E" to cout-fatura-eh
        else
            move "H" to cout-fatura-eh
        end-if
        inquire folio-list-cb, value in cb-sayi
        if cb-sayi = 1 
           move "E" to cout-folio-eh
        else
            move "H" to cout-folio-eh
        end-if 
       if oto-gec not = 1 then 
      if cout-fatura-eh = "E" 
         perform fatura-cik  thru fatura-cik-exit
      end-if
      if cout-folio-eh  = "E" 
         perform folio-liste thru folio-liste-exit
      end-if
      end-if
      go kaydet-exit.
 konuk-cout-et.
           if erken-cikis  = "E"
              move "E" to konuk-erken-cik
              move konuk-git-tar    to eski-tarih
              move calisma-tarihi   to konuk-git-tar
           end-if.
           move "H"   to konuk-durumu.
           if key-status = 156
              move 1 to konuk-acik-hesap
           else
              move 0 to konuk-acik-hesap
              move k-kodu-tasi to  konuk-kapat-staf
              move tarih-tasi to konuk-kapat-tarih 

              accept konuk-kapat-zaman from time
           end-if
           move k-kodu-tasi to konuk-cout-staf konuk-staf
              accept konuk-git-zaman from time.

          rewrite konuk-rec invalid go konuk-cout-et-exit.
               perform log-operation-konuk.  
               if  TELPARA-dishat-ac-kapa = 1 then 
                  if konuk-fol-kodu = "R"
                    perform hat-kapat
                  end-if
                 end-if
        
          move konuk-folio   to ozluk-folio.
          read ozluk no lock invalid continue. 
           move "H"   to ozluk-durumu.
          rewrite ozluk-rec invalid continue
          end-rewrite.
                  perform log-operation-ozluk.

          if konuk-fol-kodu = "R"
             perform odalar-isle   thru odalar-isle-exit
             perform odatemiz-isle
          end-if.
*********>Early check-out ise rez cast takvim duzelt....
          if erken-cikis = "E" and konuk-fol-kodu = "R"
             
             perform rez-duzelt     thru rez-duzelt-exit
             perform cast-duzelt    thru cast-duzelt-exit
             perform takvim-duzelt  thru takvim-duzelt-exit
              if konuk-fol-kodu = "R" 
               perform hes-gonder
             end-if
              if konuk-sharenum > 0 and  erken-cikis = "E"
              move konuk-sharenum to rez-sharenum
                open input rez
                  perform share-koy-kont
                  close rez
              end-if
          end-if.
          if kart-dosya-adres not = spaces
             perform kart-kontrol
          end-if
         
*********>Extra Postingler Check-out ediliyor....
        
      open input extpost
      initialize extpost-rec
      move konuk-folio      to extpost-folio  
      start extpost key not < extpost-anah 
         invalid continue
         not  invalid 
          read extpost next no lock 
           end continue
           not end   
           if extpost-folio = konuk-folio and 
               extpost-durumu  = "I"  then
                display message box 
                "Bu Misafire kayitli Safe Satisi Var"
           end-if
          end-read
       end-start
       close extpost
        call "/asya/ytl/obj/otel/extpcout.asy" using konuk-folio
            on exception perform callerr-proc
               not on exception
               cancel "/asya/ytl/obj/otel/extpcout.asy" 
       end-call .
       if genel-depozit-oto-sil = 1 
      move "Sil" to l-dep-anah
           call "/asya/ytl/obj/otel/depozit.asy" 
                         using  konuk-folio, l-dep-anah
                      on exception 
                          perform callerr-proc
                          exit paragraph
                      not on exception 
                          cancel "/asya/ytl/obj/otel/depozit.asy"
                    end-call  
       end-if
           .
*********>
 konuk-cout-et-exit.
      exit.
*
*
 hes-gonder.
    
     if konuk-rez-no > 0 then 

         move konuk-rez-no to rez-no
          open input rez
        read rez no lock invalid 
            display message box "Rezervasyon Okunamadi"

        end-read
        close rez
          move rez-rec to xrez-rec
          initialize linkh-odahes
        move xrez-no to  linkh-rez-no     
         move 4 to linkh-nereden  
         move 1 to linkh-anl-yaz
        
*         if XREZ-FIYAT-FIX not = "E"
           move  1 to linkh-cast-yaz
*         end-if
          call "/asya/ytl/obj/otel/odahes.asy" 
                        using  xrez-rec   linkh-odahes
                        on exception 
                        perform callerr-proc
                        exit paragraph
                        not on exception 
                   cancel "/asya/ytl/obj/otel/odahes.asy"
         end-call .
*
*
 listeeski-islem.
        if oto-gec not = 1 then 
      initialize foliolst-cagir  
       if konuk-fol-kodu = "R" 
            move 1 to    foliolst-kuru-cagir
            continue
       else
      
           move 0               to  foliolst-kuru-cagir
           move konuk-BANKA     to foliolst-banka-cagir
           move konuk-doviz     to foliolst-doviz-cagir
        end-if

      move "D" to foliolst-tldv-cagir
      move konuk-folio                 to foliolst-no-cagir
*      move rapor-departman             to foliolst-depart-cagir
          
     
    
      call "/asya/ytl/obj/otel/foliolst.asy" using foliolst-cagir
            on exception perform callerr-proc
               not on exception
      cancel "/asya/ytl/obj/otel/foliolst.asy" 
      end-call
      end-if.
       .         
              
*                
 folio-liste.
 fis-dok.       
    if oto-gec not = 1 then 
      if onkpara-eski-folio-lst = 1
         perform  listeeski-islem
      else        
         continue         
      end-if
    end-if. 
 fis-dok-exit.
    exit.
 folio-liste-exit.
      exit.
 fatura-cik.
*********>Folio listesi veriliyor......
*      call "/asya/ytl/obj/otel/otofat.asy" using konuk-folio
*            on exception perform callerr-proc
*               not on exception
*               cancel "/asya/ytl/obj/otel/otofat.asy" 
*       end-call.
 fatura-cik-exit.
     exit.
 romhrk-bul.
       initialize romhrk-rec.
       move konuk-folio   to romhrk-folio.
       move spaces        to romhrk-islem.
      start romhrk key not < romhrk-anah invalid 
            go romhrk-bul-bitti.
 romhrk-bul-oku.
      read romhrk next no lock end go romhrk-bul-bitti.
      if fs-romhrk = 99 go romhrk-bul-oku.
      if romhrk-folio > konuk-folio go romhrk-bul-bitti.
      if romhrk-folio = konuk-folio 
         continue
      else 
         go romhrk-bul-oku
      end-if.
        if romhrk-ba = "B"
           compute hrk-borc-tl = hrk-borc-tl + romhrk-tl-tutar
           compute hrk-borc-dv = hrk-borc-dv + romhrk-dv-tutar
        end-if.
        if romhrk-ba = "A"
           compute hrk-alac-tl = hrk-alac-tl + romhrk-tl-tutar
           compute hrk-alac-dv = hrk-alac-dv + romhrk-dv-tutar
        end-if.
       go romhrk-bul-oku.

 romhrk-bul-bitti.
        if hrk-borc-tl > hrk-alac-tl
           compute hrk-bakiye-tl = hrk-borc-tl - hrk-alac-tl
        end-if.
        if hrk-borc-tl < hrk-alac-tl
           compute hrk-bakiye-tl = hrk-alac-tl - hrk-borc-tl
        end-if.

        if hrk-borc-dv > hrk-alac-dv
           compute hrk-bakiye-dv = hrk-borc-dv - hrk-alac-dv
        end-if.
        if hrk-borc-dv < hrk-alac-dv
           compute hrk-bakiye-dv = hrk-alac-dv - hrk-borc-dv
        end-if.
 romhrk-bul-exit.
     exit.
 exthrk-bul.
       initialize exthrk-rec.
       move konuk-folio   to exthrk-folio.
       move spaces        to exthrk-islem.
      start exthrk key not < exthrk-anah invalid 
            go exthrk-bul-bitti.
 exthrk-bul-oku.
      read exthrk next no lock end go exthrk-bul-bitti.
      if fs-exthrk = 99 go exthrk-bul-oku.
      if exthrk-folio > konuk-folio go exthrk-bul-bitti.
      if exthrk-folio = konuk-folio 
         continue
      else 
         go exthrk-bul-oku
      end-if.
        if exthrk-ba = "B"
           compute hrk-borc-tl = hrk-borc-tl + exthrk-tl-tutar
           compute hrk-borc-dv = hrk-borc-dv + exthrk-dv-tutar
        end-if.
        if exthrk-ba = "A"
           compute hrk-alac-tl = hrk-alac-tl + exthrk-tl-tutar
           compute hrk-alac-dv = hrk-alac-dv + exthrk-dv-tutar
        end-if.
       go exthrk-bul-oku.
 exthrk-bul-bitti.
        if hrk-borc-tl > hrk-alac-tl
           compute hrk-bakiye-tl = hrk-borc-tl - hrk-alac-tl
        end-if.
        if hrk-borc-tl < hrk-alac-tl
           compute hrk-bakiye-tl = hrk-alac-tl - hrk-borc-tl
        end-if.

        if hrk-borc-dv > hrk-alac-dv
           compute hrk-bakiye-dv = hrk-borc-dv - hrk-alac-dv
        end-if.
        if hrk-borc-dv < hrk-alac-dv
           compute hrk-bakiye-dv = hrk-alac-dv - hrk-borc-dv
        end-if.
 exthrk-bul-exit.
     exit.
 fisno-bul.
    open i-o genelfis.
    move 1 to genelfis-anahtar.
    read genelfis no lock invalid
         initialize genelfis-rec 
         move 1 to genelfis-anahtar.
    add 1 to cekgir-oto.
    move cekgir-oto to hrkgir-islem.
    rewrite genelfis-rec invalid 
            write genelfis-rec invalid continue
            end-write
    end-rewrite.
    close genelfis.
 fisno-bul-exit.
      exit.
 

**********************  Erken Cikis Bolumu   ************************
*
 rez-duzelt.
          open i-o rez.
          move konuk-rez-no  to rez-no.
          read rez no lock invalid go rez-duzelt-bitti.
          move calisma-tarihi   to rez-cik-tar.

          accept rez-edit-tarih from century-date  |firat amonra için konuldu 03/11/2020
          accept rez-edit-zaman from time          |                           

          rewrite rez-rec invalid continue
          end-rewrite.
                  perform log-operation-rez.
 rez-duzelt-bitti.
          close rez.
 rez-duzelt-exit.
    exit.
*
 cast-duzelt.
                   open i-o cast.
           move calisma-tarihi to cast-tarih.
           move konuk-rez-no   to cast-rez-no.
        start cast   key not < cast-anah1 invalid 
              go cast-duzelt-bitti.
 cast-duzelt-oku.
        read cast next no lock end 
             go cast-duzelt-bitti.
        if fs-cast   = 99 go cast-duzelt-oku.
********if cast-tarih  > eski-tarih go cast-duzelt-bitti.
        if cast-rez-no > konuk-rez-no 
           go cast-duzelt-bitti
        end-if.
        if cast-rez-no = konuk-rez-no 
           continue
        else 
           go cast-duzelt-oku
        end-if.
        if cast-tarih  = calisma-tarihi 
           go cast-duzelt-oku
        end-if.

        delete cast invalid 
         continue.
           perform log-operation-cast
            go cast-duzelt-oku.
 cast-duzelt-bitti.
            close cast.
 cast-duzelt-exit.
    exit.
 takvim-duzelt.
         open i-o takvim.
           move calisma-tarihi to takvim-anah.
        start takvim key not < takvim-anah invalid 
              go takvim-duzelt-bitti.
 takvim-duzelt-oku.
        read takvim next no lock end go takvim-duzelt-bitti.
        if fs-takvim = 99 go takvim-duzelt-oku.
        if takvim-anah > eski-tarih go takvim-duzelt-bitti.
        if takvim-anah = eski-tarih go takvim-duzelt-bitti.

        compute takvim-sat-oda(konuk-oda-konumu)   =
                takvim-sat-oda(konuk-oda-konumu)   - 1.
        compute takvim-sat-buyuk(konuk-oda-konumu) =
                takvim-sat-buyuk(konuk-oda-konumu) - konuk-buyuk.
        compute takvim-sat-kucuk(konuk-oda-konumu) =
                takvim-sat-kucuk(konuk-oda-konumu) - konuk-kucuk.
        compute takvim-sat-free(konuk-oda-konumu)  =
                takvim-sat-free(konuk-oda-konumu)  - konuk-free.
        compute takvim-sat-free(konuk-oda-konumu)  =
                takvim-sat-free(konuk-oda-konumu)  - konuk-bebek.
         rewrite takvim-rec invalid continue.
         go takvim-duzelt-oku.
 takvim-duzelt-bitti.
            close takvim.
 takvim-duzelt-exit.
       exit.
 odalar-isle. 
     open i-o odalar 
     move konuk-odano  to odalar-no 
     read odalar no lock 
      invalid 
        close odalar go odalar-isle-exit 
      not invalid
       if odalar-durumu not = HOUSE-BT
         
         move onkpara-cot-house to odalar-durumu house-durumu  
         move "K"               to odalar-odatemiz         |Klima Filtre Bakim Sistemi 29/07/2020 Fýrat 
         initialize house-buyuk house-kucuk house-aciklama |Liberty Fabay Istegi 15/06/2021 Fýrat
                    house-bebek house-free 
         rewrite odalar-rec invalid continue
         end-rewrite
         perform log-operation-odalar
     end-if
     end-read.
     close odalar.


 odalar-isle-exit. 
       exit. 
 kaydet-exit.
     exit.
*
 kontroller.
*
 grid-yukle.
 grid-baslik-at.
      modify Form1-Gd-1, reset-grid  = 1
                         mass-update = 1.
      initialize form1-gd-1-record
      move "Tarih "       to gd-1-col-1
      move "Dep "         to gd-1-col-2
      move "Dep.Adi "     to gd-1-col-3
      move "[TL] Tutar "  to gd-1-col-4
      move "[DV] Tutar "  to gd-1-col-5
      move "Islem No "    to gd-1-col-6
      move "Cek No "      to gd-1-col-7
      move "Zaman "       to gd-1-col-8
      move "Kart No "     to gd-1-col-9
      move "Staf "        to gd-1-col-10
      modify Form1-Gd-1, record-to-add (form1-gd-1-record) 
                         mass-update = 0.
 grid-baslik-at-exit.
      exit.
*
 grid-detay-yukle.
         open input kllnc
      if konuk-fol-kodu = "R"
         initialize romhrk-rec
         move konuk-folio     to romhrk-folio
         move calisma-tarihi  to romhrk-tarih
         start romhrk key not < romhrk-anah1 invalid
               continue
         not invalid
               move zeroes to fs-romhrk
          perform with test after until fs-romhrk = "10"
           read romhrk next no lock end move "10" to fs-romhrk
           not at end
               if romhrk-folio <> konuk-folio
                  exit perform 
               end-if
               initialize form1-gd-1-record
               move romhrk-gun         to gd-1-col-1(01:02)
               move "/"                to gd-1-col-1(03:01)
               move romhrk-ay          to gd-1-col-1(04:02)
               move "/"                to gd-1-col-1(06:01)
               move romhrk-yil         to gd-1-col-1(07:04)
               move romhrk-depkod      to gd-1-col-2 depkod-kodu
                    read depkod no lock invalid 
                         move "Tanimsiz Departman"  to depkod-adi
                    end-read
                         move depkod-adi to gd-1-col-3
               move romhrk-tl-tutar    to z-tutar
               move z-tutar            to gd-1-col-4
               move romhrk-dv-tutar    to z-tutar
               move z-tutar            to gd-1-col-5
               move romhrk-islem       to gd-1-col-6
               move romhrk-cekno       to gd-1-col-7
               move romhrk-saat        to gd-1-col-8(01:02)
               move ":"                to gd-1-col-8(03:01)
               move romhrk-dakika      to gd-1-col-8(04:02)
               move ":"                to gd-1-col-8(06:01)
               move romhrk-saniye      to gd-1-col-8(07:02)
               move romhrk-kart-no     to gd-1-col-9
               move romhrk-staf        to k-kodu
                    read kllnc no lock invalid 
                         move "Tanimsiz Kullanici"  to k-adi
                    end-read
                         move k-adi to gd-1-col-10
               modify Form1-Gd-1, record-to-add (form1-gd-1-record)
           end-read
          end-perform
         end-start
         else
         initialize exthrk-rec
         move konuk-folio     to exthrk-folio
         move calisma-tarihi  to exthrk-tarih
         start exthrk key not < exthrk-anah1 invalid
               continue
         not invalid
               move zeroes to fs-exthrk
          perform with test after until fs-exthrk = "10"
           read exthrk next no lock end move "10" to fs-exthrk
           not at end
               if exthrk-folio <> konuk-folio
                  exit perform 
               end-if
               initialize form1-gd-1-record
               move exthrk-gun         to gd-1-col-1(01:02)
               move "/"                to gd-1-col-1(03:01)
               move exthrk-ay          to gd-1-col-1(04:02)
               move "/"                to gd-1-col-1(06:01)
               move exthrk-yil         to gd-1-col-1(07:04)
               move exthrk-depkod      to gd-1-col-2 depkod-kodu
                    read depkod no lock invalid 
                         move "Tanimsiz Departman"  to depkod-adi
                    end-read
                         move depkod-adi to gd-1-col-3
               move exthrk-tl-tutar    to z-tutar
               move z-tutar            to gd-1-col-4
               move exthrk-dv-tutar    to z-tutar
               move z-tutar            to gd-1-col-5
               move exthrk-islem       to gd-1-col-6
               move exthrk-cekno       to gd-1-col-7

               move exthrk-saat        to gd-1-col-8(01:02)
               move ":"                to gd-1-col-8(03:01)
               move exthrk-dakika      to gd-1-col-8(04:02)
               move ":"                to gd-1-col-8(06:01)
               move exthrk-saniye      to gd-1-col-8(07:02)
               move exthrk-kart-no     to gd-1-col-9
               move exthrk-staf        to k-kodu
                    read kllnc no lock invalid 
                         move "Tanimsiz Kullanici"  to k-adi
                    end-read
                         move k-adi to gd-1-col-10

               modify Form1-Gd-1, record-to-add (form1-gd-1-record)
           end-read
          end-perform
         end-start
      end-if.
      modify Form1-Gd-1, mass-update = 0.
      close  kllnc.
 grid-detay-yukle-exit.
      exit.
 grid-yukle-exit.
      exit.
*
 musteri-oku.
        initialize erken-cikis.
        initialize bakiye-tipi.
        initialize gec-gecme.

        modify lb-foliono-e title = konuk-folio
        modify fr-foliotipi-e title = konuk-fol-kodu
        modify lb-adi-e     title = konuk-adi
        modify lb-soyadi-e  title = konuk-soyadi
        move konuk-gel-tar   to tmp-gel-tar
        move konuk-git-tar   to tmp-git-tar
        move konuk-gel-gun      to e-gun 
        move konuk-gel-ay       to e-ay 
        move konuk-gel-yil      to e-yil
        modify lb-girtar-e  title = etarih
        move konuk-acenta to acenta-kodu
        
        open input acenta rez
         read acenta no lock 
           invalid
           move all "*" to acenta-adi
        end-read
        
        move acenta-adi to rap-acenta
        if konuk-fol-kodu = "R" then 
        move konuk-rez-no to rez-no
        read rez no lock invalid 
           move all "*" to rez-not1 rez-not2
           display message box " Hata No : 33948"
           end-read
         end-if
     
        move rez-not1 to rap-not1
        move rez-not2 to rap-not2
        close acenta  rez
        display lb-acenta lb-not1 lb-not2

        move konuk-git-gun      to e-gun
        move konuk-git-ay       to e-ay 
        move konuk-git-yil      to e-yil
        modify lb-ciktar-e  title = etarih

        move "A"            to kodlar02-tipi
        move konuk-pan-tipi to kodlar02-kodu
        read kodlar02 no lock invalid 
             initialize kodlar02-adi 
             not invalid continue
        end-read
        modify fr-pansiyon-e  title = konuk-pan-tipi
        modify lb-pansiyon-e  title = kodlar02-adi

        move "B"            to kodlar02-tipi
        move konuk-odeme-tipi to kodlar02-kodu
        read kodlar02 no lock invalid 
             initialize kodlar02-adi 
             not invalid continue
        end-read
        modify fr-odeme-e  title = konuk-odeme-tipi
        modify lb-odeme-e  title = kodlar02-adi
        
        move konuk-top-borc     to z-tutar
        modify lb-topborc-e  title = z-tutar
        move konuk-top-alac     to z-tutar
        modify lb-topalacak-e  title = z-tutar
        initialize z-tutar
        compute z-tutar = konuk-top-borc - konuk-top-alac
        compute bakiye  = konuk-top-borc - konuk-top-alac.
        modify lb-bakiye-e  title = z-tutar

        if konuk-git-tar > calisma-tarihi
           initialize mesaj-degiskenler
           move "[ Tarih Hatali ]" to mmesaj-title
           move "Musterinin Cikis Tarihi Bugun Degil " to mmesaj-1
           move "Devam Ederseniz EARLY C-OUT YAPAR !!" to mmesaj-2
           move 2           to mmesaj-type
           move 1           to mmesaj-icon
           move 2           to mmesaj-default
           perform mmesaj-ver
          
           if donus-kodu = 2 
              move 1 to gec-gecme
              move 4        to accept-control
              move gidis-id to control-id
             
                   call "w$keybuf" using 1,x"1B" end-call
              exit paragraph
            
            

           else
             move "E" to erken-cikis
           end-if 
        end-if.
         
        initialize hrk-borc-tl hrk-alac-tl hrk-bakiye-tl
                   hrk-borc-dv hrk-alac-dv hrk-bakiye-dv.
        if konuk-fol-kodu = "R" 
           perform romhrk-bul thru romhrk-bul-exit
        else
           perform exthrk-bul thru exthrk-bul-exit
        end-if.
        initialize bakiye-tipi.
        move hrk-borc-tl   to konuk-top-borc.
        move hrk-alac-tl   to konuk-top-alac.
        rewrite konuk-rec invalid continue
        end-rewrite.
        perform log-operation-konuk
        if hrk-borc-tl > hrk-alac-tl 
           move "B" to bakiye-tipi
        end-if.
        if hrk-alac-tl > hrk-borc-tl 
           move "A" to bakiye-tipi
        end-if.

        move konuk-top-borc     to z-tutar
        modify lb-topborc-e  title = z-tutar
        move konuk-top-alac     to z-tutar
        modify lb-topalacak-e  title = z-tutar
        initialize z-tutar
        compute z-tutar = konuk-top-borc - konuk-top-alac
        compute bakiye  = konuk-top-borc - konuk-top-alac.
        modify lb-bakiye-e  title = z-tutar
         
            .
 musteri-oku-exit.
     exit.
*
 Form1-Aft-Initdata.
     if genel-acik-hesap-aktif not = 1
        modify button-kaydeta,enabled = false
     end-if 
     modify form1-fr-3 title = tarih-title.
      initialize gec-gecme
      move 0 to oto-gec
     if link-var = 2 or 3 then 
         if link-var = 3          
           if link-toplu > 0 then 
             move link-toplu to oto-gec
           end-if
        end-if
        perform accept-odano-Bef-Procedure
        move link-oda to o-kisa
        perform oda-uzat
        move o-uzun to secilen-oda
        display accept-odano
     
        perform linkli-oda-after

        if konuk-fol-kodu = "R"
               
                 initialize exthrk-rec 
                 hatali-kayit-var hatali-tutar-toplam
                 move konuk-folio       to exthrk-folio 
                 start exthrk key not < exthrk-anah1 invalid
                       continue
                 not invalid
                 initialize fs-exthrk
                 perform with test after until fs-exthrk = "10"
                 read exthrk next no lock end move "10" to fs-exthrk
                 not at end
                         if exthrk-folio <> konuk-folio
                             exit perform 
                         end-if 
                         move 1  to hatali-kayit-var
                         compute hatali-tutar-toplam = 
                         hatali-tutar-toplam + exthrk-tl-tutar
                 end-read 
                 end-perform
                 end-start
                
         else
               
                 initialize romhrk-rec 
                 hatali-kayit-var hatali-tutar-toplam
                 move konuk-folio       to romhrk-folio 
                 start romhrk key not < romhrk-anah1 invalid
                       continue
                 not invalid
                 initialize fs-romhrk
                 perform with test after until fs-romhrk = "10"
                 read romhrk next no lock end move "10" to fs-romhrk
                 not at end
                         if romhrk-folio <> konuk-folio
                             exit perform 
                         end-if 
                         move 1  to hatali-kayit-var
                         compute hatali-tutar-toplam = 
                         hatali-tutar-toplam + romhrk-tl-tutar
                 end-read 
                 end-perform
                 end-start
                 
         end-if 
         
         if hatali-kayit-var = 1
            display message box "Route Edilemeyen Hareket bulundu." new-line
                                "Lutfen folio icerisine girerek route edilemeyen hareketleri isletiniz."
                                "Islem Iptal Edildi.."
                            title "Uyari"
                            icon 1
            set exit-pushed to true
            exit paragraph            
         end-if
 
         if gecmez
            set exit-pushed to true
            exit paragraph
         end-if
           perform pen-kont
             move 44 to control-id
            move 4 to accept-control
         
            if oto-gec > 0 then 
               if oto-gec = 2 then 
                  move 156 to key-status
                  perform Exception-Procedure
               else
                  move 2 to key-status
                  perform Exception-Procedure
               end-if
          end-if
         
     end-if.
*/************kilit kontrol*************************
             move konuk-rez-no     to xrez-no
             perform dosya-kilit-kontrol
             if link-islkilit-durum <> spaces
               exit paragraph 
             end-if 
*/************kilit kontrol*************************
     
*/-----------------------------\*  
*/---------DIL AYARLA----------\*    
*/-----------------------------\* 
      if oto-gec  = 0    
       perform dil-ayarla-proc
       end-if.
*/-----------------------------\*         
 linkli-oda-after.
       modify button-odaara enabled = false
         initialize gec-gecme
      
              move link-fol-no to konuk-folio
     
              read konuk no lock invalid 
                   move 1 to gec-gecme
                   exit paragraph                    
                   not invalid continue 
                   if konuk-durumu not = "I"
                      move 1 to gec-gecme
                      exit paragraph
                   end-if
              end-read
               if oto-gec not = 1 
                  if genel-minibar-devrede = "E" and konuk-mini-ok not = 1 
***                  display message box "MINIBAR KONTROL EDILMEMIS ODA COUT ETMEKTESINIZ" title "DIKKAT" icon 2
                     continue
                  end-if
                  if KONUK-SAFE > 0 or KONUK-ANAHTAR > 0 
                     display message box "Cout Olan konuktan Anahtar almayi unutmayin --" KONUK-ANAHTAR "- adet"
                     title "Safe yada Extra Anahtar Alan Misafir " icon 2
                  end-if
              end-if
              perform musteri-oku thru musteri-oku-exit
              if gecmez
                 exit paragraph
              end-if
              
           
             

*              perform grid-yukle thru grid-yukle-exit
         .
*
 Form1-Gd-1-Ev-Other.
    initialize Form1-Gd-1-record grid-islemno
    inquire Form1-Gd-1, cursor-y in satir cursor-x in sutun
    inquire Form1-Gd-1(satir),
            record-data in form1-gd-1-record
    move gd-1-col-6    to grid-islemno
    evaluate event-type 
         when msg-begin-entry
             move event-action-fail to event-action,
    end-evaluate.
*
 mmesaj-ver.
      inspect mmesaj-1 replacing trailing spaces by low-values
      inspect mmesaj-2 replacing trailing spaces by low-values
      inspect mmesaj-3 replacing trailing spaces by low-values
      display message box mmesaj-1, new-line, mmesaj-2, new-line, mmesaj-3
              title   = mmesaj-title
              type    = mmesaj-type
              icon    = mmesaj-icon
              default = mmesaj-default
              returning donus-kodu.
*
 oda-ara.
      initialize oda-cagir.
      move "D"   to oda-db-cagir.
      call "/asya/ytl/obj/otel/odaara.asy" using oda-cagir
            on exception perform callerr-proc
               not on exception
               cancel "/asya/ytl/obj/otel/odaara.asy" 
       end-call.
       move odano-cagir     to o-kisa f1-oda
       perform oda-uzat
       move o-uzun to secilen-oda .
 oda-oku.
       open input odalar.
       initialize odalar-rec.
       move secilen-oda    to o-uzun
       perform oda-kisalt
       move o-kisa to odalar-anah
       read odalar         no lock invalid 
            move 1         to gec-gecme
            not invalid continue 
       end-read
       close odalar.
      
       if secilen-oda = spaces 
          move 0 to gec-gecme
       end-if.
 oda-oku-exit.
       exit.
 oda-ara-exit.
       exit.
*
 cout-ara.
      initialize konuk-cagir.
      move "I"   to konuk-cagri-tipi.
      call "/asya/ytl/obj/otel/coutara.asy" using konuk-cagir
            on exception perform callerr-proc
               not on exception
               cancel "/asya/ytl/obj/otel/coutara.asy" 
       end-call.
       move konuk-folio-cagir  to konuk-folio
       read konuk no lock invalid
            initialize odano-cagir secilen-oda f1-oda
            not invalid
            move konuk-odano to o-kisa odano-cagir  f1-oda
            perform oda-uzat
            move o-uzun to secilen-oda
       end-read.
 cout-oku.
       open input odalar.
       initialize odalar-rec.
       move secilen-oda    to o-uzun
       perform oda-kisalt
       move o-kisa to odalar-anah
       read odalar         no lock invalid 
            move 1         to gec-gecme
            not invalid continue 
       end-read
       close odalar.
     
       if secilen-oda = spaces 
          move 0 to gec-gecme
       end-if.
 cout-oku-exit.
       exit.
 cout-ara-exit.
       exit.
*
 depkod-ara.
      initialize depkod-cagir.
      if bakiye-tipi = "A" 
         move "B" to depkod-cagri-tipi
      end-if.
      if bakiye-tipi = "B" 
         move "A" to depkod-cagri-tipi
      end-if.
      call "/asya/ytl/obj/otel/depara.asy" using depkod-cagir
            on exception perform callerr-proc
               not on exception
               cancel "/asya/ytl/obj/otel/depara.asy" 
       end-call.
       move depkod-dep-kodu     to dep-dep.
 depkod-oku.
       initialize depkod-rec.
       move dep-dep        to depkod-kodu
       read depkod         no lock invalid 
            move 1         to gec-gecme
            not invalid continue 
       end-read
       display accept-depkodu.
       if bakiye-tipi = "B" and depkod-ba = "B"
           initialize mesaj-degiskenler
           move "[ Hatali ]" to mmesaj-title
           move " Sectiginiz Departman Kodu YANLIS." to mmesaj-1
           move " Lutfen ALACAK Departmani Seciniz " to mmesaj-2
           move 1           to mmesaj-type
           move 1           to mmesaj-icon
           move 1           to mmesaj-default
           perform mmesaj-ver
           move 1 to gec-gecme
       end-if. 
       if bakiye-tipi = "A" and depkod-ba = "A"
           initialize mesaj-degiskenler
           move "[ Hatali ]" to mmesaj-title
           move " Sectiginiz Departman Kodu YANLIS." to mmesaj-1
           move " Lutfen BORC   Departmani Seciniz " to mmesaj-2
           move 1           to mmesaj-type
           move 1           to mmesaj-icon
           move 1           to mmesaj-default
           perform mmesaj-ver
           move 1 to gec-gecme
       end-if. 
 depkod-oku-exit.
       exit.
 depkod-ara-exit.
       exit.
*
 cout-oda-ara.
      initialize konuk-cagir.
      move "I"   to konuk-cagri-tipi.
      call "/asya/ytl/obj/otel/coutara.asy" using konuk-cagir
            on exception perform callerr-proc
               not on exception
               cancel "/asya/ytl/obj/otel/coutara.asy" 
       end-call.
      initialize folara-cagir cout-folio.
      move "I"  to folara-cagri-tipi
      move konuk-folio-cagir   to konuk-folio folara-no-cagir cout-folio.
      read konuk no lock invalid 
           stop "kayit bulunamadi".
      move konuk-odano   to folara-odano.
 cout-oda-ara-exit.
      exit.
*
 Form1-Aft-Routine.             
     close kodlar02 depkod.
     close romhrk exthrk konuk onkasa odalar2 yromhrk  
     perform kilit-aft-routine.
 extra-kont.
       
        move "I" to konuk-durumu
        move konuk-odano to tmp-oda
        
        start konuk key = konuk-oda 
             invalid 
                continue
             not invalid
                 perform until  fs-konuk = "10"
                     read konuk next no lock 
                      end move "10"  to fs-konuk
                      not end
                       if konuk-odano not = tmp-oda
                           move "10"  to fs-konuk
                         else
                          if  konuk-fol-kodu  = "R" and 
                              konuk-durumu = "I"  then
                                 continue 
*                            if oto-gec not = 1 
*                             display message box konuk-odano " nolu  Odayi paylasan " new-line 
*                                 konuk-adi konuk-soyadi  new-line  new-line
*                                 "bulunmaktadir. Bu folioyu da COUT etmek istermisiniz? " new-line new-line
*                                 title "SHARE ODA"
*                                 icon 2 type 2 default 1 giving sonuc2
*                            
*                                 if sonuc2 = 1 then 
*                                      initialize dokcagir-tasi
*                                      set dokcagir-tasi-call-cout2       to true
*                                      move 2                             to dokcagir-toplu
*                                      move konuk-odano                   to dokcagir-konuk-odano
*                                      move konuk-folio                   to dokcagir-konuk-folio
*                                      perform dokcagir-call
*                                           call "w$keybuf" using 3 end-call
*                                      move dokcagir-konuk-odano          to konuk-odano
*                                      move dokcagir-konuk-folio          to konuk-folio
*
*                                  end-if
*                              end-if
                          else
                           if konuk-gel-tar = tmp-gel-tar and
                              konuk-git-tar = tmp-git-tar and 
                              konuk-fol-kodu not = "R" then
                                        perform exthrk-bul thru exthrk-bul-exit
                                         
           
                                           move hrk-borc-tl   to konuk-top-borc
                                            move hrk-alac-tl   to konuk-top-alac  

                              if konuk-top-borc = konuk-top-alac  and konuk-top-borc = 0  then
                                      move calisma-tarihi   to konuk-git-tar
                                      
                                      move "H" to konuk-durumu
                                          move 0 to konuk-acik-hesap
                                                  move k-kodu-tasi to  konuk-kapat-staf konuk-staf
                                                  move tarih-tasi to konuk-kapat-tarih 

                                                  accept konuk-kapat-zaman from time
                                      rewrite konuk-rec 
                                        invalid
                                           display message box "Extra COUT olmadi"
                                      end-rewrite
                                          perform log-operation-konuk
                                  else

*************************************> cout.asy
                                      if oto-gec not = 1 
                                              initialize dokcagir-tasi
                                              set dokcagir-tasi-call-cout2       to true
                                              move konuk-odano                   to dokcagir-konuk-odano
                                              move konuk-folio                   to dokcagir-konuk-folio
                                              move 1                             to dokcagir-toplu
                                              perform dokcagir-call
                                                   call "w$keybuf" using 3 end-call
                                              move dokcagir-konuk-odano          to konuk-odano
                                              move dokcagir-konuk-folio          to konuk-folio
                                     end-if
                               end-if
                           end-if
                        end-if
                        end-if
                      end-read
                   end-perform
          end-start
         
        .
*
  not-goster.
       if oto-gec not = 1 
      if konuk-fol-kodu = "R" 
         move 11 to link-nereden 
         move "REZ"   to  link-NOT-DOS    
         move konuk-rez-no to link-NOT-DOS-ANAH   
         else
         if konuk-extra-rez-no > 0 then
           move 12 to link-nereden 
           move "REZ"   to  link-NOT-DOS    
           move konuk-extra-rez-no to link-NOT-DOS-ANAH    
           else
           move 12 to link-nereden 
           move "KON"   to  link-NOT-DOS    
           move konuk-folio to link-NOT-DOS-ANAH    
          end-if
       end-if 
             move "K"     to  link-not-islem
                   call "/asya/ytl/obj/otel/mesajgir.asy" 
                         using link-not
                          on exception 
                          perform callerr-proc
                          exit paragraph
                        not on exception 
                          cancel "/asya/ytl/obj/otel/mesajgir.asy"
                    end-call
                    move  link-not-donus  to  toplam-not
             display not-ac
             end-if
             .
*
  hat-kapat.
          open input telkod
          initialize telayarq-dosya-adi telayar-rec telayarq-rec
*          move konuk-odano to telayarq-dosya-adi
*          move ".tay" to telayarq-dosya-adi(5:4)
          if function numval(konuk-odano) < 1000
             move konuk-odano to telayarq-dosya-adi(1:3)
             move ".tay" to telayarq-dosya-adi(4:4)
          else 
            move konuk-odano to telayarq-dosya-adi
            move ".tay" to telayarq-dosya-adi(5:4)

          end-if 


          open output telayarq  
          open i-o telayar
***          move konuk-odano to telayarq-odano  telayar-odano 
          if TELPARA-dishat-ac-kapa-dahili = 1
             initialize telkod-rec kayit-var
             start telkod key not < telkod-anah invalid 
                 continue 
             not invalid 
             perform with test after until fs-telkod = "10"
             read telkod next no lock end move "10" to fs-telkod
             not at end 
                     if tel-onb-oda = konuk-odano
                         move TEL-ODA to telayarq-odano  telayar-odano
                         move 1       to kayit-var
                     else
                        exit perform cycle 
                     end-if 
             end-read 
             end-perform
             end-start
             if kayit-var not = 1
                move konuk-odano to telayarq-odano  telayar-odano 
             end-if 
          else
                move konuk-odano to telayarq-odano  telayar-odano 
          end-if 
          if konuk-folio > 0 then 
          move konuk-folio to  telayar-folio   telayarq-folio
          end-if
           accept telayar-tarih from century-date 
          accept telayar-saat from time 
           move telayar-saat to telayarq-saat 
          move telayar-tarih to telayarq-tarih  
           move "K " to telayar-islem telayarq-islem 
            
             if  TELPARA-dishat-ac-kapa-ignore = 1 and  telayarq-odano(1:1) = "0"
             move  telayarq-odano(2:) to telayarq-odano(1:)
             move " " to   telayarq-odano(4:1) 
          end-if
           if  TELPARA-dishat-ac-kapa-ignore = 1 and  telayar-odano(1:1) = "0"
             move  telayar-odano(2:) to telayar-odano(1:)
             move " " to   telayar-odano(4:1) 
          end-if
           write telayar-rec invalid continue end-write
            write telayarq-rec  end-write
            close telayarq
          if function numval(konuk-odano) < 1000
                          move ".may" to telayarq-dosya-adi(4:4)
          else 
           move ".may" to telayarq-dosya-adi(5:4)

          end-if 
           

            open output telayarq 
            write telayarq-rec  end-write
            close telayar telkod telayarq .

*
 dokcagir-call.
     call "/asya/ytl/obj/otel/dokcagir.asy" using dokcagir-tasi
          on exception 
             perform callerr-proc
          not on exception
             cancel "/asya/ytl/obj/otel/dokcagir.asy"
     end-call.
*
 kart-kontrol.
          
    if cost-sirketi not = spaces
       open i-o kart
       move konuk-folio to kart-folio
       start kart key = kart-folio invalid continue
            not invalid
          read kart next no lock end move "10" to fs-kart
            not end
             if kart-folio = konuk-folio  and 
                kart-cot = tarih-tasi then
                        delete kart invalid
                                continue 
                        not invalid 
                                perform s-yaz
                        end-delete
             else
                move "10" to fs-kart
             end-if
          end-read
       end-start 
      close kart
    end-if
      .
*

 s-yaz.
                  open i-o skart
                  move kart-no to skart-no
                  move kart-rec(8:)   to skart-data
                  accept skart-tarih from century-date
                  accept s-saat from time
                  move s-saat(1:6) to skart-saat
               
                  move k-kodu-tasi to skart-silen-staf
                  move "C"         to skart-nereden-silindi
                  write skart-rec invalid continue end-write
                  close skart.
*
 Pen-Kont.
    
    initialize pencere-toplamlar romhrk-rec exthrk-rec
    
      read konuk no lock invalid stop " " 
      end-read
     
    move konuk-folio to romhrk-folio exthrk-folio
     if konuk-fol-kodu = "R"  then
             start romhrk key > romhrk-anah invalid
                continue
                not invalid
                perform until fs-romhrk = "10"
                read romhrk next no lock 
                   end move "10" to fs-romhrk
                   not end
                     if romhrk-folio not = konuk-folio 
                        move "10" to fs-romhrk
                        else
                        move romhrk-rec to hrkgir-rec
                        perform topla
                    end-if
                end-read
                end-perform
             end-start

          else
            start exthrk key > exthrk-anah invalid
                continue
                not invalid
                  perform until fs-exthrk = "10"
                read exthrk next no lock 
                   end move "10" to fs-exthrk
                   not end
                     if exthrk-folio not = konuk-folio 
                        move "10" to fs-exthrk
                        else
                        move exthrk-rec to hrkgir-rec
                        perform topla
                    end-if
                end-read
                end-perform
             end-start

      end-if
     perform pen-yukle
   

          perform varying i from 1 by 1 until i > 9
              if p-odeme(i) = 1 and p-pesin-var(i) = 1 then 
               move i to tek-z
                display message box   " " new-line " " new-line" " new-line" " new-line
                tek-z                 " nolu pencere C/L olmasina ragmen PESIN odeme girilmis" new-line
                                       "  " new-line
                                           "Muhasebe otomasyonunda problem cikaracaktir" new-line
                                           " " new-line
                                           "Lutfen Duzeltiniz"  
                                           " " new-line
                                           " " new-line" " new-line
                                           icon 3, title " MUHASEBE HESAP KONTROL HATASI"
                  exit perform 
              end-if
              if  p-kredi-var(i) > 1 then 
                 move i to tek-z
                display message box   " " new-line " " new-line" " new-line" " new-line tek-z  
                                            " nolu pencerede birden fazla C/L odemesi bulunmaktadir" new-line
                                                      " " new-line  " " new-line
                                           "Muhasebe otomasyonunda problem cikaracaktir" new-line
                                            " " new-line     " " new-line
                                           "Lutfen Pencerelerini ayiriniz" 
                                           " " new-line" " new-line" " new-line
                                           icon 3, title " MUHASEBE HESAP KONTROL HATASI"
                  exit perform 
              end-if
              if p-odeme(i) = 0 and p-kredi-var(i) > 0 then 
                 move i to tek-z
                display message box " " new-line tek-z   
                " nolu pencere PESIN olmasina ragmen C/L odeme girilmis" new-line
                " " new-line
                "Muhasebe otomasyonunda problem cikaracaktir" new-line
                " " new-line
                "Lutfen Duzeltiniz",
                " " new-line " " new-line" " new-line  icon 3, title " MUHASEBE HESAP KONTROL HATASI"
                  exit perform 
              end-if
          end-perform
      if      p-bakiye(1) = 0  and
              p-bakiye(2) = 0    and
              p-bakiye(3) = 0   and
              p-bakiye(4) = 0   and
              p-bakiye(5) = 0   and
              p-bakiye(6) = 0      and
              p-bakiye(7) = 0    and
              p-bakiye(8) = 0   and
              p-bakiye(9) = 0  
         
                 modify button-kaydet  enabled = true
                else
               modify button-kaydet  enabled = false
                   SET GECMEZ TO TRUE
          end-if
      .
topla.
     if hrkgir-ref = 0
          move 1 to hrkgir-ref
     end-if
     move 1 to p-var(hrkgir-ref)
    if hrkgir-ba= "B"
      add hrkgir-tl-tutar to p-bakiye(hrkgir-ref)
      else
      subtract hrkgir-tl-tutar from p-bakiye(hrkgir-ref)
    end-if
    if hrkgir-fatura-no > 0 then
      continue
      else
 
      move 1 to p-fatura(hrkgir-ref)
    end-if
       move  hrkgir-depkod to depkod-anah
       read depkod no lock invalid
         continue
         not invalid
         if depkod-ba = "A" and depkod-turu = 4 
          
            add 1 to p-kredi-var(hrkgir-ref)
         end-if
         if depkod-ba = "A" and (depkod-turu = 3 or  depkod-turu = 5 )
            move 1 to p-pesin-var(hrkgir-ref)
         end-if

       end-read
      .
*
 pen-yukle.
     
      open input folref musteri
      modify pen-gd, reset-grid  = 1
                         mass-update = 1.
      initialize pen-record
      move "Pen "         to prec1
      move "Odeme "       to prec2
      move "Cari Adi "    to prec3
      move "[TL] Tutar "  to prec4
      move "Fat "         to prec5
      
      modify pen-gd, record-to-add (pen-record) 
       move 1 to kayit-sayi   
     
      perform varying ii from 1 by 1 until ii > 10
              if p-var(ii) = 1 then
               add 1 to kayit-sayi
              
               initialize pen-record   folref-rec
                 move konuk-folio to folref-folio
                 move ii to folref-ref
                 read folref no lock invalid
                    move "B"               to kodlar02-tipi
                      move konuk-odeme-tipi  to kodlar02-kodu 
                      read kodlar02 no lock invalid
                           move "Tanimsiz"   to kodlar02-adi
                      end-read
                      move ode-tipi to fol-pes
                        if  folref-ref = 1 then
                             if fol-pes not = "A" 
                                 move 1 to folref-ode
                              else
                                move 0 to folref-ode
                             end-if
                           else
                         move 0 to folref-ode
                      end-if
                 
                 end-read



                  move ii to zz p-no(ii)
                  
               move zz to prec1
                 if folref-ode = 1 then
                   move "C/L" to prec2
                   else
                   move "SELF" to prec2 
                 end-if
                  
*                 move folref-profil-anah to m-profil      |firat m-profil bos gorunuyor.. 17/08/2020
                  move folref-profil-sirket to musteri-sirket
                  move folref-profil-no     to musteri-no
                   read musteri  no lock invalid continue
                    not invalid
                      string musteri-adi delimited by "  "
                           " " delimited by size
                           musteri-soyadi delimited by "  "
                           into prec3
                   end-read
                  
                   move function numval(folref-ode) to p-odeme(ii)
 

                 move p-bakiye(ii) to z-bakiye
                 move z-bakiye to prec4
                 if p-fatura(ii) = 1 then
                   move "FAT" to prec5
                   else
                   move "   " to prec5
                 end-if
                 modify pen-gd, record-to-add (pen-record) 
                 modify pen-gd(kayit-sayi,1) hidden-data = pen-top(ii)
             end-if
    end-perform
          modify pen-gd, 
                         mass-update = 0.
    close folref musteri.
                   
*
 pen-gd-Ev-Msg-Begin-Entry.

       move event-action-fail to event-action           
     .
*
 pen-gd-Ev-Other.
        evaluate event-type 
         when msg-begin-entry
                inquire pen-gd x in px
                     y in py
       inquire pen-gd(py,1) hidden-data in pen-top(10)
       if p-no(10) > 0 and < 10 then
         evaluate px
           when 5 
              if onkpara-yeni-fatura = 1
              if p-bakiye(10) = 0 then
                     call "/asya/ytl/obj/otel/folfaty.asy" 
                         using  konuk-folio, konuk-odano, p-no(10)
                      on exception 
                          perform callerr-proc
                          exit paragraph
                      not on exception 
                          cancel "/asya/ytl/obj/otel/folfaty.asy"
                    end-call
                     perform Pen-Kont
                 else
                 display message box "BALANSLI FATURA KESILEMEZ" title "BALANSLI FATURA"
               end-if

              else
              if p-bakiye(10) = 0 then
                     call "/asya/ytl/obj/otel/folfat1.asy" 
                         using  konuk-folio, konuk-odano, p-no(10)
                      on exception 
                          perform callerr-proc
                          exit paragraph
                      not on exception 
                          cancel "/asya/ytl/obj/otel/folfat1.asy"
                    end-call
                     perform Pen-Kont
                 else
                 display message box "BALANSLI FATURA KESILEMEZ" title "BALANSLI FATURA"
               end-if
               end-if 
           when other
            if  p-bakiye(10) not = 0 then 
            initialize dokcagir-tasi
              set dokcagir-tasi-call-cekgir3   to true
              move konuk-folio                 to dokcagir-konuk-folio
              move p-no(10) to dokcagir-pencere
              if p-odeme(10)  = 1 then                  
                 move onkpara-city-ledger   to dokcagir-dep-kodu
                  if acenta-cdep > spaces 
                     move   acenta-cdep     to   dokcagir-dep-kodu
                 end-if
                 else                        
                  move onkpara-outlet-cash  to dokcagir-dep-kodu
                   if acenta-sdep > spaces 
                     move   acenta-sdep     to   dokcagir-dep-kodu
                 end-if

              end-if
              move p-bakiye(10)                 to dokcagir-cout-tutar
              perform dokcagir-call
                   call "w$keybuf" using 3 end-call
              perform Pen-Kont
             end-if
              
         end-evaluate
       end-if
             move event-action-fail to event-action,
    end-evaluate.
     .
********************************************
 share-koy-kont.
****** kural .
****** kontrol edilecek rez kaydi cagrýlmadan okunmus ve kaydedilmis olmali
******* arez.lib acast.lib takvim2.lib sel tfd de olmali  rez acik olmali
       
       open i-o arez  acast 
       open input takvim2
       initialize ana-oda-verildi arez-rec
        move "I" to arez-durumu
        move rez-sharenum to arez-sharenum
        move high-values to ilk-share-tar 
        move low-values  to son-share-tar
        initialize sodasay
 

      
       initialize ana-oda-verildi acast-rec  share-odalar
         move high-values to ilk-share-tar 
        move low-values  to son-share-tar
        initialize sodasay
        move rez-sharenum to acast-sharenum
        move tarih-tasi to acast-tarih
            initialize fs-acast
       start acast key >= acast-anah6 
               invalid continue
          not invalid
          perform until fs-acast = "10" 
              read acast next no lock end 
                     move "10" to fs-acast
                 not end
                    if rez-sharenum not = acast-sharenum 
                        move "10" to fs-acast
                        exit perform cycle
                    end-if
                    move acast-rez-no to arez-no 
                    read arez no lock invalid 
                          display message  box "Hata Bakim icin arayiniz Castttt "
                     end-read
                            if arez-durumu  = "S" then
                              exit perform cycle
                            end-if

                             if acast-tarih > son-share-tar
                                move  acast-tarih to son-share-tar
                             end-if
                              if acast-tarih < ilk-share-tar
                                move  acast-tarih to ilk-share-tar
                             end-if

                                perform varying ish from 1 by 1 until ish > sodasay or ish > 20 
                                    if share-oda(ish) = acast-oda-no
                                      exit perform 
                                    end-if
                                end-perform
                                 if ish > sodasay then 
                                     if ish >= 20 then
                                          display message box "20 den fazla oda bagladiniz"
                                       else
                                             move acast-oda-no to share-oda(ish)
                                             move ish to  sodasay
                                     end-if
                                 end-if
              end-read
          end-perform 
       end-start
       initialize fs-takvim2 takvim2-rec
       move ilk-share-tar to takvim2-anah 
       start takvim2 key >= takvim2-anah invalid continue
         not invalid 
         perform until fs-takvim2 = "10"
             read takvim2 next no lock end move "10" to fs-takvim2 
               not end
               if takvim2-anah > son-share-tar 
                   move "10" to fs-takvim2 
                   exit perform cycle
                end-if
             end-read
                perform varying ish  from 1 by 1 until ish > sodasay or ish > 20 
                  initialize ana-oda-verildi acast-rec   fs-acast
                  move takvim2-anah to acast-tarih
                  move rez-sharenum to acast-sharenum
                  move share-oda(ish) to acast-oda-no
                  move high-values to acast-fiyati  acast-buyuk

                  start acast key < acast-anah6 invalid 
                          continue
                     not invalid
                       perform until fs-acast = "10" 
                           read acast previous no lock  
                               end
                                move "10" to fs-acast
                                if ana-oda-verildi not = 1 
                                               move 1 to  ana-oda-verildi
                                               if  acast-share not = 0
                                                    move 0 to acast-share
                                                  rewrite acast-rec invalid stop " " end-rewrite
                                                  else
                                                  display message box "Hataaaaa"
                                               end-if
                                end-if
                                not end
                                if   takvim2-anah not = acast-tarih  or
                                     rez-sharenum not = acast-sharenum  or
                                     share-oda(ish) not = acast-oda-no
                                       move "10" to fs-acast
                                        if ana-oda-verildi not = 1 
                                          read   acast next no lock 
                                          end  
                                          display message box "Share Edilmis kayitlarda kesintisiz konaklama yok" new-line 
                                                     "Dikkatinize "
                                          exit perform cycle
                                          end-read
                                              if   takvim2-anah not = acast-tarih  or
                                                     rez-sharenum not = acast-sharenum  or
                                                     share-oda(ish) not = acast-oda-no
                                                  display message box "Share Edilmis kayitlarda kesintisiz konaklama yok" new-line 
                                                     "Dikkatinize "
                                                   exit perform cycle
                                             end-if
                                              move 1 to  ana-oda-verildi
                                               if  acast-share not = 0
                                                    move 0 to acast-share
                                                  rewrite acast-rec invalid stop " " end-rewrite
                                                  else
                                                  display message box "Hataaaaa"
                                               end-if
                                         end-if
                                       exit perform cycle
                                end-if
                                move acast-rez-no to arez-no
                                move acast-rez-no to arez-no 
                                    read arez no lock invalid 
                                      display message  box "Hata Bakim icin arayiniz Castttt "
                                          end-read
                                            if arez-durumu  = "S" then
                                                  display message box "Silinmis Share gorunuyor"
                                                  exit perform cycle
                                                  
                                            end-if
                                   if arez-cik-tar <= acast-tarih
                                       if  acast-share not = 1
                                            move 1 to acast-share
                                            rewrite acast-rec invalid stop " " end-rewrite
                                       end-if
                                    else
                                        if ana-oda-verildi not = 1 
                                              move 1 to  ana-oda-verildi
                                               if  acast-share not = 0
                                                    move 0 to acast-share
                                                  rewrite acast-rec invalid stop " " end-rewrite
                                              end-if
                                        else
                                                 if  acast-share not = 1
                                                       move 1 to acast-share
                                                      rewrite acast-rec invalid stop " " end-rewrite
                                                 end-if
                                  end-if
                             end-if

                           end-read
                       end-perform
                  end-start
                end-perform 
        end-perform
      end-start
      initialize arez-rec fs-arez

        move "I" to arez-durumu
        move rez-sharenum to arez-sharenum
       start arez key >= aREZ-anah-share invalid continue
          not invalid
          perform until fs-arez = "10" 
              read arez next no lock end 
                       
                     move "10" to fs-arez
                 not end
                    if rez-sharenum not = arez-sharenum  
                     
                            move "10" to fs-arez
                        exit perform cycle
                    end-if
                    if  arez-durumu not = "I"
                       exit perform cycle
                    end-if
                    if arez-cik-tar < tarih-tasi 
                         exit perform cycle
                    end-if
                    if arez-gir-tar <= tarih-tasi
                       move   tarih-tasi to acast-tarih
                       move   arez-no   to  acast-rez-no
                       read acast no lock invalid 
                                   display message  box "Hata Bakim icin arayiniz Cast444tt "
                             not invalid 
                             if acast-share not = arez-share 
                                     move acast-share to arez-share
                                     rewrite arez-rec invalid stop " " end-rewrite
                                     if acast-share not = arez-share 
                                     move acast-share to arez-share
                                     rewrite arez-rec invalid stop " " end-rewrite
                                     if arez-folio > 0 then 
                                       move arez-folio to konu2-folio
                                       read konu2 no lock invalid continue
                                       not invalid
                                          move acast-share to konu2-share
                                          rewrite konu2-rec invalid continue end-rewrite
                                       end-read

                                     end-if
                             end-if
                             end-if
                       end-read
                        else
                        move   arez-gir-tar  to acast-tarih
                         move   arez-no        to  acast-rez-no
                       read acast no lock invalid 
                                   display message  box "Hata Bakim icin arayiniz Cast444tt "
                             not invalid 
                             if acast-share not = arez-share 
                                     move acast-share to arez-share
                                     rewrite arez-rec invalid stop " " end-rewrite
                             end-if
                       end-read
                   end-if
              end-read
          end-perform 
       end-start
       read rez no lock invalid stop " " 
       end-read
     close arez acast takvim2. 
*
 kredi-karti-cagir.
      if konuk-folio > 0
         initialize link-kkart
         move konuk-folio   to link-kkart-folio
         call "/asya/ytl/obj/otel/kkarti.asy" 
              using link-kkart
              on exception 
              perform callerr-proc
              exit paragraph
              not on exception 
         cancel "/asya/ytl/obj/otel/kkarti.asy"
         end-call
      end-if. 
             
*
 extra-var-mi-kontrol.  
        move konuk-rec           to eski-konuk-rec
        move "I" to konuk-durumu
        move konuk-odano to tmp-oda        
        start konuk key = konuk-oda 
             invalid 
                continue
             not invalid
                 perform until  fs-konuk = "10"
                     read konuk next no lock 
                      end move "10"  to fs-konuk
                      not end
                       if konuk-odano not = tmp-oda
                           move "10"  to fs-konuk
                       else
                          if  konuk-fol-kodu  = "R" and 
                              konuk-durumu = "I"  then
                                 continue 
                          else
                            if konuk-gel-tar = tmp-gel-tar and
                               konuk-git-tar = tmp-git-tar and 
                               konuk-fol-kodu not = "R" then
                                perform exthrk-bul thru exthrk-bul-exit
                                if hrk-borc-tl <> hrk-alac-tl
                                   move 1 to extra-var
                                end-if 
                            end-if
                          end-if
                       end-if
                      end-read
                   end-perform
          end-start
          move eski-konuk-rec           to konuk-rec
          if genel-oda-cout-extra-kontrol-var = 1
             move 0  to extra-var
          end-if .
*
* polis-bul.
*    if konuk-fol-kodu = "R"
*    open input polisxml onbkodlar10
*    initialize polisxml-rec
*    move konuk-rez-no   to polisxml-rezno
*    start polisxml key not < polisxml-ANAH invalid 
*           continue
*    not invalid 
*    perform until fs-polisxml = "10"
*    read polisxml next no lock end move "10" to fs-polisxml
*    not at end 
*            if polisxml-rezno <> konuk-rez-no
*                exit perform 
*            end-if 
*            move konuk-odano  to polisxml-odano
*            move 1 to cikislar
*            perform kbs-exe-baglan
*    end-read 
*    end-perform
*    end-start
*    close polisxml onbkodlar10
*    end-if.
*
 kolbant-c-out-yap.
     open i-o kolbant
     initialize kolbant-rec 
     move konuk-rez-no to kolbant-rez-no
     start kolbant key not < kolbant-anah invalid
           continue
     not invalid
     perform with test after until fs-kolbant = "10"
     read kolbant next no lock end move "10" to fs-kolbant
     not at end

         if kolbant-rez-no <> konuk-rez-no 
            exit perform 
         end-if
         
         move 4 to kolbant-durumu
         accept kolbant-deg-tar from century-date
         move k-kodu-tasi to kolbant-deg-staff
         initialize kolbant-mus-anah
         rewrite kolbant-rec end-rewrite

     end-read
     end-perform 
     end-start
     close kolbant
     .
*
 odatemiz-isle.
     open i-o odatemiz                         |Klima Filtre Bakim Sistemi 29/07/2020 Fýrat 
     initialize odatemiz-rec 
     move "K"              to odatemiz-tip
     move odalar-no        to odatemiz-oda
     accept odatemiz-tarih from century-date
     accept odatemiz-zaman from time
     read odatemiz no lock invalid
          write odatemiz-rec end-write 
     end-read 
     close odatemiz
     .
*
 api-calistir.
    open i-o genelfis

    initialize genelfis-rec
    move 1 to genelfis-anahtar 
    read genelfis no lock invalid continue not invalid 
         add 1 to ekran-fis-1
         rewrite genelfis-rec end-rewrite 
    end-read 
    close genelfis

    move ekran-fis-1  to liste-txt-no
    move k-kodu-tasi  to liste-txt-k-kodu

    open output liste-txt

    open input ulke uyruk
    initialize ulke-rec 
    move konuk-ulke to ulke-anah 
    read ulke no lock invalid
         continue
    end-read 

    initialize uyruk-rec 
    move ulke-akbs  to uyruk-anah
    read uyruk no lock invalid
         continue
    end-read 
    close ulke uyruk

    initialize liste-txt-rec
    move genel2-web-servis-kodu to liste-txt-hotelcode
    move konuk-oda-konumu       to liste-txt-konum

    move konuk-gel-gun          to liste-txt-gir-tar(1:)
    move "."                    to liste-txt-gir-tar(3:)
    move konuk-gel-ay           to liste-txt-gir-tar(4:)
    move "."                    to liste-txt-gir-tar(6:)
    move konuk-gel-yil          to liste-txt-gir-tar(7:)
                                
    move konuk-git-gun          to liste-txt-cik-tar(1:)
    move "."                    to liste-txt-cik-tar(3:)
    move konuk-git-ay           to liste-txt-cik-tar(4:)
    move "."                    to liste-txt-cik-tar(6:)
    move konuk-git-yil          to liste-txt-cik-tar(7:)
                                
    move konuk-buyuk            to liste-txt-pax
    move konuk-kucuk            to liste-txt-ch
    move konuk-voucher          to liste-txt-voucher
    move konuk-adi              to liste-txt-adi
    move konuk-soyadi           to liste-txt-soyadi
    move uyruk-web-kodu         to liste-txt-ulke
    move detaylar               to liste-txt-rec
    write liste-txt-rec with no control end-write 

    accept isl-tarih from century-date
    accept isl-saat  from time

    move isl-tarih   to islem-anahtar
    move isl-saat    to islem-anahtar(9:6)
    move k-kodu-tasi to islem-anahtar(15:)            

    initialize git-adres exe-param-gonder islem-anahtar isl-tarih isl-saat

    accept isl-tarih from century-date
    accept isl-saat  from time

    move isl-tarih      to islem-anahtar
    move isl-saat       to islem-anahtar(9:6)
    move k-kodu-tasi    to islem-anahtar(15:)            
    move all low-values to git-adres exe-param-gonder 

    inspect islem-anahtar replacing trailing spaces by low-values

    string git-adres
        "@[DISPLAY]:\acucorp\acucbl701\acugt\bin\" delimited by low-values
         islem-anahtar                                        delimited by low-values
         "checkoutbilgi.txt"                                  delimited by low-values
    into git-adres

    string exe-param-gonder
           "@[DISPLAY]:C:\acucorp\acucbl701\acugt\bin\apiz.exe " delimited by low-values
           islem-anahtar                                                     delimited by low-values
    into exe-param-gonder

    call "c$copy" using liste-txt-dosya-adres, git-adres giving donus-code

    if donus-code = 0   
       call "c$copy" using "/asya/ytl/exe/apiz.exe",
       "@[DISPLAY]:\acucorp\acucbl701\acugt\bin\apiz.exe"

       call "c$copy" using "/asya/ytl/exe/Newtonsoft.Json.dll",
       "@[DISPLAY]:\acucorp\acucbl701\acugt\bin\Newtonsoft.Json.dll"

       call "c$copy" using "/asya/ytl/exe/RestSharp.dll",
       "@[DISPLAY]:\acucorp\acucbl701\acugt\bin\RestSharp.dll"

       call "c$system" using exe-param-gonder, 384                 || gonder gitsin dayýjým
    else
      display message box "Kisi Listesi Kopyalanamadi.."
    end-if 

    close liste-txt
    delete file liste-txt
    .

 
