* gunmust.evt
* gunmust.evt is generated from D:\asya\acugt.ytl\otel\gunmust.Psf
* This is a generated file. DO NOT modify this file directly.


 Form1-Event-Proc.
     .

 Form1-Exception-Proc.
     PERFORM exception-procedure
     .

 history-combo-Event-Proc.
* 
     EVALUATE Event-Type
     WHEN Cmd-Clicked
        PERFORM history-combo-Ev-Cmd-Clicked
     END-EVALUATE
     .
***   start event editor code   ***
*
 Form1-Bef-Create.
     perform adresleri-tasi.
     open input isyeri.
     move isyeri-no-tasi to isyeri-no
     read isyeri no lock invalid
          move "Tanimsiz Sirket" to isyeri-unvan
     end-read
     close isyeri
     
     open input genel
     initialize genel-rec
     move 1  to genel-anahtar
     read genel no lock invalid 
          continue 
     end-read 
     close genel
     perform genel2-oku
     .
* 
 genel2-oku.
     move 0  to hata-var
     open input genel2
     initialize genel2-rec

     if (kv-gecis-tar <= rapor-tarih )
        compute depgec-kv-orani = kv-orani
     else
        compute depgec-kv-orani = 0
     end-if

     move 1   to genel2-anah
     read genel2 no lock invalid 
          continue 
     not invalid
         if rapor-tarih < 20200731
            move 8     to cinpara-mus-kdv
         end-if

         if rapor-tarih > 20200730 and 
            rapor-tarih < 20211001
            move 1     to cinpara-mus-kdv
         end-if  
          
         if rapor-tarih >= 20211001
            move 8      to cinpara-mus-kdv
         end-if

         if rapor-tarih >= 20230710
            move 10     to cinpara-mus-kdv
         end-if
          
         if isyeri-adres-tasi(1:7) =  "seykad2"
            move 18     to cinpara-mus-kdv
            
            if rapor-tarih >= 20230710
               move 20     to cinpara-mus-kdv
            end-if
         end-if
     end-read 
     close genel2
     .
*
 before-procedure.
     initialize mesaj.
     evaluate control-id
         when 3
              evaluate true
                  when turkce
                       move "History Musteri Listesi Icin Cek Ediniz "   to mesaj
                  when ingilizce
                       move "History Musteri Listesi Icin Cek Ediniz "   to mesaj
                  when almanca
                       move "History Musteri Listesi Icin Cek Ediniz "   to mesaj
              end-evaluate
         when 5
         when 6
         when 7
              evaluate true
                  when turkce
                       move "History Musteri Listesi icin Tarih Giriniz "   to mesaj
                  when ingilizce
                       move "History Musteri Listesi icin Tarih Giriniz "   to mesaj
                  when almanca
                       move "History Musteri Listesi icin Tarih Giriniz "   to mesaj
              end-evaluate
         when 8
              evaluate true
                  when turkce
                       move "Raporu Baslat  "   to mesaj
                  when ingilizce
                       move "Raporu Baslat  "   to mesaj
                  when almanca
                       move "Raporu Baslat  "   to mesaj
              end-evaluate
     end-evaluate

     modify form1-st-1-handle,
     panel-index = 1 
     panel-text = mesaj
     .
*
 exception-procedure.
     evaluate key-status
         when 885
              if yan-rez-goster = 1
                 modify Form1-Cb-1,enabled = false
              else
                 modify Form1-Cb-1,enabled = true
              end-if
         when 886
              if yan-goster = 1
                 modify Form1-Cb-1a,enabled = false
              else
                 modify Form1-Cb-1a,enabled = true
              end-if
         when 2
              open input genel
              move 1 to genel-anahtar
              read genel no lock invalid
                   initialize mesaj-link
                   move 03 to mesaj-no
                   perform mesaj-ver
              not invalid
                  continue
              end-read
              close genel

              perform genel2-oku
                
              if hata-var = 1
                 exit paragraph
              end-if
 
              perform tarih-kontrol

              move 1 to history-eh

              if gec-gecme = 0 
                 if history-eh = 0
                    continue
                 else
                    perform history-rapor-ver thru history-rapor-ver-exit
                 end-if
              else 
                 move 4         to accept-control
                 move gidis-id  to control-id
              end-if 
     end-evaluate
     .
*
 history-rapor-ver.
     if cinpara-tastikli-kayit-sayi not numeric or
        cinpara-tastikli-kayit-sayi = 0
        move 65 to cinpara-tastikli-kayit-sayi
     end-if

     open input odadegis yanrez
     perform takas-aktar thru takas-aktar-exit.
     close odadegis
     initialize takas-rec
     start takas key not < takas-anah invalid
           initialize mesaj-link
           move 04 to mesaj-no
           perform mesaj-ver
           close takas
           delete file takas
           exit paragraph
     end-start

     initialize sayfa satir
     
     perform sayfa-atla
     
     open i-o genelfis
     move 1 to genelfis-anahtar
     read genelfis no lock invalid
          accept print-no from time
     not invalid
         add 1 to print-no
         rewrite genelfis-rec end-rewrite
     end-read
     close genelfis
**************************
     initialize dokumer-rec dokumer-anah dokumer-ozellikler-rec
                dokumer-dosya
                ilk-sor
     set dokumer-asya-set to true
     move print-no        to dokumer-dosya-adi
     open output dokumer
     move "H" to dokumer-genel-baslik-yaz
     perform sayfa-basi-bosluk-yaz.
*/WINDOW TITLE
     initialize dokumer-rec detay

     move "W"             to det-dokumer-20(1:)
     move "Gunluk Musteri Listesi" to det-filler      
     write dokumer-rec from detay 
*/ BASLIKLAR                   
     initialize dokumer-rec detay
     move "1"             to det-dokumer-20(10:1)
     move "B"             to det-dokumer-20(1:1)
     move isyeri-unvan    to det-filler(1:28)
     move "Gunluk Musteri Listesi" to det-filler(30:)
     move "Tarih..:"      to det-filler(71:10)
     move rapor-gun       to det-filler(81:02)
     move "/"             to det-filler(83:01)
     move rapor-ay        to det-filler(84:02)
     move "/"             to det-filler(86:01)
     move rapor-yil       to det-filler(87:04)

     perform soldan-bosluk
     
     write dokumer-rec from detay

     move oda-ref      to rapor-ref

     if rapor-ref < 1 
        move fiyat-ref to rapor-ref
     end-if

     open i-o bsirunv
     initialize bsirunv-rec
     move rapor-ref  to bsirunv-sirket-kodu
     read bsirunv no lock invalid
          continue
      end-read   
      close bsirunv


     initialize dokumer-rec detay
     move "2"                to det-dokumer-20(10:1) det-filler(1:)
     move "B"                to det-dokumer-20(1:1)
     if bsirunv-satir1 not = spaces 
        move bsirunv-satir1  to det-filler(1:)
     else
        move genel-res-adres to det-filler(1:)
     end-if 

     perform soldan-bosluk    

     write dokumer-rec from detay 
    

     if bsirunv-satir2 not = spaces
        initialize dokumer-rec detay
        move "3"             to det-dokumer-20(10:1) det-filler(1:)
        move "B"             to det-dokumer-20(1:1)    
        move bsirunv-satir2  to det-filler(1:)
        perform soldan-bosluk 
        write dokumer-rec from detay 
     end-if 
   
     if bsirunv-satir3 not = spaces
        initialize dokumer-rec detay
        move "4"             to det-dokumer-20(10:1) det-filler(1:)
        move "B"             to det-dokumer-20(1:1)
        move bsirunv-satir3  to det-filler(1:)
        perform soldan-bosluk
        write dokumer-rec from detay   
     end-if

     if bsirunv-satir4 not = spaces
        initialize dokumer-rec detay
        move "5"             to det-dokumer-20(10:1) det-filler(1:)
        move "B"             to det-dokumer-20(1:1)
        move bsirunv-satir4  to det-filler(1:)
        perform soldan-bosluk
        write dokumer-rec from detay
     end-if
     

*/ DOKUMER OZELLIKLER-REC
     initialize dokumer-rec detay
     move "O" to det-dokumer-20(1:)
     move "E" to dokumer-oto-sayfa-basi
     move cinpara-tastikli-kayit-sayi  to dokumer-oto-sayfa-satir
     move "|" to dokumer-detay-kolon-ayirici
     move "RLLLRRLRLRRRRRRRRR" to dokumer-align-occ
     move dokumer-ozellikler-rec     to det-filler
     write dokumer-rec from detay
*/ BASLIKLAR  

     initialize dokumer-rec detay 
     move "1"               to det-dokumer-20(10:1)
     move "D1"              to det-dokumer-20(1:2)     
     move "Oda"             to det-01
     move "Adi"             to det-02
     move "Soyadi"          to det-03
     move "Uyrugu"          to det-13
     move "Gel.Tar."        to det-14
     move "Git.Tar."        to det-15
     move "PK"              to det-04
     move "OK"              to det-05
     move "Acenta"          to det-06
     move "Pax"             to det-07
     move "Chi"             to det-08
     move "Fr"              to det-09
     move "Beb"             to det-099
     move "Matrah"          to det-10
     move "KDV"             to det-11
     move "KV"              to det-119
     move "Tutar"           to det-12
     move "GC"              to det-16 
     move "Kon.Tar."        to det-17
     if tc-ver = 1 
        move "Kimlik No"    to detay(156:11)
        move "|"            to detay(167:1)
     end-if



     move "|" to fil-01 fil-02 fil-03 fil-04 fil-05 
                 fil-06 fil-07 fil-08 fil-09 fil-10 
                 fil-11 fil-12 fil-13 fil-14 fil-15 
                 fil-16 fil-17
                 fil-099 fil-119
              perform soldan-bosluk
     write dokumer-rec from detay

     initialize dokumer-rec detay
     move "D2"           to det-dokumer-20(1:2)
     move "-"            to det-dokumer-20(5:1)
     move all "-" to det-01 det-02 det-03 det-04 det-05 
                     det-06 det-07 det-08 det-09 det-10 
                     det-11 det-12 det-13 det-14 det-15 
                     det-16 det-17
                     det-099 det-119
    
     perform soldan-bosluk
   
     write dokumer-rec from detay 
**************************
*     initialize sayfa-kayit-sayi
*     compute sayfa-kayit-sayi = dokumer-oto-sayfa-satir + cinpara-tastikli-bas-bos  
***      display message box  sayfa-kayit-sayi
     initialize fs-takas  kayit-satir-sayisi sayfa-adet
     open i-o ulke acenta polisxml  firma odalar uyruk
     perform with test after until fs-takas = "10"
     read takas next no lock end move "10" to fs-takas
     not at end
         initialize dokumer-rec detay odalar-rec
         if cinpara-bos-odalar-ciksin not = "E" and
            takas-dolu-bos = "B"                                                       
            exit perform cycle
         end-if
         
         move takas-oda          to det-01 odalar-anah 
         read odalar no lock invalid 
              continue
         end-read
         
         if genel-uzun-oda-no-kullanilsin = 1
            if odalar-uzun-no not = spaces 
               move odalar-uzun-no to det-01
            end-if                            
         end-if
         
         move takas-adi          to det-02
         move takas-soyadi       to det-03

         if prof-uyruk = 0
            initialize ulke-rec
            move takas-ulke(1:3)     to ulke-anah1
            read ulke no lock
              invalid
                initialize ulke-adi
            end-read
            move ulke-adi           to det-13
         else
            initialize uyruk-rec
            move takas-ulke   to uyruk-anah
            read uyruk no lock invalid
                    initialize ulke-rec
                    move takas-ulke(1:3)     to ulke-anah1
                    read ulke no lock
                      invalid
                        initialize ulke-adi
                    end-read
                    move ulke-adi           to det-13                                 
            not invalid 
                move uyruk-adi1  to det-13
            end-read 
         end-if 

         move takas-gel-gun      to z-gun
         move takas-gel-ay       to z-ay
         move takas-gel-yil      to z-yil
         move z-tarih            to det-14
         move takas-git-gun      to z-gun
         move takas-git-ay       to z-ay
         move takas-git-yil      to z-yil
         move z-tarih            to det-15
         move takas-kon-gun      to z-gun
         move takas-kon-ay       to z-ay
         move takas-kon-yil      to z-yil
         move z-tarih            to det-17
         
         if takas-dolu-bos = "B"
            initialize det-14 det-15
         end-if

         move takas-pan-tipi     to det-04
         move takas-odeme-tipi   to det-05
         move takas-acenta to acenta-kodu
         read acenta no lock 
            invalid  move acenta-kodu to acenta-adi  acenta-unvani
         end-read

         if cinpara-tastikli-acenta-unvan = 1
            move acenta-unvani         to det-06 
         else
            move acenta-adi         to det-06
         end-if                       

         if acenta-tipi = 3 then 
            move takas-firma to  firma-kodu
            read firma no lock invalid  
                 move firma-kodu to acenta-adi
            end-read

            move firma-adi to det-06
         end-if

         move takas-pax          to det-07
         move takas-chi          to det-08
         move takas-free         to det-09
         move takas-bebek        to det-099
         move takas-tutar-kdvli  to etutar-tl
         move etutar-tl          to det-12
         move takas-tutar-kdvsiz to etutar-tl
         move etutar-tl          to det-10

         move takas-geceleme     to zz
         move zz                 to det-16  

         move takas-kdv-tutar    to ekdv-tutar
         move ekdv-tutar    to det-11

         move takas-kv-tutar    to ekdv-tutar
         move ekdv-tutar    to det-119


         initialize polisxml-rec 
         move takas-rez to polisxml-rezno
         move 1         to polisxml-sirano
         read polisxml no lock invalid
              continue
         end-read 

         if tc-ver = 1 
            if polisxml-tckimlikno > 0                                          |firat 17/02/2020 ekleme
               move polisxml-tckimlikno  to kimlik-seri
            else
               move polisxml-kseri(1:11) to kimlik-seri
            end-if
            move kimlik-seri    to detay(156:11)
            move "|"            to detay(167:1)
         end-if


         move "|" to fil-01 fil-02 fil-03 fil-04 fil-05 fil-06
                     fil-07 fil-08 fil-09 fil-099 fil-10 fil-11 fil-12  fil-119
                     fil-13 fil-14 fil-15 fil-16 fil-17
         perform soldan-bosluk2
         
         

         if yan-rez-goster = 1
            perform yan-rez-detay
         end-if
          
         if yan-goster = 1 then
            if takas-rez not = 0   
               initialize polisxml-rec
               move takas-rez to polisxml-rezno
               move 1 to polisxml-sirano
               start polisxml key > polisxml-anah invalid 
                     continue
               not invalid
               perform until fs-polisxml = "10"
               read polisxml next no lock 
                 end move "10" to fs-polisxml
                 not end 
                   if polisxml-rezno not = takas-rez
                    move "10" to  fs-polisxml
                    else
                      initialize dokumer-rec detay
                      move polisxml-adi to det-02
                      move polisxml-soyadi to det-03
                     

                        if prof-uyruk = 0
                           initialize ulke-rec
                           move takas-ulke(1:3)     to ulke-anah1
                           read ulke no lock
                             invalid
                               initialize ulke-adi
                           end-read
                           move ulke-adi           to det-13
                        else
                           initialize uyruk-rec
                           move polisxml-uyruk   to uyruk-anah
                           read uyruk no lock invalid
                                   initialize ulke-rec
                                   move takas-ulke(1:3)     to ulke-anah1
                                   read ulke no lock
                                     invalid
                                       initialize ulke-adi
                                   end-read
                                   move ulke-adi           to det-13                                 
                           not invalid 
                               move uyruk-adi1  to det-13
                           end-read 
                        end-if 
                        if tc-ver = 1 
                           if polisxml-tckimlikno > 0                                          |firat 17/02/2020 ekleme
                              move polisxml-tckimlikno  to kimlik-seri
                           else
                              move polisxml-kseri(1:11) to kimlik-seri
                           end-if
                           move kimlik-seri    to detay(156:11)
                           move "|"            to detay(167:1)
                        end-if


                        move "|" to fil-01 fil-02 fil-03 fil-04 fil-05 fil-06
                            fil-07 fil-08 fil-09 fil-099 fil-10 fil-11 fil-12  fil-119
                            fil-13 fil-14 fil-15 fil-16  fil-17
                     
                                   perform soldan-bosluk2
   
                     
                   end-if
               end-read
            end-perform 
            end-start
           end-if 
         end-if


         
           end-read
     end-perform
     close ulke acenta  polisxml yanrez firma  odalar uyruk
                initialize dokumer-rec detay
                move "-"            to det-dokumer-20(5:1)
                move all "-" to det-01 det-02 det-03 det-04 det-05 det-06
                                det-07 det-08 det-09 det-099 det-10 det-11 det-12 det-119 
                                det-13 det-14 det-15 det-16  det-17
                                              perform soldan-bosluk2
   
                               

                initialize dokumer-rec detay
                move top-oda           to eoda-toplam
                move eoda-toplam       to det-01
                move " Toplam "        to det-02
                move "  "              to det-03
                move " "               to det-04
                move " "               to det-05
                move " "               to det-06
                move top-buyuk         to det-07
                move top-kucuk         to det-08
                move top-free          to det-09
                move top-bebek         to det-099
                move " "               to det-11
                move " "               to det-119
                
                move gen-toplam-kdvsiz to etutar-tl
                move etutar-tl         to det-10

*                move gen-toplam-kdv    to ekdv-tutar
*                move ekdv-tutar        to det-11
*
*                move gen-toplam-kv     to ekdv-tutar
*                move ekdv-tutar        to det-119
*
                move gen-toplam-kdvli  to etutar-tl
                move etutar-tl         to det-12

                move "A"          to det-dokumer-20(3:1)
                if tc-ver = 1 
                   move 481       to detay(168:)                                |firat 17/02/2020 degistirme
                else
                   move 481       to det-renk1
                end-if
                move "1"          to det-dokumer-20(10:1)
                move "|" to fil-01 fil-02 fil-03 fil-04 fil-05 fil-06
                            fil-07 fil-08 fil-09 fil-099 fil-10 fil-11 fil-12 fil-119
                            fil-13 fil-14 fil-15 fil-16   fil-17


                               perform soldan-bosluk2
   
              
             open input odalar
            initialize duzeltmeler   oda-buffer


            initialize takas-rec
            start takas key > takas-anah
              invalid
                continue
              not invalid
                perform until fs-takas= "10"
                   read takas next no lock 
                      end 
                        move "10" to fs-takas
                      not end
                        move takas-oda to odalar-anah
                        read odalar no lock invalid
                          move "H" to odalar-hayali
                       
                        end-read
                        if takas-git-tar = rapor-tarih then 
                           compute duzeltme-oda   = duzeltme-oda   + 1
                           compute duzeltme-buyuk = duzeltme-buyuk + takas-pax
                           compute duzeltme-kucuk = duzeltme-kucuk + takas-chi
                           compute duzeltme-free  = duzeltme-free  + takas-free
                           compute duzeltme-bebek = duzeltme-bebek + takas-bebek
                           exit perform cycle
                        end-if
                        if takas-oda   = oda-buffer or odalar-hayali = "H"  or odalar-hayal2 = 1 
                        
                           compute birlesme-oda   = birlesme-oda   + 1
                        end-if
                        move takas-oda to oda-buffer
                   end-read  
                end-perform 
             END-START
     
               close odalar

              if duzeltme-oda > 0 or birlesme-oda > 0 then
              
                initialize dokumer-rec detay
                move duzeltme-oda           to eoda-toplam
                move eoda-toplam            to det-01
                move " Cikis Gunu  "    to det-02
                move " Fiyat Basilan  "    to det-03
                move " "               to det-04
                move " "               to det-05
                move " "               to det-06
                move duzeltme-buyuk         to det-07
                move duzeltme-kucuk         to det-08
                move duzeltme-free          to det-09
                move duzeltme-bebek         to det-099
                initialize det-10 det-11  det-12   det-119
                move "A"          to det-dokumer-20(3:1)
                if tc-ver = 1 
                   move 481       to detay(168:)                                |firat 17/02/2020 degistirme
                else
                   move 481       to det-renk1
                end-if
                move "1"          to det-dokumer-20(10:1)
                move "|" to fil-01 fil-02 fil-03 fil-04 fil-05 fil-06
                            fil-07 fil-08 fil-09 fil-099 fil-10 fil-11 fil-12   fil-119
                            fil-13 fil-14 fil-15 fil-16  fil-17
                                          perform soldan-bosluk2
   
               

                compute  duzeltme-oda  =  top-oda - ( duzeltme-oda )
                compute  duzeltme-buyuk  =  top-buyuk - duzeltme-buyuk   
                compute  duzeltme-kucuk  =  top-kucuk - duzeltme-kucuk    
                compute  duzeltme-free  =  top-free - duzeltme-free    
                compute  duzeltme-bebek =  top-bebek - duzeltme-bebek    

                    initialize dokumer-rec detay
                move "-"            to det-dokumer-20(5:1)
                move all "-" to det-01 det-02 det-03 det-04 det-05 det-06
                                det-07 det-08 det-09 det-099 det-10 det-11 det-12 det-119
                                det-13 det-14 det-15 det-16 det-17
                                              perform soldan-bosluk2
   
               
                initialize dokumer-rec detay
                move duzeltme-oda           to eoda-toplam
                move eoda-toplam       to det-01
                move " Toplam Konaklama "        to det-02
                move "  "              to det-03
                move " "               to det-04
                move " "               to det-05
                move " "               to det-06
                move duzeltme-buyuk         to det-07
                move duzeltme-kucuk         to det-08
                move duzeltme-free          to det-09
                move duzeltme-bebek         to det-099
                initialize det-10 det-11  det-12   det-119
                move "A"          to det-dokumer-20(3:1)
                if tc-ver = 1 
                   move 481       to detay(168:)                                |firat 17/02/2020 degistirme
                else
                   move 481       to det-renk1
                end-if
                move "1"          to det-dokumer-20(10:1)
                move "|" to fil-01 fil-02 fil-03 fil-04 fil-05 fil-06
                            fil-07 fil-08 fil-09 fil-099 fil-10 fil-11 fil-12  fil-119
                            fil-13 fil-14 fil-15 fil-16 fil-17
                              perform soldan-bosluk2
   
               
                initialize dokumer-rec detay
                move "-"            to det-dokumer-20(5:1)
                move all "-" to det-01 det-02 det-03 det-04 det-05 det-06
                                det-07 det-08 det-09 det-099 det-10 det-11 det-12   det-119
                                det-13 det-14 det-15 det-16 det-17
                             perform soldan-bosluk2
   
               
                initialize dokumer-rec detay
                move birlesme-oda           to eoda-toplam
                move eoda-toplam            to det-01
                move " Birlestirilen  "    to det-02
                move " Oda  "    to det-03
                move " "               to det-04
                move " "               to det-05
                move " "               to det-06
                
                initialize det-10 det-11  det-12   det-119
                move "A"          to det-dokumer-20(3:1)
                if tc-ver = 1 
                   move 481       to detay(168:)                                |firat 17/02/2020 degistirme
                else
                   move 481       to det-renk1
                end-if
                move "1"          to det-dokumer-20(10:1)
                move "|" to fil-01 fil-02 fil-03 fil-04 fil-05 fil-06
                            fil-07 fil-08 fil-09 fil-099 fil-10 fil-11 fil-12   fil-119
                            fil-13 fil-14 fil-15 fil-16 fil-17
                               perform soldan-bosluk2
   
               
                 compute  duzeltme-oda  =  duzeltme-oda - birlesme-oda 
                 initialize dokumer-rec detay
                 move "-"            to det-dokumer-20(5:1)
                 move all "-" to det-01 det-02 det-03 det-04 det-05 det-06
                                det-07 det-08 det-09 det-099 det-10 det-11 det-12    det-119
                                det-13 det-14 det-15 det-16  det-17
                               perform soldan-bosluk2
   
               
                initialize dokumer-rec detay
                move duzeltme-oda           to eoda-toplam
                move eoda-toplam       to det-01
                move " Dolu Oda "        to det-02
                move "  "              to det-03
                move " "               to det-04
                move " "               to det-05
                move " "               to det-06
                
                initialize det-10 det-11  det-12   det-119
                move "A"          to det-dokumer-20(3:1)
                if tc-ver = 1 
                   move 481       to detay(168:)                                |firat 17/02/2020 degistirme
                else
                   move 481       to det-renk1
                end-if
                move "1"          to det-dokumer-20(10:1)
                move "|" to fil-01 fil-02 fil-03 fil-04 fil-05 fil-06
                            fil-07 fil-08 fil-09 fil-099 fil-10 fil-11 fil-12   fil-119
                            fil-13 fil-14 fil-15 fil-16 fil-17
                               perform soldan-bosluk2
   
           end-if
           
                 initialize dokumer-rec detay
                move "-"            to det-dokumer-20(5:1)
                move all "-" to det-01 det-02 det-03 det-04 det-05 det-06
                                det-07 det-08 det-09 det-099 det-10 det-11 det-12  det-119
                                det-13 det-14 det-15 det-16 det-17
                               perform soldan-bosluk2
   
                

     close dokumer takas  
     call dokumer-prog on exception
          perform callerr-proc
     not on exception
          cancel dokumer-prog
     end-call
     delete file dokumer takas.
****              display message box sayfa-adet.

*              set exit-pushed  to true.
 history-rapor-ver-exit.
      exit.

*
 Form1-Aft-Initdata.
     open input genel
     move 1 to genel-anahtar
     read genel no lock invalid
          initialize mesaj-link
          move 03 to mesaj-no
          perform mesaj-ver
     not invalid
         continue
     end-read
     close genel
     PERFORM GENEL2-OKU
 
*     initialize history-eh.
*     inquire history-combo, value in history-eh    
*     move 1 to history-eh

*        modify ef-rapor-gun, enabled = history-eh
*        modify ef-rapor-ay , enabled = history-eh
*        modify ef-rapor-yil, enabled = history-eh
     move calisma-tarihi    to rapor-tarih bas-tar bit-tar
     display form1.
*/-----------------------------\*  
*/---------DIL AYARLA----------\*    
*/-----------------------------\*    
     perform dil-ayarla-proc.
*/-----------------------------\*         
 history-combo-Ev-Cmd-Clicked.
*     inquire history-combo, value in history-eh    
*        modify ef-rapor-gun, enabled = history-eh
*        modify ef-rapor-ay , enabled = history-eh
*        modify ef-rapor-yil, enabled = history-eh
     .
 tarih-kontrol.
    initialize gec-gecme gidis-id
    open input takvim
    move bas-tar  to takvim-anah
    read takvim no lock invalid
          move 1 to gec-gecme
          initialize mesaj-link
          move 13 to mesaj-no
          perform mesaj-ver
          move 4 to accept-control
          move 7 to control-id gidis-id
    not invalid
        continue
    end-read
    move bit-tar  to takvim-anah
    read takvim no lock invalid
          move 1 to gec-gecme
          initialize mesaj-link
          move 13 to mesaj-no
          perform mesaj-ver
          move 4 to accept-control
          move 7 to control-id gidis-id
    not invalid
        continue
    end-read
    close takvim.

 takas-aktar.
 takas-dosya-ac.
    open i-o genelfis.
    move 1 to genelfis-anahtar.
    read genelfis no lock invalid move 1 to ekran-fis-1.
      
    add 1 to ekran-fis-1.
    move k-kodu-tasi to takas-k.
    move ekran-fis-1 to takas-no.
    rewrite genelfis-rec invalid write genelfis-rec.
    close genelfis.
    open output takas close takas 
    open i-o    takas with mass-update.
 takas-dosya-ac-exit.
       exit.

 ckckckc.
    
    open input cast rez konuk konum yromhrk acenta kodlar02 takvim polisxml uyruk.
    perform odalar-bul  thru odalar-bul-exit.
    open input odalar
    initialize cast-rec toplamlar.
    move bas-tar to cast-tarih.  
    start cast key not < cast-anah invalid continue,
        not invalid,
        move spaces to evet-hayir,
        perform with test after until evet,
            read cast next no lock end move "E" to evet-hayir,
                not end,
                if cast-tarih > bit-tar,
                        move "E" to evet-hayir,
                end-if,  
                move cast-tarih to rapor-tarih,
                perform genel2-oku
                   perform rez-al thru rez-al-exit,
*                end-if,
            end-read,
        end-perform,
    end-start.
    close cast rez konuk konum yromhrk acenta kodlar02 odalar takvim polisxml uyruk.
 takas-aktar-exit.
       exit.
 rez-al.
    initialize rez-rec.
    move cast-rez-no to rez-no.
    read rez no lock invalid go rez-al-exit.
   
    move rez-acenta  to acenta-kodu
    read acenta no lock invalid
         continue
    not invalid
         if acenta-tipi = 4 
           go rez-al-exit 
         end-if
    end-read
    initialize konuk-rec.
    move rez-folio to konuk-folio.
    read konuk no lock invalid go rez-al-exit.
  
    if konuk-fol-kodu = "R" or konuk-fol-kodu = "G"
       continue
    else 
       go rez-al-exit
    end-if.
    if konuk-proforma = 1 AND genel-proformali-calisma = 1 then 
                      go rez-al-exit
    end-if
*    perform ref-bul

*      if onkpara-referans-var = 1 and rapor-ref not = 0
*        and rapor-ref not = konum-ref 
*                   go rez-al-exit
*                  end-if

    if onkpara-referans-var = 1 then 
       if rezpara-trace =  1 then 
         move 1 to casttan
       end-if
       perform ref-filtre
       if  not ref-gecti then 
          go rez-al-exit
       end-if
    end-if
     if konuk-kisi not = cast-kisi
          move cast-kisi to konuk-kisi

       end-if
       move cast-oda-no    to konuk-odano
       initialize odalar-rec
      move konuk-odano to odalar-anah
         if genel-dis-cikmasin = 1 
                read odalar no lock invalid
                 move "H" to odalar-hayali
                                
                                 end-read
           if odalar-dis = 1 
                go rez-al-exit
            end-if
         end-if
      if konuk-git-tar = cast-tarih 
         if onkasa-sifir-geceleme-liste <> 1

          go rez-al-exit
        else
           perform basilan-bul thru basilan-bul-exit
             if konuk-oda-tutar = zeroes
                go rez-al-exit
             end-if

            compute duzeltme-oda   = duzeltme-oda   + 1
            compute duzeltme-buyuk = duzeltme-buyuk + konuk-buyuk
            compute duzeltme-kucuk = duzeltme-kucuk + konuk-kucuk
            compute duzeltme-free  = duzeltme-free  + konuk-free
            compute duzeltme-bebek = duzeltme-bebek + konuk-bebek
         end-if
      else



             perform basilan-bul thru basilan-bul-exit
*             if konuk-oda-tutar = zeroes
*                go rez-al-exit
*             end-if
      end-if   
  
*   TRACE Uygulamasi Acik ise kisi sayilari cast'tan alinacak
*      if (k-kodu-tasi = "ASYA" or "X   ") and konuk-folio = 289725 then stop " " end-if
       

    move "B" to kodlar02-tipi.
    move konuk-odeme-tipi to kodlar02-kodu.
    read kodlar02 no lock invalid
         move spaces to kodlar02-adi
    end-read
         if ode-posting = "H" go rez-al-exit.

    move "A" to kodlar02-tipi.
    move konuk-pan-tipi   to kodlar02-kodu.
    read kodlar02 no lock invalid
         move spaces to kodlar02-adi
    end-read
    .

    move konuk-odano                   to takas-oda
   

    move "D"                           to takas-dolu-bos
    move konuk-folio                   to takas-folio
    move konuk-rez-no                  to takas-rez
    move konuk-adi                     to takas-adi
    move konuk-soyadi                  to takas-soyadi
    if prof-uyruk = 0
       move konuk-ulke                 to takas-ulke
    else
       initialize polisxml-rec
       move rez-no   to polisxml-rezno
       move 1        to polisxml-sirano
       read polisxml no lock invalid 
            move konuk-ulke                 to takas-ulke(1:3) 
       not invalid 

*           if polisxml-tckimlikno > 0                                          |firat 17/02/2020 ekleme
*              move polisxml-tckimlikno  to kimlik-seri
*           else
*              move polisxml-kseri(1:11) to kimlik-seri
*           end-if

           if polisxml-uyruk not = spaces             
              initialize uyruk-rec
              move polisxml-uyruk            to uyruk-anah
              read uyruk no lock invalid 
                  move konuk-ulke            to takas-ulke(1:3)
              not invalid
                  move polisxml-uyruk        to takas-ulke
              end-read 
           else
              move konuk-ulke                to takas-ulke(1:3) 
           end-if
       end-read 
    end-if 

*    move kimlik-seri                   to takas-kimlik                                          |firat 17/02/2020 ekleme

    move konuk-gel-tar                 to takas-gel-tar
    move konuk-git-tar                 to takas-git-tar
    move konuk-pan-tipi                to takas-pan-tipi
    move konuk-odeme-tipi              to takas-odeme-tipi
    move konuk-acenta                  to takas-acenta
    move konuk-firma                   to takas-firma

    if konuk-git-tar <= rapor-tarih
      initialize konuk-buyuk konuk-kucuk konuk-free konuk-bebek
     end-if    
    move konuk-buyuk                   to takas-pax
    move konuk-kucuk                   to takas-chi
    move konuk-free                    to takas-free
    move konuk-bebek                   to takas-bebek

*      if isyeri-adres-tasi = "bung2019"  and (rapor-tarih >= 20200701 and  rapor-tarih <= 20200808) |||| silinecekkkk
*            if yromhrk-depkod = 100   
*                  move 8 to cinpara-mus-kdv
*            end-if
*             if yromhrk-depkod = 099   
*                  move 1 to cinpara-mus-kdv
*            end-if
*      end-if  ||| silinecekk


    move cinpara-mus-kdv               to takas-kdv.

    compute takas-tutar-kdvli = konuk-oda-tutar      + konuk-extbed-tutar +
                                konuk-kahvalti-tutar + konuk-ogle-tutar   +
                                konuk-aksam-tutar    + konuk-icecek-tutar +
                                konuk-extra-tutar.
    if konuk-room-kdv-yok  not = 1 
       compute takas-tutar-kdvsiz rounded =
            ((takas-tutar-kdvli * 100 ) / ((cinpara-mus-kdv + depgec-kv-orani )+ 100))

           
     move  cinpara-mus-kdv to takas-kdv   
   

    compute  takas-kdv-tutar  rounded =  takas-tutar-kdvsiz *  cinpara-mus-kdv / 100 
    compute  takas-kv-tutar   rounded =   takas-tutar-kdvsiz *  depgec-kv-orani / 100

     compute takas-tutar-kdvsiz =  takas-tutar-kdvli - takas-kdv-tutar - takas-kv-tutar 


    else
       move takas-tutar-kdvli to takas-tutar-kdvsiz
       move 0 to takas-kdv-tutar  takas-kv-tutar
    end-if        .

*/ kdvsiz rakam uzerinden indirim yapiliyor sonra tekrar kdvli hali hesaplaniyor
    
    if CINPARA-TASTIKLI-0-ciksin not = 1 and takas-tutar-kdvli = 0 then 
        go  rez-al-exit
    end-if

    compute gen-toplam-kdvsiz = 
            gen-toplam-kdvsiz + 
            takas-tutar-kdvsiz
    compute gen-toplam-kdvli = 
            gen-toplam-kdvli + 
            takas-tutar-kdvli
    compute gen-toplam-kdv = 
            gen-toplam-kdv + 
            takas-kdv-tutar
    compute gen-toplam-kv = 
            gen-toplam-kv + 
            takas-kv-tutar


    compute top-oda   = top-oda   + 1.
    compute top-buyuk = top-buyuk + konuk-buyuk.
    compute top-kucuk = top-kucuk + konuk-kucuk.
    compute top-free  = top-free  + konuk-free.
    compute top-bebek = top-bebek + konuk-bebek.

    perform geceleme-bul

    move cast-tarih to takas-kon-tar
    write takas-rec invalid 
       rewrite takas-rec,end-rewrite, 
    end-write.
    initialize takas-folio
    read takas no lock invalid continue 
    not invalid delete takas invalid continue
    end-delete
    end-read.
 rez-al-exit.
     exit.

 basilan-bul. 
    move "A" to kodlar02-tipi.
    move konuk-pan-tipi   to kodlar02-kodu.
    read kodlar02 no lock invalid
         move spaces to kodlar02-adi
    end-read
        initialize  konuk-oda-tutar       konuk-extra-tutar
                    konuk-kahvalti-tutar  konuk-ogle-tutar
                    konuk-aksam-tutar     konuk-icecek-tutar.
         move konuk-folio    to yromhrk-folio.
        
         move rapor-tarih    to yromhrk-tarih.
         start yromhrk key not < yromhrk-anah1 
               invalid go basilan-bul-exit.
 basilan-oku. 
         read yromhrk next no lock end 
              go basilan-bul-exit.
         if fs-yromhrk = 99 go basilan-oku.
         if yromhrk-tarih > rapor-tarih go basilan-bul-exit.
         if yromhrk-folio not = konuk-folio go basilan-bul-exit.
         |||| kdv salih


         if rapor-tarih > 20211001 and rapor-tarih < 20230710
            move genel2-kdv-eski-depkod to oda-dep
         end-if  
          




*         if rapor-tarih < genel2-kdv-gecerlilik-tar
*              move genel2-kdv-eski-depkod to oda-dep
*         end-if
         ||||

*         if isyeri-adres-tasi = "bung2019"  and (rapor-tarih >= 20200701 and  rapor-tarih <= 20200808) |||| silinecekkkk
*               if yromhrk-depkod = 100  or  yromhrk-depkod = 099
*                          compute konuk-oda-tutar      = 
*                               konuk-oda-tutar + yromhrk-tl-tutar
*               end-if
*         end-if  ||| silinecekk


         evaluate true 
          when pan-oda         = "X" and oda-dep      = yromhrk-depkod
               compute konuk-oda-tutar      = 
                       konuk-oda-tutar + yromhrk-tl-tutar
         when pan-oda         = "X" and oda-dep      = yromhrk-corr-depkod
               compute konuk-oda-tutar      = 
                       konuk-oda-tutar - yromhrk-tl-tutar
          when pan-kahvalti    = "X" and kahvalti-dep = yromhrk-depkod
               compute konuk-kahvalti-tutar = 
                       konuk-kahvalti-tutar + yromhrk-tl-tutar
          when pan-ogle        = "X" and ogle-dep     = yromhrk-depkod
               compute konuk-ogle-tutar     = 
                       konuk-ogle-tutar     + yromhrk-tl-tutar
          when pan-aksam       = "X" and aksam-dep    = yromhrk-depkod
               compute konuk-aksam-tutar    = 
                       konuk-aksam-tutar    + yromhrk-tl-tutar
          when pan-icecek      = "X" and icecek-dep   = yromhrk-depkod
               compute konuk-icecek-tutar   = 
                       konuk-icecek-tutar   + yromhrk-tl-tutar
          when pan-extra       = "X" and extra-dep    = yromhrk-depkod
               compute konuk-extra-tutar    = 
                       konuk-extra-tutar    + yromhrk-tl-tutar
         end-evaluate. 
              go basilan-oku.
 basilan-bul-exit. 
      if konuk-oda-tutar < 0 then 
         initialize konuk-oda-tutar
      end-if.
       
*
 odalar-bul.  
    open input odalar . 
    initialize odalar-rec.
    start odalar key not < odalar-anah invalid continue,
        not invalid,
        move spaces to evet-hayir,
        perform with test after until evet,
            read odalar next no lock end move "E" to evet-hayir,
                not end,
                   initialize takas-rec
                if odalar-hayali not = "H"
                  move odalar-konumu to konuk-oda-konumu
                  perform ref-bul
                  if onkpara-referans-var = 1 and rapor-ref not = 0
                     and rapor-ref not = konum-ref 
                       continue
                  else
                  
                   initialize takas-rec
                   move odalar-anah       to takas-oda
                   move "B"               to takas-dolu-bos
                   write takas-rec invalid rewrite takas-rec 
                                       end-rewrite 
                   end-write
                   end-if
                end-if
            end-read,
        end-perform,
    end-start.
    close odalar.  
 odalar-bul-exit.  
       exit.

 ref-bul.
      move konuk-oda-konumu to konum-anahtar
      read konum no lock invalid
            display message box "hata no:gunmus-konum-23644--folio---" konuk-folio
      end-read.

*
 sayfa-basi-bosluk-yaz.
      if cinpara-tastikli-bas-bos not numeric
         or cinpara-tastikli-bas-bos > 30
            initialize cinpara-tastikli-bas-bos
      end-if      .

      
       
      perform varying my-i
              from 1
              by 1
              until my-i > cinpara-tastikli-bas-bos
                    initialize dokumer-rec detay
                    move "M"   to det-dokumer-20(1:)
                    move "-----" to detay(5:)
                    write dokumer-rec from detay
      end-perform.
*
 soldan-bosluk2.
    add 1 to satir
    if satir > cinpara-tastikli-kayit-sayi
      if genel-musteri-listesi-yeni-ayarlar = 1
         move "P"            to det-dokumer-20(5:1)
      end-if
       perform sayfa-atla
       add 1 to satir
    end-if
*    initialize det-02 det-03
*    move satir to z-satir
*    move z-satir to det-02
*    move sayfa to z-satir
*    move z-satir to det-03
    perform soldan-bosluk
    
   
    if ilk-sayfa > sayfa then 
       move son-detay1 to son-detay2
        move detay to son-detay1
      else
      if ilk-sayfa > 1 and ilk-sor = 0 then 
        move 1 to ilk-sor
        display message box "Son Basilan satirlar asagidadir" new-line
                              son-detay2 new-line 
                            son-detay1 new-line
      end-if
      write dokumer-rec from detay 
    end-if.
*
 sayfa-atla.
    add 1 to sayfa
    compute  satir = cinpara-tastikli-bas-bos + 7
    .

*
 soldan-bosluk.
    if cinpara-tastikli-sagdan-sayi > 0 and  cinpara-tastikli-sagdan-sayi numeric
     move det-filler(1:200) to buffer
     move buffer to det-filler(CINPARA-TASTIKLI-sagdan-SAYI + 1 :200)
     move all spaces to det-filler(1: CINPARA-TASTIKLI-sagdan-SAYI)
    end-if
   
    .
*
 yan-rez-detay.
     if takas-rez not = 0
     initialize yanrez-rec
     move takas-rez          to yanrez-rezno
     start yanrez key not < yanrez-anah invalid
           continue
     not invalid
     perform with test after until fs-yanrez = "10"
     read yanrez next no lock end move "10"  to fs-yanrez
     not at end
            initialize dokumer-rec detay
            if yanrez-rezno <> takas-rez
               exit perform
            end-if
            if prof-uyruk not = 0
              initialize polisxml-rec
              move yanrez-rezno  to polisxml-rezno 
              move yanrez-sirano to polisxml-sirano
              read polisxml no lock invalid
                  initialize ulke-rec
                  move takas-ulke(1:3)     to ulke-anah1
                  read ulke no lock
                    invalid
                      initialize ulke-adi
                  end-read
                  move ulke-adi           to det-13                                                  
              not invalid 

                  if tc-ver = 1 
                     if polisxml-tckimlikno > 0                                          |firat 17/02/2020 ekleme
                        move polisxml-tckimlikno  to kimlik-seri
                     else
                        move polisxml-kseri(1:11) to kimlik-seri
                     end-if
                     move kimlik-seri    to detay(156:11)
                     move "|"            to detay(167:1)
                  end-if

                 initialize uyruk-rec
                 move polisxml-uyruk   to uyruk-anah
                 read uyruk no lock invalid
                         initialize ulke-rec
                         move takas-ulke(1:3)     to ulke-anah1
                         read ulke no lock
                           invalid
                             initialize ulke-adi
                         end-read
                         move ulke-adi           to det-13                                 
                 not invalid 
                     move uyruk-adi1  to det-13
                 end-read                   
              end-read 
            end-if 

            evaluate yanrez-sirano 
            when 2
                move yanrez-adi       to det-02
                move yanrez-soyadi    to det-03
                move "|" to fil-01 fil-02 fil-03 fil-04 fil-05 fil-06
                            fil-07 fil-08 fil-09 fil-099 fil-10 fil-11 fil-12  fil-119
                            fil-13 fil-14 fil-15 fil-16 fil-17
                perform soldan-bosluk2  
                
            when 3
                move yanrez-adi       to det-02
                move yanrez-soyadi    to det-03
                
                move "|" to fil-01 fil-02 fil-03 fil-04 fil-05 fil-06
                            fil-07 fil-08 fil-09 fil-099 fil-10 fil-11 fil-12  fil-119
                            fil-13 fil-14 fil-15 fil-16 fil-17
                perform soldan-bosluk2  
                
            when 4
                move yanrez-adi       to det-02
                move yanrez-soyadi    to det-03
                
                move "|" to fil-01 fil-02 fil-03 fil-04 fil-05 fil-06
                            fil-07 fil-08 fil-09 fil-099 fil-10 fil-11 fil-12 fil-119
                            fil-13 fil-14 fil-15 fil-16 fil-17
                perform soldan-bosluk2  
               
            when 5
                move yanrez-adi       to det-02
                move yanrez-soyadi    to det-03
                
                move "|" to fil-01 fil-02 fil-03 fil-04 fil-05 fil-06
                            fil-07 fil-08 fil-09 fil-099 fil-10 fil-11 fil-12  fil-119
                            fil-13 fil-14 fil-15 fil-16 fil-17
                perform soldan-bosluk2  
                
            when 6
                move yanrez-adi       to det-02
                move yanrez-soyadi    to det-03
                
                move "|" to fil-01 fil-02 fil-03 fil-04 fil-05 fil-06
                            fil-07 fil-08 fil-09 fil-099 fil-10 fil-11 fil-12 fil-119
                            fil-13 fil-14 fil-15 fil-16 fil-17
                perform soldan-bosluk2  
               
            when 7
                move yanrez-adi       to det-02
                move yanrez-soyadi    to det-03
                
                move "|" to fil-01 fil-02 fil-03 fil-04 fil-05 fil-06
                            fil-07 fil-08 fil-09 fil-099 fil-10 fil-11 fil-12 fil-119
                            fil-13 fil-14 fil-15 fil-16 fil-17
                perform soldan-bosluk2  
                
            when 8
                move yanrez-adi       to det-02
                move yanrez-soyadi    to det-03
                
                move "|" to fil-01 fil-02 fil-03 fil-04 fil-05 fil-06
                            fil-07 fil-08 fil-09 fil-099 fil-10 fil-11 fil-12  fil-119
                            fil-13 fil-14 fil-15 fil-16 fil-17
                perform soldan-bosluk2  
                
            when 9
                move yanrez-adi       to det-02
                move yanrez-soyadi    to det-03
                
                move "|" to fil-01 fil-02 fil-03 fil-04 fil-05 fil-06
                            fil-07 fil-08 fil-09 fil-099 fil-10 fil-11 fil-12 fil-119
                            fil-13 fil-14 fil-15 fil-16  fil-17
                perform soldan-bosluk2  
                
            end-evaluate


     end-read
     end-perform
     end-start
     end-if.
*
 geceleme-bul.
     initialize takvim-rec gece-sayi
     move rez-gir-tar to takvim-anah
     start takvim key not < takvim-anah invalid,    
           continue
     not invalid
     perform with test after until fs-takvim = "10"
     read takvim next no lock end move "10" to fs-takvim
     not at end 
         if takvim-anah = rez-cik-tar
            exit perform
         end-if
         add 1 to gece-sayi
     end-read 
     end-perform
     end-start 
     move gece-sayi to takas-geceleme
    .



 
