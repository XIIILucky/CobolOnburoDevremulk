* kasamah.evt
* kasamah.evt is generated from D:\asya\acugt.ytl\otel\kasamah.Psf
* This is a generated file. DO NOT modify this file directly.


 Form1-Event-Proc.
     .

 Form1-Exception-Proc.
     PERFORM Form1-Ex-Other
     .

 acc-ref-Exception-Proc.
     PERFORM acc-ref-Ex-Other
     .

 Form1-Gd-1-Event-Proc.
     .

 Form1-Cb-1aaa-Exception-Proc.
* 
     IF Event-Occurred
        EVALUATE Event-Type
        WHEN Cmd-Clicked
           PERFORM Form1-Cb-1aaa-Ev-Cmd-Clicked
        END-EVALUATE
     END-IF
     .
***   start event editor code   ***
*
 acc-yil-Aft-Procedure.
     initialize gec-gecme.
     open input takvim.
     move tarih   to takvim-anah
     read takvim no lock invalid
          move 1 to gec-gecme
     end-read
     close takvim.
   
     if girilemez-tarih <> zeroes 
        if tarih < girilemez-tarih
           move 1 to gec-gecme
           display message box
                   girilemez-gun,"/",girilemez-ay,"/",girilemez-yil,
                   " tarihinden onceye mahsup fisi kesilemez ....",
                   icon mb_error_icon
                    "Hata"
        end-if
     end-if.
*
 acc-numara-Aft-Procedure.
     initialize gec-gecme.
     if numara = zeroes 
        open i-o genelfis 
        move 1 to genelfis-anahtar
        read genelfis no lock invalid
             display message box
                     "Genel parametre'de genelfis fis tanimlamalari eksik !!!",new-line,
                     "Lutfen tanimlayiniz ..."
                     icon mb_error_icon
                     title "Hata"
                     destroy form1-handle
                     close genelfis
                     goback
        end-read
        add 1 to mahsup-oto
        move mahsup-oto to numara
        if mgenel-referans = "E"
           open i-o referans
             move ref   to referans-kodu
             move "A"   to referans-tipi
             read referans no lock invalid           
                  continue
             end-read
             add 1 to referans-fisno-ekle
             move referans-fisno-ekle   to numara
             add 4 to referans-fisno-ekle
             rewrite referans-rec end-rewrite

           close referans
        else
           add 4 to mahsup-oto
           rewrite genelfis-rec end-rewrite
        end-if
        close genelfis
        display acc-numara
     end-if.

     open input islenen.
     move numara to no-kont
     perform 4 times

     move no-kont to islenen-fis-no
     read islenen no lock invalid
          continue
     not invalid
          move 1 to gec-gecme
          display message box 
                  islenen-fis-no," numarali fis ",islenen-gun,"/",
                  islenen-ay,"/",islenen-yil," tarih kayitli",new-line,
                  "Lutfen kontrol ediniz",
                  icon mb_error_icon
                  title "Hata"
     end-read
     add 1 to no-kont 
     end-perform
     close islenen.
     
     .
*
 acc-ref-Aft-Procedure.
     initialize gec-gecme.
     if mgenel-referans = "E"
        continue else 
             exit paragraph.
*     if k-referans not = 0
*        if ref not = k-referans
*           display message box "Sadece ->" ,k-referans 
*           "<- Nolu Referansi Kullanmaya yetkilisiniz..."
*        end-if
*        move k-referans  to ref
*        display acc-ref
*     end-if

     open input referans.
     move ref   to referans-kodu
     move "A"   to referans-tipi
     read referans no lock invalid
          
          

          initialize referans-ip
          perform acuserve-adres-aktar

          move 1 to gec-gecme
          move "Tanimsiz ..." to referans-adi
     not invalid
          continue
     end-read
     close referans.
     display lb-ref.
     if referans-fisno-ekle not numeric
        move 0 to referans-fisno-ekle
     end-if.
     if nereden <> "E"
        move 0 to numara
        display acc-numara.     
     .

*
 Form1-Bef-Create.
     perform adresleri-tasi.
     move tarih-tasi     to tarih.
     
       open input genel
    move 1 to genel-anahtar
    read genel no lock
      invalid
        move 3 to mesaj-no
        perform mesaj-ver
        set exit-pushed to true
      not invalid
        continue
*        move muha-sirketi to odenmez-dosya-adres
    end-read
    close genel

    open i-o genel2
    move 1 to genel2-anah
    read genel2 no lock invalid
        continue
    end-read
    close genel2




    move muha-sirketi of genel-rec to muhasebe-entegre-sirketi
    if ONKPARA-REFERANS-VAR = 1 and genel-muha-ref not > 0  then 
       move 1 to ref-var
       else
       move 0 to ref-var
    end-if
    if genel2-onb-refsiz = 1
         move 0 to ref-var  
    end-if


    move genel-muha-ref to ref
     initialize referans-ip
     
      
     perform acuserve-adres-aktar.
     open input mgenel.
     move 1 to mgenel-anahtar.
     read mgenel no lock invalid
          display message box 
                  "mgenel parametre tanimsiz ..."
                  icon mb_error_icon
                  title "Hata"
                  close mgenel
                  destroy form1-handle
                  goback
     end-read.
     close mgenel.
     if mgenel-referans = "E" 
        move 1 to vis-1
     else
        move 0 to vis-1
     end-if.
     move 1 to enable-1
     move 0 to enable-2.
     if genel-otel-kod = "libert"
        move 1 to  dov-hes-calis
     end-if
     
     .
*
 Form1-Ex-Other.
     if key-status = 2001 or 
        key-status = 2002 or
        key-status = 2003 
        
                open i-o takvim
                move tarih to takvim-anah
                read takvim no lock 
                        invalid 
                           display message box "Takvim tanimli degil" 
                        not invalid
                        if takvim-kasamah not = 1 
                              move 1 to sonuc
                           else
                               
                               display message box "Mukerrer Mahsup yapmak uzeresiniz Devam edilsin mi? " title "Mukerrer  Kayit" type 2 giving sonuc
                        end-if
                end-read      
              
                close takvim
                if sonuc = 2 then 
                  exit paragraph
                end-if        
        else 
             exit paragraph
        end-if

       move tarih  to muhasebe-tar
        perform muhasebe-entegre-kontrol
        if  muh-isl-durdur = 1 
          exit paragraph
        end-if

     if key-status = 2001
        perform yaz-boggam
        exit paragraph.

     if key-status = 2003
        move 1 to enable-1 
        move 0 to enable-2
        modify form1-gd-1,reset-grid =1 
        display form1
*/-----------------------------\*  
*/---------DIL AYARLA----------\*    
*/-----------------------------\*    
        perform dil-ayarla-proc
*/-----------------------------\*         
        move 4 to accept-control
        move 4 to control-id
        close borc-dep alac-dep ara-borc-dep ara-alac-dep ara-fark kasa-borc-dep
           kasadov kasa-alac-dep takas-acenta
        delete file borc-dep alac-dep kasa-borc-dep kasa-alac-dep 
        takas-acenta ara-borc-dep ara-alac-dep ara-fark kasadov

        exit paragraph.

*       display message box  "geldi".
     perform Acc-Yil-Aft-Procedure.
     if gec-gecme = 1 
        move 4 to accept-control
        move 4 to control-id
        exit paragraph.

     perform Acc-Numara-Aft-Procedure.
     if gec-gecme = 1 
        move 4 to accept-control
        move 8 to control-id
        exit paragraph.

     move "E" to nereden.
     perform Acc-Ref-Aft-Procedure.
     if gec-gecme = 1 
        move 4 to accept-control
        move 12 to control-id
        exit paragraph.

     open i-o genelfis.
     move 1 to genelfis-anahtar.
     read genelfis no lock invalid move 1 to ekran-fis-1.
      
     add 1 to ekran-fis-1.
     move ekran-fis-1 to borc-dep-no.
      
     add 1 to ekran-fis-1.
     move ekran-fis-1 to kasa-borc-dep-no.
      
     add 1 to ekran-fis-1.
     move ekran-fis-1 to kasa-alac-dep-no.
     add 1 to ekran-fis-1.
      
     add 1 to ekran-fis-1.
     move ekran-fis-1 to alac-dep-no ara-alac-dep-no ara-borc-dep-no ara-fark-no.
      
     add 1 to ekran-fis-1.
     move ekran-fis-1 to takas-acenta-no kasadov-no.
     rewrite genelfis-rec invalid write genelfis-rec end-write end-rewrite.
     close genelfis.
     open output borc-dep close borc-dep open i-o borc-dep with mass-update.
     open output kasadov close kasadov open i-o kasadov with mass-update.
     open output alac-dep close alac-dep open i-o alac-dep with mass-update.
     open output ara-borc-dep close ara-borc-dep open i-o ara-borc-dep with mass-update.
     open output ara-alac-dep close ara-alac-dep open i-o ara-alac-dep with mass-update.
     open output ara-fark     close ara-fark     open i-o ara-fark     with mass-update.
     open output kasa-borc-dep close kasa-borc-dep open i-o kasa-borc-dep with mass-update.
     open output kasa-alac-dep close kasa-alac-dep open i-o kasa-alac-dep with mass-update.
     open output takas-acenta close takas-acenta open i-o takas-acenta with mass-update.
     initialize kasa-borc-dep-rec kasa-alac-dep-rec borc-dep-rec alac-dep-rec takas-acenta-rec borc alac.

****|HAKAN|*** PROGRAMDAKÝ ARIZA YÜZÜNDEN BENÝ UÐRAÞTIRAN
**** DÝÐER PROGRAMCI ARKADAÞLARA SESLENÝYORUZ
*****
     open input efat2onb   kodlar02 cast
    if ref-var = 1 and ref > 0 then 
       perform onkasar-oku thru onkasar-oku-exit
    else
       perform onkasa-oku thru onkasa-oku-exit
    end-if   
    close efat2onb kodlar02 cast
     move 0 to enable-1
     move 1 to enable-2
     display form1.
*/-----------------------------\*  
*/---------DIL AYARLA----------\*    
*/-----------------------------\*    
     perform dil-ayarla-proc.
*/-----------------------------\*         
     modify form1-gd-1,reset-grid =1,.
     move "Hesap kodu"       to gd-1-col-1
     move "Hesap adi"        to gd-1-col-2
     move "Aciklama"         to gd-1-col-3
     move "Borc Tutar"       to gd-1-col-5
     move "Alacak Tutar"     to gd-1-col-6
     modify form1-gd-1,record-to-add(form1-gd-1-record).
      
     open input hesap doviz.
        initialize kasadov-rec  borc alac
     start kasadov key not < kasadov-anah invalid
      continue
      not invalid
   
     perform with test after until fs-kasadov = "10"
     read kasadov next no lock end move "10" to fs-kasadov
     not at end
     initialize form1-gd-1-record hesap-kodu
         move kasadov-doviz to doviz-kodu 
          read doviz no lock invalid continue
          end-read
      
         move d-hesap      to mahsup-hesap-kodu(5:)   hesap-kodu(5:)
           move "100-" to  hesap-kodu(1:4)

            read hesap no lock invalid
                 move "." to  hesap-kodu(4:1) mahsup-hesap-kodu(4:1) 
          end-read
          
            move d-hesap      to hesap-kodu(5:)
            move hesap-kodu          to gd-1-col-1 
          read hesap no lock invalid
                 add 1 to tanimsiz-sayi
                 move "Tanimsiz ..."   to hesap-adi
          end-read
          move hesap-adi             to gd-1-col-2
           
          move kasadov-tl-tut       to etutar
          
             move etutar             to gd-1-col-5
               move  kasadov-doviz-tut to z-para
             string z-para  delimited by size
                " " delimited by size
                d-kisa-adi delimited by size
                " ONBURO DOVIZLI TAHSILAT" delimited by size
                      into gd-1-col-3
        
          modify form1-gd-1,record-to-add(form1-gd-1-record)
         
             add kasadov-tl-tut to borc
          
             add kasadov-tl-tut to alac
         
               initialize  gd-1-col-5
       
             move etutar             to gd-1-col-6
             move  kasadov-doviz-tut to z-para
             string z-para  delimited by size
                " " delimited by size
                d-kisa-adi delimited by size
                " ONBURO DOVIZLI TAHSILAT" delimited by size
                      into gd-1-col-3
                 move cash-hesap      to hesap-kodu
            move hesap-kodu          to gd-1-col-1 
          read hesap no lock invalid
                 add 1 to tanimsiz-sayi
                 move "Tanimsiz ..."   to hesap-adi
          end-read
          move hesap-adi             to gd-1-col-2
           modify form1-gd-1,record-to-add(form1-gd-1-record)
     end-read
     end-perform
     end-start
     if fark-kes = 1 
******************************* fark mahsubu
         initialize ara-borc-dep-rec ara-alac-dep-rec  borc alac
     start ara-borc-dep key not < ara-borc-dep-anah invalid continue
     not invalid
     initialize fs-ara-borc-dep
     perform with test after until fs-ara-borc-dep = "10"
     read ara-borc-dep next no lock end move "10" to fs-ara-borc-dep
     not at end
          initialize form1-gd-1-record
          move ara-borc-dep-hesap           to gd-1-col-1 hesap-kodu
          read hesap no lock invalid
                 add 1 to tanimsiz-sayi
                 move "Tanimsiz ..."   to hesap-adi
          end-read
          move hesap-adi             to gd-1-col-2
          move ara-borc-dep-aciklama     to gd-1-col-3
          move ara-borc-dep-tutar-tl        to etutar
          if ara-borc-dep-ba = "B"
             move etutar             to gd-1-col-5
          else
             move etutar             to gd-1-col-6
          end-if
          modify form1-gd-1,record-to-add(form1-gd-1-record)
          if ara-borc-dep-ba = "B"
             add ara-borc-dep-tutar-tl to borc
          else
             add ara-borc-dep-tutar-tl to alac
          end-if
     end-read
     end-perform
     end-start
     initialize ara-borc-dep-rec ara-alac-dep-rec 
     
     start ara-alac-dep key not < ara-alac-dep-anah invalid continue
     not invalid
     initialize fs-ara-alac-dep
     perform with test after until fs-ara-alac-dep = "10"
     read ara-alac-dep next no lock end move "10" to fs-ara-alac-dep
     not at end
          initialize form1-gd-1-record
          move ara-alac-dep-hesap           to gd-1-col-1 hesap-kodu
          read hesap no lock invalid
               add 1 to tanimsiz-sayi
               move "Tanimsiz ..."   to hesap-adi
          end-read
          move hesap-adi             to gd-1-col-2
          move ara-alac-dep-aciklama     to gd-1-col-3
          move ara-alac-dep-tutar-tl     to etutar
          if ara-alac-dep-ba = "B"
             move etutar             to gd-1-col-5
          else
             move etutar             to gd-1-col-6
          end-if
          modify form1-gd-1,record-to-add(form1-gd-1-record)
          if alac-dep-ba = "B"
             add ara-alac-dep-tutar-tl to borc
          else
             add ara-alac-dep-tutar-tl to alac
          end-if
     end-read
     end-perform
     end-start


******************************* fark mahsubu
     else
     initialize borc-dep-rec alac-dep-rec kasa-borc-dep-rec kasa-alac-dep-rec 
     start borc-dep key not < borc-dep-anah2 invalid continue
     not invalid
     initialize fs-borc-dep
     perform with test after until fs-borc-dep = "10"
     read borc-dep next no lock end move "10" to fs-borc-dep
     not at end
          initialize form1-gd-1-record
          move borc-dep-hesap           to gd-1-col-1 hesap-kodu
          read hesap no lock invalid
                 add 1 to tanimsiz-sayi
                 move "Tanimsiz ..."   to hesap-adi
          end-read
          move hesap-adi             to gd-1-col-2
          move borc-dep-aciklama     to gd-1-col-3
          move borc-dep-tutar        to etutar

          if borc-dep-ba = "B"
             move etutar             to gd-1-col-5
          else
             move etutar             to gd-1-col-6
          end-if
          modify form1-gd-1,record-to-add(form1-gd-1-record)
          if borc-dep-ba = "B"
             add borc-dep-tutar to borc
          else
             add borc-dep-tutar to alac
          end-if
     end-read
     end-perform
     end-start
     initialize borc-dep-rec alac-dep-rec 
     
     start alac-dep key not < alac-dep-anah2 invalid continue
     not invalid
     initialize fs-alac-dep
     perform with test after until fs-alac-dep = "10"
     read alac-dep next no lock end move "10" to fs-alac-dep
     not at end

       


          initialize form1-gd-1-record
          move alac-dep-hesap           to gd-1-col-1 hesap-kodu
          read hesap no lock invalid
               add 1 to tanimsiz-sayi
               move "Tanimsiz ..."   to hesap-adi
          end-read
          move hesap-adi             to gd-1-col-2
          move alac-dep-aciklama     to gd-1-col-3
          move alac-dep-tutar-tl     to etutar
          if alac-dep-ba = "B"
             move etutar             to gd-1-col-5
          else
             move etutar             to gd-1-col-6
          end-if
          modify form1-gd-1,record-to-add(form1-gd-1-record)
          if alac-dep-ba = "B"
             add alac-dep-tutar-tl to borc
          else
             add alac-dep-tutar-tl to alac
          end-if
     end-read
     end-perform
     end-start
********************* KASALAR **********************************
     start kasa-borc-dep key not < kasa-borc-dep-anah2 invalid continue
     not invalid
     initialize fs-kasa-borc-dep
     perform with test after until fs-kasa-borc-dep = "10"
     read kasa-borc-dep next no lock end move "10" to fs-kasa-borc-dep
     not at end
          initialize form1-gd-1-record
          move kasa-borc-dep-hesap           to gd-1-col-1 hesap-kodu
          read hesap no lock invalid
               add 1 to tanimsiz-sayi
               move "Tanimsiz ..."   to hesap-adi
          end-read
          move hesap-adi             to gd-1-col-2
          move kasa-borc-dep-aciklama     to gd-1-col-3
          move kasa-borc-dep-tutar        to etutar
          if kasa-borc-dep-ba = "B"
             move etutar             to gd-1-col-5
          else
             move etutar             to gd-1-col-6
          end-if
          modify form1-gd-1,record-to-add(form1-gd-1-record)
          if kasa-borc-dep-ba = "B"
             add kasa-borc-dep-tutar to borc
          else
             add kasa-borc-dep-tutar to alac
          end-if
     end-read
     end-perform
     end-start
            

     initialize kasa-borc-dep-rec kasa-alac-dep-rec 
     start kasa-alac-dep key not < kasa-alac-dep-anah2 invalid continue
     not invalid
     initialize fs-kasa-alac-dep
     perform with test after until fs-kasa-alac-dep = "10"
     read kasa-alac-dep next no lock end move "10" to fs-kasa-alac-dep
     not at end
          initialize form1-gd-1-record
          move kasa-alac-dep-hesap           to gd-1-col-1 hesap-kodu
          read hesap no lock invalid
               add 1 to tanimsiz-sayi
               move "Tanimsiz ..."   to hesap-adi
          end-read
          move hesap-adi             to gd-1-col-2
          move kasa-alac-dep-aciklama     to gd-1-col-3
          move kasa-alac-dep-tutar-tl     to etutar
          if kasa-alac-dep-ba = "B"
             move etutar             to gd-1-col-5
          else
             move etutar             to gd-1-col-6
          end-if
          modify form1-gd-1,record-to-add(form1-gd-1-record)
          if kasa-alac-dep-ba = "B"
             add kasa-alac-dep-tutar-tl to borc
          else
             add kasa-alac-dep-tutar-tl to alac
          end-if
     end-read
     end-perform
     end-start
     end-if




     close hesap doviz.

     modify form1-gd-1,
            mass-update = 0.

     compute bakiye = borc - alac
     move borc   to etutar
     modify acc-borc, value = etutar
     move alac   to etutar
     modify acc-alac, value = etutar
     move bakiye to etutar
     modify acc-bakiye, value = etutar
     if borc <> alac 
        display message box 
                "Borc/Alacak toplami esit degil Kontrol ediniz",
                icon mb_error_icon
                title "Hata"
*                move 1 to enable-1 
*                move 0 to enable-2
*                display form1
*                move 4 to accept-control
*               move 4 to control-id
*                exit paragraph
*                close borc-dep alac-dep kasa-borc-dep 
*                ara-borc-dep ara-alac-dep ara-fark kasa-alac-dep takas-acenta
*                delete file borc-dep alac-dep 
*                ara-borc-dep ara-alac-dep ara-fark kasa-borc-dep kasa-alac-dep takas-acenta
    end-if.

 yaz-boggam.
     close takas-acenta.
     delete file takas-acenta.
     if combo-dovizlimi-value(1:1)  = "D"
        perform kur-bul thru kur-bul-exit
     end-if
     if borc = 0 or alac = 0
        display message box
                "Muhasebelestirilecek kayit bulunamadi ..."
                icon mb_error_icon
                title "Hata"
                move 1 to enable-1 
                move 0 to enable-2
                display form1
*/-----------------------------\*  
*/---------DIL AYARLA----------\*    
*/-----------------------------\*    
                perform dil-ayarla-proc
*/-----------------------------\*         
                move 4 to accept-control
                move 4 to control-id
                close  borc-dep alac-dep  ara-borc-dep ara-alac-dep ara-fark kasa-borc-dep kasa-alac-dep 
                delete file borc-dep alac-dep ara-borc-dep ara-alac-dep ara-fark kasa-borc-dep kasa-alac-dep 
                exit paragraph
      end-if.
*******>Borc Departmanlari Muhasebelesiyor.........

    
     open i-o mahsup islenen doviz hesap kur.
     initialize borc-dep-rec alac-dep-rec fis-sira-sakla
     if fark-kes = 1
     
                start ara-borc-dep key not < ara-borc-dep-anah invalid
              continue
              not invalid
             initialize fs-ara-borc-dep
             perform with test after until fs-ara-borc-dep = "10"
             read ara-borc-dep next no lock end move "10" to fs-ara-borc-dep
             not at end
               if ara-borc-dep-tutar-tl  = 0 exit perform cycle end-if
                 initialize mahsup-rec 
                 move tarih               to mahsup-tarih
                 move numara              to mahsup-fis-no
                 add  1                   to fis-sira-sakla
                 move fis-sira-sakla      to mahsup-fis-sira
                 move ara-borc-dep-hesap      to mahsup-hesap-kodu
                 move "A"                 to mahsup-tipi
                 move ara-borc-dep-ba         to mahsup-b-a 
                 move ara-borc-dep-tutar-tl      to mahsup-tutar
                 if  ara-borc-dep-tutar-tl < 0 
                     if ara-borc-dep-ba  = "B" then 
                        move "A" to mahsup-b-a
                      else
                           move "B" to mahsup-b-a
                     end-if
                 end-if
                 move ara-borc-dep-aciklama   to mahsup-aciklama 
                 move ref                 to mahsup-referans 
                 move k-kodu-tasi         to mahsup-staf 
                 
                 if combo-dovizlimi-value(1:1)  = "D" and 
                    islem-kuru not = 0
                    if mahsup-tutar <> zeroes
                       move mgenel-banka  to mahsup-banka-kodu
                       move mgenel-doviz  to mahsup-doviz-kodu
                       move mgenel-d-e    to mahsup-d-e       
                       move islem-kuru   to mahsup-doviz-kuru
                       compute mahsup-tutar-dv rounded = 
                               mahsup-tutar / islem-kuru
                    end-if
                 end-if

                
                 move "O"                 to mahsup-nereden
                  if genel-otel-kod = "libert"
                     perform doviz-kodu-duzenle
                     perform hesaba-gore-doviz
                  end-if
        
                 write mahsup-rec invalid continue end-write
             end-read
             end-perform
             end-start
             
     initialize ara-alac-dep-rec 
     start ara-alac-dep key not < ara-alac-dep-anah invalid
      continue
      not invalid
     initialize fs-ara-alac-dep
     perform with test after until fs-ara-alac-dep = "10"
     read ara-alac-dep next no lock end move "10" to fs-ara-alac-dep
     not at end
         if ara-alac-dep-tutar-tl  = 0 exit perform cycle end-if
         initialize mahsup-rec 
         move tarih               to mahsup-tarih
         move numara              to mahsup-fis-no
         add  1                   to fis-sira-sakla
         move fis-sira-sakla      to mahsup-fis-sira

         move ara-alac-dep-hesap      to mahsup-hesap-kodu
         move "A"                 to mahsup-tipi
         move ara-alac-dep-ba         to mahsup-b-a 
         move ara-alac-dep-tutar-tl   to mahsup-tutar
          if  ara-alac-dep-tutar-tl < 0 
                     if ara-alac-dep-ba  = "B" then 
                        move "A" to mahsup-b-a
                      else
                           move "B" to mahsup-b-a
                     end-if
                 end-if
         move ara-alac-dep-aciklama   to mahsup-aciklama 
         move ref                 to mahsup-referans 
         move k-kodu-tasi         to mahsup-staf 
          if ara-alac-dep-acenno not = spaces then
               move ara-alac-dep-banka      to mahsup-banka-kodu
               move ara-alac-dep-doviz      to mahsup-doviz-kodu
               move mgenel-d-e           to mahsup-d-e       
               move ara-alac-dep-tutar-dv   to mahsup-tutar-dv
               move ara-alac-dep-doviz-kuru to mahsup-doviz-kuru
         else
            if combo-dovizlimi-value(1:1)  = "D" and 
               islem-kuru not = 0
                if mahsup-tutar <> zeroes
                       move mgenel-banka  to mahsup-banka-kodu
                       move mgenel-doviz  to mahsup-doviz-kodu
                       move mgenel-d-e    to mahsup-d-e       
                       move islem-kuru   to mahsup-doviz-kuru
                       compute mahsup-tutar-dv rounded = 
                               mahsup-tutar / islem-kuru
                end-if
             end-if
         if combo-dovizlimi-value(1:1)  = "D" and 
            ara-alac-dep-banka  not = 0 and
            ara-alac-dep-doviz  not = 0
            if mahsup-tutar <> zeroes
               move ara-alac-dep-banka      to mahsup-banka-kodu
               move ara-alac-dep-doviz      to mahsup-doviz-kodu
               move mgenel-d-e           to mahsup-d-e       
               move ara-alac-dep-tutar-dv   to mahsup-tutar-dv
               move ara-alac-dep-doviz-kuru to mahsup-doviz-kuru
            end-if
         end-if
         end-if
         move "O" to mahsup-nereden
          if genel-otel-kod = "libert"
             perform doviz-kodu-duzenle
             perform hesaba-gore-doviz
          end-if

         write mahsup-rec invalid continue end-write
         
     end-read
     end-perform
     end-start
************************** alacak correctionlar
     if fis-sira-sakla > 0 then 

             move numara      to islenen-fis-no
             move tarih       to islenen-tarih
             move "A"         to islenen-tipi
                move "O " to ISLENEN-NEREDEN
             write islenen-rec invalid 
                   rewrite islenen-rec end-rewrite
             end-write
             add 1 to numara
       end-if,           

     
     
     
     else
     start borc-dep key not < borc-dep-anah2 invalid
      continue
      not invalid
     initialize fs-borc-dep
     perform with test after until fs-borc-dep = "10"
     read borc-dep next no lock end move "10" to fs-borc-dep
     not at end
         if borc-dep-tutar  = 0 exit perform cycle end-if
         initialize mahsup-rec 
         move tarih               to mahsup-tarih
         move numara              to mahsup-fis-no
         add  1                   to fis-sira-sakla
         move fis-sira-sakla      to mahsup-fis-sira
         move borc-dep-hesap      to mahsup-hesap-kodu
         move "A"                 to mahsup-tipi
         move borc-dep-ba         to mahsup-b-a 
         move borc-dep-tutar      to mahsup-tutar
          if  borc-dep-tutar < 0 
                     if borc-dep-ba  = "B" then 
                        move "A" to mahsup-b-a
                      else
                           move "B" to mahsup-b-a
                     end-if
                 end-if
         move borc-dep-aciklama   to mahsup-aciklama 
         move ref                 to mahsup-referans 
         move k-kodu-tasi         to mahsup-staf 
         
         if combo-dovizlimi-value(1:1)  = "D" and 
            islem-kuru not = 0
            if mahsup-tutar <> zeroes
               move mgenel-banka  to mahsup-banka-kodu
               move mgenel-doviz  to mahsup-doviz-kodu
               move mgenel-d-e    to mahsup-d-e       
               move islem-kuru   to mahsup-doviz-kuru
               compute mahsup-tutar-dv rounded = 
                       mahsup-tutar / islem-kuru
            end-if
         end-if
        
         move "O"                 to mahsup-nereden
          if genel-otel-kod = "libert"
             perform doviz-kodu-duzenle
             perform hesaba-gore-doviz
          end-if

         write mahsup-rec invalid continue end-write
     end-read
     end-perform
     end-start
     if fis-sira-sakla > 0 then 
             move numara      to islenen-fis-no
             move tarih       to islenen-tarih
             move "A"         to islenen-tipi
             move "O "        to ISLENEN-NEREDEN
             write islenen-rec invalid 
                   rewrite islenen-rec end-rewrite
             end-write
             add 1 to numara
       end-if,           

     initialize kasa-borc-dep-rec  fis-sira-sakla
     start kasa-borc-dep key not < kasa-borc-dep-anah2 invalid
              continue
              not invalid
     initialize fs-kasa-borc-dep
     perform with test after until fs-kasa-borc-dep = "10"
     read kasa-borc-dep next no lock end move "10" to fs-kasa-borc-dep
     not at end
         if kasa-borc-dep-tutar  = 0 exit perform cycle end-if
         initialize mahsup-rec 
         move tarih               to mahsup-tarih
         move numara              to mahsup-fis-no
         add  1                   to fis-sira-sakla
         move fis-sira-sakla      to mahsup-fis-sira
         move kasa-borc-dep-hesap      to mahsup-hesap-kodu
         move "C"                 to mahsup-tipi
         move kasa-borc-dep-ba         to mahsup-b-a 
         move kasa-borc-dep-tutar      to mahsup-tutar
         move kasa-borc-dep-aciklama   to mahsup-aciklama
         if  kasa-borc-dep-tutar < 0 
                     if kasa-borc-dep-ba  = "B" then 
                        move "A" to mahsup-b-a
                      else
                           move "B" to mahsup-b-a
                     end-if
                 end-if
         move ref                 to mahsup-referans 
         move k-kodu-tasi         to mahsup-staf   
         if combo-dovizlimi-value(1:1)  = "D" and 
            islem-kuru not = 0
            if mahsup-tutar <> zeroes
               move mgenel-banka  to mahsup-banka-kodu
               move mgenel-doviz  to mahsup-doviz-kodu
               move mgenel-d-e    to mahsup-d-e       
               move islem-kuru   to mahsup-doviz-kuru
               compute mahsup-tutar-dv rounded = 
                       mahsup-tutar / islem-kuru
            end-if
         end-if
         move "O"                 to mahsup-nereden
          if genel-otel-kod = "libert"
             perform doviz-kodu-duzenle
             perform hesaba-gore-doviz
          end-if

         write mahsup-rec invalid continue end-write
     end-read
     end-perform
     end-start


     


        
     if fis-sira-sakla > 0 then 

             move numara      to islenen-fis-no
             move tarih       to islenen-tarih
             move "C"         to islenen-tipi
                move "O " to ISLENEN-NEREDEN
             write islenen-rec invalid 
                   rewrite islenen-rec end-rewrite
             end-write             
             add 1 to numara
       end-if,           
*******>Alacak Departmanlari Muhasebelesiyor.........
     initialize  fis-sira-sakla
     initialize alac-dep-rec 
     start alac-dep key not < alac-dep-anah2 invalid
      continue
      not invalid
     initialize fs-alac-dep
     perform with test after until fs-alac-dep = "10"
     read alac-dep next no lock end move "10" to fs-alac-dep
     not at end
 
        if alac-dep-tutar-tl  = 0 exit perform cycle end-if
       if alac-dep-corr not = "C" then
         initialize mahsup-rec 
         move tarih               to mahsup-tarih
         move numara              to mahsup-fis-no
         add  1                   to fis-sira-sakla
         move fis-sira-sakla      to mahsup-fis-sira

         move alac-dep-hesap      to mahsup-hesap-kodu
         move "A"                 to mahsup-tipi
         move alac-dep-ba         to mahsup-b-a 
         move alac-dep-tutar-tl   to mahsup-tutar
         move alac-dep-aciklama   to mahsup-aciklama 
         move ref                 to mahsup-referans
         if  alac-dep-tutar-tl < 0 
                     if alac-dep-ba  = "B" then 
                        move "A" to mahsup-b-a
                      else
                           move "B" to mahsup-b-a
                     end-if
                 end-if
         move k-kodu-tasi         to mahsup-staf 
          if alac-dep-acenno not = spaces  then
               move alac-dep-banka      to mahsup-banka-kodu
               move alac-dep-doviz      to mahsup-doviz-kodu
               move mgenel-d-e           to mahsup-d-e       
               move alac-dep-tutar-dv   to mahsup-tutar-dv
               move alac-dep-doviz-kuru to mahsup-doviz-kuru
         else
         if combo-dovizlimi-value(1:1)  = "D" and 
            islem-kuru not = 0
            if mahsup-tutar <> zeroes
               move mgenel-banka  to mahsup-banka-kodu
               move mgenel-doviz  to mahsup-doviz-kodu
               move mgenel-d-e    to mahsup-d-e       
               move islem-kuru   to mahsup-doviz-kuru
               compute mahsup-tutar-dv rounded = 
                       mahsup-tutar / islem-kuru
            end-if
         end-if
         if combo-dovizlimi-value(1:1)  = "D" and 
            alac-dep-banka  not = 0 and
            alac-dep-doviz  not = 0
            if mahsup-tutar <> zeroes
               move alac-dep-banka      to mahsup-banka-kodu
               move alac-dep-doviz      to mahsup-doviz-kodu
               move mgenel-d-e           to mahsup-d-e       
               move alac-dep-tutar-dv   to mahsup-tutar-dv
               move alac-dep-doviz-kuru to mahsup-doviz-kuru
            end-if
         end-if
         end-if
         move "O" to mahsup-nereden
          if genel-otel-kod = "libert"
             perform doviz-kodu-duzenle
             perform hesaba-gore-doviz
          end-if

         write mahsup-rec invalid continue end-write
         end-if
     end-read
     end-perform
     end-start
************************** alacak correctionlar
     if fis-sira-sakla > 0 then 

             move numara      to islenen-fis-no
             move tarih       to islenen-tarih
             move "A"         to islenen-tipi
                move "O " to ISLENEN-NEREDEN
             write islenen-rec invalid 
                   rewrite islenen-rec end-rewrite
             end-write
             add 1 to numara
       end-if,           

     initialize  fis-sira-sakla
     initialize alac-dep-rec 
     start alac-dep key not < alac-dep-anah2 invalid
      continue
      not invalid
     initialize fs-alac-dep
     perform with test after until fs-alac-dep = "10"
     read alac-dep next no lock end move "10" to fs-alac-dep
     not at end
      if alac-dep-tutar-tl  = 0 exit perform cycle end-if
       if alac-dep-corr  = "C" then
         initialize mahsup-rec 
         move tarih               to mahsup-tarih
         move numara              to mahsup-fis-no
         add  1                   to fis-sira-sakla
         move fis-sira-sakla      to mahsup-fis-sira

         move alac-dep-hesap      to mahsup-hesap-kodu
         move "A"                 to mahsup-tipi
         move alac-dep-ba         to mahsup-b-a 
         move alac-dep-tutar-tl   to mahsup-tutar
         move alac-dep-aciklama   to mahsup-aciklama
         if  alac-dep-tutar-tl < 0 
                     if alac-dep-ba  = "B" then 
                        move "A" to mahsup-b-a
                      else
                           move "B" to mahsup-b-a
                     end-if
                 end-if
         move ref                 to mahsup-referans 
         move k-kodu-tasi         to mahsup-staf   
         if alac-dep-acenno not = spaces then
               move alac-dep-banka      to mahsup-banka-kodu
               move alac-dep-doviz      to mahsup-doviz-kodu
               move mgenel-d-e           to mahsup-d-e       
               move alac-dep-tutar-dv   to mahsup-tutar-dv
               move alac-dep-doviz-kuru to mahsup-doviz-kuru
         else
         if combo-dovizlimi-value(1:1)  = "D" and 
            islem-kuru not = 0
            if mahsup-tutar <> zeroes
               move mgenel-banka  to mahsup-banka-kodu
               move mgenel-doviz  to mahsup-doviz-kodu
               move mgenel-d-e    to mahsup-d-e       
               move islem-kuru   to mahsup-doviz-kuru
               compute mahsup-tutar-dv rounded = 
                       mahsup-tutar / islem-kuru 
            end-if
         end-if
         if combo-dovizlimi-value(1:1)  = "D" and 
            alac-dep-banka  not = 0 and
            alac-dep-doviz  not = 0
            if mahsup-tutar <> zeroes
               move alac-dep-banka      to mahsup-banka-kodu
               move alac-dep-doviz      to mahsup-doviz-kodu
               move mgenel-d-e           to mahsup-d-e       
               move alac-dep-tutar-dv   to mahsup-tutar-dv
               move alac-dep-doviz-kuru to mahsup-doviz-kuru
            end-if
         end-if
         end-if
         move "O" to mahsup-nereden
          if genel-otel-kod = "libert"
             perform doviz-kodu-duzenle
             perform hesaba-gore-doviz
          end-if

         write mahsup-rec invalid continue end-write
         end-if
     end-read
     end-perform
     end-start


************************   alacak kasalar        
     if fis-sira-sakla > 0 then 

             move numara      to islenen-fis-no
             move tarih       to islenen-tarih
             move "A"         to islenen-tipi
                move "O " to ISLENEN-NEREDEN
             write islenen-rec invalid 
                   rewrite islenen-rec end-rewrite
             end-write
             add 1 to numara             
       end-if,           
          initialize  fis-sira-sakla

     initialize kasa-alac-dep-rec 
     start kasa-alac-dep key not < kasa-alac-dep-anah2 invalid
      continue
      not invalid
     initialize fs-kasa-alac-dep
     perform with test after until fs-kasa-alac-dep = "10"
     read kasa-alac-dep next no lock end move "10" to fs-kasa-alac-dep
     not at end
         if kasa-alac-dep-tutar-tl  = 0 exit perform cycle end-if
         initialize mahsup-rec 
         move tarih               to mahsup-tarih
         move numara              to mahsup-fis-no
         add  1                   to fis-sira-sakla
         move fis-sira-sakla      to mahsup-fis-sira

         move kasa-alac-dep-hesap      to mahsup-hesap-kodu
         move "B"                 to mahsup-tipi
         move kasa-alac-dep-ba         to mahsup-b-a 
         move kasa-alac-dep-tutar-tl   to mahsup-tutar
         move kasa-alac-dep-aciklama   to mahsup-aciklama
         if  kasa-alac-dep-tutar-tl < 0 
                     if kasa-alac-dep-ba  = "B" then 
                        move "A" to mahsup-b-a
                      else
                           move "B" to mahsup-b-a
                     end-if
                 end-if
         move ref                 to mahsup-referans 
         move k-kodu-tasi         to mahsup-staf   
         if combo-dovizlimi-value(1:1)  = "D" and 
            islem-kuru not = 0
            if mahsup-tutar <> zeroes
               move mgenel-banka  to mahsup-banka-kodu
               move mgenel-doviz  to mahsup-doviz-kodu
               move mgenel-d-e    to mahsup-d-e       
               move islem-kuru   to mahsup-doviz-kuru
               compute mahsup-tutar-dv rounded = 
                       mahsup-tutar / islem-kuru
            end-if
         end-if
         if combo-dovizlimi-value(1:1)  = "D" and 
            kasa-alac-dep-banka  not = 0 and
            kasa-alac-dep-doviz  not = 0
            if mahsup-tutar <> zeroes
               move kasa-alac-dep-banka      to mahsup-banka-kodu
               move alac-dep-doviz      to mahsup-doviz-kodu
               move mgenel-d-e           to mahsup-d-e       
               move kasa-alac-dep-tutar-dv   to mahsup-tutar-dv
               move kasa-alac-dep-doviz-kuru to mahsup-doviz-kuru
            end-if
         end-if
         move "O" to mahsup-nereden
          if genel-otel-kod = "libert"
             perform doviz-kodu-duzenle
             perform hesaba-gore-doviz
          end-if

         write mahsup-rec invalid continue end-write
     end-read
     end-perform
     end-start
        if fis-sira-sakla > 0 then 

             move numara      to islenen-fis-no
             move tarih       to islenen-tarih
             move "B"         to islenen-tipi
                move "O " to ISLENEN-NEREDEN
             write islenen-rec invalid 
                   rewrite islenen-rec end-rewrite
             end-write
             add 1 to numara             
       end-if,           
     end-if
     
************************   doviz-bozumlari       
     
          initialize  fis-sira-sakla
 
     initialize kasadov-rec 
     start kasadov key not < kasadov-anah invalid
      continue
      not invalid
   
     perform with test after until fs-kasadov = "10"
     read kasadov next no lock end move "10" to fs-kasadov
     not at end
         initialize mahsup-rec 
         move tarih               to mahsup-tarih
         move numara              to mahsup-fis-no
         add  1                   to fis-sira-sakla
         move fis-sira-sakla      to mahsup-fis-sira
          move kasadov-doviz to doviz-kodu 
          read doviz no lock invalid continue
          end-read
         move "100-" to  mahsup-hesap-kodu(1:4)
         
         move d-hesap      to mahsup-hesap-kodu(5:)

         initialize hesap-rec
         move mahsup-hesap-kodu to  hesap-kodu
            read hesap no lock invalid
                 move "." to  mahsup-hesap-kodu(4:1) 
           end-read
         move "A"          to mahsup-tipi
         move "B"          to mahsup-b-a 
        if  kasadov-tl-tut   < 0 then 
           move "A"          to mahsup-b-a 
        end-if
         move kasadov-tl-tut    to mahsup-tutar
         move kasadov-doviz-tut  to mahsup-tutar-dv 
         move kasadov-banka     to mahsup-banka-kodu
         move kasadov-doviz     to mahsup-doviz-kodu
          compute  mahsup-doviz-kuru  rounded =  kasadov-tl-tut / kasadov-doviz-tut

          move  mahsup-tutar-dv to z-para
          string z-para  delimited by size
                " " delimited by size
                d-kisa-adi delimited by size
                " ONBURO DOVIZLI TAHSILAT" delimited by size
                 into  mahsup-aciklama
          

         move "D"               to mahsup-d-e 
         move ref                 to mahsup-referans 
         move k-kodu-tasi         to mahsup-staf   
         move "DB" to mahsup-nereden
        
                initialize  bozumdan-geldi
          if genel-otel-kod = "libert"
              move 1 to bozumdan-geldi
****             perform doviz-kodu-duzenle
             perform hesaba-gore-doviz
          end-if

         write mahsup-rec invalid continue end-write
         add  1                   to fis-sira-sakla
         move fis-sira-sakla      to mahsup-fis-sira
         move "A"                to mahsup-b-a 
          if  kasadov-tl-tut   < 0 then 
           move "B"          to mahsup-b-a 
        end-if
         move cash-hesap         to  mahsup-hesap-kodu

         move  mahsup-tutar-dv to z-para
*         string z-para  delimited by size
*                " " delimited by size
*                d-kisa-adi delimited by size
*                " ONBURO DOVIZ BOZUMU" delimited by size
*         
*         into  mahsup-aciklama
         initialize  mahsup-tutar-dv 
         mahsup-banka-kodu
         mahsup-doviz-kodu
           mahsup-doviz-kuru  

             if combo-dovizlimi-value(1:1)  = "D" and 
                    islem-kuru not = 0
                    if mahsup-tutar <> zeroes
                       move mgenel-banka  to mahsup-banka-kodu
                       move mgenel-doviz  to mahsup-doviz-kodu
                       move mgenel-d-e    to mahsup-d-e       
                       move islem-kuru   to mahsup-doviz-kuru
                       compute mahsup-tutar-dv rounded = 
                               mahsup-tutar / islem-kuru
                    end-if
                 end-if
          if genel-otel-kod = "libert"
             perform doviz-kodu-duzenle
             perform hesaba-gore-doviz
          end-if

          write mahsup-rec invalid continue end-write

     end-read
     end-perform
     end-start
     
       if fis-sira-sakla > 0 then 
             move numara      to islenen-fis-no
             move tarih       to islenen-tarih
             move "A"         to islenen-tipi
                move "DB" to ISLENEN-NEREDEN
             write islenen-rec invalid 
                   rewrite islenen-rec end-rewrite
             end-write
             add 1 to numara             
       end-if,           

       


     
     close borc-dep kasa-borc-dep .
     close alac-dep mahsup kasa-alac-dep ara-borc-dep ara-alac-dep ara-fark kasadov.
     delete file alac-dep kasa-alac-dep ara-borc-dep ara-alac-dep ara-fark kasadov.
     delete file borc-dep kasa-borc-dep.



     close islenen doviz hesap kur.
     display message box 
             "Gunluk [ ONBURO MAHSUBU ] Olusturulmustur Kontrol Ediniz !!!".
     modify form1-gd-1,reset-grid =1 .
     move 1 to enable-1 
     move 0 to enable-2
     display form1
*/-----------------------------\*  
*/---------DIL AYARLA----------\*    
*/-----------------------------\*    
     perform dil-ayarla-proc
*/-----------------------------\*         
     move 4 to accept-control
     move 4 to control-id.
     .
*
 acc-ref-Ex-Other.
     if key-status =  1
        initialize link-referans
        call "/asya/ytl/obj/muha/refara.asy" using link-referans
             on exception 
                perform callerr-proc
        not on exception
             cancel "/asya/ytl/obj/muha/refara.asy"
        end-call
        if link-referans <> spaces
           move link-referans to ref
           display acc-ref
           move 4 to accept-control
           move 12 to control-id
        end-if
     end-if.
*
 kur-bul.
        initialize islem-kuru.
     if combo-dovizlimi-value(1:1)  = "D"
               
        open input kur

        initialize islem-kuru
        move tarih         to kur-tarih
        move mgenel-banka   to kur-banka
        move mgenel-doviz   to kur-doviz
        if genel-otel-kod = "libert"
          perform uzak-kur-degistir
        end-if
        read kur no lock invalid 
         display message box "Gunluk Kur Kaydi Bulunamadi Devam Ederseniz Dovizsiz Mahsup Keser.."
                              new-line,
                              "Islem Tarihi...........:" gun "/" ay "/" yil   
                              new-line,
                              "Banka-Doviz Kodu.......:" mgenel-banka   "-" mgenel-doviz
                              title = " [ Kurlar Tanimsiz ] "
         close kur 
         exit paragraph
        end-read
        move doviz-alis to islem-kuru
        if mgenel-d-e = "D" and mgenel-a-s = "A" 
           move doviz-alis    to islem-kuru
        end-if 
        if mgenel-d-e = "D" and mgenel-a-s = "S" 
           move doviz-satis   to islem-kuru
        end-if 
        if mgenel-d-e = "E" and mgenel-a-s = "A" 
           move efektif-alis  to islem-kuru
        end-if 
        if mgenel-d-e = "E" and mgenel-a-s = "S" 
           move efektif-satis to islem-kuru
        end-if 

        if islem-kuru = 0 
           display message box "Kur Tutari [0] Olamaz, Islem Yapamazsiniz.."
                            new-line,
                            "Islem Tarihi...........:" gun "/" ay "/" yil
                            new-line,
                            "Banka-Doviz Kodu.......:" mgenel-banka   "-" mgenel-doviz
                            title = " [ Kurlar Tanimsiz ] "
          close kur 
          exit paragraph
        end-if
        close kur
     end-if.
 kur-bul-exit.
    exit.
*


               
*
 dov-boz-oku.
           open input dov-boz depkod depkod2 konuk doviz.
    initialize dov-boz-rec
    move tarih to dov-boz-tarih.
    start dov-boz key not < dov-boz-anah 
        invalid 
             continue
        not invalid
        perform with test after until fs-dov-boz = "10"
            read dov-boz next no lock end move "10" to fs-dov-boz
                not end
                if dov-boz-durumu = "S" 
                   exit perform cycle
                end-if
                if dov-boz-tarih not = tarih
                   exit perform 
                else
***                if DOV-BOZ-FOLIO not = 61956 exit perform cycle  end-if 
                   if ref-var = 1 then 
                      move DOV-BOZ-FOLIO to konuk-folio
                      read konuk no lock invalid 
                         move 1 to KONUK-ODA-konumu
                      end-read
                      if onkpara-referans-nerden <> 2
                           if xkonum-ref(KONUK-ODA-konumu) not = ref
                                  exit perform cycle
                           end-if
                      else
                            open input odalar
                               initialize odalar-rec
                               move KONUK-ODANO to odalar-anah
                               read odalar no lock invalid
                                       continue
                               not invalid
                                                    if odalar-referans not > 0
                                                        move 1 to odalar-referans
                                                    end-if
                                    if odalar-referans not = ref and genel-muha-ref not > 0 
                                       and ref > 0
                                            close odalar
                                          exit perform cycle
                                    end-if
                               end-read
                            close odalar
                        end-if
                                 

                   end-if
                  initialize kasadov-rec

                   
*                  if genel-otel-kod = "libert"
*
*                      move dov-boz-doviz to HESAP-DOVIZ
*                      perform uzak-kur-degistir-hesaba-gore
*                      move kur-doviz to dov-boz-doviz
*                   end-if

                  move dov-boz-doviz to kasadov-doviz 
                  move dov-boz-banka to kasadov-banka
                  read kasadov no lock invalid 
                     continue
                  end-read
                   if  DOV-BOZ-ALIS-SATIS = 1 
                    subtract DOV-BOZ-DV-TUTAR from kasadov-doviz-tut   
                    subtract DOV-BOZ-tl-TUTAR from kasadov-tl-tut  
                  else
                   
                  
                  add DOV-BOZ-DV-TUTAR to kasadov-doviz-tut   
                  add DOV-BOZ-tl-TUTAR to   kasadov-tl-tut 
                  end-if
                  write kasadov-rec invalid rewrite kasadov-rec end-write
               end-if
           end-read
       end-perform 
    end-start.
    close doviz
     initialize  depkod-rec
    start depkod key > depkod-anah invalid continue
    not invalid
      perform until fs-depkod = "10"
        
      read depkod next  no lock 
      end move "10" to fs-depkod
         not end,
                  move depkod-anah to depkod2-anah
                  
                    read depkod2 no lock invalid continue end-read
                     perform depkod2-tr
                     if depkod2-kasa-hesap = spaces 
                        exit perform cycle
                     end-if

                     if depkod-turu = 2 then 
                        continue
                     else
                      if depkod2-kasa-hesap(1:3) not = "100"                          
                         continue
                      else                   
                         move  depkod2-kasa-hesap to cash-hesap
                        exit perform
                      end-if
                     end-if
                end-read,
         end-perform 
      end-start      
    close dov-boz depkod depkod2 konuk.

 onkasa-oku.
     perform dov-boz-oku
    open input onkasa depkod depkod2 doviz  .
    




    initialize onkasa-rec .
    move tarih to onkasa-tarih.

    start onkasa key not < onkasa-anah invalid continue,
        not invalid,
        move spaces to evet-hayir,
        perform with test after until evet,
        read onkasa next no lock end move "E" to evet-hayir,
            not end,

            if onkasa-tarih > tarih,
                      move "E" to evet-hayir,
            end-if,
             
            if onkasa-tarih = tarih  ,
                initialize depkod-rec  depkod2-rec,
                move onkasa-dep to depkod-kodu depkod2-anah,
                read depkod no lock invalid continue,
                    not invalid,
                    read depkod2 no lock invalid continue end-read
                     perform depkod2-tr
                     if depkod2-kasa-hesap = spaces 
                        exit perform cycle
                     end-if

                     if depkod-turu = 2 then 
                       continue
                     else
                         if depkod2-kasa-hesap(1:3) not = "100"
                             
                               perform takaslara-yaz
                         else
                              move  depkod2-kasa-hesap to cash-hesap
                              perform kasa-takaslara-yaz
                         end-if
 
                     end-if

                end-read,
            end-if,
        end-read,
        end-perform,
    end-start.
    close onkasa depkod depkod2 doviz  .
 onkasa-oku-exit.
    exit. 
*
 onkasar-oku.
  


        perform dov-boz-oku
    open input onkasar depkod depkod2 doviz.
    initialize onkasar-rec .
    move ref to onkasar-ref
    move tarih to onkasar-tarih.
    
    start onkasar key not < onkasar-anah invalid continue,
        not invalid,
        move spaces to evet-hayir,
        perform with test after until evet,
        read onkasar next no lock end move "E" to evet-hayir,
            not end,

            if onkasar-tarih > tarih or onkasar-ref not = ref,
                      move "E" to evet-hayir,
            end-if,

 
            if onkasar-tarih = tarih  ,
                initialize depkod-rec depkod2-rec,
                move onkasar-dep to depkod-kodu depkod2-anah,
                read depkod no lock invalid continue,
                    not invalid,
                     read depkod2 no lock invalid continue end-read
                      perform depkod2-tr
                     if depkod2-kasa-hesap = spaces 
                        exit perform cycle
                     end-if

                     if depkod-turu = 2 then continue
                      else
                      move onkasar-rec(2:) to onkasa-rec
                      if depkod2-kasa-hesap(1:3) not = "100"
                           
                      perform takaslara-yaz

                      else
                          move  depkod2-kasa-hesap to cash-hesap  
                          perform kasa-takaslara-yaz
                      end-if
                     end-if
                end-read,
            end-if,
        end-read,
        end-perform,
    end-start.
    close onkasar depkod depkod2 doviz.
 onkasar-oku-exit.
    exit.
 dovizli-bul.
      initialize ONKASA-TUTAR-DV  romhrk-rec exthrk-rec
      open input romhrk exthrk  hrk2 yromhrk  konuk
      move onkasa-tarih to romhrk-tarih   exthrk-tarih
      move onkasa-dep to romhrk-depkod  exthrk-depkod
      start romhrk key >= ROMHRK-ANAH2 invalid continue
             not invalid
             perform until fs-romhrk = "10"
                read romhrk next no lock end move "10" to fs-romhrk
                     not end
                       if onkasa-tarih not =  romhrk-tarih or 
                         onkasa-dep not =  romhrk-depkod  
                         move "10" to fs-romhrk
                         else
                          if ref-var = 1 then 
                              move romhrk-FOLIO to konuk-folio
                              read konuk no lock invalid 
                                 move 1 to KONUK-ODA-konumu
                              end-read
                         
                                     if onkpara-referans-nerden <> 2
                                           if xkonum-ref(KONUK-ODA-konumu) not = ref
                                                  exit perform cycle
                                           end-if
                                      else
                                            open input odalar
                                               initialize odalar-rec
                                               move KONUK-ODANO to odalar-anah
                                               read odalar no lock invalid
                                                       continue
                                               not invalid
                                                    if odalar-referans not > 0
                                                        move 1 to odalar-referans
                                                    end-if
                                                   if odalar-referans not = ref and genel-muha-ref not > 0 
                                                   and ref > 0
                                                           close odalar
                                                         exit perform cycle
                                                    end-if
                                               end-read
                                            close odalar
                                        end-if
                          end-if



************************REFERANS AYRILMADI
*                            if ref-var = 1 then 
*                              if romhrk-ref not = 
                            move romhrk-anah to hrk2-anah  yromhrk-anah
                           perform d-at

                      end-if
                  end-read
             end-perform
      end-start
            start exthrk key >= extHRK-ANAH2 invalid continue
             not invalid
             perform until fs-exthrk = "10"
                read exthrk next no lock end move "10" to fs-exthrk
                     not end
                       if onkasa-tarih not =  exthrk-tarih or 
                         onkasa-dep not =  exthrk-depkod  
                         move "10" to fs-exthrk
                         else
************************REFERANS AYRILMADI
*                            if ref-var = 1 then 
*                              if romhrk-ref not =  
                            if ref-var = 1 then 
                              move exthrk-FOLIO to konuk-folio
                              read konuk no lock invalid 
                                 move 1 to KONUK-ODA-konumu
                              end-read
                              if onkpara-referans-nerden <> 2
                                   if xkonum-ref(KONUK-ODA-konumu) not = ref
                                          exit perform cycle
                                   end-if
                              else
                                    open input odalar
                                       initialize odalar-rec
                                       move KONUK-ODANO to odalar-anah
                                       read odalar no lock invalid
                                               continue
                                       not invalid
                                                    if odalar-referans not > 0
                                                        move 1 to odalar-referans
                                                    end-if
                                            if odalar-referans not = ref and genel-muha-ref not > 0 
                                            and ref > 0
                                                    close odalar
                                                  exit perform cycle
                                            end-if
                                       end-read
                                    close odalar
                                end-if
                          end-if
                            move exthrk-anah to hrk2-anah  yromhrk-anah
                           perform d-at

                      end-if
                  end-read
             end-perform
      end-start

      close  romhrk exthrk  hrk2 yromhrk  konuk

      .
*
 d-at.
  
    read hrk2 no lock invalid  continue not invalid
         move hrk2-kaynak-folio to yromhrk-folio
         read yromhrk no lock  invalid continue  not invalid
          if  yromhrk-derle-kaydi = 1 
                                     exit paragraph
           end-if 
            if yromhrk-dovizli-kk  = 1 and 1=0
               initialize takas-kk-rec
                move yromhrk-doviz-kodu to takas-kk-kodu
                read takas-kk no lock invalid
                      continue
                end-read
                     
                 add yromhrk-doviz-tut to takas-kk-TUTAR-DV
                 add yromhrk-tl-tutar to takas-kk-TUTAR-tl
                 
                  write takas-kk-rec invalid rewrite takas-kk-rec end-rewrite
                  end-write
               
           else
                initialize takas-kk-rec
               
                read takas-kk no lock invalid 
                     continue
                end-read
                  if yromhrk-rez-no > 1 then 
                        
                   perform derle-dus
                   subtract dus-tl from  yromhrk-tl-tutar
                 end-if 
               
                 add yromhrk-tl-tutar to takas-kk-TUTAR-tl
                  write takas-kk-rec invalid rewrite takas-kk-rec end-rewrite
                  end-write
              
            end-if
         end-read
    end-read.


*
   
 derle-dus.
      if yromhrk-rez-no > 1 and yromhrk-derle-kaydi  not = 1   and yromhrk-derle-kaydi  not = 2 
           continue
           else
           exit paragraph
      end-if
          initialize dus-tl
         move  yromhrk-rez-no to  eski-rez
         move yromhrk-rec to hrkgir-rec
          initialize yromhrk-rec
          move hrkgir-tarih to yromhrk-tarih
          
         
         start yromhrk key >= yROMHRK-ANAH2  invalid continue
             not invalid 
               perform until fs-yromhrk = "10"

                  read yromhrk next no lock end move "10" to fs-yromhrk
                      not end 
                      if   yromhrk-tarih not = hrkgir-tarih 
                            move "10" to fs-yromhrk

                         else
                         if yromhrk-rez-no = eski-rez  
                            and yromhrk-islem not = hrkgir-islem  and yromhrk-derle-kaydi = 1  then
                            if yromhrk-ba = "B"
                               
                                add yromhrk-tl-tutar to dus-tl
                            else
                              subtract yromhrk-tl-tutar from dus-tl
                            end-if
                          end-if

                      end-if
                 end-read
              end-perform 
          end-start
           move hrk2-kaynak-folio to yromhrk-folio
             
             move hrkgir-anah to yromhrk-anah
            read yromhrk no lock  invalid continue  end-read 

       .

*         
 derleeski-dus.
          initialize dus-tl
         move  yromhrk-rez-no to  eski-rez
         move yromhrk-rec to hrkgir-rec
          initialize yromhrk-rec
          move hrkgir-tarih to yromhrk-tarih
          
         
         start yromhrk key >= yROMHRK-ANAH2  invalid continue
             not invalid 
               perform until fs-yromhrk = "10"
                  read yromhrk next no lock end move "10" to fs-yromhrk
                      not end 
                      if   yromhrk-tarih not = hrkgir-tarih 
                            move "10" to fs-yromhrk

                         else
                         if yromhrk-rez-no = eski-rez  
                            and yromhrk-islem not = hrkgir-islem  and yromhrk-derle-kaydi = 1  then
                            if yromhrk-ba = "A"
                               
                            add yromhrk-tl-tutar to dus-tl
                            else
                              subtract yromhrk-tl-tutar from dus-tl
                            end-if
                          end-if

                      end-if
                 end-read
              end-perform 
          end-start
           move hrk2-kaynak-folio to yromhrk-folio
             
             move hrkgir-anah to yromhrk-anah
         read yromhrk no lock  invalid continue  end-read

           .
 takaslara-yaz.
          move ekran-fis-1 to takas-kk-no
               open output takas-kk   close takas-kk open i-o takas-kk
               open input acenta
             perform dovizli-bul.
             initialize takas-kk-rec
              start takas-kk key >= takas-kk-kodu invalid continue 
                 not invalid
                 perform until fs-takas-kk = "10"
                    read takas-kk next no lock end move "10" to fs-takas-kk
                      not end
                     
                        move takas-kk-TUTAR-DV  to onkasa-tutar-dv
                       move takas-kk-TUTAR-tl  to onkasa-tutar-tl
*/****doviz deðerlemesi olmayan otellerin sistemini bozuyordu örnek : likya world ekleyen ramazan
                       if GENEL-ONODEME-DOV-DERLE = 1
                          initialize onkasa-corr-tutar-tl
                       end-if 
*/****doviz deðerlemesi olmayan otellerin sistemini bozuyordu örnek : likya world ekleyen ramazan
                       perform takaslara-yaz2
                    end-read
                 end-perform
              end-start

             close takas-kk  acenta
            .
 takaslara-yaz2.
              
               evaluate true
                    when depkod-ba = "B" 
                         initialize borc-dep-rec,
                         if depkod2-matrah-hesap not = spaces
                            move depkod2-matrah-hesap   to borc-dep-hesap
                            if depkod-matrah-ba = "B"
                                 move "A"   to borc-dep-ba
                              else
                                 move "B"   to borc-dep-ba
                            end-if
                            move depkod2-matrah-hesap   to borc-dep-hesap
                            
                            read borc-dep no lock invalid continue,
                            end-read,
                                 compute borc-dep-tutar rounded = borc-dep-tutar + onkasa-tutar-tl
                                 - ONKASA-CORR-TUTAR-TL
                                 move "Gunluk Gelirler Geregi" to borc-dep-aciklama
                            write borc-dep-rec invalid rewrite borc-dep-rec,
                            end-write,
                         end-if
                    evaluate depkod-turu
                              when  4 perform kredi-bul thru kredi-bul-exit
                              
                              
*                              when  5 perform kredi-karti-bul thru kredi-karti-bul-exit
                              when other continue
                       if depkod-mahsup-detay = "E" then

                          if depkod2-kasa-hesap not = spaces and 
                              depkod-kdv-hesap    not = spaces and
                              depkod-kdv              = zeroes
                                 move "H" to kdvli
                                 perform borc-departman-detay-bul thru borc-departman-detay-bul-exit
                            end-if
                          if depkod2-kasa-hesap not = spaces and 
                             depkod-kdv-hesap        = spaces 
                                 move "H" to kdvli
                                 perform borc-departman-detay-bul thru borc-departman-detay-bul-exit
                            end-if
                           if depkod2-kasa-hesap not = spaces and 
                             depkod-kdv-hesap    not = spaces and
                             depkod-kdv          not = zeroes
                                   move "E" to kdvli
                                   perform borc-departman-detay-bul thru borc-departman-detay-bul-exit
                            end-if
                        else
                         initialize borc-dep-rec,
                         if depkod2-kasa-hesap not = spaces and 
                            depkod-kdv-hesap    not = spaces and
                            depkod-kdv              = zeroes
                            if depkod-matrah-ba = "B"
                               move "B"   to borc-dep-ba
                            else
                               move "A"   to borc-dep-ba
                            end-if
                            move depkod2-kasa-hesap   to borc-dep-hesap
                         
                            read borc-dep no lock invalid continue,
                            end-read,
                                 compute borc-dep-tutar rounded = borc-dep-tutar
                                 + onkasa-tutar-tl
                                 - ONKASA-CORR-TUTAR-TL
                                 move "Gunluk Gelirler Geregi" to borc-dep-aciklama
                            write borc-dep-rec invalid rewrite borc-dep-rec,
                            end-write,
                         end-if
                         initialize borc-dep-rec,
                         if depkod2-kasa-hesap not = spaces and 
                            depkod-kdv-hesap        = spaces 
                            if depkod-matrah-ba = "B"
                               move "B"   to borc-dep-ba
                            else
                               move "A"   to borc-dep-ba
                            end-if
                            move depkod-KODU           to borc-dep-kodu
                            move depkod2-kasa-hesap   to borc-dep-hesap
                             move depkod-KODU          to borc-dep-kodu
                      
                            read borc-dep no lock invalid continue,
                            end-read,
                                 compute borc-dep-tutar rounded = borc-dep-tutar + onkasa-tutar-tl
                                 - ONKASA-CORR-TUTAR-TL
                                 move onk-gun to borc-dep-aciklama(1:2)
                                 move onk-ay to borc-dep-aciklama(4:2)
                                 
                                 move "/" to borc-dep-aciklama(3:1)
                                 move depkod-adi(1:15) to  
                                 borc-dep-aciklama (7:15)
                                 move " Geliri     " to   borc-dep-aciklama(23:)
                            write borc-dep-rec invalid rewrite borc-dep-rec,
                            end-write,
                         end-if
                         initialize borc-dep-rec,
                         if depkod2-kasa-hesap not = spaces and 
                            depkod-kdv-hesap    not = spaces and
                            depkod-kdv          not = zeroes
                            if depkod-matrah-ba = "B"
                               move "B"   to borc-dep-ba
                            else
                               move "A"   to borc-dep-ba
                            end-if

                            move depkod2-kasa-hesap   to borc-dep-hesap
                            move depkod-KODU   to borc-dep-KODU
                            read borc-dep no lock invalid continue,
                            end-read,
                                 compute borc-dep-tutar rounded = 
                                         (borc-dep-tutar + 
                                         (((onkasa-tutar-tl - ONKASA-CORR-TUTAR-TL) * 100) / 
                                         (100 + depkod-kdv)))
****                                 move "Gunluk Gelirler Geregi" to
                                 move depkod-adi(1:10) to  
                                 borc-dep-aciklama
                                 move " Geliri     " to   borc-dep-aciklama(11:)
                            write borc-dep-rec invalid rewrite borc-dep-rec,
                            end-write,
                            initialize borc-dep-rec,
                            if depkod-matrah-ba = "B"
                               move "B"   to borc-dep-ba
                            else
                               move "A"   to borc-dep-ba
                            end-if
                            move depkod-kdv-hesap      to borc-dep-hesap
                            read borc-dep no lock invalid continue,
                            end-read,
                                 compute borc-dep-tutar rounded = 
                                         (borc-dep-tutar + 
                                         ((onkasa-tutar-tl - ONKASA-CORR-TUTAR-TL ) - 
                                         ((onkasa-tutar-tl - ONKASA-CORR-TUTAR-TL ) * 100) 
                                         / (100 + depkod-kdv)))
                                 move "Gunluk Gelirler Geregi" to borc-dep-aciklama
                            write borc-dep-rec invalid   rewrite borc-dep-rec,
                            end-write,
                         
                        end-if
                      end-if  
                    end-evaluate
//////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
                    when depkod-ba = "A" 


 
                         initialize alac-dep-rec,
                          if depkod2-matrah-hesap not = spaces
                               initialize alac-dep-anah
                               move depkod2-matrah-hesap   to alac-dep-hesap
                               if depkod-matrah-ba = "B"
                                        move "A"   to alac-dep-ba
                               else
                                        move "B"   to alac-dep-ba
                               end-if
                               if depkod-turu = 2 then
                                     move "C" to alac-dep-corr
                               end-if
                               read alac-dep no lock invalid continue,
                               end-read,
                                    compute alac-dep-tutar-tl rounded = alac-dep-tutar-tl + 
                                    ( onkasa-tutar-tl -  ONKASA-CORR-TUTAR-TL )
                                    
                                    move "Gunluk Tahsilatlar Geregi" to alac-dep-aciklama
                               write alac-dep-rec invalid rewrite alac-dep-rec,
                               end-write,




                              |||| 06.02.2019 MUKARNAS PERA HAVALE MAILORDER ISLEMI OLAYI
                               if konuk-folio > 0 and depkod2-havale = 1 and genel2-mah-havale-virman-aktif = 1
                                                      
                                      initialize alac-dep-anah alac-dep-tutar-tl

                                      move depkod2k-matrah-hesap  to alac-dep-hesap

                                      move "B"   to alac-dep-ba
                                      if depkod-turu = 2 then
                                            move "C" to alac-dep-corr
                                      end-if
                                      read alac-dep no lock invalid continue,
                                      end-read,
                                           compute alac-dep-tutar-tl rounded = alac-dep-tutar-tl + 
                                           ( onkasa-tutar-tl -  ONKASA-CORR-TUTAR-TL )

                                           move "Gunluk Tahsilatlar Geregi" to alac-dep-aciklama
                                      write alac-dep-rec invalid rewrite alac-dep-rec,
                                      end-write,


                                      initialize alac-dep-anah alac-dep-tutar-tl

                                      initialize acenta-rec  
                                      move konuk-acenta to ACENTA-KODU
                                      read acenta no lock invalid
                                             continue
                                      not invalid
                                              move ACENTA-avano  to alac-dep-hesap
                                      end-read
 
                                      move "A"   to alac-dep-ba

                                      if depkod-turu = 2 then
                                            move "C" to alac-dep-corr
                                      end-if
                                      read alac-dep no lock invalid continue,
                                      end-read,
                                           compute alac-dep-tutar-tl rounded = alac-dep-tutar-tl + 
                                           ( onkasa-tutar-tl -  ONKASA-CORR-TUTAR-TL )
                                           
                                           move "Gunluk Tahsilatlar Geregi" to alac-dep-aciklama
                                      write alac-dep-rec invalid rewrite alac-dep-rec,
                                      end-write,

                               end-if
                               |||| 06.02.2019 MUKARNAS PERA HAVALE MAILORDER ISLEMI OLAYI
 
 

                         end-if
                         evaluate depkod-turu

                              when  4 
                              perform kredi-bul thru kredi-bul-exit
                               open input depkod2
                               move depkod-kodu to depkod2-kodu
                               read depkod2 no lock invalid continue end-read
                                perform depkod2-tr
                               close depkod2
                                  
                              if fark-kes = 1 and depkod2-matrah-hesap not = spaces then
                               initialize ara-fark-rec
                               start ara-fark key > ara-fark-anah 
                                  invalid continue
                                  not invalid
                                  perform until  fs-ara-fark = "10"
                                    read ara-fark next no lock end move "10" to fs-ara-fark
                                     not end
                                     if ara-fark-fol-tutar-tl not = ara-fark-fat-tutar-tl then
                                 
                                      MOVE ARA-fark-FOlio to konuk-folio
                                      open input konuk acenta
                                      read konuk no lock invalid
                                        initialize konuk-rec acenta-rec
                                      end-read                                        
                                      if onkpara-referans-var = 1 and ref-var = 1 then
                                               if onkpara-referans-nerden <> 2
                                                   if xkonum-ref(KONUK-ODA-konumu) not = ref
                                                          exit perform cycle
                                                   end-if
                                              else
                                                    open input odalar
                                                       initialize odalar-rec
                                                       move KONUK-ODANO to odalar-anah
                                                       read odalar no lock invalid
                                                               continue
                                                       not invalid
                                                    if odalar-referans not > 0
                                                        move 1 to odalar-referans
                                                    end-if
                                                            if odalar-referans not = ref 
                                                            and genel-muha-ref not > 0  and ref > 0
                                                            and ref > 0
                                                                    close odalar
                                                                  exit perform cycle
                                                            end-if
                                                       end-read
                                                    close odalar
                                                end-if
                                        end-if
                                      move konuk-acenta to acenta-kodu
                                      read acenta no lock invalid continue end-read
                                       close konuk acenta
                                initialize ara-alac-dep-rec ara-borc-dep-rec
                                move depkod2-matrah-hesap  to ara-alac-dep-hesap ara-borc-kars-kodu
                                move depkod-kodu to ara-alac-dep-kodu ara-borc-dep-kodu
                                if ara-fark-fol-tutar-tl <  ara-fark-fat-tutar-tl 
                                move "A" to  ara-alac-dep-ba
                                move "B" to  ara-borc-dep-ba
                                else
                                move "B" to  ara-alac-dep-ba
                                move "A" to  ara-borc-dep-ba
                                end-if
                                move konuk-acenta   to ara-alac-dep-acenno
                                move konuk-voucher  to ara-alac-dep-voucher
                                move konuk-eb to ara-alac-dep-eb
***********************kaya otele ozel yapildi parametrik yap
                                move "389-01-001-0001" to ara-borc-dep-hesap
**************************************
                                read ara-alac-dep invalid continue end-read
                                read ara-borc-dep invalid continue end-read
                                if ara-fark-fol-tutar-tl <  ara-fark-fat-tutar-tl 
                                   compute ara-alac-dep-tutar-tl rounded = ara-alac-dep-tutar-tl + 
                                      ara-fark-fat-tutar-tl - ara-fark-fol-tutar-tl
                                   compute ara-alac-dep-tutar-dv rounded = ara-alac-dep-tutar-dv + 
                                      ara-fark-fat-tutar-dv - ara-fark-fol-tutar-dv
                                   compute ara-alac-dep-doviz-kuru rounded = 
                                              ara-alac-dep-tutar-tl /  ara-alac-dep-tutar-dv 
                                    compute ara-borc-dep-tutar-tl rounded = ara-borc-dep-tutar-tl + 
                                      ara-fark-fat-tutar-tl - ara-fark-fol-tutar-tl
                                   compute ara-borc-dep-tutar-dv rounded = ara-borc-dep-tutar-dv + 
                                      ara-fark-fat-tutar-dv - ara-fark-fol-tutar-dv
                                   compute ara-borc-dep-doviz-kuru rounded = 
                                              ara-borc-dep-tutar-tl /  ara-borc-dep-tutar-dv
                                 else
                                   compute ara-alac-dep-tutar-tl rounded = ara-alac-dep-tutar-tl + 
                                      ara-fark-fol-tutar-tl - ara-fark-fat-tutar-tl
                                   compute ara-alac-dep-tutar-dv rounded = ara-alac-dep-tutar-dv + 
                                      ara-fark-fol-tutar-dv - ara-fark-fat-tutar-dv
                                   compute ara-alac-dep-doviz-kuru rounded = 
                                              ara-alac-dep-tutar-tl /  ara-alac-dep-tutar-dv 

                                   compute ara-borc-dep-tutar-tl rounded = ara-borc-dep-tutar-tl + 
                                      ara-fark-fol-tutar-tl - ara-fark-fat-tutar-tl
                                   compute ara-borc-dep-tutar-dv rounded = ara-borc-dep-tutar-dv + 
                                      ara-fark-fol-tutar-dv - ara-fark-fat-tutar-dv
                                   compute ara-borc-dep-doviz-kuru rounded = 
                                              ara-borc-dep-tutar-tl /  ara-borc-dep-tutar-dv 
                                end-if

                                  initialize ara-alac-dep-aciklama ara-borc-dep-aciklama
                                 
                                 move onk-gun to ara-alac-dep-aciklama(1:2)
                                 move onk-ay to ara-alac-dep-aciklama(4:2)
                                 move "/"  to ara-alac-dep-aciklama(3:1)
                                 move  ara-alac-dep-aciklama to ara-borc-dep-aciklama


                                move " City Ledger Farklari" to ara-borc-dep-aciklama(7:)
                                move acenta-adi to ara-alac-dep-aciklama(7:)
                                 move konuk-voucher to ara-alac-dep-aciklama(17:)
                                 move " C/L Farki" to ara-alac-dep-aciklama(27:)


                                write ara-alac-dep-rec invalid rewrite ara-alac-dep-rec end-write
                                write ara-borc-dep-rec invalid rewrite ara-borc-dep-rec end-write
                                END-IF
                                end-read 
                                end-perform

                                end-start
                                 





*********************************************
                                initialize ara-alac-dep-rec ara-borc-dep-rec
                                move  depkod2-kasa-hesap  to ara-alac-dep-hesap ara-borc-kars-kodu
                                move depkod-kodu to ara-alac-dep-kodu ara-borc-dep-kodu
                                move "A" to  ara-alac-dep-ba
                                move "B" to  ara-borc-dep-ba
***********************kaya otele ozel yapildi parametrik yap
                                move "389-01-001-0001" to ara-borc-dep-hesap
**************************************
                                read ara-alac-dep invalid continue end-read
                                read ara-borc-dep invalid continue end-read
                                compute ara-alac-dep-tutar-tl rounded = ara-alac-dep-tutar-tl + 
                                  onkasa-tutar-tl - ONKASA-CORR-TUTAR-TL 
                                compute ara-borc-dep-tutar-tl rounded = ara-borc-dep-tutar-tl + 
                                  onkasa-tutar-tl - ONKASA-CORR-TUTAR-TL 
                                 
                                 move onk-gun to ara-alac-dep-aciklama(1:2)
                                 move onk-ay to ara-alac-dep-aciklama(4:2)
                                 move "/" to ara-alac-dep-aciklama(3:1)
                                move "Onburo Krediye Kaldirilanlar" to ara-alac-dep-aciklama(7:)
                                move ara-alac-dep-aciklama to ara-borc-dep-aciklama
                                write ara-alac-dep-rec invalid rewrite ara-alac-dep-rec end-write
                                write ara-borc-dep-rec invalid rewrite ara-borc-dep-rec end-write
                             end-if
                              
*                              
                              when  other continue
                       if depkod-mahsup-detay = "E" then
                           if depkod2-kasa-hesap not = spaces and 
                              depkod-kdv-hesap    not = spaces and
                              depkod-kdv              = zeroes
                                 move "H" to kdvli
                                 perform alac-departman-detay-bul thru alac-departman-detay-bul-exit
                            end-if
                          if depkod2-kasa-hesap not = spaces and 
                             depkod-kdv-hesap        = spaces 
                                 move "H" to kdvli
                                 perform alac-departman-detay-bul thru alac-departman-detay-bul-exit
                            end-if
                           if depkod2-kasa-hesap not = spaces and 
                             depkod-kdv-hesap    not = spaces and
                             depkod-kdv          not = zeroes
                                   move "E" to kdvli
                                   perform alac-departman-detay-bul thru alac-departman-detay-bul-exit
                            end-if
                        else
                          initialize alac-dep-rec,
                          if depkod2-kasa-hesap not = spaces and 
                             depkod-kdv-hesap    not = spaces and
                             depkod-kdv              = zeroes
                             initialize alac-dep-anah
                            if depkod-matrah-ba = "B"
                               move "B"   to alac-dep-ba
                            else
                               move "A"   to alac-dep-ba
                            end-if
                             move depkod2-kasa-hesap   to alac-dep-hesap
                              if depkod-turu = 2 then
                           move "C" to alac-dep-corr
                           end-if
                             read alac-dep no lock invalid continue,
                             end-read,
                                  compute alac-dep-tutar-tl rounded = alac-dep-tutar-tl + 
                                  onkasa-tutar-tl -  ONKASA-CORR-TUTAR-TL 
                                  move "Gunluk Tahsilatlar Geregi" to alac-dep-aciklama
                             write alac-dep-rec invalid rewrite alac-dep-rec,
                             end-write,
                          end-if
                          initialize alac-dep-rec,
                          if depkod2-kasa-hesap not = spaces and 
                             depkod-kdv-hesap        = spaces 
                             initialize alac-dep-anah
                            if depkod-matrah-ba = "B"
                               move "B"   to alac-dep-ba
                            else
                               move "A"   to alac-dep-ba
                            end-if
                             move depkod2-kasa-hesap   to alac-dep-hesap
                              if depkod-turu = 2 then
                           move "C" to alac-dep-corr
                           end-if
                           move depkod-kodu to alac-dep-kodu
                             read alac-dep no lock invalid continue,
                             end-read,
                                  compute alac-dep-tutar-tl rounded = alac-dep-tutar-tl + 
                                  onkasa-tutar-tl - ONKASA-CORR-TUTAR-TL 
                                   move onk-gun to alac-dep-aciklama(1:2)
                                 move onk-ay to alac-dep-aciklama(4:2)
                                 
                                 move "/" to alac-dep-aciklama(3:1)
                                 move depkod-adi(1:15) to  
                                 alac-dep-aciklama (7:15)

                                 move " Tahsilati" to   alac-dep-aciklama(23:)
*                                  if depkod2-kasa-hesap(1:3) not = "100"

*                                   if  takas-kk-kodu not = 0
                              
*                                     compute alac-dep-tutar-dv rounded =  alac-dep-tutar-dv + ONKASA-TUTAR-DV 
*                                          move "0022" to   alac-dep-acenno
*                                           move "01" to    ara-alac-dep-banka  
*   
*                                        move takas-kk-kodu to  alac-dep-doviz   
*                                     
*                                      compute  alac-dep-doviz-kuru rounded =  alac-dep-tutar-tl / alac-dep-tutar-dv
*                                      else
*                                      initialize  alac-dep-doviz-kuru   alac-dep-tutar-dv  alac-dep-doviz
*                                      end-if
*                                     
*                                end-if
****                                  move "Gunluk Tahsilatlar Geregi" to alac-dep-aciklama
                             write alac-dep-rec invalid rewrite alac-dep-rec,
                             end-write,
                             if fark-kes = 1 then
                                initialize ara-alac-dep-rec ara-borc-dep-rec
                                move alac-dep-hesap to ara-alac-dep-hesap ara-borc-kars-kodu
                                move depkod-kodu to ara-alac-dep-kodu ara-borc-dep-kodu
                                move "A" to  ara-alac-dep-ba
                                move "B" to  ara-borc-dep-ba
***********************kaya otele ozel yapildi parametrik yap
                                move "389-01-001-0001" to ara-borc-dep-hesap
**************************************
                                read ara-alac-dep invalid continue end-read
                                read ara-borc-dep invalid continue end-read
                                compute ara-alac-dep-tutar-tl rounded = ara-alac-dep-tutar-tl + 
                                  onkasa-tutar-tl - ONKASA-CORR-TUTAR-TL 
                                compute ara-borc-dep-tutar-tl rounded = ara-borc-dep-tutar-tl + 
                                  onkasa-tutar-tl - ONKASA-CORR-TUTAR-TL 
                                move alac-dep-aciklama to ara-alac-dep-aciklama
                                move alac-dep-aciklama to ara-borc-dep-aciklama
                                write ara-alac-dep-rec invalid rewrite ara-alac-dep-rec end-write
                                write ara-borc-dep-rec invalid rewrite ara-borc-dep-rec end-write
                             end-if
                          end-if
                          initialize alac-dep-rec,
                          if depkod2-kasa-hesap not = spaces and 
                             depkod-kdv-hesap    not = spaces and
                             depkod-kdv          not = zeroes
                            if depkod-matrah-ba = "B"
                               move "B"   to alac-dep-ba
                            else
                               move "A"   to alac-dep-ba
                            end-if
                             move depkod2-kasa-hesap   to alac-dep-hesap
                            if depkod-turu = 2 then
                           move "C" to alac-dep-corr
                           end-if
                             read alac-dep no lock invalid continue,
                             end-read,
                                 compute alac-dep-tutar-tl rounded = 
                                         (alac-dep-tutar-tl + 
                                         (((onkasa-tutar-tl -  ONKASA-CORR-TUTAR-TL ) * 100) / 
                                         (100 + depkod-kdv)))
                                           
                                 if depkod2-kasa-hesap(1:3) not = "100"
                                   if  takas-kk-kodu not = spaces
                                     compute alac-dep-tutar-dv rounded =  alac-dep-tutar-dv + ONKASA-TUTAR-DV 
                                          move "0022" to   alac-dep-acenno
                                           move "01" to    ara-alac-dep-banka  
   
                                        move takas-kk-kodu to  alac-dep-doviz   
                                     
                                      compute  alac-dep-doviz-kuru rounded =  alac-dep-tutar-tl / alac-dep-tutar-dv
                                      end-if
                                         
                                end-if
                                  move "Gunluk Tahsilatlar Geregi" to alac-dep-aciklama
                             write alac-dep-rec invalid rewrite alac-dep-rec,
                             end-write,
                              initialize alac-dep-rec,
                              move depkod-kdv-hesap      to alac-dep-hesap
                            if depkod-matrah-ba = "B"
                               move "B"   to alac-dep-ba
                            else
                               move "A"   to alac-dep-ba
                            end-if
                             if depkod-turu = 2 then
                           move "C" to alac-dep-corr
                           end-if
                             read alac-dep no lock invalid continue,
                             end-read,
                                 compute alac-dep-tutar-tl rounded = 
                                         (alac-dep-tutar-tl
                                         + ((onkasa-tutar-tl - ONKASA-CORR-TUTAR-TL )
                                         - ((onkasa-tutar-tl - ONKASA-CORR-TUTAR-TL ) * 100)
                                         / (100 + depkod-kdv)))
                                  move "Gunluk Tahsilatlar Geregi" to alac-dep-aciklama
                             write alac-dep-rec invalid rewrite alac-dep-rec,
                             end-write,
                          end-if
                        end-if
             end-evaluate

                    end-evaluate,
          
    .   
*
************************************************************ *
*
kacgun-bul.
       open input takvim 
       initialize takvim-rec takas-acenta-gun
        
        move konuk-gel-tar to takvim-anah
        start takvim key > takvim-anah 
            invalid
            not invalid   
             perform until fs-takvim =  "10"  
               read takvim next no lock
                  end move "10" to fs-takvim
                  not end
                  if takvim-anah < konuk-git-tar then
                      add 1 to takas-acenta-gun
                    else
                       add 1 to takas-acenta-gun
                       move "10" to fs-takvim
                  end-if
               end-read
             end-perform
         end-start
         close takvim.

*
 takas-acenta-dovizleri-bul.
       
         open input acenfat
           initialize acenfat-rec
           move tarih to acenfat-tarih
           move konuk-acenta to acenfat-acenta
             start acenfat key > acenfat-anah
                invalid continue
                not invalid
                  perform until fs-acenfat = "10"
                    read acenfat next
                       end move "10" to fs-acenfat
                       not end
                       if tarih not =  acenfat-tarih
                         or konuk-acenta not = acenfat-acenta
                          move "10" to fs-acenfat
                          else
                          if acenfat-folio = konuk-folio
                                 
                             compute tl-gunluk rounded =   (ACENFAT-tl-TUTAR / acenfat-per-geceleme )
                             compute dv-gunluk rounded =   tl-gunluk / (konuk-kur-degeri)
                             compute takas-acenta-dv-tutar =  takas-acenta-dv-tutar + 
                                                           ( dv-gunluk  * acenfat-per-geceleme )
                            compute ACENFAT-GER-DV-TUTAR = dv-gunluk  * acenfat-per-geceleme 
                           if fark-kes = 1 
                           initialize ara-fark-rec
                             move konuk-folio to ara-fark-folio
                             read ara-fark invalid continue end-read
                             add ACENFAT-tl-TUTAR to ara-fark-fat-tutar-tl
                             add ACENFAT-GER-DV-TUTAR to ara-fark-fat-tutar-dv
                             write ara-fark-rec invalid rewrite ara-fark-rec end-rewrite
                           end-if
                          end-if 
                        end-if
                    end-read

                  end-perform
             end-start
         close acenfat

        
          .

 kredi-bul.
    
    move spaces to evet-hayir.
    open input romhrk konuk kur acenta.
    initialize romhrk-rec.
    move tarih        to romhrk-tarih.
    move depkod-kodu  to romhrk-depkod.
    start romhrk key not < romhrk-anah2 invalid continue,
        not invalid,

        move spaces to evet-hayir,
        perform with test after until evet,
            read romhrk next no lock end move "E" to evet-hayir,
                not end,
                if romhrk-tarih > tarih,
                          move "E" to evet-hayir,
                end-if,

                if romhrk-tarih not > tarih,
                   if romhrk-depkod = depkod-kodu,
                          modify lb-1, title = romhrk-folio
                           initialize takas-acenta-rec,
                           initialize konuk-rec,
                           move romhrk-folio    to konuk-folio,
                           read konuk no lock invalid 
                                move spaces to konuk-adi konuk-soyadi,
                           end-read,
                           initialize cast-rec                             ||| firat ekleme 21/08/2019
                           move romhrk-tarih to cast-tarih
                           move konuk-rez-no to cast-rez-no
                           read cast no lock invalid
                                move konuk-oda-konumu to cast-oda-konumu
                                move konuk-odano      to cast-oda-no
                           end-read                                        ||
                           if onkpara-referans-var = 1 and ref-var = 1 then
                                      if onkpara-referans-nerden <> 2
*                                           if xkonum-ref(KONUK-ODA-konumu) not = ref   ||| firat ekleme 21/08/2019
*                                                  exit perform cycle
*                                           end-if

                                           if xkonum-ref(cast-oda-konumu) not = ref
                                                  exit perform cycle
                                           end-if                                     ||

                                      else
                                            open input odalar
                                               initialize odalar-rec
*                                               move KONUK-ODANO to odalar-anah        ||| firat ekleme 21/08/2019
                                               move cast-oda-no to odalar-anah         ||
                                               read odalar no lock invalid
                                                       continue
                                               not invalid
                                                   if odalar-referans not > 0
                                                        move 1 to odalar-referans
                                                    end-if
                                                    if odalar-referans not = ref and 
                                                    genel-muha-ref not > 0 and ref > 0
                                                            close odalar
                                                          exit perform cycle
                                                    end-if
                                               end-read
                                            close odalar
                                        end-if
                           end-if 
                           initialize kur-rec takas-acenta-rec acenta-rec
                           move konuk-acenta    to takas-acenta-kodu 
                           move takas-acenta-kodu   to acenta-kodu

                          read acenta no lock invalid 
                               continue

                          end-read
                           if konuk-kur-aygun = "A"
                              move 01         to kur-gun
                           else 
                             move konuk-gel-gun to kur-gun
                           end-if
                           move konuk-gel-ay     to kur-ay
                           move konuk-gel-yil    to kur-yil
                           move konuk-banka      to kur-banka takas-acenta-banka
                           move konuk-doviz      to kur-doviz takas-acenta-doviz
************************************   EARLY BOOK            
                            move konuk-gel-tar to takas-acenta-gel-tar
                            move konuk-eb      to takas-acenta-eb
                           
*                            move konuk-pazar   to takas-acenta-pazar
************************************ 
                                      
                           if acenta-detay-mahsup = "E" then
                               move KONUK-ODANO to takas-acenta-odano
                           end-if
                            move konuk-fat-no to takas-acenta-fatura-no               
                           read takas-acenta no lock invalid continue
                           end-read
                            if konuk-fat-no > 0 then  
                            move konuk-folio to takas-acenta-folno

                            end-if,
                           compute takas-acenta-tl-tutar rounded =  
                                   takas-acenta-tl-tutar + romhrk-tl-tutar 
                              if konuk-kur-degeri = 0 then 
                                   move 1 to konuk-kur-degeri  
                               end-if
                               perform kacgun-bul
                               
                               perform takas-acenta-dovizleri-bul
                              move konuk-kur-degeri to takas-acenta-doviz-kuru doviz-alis
*                    
                          if fark-kes = 1 then
                          
                             initialize ara-fark-rec
                             move konuk-folio to ara-fark-folio
                             read ara-fark invalid continue end-read
                             add  romhrk-tl-tutar      to ara-fark-fol-tutar-tl
                             compute ara-fark-fol-tutar-dv rounded =  ara-fark-fol-tutar-dv +
                              ( romhrk-tl-tutar / konuk-kur-degeri )
                             compute ara-fark-fol-doviz-kuru rounded =
                                       ara-fark-fol-tutar-tl / ara-fark-fol-tutar-dv
                             compute ara-fark-fat-doviz-kuru rounded =
                                       ara-fark-fat-tutar-tl / ara-fark-fat-tutar-dv
                             write ara-fark-rec invalid rewrite ara-fark-rec end-rewrite
                             
                          end-if
                            
                           write takas-acenta-rec invalid
                                 rewrite takas-acenta-rec end-rewrite
                           end-write,
                   end-if, 
                end-if,
            end-read,
        end-perform,
    end-start.
    close romhrk.

    

    move spaces to evet-hayir.
    open input exthrk.
    initialize exthrk-rec.
    move tarih          to exthrk-tarih.
    move depkod-kodu  to exthrk-depkod.
    start exthrk key not < exthrk-anah2 invalid continue,
        not invalid,

        move spaces to evet-hayir,
        perform with test after until evet,
            read exthrk next no lock end move "E" to evet-hayir,
                not end,
                if exthrk-tarih > tarih,
                          move "E" to evet-hayir,
                end-if,

                if exthrk-tarih not > tarih,
                   if exthrk-depkod = depkod-kodu,
                          modify lb-1, title = exthrk-folio
                           initialize takas-acenta-rec,
                           initialize konuk-rec,
                           move exthrk-folio    to konuk-folio,
                           read konuk no lock invalid 
                                move spaces to konuk-adi konuk-soyadi,
                           end-read,   

                           initialize cast-rec                             ||| firat ekleme 21/08/2019
                           move exthrk-tarih       to cast-tarih
                           move konuk-extra-rez-no to cast-rez-no
                           read cast no lock invalid
                                move konuk-oda-konumu to cast-oda-konumu
                                move konuk-odano      to cast-oda-no
                           end-read                                        ||

                           if onkpara-referans-var = 1 and ref-var = 1 then
                                              if onkpara-referans-nerden <> 2
                                                   if xkonum-ref(cast-oda-konumu) not = ref    ||| firat ekleme 21/08/2019
                                                          exit perform cycle
                                                   end-if                                        

*                                                   if xkonum-ref(konuk-oda-konumu) not = ref   
*                                                          exit perform cycle                   
*                                                   end-if                                       ||                         
                                              else
                                                    open input odalar
                                                       initialize odalar-rec
                                                       move cast-oda-no to odalar-anah         ||| firat ekleme 21/08/2019
*                                                       move KONUK-ODANO to odalar-anah        ||
                                                       read odalar no lock invalid
                                                               continue
                                                       not invalid
                                                   if odalar-referans not > 0
                                                        move 1 to odalar-referans
                                                    end-if
                                                            if odalar-referans not = ref and 
                                                            genel-muha-ref not > 0 and ref > 0
                                                                    close odalar
                                                                  exit perform cycle
                                                            end-if
                                                       end-read
                                                    close odalar
                                                end-if

                           end-if
                           initialize kur-rec takas-acenta-rec
                           move konuk-acenta    to takas-acenta-kodu,
                           if konuk-kur-aygun = "A"
                              move 01         to kur-gun
                           else 
                             move konuk-gel-gun to kur-gun
                           end-if
                           move konuk-gel-ay     to kur-ay
                           move konuk-gel-yil    to kur-yil
                           move konuk-banka      to kur-banka takas-acenta-banka
                           move konuk-doviz      to kur-doviz takas-acenta-doviz
************************************   EARLY BOOK            
                            move konuk-gel-tar to takas-acenta-gel-tar
                             move konuk-eb      to takas-acenta-eb
*                            move konuk-pazar   to takas-acenta-pazar
************************************  
                                                    
                           if acenta-detay-mahsup = "E" then
                                move KONUK-ODANO to takas-acenta-odano
                           end-if
                            move konuk-fat-no to takas-acenta-fatura-no
                           read takas-acenta no lock invalid continue
                           end-read
                           move konuk-folio to takas-acenta-folno,
                           compute takas-acenta-tl-tutar rounded =  
                                   takas-acenta-tl-tutar + exthrk-tl-tutar 
                           
                                   
                                   
                           read kur no lock invalid continue
                            not invalid
                                  evaluate true
                                  when mgenel-d-e = "D" and mgenel-a-s = "A"
                                       move doviz-alis   to takas-acenta-doviz-kuru
                                       compute takas-acenta-dv-tutar rounded = 
                                               ( takas-acenta-dv-tutar +
                                               (exthrk-tl-tutar / doviz-alis))
                                  when mgenel-d-e = "D" and mgenel-a-s = "S"
                                       move doviz-satis  to takas-acenta-doviz-kuru
                                       compute takas-acenta-dv-tutar rounded = 
                                               ( takas-acenta-dv-tutar +
                                               (exthrk-tl-tutar / doviz-satis))
                                  when mgenel-d-e = "E" and mgenel-a-s = "A"
                                       move efektif-alis    to takas-acenta-doviz-kuru
                                       compute takas-acenta-dv-tutar rounded = 
                                               ( takas-acenta-dv-tutar +
                                               (exthrk-tl-tutar / efektif-alis))
                                  when mgenel-d-e = "E" and mgenel-a-s = "S"
                                       move efektif-satis   to takas-acenta-doviz-kuru
                                       compute takas-acenta-dv-tutar rounded = 
                                               ( takas-acenta-dv-tutar +
                                               (exthrk-tl-tutar / efektif-satis))
                                  when other
                                       move doviz-alis   to takas-acenta-doviz-kuru
                                       compute takas-acenta-dv-tutar rounded = 
                                               ( takas-acenta-dv-tutar +
                                               (exthrk-tl-tutar / doviz-alis))
                                  end-evaluate 
                           end-read
                           write takas-acenta-rec invalid
                                 rewrite takas-acenta-rec end-rewrite
                           end-write,
                   end-if, 
                end-if,
            end-read,
        end-perform,
    end-start.
    close exthrk kur.

    move spaces to evet-hayir.
    initialize takas-acenta-rec.

    start takas-acenta key not < takas-acenta-anah invalid continue,
        not invalid,

        move spaces to evet-hayir,
        perform with test after until evet,
            read takas-acenta next no lock end move "E" to evet-hayir,
                not end,
                   initialize alac-dep-rec,
                          modify lb-1, title = takas-acenta-kodu
                   move takas-acenta-kodu   to acenta-kodu
                   read acenta no lock invalid 
              
                               display message box 
                                "Tanimsiz Acenta",
                                icon mb_error_icon
                                title "Hata"
                                move 1 to enable-1 
                                move 0 to enable-2
                                display form1
*/-----------------------------\*  
*/---------DIL AYARLA----------\*    
*/-----------------------------\*    
                                perform dil-ayarla-proc
*/-----------------------------\*         
                                move 4 to accept-control
                                move 4 to control-id
                                exit paragraph
                                close kasa-borc-dep kasa-alac-dep borc-dep alac-dep takas-acenta
                                delete file kasa-borc-dep kasa-alac-dep borc-dep alac-dep takas-acenta
                   not invalid
                        if depkod-matrah-ba = "B"
                           move "B"   to alac-dep-ba
                        else
                           move "A"   to alac-dep-ba
                        end-if
                        
                        move acenta-muhno       to alac-dep-hesap
                        move takas-acenta-banka to alac-dep-banka
                        move takas-acenta-doviz to alac-dep-doviz
                        move takas-acenta-kodu  to alac-dep-acenno    | Ayni hesap noya iki acenta atilirsa - mami
                        if acenta-detay-mahsup = "E" then
                           move takas-acenta-odano to alac-dep-odano
                        end-if

************************************   EARLY BOOK            
                         move takas-acenta-gel-tar to alac-dep-gel-tar
                         move takas-acenta-eb      to alac-dep-eb
*                        move takas-acenta-pazar   to alac-dep-pazar

************************************                           
                        move takas-acenta-folno    to konuk-folio,
                           read konuk no lock invalid 
                                move spaces to konuk-adi konuk-soyadi,
                           end-read
                        if onkpara-referans-var = 1 and ref-var = 1 then
                                      if onkpara-referans-nerden <> 2
                                           if xkonum-ref(KONUK-ODA-konumu) not = ref
                                                  exit perform cycle
                                           end-if
                                      else
                                            open input odalar
                                               initialize odalar-rec
                                               move KONUK-ODANO to odalar-anah
                                               read odalar no lock invalid
                                                       continue
                                               not invalid
                                                   if odalar-referans not > 0
                                                        move 1 to odalar-referans
                                                    end-if
                                                    if odalar-referans not = ref and 
                                                    genel-muha-ref not > 0   and ref > 0
                                                            close odalar
                                                          exit perform cycle
                                                    end-if
                                               end-read
                                            close odalar
                                        end-if
                           end-if
                        move takas-acenta-fatura-no   to alac-dep-fatura-no
                        
                        read alac-dep no lock invalid
*                           if konuk-fat-no = 0 then stop " " end-if
                           move konuk-fat-no  to alac-dep-aciklama
                           move " Ft"         to alac-dep-aciklama(7:3) 
                        end-read
*                        if alac-dep-eb = "E" then 
*                        compute dusulecek rounded = ( takas-acenta-tl-tutar * ((acenta-av-oran) / 100))
*                        compute alac-dep-tutar-tl rounded =  
*                                alac-dep-tutar-tl + ( takas-acenta-tl-tutar - dusulecek )
*                        compute dusulecek rounded = ( takas-acenta-dv-tutar * ((acenta-av-oran) / 100))
*                        compute alac-dep-tutar-dv rounded =  
*                                alac-dep-tutar-dv + ( takas-acenta-dv-tutar - dusulecek )
*                        else
                        compute alac-dep-tutar-tl rounded =  
                                alac-dep-tutar-tl + takas-acenta-tl-tutar
                        compute alac-dep-tutar-dv rounded =  
                                alac-dep-tutar-dv + takas-acenta-dv-tutar
*                        end-if
*********************************                        
                        
                        move takas-acenta-gel-tar(7:2) to alac-dep-aciklama(11:2)                        
                        move "/" to alac-dep-aciklama(13:1)                        
                        move takas-acenta-gel-tar(5:2) to alac-dep-aciklama(14:2)                        
                        move "-" to alac-dep-aciklama(16:01)
                        move gun to alac-dep-aciklama(17:2)
                        move "/" to alac-dep-aciklama(19:1)
                        move ay  to alac-dep-aciklama(20:2)
                        move acenta-adi to alac-dep-aciklama(23:10)
                        if alac-dep-eb = "E" then 
                                move "E/B" to alac-dep-aciklama(35:3)       
                        end-if
*                        move alac-dep-pazar        to alac-dep-aciklama(35:2)
*                        if alac-dep-pazar not = spaces
*                                move "Knk" to alac-dep-aciklama(38:) 
*                                else 
*                                move "Extra Harcamalari" to alac-dep-aciklama(22:)       
*                        end-if
***********************************                                 
                        if acenta-detay-mahsup = "E" then
                        initialize alac-dep-aciklama
                        move gun to alac-dep-aciklama (11:2)
                        move "/" to alac-dep-aciklama(13:1)
                        move ay  to alac-dep-aciklama(14:2)
*                        move "Cikislar-" to alac-dep-aciklama(17:)
                                
                        move acenta-kodu to alac-dep-aciklama(17:4)
                        move takas-acenta-odano to alac-dep-aciklama(22:4)
                        move konuk-adi        to alac-dep-aciklama(27:7)
                        move konuk-soyadi     to alac-dep-aciklama(35:)

 
                          end-if 
                       

                        move  takas-acenta-doviz-kuru to alac-dep-doviz-kuru
                        write alac-dep-rec invalid
                              rewrite alac-dep-rec end-rewrite
                        end-write,
*                        if takas-acenta-eb = "E" and acenta-av-oran > 0 then 
*                           perform  acenta-avans-yaz
*                        end-if
                   end-read,
            end-read,
        end-perform,
    end-start.
    close acenta konuk.
    move spaces to evet-hayir.

 kredi-bul-exit.
     exit.
*
 acenta-avans-yaz.
               initialize alac-dep-rec      
               if depkod-matrah-ba = "B"
                           move "B"   to alac-dep-ba
                        else
                           move "A"   to alac-dep-ba
                        end-if
                        
                        move acenta-avano       to alac-dep-hesap
                        move takas-acenta-banka to alac-dep-banka
                        move takas-acenta-doviz to alac-dep-doviz
                        move takas-acenta-kodu  to alac-dep-acenno    | Ayni hesap noya iki acenta atilirsa - mami
                        if acenta-detay-mahsup = "E" then
                                move takas-acenta-odano to alac-dep-odano
                        end-if

************************************   EARLY BOOK            
                        move takas-acenta-gel-tar to alac-dep-gel-tar
                        move takas-acenta-eb      to alac-dep-eb
*                        move takas-acenta-pazar   to alac-dep-pazar

************************************                           
                        move takas-acenta-folno    to konuk-folio,
                           read konuk no lock invalid 
                                move spaces to konuk-adi konuk-soyadi,
                           end-read

                       
                        read alac-dep no lock invalid 
                          
                           move konuk-fat-no to alac-dep-aciklama
                           move " Ft"    to alac-dep-aciklama(7:3)
                        end-read
                        
                        compute alac-dep-tutar-tl rounded =  
                                alac-dep-tutar-tl + ( takas-acenta-tl-tutar * ((acenta-av-oran) / 100))
                        compute alac-dep-tutar-dv rounded =  
                                alac-dep-tutar-dv + ( takas-acenta-dv-tutar * (( acenta-av-oran) / 100))
                        
*********************************                        
                        
                        move takas-acenta-gel-tar(7:2) to alac-dep-aciklama(11:2)                        
                        move "/" to alac-dep-aciklama(13:1)                        
                        move takas-acenta-gel-tar(5:2) to alac-dep-aciklama(14:2)                        
                        move "-" to alac-dep-aciklama(16:01)
                        move gun to alac-dep-aciklama(17:2)
                        move "/" to alac-dep-aciklama(19:1)
                        move ay  to alac-dep-aciklama(20:2)
                        move acenta-adi to alac-dep-aciklama(23:10)
                        if alac-dep-eb = "E" then 
                                move "E/B" to alac-dep-aciklama(35:3)       
                        end-if
*                        move alac-dep-pazar        to alac-dep-aciklama(35:2)
*                        if alac-dep-pazar not = spaces
*                                move "Knk" to alac-dep-aciklama(38:) 
*                                else 
*                                move "Extra Harcamalari" to alac-dep-aciklama(22:)       
*                        end-if
***********************************                                 
                        
                        

                        if acenta-detay-mahsup = "E" then
                        initialize alac-dep-aciklama
                        move gun to alac-dep-aciklama (11:2)
                        move "/" to alac-dep-aciklama(13:1)
                        move ay  to alac-dep-aciklama(14:2)
*                        move "Cikislar-" to alac-dep-aciklama(17:)
                        move acenta-kodu to alac-dep-aciklama(17:4)
                        move takas-acenta-odano to alac-dep-aciklama(22:4),
                        move konuk-adi        to alac-dep-aciklama(27:7)
                        move konuk-soyadi     to alac-dep-aciklama(35:)
                          end-if 
                       

                        move  takas-acenta-doviz-kuru to alac-dep-doviz-kuru
                        write alac-dep-rec invalid
                              rewrite alac-dep-rec end-rewrite
                        end-write,
        
         
         .
*
 alac-departman-detay-bul.
    move spaces to evet-hayir.
    open input romhrk konuk yromhrk hrk2 nt .
    initialize romhrk-rec.
    move tarih        to romhrk-tarih.
    move depkod-kodu  to romhrk-depkod.
    start romhrk key not < romhrk-anah2 invalid continue,
        not invalid,

        move spaces to evet-hayir,
        perform with test after until evet,
            read romhrk next no lock end move "E" to evet-hayir,
                not end,
                if romhrk-tarih > tarih,
                          move "E" to evet-hayir,
                end-if,   

                if romhrk-tarih not > tarih,
                          modify lb-1, title = romhrk-folio
                   if romhrk-depkod = depkod-kodu,                      
                           initialize alac-dep-rec,
                           initialize konuk-rec,
                           move romhrk-folio    to konuk-folio,
                           read konuk no lock invalid 
                                move spaces to konuk-adi konuk-soyadi,
                           end-read,
                           initialize cast-rec                             ||| firat ekleme 21/08/2019
                           move romhrk-tarih to cast-tarih
                           move konuk-rez-no to cast-rez-no
                           read cast no lock invalid
                                move konuk-oda-konumu to cast-oda-konumu
                                move konuk-odano      to cast-oda-no
                           end-read                                        ||
                           if onkpara-referans-var = 1 and ref-var = 1 then
                              if onkpara-referans-nerden <> 2
*                                   if xkonum-ref(KONUK-ODA-konumu) not = ref ||| firat ekleme 21/08/2019
*                                          exit perform cycle
*                                   end-if                                    
                                   if xkonum-ref(cast-oda-konumu) not = ref
                                          exit perform cycle
                                   end-if                                       ||
                              else
                                    open input odalar
                                       initialize odalar-rec
                                       move cast-oda-no to odalar-anah      ||| firat ekleme 21/08/2019
*                                       move KONUK-ODANO to odalar-anah     ||
                                       read odalar no lock invalid
                                               continue
                                       not invalid
                                                   if odalar-referans not > 0
                                                        move 1 to odalar-referans
                                                    end-if
                                            if odalar-referans not = ref and 
                                            genel-muha-ref not > 0   and ref > 0
                                                    close odalar
                                                  exit perform cycle
                                            end-if
                                       end-read
                                    close odalar
                                end-if
        
                           end-if    
                           initialize kur-rec 
                           move depkod2-kasa-hesap  to alac-dep-hesap
                           move KONUK-ODANO            to alac-dep-odano
                           move ROMHRK-FATURA-NO       to alac-dep-fatura-no
                           if depkod-matrah-ba = "B"
                              move "B"   to alac-dep-ba
                           else
                              move "A"   to alac-dep-ba
                           end-if
                            if depkod-turu = 2 then
                           move "C" to alac-dep-corr
                           end-if
                            initialize dus-tl
                           move romhrk-anah to hrk2-anah  yromhrk-anah
                           read hrk2 no lock invalid continue
                              not invalid 
                                move hrk2-kaynak-folio to yromhrk-folio
                               read yromhrk no lock invalid continue
                                   not invalid  
                                       if yromhrk-rez-no > 1 move yromhrk-rez-no to alac-dep-gel-tar end-if
                                      perform derle-dus
                                      
                               end-read
                            end-read


                 ||////////18.09.2018/////    28.07.2021 yer degistiridli
                  if  yromhrk-dovizli-kk = 1  

                       move  yromhrk-doviz-kodu to alac-dep-doviz
                       move yromhrk-doviz-tut      to alac-dep-tutar-dv
                        
                       compute alac-dep-doviz-kuru 
                       rounded = romhrk-tl-tutar / 
                                alac-dep-tutar-dv
                                  move "0022" to  alac-dep-acenno
                                  move "01" to    alac-dep-banka  
                   end-if       
                  ||///////////  
                            

                           read alac-dep no lock invalid continue
                           end-read   
                                    subtract dus-tl from romhrk-tl-tutar


                           

                           if kdvli = "E"  then
                             compute alac-dep-tutar-tl rounded = 
                                         (alac-dep-tutar-tl +  ((romhrk-tl-tutar * 100) / (100 + depkod-kdv)))

                              else
                              compute alac-dep-tutar-tl rounded =  
                                       alac-dep-tutar-tl + romhrk-tl-tutar 
                            end-if
                            
                          string  
                                  konuk-adi   delimited by "   "
                                  " " delimited by size 
                                  konuk-soyadi   delimited by "   "
                                into  alac-dep-aciklama
                            initialize not-rec  not1
                            move  "RHR"      to NOT-DOS
                            move romhrk-anah to  NOT-DOS-ANAH 
                                           read nt no lock invalid continue
                                           end-read
                           string alac-dep-aciklama delimited by "                                     "
                           not1 delimited by "       "
                           into  alac-dep-aciklama




                            if yROMHRK-DEPKOD = genel-web-odeme
                                open i-o webbanka rezweb
                                   initialize rezweb-rec
                                   move yromhrk-rez-no to REZweb-rezno
                                   read rezweb no lock invalid
                                           continue
                                   not invalid
                                        unstring  rezweb-adres delimited by "-" into wbanka-sip wbanka-taksit
                                        initialize webbanka-rec
                                        move wbanka-sip(1:3)    to webbanka-banka-kodu
                                        move yromhrk-doviz-kodu to webbanka-doviz-kodu
                                        move wbanka-taksit(1:2) to webbanka-taksit-sayisi
                                        read webbanka no lock invalid
                                                continue
                                        not invalid
                                                move webbanka-hesap-kodu to alac-dep-hesap
                                        end-read
                                   end-read
                                 close webbanka rezweb
                          end-if

                           write alac-dep-rec invalid
                                 rewrite alac-dep-rec end-rewrite
                           end-write,  
                           if yromhrk-rez-no > 1 then 
                                if  yromhrk-derle-kaydi = 1 
                                     exit perform cycle
                                     end-if   
                               perform derle-dus
                                 subtract dus-tl from  romhrk-tl-tutar
                            end-if 
                            if kdvli = "E" then
                               initialize alac-dep-rec,
                               move depkod-kdv-hesap      to alac-dep-hesap
                               if depkod-matrah-ba = "B"
                                  move "B"   to alac-dep-ba
                                 else
                                   move "A"   to alac-dep-ba
                                end-if
                                 if depkod-turu = 2 then
                                move "C" to alac-dep-corr
                                end-if
                               read alac-dep no lock invalid continue,
                               end-read,                                
                                 compute alac-dep-tutar-tl rounded = 
                                         (alac-dep-tutar-tl + (romhrk-tl-tutar - (romhrk-tl-tutar * 100) / (100 + depkod-kdv)))
                                  move "Gunluk Tahsilatlar Geregi" to alac-dep-aciklama
                             write alac-dep-rec invalid rewrite alac-dep-rec,
                             end-write,
                                                  
                           end-if
                   end-if, 
                end-if,
            end-read,
        end-perform,
    end-start.
    close romhrk.


    move spaces to evet-hayir.
    open input exthrk.
    initialize exthrk-rec.
    move tarih        to exthrk-tarih.
    move depkod-kodu  to exthrk-depkod.
    start exthrk key not < exthrk-anah2 invalid continue,
        not invalid,

        move spaces to evet-hayir,
        perform with test after until evet,
            read exthrk next no lock end move "E" to evet-hayir,
                not end,
                if exthrk-tarih > tarih,
                          move "E" to evet-hayir,
                end-if,                                    

                if exthrk-tarih not > tarih,
                          modify lb-1, title = exthrk-folio
                   if exthrk-depkod = depkod-kodu,                       
                           initialize alac-dep-rec,
                           initialize konuk-rec,
                           move exthrk-folio    to konuk-folio,
                           read konuk no lock invalid 
                                move spaces to konuk-adi konuk-soyadi,
                           end-read,
                           initialize cast-rec                             ||| firat ekleme 21/08/2019
                           move exthrk-tarih       to cast-tarih
                           move konuk-extra-rez-no to cast-rez-no
                           read cast no lock invalid
                                move konuk-oda-konumu to cast-oda-konumu
                                move konuk-odano      to cast-oda-no
                           end-read                                        ||
                           if onkpara-referans-var =1 and ref-var = 1 then
                                      if onkpara-referans-nerden <> 2
*                                           if xkonum-ref(KONUK-ODA-konumu) not = ref  ||| firat ekleme 21/08/2019
*                                                  exit perform cycle
*                                           end-if                                   
                                           if xkonum-ref(cast-oda-konumu) not = ref
                                                  exit perform cycle
                                           end-if                                    ||
                                      else
                                            open input odalar
                                               initialize odalar-rec
                                               move cast-oda-no to odalar-anah     ||| firat ekleme 21/08/2019
*                                               move KONUK-ODANO to odalar-anah     ||
                                               read odalar no lock invalid
                                                       continue
                                               not invalid
                                                    if odalar-referans not > 0
                                                        move 1 to odalar-referans
                                                    end-if
                                                    if odalar-referans not = ref and 
                                                    genel-muha-ref not > 0 and ref > 0
                                                            close odalar
                                                          exit perform cycle
                                                    end-if
                                               end-read
                                            close odalar
                                        end-if

                           end-if
                           initialize kur-rec 
                           move depkod2-kasa-hesap     to alac-dep-hesap
                           move KONUK-ODANO            to alac-dep-odano
                           move extHRK-FATURA-NO       to alac-dep-fatura-no
                           if depkod-matrah-ba = "B"
                              move "B"   to alac-dep-ba
                           else
                              move "A"   to alac-dep-ba
                           end-if
                            if depkod-turu = 2 then
                           move "C" to alac-dep-corr
                           end-if
                                       
                           initialize dus-tl
                           move exthrk-anah to hrk2-anah  yromhrk-anah
                           read hrk2 no lock invalid continue
                              not invalid 
                                move hrk2-kaynak-folio to yromhrk-folio
                               read yromhrk no lock invalid continue
                                   not invalid                                     
                                     if  yromhrk-derle-kaydi = 1 
                                     exit perform cycle
                                     end-if  
                                      perform derle-dus
                                       if yromhrk-rez-no > 1 move yromhrk-rez-no to alac-dep-gel-tar end-if
                                       subtract dus-tl from exthrk-tl-tutar
                               end-read
                            end-read

                   ||////////18.09.2018/////  28.07.2021 yer degistiridli exthrkye konuldu
                  if  yromhrk-dovizli-kk = 1  

                       move  yromhrk-doviz-kodu to alac-dep-doviz
                       move yromhrk-doviz-tut      to alac-dep-tutar-dv
                        
                       compute alac-dep-doviz-kuru 
                       rounded = romhrk-tl-tutar / 
                                alac-dep-tutar-dv
                                  move "0022" to  alac-dep-acenno
                                  move "01" to    alac-dep-banka  
                   end-if       
                  ||///////////  

                              read alac-dep no lock invalid continue
                           end-read                                                          
                           if kdvli = "E"  then
                             compute alac-dep-tutar-tl rounded = 
                                         (alac-dep-tutar-tl +  ((exthrk-tl-tutar * 100) / (100 + depkod-kdv)))

                              else
                              compute alac-dep-tutar-tl rounded =  
                                       alac-dep-tutar-tl + exthrk-tl-tutar 
                            end-if    

                             string  
                                  konuk-adi   delimited by "   "
                                  " " delimited by size 
                                  konuk-soyadi   delimited by "   "
                                into  alac-dep-aciklama
                           initialize not-rec  not1
                            move  "EHR"       to NOT-DOS
                            move exthrk-anah to  NOT-DOS-ANAH 
                                           read nt no lock invalid continue
                                           end-read
                           string alac-dep-aciklama delimited by "                                     "
                           not1 delimited by "       "
                           into  alac-dep-aciklama

                          if yROMHRK-DEPKOD = genel-web-odeme
                                open i-o webbanka rezweb
                                   initialize rezweb-rec
                                   move yromhrk-rez-no to REZweb-rezno
                                   read rezweb no lock invalid
                                           continue
                                   not invalid
                                        unstring  rezweb-adres delimited by "-" into wbanka-sip wbanka-taksit
                                        initialize webbanka-rec
                                        move wbanka-sip(1:3)    to webbanka-banka-kodu
                                        move yromhrk-doviz-kodu to webbanka-doviz-kodu
                                        move wbanka-taksit(1:2) to webbanka-taksit-sayisi
                                        read webbanka no lock invalid
                                                continue
                                        not invalid
                                                move webbanka-hesap-kodu to alac-dep-hesap
                                        end-read
                                   end-read
                                 close webbanka rezweb
                          end-if

                           write alac-dep-rec invalid
                                 rewrite alac-dep-rec end-rewrite
                           end-write,
                           if kdvli = "E" then
                               initialize alac-dep-rec,
                               move depkod-kdv-hesap      to alac-dep-hesap
                               if depkod-matrah-ba = "B"
                                  move "B"   to alac-dep-ba
                                 else
                                   move "A"   to alac-dep-ba
                                end-if
                                 if depkod-turu = 2 then
                                move "C" to alac-dep-corr
                                end-if
                                read alac-dep no lock invalid continue,
                               end-read,
                                 compute alac-dep-tutar-tl rounded = 
                                         (alac-dep-tutar-tl + (exthrk-tl-tutar - (exthrk-tl-tutar * 100) / (100 + depkod-kdv)))
                                  move "Gunluk Tahsilatlar Geregi" to alac-dep-aciklama
                             write alac-dep-rec invalid rewrite alac-dep-rec,
                             end-write,
                                                  
                           end-if



                   end-if, 
                end-if,
            end-read,
        end-perform,
    end-start.
    close exthrk konuk yromhrk hrk2 nt .
    move spaces to evet-hayir.

 alac-departman-detay-bul-exit.
     exit.
*
 borc-departman-detay-bul.
    move spaces to evet-hayir.
    open input romhrk konuk.
    initialize romhrk-rec.
    move tarih        to romhrk-tarih.
    move depkod-kodu  to romhrk-depkod.
    start romhrk key not < romhrk-anah2 invalid continue,
        not invalid,

        move spaces to evet-hayir,
        perform with test after until evet,
            read romhrk next no lock end move "E" to evet-hayir,
                not end,
                if romhrk-tarih > tarih,
                          move "E" to evet-hayir,
                end-if,

                if romhrk-tarih not > tarih,
                          modify lb-1, title = romhrk-folio
                   if romhrk-depkod = depkod-kodu,
                           initialize borc-dep-rec,
                           initialize konuk-rec,
                           move romhrk-folio    to konuk-folio,
                           read konuk no lock invalid 
                                move spaces to konuk-adi konuk-soyadi,
                           end-read,
                           initialize cast-rec                             ||| firat ekleme 21/08/2019
                           move romhrk-tarih to cast-tarih
                           move konuk-rez-no to cast-rez-no
                           read cast no lock invalid
                                move konuk-oda-konumu to cast-oda-konumu
                                move konuk-odano      to cast-oda-no
                           end-read                                        ||
                           if onkpara-referans-var = 1 and ref-var = 1  then
                                      if onkpara-referans-nerden <> 2
                                           if xkonum-ref(cast-oda-konumu) not = ref    ||| firat ekleme 21/08/2019
                                                  exit perform cycle
                                           end-if
*                                           if xkonum-ref(KONUK-ODA-konumu) not = ref  
*                                                  exit perform cycle
*                                           end-if                                         ||
                                      else
                                            open input odalar
                                               initialize odalar-rec
                                               move cast-oda-no to odalar-anah   ||| firat ekleme 21/08/2019
*                                               move KONUK-ODANO to odalar-anah  ||
                                               read odalar no lock invalid
                                                       continue
                                               not invalid
                                                    if odalar-referans not > 0
                                                        move 1 to odalar-referans
                                                    end-if
                                                    if odalar-referans not = ref and 
                                                    genel-muha-ref not > 0  and ref > 0
                                                            close odalar
                                                          exit perform cycle
                                                    end-if
                                               end-read
                                            close odalar
                                        end-if

                           end-if
                           initialize kur-rec 
                          
                           move depkod2-kasa-hesap  to borc-dep-hesap
                           move KONUK-ODANO            to borc-dep-odano
                           move ROMHRK-FATURA-NO       to borc-dep-fatura-no
                           if depkod-matrah-ba = "B"
                              move "B"   to borc-dep-ba
                           else
                              move "A"   to borc-dep-ba
                           end-if
                           
                           read borc-dep no lock invalid continue
                           end-read
                           if kdvli = "E"  then
                             compute borc-dep-tutar rounded = 
                                         (borc-dep-tutar +  ((romhrk-tl-tutar * 100) / (100 + depkod-kdv)))

                              else
                              compute borc-dep-tutar rounded =  
                                       borc-dep-tutar + romhrk-tl-tutar 
                            end-if 
   
         
                                   move borc-dep-fatura-no  to borc-dep-aciklama(01:08)
                                   move "FT "             to borc-dep-aciklama(09:03)
                                   move konuk-folio      to borc-dep-aciklama(12:08)
                                   move konuk-adi        to borc-dep-aciklama(21:8)
                                   move konuk-soyadi     to borc-dep-aciklama(30:10)  
                          
                           
                           write borc-dep-rec invalid
                                 rewrite borc-dep-rec end-rewrite
                           end-write,
                            if kdvli = "E" then
                               initialize borc-dep-rec,
                               
                               move depkod-kdv-hesap      to borc-dep-hesap
                               if depkod-matrah-ba = "B"
                                  move "B"   to borc-dep-ba
                                 else
                                   move "A"   to borc-dep-ba
                                end-if
                               read borc-dep no lock invalid continue,
                               end-read,
                                 compute borc-dep-tutar rounded = 
                                         (borc-dep-tutar + (romhrk-tl-tutar - (romhrk-tl-tutar * 100) / (100 + depkod-kdv)))
                                  move "Gunluk Tahsilatlar Geregi" to borc-dep-aciklama
                             write borc-dep-rec invalid rewrite borc-dep-rec,
                             end-write,
                                                  
                           end-if
                   end-if, 
                end-if,
            end-read,
        end-perform,
    end-start.
    close romhrk.


    move spaces to evet-hayir.
    open input exthrk.
    initialize exthrk-rec.
    move tarih        to exthrk-tarih.
    move depkod-kodu  to exthrk-depkod.
    start exthrk key not < exthrk-anah2 invalid continue,
        not invalid,

        move spaces to evet-hayir,
        perform with test after until evet,
            read exthrk next no lock end move "E" to evet-hayir,
                not end,
                if exthrk-tarih > tarih,
                          move "E" to evet-hayir,
                end-if,

                if exthrk-tarih not > tarih,
                   if exthrk-depkod = depkod-kodu,
                          modify lb-1, title = exthrk-folio
                           initialize borc-dep-rec,
                           initialize konuk-rec,
                           move exthrk-folio    to konuk-folio,
                           read konuk no lock invalid 
                                move spaces to konuk-adi konuk-soyadi,
                           end-read,
                           initialize cast-rec                             ||| firat ekleme 21/08/2019
                           move exthrk-tarih       to cast-tarih
                           move konuk-extra-rez-no to cast-rez-no
                           read cast no lock invalid
                                move konuk-oda-konumu to cast-oda-konumu
                                move konuk-odano      to cast-oda-no
                           end-read                                        ||
                           if onkpara-referans-var = 1 and ref-var = 1 then
                              if onkpara-referans-nerden <> 2
                                   if xkonum-ref(cast-oda-konumu) not = ref     ||| firat ekleme 21/08/2019
                                          exit perform cycle
                                   end-if
*                                   if xkonum-ref(KONUK-ODA-konumu) not = ref
*                                          exit perform cycle
*                                   end-if                                    ||
                              else
                                    open input odalar
                                       initialize odalar-rec
                                       move cast-oda-no to odalar-anah         ||| firat ekleme 21/08/2019
*                                       move KONUK-ODANO to odalar-anah         ||
                                       read odalar no lock invalid
                                               continue
                                       not invalid
                                                    if odalar-referans not > 0
                                                        move 1 to odalar-referans
                                                    end-if
                                            if odalar-referans not = ref and 
                                            genel-muha-ref not > 0   and ref > 0
                                                    close odalar
                                                  exit perform cycle
                                            end-if
                                       end-read
                                    close odalar
                                end-if

                           end-if
                           initialize kur-rec 
                           move depkod2-kasa-hesap  to borc-dep-hesap
                           move KONUK-ODANO            to borc-dep-odano
                           move extHRK-FATURA-NO       to borc-dep-fatura-no
                           if depkod-matrah-ba = "B"
                              move "B"   to borc-dep-ba
                           else
                              move "A"   to borc-dep-ba
                           end-if
                           read borc-dep no lock invalid continue
                           end-read
                           if kdvli = "E"  then
                             compute borc-dep-tutar rounded = 
                                         (borc-dep-tutar +  ((exthrk-tl-tutar * 100) / (100 + depkod-kdv)))

                              else
                              compute borc-dep-tutar rounded =  
                                       borc-dep-tutar + exthrk-tl-tutar 
                            end-if  
  

               

                           move borc-dep-fatura-no  to borc-dep-aciklama(01:08)
                           move "FT "             to borc-dep-aciklama(09:03)
                           move konuk-folio      to borc-dep-aciklama(12:08)
                           move konuk-adi        to borc-dep-aciklama(21:8)
                           move konuk-soyadi     to borc-dep-aciklama(30:10)

                           write borc-dep-rec invalid
                                 rewrite borc-dep-rec end-rewrite
                           end-write,
                           if kdvli = "E" then
                               initialize borc-dep-rec,
                               move depkod-kdv-hesap      to borc-dep-hesap
                               if depkod-matrah-ba = "B"
                                  move "B"   to borc-dep-ba
                                 else
                                   move "A"   to borc-dep-ba
                                end-if
                               read borc-dep no lock invalid continue,
                               end-read,
                                 compute borc-dep-tutar rounded = 
                                         (borc-dep-tutar + (exthrk-tl-tutar - (exthrk-tl-tutar * 100) / (100 + depkod-kdv)))
                                  move "Gunluk Tahsilatlar Geregi" to borc-dep-aciklama
                             write borc-dep-rec invalid rewrite borc-dep-rec,
                             end-write,
                                                  
                           end-if



                   end-if, 
                end-if,
            end-read,
        end-perform,
    end-start.
    close exthrk konuk.
    move spaces to evet-hayir.

 borc-departman-detay-bul-exit.
     exit.

***************** KASA BORC DEPARTMANI *******************

*
 kasa-borc-departman-detay-bul.
                    
    move spaces to evet-hayir.
    open input romhrk konuk.
    initialize romhrk-rec.
    move tarih        to romhrk-tarih.
    move depkod-kodu  to romhrk-depkod.
    start romhrk key not < romhrk-anah2 invalid continue,
        not invalid,

        move spaces to evet-hayir,
        perform with test after until evet,
            read romhrk next no lock end move "E" to evet-hayir,
                not end,
                if romhrk-tarih > tarih,
                          move "E" to evet-hayir,
                end-if,

 
                if romhrk-tarih not > tarih,
                   if romhrk-depkod = depkod-kodu,
                          modify lb-1, title = romhrk-folio
                           initialize kasa-borc-dep-rec,
                           initialize konuk-rec,
                           move romhrk-folio    to konuk-folio,
                           read konuk no lock invalid 
                                move spaces to konuk-adi konuk-soyadi,
                           end-read,
                           initialize cast-rec                             ||| firat ekleme 21/08/2019
                           move romhrk-tarih to cast-tarih
                           move konuk-rez-no to cast-rez-no
                           read cast no lock invalid
                                move konuk-oda-konumu to cast-oda-konumu
                                move konuk-odano      to cast-oda-no
                           end-read                                        ||
                           if onkpara-referans-var = 1 and ref-var = 1 then
           
                                      if onkpara-referans-nerden <> 2
                                           if xkonum-ref(cast-oda-konumu) not = ref   ||| firat ekleme 21/08/2019
                                                  exit perform cycle
                                           end-if
*                                           if xkonum-ref(KONUK-ODA-konumu) not = ref
*                                                  exit perform cycle
*                                           end-if                                    ||
                                      else
                                            open input odalar
                                               initialize odalar-rec
                                               move cast-oda-no to odalar-anah         ||| firat ekleme 21/08/2019
*                                               move KONUK-ODANO to odalar-anah        ||
                                               read odalar no lock invalid
                                                       continue
                                               not invalid
                                                    if odalar-referans not > 0
                                                        move 1 to odalar-referans
                                                    end-if
                                                    if odalar-referans not = ref and 
                                                    genel-muha-ref not > 0  and ref > 0
                                                            close odalar
                                                          exit perform cycle
                                                    end-if
                                               end-read
                                            close odalar
                                        end-if

                           end-if
                           move romhrk-fatura-no       to kasa-borc-dep-fatura-no
                           initialize kur-rec 
                           move depkod2-kasa-hesap  to kasa-borc-dep-hesap
                           move KONUK-ODANO            to kasa-borc-dep-odano








                           if depkod-matrah-ba = "B"
                              move "B"   to kasa-borc-dep-ba
                           else
                              move "A"   to kasa-borc-dep-ba
                           end-if
                           read kasa-borc-dep no lock invalid continue
                           end-read
                           if kdvli = "E"  then
                             compute kasa-borc-dep-tutar rounded = 
                                         (kasa-borc-dep-tutar +  ((romhrk-tl-tutar * 100) / (100 + depkod-kdv)))

                              else
                              compute kasa-borc-dep-tutar rounded =  
                                       kasa-borc-dep-tutar + romhrk-tl-tutar 
                            end-if    
                           

 
                           move romhrk-fatura-no   to kasa-borc-dep-aciklama(01:08)
                           move "FT "             to kasa-borc-dep-aciklama(09:03)
                           move konuk-folio      to kasa-borc-dep-aciklama(12:08)
                           move konuk-adi        to kasa-borc-dep-aciklama(21:8)
                           move konuk-soyadi     to kasa-borc-dep-aciklama(30:10)

                           write kasa-borc-dep-rec invalid
                                 rewrite kasa-borc-dep-rec end-rewrite
                           end-write,
                            if kdvli = "E" then
                               initialize kasa-borc-dep-rec,
                               move depkod-kdv-hesap      to kasa-borc-dep-hesap
                               if depkod-matrah-ba = "B"
                                  move "B"   to kasa-borc-dep-ba
                                 else
                                   move "A"   to kasa-borc-dep-ba
                                end-if
                               read kasa-borc-dep no lock invalid continue,
                               end-read,
                                 compute kasa-borc-dep-tutar rounded = 
                                         (kasa-borc-dep-tutar + (romhrk-tl-tutar - (romhrk-tl-tutar * 100) / (100 + depkod-kdv)))
                                  move "Gunluk Tahsilatlar Geregi" to kasa-borc-dep-aciklama
                             write kasa-borc-dep-rec invalid rewrite kasa-borc-dep-rec,
                             end-write,
                           end-if
                   end-if, 
                end-if,
            end-read,
        end-perform,
    end-start.
    close romhrk.


    move spaces to evet-hayir.
    open input exthrk.
    initialize exthrk-rec.
    move tarih        to exthrk-tarih.
    move depkod-kodu  to exthrk-depkod.
    start exthrk key not < exthrk-anah2 invalid continue,
        not invalid,

        move spaces to evet-hayir,
        perform with test after until evet,
            read exthrk next no lock end move "E" to evet-hayir,
                not end,
                if exthrk-tarih > tarih,
                          move "E" to evet-hayir,
                end-if,

                if exthrk-tarih not > tarih,
                   if exthrk-depkod = depkod-kodu,
                          modify lb-1, title = exthrk-folio
                           initialize kasa-borc-dep-rec,
                           initialize konuk-rec,
                           move exthrk-folio    to konuk-folio,
                           read konuk no lock invalid 
                                move spaces to konuk-adi konuk-soyadi,
                           end-read,
                           initialize cast-rec                             ||| firat ekleme 21/08/2019
                           move exthrk-tarih       to cast-tarih
                           move konuk-extra-rez-no to cast-rez-no
                           read cast no lock invalid
                                move konuk-oda-konumu to cast-oda-konumu
                                move konuk-odano      to cast-oda-no
                           end-read                                        ||
                           if onkpara-referans-var = 1 and ref-var = 1 then
                                      if onkpara-referans-nerden <> 2
                                           if xkonum-ref(cast-oda-konumu) not = ref    ||| firat ekleme 21/08/2019
                                                  exit perform cycle
                                           end-if
*                                           if xkonum-ref(KONUK-ODA-konumu) not = ref
*                                                  exit perform cycle
*                                           end-if
                                      else                                               ||
                                            open input odalar
                                               initialize odalar-rec
                                               move cast-oda-no to odalar-anah         ||| firat ekleme 21/08/2019
*                                               move KONUK-ODANO to odalar-anah        ||
                                               read odalar no lock invalid
                                                       continue
                                               not invalid
                                                    if odalar-referans not > 0
                                                        move 1 to odalar-referans
                                                    end-if
                                                    if odalar-referans not = ref and genel-muha-ref not > 0 and ref > 0
                                                          close odalar
                                                          exit perform cycle
                                                    end-if
                                               end-read
                                            close odalar
                                        end-if
                
                           end-if
                           move extHRK-FATURA-NO       to kasa-borc-dep-fatura-no
                           initialize kur-rec 
                           move depkod2-kasa-hesap  to kasa-borc-dep-hesap
                           move KONUK-ODANO            to kasa-borc-dep-odano
                           if depkod-matrah-ba = "B"
                              move "B"   to kasa-borc-dep-ba
                           else
                              move "A"   to kasa-borc-dep-ba
                           end-if
                           read kasa-borc-dep no lock invalid continue
                           end-read

                           if kdvli = "E"  then
                             compute kasa-borc-dep-tutar rounded = 
                                         (kasa-borc-dep-tutar +  ((exthrk-tl-tutar * 100) / (100 + depkod-kdv)))

                              else
                              compute kasa-borc-dep-tutar rounded =  
                                       kasa-borc-dep-tutar + exthrk-tl-tutar 
                            end-if    
                            
                            
                           move exthrk-fatura-no   to kasa-borc-dep-aciklama(01:08)
                           move "FT "             to kasa-borc-dep-aciklama(09:03)
                           move konuk-folio      to kasa-borc-dep-aciklama(12:08)
                           move konuk-adi        to kasa-borc-dep-aciklama(21:8)
                           move konuk-soyadi     to kasa-borc-dep-aciklama(30:10)


                           write kasa-borc-dep-rec invalid
                                 rewrite kasa-borc-dep-rec end-rewrite
                           end-write,
                           if kdvli = "E" then
                               initialize kasa-borc-dep-rec,
                               move depkod-kdv-hesap      to kasa-borc-dep-hesap
                               if depkod-matrah-ba = "B"
                                  move "B"   to kasa-borc-dep-ba
                                 else
                                   move "A"   to kasa-borc-dep-ba
                                end-if
                               read kasa-borc-dep no lock invalid continue,
                               end-read,
                                 compute kasa-borc-dep-tutar rounded = 
                                         (kasa-borc-dep-tutar + (exthrk-tl-tutar - (exthrk-tl-tutar * 100) / (100 + depkod-kdv)))
                                  move "Gunluk Tahsilatlar Geregi" to kasa-borc-dep-aciklama
                             write kasa-borc-dep-rec invalid rewrite kasa-borc-dep-rec,
                             end-write,
                           end-if
                   end-if, 
                end-if,
            end-read,
        end-perform,
    end-start.
    close exthrk konuk.
    move spaces to evet-hayir.

 kasa-borc-departman-detay-bul-exit.
     exit.

*****************************************

 kasa-alac-departman-detay-bul.
                   
    move spaces to evet-hayir.
    open input romhrk konuk.
    initialize romhrk-rec.
    move tarih        to romhrk-tarih.
    move depkod-kodu  to romhrk-depkod.
    start romhrk key not < romhrk-anah2 invalid continue,
        not invalid,

        move spaces to evet-hayir,
        perform with test after until evet,
            read romhrk next no lock end move "E" to evet-hayir,
                not end,
                if romhrk-tarih > tarih,
                          move "E" to evet-hayir,
                end-if,

                if romhrk-tarih not > tarih,
                   if romhrk-depkod = depkod-kodu,
                          modify lb-1, title = romhrk-folio
                           initialize kasa-alac-dep-rec,
                           initialize konuk-rec,
                           move romhrk-folio    to konuk-folio,
                           read konuk no lock invalid 
                                move spaces to konuk-adi konuk-soyadi,
                           end-read,
                           initialize cast-rec                             ||| firat ekleme 21/08/2019
                           move romhrk-tarih to cast-tarih
                           move konuk-rez-no to cast-rez-no
                           read cast no lock invalid
                                move konuk-oda-konumu to cast-oda-konumu
                                move konuk-odano      to cast-oda-no
                           end-read                                        ||
                            if onkpara-referans-var = 1 and ref-var = 1 then
                                      if onkpara-referans-nerden <> 2
                                           if xkonum-ref(cast-oda-konumu) not = ref   ||| firat ekleme 21/08/2019
                                                  exit perform cycle
                                           end-if
*                                           if xkonum-ref(KONUK-ODA-konumu) not = ref
*                                                  exit perform cycle
*                                           end-if                                     ||
                                      else
                                            open input odalar
                                               initialize odalar-rec
                                               move cast-oda-no to odalar-anah    ||| firat ekleme 21/08/2019
*                                               move KONUK-ODANO to odalar-anah   ||
                                               read odalar no lock invalid
                                                       continue
                                               not invalid
                                                    if odalar-referans not > 0
                                                        move 1 to odalar-referans
                                                    end-if
                                                    if odalar-referans not = ref and genel-muha-ref not > 0 
                                                    and ref > 0
                                                            close odalar
                                                          exit perform cycle
                                                    end-if
                                               end-read
                                            close odalar
                                        end-if

                           end-if  
                                              
             
                                   initialize kur-rec 
                                   move depkod2-kasa-hesap  to kasa-alac-dep-hesap
        
                                   move KONUK-ODANO            to kasa-alac-dep-odano
                                   move romhrk-fatura-no       to kasa-alac-dep-fatura-no
                                   if depkod-matrah-ba = "B"
                                      move "B"   to kasa-alac-dep-ba
                                   else
                                      move "A"   to kasa-alac-dep-ba
                                   end-if
                                   read kasa-alac-dep no lock invalid continue
                                   end-read
                                   if kdvli = "E"  then
                                     compute kasa-alac-dep-tutar-tl rounded = 
                                                 (kasa-alac-dep-tutar-tl +  ((romhrk-tl-tutar * 100) / (100 + depkod-kdv)))
        
                                      else
                                      compute kasa-alac-dep-tutar-tl rounded =  
                                               kasa-alac-dep-tutar-tl + romhrk-tl-tutar 
                                    end-if    
        
 
                                   move romhrk-fatura-no   to kasa-alac-dep-aciklama(01:08)
                                   move "FT "             to kasa-alac-dep-aciklama(09:03)
                                   move konuk-folio      to kasa-alac-dep-aciklama(12:08)
                                   move konuk-adi        to kasa-alac-dep-aciklama(21:8)
                                   move konuk-soyadi     to kasa-alac-dep-aciklama(30:10)
        
        
        
                                 write kasa-alac-dep-rec invalid
                                         rewrite kasa-alac-dep-rec end-rewrite
                                 end-write,


                                 if kdvli = "E" then
                                       initialize kasa-alac-dep-rec,
                                       move depkod-kdv-hesap      to kasa-alac-dep-hesap
                                       if depkod-matrah-ba = "B"
                                          move "B"   to kasa-alac-dep-ba
                                         else
                                           move "A"   to kasa-alac-dep-ba
                                        end-if
                                       read kasa-alac-dep no lock invalid continue,
                                       end-read,
                                         compute kasa-alac-dep-tutar-tl rounded = 
                                                 (kasa-alac-dep-tutar-tl + (romhrk-tl-tutar - (romhrk-tl-tutar * 100) / (100 + depkod-kdv)))
                                          move "Gunluk Tahsilatlar Geregi" to kasa-alac-dep-aciklama
                                     write kasa-alac-dep-rec invalid rewrite kasa-alac-dep-rec,
                                     end-write,
                                                  
                                 end-if

           
                              |||| 06.02.2019 MUKARNAS PERA HAVALE MAILORDER ISLEMI OLAYI
                               if konuk-folio > 0 and 
                               depkod2-havale = 1 and
                               genel2-mah-havale-virman-aktif = 1           
                                     initialize kasa-alac-dep-anah kasa-alac-dep-tutar-tl   
                                     move depkod2k-matrah-hesap   to kasa-alac-dep-hesap
                                     move "B"   to kasa-alac-dep-ba
                                     read kasa-alac-dep no lock invalid continue,
                                     end-read,
                                           if kdvli = "E"  then
                                             compute kasa-alac-dep-tutar-tl rounded = 
                                                         (kasa-alac-dep-tutar-tl +  ((romhrk-tl-tutar * 100) / (100 + depkod-kdv)))
                
                                              else
                                              compute kasa-alac-dep-tutar-tl rounded =  
                                                       kasa-alac-dep-tutar-tl + romhrk-tl-tutar 
                                            end-if    
                
                                          move "Gunluk Tahsilatlar Geregi" to kasa-alac-dep-aciklama
                                     write kasa-alac-dep-rec invalid rewrite kasa-alac-dep-rec,
                                     end-write,


                                      initialize kasa-alac-dep-anah kasa-alac-dep-tutar-tl  
                                      OPEN INPUT ACENTA
                                      initialize acenta-rec  
                                      move konuk-acenta to ACENTA-KODU
                                      read acenta no lock invalid
                                             continue
                                      not invalid
                                              move ACENTA-avano  to kasa-alac-dep-hesap
                                      end-read
                                      CLOSE ACENTA

                                     move "A"   to kasa-alac-dep-ba
                                     read kasa-alac-dep no lock invalid continue,
                                     end-read,
                                           if kdvli = "E"  then
                                             compute kasa-alac-dep-tutar-tl rounded = 
                                                         (kasa-alac-dep-tutar-tl +  ((romhrk-tl-tutar * 100) / (100 + depkod-kdv)))
                
                                              else
                                              compute kasa-alac-dep-tutar-tl rounded =  
                                                       kasa-alac-dep-tutar-tl + romhrk-tl-tutar 
                                            end-if    
        
                                          move "Gunluk Tahsilatlar Geregi" to kasa-alac-dep-aciklama
                                     write kasa-alac-dep-rec invalid rewrite kasa-alac-dep-rec,
                                     end-write,
                               end-if
                               |||| 06.02.2019 MUKARNAS PERA HAVALE MAILORDER ISLEMI OLAYI
                   end-if, 
                end-if,
            end-read,
        end-perform,
    end-start.
    close romhrk.


    move spaces to evet-hayir.
    open input exthrk.
    initialize exthrk-rec.
    move tarih        to exthrk-tarih.
    move depkod-kodu  to exthrk-depkod.
    start exthrk key not < exthrk-anah2 invalid continue,
        not invalid,

        move spaces to evet-hayir,
        perform with test after until evet,
            read exthrk next no lock end move "E" to evet-hayir,
                not end,
                if exthrk-tarih > tarih,
                          move "E" to evet-hayir,
                end-if,

                if exthrk-tarih not > tarih,
                   if exthrk-depkod = depkod-kodu,
                          modify lb-1, title = exthrk-folio
                           initialize kasa-alac-dep-rec,
                           initialize konuk-rec,
                           move exthrk-folio    to konuk-folio,
                           read konuk no lock invalid 
                                move spaces to konuk-adi konuk-soyadi,
                           end-read,
                           initialize cast-rec                             ||| firat ekleme 21/08/2019
                           move exthrk-tarih to cast-tarih
                           move konuk-extra-rez-no to cast-rez-no
                           read cast no lock invalid
                                move konuk-oda-konumu to cast-oda-konumu
                                move konuk-odano      to cast-oda-no
                           end-read                                        ||
                           if onkpara-referans-var = 1 and ref-var = 1 then
                                      if onkpara-referans-nerden <> 2
                                           if xkonum-ref(cast-oda-konumu) not = ref     ||| firat ekleme 21/08/2019
                                                  exit perform cycle
                                           end-if
*                                           if xkonum-ref(KONUK-ODA-konumu) not = ref
*                                                  exit perform cycle
*                                           end-if                                 ||
                                      else
                                            open input odalar
                                               initialize odalar-rec
                                               move cast-oda-no to odalar-anah   ||| firat ekleme 21/08/2019
*                                               move KONUK-ODANO to odalar-anah   ||
                                               read odalar no lock invalid
                                                       continue
                                               not invalid
                                                    if odalar-referans not > 0
                                                        move 1 to odalar-referans
                                                    end-if
                                                    if odalar-referans not = ref and genel-muha-ref not > 0  
                                                    and ref > 0
                                                            close odalar
                                                          exit perform cycle
                                                    end-if
                                               end-read
                                            close odalar
                                        end-if

                           end-if
                           initialize kur-rec 
                           move depkod2-kasa-hesap  to kasa-alac-dep-hesap
                           move KONUK-ODANO            to kasa-alac-dep-odano
                           move exthrk-fatura-no       to kasa-alac-dep-fatura-no
                           if depkod-matrah-ba = "B"
                              move "B"   to kasa-alac-dep-ba
                           else
                              move "A"   to kasa-alac-dep-ba
                           end-if
                           read kasa-alac-dep no lock invalid continue
                           end-read
                           if kdvli = "E"  then
                             compute kasa-alac-dep-tutar-tl rounded = 
                                         (kasa-alac-dep-tutar-tl +  ((exthrk-tl-tutar * 100) / (100 + depkod-kdv)))

                              else
                              compute kasa-alac-dep-tutar-tl rounded =  
                                       kasa-alac-dep-tutar-tl + exthrk-tl-tutar 
                            end-if    

 

                           move exthrk-fatura-no   to kasa-alac-dep-aciklama(01:08)
                           move "FT "             to kasa-alac-dep-aciklama(09:03)
                           move konuk-folio      to kasa-alac-dep-aciklama(12:08)
                           move konuk-adi        to kasa-alac-dep-aciklama(21:8)
                           move konuk-soyadi     to kasa-alac-dep-aciklama(30:10)


                           write kasa-alac-dep-rec invalid
                                 rewrite kasa-alac-dep-rec end-rewrite
                           end-write,
                           if kdvli = "E" then
                               initialize kasa-alac-dep-rec,
                               move depkod-kdv-hesap      to kasa-alac-dep-hesap
                               if depkod-matrah-ba = "B"
                                  move "B"   to kasa-alac-dep-ba
                                 else
                                   move "A"   to kasa-alac-dep-ba
                                end-if
                               read kasa-alac-dep no lock invalid continue,
                               end-read,
                                 compute kasa-alac-dep-tutar-tl rounded = 
                                         (kasa-alac-dep-tutar-tl + (exthrk-tl-tutar - (exthrk-tl-tutar * 100) / (100 + depkod-kdv)))
                                  move "Gunluk Tahsilatlar Geregi" to kasa-alac-dep-aciklama
                             write kasa-alac-dep-rec invalid rewrite kasa-alac-dep-rec,
                             end-write,
                           end-if
                   end-if, 
                end-if,
            end-read,
        end-perform,
    end-start.
    close exthrk konuk.
    move spaces to evet-hayir.

 kasa-alac-departman-detay-bul-exit.
     exit.
*
 kasa-takaslara-yaz. 
 
             evaluate true
                    when depkod-ba = "B" 
                         initialize kasa-borc-dep-rec,
                         if depkod2-matrah-hesap not = spaces
                            move depkod2-matrah-hesap   to kasa-borc-dep-hesap
                            if depkod-matrah-ba = "B"
                               move "A"   to kasa-borc-dep-ba
                            else
                               move "B"   to kasa-borc-dep-ba
                            end-if
                            move depkod2-matrah-hesap   to kasa-borc-dep-hesap
                            read kasa-borc-dep no lock invalid continue,
                            end-read,
                                 compute kasa-borc-dep-tutar rounded = kasa-borc-dep-tutar + onkasa-tutar-tl 

                                 move "Gunluk Gelirler Geregi" to kasa-borc-dep-aciklama
                            write kasa-borc-dep-rec invalid rewrite kasa-borc-dep-rec,
                            end-write,
                         end-if
                    evaluate depkod-turu
                              when  4  
                                 
                              perform kredi-bul thru kredi-bul-exit
                                 
                              
*                              when  5 perform kredi-karti-bul thru kredi-karti-bul-exit
                              when  other continue
                       if depkod-mahsup-detay = "E" then

                          if depkod2-kasa-hesap not = spaces and 
                              depkod-kdv-hesap    not = spaces and
                              depkod-kdv              = zeroes
                                 move "H" to kdvli
                                 perform kasa-borc-departman-detay-bul thru kasa-borc-departman-detay-bul-exit
                            end-if
                          if depkod2-kasa-hesap not = spaces and 
                             depkod-kdv-hesap        = spaces 
                                 move "H" to kdvli
                                 perform kasa-borc-departman-detay-bul thru kasa-borc-departman-detay-bul-exit
                            end-if
                           if depkod2-kasa-hesap not = spaces and 
                             depkod-kdv-hesap    not = spaces and
                             depkod-kdv          not = zeroes
                                   move "E" to kdvli
                                   perform kasa-borc-departman-detay-bul thru kasa-borc-departman-detay-bul-exit
                            end-if
                        else
                       initialize kasa-borc-dep-rec,
                         if depkod2-kasa-hesap not = spaces and 
                            depkod-kdv-hesap    not = spaces and
                            depkod-kdv              = zeroes
                            if depkod-matrah-ba = "B"
                               move "B"   to kasa-borc-dep-ba
                            else
                               move "A"   to kasa-borc-dep-ba
                            end-if

                            move depkod2-kasa-hesap   to kasa-borc-dep-hesap
                            read kasa-borc-dep no lock invalid continue,
                            end-read,
                                 compute kasa-borc-dep-tutar rounded = kasa-borc-dep-tutar + onkasa-tutar-tl 
                                 move "Gunluk Gelirler Geregi" to kasa-borc-dep-aciklama
                            write kasa-borc-dep-rec invalid rewrite kasa-borc-dep-rec,
                            end-write,
                         end-if
                         initialize kasa-borc-dep-rec,
                         if depkod2-kasa-hesap not = spaces and 
                            depkod-kdv-hesap        = spaces 
                            if depkod-matrah-ba = "B"
                               move "B"   to kasa-borc-dep-ba
                            else
                               move "A"   to kasa-borc-dep-ba
                            end-if

                            move depkod2-kasa-hesap   to kasa-borc-dep-hesap
                            read kasa-borc-dep no lock invalid continue,
                            end-read,
                                 compute kasa-borc-dep-tutar rounded = kasa-borc-dep-tutar + onkasa-tutar-tl 
                                 move "Gunluk Gelirler Geregi" to kasa-borc-dep-aciklama
                            write kasa-borc-dep-rec invalid rewrite kasa-borc-dep-rec,
                            end-write,
                         end-if
                         initialize kasa-borc-dep-rec,
                         if depkod2-kasa-hesap not = spaces and 
                            depkod-kdv-hesap    not = spaces and
                            depkod-kdv          not = zeroes
                            if depkod-matrah-ba = "B"
                               move "B"   to kasa-borc-dep-ba
                            else
                               move "A"   to kasa-borc-dep-ba
                            end-if

                            move depkod2-kasa-hesap   to kasa-borc-dep-hesap
                            read kasa-borc-dep no lock invalid continue,
                            end-read,
                                 compute kasa-borc-dep-tutar rounded = 
                                         (kasa-borc-dep-tutar +  ((onkasa-tutar-tl * 100) / (100 + depkod-kdv)))
                                 move "Gunluk Gelirler Geregi" to kasa-borc-dep-aciklama
                            write kasa-borc-dep-rec invalid rewrite kasa-borc-dep-rec,
                            end-write,
                            initialize kasa-borc-dep-rec,
                            if depkod-matrah-ba = "B"
                               move "B"   to kasa-borc-dep-ba
                            else
                               move "A"   to kasa-borc-dep-ba
                            end-if
                            move depkod-kdv-hesap      to kasa-borc-dep-hesap
                            read kasa-borc-dep no lock invalid continue,
                            end-read,
                                 compute kasa-borc-dep-tutar rounded = 
                                         (kasa-borc-dep-tutar + (onkasa-tutar-tl - (onkasa-tutar-tl * 100) / (100 + depkod-kdv)))
                                 move "Gunluk Gelirler Geregi" to kasa-borc-dep-aciklama
                            write kasa-borc-dep-rec invalid   rewrite kasa-borc-dep-rec,
                            end-write,
                         
                        end-if
                      end-if  
                    end-evaluate
///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
                    when depkod-ba = "A" 
 
                         initialize kasa-alac-dep-rec,
                          if depkod2-matrah-hesap not = spaces
                             initialize kasa-alac-dep-anah    
                             move depkod2-matrah-hesap   to kasa-alac-dep-hesap
                            if depkod-matrah-ba = "B"
                               move "A"   to kasa-alac-dep-ba
                            else
                               move "B"   to kasa-alac-dep-ba
                            end-if
                             read kasa-alac-dep no lock invalid continue,
                             end-read,
                                  compute kasa-alac-dep-tutar-tl rounded = kasa-alac-dep-tutar-tl + onkasa-tutar-tl
                                  move "Gunluk Tahsilatlar Geregi" to kasa-alac-dep-aciklama
                             write kasa-alac-dep-rec invalid rewrite kasa-alac-dep-rec,
                             end-write,
                                 
                          end-if
                         evaluate depkod-turu
                                
                              when  4 perform kredi-bul thru kredi-bul-exit
*                              when  5 perform kredi-karti-bul thru kredi-karti-bul-exit
                              when  other continue
                       if depkod-mahsup-detay = "E" then
                           if depkod2-kasa-hesap not = spaces and 
                              depkod-kdv-hesap    not = spaces and
                              depkod-kdv              = zeroes
                                 move "H" to kdvli
                                 perform kasa-alac-departman-detay-bul thru kasa-alac-departman-detay-bul-exit
                            end-if
                          if depkod2-kasa-hesap not = spaces and 
                             depkod-kdv-hesap        = spaces 
                                 move "H" to kdvli
                                 perform kasa-alac-departman-detay-bul thru kasa-alac-departman-detay-bul-exit
                            end-if
                           if depkod2-kasa-hesap not = spaces and 
                             depkod-kdv-hesap    not = spaces and
                             depkod-kdv          not = zeroes
                                   move "E" to kdvli
                                   perform kasa-alac-departman-detay-bul thru kasa-alac-departman-detay-bul-exit
                            end-if


                           

                        else
 
                          initialize kasa-alac-dep-rec,
                          if depkod2-kasa-hesap not = spaces and 
                             depkod-kdv-hesap    not = spaces and
                             depkod-kdv              = zeroes
                             initialize kasa-alac-dep-anah
                            if depkod-matrah-ba = "B"
                               move "B"   to kasa-alac-dep-ba
                            else
                               move "A"   to kasa-alac-dep-ba
                            end-if
                             move depkod2-kasa-hesap   to kasa-alac-dep-hesap
                             read kasa-alac-dep no lock invalid continue,
                             end-read,
                                  compute kasa-alac-dep-tutar-tl rounded = kasa-alac-dep-tutar-tl + onkasa-tutar-tl
                                  move "Gunluk Tahsilatlar Geregi" to kasa-alac-dep-aciklama
                             write kasa-alac-dep-rec invalid rewrite kasa-alac-dep-rec,
                             end-write,
                          end-if
                          initialize kasa-alac-dep-rec,
                          if depkod2-kasa-hesap not = spaces and 
                             depkod-kdv-hesap        = spaces 
                             initialize kasa-alac-dep-anah
                            if depkod-matrah-ba = "B"
                               move "B"   to kasa-alac-dep-ba
                            else
                               move "A"   to kasa-alac-dep-ba
                            end-if
                             move depkod2-kasa-hesap   to kasa-alac-dep-hesap
                             read kasa-alac-dep no lock invalid continue,
                             end-read,
                                  compute kasa-alac-dep-tutar-tl rounded = kasa-alac-dep-tutar-tl + onkasa-tutar-tl
                                  move "Gunluk Tahsilatlar Geregi" to kasa-alac-dep-aciklama
                             write kasa-alac-dep-rec invalid rewrite kasa-alac-dep-rec,
                             end-write,
                          end-if
                          initialize kasa-alac-dep-rec,
                          if depkod2-kasa-hesap not = spaces and 
                             depkod-kdv-hesap    not = spaces and
                             depkod-kdv          not = zeroes
                            if depkod-matrah-ba = "B"
                               move "B"   to kasa-alac-dep-ba
                            else
                               move "A"   to kasa-alac-dep-ba
                            end-if
                             move depkod2-kasa-hesap   to kasa-alac-dep-hesap
                             read kasa-alac-dep no lock invalid continue,
                             end-read,
                                 compute kasa-alac-dep-tutar-tl rounded = 
                                         (kasa-alac-dep-tutar-tl +  ((onkasa-tutar-tl * 100) / (100 + depkod-kdv)))
                                  move "Gunluk Tahsilatlar Geregi" to kasa-alac-dep-aciklama
                             write kasa-alac-dep-rec invalid rewrite kasa-alac-dep-rec,
                             end-write,
                              initialize kasa-alac-dep-rec,
                              move depkod-kdv-hesap      to kasa-alac-dep-hesap
                            if depkod-matrah-ba = "B"
                               move "B"   to kasa-alac-dep-ba
                            else
                               move "A"   to kasa-alac-dep-ba
                            end-if
                             read kasa-alac-dep no lock invalid continue,
                             end-read,
                                 compute kasa-alac-dep-tutar-tl rounded = 
                                         (kasa-alac-dep-tutar-tl + (onkasa-tutar-tl - (onkasa-tutar-tl * 100) / (100 + depkod-kdv)))
                                  move "Gunluk Tahsilatlar Geregi" to kasa-alac-dep-aciklama
                             write kasa-alac-dep-rec invalid rewrite kasa-alac-dep-rec,
                             end-write,
                          end-if
                        end-if
                         end-evaluate
                    end-evaluate,
    .   
*
     .
*
 acc-ref-Bef-Procedure.
    initialize nereden.
*
*
 depkod2-tr.
      if resmiye-kes = 1 
      if depkod-matrah-hesap not = spaces and  depkod2-matrah-hesap = spaces
         move  depkod-matrah-hesap to  depkod2-matrah-hesap
      end-if
       if depkod-kdv-hesap not = spaces and  depkod2-kdv-hesap = spaces
         move  depkod-kdv-hesap to  depkod2-kdv-hesap
      end-if
      end-if   
        .
*
 acuserve-adres-aktar.
     if resmiye-kes = 1 then  
         move genel-resmi-muha of genel-rec to CARI-DOSYA-adres         
                         ISLENEN-DOSYA-adres      
                         HESAP-DOSYA-adres        
                         MAHSUP-DOSYA-adres       
                         genelfis-DOSYA-adres     
                         REFERANS-DOSYA-adres     
                         mgenel-DOSYA-adres       
                         genelfis-DOSYA-adres 
                         alsat-dosya-adres
                         efat2onb-dosya-adres
                         move "muha" to genelfis-DOSYA(16:4)

      else
       move muhasebe-entegre-sirketi  to CARI-DOSYA-adres         
                         ISLENEN-DOSYA-adres      
                         HESAP-DOSYA-adres        
                         MAHSUP-DOSYA-adres       
                         genelfis-DOSYA-adres     
                         REFERANS-DOSYA-adres     
                         mgenel-DOSYA-adres       
                         genelfis-DOSYA-adres 
                         alsat-dosya-adres
                         efat2onb-dosya-adres
                         move "muha" to genelfis-DOSYA(16:4)
      end-if         

   
                
    move all low-values to      
                           cari-acuserve-dosya       
                           islenen-acuserve-dosya    
                           hesap-acuserve-dosya      
                           mahsup-acuserve-dosya     
                           genelfis-acuserve-dosya   
                           referans-acuserve-dosya   
                           mgenel-acuserve-dosya     
                           genelfis-acuserve-dosya  
                           efat2onb-acuserve-dosya
                           ip-no.

    inspect genel-muha-uzak-ip 
            replacing trailing spaces by low-values.

    if genel-muha-uzak-ip <> low-values
       move all low-values to ip-no
       string ip-no,
              "@" delimited by low-values
              genel-muha-uzak-ip delimited by low-values
              ":" delimited by low-values
              into ip-no
    end-if

    string mgenel-acuserve-dosya,
           ip-no                        delimited by low-values
           mgenel-dosya                 delimited by low-values
           into mgenel-acuserve-dosya.
    string genelfis-acuserve-dosya,
           ip-no                        delimited by low-values
           genelfis-dosya               delimited by low-values
           into genelfis-acuserve-dosya.

    
    string hesap-acuserve-dosya,
           ip-no                        delimited by low-values
           hesap-dosya                  delimited by low-values
           into hesap-acuserve-dosya.
    string mahsup-acuserve-dosya,
           ip-no                        delimited by low-values
           mahsup-dosya                 delimited by low-values
           into mahsup-acuserve-dosya.
    string cari-acuserve-dosya,
           ip-no                        delimited by low-values
           cari-dosya                   delimited by low-values
           into cari-acuserve-dosya.
    string islenen-acuserve-dosya,
           ip-no                        delimited by low-values
           islenen-dosya                delimited by low-values
           into islenen-acuserve-dosya.
    string referans-acuserve-dosya,
           ip-no                        delimited by low-values
           referans-dosya               delimited by low-values
           into referans-acuserve-dosya.
     string efat2onb-acuserve-dosya,
           ip-no                        delimited by low-values
           efat2onb-dosya                delimited by low-values
           into efat2onb-acuserve-dosya.
    
    inspect cari-acuserve-dosya        replacing  all spaces by low-values
    inspect islenen-acuserve-dosya     replacing  all spaces by low-values
    inspect hesap-acuserve-dosya       replacing  all spaces by low-values
    inspect mahsup-acuserve-dosya      replacing  all spaces by low-values
    inspect genelfis-acuserve-dosya    replacing  all spaces by low-values
    inspect referans-acuserve-dosya    replacing  all spaces by low-values
    inspect mgenel-acuserve-dosya      replacing  all spaces by low-values
    inspect efat2onb-acuserve-dosya      replacing  all spaces by low-values
    inspect genelfis-acuserve-dosya    replacing  all spaces by low-values.
    
*
 Form1-Aft-Initdata.
*/-----------------------------\*  
*/---------DIL AYARLA----------\*    
*/-----------------------------\*    
     perform dil-ayarla-proc.
*/-----------------------------\*         
     .

*
 Form1-Cb-1aaa-Ev-Cmd-Clicked.
         inquire Form1-Cb-1aaa   value in  resmiye-kes
        
          display acc-resmi.
        


             initialize referans-ip
             perform acuserve-adres-aktar.
     
             open input mgenel.
             move 1 to mgenel-anahtar.
             read mgenel no lock invalid
                  display message box 
                          "mgenel parametre tanimsiz ..."
                          icon mb_error_icon
                          title "Hata"
                          close mgenel
                          destroy form1-handle
                          goback
             end-read.
             close mgenel.
             initialize referans-ip
    
       

     if mgenel-referans = "E" 
        move 1 to vis-1
          move 1 to ref-var
     else
        move 0 to vis-1
          move 0 to ref-var
     end-if.
     if genel2-onb-refsiz = 1
            move 0 to ref-var  
     end-if
     move 1 to enable-1
     move 0 to enable-2.
     display Form1-La-1aa acc-ref.
*
 doviz-kodu-duzenle.
           exit paragraph.
     initialize doviz-rec                              | firat liberty likya 28/12/2018..
     move mahsup-doviz-kodu to doviz-kodu
     read doviz no lock invalid
          continue
     not invalid
         if d-muh-doviz-kodu > 0
            move d-muh-doviz-kodu to mahsup-doviz-kodu
         end-if
     end-read
        .

*
 uzak-kur-degistir. 
     open input doviz
     initialize doviz-rec
     start doviz key not < DOVIZ-KODU invalid 
         continue 
     not invalid 
     perform until fs-doviz = "10"
     read doviz next no lock end move "10" to fs-doviz
     not at end 
            if mgenel-doviz = d-muh-doviz-kodu
                move DOVIZ-KODU  to kur-doviz
            end-if 
     end-read 
     end-perform
     end-start
     close doviz
       .


*
 uzak-kur-degistir-hesaba-gore. 
    
     initialize doviz-rec
     start doviz key not < DOVIZ-KODU invalid 
         continue 
     not invalid 
     perform until fs-doviz = "10"
     read doviz next no lock end move "10" to fs-doviz
     not at end 
            if HESAP-DOVIZ = d-muh-doviz-kodu
                move DOVIZ-KODU  to kur-doviz
            end-if 
     end-read 
     end-perform
     end-start
     
       .
*
 hesaba-gore-doviz.
     if combo-dovizlimi-value(1:1)  = "D" and dov-hes-calis = 1
        if mahsup-tutar <> zeroes
           initialize hesap-rec
           move mahsup-hesap-kodu to hesap-kodu
           read hesap no lock invalid
               continue 
           end-read 
           if bozumdan-geldi not = 1
              move HESAP-BANKA   to mahsup-banka-kodu  
           else
              if kasadov-banka = spaces
                 move HESAP-BANKA to  mahsup-banka-kodu
              else
                 move kasadov-banka to mahsup-banka-kodu
              end-if 
           end-if 
         
           move HESAP-DOVIZ         to mahsup-doviz-kodu          
           move hesap-doviz-efektif to mahsup-d-e 
           move hesap-doviz-eh      to MAHSUP-DOVIZ-E-H

           initialize kur-rec
           move mahsup-banka-kodu to kur-banka
           move mahsup-doviz-kodu to kur-doviz
           if genel-otel-kod = "libert"
             perform uzak-kur-degistir-hesaba-gore
           end-if
           
           move tarih              to kur-tarih
           read kur no lock invalid 
               continue 
           not invalid 
               move doviz-alis to islem-kuru
           end-read 
           move islem-kuru     to mahsup-doviz-kuru
*****************************************10.05.2022 eklenen********************************************
           if genel-otel-kod = "libert"
              if kur-doviz = 4 |||TL demek
                 move 1 to mahsup-doviz-kuru
                 move  mahsup-tutar to mahsup-tutar-dv
              else
                compute mahsup-doviz-kuru rounded = mahsup-tutar / mahsup-tutar-dv  
              end-if 
           end-if 
*******************************************10.05.2022 eklenen******************************************
                               |||freshdesk 9037 nolu taska istinaden
                               ||| eski hali aþaðýdaki gibi   RAMAZAN 10.05.2022
*           compute mahsup-tutar-dv rounded = 
*                   mahsup-tutar / islem-kuru                      
        end-if 
     end-if
     initialize bozumdan-geldi.
 
             

 


 
