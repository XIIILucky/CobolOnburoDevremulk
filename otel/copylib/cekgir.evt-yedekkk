* cekgir.evt
* cekgir.evt is generated from D:\asya\acugt.ytl\otel\cekgir.Psf
* This is a generated file. DO NOT modify this file directly.


 Form1-Exception-Proc.
     PERFORM exception-procedure
     .

 Form1-Gd-1-Event-Proc.
* 
     EVALUATE Event-Type
     WHEN Msg-Begin-Entry
        EVALUATE Event-Control-Id
        WHEN 65
           PERFORM fdep-Ev-Msg-Begin-Entry
        WHEN 66
           PERFORM ftut-Ev-Msg-Begin-Entry
        WHEN 302
           PERFORM gf-Ev-Msg-Begin-Entry
        END-EVALUATE
     WHEN Other
        EVALUATE Event-Control-Id
        WHEN 16
           PERFORM Form1-Gd-1-Ev-Other
        END-EVALUATE
     END-EVALUATE
     .

 Form2-Event-Proc.
     .

 Form3-Event-Proc.
     .

 Form3-Exception-Proc.
     PERFORM Form3-Ex-Other
     .
***   start event editor code   ***
* cekgir.evt
* cekgir.evt is generated from D:\asya\acugt.ytl\otel\cekgir.Psf
* This is a generated file. DO NOT modify this file directly.


 Form1-Exception-Proc.
     PERFORM exception-procedure
     .

 Form1-Gd-1-Event-Proc.
* 
     EVALUATE Event-Type
     WHEN Msg-Begin-Entry
        EVALUATE Event-Control-Id
        WHEN 65
           PERFORM fdep-Ev-Msg-Begin-Entry
        WHEN 66
           PERFORM ftut-Ev-Msg-Begin-Entry
        WHEN 302
           PERFORM gf-Ev-Msg-Begin-Entry
        END-EVALUATE
     WHEN Other
        EVALUATE Event-Control-Id
        WHEN 16
           PERFORM Form1-Gd-1-Ev-Other
        END-EVALUATE
     END-EVALUATE
     .
 Form2-Event-Proc.
     .

 Form3-Event-Proc.
     .

 Form3-Exception-Proc.
     PERFORM Form3-Ex-Other
     .
***   start event editor code   ***
*
 Form1-Bef-Create.
     perform icyetki-kontrol.
     call "c$narg" using link-var.
     if link-var > 1  then 
       
       move link-pen  to link-pencere
     end-if       
     
     perform adresleri-tasi.
     open input genel kllnc
      initialize kllnc-rec
              move k-kodu-tasi to k-kodu
              read kllnc no lock invalid 
              continue
              end-read
              move K-muh-SUP  to muh-sup

     move 1 to genel-anahtar
     read genel no lock invalid continue
          not invalid
          move calis-yil    to yil title-yil 
          move calis-ay     to  ay title-ay
          move calis-gun    to gun title-gun
     end-read
     close genel kllnc.  
     if link-var =  5 

            move tarih-tasi to ukur-tar
            move 1 to onodeme-vis
            display uk1 uk2 uk3 uk4
       else
          move 0 to onodeme-vis
      end-if
       move cost-sirketi to p-dosya-alan posy-dosya-adres
     .
     open input kodlar02 depkod depkod2 acenta firma.
     open i-o romhrk exthrk konuk onkasa yromhrk hrk2 dov-boz.
     initialize gec-gecme islkilit-acik-kapali.
     open i-o odalar2.
     .
*
 sonraki-doviz.
    
    open input doviz
    move konuk-doviz  to doviz-kodu
      start doviz key > doviz-kodu
        invalid
         initialize doviz-kodu
            start doviz key > doviz-kodu
              invalid
               display message box "doviz bulunamadi :1456"
            end-start
      end-start
      read doviz next no lock
        end continue
        not end
        
        move doviz-kodu to konuk-doviz
      end-read
      close doviz
    .     
*
 kur-bul.
      if link-var = 5
            move link-onodeme-rez  to yromhrk-rez-no
            string form-acik
                 "On Odeme Rez No: " delimited by "  "  
                 link-onodeme-rez delimited by size
            into form-acik
           
            if link-onodeme-rez > 0                  
                open input rez
                initialize rez-rec
                move link-onodeme-rez to rez-no
                read rez no lock invalid 
                    display message box "Kaydedilmemis Rezervasyona On Odeme Girmektesiniz."
                                    title "Uyari"
                                    icon 1
                not invalid 
                    continue
*                    move rez-cin-kuru      to islem-kuru
*                     move islem-kuru to uy-kur
*                   display dov-kur-l l-kur
                end-read 
                close rez
            end-if
          
            end-if
    open input kur
    initialize islem-kuru
    if onodeme-vis = 1
      move ukur-tar to kur-tarih
      else
      move calisma-tarihi  to kur-tarih
     end-if
           if konuk-banka = spaces or konuk-banka = zeroes
             move onkpara-banka to konuk-banka
           end-if 
           if konuk-doviz = spaces or konuk-doviz = zeroes
             move onkpara-doviz to konuk-doviz
           end-if 
       
         
     if cinmi = 1  then 
         READ KONUK NO LOCK INVALID 
            STOP " " 
         END-READ
         if link-var = 5 
            move rez-cin-kuru to islem-kuru doviz-alis
            move rez-doviz to doviz-kodu            
         else          
           move KONUK-KUR-DEGERI to islem-kuru doviz-alis
           move konuk-doviz to doviz-kodu
         end-if
           

         move konuk-banka to banka-kodu          
         open input banka doviz     
         read banka no lock invalid
             initialize banka-adi
         end-read
         read doviz  no lock invalid
             initialize  D-KISA-ADI 
         end-read
            move banka-adi to dov-kur
            move "-" to dov-kur(6:1)
            move d-kisa-adi to dov-kur(7:)
            if cinmi = 1 then 
                move "C/IN" to  dov-kur(12:4)
            end-if
            move islem-kuru to uy-kur
            display dov-kur-l l-kur
         close banka doviz 
     else
        if cinmi = 2 and hrkgir-tl-tutar not = 0 and hrkgir-dv-tutar not = 0          
           move konuk-banka to banka-kodu
           move konuk-doviz to doviz-kodu
           open input banka doviz    
          read banka no lock invalid
                 initialize banka-adi
         end-read
         read doviz no lock invalid
                 initialize D-KISA-ADI 
         end-read
            move banka-adi to dov-kur
            move "-" to dov-kur(6:1)
            move d-kisa-adi to dov-kur(7:)
            if cinmi = 1 then 
               move "C/IN" to  dov-kur(12:4)
            else 
               if cinmi = 2 then 
                  move "ORT" to  dov-kur(12:4)
               end-if
            end-if
            compute islem-kuru rounded = hrkgir-tl-tutar / hrkgir-dv-tutar 
            move islem-kuru to uy-kur
            display dov-kur-l l-kur
         close banka doviz
        else
**/*************************likya world istek****************ramazan*************  
            initialize dep-konuk-doviz        
            if depkod-ba = "A" 
               if depkod-turu = 5  
                   if depkod2-dov-kod not = spaces and 
                      depkod2-dov-kod not = zeroes
                          move depkod2-dov-kod      to dep-konuk-doviz
                   end-if 
               end-if 
               if depkod-turu = 3  
                   if depkod2-dov-kod not = spaces and 
                      depkod2-dov-kod not = zeroes
                          move depkod2-dov-kod      to dep-konuk-doviz
                   end-if 
               end-if 
            end-if                                                                         
                 
**/*************************likya world istek****************ramazan************* 
           if  oto-cinkuru  not = 1       
              move 0 to cinmi
            end-if
               perform Form1-Cb-1-Ev-Cmd-Clicked
             initialize bakilan
              perform test after until islem-kuru > 0 
               add 1 to bakilan
               if bakilan > 20                
                  display message box "Hic bir kur girilmemis"
                  exit perform
                  set exit-pushed to true
               end-if
               move konuk-banka    to kur-banka banka-kodu 
               if dep-konuk-doviz > 0
                  move dep-konuk-doviz    to kur-doviz doviz-kodu   
               else 
                  move konuk-doviz    to kur-doviz doviz-kodu   
               end-if 
               read kur no lock invalid 
                  initialize islem-kuru doviz-alis
               end-read
                move doviz-alis to islem-kuru
          
                  open input banka doviz
             
                read banka no lock invalid
                       initialize banka-adi
               end-read
               read doviz  no lock invalid
                       initialize  D-KISA-ADI 
               end-read
                     move banka-adi to dov-kur
                      move "-" to dov-kur(6:1)
                     move d-kisa-adi to dov-kur(7:)
                     move islem-kuru to uy-kur
                     display dov-kur-l l-kur
                close banka doviz
               if islem-kuru = 0 
                    perform sonraki-doviz 
                end-if
            end-perform
            end-if
    end-if   
        
      
       
     close     kur.
    
     if link-var = 5
            move link-onodeme-rez  to yromhrk-rez-no
            string form-acik
                 "On Odeme Rez No: " delimited by "  "  
                 link-onodeme-rez delimited by size
            into form-acik
            if link-onodeme-rez > 0                  
                open input rez
                initialize rez-rec
                move link-onodeme-rez to rez-no
                read rez no lock invalid 
                    display message box "Kaydedilmemis Rezervasyona On Odeme Girmektesiniz."
                                    title "Uyari"
                                    icon 1
                not invalid 
                     continue
*                    move rez-cin-kuru      to islem-kuru
*                     move islem-kuru to uy-kur
*                   display dov-kur-l l-kur
                end-read 
                close rez
            end-if 
         end-if



   
     evaluate true
       when hrkgir-tl-tutar > 0 and    hrkgir-dv-tutar > 0 
          if tl-degisme not = 1 
             compute   hrkgir-tl-tutar rounded =  hrkgir-dv-tutar * islem-kuru
          end-if
       when hrkgir-tl-tutar = 0 and    hrkgir-dv-tutar > 0 
          compute   hrkgir-tl-tutar rounded =  hrkgir-dv-tutar * islem-kuru
        
         
       when hrkgir-tl-tutar > 0 and    hrkgir-dv-tutar = 0  
          compute   hrkgir-dv-tutar rounded =  hrkgir-tl-tutar / islem-kuru
    end-evaluate
      DISPLAY ACCEPT-TLTUTAR ACCEPT-DVTUTAR .

 kur-bul-exit.
    exit.
*
 accept-depkodu-Bef-Procedure.
     initialize hrkgir-rec  grid-islemno
                corr-dep-dep form-acik depkod-adi of depkod.
     move dep-dep    to hrkgir-depkod.
 
     modify accept-corrdepkodu enabled = false.
    
*     modify accept-aciklama enabled = false.

     modify lb-foliono-e   title = spaces
     modify fr-foliotipi-e title = spaces
     modify lb-adi-e       title = spaces
     modify lb-soyadi-e    title = spaces
     modify lb-girtar-e    title = spaces
     modify lb-ciktar-e    title = spaces
     modify fr-pansiyon-e  title = spaces
     modify lb-pansiyon-e  title = spaces
     modify fr-odeme-e     title = spaces
     modify lb-odeme-e     title = spaces
     modify lb-topborc-e   title = spaces
     modify lb-topalacak-e title = spaces
     modify lb-bakiye-e    title = spaces
   
     modify lb-acenta      title = spaces
     modify lb-not1        title = spaces
     modify lb-not2        title = spaces
     initialize toplam-not
     display form1.
     modify form1-fr-3 title = tarih-title.

*/-----------------------------\*  
*/---------DIL AYARLA----------\*    
*/-----------------------------\*    
     perform dil-ayarla-proc.
*/-----------------------------\*         

     perform grid-baslik-at thru grid-baslik-at-exit.
     perform bef-procedure.
     .
*
 exception-procedure.
     perform kullandi.
     move control-id to gidis-id
     evaluate key-status
       when 6                                   
          if link-var not = 5 then  
          open input banka
          move konuk-banka to banka-kodu
          start banka  key > banka-kodu
            invalid
             initialize banka-kodu
             start banka key > banka-kodu
               invalid
                continue
             end-start
         end-start
         read banka next
           end continue
           not end
          move banka-kodu to konuk-banka
        end-read
          close banka

          perform kur-bul
          display dov-kur-l 
         end-if

       when 7
*          if link-var not = 5 then  
          perform sonraki-doviz
          perform kur-bul
          display dov-kur-l 
*          end-if
       when 8
*        if link-var not = 5 then       
        
         if control-id = 1008 and (k-kodu-tasi = "ASYA" or "X   ")
            and form-acik(1:6) = "A42   "
              move 1 to a42 
              initialize  form-acik
               move 4 to accept-control
               move 1001 to control-id
                display acc-01 acc-02 acc-03 l-1
                 accept-aciklama
             perform   grid-baslik-at
             perform grid-detay-yukle
         else
         if cinmi= 1 then 
           move 0 to cinmi
           else
           move 1 to cinmi
         end-if
          perform Form1-Cb-1-Ev-Cmd-Clicked
          perform kur-bul
          display dov-kur-l 
          end-if
*         end-if
       when 3131 
          if konuk-fol-kodu = "R" 

            move 5 to link-nereden 
            move "REZ"   to  link-NOT-DOS    
           move konuk-rez-no to link-NOT-DOS-ANAH   
         else
          if konuk-extra-rez-no > 0 then
           move 6 to link-nereden 
           move "REZ"   to  link-NOT-DOS    
           move konuk-extra-rez-no to link-NOT-DOS-ANAH    
           else
           move 6 to link-nereden 
           move "KON"   to  link-NOT-DOS    
           move konuk-folio to link-NOT-DOS-ANAH    
           
          end-if

       end-if 
      
           move "U"     to  link-not-islem
           
           string konuk-adi delimited by "  "
                  " " delimited by size
                  konuk-soyadi delimited by "  " 
                  " " delimited by size
                  "isimli rezervasyon" delimited by size
                  into link-dosya-aciklamasi
     
                   call "/asya/ytl/obj/otel/mesajgir.asy" 
                         using link-not
                          on exception 
                          perform callerr-proc
                          exit paragraph
                        not on exception 
                          cancel "/asya/ytl/obj/otel/mesajgir.asy"
                    end-call
              
                    move  link-not-donus  to  toplam-not
                  display not-ac
         when 1 
            evaluate control-id
              when  1001 
               perform depkod-ara
              when  1002
               perform oda-ara thru oda-ara-exit
              when  1007
               perform corr-depkod-ara
            end-evaluate

         when 2 
*/************kilit kontrol*/***********************
             if konuk-fol-kodu = "R"
                move konuk-rez-no     to xrez-no
             else
                move konuk-extra-rez-no     to xrez-no
             end-if 
             perform dosya-kilit-kontrol
             if link-islkilit-durum <> spaces
               exit paragraph 
             end-if 
*/************kilit kontrol*/***********************
*            initialize depkod-rec
*            move hrkgir-depkod   to depkod-anah
*            read depkod no lock invalid 
*                 display message box "Departman Kodu bulunamadi.."
*                                 title "Uyari"
*                                 icon 1
*                  exit paragraph
*            end-read 
*            if depkod-ba = "A"
*                    if genel-e-arsiv-gecis-tarihi <= tarih-tasi and
*                       genel-e-arsiv-gecis-tarihi > "20150101"
*        
*                          initialize link-earsiv-odeme-bilgileri
*                          move "F"               to link-earsiv-odeme-nereden
*                          move calisma-tarihi    to link-earsiv-odeme-tarihi
*                          move hrkgir-anah       to link-earsiv-odeme-anah
*                          move hrkgir-depkod     to link-earsiv-odeme-depkod
*                          call "/asya/ytl/obj/otel/earsbil.asy" 
*                               using link-earsiv-odeme-bilgileri
*                               on exception 
*                               perform callerr-proc
*                               exit paragraph
*                               not on exception 
*                          cancel "/asya/ytl/obj/otel/earsbil.asy"
*                          end-call
*                    end-if   
*            end-if 
              perform kontroller

              if gecmez
                 initialize gec-gecme
                 move 4        to accept-control
                 move gidis-id to control-id
                 exit paragraph
              end-if
              if ( DEPKOD-TURU = 4 or DEPKOD-TURU = 2 ) and depkod-ba = "A" and genel-onay = 1  then 
                 perform onay-takip
                 if not ONAY-VERILDI 
                    display message box "Islem Kaydedilemedi"
                             title " "
                     exit paragraph
                 end-if
              end-if
              initialize mesaj-degiskenler
              move "Girilen Bilgiler Kaydedilsin Mi ?"  to mmesaj-1
              move " [ Kaydet Basla ] " to mmesaj-title
              move 2           to mmesaj-type
              move 1           to mmesaj-icon
              move 1           to mmesaj-default
              perform mmesaj-ver
              if donus-kodu = 2
                 move 4        to accept-control
                 move gidis-id to control-id
                 exit paragraph
              end-if
              if dovizliislem = 0
                 open input kur 
                 initialize KUR-REC doviz-alis
                   move calisma-tarihi  to kur-tarih
                       move onkpara-banka   to kur-banka
                       move onkpara-doviz   to kur-doviz
                       read kur no lock invalid
                            move 1 to doviz-alis
                      
                           
                       end-read

                    compute hrkgir-dv-tutar rounded = 
                           hrkgir-tl-tutar / doviz-alis

                   close kur
               end-if
               
              perform kaydet
              if link-var = 4 or link-var = 5 then 
                  continue
              else
                set exit-pushed to true

*                  perform grid-yukle thru grid-yukle-exit
*                  move 4    to accept-control
*                  move 1001 to control-id
              end-if
              if depkod-ba = "B" 
              if depkod-turu = 4
                 display message box "PAID-OUT Makbuzu Yazdirilacaktir." new-line
                                     "Eminmisiniz.?"
                                 title "Uyari"
                                 icon 1
                                 type 2 
                                 default 1
                                 returning return-code 
                 if return-code = 2
                    exit paragraph 
                 end-if 
                 perform paid-form-cagir
              end-if 
              end-if 
         when 3            
*/************kilit kontrol*************************
             move konuk-rez-no     to xrez-no
             perform dosya-kilit-kontrol
             if link-islkilit-durum <> spaces
               exit paragraph 
             end-if 
*/************kilit kontrol*************************
              initialize satir sutun
              initialize kllnc-rec
              move k-kodu-tasi to k-kodu
              
              open input kllnc
              read kllnc no lock invalid 
              continue
              end-read
              close kllnc   
          
              if k-cek-silemez = 1 
                 display message box "Bu kullanici ile cek silemezsiniz" new-line
                   "Kullanici Kodlari Tanimlamadan aciniz (Gelismis)" 
                
              else
              if grid-islemno not  = 0  or k-kodu-tasi = "ASYA" then 
                 initialize mesaj-degiskenler
                 move "Kayit Silinsin Mi ?"  to mmesaj-1
                 move " [ SIL ] " to mmesaj-title
                 move 2           to mmesaj-type
                 move 1           to mmesaj-icon
                 move 1           to mmesaj-default
                 perform mmesaj-ver
                 if donus-kodu = 2
                    move 4        to accept-control
                    move gidis-id to control-id
                    exit paragraph
                 end-if

                 perform Acu-Form3-Routine

                 initialize Form1-Gd-1-record minibar-islem-tipi minibar-cek-no
                 inquire Form1-Gd-1, cursor-y in satir cursor-x in sutun
                 inquire Form1-Gd-1(satir,7),
                         cell-data in grid-islemno
                 open i-o nt
                 if konuk-fol-kodu = "R"
                     
                    initialize romhrk-rec
                    move konuk-folio   to romhrk-folio
                    move grid-islemno  to romhrk-islem
                    read romhrk no lock invalid
                        continue 
                    not invalid 
                       initialize depkod2-rec
                       move romhrk-depkod   to depkod2-anah
                       read depkod2 no lock invalid
                            continue 
                       not invalid 
                          if depkod2-sil-fis-ciksin = 1
                            initialize makbuz-cagir
                            move konuk-folio                 to makbuz-folio-no
                            move grid-islemno                to makbuz-islem-no
                            move "S"                         to makbuz-islem-tipi
                            call "/asya/ytl/obj/otel/maklzr.asy" using makbuz-cagir
                                  on exception perform callerr-proc
                                     not on exception
                            cancel "/asya/ytl/obj/otel/maklzr.asy" 
                            end-call          
                           
                          end-if 
                       end-read 
                    end-read 
                 else
                    initialize romhrk-rec
                    move konuk-folio   to exthrk-folio
                    move grid-islemno  to exthrk-islem
                    read exthrk no lock invalid
                        continue 
                    not invalid 
                       initialize depkod2-rec
                       move exthrk-depkod   to depkod2-anah
                       read depkod2 no lock invalid
                            continue 
                       not invalid 
                          if depkod2-sil-fis-ciksin = 1
                            initialize makbuz-cagir
                            move konuk-folio                 to makbuz-folio-no
                            move grid-islemno                to makbuz-islem-no
                            move "S"                         to makbuz-islem-tipi
                            call "/asya/ytl/obj/otel/maklzr.asy" using makbuz-cagir
                                  on exception perform callerr-proc
                                     not on exception
                            cancel "/asya/ytl/obj/otel/maklzr.asy" 
                            end-call          
                           
                          end-if 
                       end-read 
                    end-read 
                 end-if 

                 if konuk-fol-kodu = "R"
                    
                    perform romhrk-sil
  
                    move romhrk-islem-tipi to minibar-islem-tipi
                    move romhrk-cekno     to minibar-cek-no
                    
                 else 
                     
                    perform exthrk-sil
                    move exthrk-islem-tipi to minibar-islem-tipi
                    move exthrk-cekno      to minibar-cek-no
                    
                 end-if
                 close nt

                 if fat-buldum = 1
                    display message box "Faturasi Kesilmis Kayit Silinemez..." new-line
                                        "Faturayi iptal ettikten sonra silme islemine devam ediniz..."
                                    title "Uyari"
                                    icon 1
                      exit paragraph 
                 end-if 
                 
                 if GENEL-MINIBAR-POS-DEP not = spaces and 
                    minibar-islem-tipi = "P"  
                        perform minibar-kayit-sil
                 end-if 
                 inquire form1-gd-1,
                         last-row in return-code
                 if return-code < 2
                    initialize grid-islemno
                 end-if

              end-if
              end-if
*              if kayit-var 
*                 move 4    to accept-control
*                 move 1001 to control-id
*              end-if 
         when 5
           Display message box "Lutfen dovizli islem secenegini tikleyiniz" new-line
                                "Kaydederken otomatik olarak dovizli kasaya alaccaktir" new-line title "KISAYOL KULLANIM DISI"
                                EXiT PARAGRAPH        
           if hrkgir-tl-tutar not > 0 then
                 display message box
                "Once TL Tutarini giriniz"

            else
             
                     if cinmi= 1 then 
                          call "/asya/ytl/obj/otel/dov-boz.asy" 
                                using  konuk-folio   hrkgir-tl-tutar
                                hrkgir-dv-tutar  banka-kodu   doviz-kodu 1
                                on exception 
                                perform callerr-proc
                                exit paragraph
                                not on exception 
                           cancel "/asya/ytl/obj/otel/dov-boz.asy"
                       end-call



       
             else
          
**************************> dov-boz.asy
              initialize dokcagir-tasi
              set dokcagir-tasi-call-dovboz5  to true 
              move konuk-folio                to dokcagir-konuk-folio
              move hrkgir-tl-tutar            to dokcagir-hrkgir-tl-tutar
              move hrkgir-dv-tutar            to dokcagir-hrkgir-dv-tutar
              move banka-kodu                 to dokcagir-banka-kodu
              move doviz-kodu                 to dokcagir-doviz-kodu
              perform dokcagir-call
              move dokcagir-konuk-folio       to konuk-folio
              move dokcagir-hrkgir-tl-tutar   to hrkgir-tl-tutar
              move dokcagir-hrkgir-dv-tutar   to hrkgir-dv-tutar
              move dokcagir-banka-kodu        to banka-kodu
              move dokcagir-doviz-kodu        to doviz-kodu
           
          end-if
            end-if
           
    end-evaluate.

*
 romhrk-sil.
       open i-o silhrk .
       initialize sil-degiskenler fat-buldum
       move grid-islemno  to romhrk-islem
       move konuk-folio   to romhrk-folio
       read romhrk no lock invalid 
            display message box "Silinecek Kayit Bulunamadi....."
                              title = " [ Kayit Yok ] "
            close silhrk
            exit paragraph
       not invalid
*//****30.01.2015 ramazan
            if k-kodu-tasi not = "ASYA"
                if romhrk-fatura-no > 0
                   move 1       to fat-buldum
                   close silhrk
                   exit paragraph
                end-if 
            end-if
*//****30.01.2015 ramazan
            move romhrk-folio     to sil-folio 
            move romhrk-depkod    to sil-depkod
            move romhrk-ba        to sil-ba
            move romhrk-tl-tutar  to sil-tl-tutar
            move romhrk-dv-tutar  to sil-dv-tutar
            
            delete romhrk invalid exit paragraph
            end-delete
            move romhrk-anah      to hrk2-anah
            read hrk2 no lock invalid
                 continue
            not invalid
                delete hrk2 end-delete
            end-read
            move hrk2-kaynak-folio     to yromhrk-folio
            move romhrk-islem          to yromhrk-islem
            read yromhrk no lock invalid
                 stop " "
            not invalid
            if  yromhrk-dovboz-anah not = spaces          
              move  yromhrk-dovboz-anah to  dov-boz-anah 
              read dov-boz no lock invalid continue
               not invalid 
                 delete dov-boz invalid continue
                 end-delete
                 display message box "Dovizli Tahsilat Doviz Kasasindan dusuldu" title "Dovizli Tahsilat"
              end-read
           
            end-if
                delete yromhrk end-delete
             
            end-read
*******>Silinmis kayitlara yaz
            move romhrk-rec to silhrk-rec
            accept silhrk-zaman from time 
            move romhrk-tarih to silhrk-tarih
            move k-kodu-tasi to silhrk-staf
            write silhrk-rec invalid continue
            end-write.
            close silhrk.

           initialize not-rec
            move  "SHR"      to NOT-DOS
           move silhrk-anah to  NOT-DOS-ANAH 
          
           read nt no lock invalid 
                initialize not1
           end-read
           move neden-silindi to not1 
   
             write not-rec invalid 
                 continue 
             end-write

            perform onkasa-eksilt thru onkasa-eksilt-exit
*/CORRECTION
            if silhrk-corr-depkod <> zeroes
               perform onkasa-corr-eksilt
            end-if
*/CORRECTION

            perform konuk-eksilt  thru konuk-eksilt-exit
            modify Form1-Gd-1, record-to-delete(satir)
                               cursor-y = 2 cursor-x = 2
                               mass-update = 0.
            inquire form1-gd-1(2,7),
                    cell-data in grid-islemno.
            .

 exthrk-sil.
       open i-o silhrk.
       initialize sil-degiskenler fat-buldum.
       move grid-islemno  to exthrk-islem
       move konuk-folio   to exthrk-folio
       read exthrk no lock invalid 
            display message box "Silinecek Kayit Bulunamadi....."
                              title = " [ Kayit Yok ] "
            close silhrk
            exit paragraph
       not invalid 
*//****30.01.2015 ramazan
             if k-kodu-tasi not = "ASYA"
                  if exthrk-fatura-no > 0
                     move 1       to fat-buldum
                     close silhrk
                     exit paragraph
                  end-if 
             end-if             
*//****30.01.2015 ramazan
            move exthrk-folio     to sil-folio 
            move exthrk-depkod    to sil-depkod
            move exthrk-ba        to sil-ba
            move exthrk-tl-tutar  to sil-tl-tutar
            move exthrk-dv-tutar  to sil-dv-tutar
            delete exthrk invalid exit paragraph
            end-delete.
            move exthrk-anah      to hrk2-anah
            read hrk2 no lock invalid
                 continue
            not invalid
                delete hrk2 end-delete
            end-read
            move hrk2-kaynak-folio     to yromhrk-folio
            move exthrk-islem          to yromhrk-islem
            read yromhrk no lock invalid
                 stop " "
            not invalid
                delete yromhrk end-delete
                if  yromhrk-dovboz-anah not = spaces
           
              move  yromhrk-dovboz-anah to  dov-boz-anah 
             read dov-boz no lock invalid continue
               not invalid 
                 delete dov-boz invalid continue
                 end-delete
                 display message box "Dovizli Tahsilat Doviz Kasasindan dusuldu" title "Dovizli Tahsilat"
              end-read
           
           end-if
            end-read

*******>Silinmis kayitlara yaz
            move exthrk-rec to silhrk-rec
            accept silhrk-zaman from time 
             move exthrk-tarih to silhrk-tarih
****            move calisma-tarihi to silhrk-tarih
            move k-kodu-tasi to silhrk-staf
            write silhrk-rec invalid continue
            end-write.
            close silhrk.
           initialize not-rec
            move  "SHR"      to NOT-DOS
           move silhrk-anah to  NOT-DOS-ANAH 
          
           read nt no lock invalid 
                initialize not1
           end-read
           move neden-silindi to not1 
   
             write not-rec invalid 
                 continue 
             end-write

            perform onkasa-eksilt thru onkasa-eksilt-exit

*/CORRECTION
            if silhrk-corr-depkod <> zeroes
               perform onkasa-corr-eksilt
            end-if
*/CORRECTION

            perform konuk-eksilt  thru konuk-eksilt-exit
            modify Form1-Gd-1, record-to-delete(satir)
                               cursor-y = 2 cursor-x = 2
                               mass-update = 0.
            inquire form1-gd-1(2,7),
                    cell-data in grid-islemno.
            .
*



*
 kaydet.
          if hrkgir-ISLEM  < 1 then 
            display message box "Islem Kaydedilemedi"
                            title " "
             exit paragraph
          end-if
         
          move "M"              to hrkgir-islem-tipi
          move calisma-tarihi   to hrkgir-tarih
          move depkod-ba        to hrkgir-ba
          accept hrkgir-zaman from time
          move k-kodu-tasi      to hrkgir-staf
          if corr-dep-dep <> zeroes
             move corr-dep-dep  to hrkgir-corr-depkod
          end-if
          move hrkgir-rec       to romhrk-rec exthrk-rec
          if depkod-ba = "A" and depkod-turu = 3 
            if  dovizliislem = 1 
              continue
            end-if
          end-if
********************kopyalanacak
               
*          open i-o yromhrk
          move hrkgir-rec  to yromhrk-rec
          move hrk2-data to yromhrk-data
          initialize yromhrk-dovboz-anah 
          if dovizliislem = 1 then
             initialize yedek-form-acik
             move form-acik              to yedek-form-acik
             initialize form-acik
             if cashislem = 1 
                 initialize dov-boz-rec
                      open i-o genelfis
                      move 1 to genelfis-anahtar
                     read genelfis no lock invalid 
                        initialize genelfis-rec 
                        move 1 to genelfis-anahtar
                        
                     end-read
                        add 1 to dov-boz-oto
                        move dov-boz-oto to dov-boz-fisno    
                        if DOV-BOZ-ALIS-SATIS(1:1) = 1
                           move 1 to dov-boz-fisno(1:1)
                        end-if      
                        rewrite genelfis-rec invalid continue  end-rewrite
                        close genelfis
                        move calisma-tarihi to dov-boz-tarih
        
                     |move konuk-banka to DOV-BOZ-BANKA 
                     move banka-kodu to DOV-BOZ-BANKA 
    
                     move "D" to  DOV-BOZ-TIPI  
                     if dep-konuk-doviz > 0
                        move dep-konuk-doviz to  DOV-BOZ-DOVIZ   yromhrk-doviz-kodu     
                     else
                      move konuk-doviz to  DOV-BOZ-DOVIZ   yromhrk-doviz-kodu     
                     end-if 
                          
                     move hrkgir-dv-tutar to  DOV-BOZ-DV-TUTAR  
                     move hrkgir-tl-tutar to  DOV-BOZ-tl-TUTAR  DOV-BOZ-NET-TL-TUTAR
                     compute  DOV-BOZ-KUR-TUTAR rounded =  DOV-BOZ-TL-TUTAR /   DOV-BOZ-DV-TUTAR
                     move konuk-folio   to DOV-BOZ-FOLIO
                     move konuk-adi     to DOV-BOZ-ADI
                     move konuk-soyadi  to DOV-BOZ-SOY
                     move konuk-ulke    to DOV-BOZ-ULKE 
                     if hrkgir-ba = "B"
                         move 1             to DOV-BOZ-ALIS-SATIS
                         else 
                         move 0             to DOV-BOZ-ALIS-SATIS
                     end-if
                     accept DOV-BOZ-ZAMAN from time
                    
                     move cinmi to      DOV-BOZ-ELLE
                     move konuk-odano to  DOV-BOZ-ODA          DOV-BOZ-islem        
                     move "F" to  dov-boz-nereden   
                     move k-kodu-tasi to DOV-BOZ-STAF 
                     if link-var = 5  
                         if cinmi = 1 
                         if dep-konuk-doviz > 0
                           move dep-konuk-doviz to DOV-BOZ-DOVIZ yromhrk-doviz-kodu
                         else
                           move rez-doviz to DOV-BOZ-DOVIZ yromhrk-doviz-kodu
                         end-if
                         end-if
                     end-if
                    write dov-boz-rec 
                      invalid 
                       display message box "Dovizli taksilat yapilamadi"
                       end-write   
                     if dep-konuk-doviz > 0
                        move dep-konuk-doviz to  doviz-kodu
                     else
                      move konuk-doviz to doviz-kodu
                     end-if                     
                     
                       open input doviz
                    read doviz no lock invalid 
                        continue
                    end-read
                       close  doviz
                        move dov-boz-anah        to yromhrk-dovboz-anah
                        move hrkgir-dv-tutar  to  yromhrk-doviz-tut                   
                        move hrkgir-dv-tutar to z-dov       

                        move  z-dov     to form-acik(3:10)
                        move d-kisa-adi to form-acik(12:5)
                        move "DT" to form-acik(1:2)
                        if yedek-form-acik not = spaces 
                           move "-"  to form-acik(17:1)
                           move yedek-form-acik to form-acik(19:)
                        end-if 
             else  


                        initialize dep-konuk-doviz        
                                    if depkod-ba = "A" 
                                       if depkod-turu = 5  
                                           if depkod2-dov-kod not = spaces and 
                                              depkod2-dov-kod not = zeroes
                                                  move depkod2-dov-kod      to dep-konuk-doviz
                                           end-if 
                                       end-if 
                                        if depkod-turu = 3  
                                           if depkod2-dov-kod not = spaces and 
                                              depkod2-dov-kod not = zeroes
                                                  move depkod2-dov-kod      to dep-konuk-doviz
                                           end-if 
                                       end-if 
                                    end-if   

                    move hrkgir-dv-tutar to z-dov 
                   
                    if dep-konuk-doviz > 0
                       move dep-konuk-doviz  to doviz-kodu   yromhrk-doviz-kodu
                    else
                       move konuk-doviz to doviz-kodu   yromhrk-doviz-kodu
                    end-if 
                    if link-var = 5  
                        if cinmi = 1 
                           if dep-konuk-doviz > 0 
                             move dep-konuk-doviz  to doviz-kodu yromhrk-doviz-kodu
                           else
                             move rez-doviz to doviz-kodu yromhrk-doviz-kodu
                           end-if
                        end-if
                    end-if
                       open input doviz
                       read doviz no lock invalid 
                            continue
                       end-read
                       close  doviz
                      move 1 to yromhrk-dovizli-kk
                      move hrkgir-dv-tutar  to  yromhrk-doviz-tut z-dov

                      move "DKK " to form-acik(1:3) 
                      move  z-dov to form-acik(4:10)
                      move d-kisa-adi to form-acik(17:5)

                      if yedek-form-acik not = spaces
                         move "-"  to form-acik(23:1)
                         move yedek-form-acik to form-acik(25:)
                      end-if                  
             end-if
           end-if

           if cinmi = 1 then
               move 1 to yromhrk-cin-kur
               else
               move 0 to yromhrk-cin-kur
           end-if
         if link-var = 5
            move link-onodeme-rez  to yromhrk-rez-no
           
            if link-onodeme-rez > 0                  
                open input rez
                initialize rez-rec
                move link-onodeme-rez to rez-no
                read rez no lock invalid 
                    display message box "Kaydedilmemis Rezervasyona On Odeme Girmektesiniz."
                                    title "Uyari"
                                    icon 1
                not invalid
                  if cinmi = 1
                    move rez-cin-kur-tar   to yromhrk-kur-tarih
                    move rez-cin-kuru      to yromhrk-kur-degeri
                    move rez-doviz         to yromhrk-doviz-kodu
                  else
*****                     move rez-cin-kur-tar   to yromhrk-kur-tarih

                   if dovizliislem = 1 
                      compute yromhrk-kur-degeri rounded =   hrkgir-tl-tutar / hrkgir-dv-tutar  
                      if onodeme-vis = 1 
                      move  ukur-tar to          yromhrk-kur-tarih
                      end-if
                   end-if
                 end-if
                end-read 
                close rez
            end-if
            
            if dovizliislem = 1 
                 move  hrkgir-dv-tutar to  z-dov
                   move yromhrk-doviz-kodu to doviz-kodu 
                       open input doviz
                    read doviz no lock invalid continue
                    end-read
                       close  doviz
              else
                 move  hrkgir-tl-tutar to  z-dov
                 initialize d-kisa-adi
                 move "TL      " to d-kisa-adi
           end-if
           initialize yedek-form-acik
           move form-acik            to yedek-form-acik
           initialize form-acik

           string 
                 "OO:" delimited by size                                 
                 z-dov delimited by size
                 d-kisa-adi delimited by "  "
                  " " delimited by size
                  rez-adi delimited by "  " 
                  " " delimited by size
                 rez-soyadi delimited by  "  "
                
                 "-" delimited by size
                 link-onodeme-rez delimited by "  "
                 "-" delimited by size 
                 yedek-form-acik delimited by size 
                 
            into form-acik
         end-if
           
         if depkod-ba = "A"
            if depkod-turu = 5 
               move 1  to onay-var
               display lb-onay-no accept-onay-no
               
               move onay-no  to yromhrk-kk-onay-kodu
               if yromhrk-kk-onay-kodu not = spaces
                    string form-acik delimited by "          "
                         "-" delimited by size
                         "Onay Kodu : " delimited by "       "  
                         yromhrk-kk-onay-kodu delimited by size
                    into form-acik
               end-if 

            else
               move 0  to onay-var
               display lb-onay-no accept-onay-no
            end-if
         else
            move 0  to onay-var
            display lb-onay-no accept-onay-no
         end-if 
         

         write yromhrk-rec invalid  
            display message box " hatali islem tekrar giriniz"
             exit paragraph
          
          end-write 
*         close yromhrk
           open input route konu2 rez
          perform folref-bul
          perform folref-ata
          close route konu2  rez
*          open i-o hrk2
          move hrkgir-anah to hrk2-anah
          move yromhrk-folio to hrk2-kaynak-folio
          
          write hrk2-rec end-write
*          close hrk2
          move hrkgir-rec       to romhrk-rec exthrk-rec
**************** kopyalanacak
          open input konu2
          move hrkgir-folio   to konu2-folio
          read konu2 no lock invalid 
               close konu2
               exit paragraph 
          end-read 
          close konu2

          if konu2-fol-kodu = "R"
             write romhrk-rec end-write,

             else
             write exthrk-rec end-write
          end-if.
          
          perform aciklama-yaz
          perform onkasa-artir thru onkasa-artir-exit
*/CORRECTION
          if hrkgir-corr-depkod <> zeroes
             perform onkasa-corr-artir
          end-if
*/CORRECTION
          open i-o konu2
          perform konuk-artir  thru konuk-artir-exit
          close konu2
          if ( DEPKOD-FATURA-TAKIP = "E" and  0 = 1 ) 
             perform oto-fatura
          else
         
             if depkod-makbuz = "E" 
               perform makbuz-cik thru makbuz-cik-exit
              end-if
           end-if
                   if onay-uygulandi-yaz = 1 
               open i-o onay
                   set onay-uygulandi to true
                    move k-kodu-tasi to ONAY-uyg-STAF
                                                accept ONAY-uyg-TARIH from century-date 
                                                accept ONAY-uyg-zaman  from time
                   rewrite  onay-rec invalid write onay-rec end-rewrite
                 close onay
                 initialize onay-uygulandi-yaz
              end-if 
          
*          if link-var = 4 then 
             set exit-pushed to true
*          end-if.
*               .
               .

 folref-bul.
*       if k-kodu-tasi = "ASYA" then stop " " end-if
       initialize aroute-anah routtur routyazma routbulundu  extradan-geldi
       
          
       if konuk-grup-no > 0 then 
          move konuk-grup-no to aroute-rezno
          move konuk-grup-no to aroute-folio
            move hrkgir-depkod   to route-depkod
          else
          move high-values to  aroute-anah
       end-if
         move aroute-anah to route-anah
             move hrkgir-depkod   to route-depkod
         read route no lock invalid
           
                initialize route-rec aroute-anah
               if konuk-fol-kodu = "R" then 
                  move konuk-rez-no to aroute-rezno
                 else
*                  if konuk-extra-rez-no  > 0 
*                      move 1 to extradan-geldi
*                      move konuk-extra-rez-no to aroute-rezno
*                   else
                      move konuk-folio to aroute-folio
*                  end-if
               end-if

       end-read


       perform until routbulundu = 1 or routtur > 10 
       add 1 to routtur
       initialize route-rec
       move aroute-anah to route-anah
       move hrkgir-depkod   to route-depkod
       if hrkgir-corr-depkod not = spaces and hrkgir-corr-depkod not = zeroes 
         move  hrkgir-corr-depkod to route-depkod
       end-if
       read route no lock invalid
           
           perform rout-folio-kontrol
           perform def-pen-bul
            move 1 to routbulundu
         not invalid
         if route-tip = "P"

            perform rout-folio-kontrol
            move 1 to routbulundu
          else
            if route-tip = "F" 
               if route-no <> route-folio
                        initialize aroute-anah
                        move route-no to  aroute-folio
                   else
                     perform rout-folio-kontrol
                     perform def-pen-bul
                     move 1 to routbulundu

                end-if
              else   
                if route-no <> route-rezno
                      initialize aroute-anah

                      move route-no  to aroute-rezno
                         else
                       perform rout-folio-kontrol
                       perform def-pen-bul
                       move 1 to routbulundu
               end-if 
            end-if
        end-if
        end-read
       end-perform 
        .
 rout-folio-kontrol.
     initialize konu2-rec
     if route-rezno = 0 then
       move route-folio to konu2-folio
       else
        move route-rezno to rez-no
        read rez no lock invalid
         move 1 to routyazma
        end-read
          
            if extradan-geldi = 1 then 
            
               compute konu2-folio = rez-folio + 1
               read konu2 no lock invalid 
                   move 1 to routyazma
                   move konuk-folio to konu2-folio
                     read konu2 no lock invalid 
                        continue
                      end-read

                   not invalid
                   if konu2-extra-rez-no = rez-no then 
                      continue
                      else
                      move 1 to routyazma
                      move konuk-folio to konu2-folio
                      read konu2 no lock invalid 
                        continue
                      end-read
                  end-if
               end-read
               else
                move rez-folio to konu2-folio
                read konu2 no lock invalid
                       continue
                      end-read
           end-if

    end-if
       read konu2 no lock 
          invalid
           move 1 to routyazma
          not invalid
          if KONU2-ACIK-KAPALI    = "C" 
            move 2 to routyazma
          end-if
          if KONU2-DURUMU not = "I" and konu2-acik-hesap not = 1 then
              move 3 to routyazma
          end-if
       end-read
          .
 def-pen-bul.
        
       initialize konu2-rec
      if route-rezno = 0 then
        move route-folio to konu2-folio
      else
        initialize rez-rec
        move route-rezno to rez-no
        read rez no lock invalid
         move 1 to routyazma
        end-read
          if extradan-geldi = 1 then 
               compute konu2-folio = rez-folio + 1
               read konu2 no lock invalid 
                   move 1 to routyazma
                   move konuk-folio to konu2-folio
                   read konu2 no lock invalid
                       continue
                      end-read
                   not invalid
                   if konu2-extra-rez-no = rez-no then 
                      continue
                      else
                      move 1 to routyazma
                      move konuk-folio to konu2-folio
                      read konu2 no lock invalid
                       continue
                      end-read
                  end-if
               end-read
          else
                move rez-folio to konu2-folio
                read konu2 no lock invalid
                       continue
                      end-read
          end-if
     end-if                    
       read konu2 no lock 
          invalid
           move 1 to routyazma
           move konuk-folio to konu2-folio
           read konu2 no lock invalid continue
           end-read
          not invalid
             move "B"               to kodlar02-tipi
               move konu2-odeme-tipi  to kodlar02-kodu 
              read kodlar02 no lock invalid
                    move 1 to route-no
             
                  not invalid
                     if ode-tipi  not =  "A"  | KREDI ISE
                        if hrkgir-corr-depkod not = spaces
                                    move  hrkgir-corr-depkod to depkod-anah
                                    read depkod no lock invalid continue
                                    end-read
                        end-if
                          if depkod-tipi = 2 then 
                                 move 1 to route-no
                             else
                                move 2 to route-no
                          end-if
                          if hrkgir-corr-depkod not = spaces

                                    move  hrkgir-depkod to depkod-anah
                                    read depkod no lock invalid continue
                                    end-read
                                   
                          end-if
                      else
                         move 1 to route-no
                   end-if
             end-read
       end-read
          .
*
 folref-ata.
     if routyazma = 0 and routbulundu = 1 
      move konu2-folio to hrkgir-folio
      if vis-pen = 1 then
          move odemepen to hrkgir-ref
          if link-pencere = 0         ||| 07.08.2020 ramazan ekleme
            move bol-tut to hrkgir-ref    ||| 07.08.2020 ramazan ekleme
          end-if     ||| 07.08.2020 ramazan ekleme
      else
          move route-no to hrkgir-ref
      end-if
      else
       move konuk-folio to konu2-folio
       read konu2 no lock invalid
          stop " " 
       end-read 
       if vis-pen = 1 then
          move odemepen to hrkgir-ref
             else
          move 1 to hrkgir-ref
      end-if
    end-if
       .
*
 oto-fatura.
*       call "/asya/ytl/obj/otel/folfat1.asy" 
*            using  konuk-folio, konuk-odano
*         on exception 
*             perform callerr-proc
*             exit paragraph
*         not on exception 
*             cancel "/asya/ytl/obj/otel/folfat1.asy"
*       end-call
     .
*
 aciklama-yaz.
        if form-acik not = spaces then
           open i-o nt
               initialize not-rec
               if konuk-fol-kodu = "R"
                  move  "RHR"     to NOT-DOS
                  move romhrk-anah to  NOT-DOS-ANAH 

                  else
                  move  "EHR"      to NOT-DOS
                  move exthrk-anah to  NOT-DOS-ANAH 

               end-if
               move form-acik to not1

              write not-rec invalid
                display message box "Cakisma Hatasi 232352"
              end-write
          
           close nt
         end-if   .


*
 onkasa-artir.
       move hrkgir-tarih    to onkasa-tarih.
       move hrkgir-depkod   to onkasa-dep.
       read onkasa no lock invalid 
            go onkasa-yeni-isle
            not invalid continue 
       end-read.
       compute onkasa-tutar-tl   = onkasa-tutar-tl + hrkgir-tl-tutar.
       compute onkasa-tutar-dv   = onkasa-tutar-dv + hrkgir-dv-tutar.
       rewrite onkasa-rec invalid 
               write onkasa-rec 
               end-write continue
       end-rewrite.
       go onkasa-artir-exit.

*/CORRECTION
 onkasa-corr-artir.
 
       move hrkgir-tarih              to onkasa-tarih.
       move hrkgir-corr-depkod        to onkasa-dep.
       read onkasa no lock invalid 
            initialize onkasa-rec
            move hrkgir-tarih         to onkasa-tarih
            move hrkgir-corr-depkod   to onkasa-dep
       end-read.
       compute onkasa-corr-tutar-tl = 
       onkasa-corr-tutar-tl + hrkgir-tl-tutar
       
       compute onkasa-corr-tutar-dv = 
       onkasa-corr-tutar-dv + hrkgir-dv-tutar

       rewrite onkasa-rec invalid 
               write onkasa-rec end-write
       end-rewrite.

 onkasa-yeni-isle.
       initialize onkasa-rec.
       move hrkgir-tarih    to onkasa-tarih.
       move hrkgir-depkod   to onkasa-dep.
       move hrkgir-tl-tutar to onkasa-tutar-tl.
       move hrkgir-dv-tutar to onkasa-tutar-dv.
       write onkasa-rec invalid 
             rewrite onkasa-rec 
             end-rewrite continue 
       end-write.
 onkasa-artir-exit.
       exit.

 onkasa-eksilt.

       move SILHRK-TARIH    to onkasa-tarih.
       move sil-depkod        to onkasa-dep.
       read onkasa no lock invalid 
            go onkasa-eksilt-exit
            not invalid continue 
       end-read.
       compute onkasa-tutar-tl   = onkasa-tutar-tl - sil-tl-tutar.
       compute onkasa-tutar-dv   = onkasa-tutar-dv - sil-dv-tutar.
       rewrite onkasa-rec invalid continue.
 onkasa-eksilt-exit.
       exit.

*/CORRECTION
 onkasa-corr-eksilt.
       move SILHRK-TARIH            to onkasa-tarih.
       move silhrk-corr-depkod        to onkasa-dep.
       read onkasa no lock invalid 
            continue
       end-read.
       compute onkasa-corr-tutar-tl   = onkasa-corr-tutar-tl - sil-tl-tutar.
       compute onkasa-corr-tutar-dv   = onkasa-corr-tutar-dv - sil-dv-tutar.
       rewrite onkasa-rec invalid 
               write onkasa-rec end-write
       end-rewrite.
 konuk-artir.
           move hrkgir-folio   to konu2-folio.
           read konu2 no lock invalid 
                go konuk-artir-exit
                not invalid continue
           end-read.
           if hrkgir-ba = "B"
              compute konu2-top-borc = konu2-top-borc + hrkgir-tl-tutar.
           if hrkgir-ba = "A"
              compute konu2-top-alac = konu2-top-alac + hrkgir-tl-tutar.
          rewrite konu2-rec invalid continue.
 konuk-artir-exit.
      exit.
 konuk-eksilt.
    move sil-folio to konuk-folio.
    read konuk no lock invalid 
         go konuk-eksilt-exit
         not invalid continue
    end-read.
    if sil-ba = "B"
       compute konuk-top-borc = konuk-top-borc - sil-tl-tutar.
    if sil-ba = "A"
       compute konuk-top-alac = konuk-top-alac - sil-tl-tutar.
    rewrite konuk-rec invalid continue.
 konuk-eksilt-exit.
      exit.
*                                  
 bef-procedure.
     if control-id not = 1008
        initialize grid-islemno
     end-if
*     move control-value    to sonraki-kontrol
*     move control-id       to sonraki-id
*     display message box "o-k->" onceki-kontrol, new-line
*                         "S-k->" sonraki-kontrol, new-line
*                         "O-id->" onceki-id, new-line
*                         "S-Id->" sonraki-id, new-line
*                         "key-->" key-status new-line
*                         "gec-gecme-->" gec-gecme.
***>Onceki Kontrole gidebildin ama sonrakine gidemesin....
*     if gecmez


*        if sonraki-kontrol not = 2
*           if sonraki-kontrol > onceki-kontrol
*              move 4         to accept-control
*              move onceki-id to control-id
*              exit paragraph
*           end-if
*        end-if
*     end-if
      if control-id = 1001 then
          perform fisno-al

      end-if
     if control-id = 1005 and hrkgir-tl-tutar not = 0 and
        sonraki-kontrol > onceki-kontrol
        perform tlden-doviz
                move 4    to accept-control
                move 1006 to control-id
     end-if 
     

     initialize mesaj.
     evaluate control-id
          when 1001
              evaluate true
                  when turkce
                       move "Departman Kodu Giriniz... F1->Departman Kodu Ara..." to mesaj
                  when almanca
                       move "Departman Kodu Giriniz... F1->Departman Kodu Ara..." to mesaj
                  when ingilizce
                       move "Departman Kodu Giriniz... F1->Departman Kodu Ara..." to mesaj
              end-evaluate
          when 1002
              evaluate true
                  when turkce
                       move "Oda Numarasi Giriniz F1->Oda No Ara..." to mesaj
                  when almanca
                       move "Oda Numarasi Giriniz F1->Oda No Ara..." to mesaj
                  when ingilizce
                       move "Oda Numarasi Giriniz F1->Oda No Ara..." to mesaj
              end-evaluate
          when 1004
            if depkod-turu  = 3 
             if hrkgir-dv-tutar = 0 then 
              move 1 to v-ort
           
            end-if
            end-if
              evaluate true
                  when turkce
                       move "Islemin [ TL ] Tutarini Giriniz... " to mesaj
                  when ingilizce
                       move "Islemin [ TL ] Tutarini Giriniz... " to mesaj
                  when almanca
                       move "Islemin [ TL ] Tutarini Giriniz... " to mesaj
              end-evaluate
          when 1005
              evaluate true
                  when turkce
                       move "Islemin [ Doviz ] Tutarini Giriniz... " to mesaj
                  when ingilizce
                       move "Islemin [ Doviz ] Tutarini Giriniz... " to mesaj
                  when almanca
                       move "Islemin [ Doviz ] Tutarini Giriniz... " to mesaj
              end-evaluate
          when 1006
              evaluate true
                  when turkce
                       move "Cek Numarasini Giriniz......" to mesaj
                  when ingilizce
                       move "Cek Numarasini Giriniz......" to mesaj
                  when almanca
                       move "Cek Numarasini Giriniz......" to mesaj
              end-evaluate
          when 1007
              evaluate true
                  when turkce
                       move "Correction Yapilan Departman Kodu..F1->Departman Kodu Ara " to mesaj
                  when ingilizce
                       move "Correction Yapilan Departman Kodu..F1->Departman Kodu Ara " to mesaj
                  when almanca
                       move "Correction Yapilan Departman Kodu..F1->Departman Kodu Ara " to mesaj
              end-evaluate
          when 1008
              evaluate true
                  when turkce
                       move "Departman Makbuzu Icin Aciklama Giriniz" to mesaj
                  when ingilizce
                       move "Departman Makbuzu Icin Aciklama Giriniz" to mesaj
                  when almanca
                       move "Departman Makbuzu Icin Aciklama Giriniz" to mesaj
              end-evaluate
          when 1009
              evaluate true
                  when turkce
                       move "Girilen Bilgileri Kaydet " to mesaj
                  when ingilizce
                       move "Girilen Bilgileri Kaydet " to mesaj
                  when almanca
                       move "Girilen Bilgileri Kaydet " to mesaj
              end-evaluate
          when 1010
              evaluate true
                  when turkce
                       move "Kaydi Sil " to mesaj
                  when ingilizce
                       move "Kaydi Sil " to mesaj
                  when almanca
                       move "Kaydi Sil " to mesaj
              end-evaluate
          when 1011
              evaluate true
                  when turkce
                       move "Girilen Kaydi Outlet Cash'e Aktar " to mesaj
                  when ingilizce
                       move "Girilen Kaydi Outlet Cash'e Aktar " to mesaj
                  when almanca
                       move "Girilen Kaydi Outlet Cash'e Aktar " to mesaj
              end-evaluate
     end-evaluate.

     modify form1-st-1-handle,
            panel-index = 2 
            panel-text = mesaj.
     .
*
 Form1-Aft-Initdata.
      
     modify form1-fr-3 title = tarih-title.
     perform olasi-dep-bul 
     if link-var > 0 then
        initialize hata
        move link-fol-no to konuk-folio
        read konuk no lock 
           invalid 
             display message box "konuk bulnaamadi Folio---" konuk-folio
             set exit-pushed to true
             exit paragraph

           not invalid
           if konuk-fol-kodu not = "E"
                if konuk-kur-degeri = 0 then 
                     display message box "Bu folioya cin-kuru girilmelidir.",
                                         "Aksi Halde Hareket giremessiniz",
                                         "Herhangi bir folioya girip buraya routelayiniz veya",
                                         "Register Kartndan CIN kuru belirleyiniz " title "HATA"
                     set exit-pushed to true
                     exit paragraph
               end-if
            end-if 
*           if k-kodu-tasi = high-values  and konuk-durumu = "H" 
*               move konuk-git-tar to calisma-tarihi
*                display message box "SELAHATTIN DIKKAT GECMISE ISLEM YAPIYOSUN"
*           end-if
       
           if  (konuk-durumu = "I" or konuk-acik-hesap = 1  ) 
               perform uygun-folio  
               perform fisno-al
              
           end-if
        end-read
         if konuk-fol-kodu = "R" and CINPARA-EXT-FOL-AC ="E"
          move 1 to cinmi
           perform Form1-Cb-1-Ev-Cmd-Clicked
        end-if                                
         if link-var = 5 then  
****             move 1 to cinmi
              
             move 0 to cinmi
             perform Form1-Cb-1-Ev-Cmd-Clicked
        end-if
        perform kur-bul
        if konuk-fol-kodu = "E" then 
            move 1 to vextra
            else
            move 0 to vextra
        end-if
        display lextra
         if link-var = 4 then

*           if link-depkod = onkpara-city-ledger 
           move link-depkod   to hrkgir-depkod
*           end-if
           move 1001 to control-id
            if   mesaj-title(1:5) = "SMAMI"
           move mesaj-title(6:)  to form-acik
           display accept-aciklama
           end-if
           move link-tl-tutar to hrkgir-tl-tutar 
           display accept-tltutar accept-depkodu
             perform    Aft-Procedure
             if hata not = 1 then 
            move 1001 to control-id
            if link-depkod = onkpara-city-ledger and hata not = 1 then
            move 2 to key-status
            perform Exception-Procedure
            set exit-pushed to true
            end-if
            end-if
         end-if
     end-if 
     move konuk-rez-no     to xrez-no

     perform cek-kontrol                       | firat delphine istei 23/09/2020

     perform dosya-kilit-kontrol

*/-----------------------------\*  
*/---------DIL AYARLA----------\*    
*/-----------------------------\*    
     perform dil-ayarla-proc.
*/-----------------------------\*         
      
 uygun-folio.
        perform accept-depkodu-Bef-Procedure
        move konuk-odano to o-kisa
        perform oda-uzat
        move o-uzun to cekgir-odano 
        display accept-odano
        move 1           to onceki-kontrol
        move 1002        to onceki-id
        move 1002        to gidis-id.
        move konuk-folio to hrkgir-folio
        initialize konuk-uygun
        perform musteri-oku 
 
          if konuk-uygun = 1
                  move 1 to gec-gecme
                  set exit-pushed to true
                 exit paragraph
                 
          end-if
              perform grid-yukle thru grid-yukle-exit
              
            
              move 4 to accept-control
              move 1001 to control-id
      .
*
 cek-kontrol.
      open i-o genelfis
      initialize genelfis-rec 
      move 1 to genelfis-anahtar

      read genelfis no lock invalid 
           move 1 to ekran-fis-1
      end-read
      
      add 1 to ekran-fis-1
      
      move ekran-fis-1(2:) to takcek-no 
      write genelfis-rec invalid 
            rewrite genelfis-rec end-rewrite
      end-write
      close genelfis
      open output takcek close takcek open i-o takcek

      evaluate konuk-fol-kodu
          when "R" 
               initialize romhrk-rec 
               move link-fol-no to romhrk-folio
               start romhrk key not < romhrk-anah invalid
                     continue
               not invalid
               perform with test after until fs-romhrk = "10" 
               read romhrk next no lock end move "10" to fs-romhrk
               not at end 
                   if romhrk-cekno not > 0 
                      exit perform cycle 
                   end-if

                   if romhrk-folio <> link-fol-no
                      exit perform 
                   end-if

                   initialize takcek-rec 
                   move romhrk-folio to takcek-folio 
                   move romhrk-cekno to takcek-cek

                   read takcek no lock invalid continue end-read 

                   move romhrk-tarih to takcek-tar

                   write takcek-rec invalid
                         rewrite takcek-rec end-rewrite 
                   end-write

               end-read 
               end-perform
               end-start       
          when "E" 
               initialize exthrk-rec 
               move link-fol-no to exthrk-folio
               start exthrk key not < exthrk-anah invalid
                     continue
               not invalid
               perform with test after until fs-exthrk = "10" 
               read exthrk next no lock end move "10" to fs-exthrk
               not at end 
                   if exthrk-cekno not > 0 
                      exit perform cycle 
                   end-if

                   if exthrk-folio <> link-fol-no
                      exit perform 
                   end-if

                   initialize takcek-rec 
                   move exthrk-folio to takcek-folio 
                   move exthrk-cekno to takcek-cek

                   read takcek no lock invalid continue end-read 

                   move exthrk-tarih to takcek-tar

                   write takcek-rec invalid
                         rewrite takcek-rec end-rewrite 
                   end-write

               end-read 
               end-perform
               end-start       
      end-evaluate 
      close takcek
      .
*
 Aft-Procedure.
      perform kullandi.
      move control-value    to onceki-kontrol
      move control-id       to onceki-id
      move control-id to gidis-id.
      evaluate control-id
       when 1001
         
         initialize gec-gecme ba-kontrol onay-no oto-cinkuru  
         move hrkgir-depkod to depkod-kodu dep-dep ba-kontrol  depkod2-kodu
         read depkod no lock invalid 
               move 4         to accept-control
               move gidis-id  to control-id
               move 1 to hata     
         not invalid 
              if depkod-kullanma = 1 then 
                 move 4          to accept-control
                 move gidis-id   to control-id
                 move 1          to hata
                 exit paragraph
              end-if
              read depkod2 no lock invalid
                  continue 
              end-read 
                 if depkod-ba = "A" 
                   if depkod-turu = 3
                     if konuk-fol-kodu = "R" and CINPARA-EXT-FOL-AC = "E" 
                           move 1 to oto-cinkuru
                           move 1 to cinmi
                           perform Form1-Cb-1-Ev-Cmd-Clicked
               perform kur-bul
             display dov-kur-l 
                     end-if
                   end-if
                    if depkod-turu = 5 
*/*******************************likya world istek*******************
                       if depkod2-dov-kod > 0
                          if link-var = 5
                            move 0 to cinmi
                          end-if 
                       end-if 
*/*******************************likya world istek*******************
                       move 1  to onay-var
                       display lb-onay-no accept-onay-no                       
                    else
                       move 0  to onay-var
                       display lb-onay-no accept-onay-no
                    end-if
                 else         
                    move 0  to onay-var
                    display lb-onay-no accept-onay-no
                 end-if 
               move 0 to tl-degisme
               if depkod-turu = 3 and (depkod-ba = "A" or "B")
                                          move 1 to cashislem
                                          
                                          if depkod-ba =  "B"  and (muh-sup = 1 OR depkod-turu = 2 )
                                            move 1 to tl-degisme
                                          end-if
                                          if link-var not = 5 and oto-cinkuru not = 1 
                                          move 2 to cinmi
                                          end-if
                                           perform Form1-Cb-1-Ev-Cmd-Clicked
                                            perform kur-bul
                                           display dov-kur-l 
                                          else
                                          move 0 to cashislem
                                    end-if
                 if depkod-turu = 5 and depkod-ba = "A" 
                                          move 1 to kkislem
                                          if link-var not = 5
                                             move 2 to cinmi
                                          end-if
                                       
                                           perform Form1-Cb-1-Ev-Cmd-Clicked
                                           perform kur-bul
                                           display dov-kur-l 
                                          else
                                        move 0 to kkislem
                        end-if
                        if  kkislem = 1 or cashislem = 1 then 
                           move 1 to vis-di
                        else
                           move 0 to vis-di dovizliislem
                        end-if
                  display  Form1-Cb-1
                  perform  Form1-Cb-1-Ev-Cmd-Clicked
               read depkod2 no lock invalid 
                      continue 
               end-read

               if vis-di = 1 |and depkod2-dov-tah = 1    | dovizli tahsilat isaretlensin
                 move depkod2-dov-tah to dovizliislem
                 display Form1-Cb-1
               end-if

              if ONKPARA-CITY-LEDGER = depkod-kodu and 
              (( acenta-kredili not = 1 and konuk-firma = spaces ) or 
              (firma-kredili not = 1 and konuk-firma not = spaces))
              and ONKPARA-kredi-kilit = 1 then 
                 display message box "Bu Konaklamayi Krediye kaldiramazsiniz" new-line
                                     "Onburo calisma parametrlerinde Kredi kilitlemesini kaldirmalisiniz" new-line
                                     "veya Muhasebe Supervisori tarafindan " new-line
                                     "Acenta veya Sirket tanimlamadan Kredili secenegi secilmelidir" new-line
                 move 4         to accept-control
                 move gidis-id  to control-id
                 move 1 to hata
                 exit paragraph
              end-if
         end-read
         
               modify lb-depadi-e, title = depkod-adi of depkod
             
*               modify accept-aciklama, enabled = true
*               if depkod-makbuz = "E" 
*                  modify accept-aciklama, enabled = true
*               end-if 
               if depkod-turu = 2 
                   modify accept-corrdepkodu, enabled = true               
                   modify lb-corrdepadi-e,    enabled = true

                   initialize kllnc-rec
                   move k-kodu-tasi to k-kodu              
                   open input kllnc
                   read kllnc no lock invalid 
                       continue
                   end-read
                   close kllnc
                   if k-corr-yapabilir not = 1
                      display message box "Correction Yapma Yetkiniz Bulunmamaktadir.." new-line new-line
                                          "ISLEM IPTAL EDILDI..."
                                      title "Uyari"
                                      icon 1

                         move 4          to accept-control
                         move gidis-id   to control-id
                         move 1          to hata

                      exit paragraph 
                   end-if 
                   move 1 to vis-pen
                     if link-pencere > 0 then
                       move link-pencere to odemepen 
                       else
                       move 1 to  odemepen
                     end-if
               else 
                 
                if konuk-fol-kodu = "E" and  depkod2-alt-kate = "01" 
                     display message box "Extra folioya oda geliri kategorisinde bilgi giriyorsunuz." new-line
                             "Oda istatistiklerinde ve Breakdown raporlarinda tutarsizliga sebep olacaktir"  new-line
                             "Oda foliosuna basip transfer / route etmeniz onerilir."  new-line
                             "Devam ederseniz bozulan istatistik logunda kullanici kodunuz kaydedilecektir."  new-line
                             "Lutfen Escape ile cikip oda foliosuna giriniz.(Sonra Transfer edebilirsiniz) "  new-line "DIKKAT"
                end-if
                  initialize corr-dep-dep hrkgir-corr-depkod
                  modify lb-corrdepadi-e, value = " "
                  modify accept-corrdepkodu, enabled = false
                                             value = 0
                  display accept-corrdepkodu
                  modify lb-corrdepadi-e,    enabled = false
                  if depkod-ba = "A" or depkod-turu = 3
                     move 1 to vis-pen
                     if link-pencere > 0 then
                       move link-pencere to odemepen
                       else
                       move 1 to  odemepen
                     end-if
                     else
                     move 0 to vis-pen
                     open input route konu2 rez
        
                     
                     perform folref-bul
                 
                     close route konu2 rez
                    
                 
                  move 1 to rout-vis
                  evaluate routyazma 
                     when 0
                       move "OK" to rsonuc
                     when 1
                       move "YOK" to rsonuc
                    when 2
                       move "KAPALI" to rsonuc
                    when 3 
                      move "COUT" to rsonuc
                  end-evaluate

                   display r1 r2 r3 r4 r5  r6
                   end-if
                   display penacc
               end-if 
       
               perform bakiyeleri-bul
*            if depkod-turu not = 3 and konuk-fol-kodu not = "R"
*                 move onkpara-banka to konuk-banka
*                 move onkpara-doviz to konuk-doviz
*                perform kur-bul
*                 
*             end-if
       when 61
      
          perform bakiyeleri-bul
       when 1002
         initialize gec-gecme
         open input odalar
         move cekgir-odano to o-uzun
         perform oda-kisalt
         move o-kisa to odalar-anah
         read odalar no lock invalid 
              move 1 to gec-gecme
              close odalar
              initialize cekgir-odano
              display accept-odano
              exit paragraph
              not invalid continue 
         end-read
         close odalar
              initialize folara-cagir hrkgir-folio
              move "I"    to folara-cagri-tipi
              move cekgir-odano  to o-uzun
              perform oda-kisalt
              move o-kisa to folara-odano
                   call "/asya/ytl/obj/otel/folara.asy" using folara-cagir
                         on exception perform callerr-proc
                         not on exception
                   cancel "/asya/ytl/obj/otel/folara.asy " 
                   end-call
                   move folara-no-cagir    to hrkgir-folio

              move hrkgir-folio to konuk-folio     
              read konuk no lock invalid 
                   move 1 to gec-gecme
                   exit paragraph                    
                   not invalid continue 
                   if konuk-durumu not = "I" and konuk-acik-hesap not = 1
                      move 1 to gec-gecme
                      exit paragraph
                   end-if
              end-read
              initialize konuk-uygun
              perform musteri-oku 
              perform kur-bul
              if konuk-uygun = 1
                  move 1 to gec-gecme
                 exit paragraph
              end-if
              perform grid-yukle thru grid-yukle-exit
              perform fisno-al
              

       when 1004
           
            perform tlden-doviz
            move hrkgir-tl-tutar    to z-tutar
            modify accept-tltutar  value = z-tutar
             
            move 0 to v-ort
         
            if hrkgir-tl-tutar > 0 then 
              move 1006 to control-id
              move 4 to accept-control
            end-if

       when 1005
        if tl-degisme  not = 1 
            perform dovizden-tl
            move hrkgir-dv-tutar    to z-tutar
            modify accept-dvtutar  value = z-tutar
        end-if

       when 1006
            open input takcek 
            initialize takcek-rec 
            move link-fol-no  to takcek-folio 
            move hrkgir-cekno to takcek-cek
            read takcek no lock invalid
                 continue 
            not invalid
                display message box "Cek no cakismasi.." new-line
                                    "Ayni folio icersinde ", 
                                    takcek-tar(7:2),"/", 
                                    takcek-tar(5:2),"/",
                                    takcek-tar(1:4)," tarihinde girilmis cek bulunmaktadir." new-line 
                                    "Bilginize.."
                               icon mb_warning_icon
                              title "Uyari"
            end-read
            close takcek
       when 16
            initialize grid-islemno
       when 1007

         initialize gec-gecme
         move corr-dep-dep to depkod-kodu depkod2-kodu 
         read depkod no lock invalid 
               move 1 to gec-gecme
               exit paragraph
         not invalid 
                 if depkod-kullanma = 1 then
                     display message box "Bu departman kullanmda degil"
                     move 1 to gec-gecme
                    exit paragraph             
                 end-if
         end-read
          read depkod2 no lock invalid 
             continue
          end-read

          if konuk-fol-kodu = "E" and  depkod2-alt-kate = "01" 
                     display message box "Extra folioya oda geliri kategorisinde bilgi giriyorsunuz." new-line
                             "Oda istatistiklerinde ve Breakdown raporlarinda tutarsizliga sebep olacaktir"  new-line
                             "Oda foliosuna basip transfer / route etmeniz onerilir."  new-line
                             "Devam ederseniz bozulan istatistik logunda kullanici kodunuz kaydedilecektir."  new-line
                             "Lutfen Escape ile cikip oda foliosuna giriniz.(Sonra Transfer edebilirsiniz) "  new-line "DIKKAT"
                end-if
               display accept-corrdepkodu
               modify lb-corrdepadi-e, title = depkod-adi of depkod
             

         initialize gec-gecme
         move hrkgir-depkod to depkod-kodu dep-dep
         read depkod no lock invalid 
               move 1 to gec-gecme
               exit paragraph
              not invalid
               if depkod-kullanma = 1 then
                     display message box "Bu departman kullanimda degil"
                     move 1 to gec-gecme
                    exit paragraph
              
                 end-if
         end-read
           move 0 to vis-pen
           open input route konu2 rez
        
           move corr-dep-dep  to hrkgir-CORR-DEPKOD
           
           perform folref-bul
           
           close route konu2 rez




                 
                  move 1 to rout-vis
                  evaluate routyazma 
                     when 0
                       move "OK" to rsonuc
                     when 1
                       move "YOK" to rsonuc
                    when 2
                       move "KAPALI" to rsonuc
                    when 3 
                      move "COUT" to rsonuc
                  end-evaluate

                   display r1 r2 r3 r4 r5  r6
       when 1008 continue
       when 11001
            move 27 to key-status
      end-evaluate
      .
*
 kontroller.
       initialize gec-gecme.
         move hrkgir-depkod to depkod-kodu dep-dep
         read depkod no lock invalid 
               move 1         to gec-gecme
               move 1001      to gidis-id
               exit paragraph
         not invalid 
               if depkod-kullanma = 1 then 
                    move 1         to gec-gecme
                    move 1001      to gidis-id
                    exit paragraph
               end-if
               if GENEL-odaya-extra-basilamaz   = 1 and CINPARA-EXT-FOL-AC  = "E"
                and CINPARA-EXT-FOL-ADET > 0  and konuk-fol-kodu = "R"
                   if depkod-ba = "B" and depkod-tipi = 3
                      display message box "Oda Foliosuna Extra gelir giremessiniz"  new-line new-line
                                        "Onburo calisma parametreleri tarafindan kisitlanmis." new-line
                                        "Departman kodlari tanimlamada bu departman extra " new-line
                                    title "Uyari"
                                    icon 1
                    move 1         to gec-gecme
                    move 1001      to gidis-id
                    exit paragraph       
                   end-if
               end-if
               if GENEL-odaya-extra-basilamaz   = 1 and konuk-fol-kodu = "E"
                   if depkod-ba = "B" and depkod-tipi = 2
                      display message box "Extra Folyoya Oda Geliri Giremessiniz !"  new-line new-line
                                        "Onburo calisma parametreleri tarafindan kisitlanmis." new-line
                                        "Departman kodlari tanimlamada bu departman Oda " new-line
                                    title "Uyari"
                                    icon 1
                    move 1         to gec-gecme
                    move 1001      to gidis-id
                    exit paragraph       
                   end-if
               end-if
               initialize depkod2-rec 
               move hrkgir-depkod to depkod2-kodu
               read depkod2 no lock invalid
                    continue 
               end-read 
               if depkod2-max-tut > 0
                  if hrkgir-tl-tutar > depkod2-max-tut
                    display message box "Max. Girilebilecek TL Tutar : " depkod2-max-tut new-line new-line
                                        "Girilen Tutar : " hrkgir-tl-tutar
                                    title "Uyari"
                                    icon 1
                    move 1         to gec-gecme
                    move 1001      to gidis-id
                    exit paragraph                   
                  end-if 
               end-if 
                 if depkod-ba = "A"
                    if depkod-turu = 5 
                       move 1  to onay-var
                       display lb-onay-no accept-onay-no                       
                    else
                       move 0  to onay-var
                       display lb-onay-no accept-onay-no
                    end-if
                 else
                    move 0  to onay-var
                    display lb-onay-no accept-onay-no
                 end-if 

         end-read
               modify lb-depadi-e, title = depkod-adi of depkod

         open input odalar
         move cekgir-odano to o-uzun
         perform oda-kisalt
         move o-kisa to odalar-anah
         read odalar no lock invalid 
              move 1002  to gidis-id
              move 1     to gec-gecme
              close odalar
              exit paragraph
              not invalid continue 
         end-read
         close odalar
           if dovizliislem = 1
            move konuk-doviz to yedek-doviz
           end-if
              move hrkgir-folio to konuk-folio     
              read konuk no lock invalid 
                   move 1002   to gidis-id
                   move 1      to gec-gecme
                   exit paragraph
                   not invalid continue 
                   if konuk-durumu not = "I"  and konuk-acik-hesap not = 1 
                      move 1002 to gidis-id
                      move 1    to gec-gecme
                      exit paragraph
                   end-if
              end-read
          if dovizliislem = 1
            move yedek-doviz to konuk-doviz 
          end-if
       if hrkgir-tl-tutar = 0
          display message box 
                  "[TL] Tutarini Bos Gectiniz.."
                  new-line,
                  "Lutfen Rakam Giriniz" 
                  title = " [ Tutar Hatali ] "
          move 1    to gec-gecme
          move 1004 to gidis-id
          exit paragraph
        end-if
       if depkod-turu = 2 
          move corr-dep-dep to depkod-kodu
          read depkod no lock invalid 
               move 1         to gec-gecme
               move 1007      to gidis-id
               exit paragraph
              not invalid 
               if depkod-kullanma = 1 then 
                       move 1         to gec-gecme
                       move 1007      to gidis-id
                       display message box "Departman kullanim disi"
                       exit paragraph
               end-if
               if GENEL-odaya-extra-basilamaz   = 1 and CINPARA-EXT-FOL-AC  = "E"
                and CINPARA-EXT-FOL-ADET > 0  and konuk-fol-kodu = "R"
                   if depkod-ba = "B" and depkod-tipi = 3
                      display message box "Oda Foliosuna Extra gelir icin duzeltme giremessiniz"  new-line new-line
                                        "Onburo calisma parametreleri tarafindan kisitlanmis." new-line
                                        "Departman kodlari tanimlamada bu departman extra " new-line
                                    title "Uyari"
                                    icon 1
                    move 1         to gec-gecme
                    move 1001      to gidis-id
                    exit paragraph       
                   end-if
               end-if



**/kaya ramada istek
                 if depkod-ba = "B" and 
                    depkod-turu = 4
                      display message box "PAID OUT departmanina Eksileme Yapilamaz.." new-line

                                          "Islem Iptal edilecektir."
                                      title "Uyari"
                                      icon 1
                               move 1 to gec-gecme
                               move 1007 to gidis-id
                      exit paragraph 
                 end-if 
**/kaya ramada istek               
         end-read

         if depkod-turu = 2
            display message box 
                    "Correction yapmak istediginiz departmanin turu Correction",new-line,
                    "Lutfen kontrol ediniz"
                    icon mb_error_icon
                    title "Hata"
                    move 1 to gec-gecme
                    move 1007 to gidis-id
                    exit paragraph
         end-if

         move depkod-ba          to dummy-x | Correction - mi + mi ?
        


         modify lb-corrdepadi-e, title = depkod-adi of depkod
         move hrkgir-depkod to depkod-kodu dep-dep
         read depkod no lock invalid 
               move 1         to gec-gecme
               move 1001      to gidis-id
               exit paragraph
              not invalid 
              if depkod-kullanma = 1 then
                 move 1         to gec-gecme
               move 1001      to gidis-id
               display message box "Kullanim disi departman"
               exit paragraph

              end-if
         end-read
         if depkod-ba = dummy-x 
            display message box 
                    "Lutfen Borc Departmanlar icin Correction (+)",new-line,
                    "Alacak Departmanlar icin Correction (-) kullaniniz"
                    icon mb_error_icon
                    title "Hata"
                    move 1007   to gidis-id
                    move 1      to gec-gecme

                    exit paragraph
         end-if
         modify lb-depadi-e, title = depkod-adi of depkod
*/ Borc departmana Corr   (+) YASAK
*/ Alacak Departmana Corr (-) YASAK KONULACAK 
       end-if 
        .
*
 Form1-Pb-1-Link.
     .
*
 depkod-ara.
      initialize depkod-cagir.
      call "/asya/ytl/obj/otel/depara.asy" using depkod-cagir
            on exception perform callerr-proc
               not on exception
               cancel "/asya/ytl/obj/otel/depara.asy" 
       end-call
       move depkod-dep-kodu  to hrkgir-depkod
       move hrkgir-depkod to depkod-kodu dep-dep
       read depkod no lock invalid 
            move 4        to accept-control
            move 1001     to control-id
            exit paragraph
       not invalid 
            if depkod-kullanma = 1 then
                 move 4         to gec-gecme
               move 1001      to gidis-id
               display message box "Kullanim disi departman"
               exit paragraph

              end-if
       end-read
       modify lb-depadi-e, title = depkod-adi of depkod
       display accept-depkodu.
       if depkod-makbuz = "E" 
          modify accept-aciklama, enabled = true
       end-if
       
       if depkod-turu = 2 
          modify accept-corrdepkodu, enabled = true
          modify lb-corrdepadi-e,    enabled = true
       else
          move ROMHRK-CORR-DEPKOD to  hrkgir-corr-depkod 
       end-if 
       move 4        to accept-control
       move 1001     to control-id.
     .
*
 oda-ara.
      initialize oda-cagir.
      move "D"   to oda-db-cagir
      call "/asya/ytl/obj/otel/odaara.asy" using oda-cagir
            on exception perform callerr-proc
               not on exception
               cancel "/asya/ytl/obj/otel/odaara.asy" 
       end-call.
       move odano-cagir     to o-kisa
       perform oda-uzat
       move o-uzun to cekgir-odano.
 oda-oku.
       open input odalar.
       initialize odalar-rec.
       move cekgir-odano   to o-uzun 
       perform oda-kisalt
       move o-kisa to odalar-anah
       read odalar         no lock invalid 
            initialize cekgir-odano
            not invalid continue 
       end-read
       close odalar.
       display accept-odano.
 oda-oku-exit.
       exit.
 oda-ara-exit.
       exit.
*
 corr-depkod-ara.
      initialize depkod-cagir.
      call "/asya/ytl/obj/otel/depara.asy" using depkod-cagir
            on exception perform callerr-proc
               not on exception
               cancel "/asya/ytl/obj/otel/depara.asy" 
       end-call
       move depkod-dep-kodu  to corr-dep-dep
       move corr-dep-dep to depkod-kodu
       read depkod no lock invalid 
            move 4        to accept-control
            move 1007     to control-id
            exit paragraph
            not invalid
            if depkod-kullanma = 1 then
                 move 4         to gec-gecme
               move 1007      to gidis-id
               display message box "Kullanim disi departman"
               exit paragraph

              end-if


       end-read
       modify lb-corrdepadi-e, title = depkod-adi of depkod
       display accept-corrdepkodu.

       move hrkgir-depkod to depkod-kodu dep-dep
       read depkod no lock invalid 
            move 4        to accept-control
            move 1001     to control-id
            exit paragraph
            not invalid 
            if depkod-kullanma = 1 then
                 move 4         to gec-gecme
               move 1001      to gidis-id
               display message box "Kullanim disi departman"
               exit paragraph

              end-if
       end-read
       move 4        to accept-control
       move 1007     to control-id.
     .
*
 grid-yukle.
 grid-baslik-at.
       move 0 to vis-fo
             if genel-onay = 1 
               perform onay-kontrol
               
               display f-onay
             end-if
      modify Form1-Gd-1, reset-grid  = 1
                         mass-update = 1.
      initialize form1-gd-1-record
      move "Tarih "       to gd-1-col-1
      move "Dep "         to gd-1-col-2
      move "Dep.Adi "     to gd-1-col-3
      move "Aciklama"     to gd-1-col-4
      move "[TL] Tutar "  to gd-1-col-5
      move "[DV] Tutar "  to gd-1-col-6
      move "Islem No "    to gd-1-col-7
      move "Cek No "      to gd-1-col-8
      move "Zaman "       to gd-1-col-9
      move "Kart No "     to gd-1-col-10
      move "Staf "        to gd-1-col-11
      modify Form1-Gd-1, record-to-add (form1-gd-1-record) 
                         mass-update = 0.
 grid-baslik-at-exit.
      exit.

 grid-detay-yukle.

         open input kllnc nt
      if konuk-fol-kodu = "R"
         initialize romhrk-rec
         move konuk-folio     to romhrk-folio
         move calisma-tarihi  to romhrk-tarih
         if (k-kodu-tasi  = "X    " or k-kodu-tasi  = "ASYA") and a42 = 1  then 
            
             initialize   romhrk-tarih
             
         end-if
         start romhrk key not < romhrk-anah1 invalid
               continue
         not invalid
               move zeroes to fs-romhrk
          perform with test after until fs-romhrk = "10"
           read romhrk next no lock end move "10" to fs-romhrk
           not at end
               if romhrk-folio <> konuk-folio
                  exit perform 
               end-if
               if romhrk-tarih <> calisma-tarihi
               if (k-kodu-tasi  = "X    " or k-kodu-tasi  = "ASYA") and a42 = 1  then 
                   continue
                  else
                  exit perform cycle
                  end-if
               end-if
               initialize form1-gd-1-record
               move romhrk-gun         to gd-1-col-1(01:02)
               move "/"                to gd-1-col-1(03:01)
               move romhrk-ay          to gd-1-col-1(04:02)
               move "/"                to gd-1-col-1(06:01)
               move romhrk-yil         to gd-1-col-1(07:04)
               move romhrk-depkod      to gd-1-col-2 depkod-kodu
                    read depkod no lock invalid 
                         move "Tanimsiz Departman"  to depkod-adi
                    end-read
                         move depkod-adi to gd-1-col-3
                  initialize not-rec     
                  move  "RHR"     to NOT-DOS
                  move romhrk-anah to  NOT-DOS-ANAH 
                  read nt no lock invalid initialize not1
                  end-read
                  move not1 to gd-1-col-4
               
               

               move romhrk-tl-tutar    to z-tutar
               move z-tutar            to gd-1-col-5
               move romhrk-dv-tutar    to z-tutar
               move z-tutar            to gd-1-col-6
               move romhrk-islem       to gd-1-col-7
               move romhrk-cekno       to gd-1-col-8
               move romhrk-saat        to gd-1-col-9(01:02)
               move ":"                to gd-1-col-9(03:01)
               move romhrk-dakika      to gd-1-col-9(04:02)
               move ":"                to gd-1-col-9(06:01)
               move romhrk-saniye      to gd-1-col-9(07:02)
               move romhrk-kart-no     to gd-1-col-10
               move romhrk-staf        to k-kodu
                    read kllnc no lock invalid 
                         move "Tanimsiz Kullanici"  to k-adi
                    end-read
                         move k-adi to gd-1-col-11
               modify Form1-Gd-1, record-to-add (form1-gd-1-record)
           end-read
          end-perform
         end-start

         else
         initialize exthrk-rec
         move konuk-folio     to exthrk-folio
         move calisma-tarihi  to exthrk-tarih
         if (k-kodu-tasi  = "X    " or k-kodu-tasi  = "ASYA") and a42 = 1  then 
            
             initialize   exthrk-tarih
             
         end-if
         start exthrk key not < exthrk-anah1 invalid
               continue
         not invalid
               move zeroes to fs-exthrk
          perform with test after until fs-exthrk = "10"
           read exthrk next no lock end move "10" to fs-exthrk
           not at end
               if exthrk-folio <> konuk-folio
                  exit perform 
               end-if
               if exthrk-tarih <> calisma-tarihi
                  if (k-kodu-tasi  = "X    " or k-kodu-tasi  = "ASYA") and a42 = 1  then 
                   continue
                  else
                  exit perform cycle
                  end-if
               
               end-if
               initialize form1-gd-1-record
               move exthrk-gun         to gd-1-col-1(01:02)
               move "/"                to gd-1-col-1(03:01)
               move exthrk-ay          to gd-1-col-1(04:02)
               move "/"                to gd-1-col-1(06:01)
               move exthrk-yil         to gd-1-col-1(07:04)
               move exthrk-depkod      to gd-1-col-2 depkod-kodu
                    read depkod no lock invalid 
                         move "Tanimsiz Departman"  to depkod-adi
                    end-read
                         move depkod-adi to gd-1-col-3
                       initialize not-rec     
                  move  "EHR"     to NOT-DOS
                  move romhrk-anah to  NOT-DOS-ANAH 
                  read nt no lock invalid initialize not1
                  end-read
                  move not1 to gd-1-col-4
               move exthrk-tl-tutar    to z-tutar
               move z-tutar            to gd-1-col-5
               move exthrk-dv-tutar    to z-tutar
               move z-tutar            to gd-1-col-6
               move exthrk-islem       to gd-1-col-7
               move exthrk-cekno       to gd-1-col-8
               move exthrk-saat        to gd-1-col-9(01:02)
               move ":"                to gd-1-col-9(03:01)
               move exthrk-dakika      to gd-1-col-9(04:02)
               move ":"                to gd-1-col-9(06:01)
               move exthrk-saniye      to gd-1-col-9(07:02)
               move exthrk-kart-no     to gd-1-col-10
               move exthrk-staf        to k-kodu
                    read kllnc no lock invalid 
                         move "Tanimsiz Kullanici"  to k-adi
                    end-read
                         move k-adi to gd-1-col-11

               modify Form1-Gd-1, record-to-add (form1-gd-1-record)
           end-read
          end-perform
         end-start
      end-if.
      modify Form1-Gd-1, mass-update = 0.
      close  kllnc nt.
 grid-detay-yukle-exit.
      exit.
 grid-yukle-exit.
      exit.
*
 Form1-Aft-Routine.
     close kodlar02 depkod depkod2 acenta yromhrk hrk2 odalar2. 
     close romhrk exthrk konuk onkasa firma dov-boz
     delete file takcek
     perform kilit-aft-routine.
*
 musteri-oku.
        initialize konuk-uygun
        modify lb-foliono-e title = konuk-folio
        modify fr-foliotipi-e title = konuk-fol-kodu
        modify lb-adi-e     title = konuk-adi
        modify lb-soyadi-e  title = konuk-soyadi

        move konuk-gel-gun      to e-gun
        move konuk-gel-ay       to e-ay 
        move konuk-gel-yil      to e-yil
        modify lb-girtar-e  title = etarih
        
        move konuk-git-gun      to e-gun
        move konuk-git-ay       to e-ay 
        move konuk-git-yil      to e-yil
        modify lb-ciktar-e  title = etarih
        move konuk-acenta to acenta-kodu
        read acenta no lock invalid move acenta-kodu to acenta-adi end-read
         modify lb-acenta   title = acenta-adi
         move konuk-firma to firma-kodu
        read firma no lock invalid initialize firma-rec end-read
          modify lb-firma   title = firma-adi
*        modify lb-not1    title = konuk-not1
*        modify lb-not2    title = konuk-not2
        move "A"            to kodlar02-tipi
        move konuk-pan-tipi to kodlar02-kodu
        read kodlar02 no lock invalid 
             initialize kodlar02-adi 
             not invalid continue
        end-read
        modify fr-pansiyon-e  title = konuk-pan-tipi
        modify lb-pansiyon-e  title = kodlar02-adi

        move "B"            to kodlar02-tipi
        move konuk-odeme-tipi to kodlar02-kodu
        read kodlar02 no lock invalid 
             initialize kodlar02-adi 
             not invalid continue
        end-read
        modify fr-odeme-e  title = konuk-odeme-tipi
        modify lb-odeme-e  title = kodlar02-adi
          if ode-tipi not = "B" and link-var >  2 
              if link-depkod = onkpara-city-ledger then
                 display message box "Kredi Acilmayan bir folioyu krediye kaldirmak uzeresiniz" new-line
                                     " HESAP KACIRIYOR OLABILIRSINIZ." new-line
                                     "  Devam ederseniz kullanici kodunuz ve bu islem muhasebe loglarina " new-line
                                     " UYARI olarak gececektir. "    new-line   new-line
                                     "BILGINIZE" new-line title "HESAP KACIRIYOR OLABILIRSINIZ" icon 3 
                                       move 1 to hata
              end-if

          end-if
        move konuk-top-borc     to z-tutar
        modify lb-topborc-e  title = z-tutar
        move konuk-top-alac     to z-tutar
        modify lb-topalacak-e  title = z-tutar
        initialize z-tutar
        compute z-tutar = konuk-top-borc - konuk-top-alac
        modify lb-bakiye-e  title = z-tutar
            if konuk-git-tar < calisma-tarihi and konuk-acik-hesap not = 1
               if k-kodu-tasi not = "ASYA"
               move 1 to konuk-uygun
               display message box "Folionun Cikis Tarihi Gecmis"
                                  new-line,
                                   "Bu Tarihe Cek Giremezsiniz    "
                                  new-line,
                                   "Cikis Tarihini Kontrol Ediniz !!!"
                                title = " [ Tarih Hatali ] "
               exit paragraph
               end-if 
            end-if
            if ode-posting = "H"
               move 1 to konuk-uygun
               display message box "Bu Folioya Cek Giremezsiniz"
                                  new-line,
                                   "Odeme Tipi Postinge Kapali"
                                title = " [ Posting Yapilamaz ] "
               exit paragraph
            end-if
            if k-kodu-tasi not = "ASYA"
            if konuk-acik-kapali = "C"
              
               display message box "Bu Folioya Postinge Kapali"
                                  new-line,
                                   "NO-POST FOLIO "
                                title = " [ Folio Kapali ] "
              
            end-if
            end-if

*            if konuk-fol-kodu = "R"
*               display message box "Musterinin Oda Foliosunu Sectiniz"
*                                title = " [ Dikkat ] "
*               
*            end-if
            perform not-goster
             perform alternatif-dovizleri-bul
            .

*
 fisno-al.
      
    open i-o genelfis
    move 1 to genelfis-anahtar
    read genelfis no lock invalid
         initialize genelfis-rec 
         move 1 to genelfis-anahtar
         not invalid continue 
    end-read
    add 1 to cekgir-oto
    move cekgir-oto to hrkgir-islem
    rewrite genelfis-rec invalid 
            write genelfis-rec 

            end-write continue
    end-rewrite
    close genelfis.
*    modify accept-islemno, color = 3
    display accept-islemno.
*
 tlden-doviz.
       initialize hrkgir-dv-tutar.        
       compute hrkgir-dv-tutar rounded = hrkgir-tl-tutar / islem-kuru.
       move hrkgir-dv-tutar    to z-tutar.
       modify accept-dvtutar  value = z-tutar.
 dovizden-tl.
       
     
       initialize hrkgir-tl-tutar
       compute hrkgir-tl-tutar rounded = hrkgir-dv-tutar * islem-kuru
       move hrkgir-tl-tutar    to z-tutar
       modify accept-tltutar  value = z-tutar.
      .
*
 Form1-Gd-1-Ev-Other.
    initialize Form1-Gd-1-record grid-islemno
    inquire Form1-Gd-1, cursor-y in satir cursor-x in sutun
    inquire Form1-Gd-1(satir),
            record-data in form1-gd-1-record
    move gd-1-col-7    to grid-islemno
    evaluate event-type 
         when msg-begin-entry
             move event-action-fail to event-action,
    end-evaluate.
*
 makbuz-cik.
 rapor-liste-basla.
    initialize makbuz-cagir
    move hrkgir-folio                to makbuz-folio-no
    move hrkgir-islem                to makbuz-islem-no
    move uy-kur                      to makbuz-kur
    move hrkgir-tl-tutar             to makbuz-tl-tutar
    move hrkgir-dv-tutar             to makbuz-dv-tutar
    move dov-kur(7:)                 to makbuz-doviz
    move "M"                         to makbuz-islem-tipi
    call "/asya/ytl/obj/otel/maklzr.asy" using makbuz-cagir
          on exception perform callerr-proc
             not on exception
    cancel "/asya/ytl/obj/otel/maklzr.asy" 
    end-call .


 makbuz-cik-exit.
    exit.

*
 mmesaj-ver.
      inspect mmesaj-1 replacing trailing spaces by low-values
      inspect mmesaj-2 replacing trailing spaces by low-values
      inspect mmesaj-3 replacing trailing spaces by low-values
      display message box mmesaj-1, new-line, mmesaj-2, new-line, mmesaj-3
              title   = mmesaj-title
              type    = mmesaj-type
              icon    = mmesaj-icon
              default = mmesaj-default
              returning donus-kodu.
*
  not-goster.
      
      if konuk-fol-kodu = "R" 

         move 5 to link-nereden 
         move "REZ"   to  link-NOT-DOS    
         move konuk-rez-no to link-NOT-DOS-ANAH   
         else
         if konuk-extra-rez-no > 0 then
           move 6 to link-nereden 
           move "REZ"   to  link-NOT-DOS    
           move konuk-extra-rez-no to link-NOT-DOS-ANAH    
           else
           move 6 to link-nereden 
           move "KON"   to  link-NOT-DOS    
           move konuk-folio to link-NOT-DOS-ANAH    
           
          end-if

       end-if .
        


             move "K"     to  link-not-islem
             
                   call "/asya/ytl/obj/otel/mesajgir.asy" 
                         using link-not
                          on exception 
                          perform callerr-proc
                          exit paragraph
                        not on exception 
                          cancel "/asya/ytl/obj/otel/mesajgir.asy"
                    end-call
              
                    move  link-not-donus  to  toplam-not
             display not-ac
                           .
*
 dokcagir-call.
     call "/asya/ytl/obj/otel/dokcagir.asy" using dokcagir-tasi
          on exception 
             perform callerr-proc
          not on exception
             cancel "/asya/ytl/obj/otel/dokcagir.asy"
     end-call.
*
 Form2-Aft-Initdata.
*/-----------------------------\*  
*/---------DIL AYARLA----------\*    
*/-----------------------------\*    
     perform dil-ayarla-proc.
*/-----------------------------\*         
     .
*
 paid-form-cagir.



             initialize  link-paid-cagir
             move konuk-folio to link-paid-folio
             
                   call "/asya/ytl/obj/otel/paidlzr.asy" 
                         using link-paid-cagir
                          on exception 
                          perform callerr-proc
                          exit paragraph
                        not on exception 
                          cancel "/asya/ytl/obj/otel/paidlzr.asy"
                    end-call.
*
 minibar-kayit-sil.
    open i-o posy
    initialize p-rec
    move minibar-cek-no  to posy-fis-no
    move 1               to posy-fis-sira
    move calisma-tarihi to posy-tarih
    read posy no lock invalid 
        continue 
    not invalid 
         if posy-fis-no = minibar-cek-no and
            posy-fis-sira = 1 and 
            posy-manuel-minibar = "M" and 
            posy-tarih  = calisma-tarihi
               move "S" to posy-durumu
               rewrite posy-rec invalid continue end-rewrite 
         end-if 
    end-read 
    close posy
    .
*
 Form1-Cb-1-Ev-Cmd-Clicked.
       if cinmi = 2 then
          move 0 to doviz-en tl-enable

      else
      move 1 to tl-enable
      if (cashislem = 1 or kkislem = 1)  and dovizliislem = 0 then 
          move 1 to doviz-en
            else
          move 1 to doviz-en
          
      end-if
     end-if
      display accept-dvtutar   accept-tltutar
     .
*
 toplam-bul.

    
      if konuk-fol-kodu = "R"
         initialize romhrk-rec
         move konuk-folio     to romhrk-folio 
       
         start romhrk key not < romhrk-anah invalid
               continue
         not invalid
               move zeroes to fs-romhrk
          perform with test after until fs-romhrk = "10"
           read romhrk next no lock end move "10" to fs-romhrk
           not at end
               if romhrk-folio <> konuk-folio
                  exit perform 
               end-if
                  move romhrk-rec to hrkgir-rec
                  perform toplam-tek
            

           end-read
          end-perform
         end-start
         else
         initialize exthrk-rec
         move konuk-folio     to exthrk-folio
       
         start exthrk key not < exthrk-anah invalid
               continue
         not invalid
               move zeroes to fs-exthrk
          perform with test after until fs-exthrk = "10"
           read exthrk next no lock end move "10" to fs-exthrk
           not at end
               if exthrk-folio <> konuk-folio
                  exit perform 
               end-if
                 move exthrk-rec to hrkgir-rec
                  perform toplam-tek
           end-read
          end-perform
         end-start
      end-if.
    


* 
 toplam-tek.
       
       if hrkgir-ref = 0 or hrkgir-ref not  numeric then 
                
                 if hrkgir-ref = 0 or hrkgir-ref not  numeric then 
                     move 1 to hrkgir-ref
                end-if
             if konuk-fol-kodu = "R"
                   move hrkgir-ref to romhrk-ref
                   rewrite romhrk-rec end-rewrite
               else
                  move hrkgir-ref to exthrk-ref
                  rewrite exthrk-rec end-rewrite
            end-if  
             end-if
       
       
       initialize form1-gd-1-record 
         initialize not-rec
      if konuk-fol-kodu = "R"
          move  "RHR"     to NOT-DOS
          move romhrk-anah to  NOT-DOS-ANAH 
         else
          move  "EHR"     to NOT-DOS
          move exthrk-anah to  NOT-DOS-ANAH 
       end-if  
         
          read nt no lock invalid 
               initialize not1
          end-read
          move not1 to gd-1-col-4
     initialize konu2-rec  
     move hrkgir-hrk2-kaynak-folio to  konu2-anah
     read konu2 no lock invalid 
          
            continue
       end-read
    
     
    
     
      initialize cor-adi cor-tipi
        if hrkgir-corr-depkod not = spaces 
              move hrkgir-corr-depkod          to  depkod-anah
      
        read depkod no lock invalid
          continue
          not invalid 
          move depkod-adi to cor-adi
          MOVE DEPKOD-tipi to cor-tipi
         end-read
         end-if
      move hrkgir-depkod          to  depkod-anah
      
      read depkod no lock invalid
           move "Tanimsiz ..."    to depkod-adi
      end-read
   
      if cor-adi not = spaces
      move "-" to gd-1-col-3(6:1)
      move cor-adi to  gd-1-col-3(7:)
      end-if
     
    
        if cor-tipi = 2 then move 2 to depkod-tipi end-if              
      if konu2-fol-kodu = "R" and   depkod-tipi = 2  and konu2-doviz = konuk-doviz
            move   konu2-kur-degeri to  konuk-kur-degeri

              
         else
          open input kur
          move konu2-banka to  kur-banka
          move konuk-doviz to kur-doviz
          if  depkod-tipi = 2 then 
            move konu2-gel-tar to kur-tarih
            else
            move hrkgir-tarih to kur-tarih
         end-if
             read kur no lock 
                 invalid
                   if uyari = 0 then 
                       display message box kur-banka "---" kur-banka "--Kur bulunamadi folio-kuru alinacak"
                        move 1 to uyari
                  end-if
                 not invalid 
                     move doviz-alis    to konuk-kur-degeri
              end-read            
                 close kur       
         end-if
         
         compute   hrkgir-dv-tutar rounded =
               hrkgir-tl-tutar / konuk-kur-degeri
      



                  


*******************************
     

      evaluate hrkgir-ba
           when "A" 
           when "B".
*
 alternatif-dovizleri-bul.
      if  link-var = 5 then
         exit paragraph
      end-if
    open input kur  doviz ozluk  takvim
    initialize islem-kuru uygun-dovizler
    move konuk-banka to kur-banka
    start doviz key > doviz-kodu invalid continue
       not invalid
       perform until fs-doviz = "10"
             read doviz next no lock end move "10" to fs-doviz
                 not end
                 if d-merkez-banka-kodu(1:2) = "TL" or d-kisa-adi(1:2) = "TL"
                     exit perform cycle 
                 end-if 
                 move doviz-kodu to kur-doviz
                   move konuk-folio to ozluk-folio
                         read ozluk no lock invalid 
                               move konuk-gel-tar to ozluk-ilk-har
                                   move konuk-git-tar to ozluk-son-har-tar
                           end-read
                      move 0 to kurbulunamadi
                    move  ozluk-ilk-har to takvim-anah
                   start takvim key > takvim-anah invalid continue
                     not invalid
                         perform until fs-takvim = "10"
                            read takvim next no lock end move "10" to fs-takvim
                                 not end 
                               if calisma-tarihi < takvim-anah 
                                      move "10" to fs-takvim
                                      exit perform cycle
                               end-if
                               if ozluk-son-har-tar  < takvim-anah 
                                      move "10" to fs-takvim
                                      exit perform cycle
                               end-if
                               move takvim-anah to kur-tarih
                               read kur no lock invalid
                                  move 1 to kurbulunamadi
                               end-read   
                               if doviz-alis = 0  then 
                                 move 1 to kurbulunamadi
                               end-if

                            end-read
                         end-perform
                   end-start
             end-read
          
             if kurbulunamadi = 0 then 
             perform varying ik from 1 by 1 until ik > 10
                   if uygun-doviz(ik) = 0 then
                     move doviz-kodu to uygun-doviz(ik)                    
                     exit perform 
                   end-if
             end-perform
             end-if
          end-perform 
    end-start

     close     kur ozluk doviz takvim.

*
 bakiyeleri-bul.
  
      
       if vis-pen  = 0 then 
         exit paragraph 
       end-if
       if odemepen = 0 then 
         move 1 to odemepen 
       end-if
        modify ftut reset-grid = 1 
           initialize toplamlar
       open input konu2 doviz
       perform varying ik from 1 by 1 until ik > 10
          if uygun-doviz(ik) > 0 then 
              move uygun-doviz(ik) to sira-doviz
              
              perform tek-bakiye-bul
              
              if ik = 1 then 
                     if tlbakiye-pen(ik) not > 0 then 
                        exit perform
                     end-if
                      move tlbakiye-pen(ik) to z-dov
                      move z-dov to ftut1 
                      move "TL " to ftut2(2:)
                    modify ftut record-to-add (ftut-rec)
               
                if cashislem not = 1 and kkislem not = 1 then
                   move 0 to dovizliislem 
                  perform  Form1-Cb-1-Ev-Cmd-Clicked
                  exit perform 
                end-if
              end-if 
              if  bakiye-pen(ik) not > 0 then 
                      exit perform cycle
                 end-if 
              
              move uygun-doviz(ik) to doviz-kodu
              read doviz no lock invalid continue end-read            
                  move bakiye-pen(ik) to z-dov
                  move z-dov to ftut1 
                  move d-kisa-adi to ftut2(2:)
                  modify ftut record-to-add (ftut-rec)
          end-if
       end-perform.
         close konu2 doviz.



*
 tek-bakiye-bul. 
          
         initialize romhrk-rec exthrk-rec 
         move konuk-folio       to romhrk-folio exthrk-folio
         move odemepen to pencere
         move hrkgir-rec    to eski-hrkgir-rec 
        
    if konuk-fol-kodu = "R"
         start romhrk key not < romhrk-anah1 invalid
               continue
         not invalid
         initialize fs-romhrk
         perform with test after until fs-romhrk = "10"
         read romhrk next no lock end move "10" to fs-romhrk
         not at end
              if romhrk-folio <> konuk-folio
                 move "10" to fs-romhrk
                 exit perform 
              end-if
              if romhrk-ref = 0 then 
                move 1 to romhrk-ref
              end-if
             if romhrk-ref not = pencere
                  exit perform cycle
             end-if
        
              initialize hrkgir-rec
              move romhrk-rec        to hrkgir-rec
              move romhrk-anah       to hrk2-anah
              read hrk2 no lock invalid
                   display message box "Eski Versiyon Datasi" new-line 
                              " Bakim icin arayiniz" title "HATA"
               
              end-read
              move hrk2-rec to hrkgir-hrk2
              perform grid-yukle2
           
          
         end-read
         end-perform
         end-start
        else
         start exthrk key not < exthrk-anah1 invalid
               continue
         not invalid
         initialize fs-exthrk
         perform with test after until fs-exthrk = "10"
         read exthrk next no lock end move "10" to fs-exthrk
         not at end
              if exthrk-folio <> konuk-folio
                 move "10" to fs-romhrk
                 exit perform 
              end-if
              if exthrk-ref = 0 then 
                move 1 to exthrk-ref
              end-if
                if exthrk-ref not = pencere
                  exit perform cycle
               end-if
             
        
              initialize hrkgir-rec
              move exthrk-rec        to hrkgir-rec
              move exthrk-anah       to hrk2-anah
              read hrk2 no lock invalid
                   display message box "Eski Versiyon Datasi" new-line 
                              " Bakim icin arayiniz" title "HATA"
                 
              end-read
              move hrk2-rec to hrkgir-hrk2
              perform grid-yukle2
           
          
         end-read
         end-perform
         end-start


      end-if
      move eski-hrkgir-rec  to hrkgir-rec
     move  hrkgir-depkod to depkod-kodu
     read depkod no lock invalid continue
     end-read
     
         .

 grid-yukle2.
    
     initialize konu2-rec  
     move hrkgir-hrk2-kaynak-folio to  konu2-anah
     read konu2 no lock invalid 
          
            continue
       end-read
      initialize yromhrk-rec
      move hrkgir-anah to yromhrk-anah
      move hrk2-kaynak-folio to yromhrk-folio
      read yromhrk no lock invalid continue
      end-read
      initialize cor-adi cor-tipi
        if hrkgir-corr-depkod not = spaces  and zeroes
         
              move hrkgir-corr-depkod          to  depkod-anah
      
        read depkod no lock invalid
          continue
          not invalid 
          move depkod-adi to cor-adi
          MOVE DEPKOD-tipi to cor-tipi
         end-read

      end-if
      move hrkgir-depkod          to gd-1-col-2 depkod-anah
      
      read depkod no lock invalid
           move "Tanimsiz ..."    to depkod-adi
      end-read
      move depkod-adi             to gd-1-col-3
      if cor-adi not = spaces
      
              move "-" to gd-1-col-3(6:1)
              move cor-adi to  gd-1-col-3(7:)
              move cor-tipi  to depkod-tipi
      end-if
    
        move 0 to dtah-islem 
      if yromhrk-dovboz-anah not = spaces       
             move  yromhrk-dovboz-anah to  dov-boz-anah 
             read dov-boz no lock 
               invalid 
                  continue
               not invalid 
               if dov-boz-doviz = sira-doviz
  
                 move 1 to dtah-islem
               end-if
              end-read
      else 
        if (yromhrk-rez-no > 0   and yromhrk-kur-degeri > 0 ) or yromhrk-dovizli-kk = 1
          move 2  to dtah-islem
        end-if 
      end-if

      if dtah-islem = 1 or 2 then 
         if dtah-islem = 1
           if DOV-BOZ-TL-TUTAR = hrkgir-tl-tutar 
               move DOV-BOZ-dv-TUTAR to hrkgir-dv-tutar 
                 compute    konuk-kur-degeri rounded =
                      hrkgir-tl-tutar / hrkgir-dv-tutar
           else
            move DOV-BOZ-KUR-TUTAR to konuk-kur-degeri
           end-if
         end-if
         if dtah-islem = 2            
                  if yromhrk-doviz-kodu = sira-doviz 
                     compute yromhrk-kur-degeri rounded = hrkgir-tl-tutar / yromhrk-doviz-tut
                     move yromhrk-kur-degeri to konuk-kur-degeri
                  else
              open input kur
              move konu2-banka to  kur-banka
          move sira-doviz to kur-doviz
            
          if  depkod-tipi = 2 or 4  then            
            move konu2-gel-tar to kur-tarih
          else
            move hrkgir-tarih to kur-tarih
          end-if
             read kur no lock 
                 invalid
                 continue
                 not invalid 
               
                         move doviz-alis    to konuk-kur-degeri
                   
              end-read            
                 close kur       
            end-if
         end-if 
      else 
      if ((konu2-fol-kodu = "R" and   depkod-tipi = 2  )  or yromhrk-cin-kur = 1) and konu2-doviz = sira-doviz 
            
            move   konu2-kur-degeri to  konuk-kur-degeri

          
         else
         
          if TLbakiye-pen(ik) > 0 and bakiye-pen(ik) > 0   and depkod-ba = "A"
                compute konuk-kur-degeri rounded = TLbakiye-pen(ik) / bakiye-pen(ik)
          else

          open input kur
          move konu2-banka to  kur-banka
          move sira-doviz to kur-doviz     | Rapor doviz gibi kullaniliyor.
          if  depkod-tipi = 2 or 4  then            
            move konu2-gel-tar to kur-tarih
            else
            move hrkgir-tarih to kur-tarih
         end-if
             read kur no lock 
                 invalid
                 if uyari = 0 then 
                    display message box rapor-banka "---" kur-banka "--Kur bulunamadi folio-kuru alinacak"
                    move 1 to uyari
                  end-if
                 not invalid 
               
                         move doviz-alis    to konuk-kur-degeri
                   
              end-read            
                 close kur       
         end-if
         end-if
         end-if
         
         compute   hrkgir-dv-tutar rounded =
               hrkgir-tl-tutar / konuk-kur-degeri

*******************************
     evaluate hrkgir-ba
           when "A"
                    subtract hrkgir-tl-tutar from TLbakiye-pen(ik)
                    subtract hrkgir-dv-tutar from bakiye-pen(ik)
           when "B" 
                     add hrkgir-tl-tutar   to TLbakiye-pen(ik)
                     add hrkgir-dv-tutar   to bakiye-pen(ik)
      end-evaluate.
    
 olasi-dep-bul.
   
      move 0 to ik
      initialize uygun-depkodlar
       modify fdep, reset-grid = 1
    
      start depkod key > depkod-anah
         invalid continue
         not invalid
                perform until fs-depkod = "10"
                        read depkod next no lock end move "10" to fs-depkod
                            not end
                               if depkod-kullanma = 1
                                   exit perform cycle 
                               end-if 
                               if depkod-ba = "A" and 
                                  ( depkod-turu = 3 or 4 or 5 ) then 
                                       add 1            to ik
                                       move depkod-kodu to uygun-depkod(ik)
                                       move depkod-adi  to fdep-rec(2:)


                                           modify fdep, record-to-add (fdep-rec) 
                                           evaluate ik
                                             when 1 when 4 when  7
                                                move 176 to renk 
                                             when 2 when 5 when 8 
                                                move 112 to renk
                                             when 3  when 6 when 9
                                                move 480 to renk
                                           end-evaluate

                                           modify fdep(ik,1 ) hidden-data = depkod-kodu row-color = renk
                               end-if
                        end-read
                end-perform 
       end-start  .
     
         
     
*
 fdep-Ev-Msg-Begin-Entry.
      
        move  event-action-fail to event-action.
          inquire fdep, y in satir x in sutun
          inquire fdep(satir,1) hidden-data in htext 
          move function numval(htext) to hrkgir-depkod
        display accept-depkodu 
             
        move 1001 to control-id
        perform aft-procedure
        move 4 to accept-control



                                           
     .
*
 guest-ver.
    
     

              .
*
 ftut-Ev-Msg-Begin-Entry.
          if kkislem = 1 or cashislem = 1 then
              move 1 to vis-di
              else
              move 0 to vis-di
          end-if
         move  event-action-fail to event-action.
          inquire ftut, y in satir x in sutun
           if satir > 1
            move 1 to tl-degisme
            subtract 1 from satir
            if bakiye-pen(satir) > 0 and  tlbakiye-pen(satir)> 0 
              move 1 to dovizliislem
              move  bakiye-pen(satir) to  hrkgir-dv-tutar
              move  tlbakiye-pen(satir) to  hrkgir-tl-tutar
              display  accept-dvtutar accept-tltutar  form1-cb-1
              move uygun-doviz(satir) to konuk-doviz
                 move 2 to cinmi
                perform Form1-Cb-1-Ev-Cmd-Clicked
                perform kur-bul
              display dov-kur-l 
           end-if
           move 0 to tl-degisme
          else
            if satir = 1
           
            if   tlbakiye-pen(satir)> 0 
              move 0 to dovizliislem
               move 1 to tl-degisme
              move  tlbakiye-pen(satir) to  hrkgir-tl-tutar
              display  accept-dvtutar accept-tltutar  form1-cb-1
                  move uygun-doviz(1) to konuk-doviz
                    move  bakiye-pen(1) to  hrkgir-dv-tutar
                 move 2 to cinmi
                  perform Form1-Cb-1-Ev-Cmd-Clicked
               perform kur-bul
             display dov-kur-l 
            end-if
          end-if
          end-if
           perform Form1-Cb-1-Ev-Cmd-Clicked
       
     
     .
*
 Form3-Ex-Other.
     evaluate key-status
     when 3 
        if neden-silindi = spaces
           display message box "Silme Nedeni Yazilmadan Devam edilemez.."
                           title "Uyari"
                           icon 1
             exit paragraph 
        else
           set exit-pushed to true
        end-if 
     when 27
        if neden-silindi = spaces

           display message box "Silme Nedeni Yazilmadan Devam edilemez.."
                           title "Uyari"
                           icon 1
             move 3 to key-status
             
             exit paragraph 
        else
           set exit-pushed to true
        end-if         
     end-evaluate 
     
     .
* *
 gf-Ev-Msg-Begin-Entry.
     
      if  event-data-2 > 1
          
         inquire f-onay(event-data-2,1)  hidden-data in ONAY-id 
         if ONAY-rec not = spaces
         open i-o onay
         read onay no lock invalid
             perform onay-getir
             not invalid 
            
             if ONAY-VERILDI  then 
               move function numval(ONAY-VERI-yeni(11:3))  to hrkgir-depkod of hrkgir-rec
                display accept-depkodu
                move 1001 to control-id




                perform aft-procedure
                if  function numval( ONAY-VERI-yeni(19:1)) > 0
                 move  function numval( ONAY-VERI-yeni(19:1))  to   bol-tut
                      display penacc
                    move 61 to control-id
                    perform aft-procedure
                 end-if
               
      if  function numval(ONAY-VERI-yeni(15:3)) > 0
         move    function numval(ONAY-VERI-yeni(15:3)) to corr-dep-dep
          display accept-corrdepkodu
         move 1007 to control-id
        perform aft-procedure
       end-if
                 
                move function numval(ONAY-VERI-yeni(1:10))  to hrkgir-tl-tutar of hrkgir-rec
                 display  accept-tltutar 
                     move 1004 to control-id
                      perform aft-procedure
                
                 
                 
                   
                          display message box  "Onaylanan Talep Uygulandi " new-line
                          "Kaydetdiginizde Gecerli Olacaktir" title "Onay"
                         move 1001 to control-id
                         move 4 to accept-control
             else
               perform onay-getir
             end-if

        end-read
        close onay
        else
           perform onay-getir
        end-if


         
     
    end-if
     set event-action to event-action-fail
     .
* 
 onay-getir.
     inquire f-onay(event-data-2,1)  hidden-data in link-onay 
                  call "/asya/ytl/obj/otel/onaygir.asy" 
                       using link-onay 
                       on exception 
                       perform callerr-proc
                       exit paragraph
                       not on exception 
                  cancel "/asya/ytl/obj/otel/onaygir.asy"
                  end-call .
*
*
 onay-takip.      
            open i-o onay 
           
             initialize onay-rec  onay-uygulandi-yaz
             set  CORR-ONAY to true
              move konuk-folio to  ONAY-ANAHTAR
              move hrkgir-ref to  ONAY-VERI-yeni(19:1) 
               move hrkgir-tl-tutar of hrkgir-rec to    zo-tut
               move zo-tut to   ONAY-VERI-yeni(1:10)
                move hrkgir-depkod of hrkgir-rec to   ONAY-VERI-yeni(11:3) 
                  move hrkgir-corr-depkod of hrkgir-rec to   ONAY-VERI-yeni(15:3) 
                  move  ONAY-VERI-yeni(11:3)  to depkod-anah
                    
                     read depkod no lock invalid continue end-read
              read onay no lock invalid 
                 set  ONAY-BEKLER to true
                       string  konuk-adi delimited by "   "
                               " " delimited by size
                              konuk-soyadi delimited by "   "
                               new-line  delimited by size
                               "ait misafire "  delimited by size
                                 zo-tut delimited by size
                                 "TL " delimited by size
                                 new-line  delimited by size
                                  depkod-adi delimited by "    "
                                  " talebi " 
                               into onay-text

                             move k-kodu-tasi to ONAY-IST-STAF
                             accept ONAY-IST-TARIH from century-date 
                             accept ONAY-IST-zaman  from time
                             display message box  "Onay Almadan uygulanamayacak bir  islem yapmaktasiniz"
                                      onay-text new-line 
                                   "Onay talebi girilsin mi?" 
                                  icon 1 type 2 giving onay-sonuc
                            if onay-sonuc = 1
                                write onay-rec invalid continue
                                    rewrite onay-rec end-write
                             end-if 
                             not invalid 
                             evaluate true
                              when  ONAY-bekler  
                                 display message box "Onaylanmamis  Talep " title "Onayla"
                              when onay-verildi
                                    move 1 to  onay-uygulandi-yaz
                              when  ONAY-IPTAL
                                   display message box "Reddilmis   Talep  " new-line 
                                        "Devam Edemessiniz"  title "Onayla"
                              when  onay-uygulandi 
                                    
                                  display message box  "Daha nce uyguladiginiz bir islemi tekrar etmektesiniz"
                                       new-line  
                                      onay-text 
                                      new-line 
                                      new-line  
                                   "Onay talebi tekrarlansin mi?" 
                                  icon 1 type 2 giving onay-sonuc
                                 

                                    if onay-sonuc = 1
                                      move ONAY-uyg-TZ to ONAY-VERI-eski
                                       write onay-rec invalid continue
                                            rewrite onay-rec end-write
                                       initialize  ONAY-VERI-eski
                                        set onay-bekler to true
                                         string  onay-text delimited by "                 "
                                             new-line delimited by size
                                         "Daha once uygulandigi halde tekrar TALEP"  delimited by size
                                        into onay-text

                                         initialize  ONAY-VER-STAF     ONAY-ver-TZ 
                                          initialize  ONAY-uyg-STAF  ONAY-uyg-TZ
                                            move k-kodu-tasi to ONAY-IST-STAF
                                             accept ONAY-IST-TARIH from century-date 
                                             accept ONAY-IST-zaman  from time



                                        rewrite onay-rec invalid continue
                                            write onay-rec end-rewrite
                                     end-if 
                                
                             end-evaluate
                     end-read
                    close  onay
                 .

*
 onay-kontrol.
      modify f-onay,
            reset-grid = 1
       open i-o onay
       
        move "ONAYLAR" to  f-1
                    modify f-onay,record-to-add(f-rec)
                    move 1 to onay-no
       initialize onay-rec
       set CORR-ONAY   to true
       move konuk-folio to  ONAY-ANAHTAR
       start onay key >= onay-id invalid continue
           not invalid 
           perform until fs-onay = "10"
             read onay next no lock end move "10" to fs-onay
                not end 
                 if (not CORR-ONAY ) or function numval(onay-anahtar) not =  konuk-folio
                  move "10" to fs-onay
                  exit perform 
                  else
                    add 1 to  onay-no
                     move function numval(ONAY-VERI-yeni(1:10))  to zo-tut  
                     move  ONAY-VERI-yeni(11:3)  to depkod-anah
                    
                     read depkod no lock invalid continue end-read

                                     string
                                          zo-tut delimited by size
                                          " - " delimited by size
                                          depkod-adi delimited by size     
                                          into  f-1
                    modify f-onay, record-to-add(f-rec)
                    modify f-onay(onay-no, 2) hidden-data = ONAY-rec 
                    modify f-onay(onay-no, 1) hidden-data = ONAY-ID 
                    evaluate true
                           
                          when  ONAY-VERILDI 
                             move 152 to o-renk
                          when       ONAY-IPTAL 
                             move 176 to o-renk
                          when       onay-uygulandi 
                              move 80  to o-renk
                          when other
                            move 0 to o-renk
                    end-evaluate
                    if o-renk > 0
                     modify  f-onay(onay-no,1) row-color = o-renk
                    end-if
                     move 1 to vis-fo
                    
                 end-if  
              end-read 
              end-perform 
        end-start

       close onay .
*
*
 kafter.
       perform kur-bul
              display dov-kur-l 
     .

 


 
