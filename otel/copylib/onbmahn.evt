* onbmahn.evt
* onbmahn.evt is generated from D:\asya\acugt.ytl\otel\onbmahn.Psf
* This is a generated file. DO NOT modify this file directly.


 Form1-Event-Proc.
     .

 Form1-Exception-Proc.
     PERFORM Form1-Ex-Other
     .

 acc-ref-Exception-Proc.
     PERFORM acc-ref-Ex-Other
     .

 Form1-Gd-1-Event-Proc.
     .
***   start event editor code   ***

*
 acc-yil-Aft-Procedure.
     initialize gec-gecme.
     open input takvim.
     move tarih   to takvim-anah
     read takvim no lock invalid
          move 1 to gec-gecme
     end-read
     close takvim.

     if girilemez-tarih <> zeroes 
        if tarih < girilemez-tarih
           move 1 to gec-gecme
          if k-kodu-tasi not = "ASYA" and "X   "
           display message box
                   girilemez-gun,"/",girilemez-ay,"/",girilemez-yil,
                   " tarihinden onceye mahsup fisi kesilemez ....",
                   icon mb_error_icon
                   title "Hata"
          end-if
        end-if
     end-if.
*
 acc-numara-Aft-Procedure.
     initialize gec-gecme.
     if numara = zeroes 
        open i-o genelfis 
        move 1 to genelfis-anahtar
        read genelfis no lock invalid
             display message box
                     "mgenel parametre'de genelfis fis tanimlamalari eksik !!!",new-line,
                     "Lutfen tanimlayiniz ..."
                     icon mb_error_icon
                     title "Hata"
                     destroy form1-handle
                     close genelfis
                     goback
        end-read
        add 1 to mahsup-oto
        move mahsup-oto to numara
        if mgenel-referans = "E"
           open i-o referans
             move ref   to referans-kodu
             move "A"   to referans-tipi
             read referans no lock invalid           
                  continue
             end-read
             add 1 to referans-fisno-ekle
             move referans-fisno-ekle   to numara
             add 6 to referans-fisno-ekle
             rewrite referans-rec end-rewrite

           close referans
        else
           add 6 to mahsup-oto
           rewrite genelfis-rec end-rewrite
        end-if
        close genelfis
        display acc-numara
     end-if.

     open input islenen.
     move numara to no-kont
     perform 6 times

     move no-kont to islenen-fis-no
     read islenen no lock invalid
          continue
     not invalid
          move 1 to gec-gecme
          display message box 
                  islenen-fis-no," numarali fis ",islenen-gun,"/",
                  islenen-ay,"/",islenen-yil," tarih kayitli",new-line,
                  "Lutfen kontrol ediniz",
                  icon mb_error_icon
                  title "Hata"
     end-read
     add 1 to no-kont 
     end-perform
     close islenen.
     
     .
*
 acc-ref-Aft-Procedure.
     initialize gec-gecme.
     if mgenel-referans = "E"
        continue else 
             exit paragraph.
     

     open input referans.
     move ref   to referans-kodu
     move "A"   to referans-tipi
     read referans no lock invalid
         initialize referans-ip
          perform acuserve-adres-aktar

          move 1 to gec-gecme
          move "Tanimsiz ..." to referans-adi
     not invalid
          
             perform acuserve-adres-aktar
         
     end-read
     close referans.
     display lb-ref.
     if referans-fisno-ekle not numeric
        move 0 to referans-fisno-ekle
     end-if.
     if nereden <> "E"
        move 0 to numara
        display acc-numara.     
     .

*
 Form1-Bef-Create.
     perform adresleri-tasi.
     move tarih-tasi     to tarih.
        open input genel
    move 1 to genel-anahtar
    read genel no lock
      invalid
        move 3 to mesaj-no
        perform mesaj-ver
        set exit-pushed to true
      not invalid
        continue
*        move muha-sirketi to odenmez-dosya-adres
    end-read
    close genel
    move genel-muha-ref to ref
     if ONKPARA-REFERANS-VAR = 1 then 
       move 1 to ref-var
       else
       move 0 to ref-var
    end-if
     initialize referans-ip
        perform acuserve-adres-aktar.
     
     open input mgenel.
     move 1 to mgenel-anahtar.
     read mgenel no lock invalid
          display message box 
                  "mgenel parametre tanimsiz ..."
                  icon mb_error_icon
                  title "Hata"
                  close mgenel
                  destroy form1-handle
                  goback
     end-read.
     close mgenel.
     initialize referans-ip
    

     

     if mgenel-referans = "E" 
        move 1 to vis-1
     else
        move 0 to vis-1
     end-if.
     move 1 to enable-1
     move 0 to enable-2.
     
     .
*
 Form1-Ex-Other.
     if key-status = 2001 or 
        key-status = 2002 or
        key-status = 2003 
        continue else 
             exit paragraph.

     if key-status = 2001
        perform yaz-boggam
        exit paragraph.

     if key-status = 2003
        move 1 to enable-1 
        move 0 to enable-2
        modify form1-gd-1,reset-grid =1 
        display form1
*/-----------------------------\*  
*/---------DIL AYARLA----------\*    
*/-----------------------------\*    
        perform dil-ayarla-proc
*/-----------------------------\*         
        move 4 to accept-control
        move 4 to control-id
        close borc-dep alac-dep kasa-borc-dep kasa-alac-dep takas-acenta
        delete file borc-dep alac-dep  kasa-borc-dep kasa-alac-dep takas-acenta

        exit paragraph.

*       display message box  "geldi".
     perform Acc-Yil-Aft-Procedure.
     if gec-gecme = 1 
        move 4 to accept-control
        move 4 to control-id
        exit paragraph.

     perform Acc-Numara-Aft-Procedure.
     if gec-gecme = 1 
        move 4 to accept-control
        move 8 to control-id
        exit paragraph.

     move "E" to nereden.
     perform Acc-Ref-Aft-Procedure.
     if gec-gecme = 1 
        move 4 to accept-control
        move 12 to control-id
        exit paragraph.

     open i-o genelfis.
     move 1 to genelfis-anahtar.
     read genelfis no lock invalid move 1 to ekran-fis-1.
      
     add 1 to ekran-fis-1.
     move ekran-fis-1 to borc-dep-no.
      
     add 1 to ekran-fis-1.
     move ekran-fis-1 to kasa-borc-dep-no.
      
     add 1 to ekran-fis-1.
     move ekran-fis-1 to kasa-alac-dep-no.
     add 1 to ekran-fis-1.
      
     add 1 to ekran-fis-1.
     move ekran-fis-1 to alac-dep-no.
      
     add 1 to ekran-fis-1.
     move ekran-fis-1 to takas-acenta-no.
     rewrite genelfis-rec invalid write genelfis-rec end-write end-rewrite.
     close genelfis.
     open output borc-dep close borc-dep open i-o borc-dep with mass-update.
     open output alac-dep close alac-dep open i-o alac-dep with mass-update.
     open output kasa-borc-dep close kasa-borc-dep open i-o kasa-borc-dep with mass-update.
     open output kasa-alac-dep close kasa-alac-dep open i-o kasa-alac-dep with mass-update.
     open output takas-acenta close takas-acenta open i-o takas-acenta with mass-update.
     initialize kasa-borc-dep-rec kasa-alac-dep-rec borc-dep-rec alac-dep-rec takas-acenta-rec borc alac.

****|HAKAN|*** PROGRAMDAKÝ ARIZA YÜZÜNDEN BENÝ UÐRAÞTIRAN
**** DÝÐER PROGRAMCI ARKADAÞLARA SESLENÝYORUZ
*****
    perform fatdetay-oku
       
     move 0 to enable-1
     move 1 to enable-2
     display form1.
*/-----------------------------\*  
*/---------DIL AYARLA----------\*    
*/-----------------------------\*    
     perform dil-ayarla-proc.
*/-----------------------------\*         
     modify form1-gd-1,reset-grid =1,mass-update = 1.
     move "Hesap kodu"       to gd-1-col-1
     move "Hesap adi"        to gd-1-col-2
     move "Aciklama"         to gd-1-col-3
     MOVE "Ref"              to gd-1-col-4
     move "Borc Tutar"       to gd-1-col-5
     move "Alacak Tutar"     to gd-1-col-6
     modify form1-gd-1,record-to-add(form1-gd-1-record).

     open input hesap.
     initialize borc-dep-rec alac-dep-rec kasa-borc-dep-rec kasa-alac-dep-rec borc alac
     start borc-dep key not < borc-dep-anah2 invalid continue
     not invalid
     initialize fs-borc-dep
     perform with test after until fs-borc-dep = "10"
     read borc-dep next no lock end move "10" to fs-borc-dep
     not at end
          initialize form1-gd-1-record
          move borc-dep-hesap           to gd-1-col-1 hesap-kodu
          read hesap no lock invalid
                 add 1 to tanimsiz-sayi
                 move "Tanimsiz ..."   to hesap-adi
          end-read
          move hesap-adi             to gd-1-col-2
          move borc-dep-aciklama     to gd-1-col-3
          move borc-dep-ref          to gd-1-col-4 
          if onkpara-referans-var = 1 then 
              move ref-adi(borc-dep-ref)          to gd-1-col-4
            end-if
          
          move borc-dep-tutar        to etutar
          if borc-dep-ba = "B"
             move etutar             to gd-1-col-5
          else
             move etutar             to gd-1-col-6
          end-if
          modify form1-gd-1,record-to-add(form1-gd-1-record)
          if borc-dep-ba = "B"
             add borc-dep-tutar to borc
          else
             add borc-dep-tutar to alac
          end-if
     end-read
     end-perform
     end-start
     initialize borc-dep-rec alac-dep-rec 
     
     start alac-dep key not < alac-dep-anah2 invalid continue
     not invalid
     initialize fs-alac-dep
     perform with test after until fs-alac-dep = "10"
     read alac-dep next no lock end move "10" to fs-alac-dep
     not at end
          initialize form1-gd-1-record
            
          
          move alac-dep-hesap           to gd-1-col-1 hesap-kodu
          read hesap no lock invalid
               add 1 to tanimsiz-sayi
               move "Tanimsiz ..."   to hesap-adi
          end-read
          move hesap-adi             to gd-1-col-2
          move alac-dep-aciklama     to gd-1-col-3
          
            move alac-dep-ref          to gd-1-col-4
            
            if onkpara-referans-var = 1 then 
              move ref-adi(alac-dep-ref)          to gd-1-col-4
            end-if
          move alac-dep-tutar-tl     to etutar
          if alac-dep-ba = "B"
             move etutar             to gd-1-col-5
          else
             move etutar             to gd-1-col-6
          end-if
          modify form1-gd-1,record-to-add(form1-gd-1-record)
          if alac-dep-ba = "B"
             add alac-dep-tutar-tl to borc
          else
             add alac-dep-tutar-tl to alac
          end-if
     end-read
     end-perform
     end-start
********************* KASALAR **********************************
     start kasa-borc-dep key not < kasa-borc-dep-anah2 invalid continue
     not invalid
     initialize fs-kasa-borc-dep
     perform with test after until fs-kasa-borc-dep = "10"
     read kasa-borc-dep next no lock end move "10" to fs-kasa-borc-dep
     not at end
          initialize form1-gd-1-record
          move kasa-borc-dep-hesap           to gd-1-col-1 hesap-kodu
          read hesap no lock invalid
               add 1 to tanimsiz-sayi
               move "Tanimsiz ..."   to hesap-adi
          end-read
          move hesap-adi             to gd-1-col-2
          move kasa-borc-dep-aciklama     to gd-1-col-3
          move kasa-borc-dep-tutar        to etutar
          move kasa-borc-dep-ref          to gd-1-col-4
           if onkpara-referans-var = 1 then 
              move ref-adi(kasa-borc-dep-ref)          to gd-1-col-4
            end-if
          if kasa-borc-dep-ba = "B"
             move etutar             to gd-1-col-5
          else
             move etutar             to gd-1-col-6
          end-if
          modify form1-gd-1,record-to-add(form1-gd-1-record)
          if kasa-borc-dep-ba = "B"
             add kasa-borc-dep-tutar to borc
          else
             add kasa-borc-dep-tutar to alac
          end-if
     end-read
     end-perform
     end-start
            

     initialize kasa-borc-dep-rec kasa-alac-dep-rec 
     start kasa-alac-dep key not < kasa-alac-dep-anah2 invalid continue
     not invalid
     initialize fs-kasa-alac-dep
     perform with test after until fs-kasa-alac-dep = "10"
     read kasa-alac-dep next no lock end move "10" to fs-kasa-alac-dep
     not at end
          initialize form1-gd-1-record
          move kasa-alac-dep-hesap           to gd-1-col-1 hesap-kodu
          read hesap no lock invalid
               add 1 to tanimsiz-sayi
               move "Tanimsiz ..."   to hesap-adi
          end-read
          move hesap-adi             to gd-1-col-2
          move kasa-alac-dep-aciklama     to gd-1-col-3
          move kasa-alac-dep-tutar     to etutar
            move kasa-alac-dep-ref          to gd-1-col-4
             if onkpara-referans-var = 1 then 
              move ref-adi(kasa-alac-dep-ref)          to gd-1-col-4
            end-if
          if kasa-alac-dep-ba = "B"
             move etutar             to gd-1-col-5
          else
             move etutar             to gd-1-col-6
          end-if
          modify form1-gd-1,record-to-add(form1-gd-1-record)
          if kasa-alac-dep-ba = "B"
             add kasa-alac-dep-tutar to borc
          else
             add kasa-alac-dep-tutar to alac
          end-if
     end-read
     end-perform
     end-start
     
     close hesap.

     modify form1-gd-1,
            mass-update = 0.

     compute bakiye = borc - alac
     move borc   to etutar
     modify acc-borc, value = etutar
     move alac   to etutar
     modify acc-alac, value = etutar
     move bakiye to etutar
     modify acc-bakiye, value = etutar
     if borc <> alac 
        display message box 
                "Borc/Alacak toplami esit degil", new-line 
                "Mahsuplastirirsaniz mutlaka duzeltin"
                icon mb_error_icon
                title "Hata"
                
    end-if.

 yaz-boggam.
     close takas-acenta.
     delete file takas-acenta.
     if combo-dovizlimi-value(1:1)  = "D"
        perform kur-bul thru kur-bul-exit
     end-if
     if borc = 0 or alac = 0
        display message box
                "Muhasebelestirilecek kayit bulunamadi ..."
                icon mb_error_icon
                title "Hata"
                move 1 to enable-1 
                move 0 to enable-2
                display form1
*/-----------------------------\*  
*/---------DIL AYARLA----------\*    
*/-----------------------------\*    
                perform dil-ayarla-proc
*/-----------------------------\*         
                move 4 to accept-control
                move 4 to control-id
                close  borc-dep alac-dep   kasa-borc-dep kasa-alac-dep 
                delete file borc-dep alac-dep kasa-borc-dep kasa-alac-dep 
                exit paragraph
      end-if.
*******>Borc Departmanlari Muhasebelesiyor.........

 
     open i-o mahsup islenen hesap.
     if mah-birles = 1 then 
       open output mahsupm
       close mahsupm
       open i-o mahsupm
     end-if
     initialize borc-dep-rec alac-dep-rec fis-sira-sakla
     start borc-dep key not < borc-dep-anah2 invalid
      continue
      not invalid
     initialize fs-borc-dep
     perform with test after until fs-borc-dep = "10"
     read borc-dep next no lock end move "10" to fs-borc-dep
     not at end
      if " " not = borc-dep-corr
         move "10" to fs-borc-dep
         exit perform
       end-if
         initialize mahsup-rec 
         move tarih               to mahsup-tarih
         move numara              to mahsup-fis-no
         add  1                   to fis-sira-sakla
         move fis-sira-sakla      to mahsup-fis-sira
         move borc-dep-hesap      to mahsup-hesap-kodu
         move "A"                 to mahsup-tipi
         move borc-dep-ba         to mahsup-b-a 
         move borc-dep-tutar      to mahsup-tutar
         move borc-dep-aciklama   to mahsup-aciklama 
         move ref                 to mahsup-referans
         if ref-var = 1 then 
            move borc-dep-ref to mahsup-referans
         end-if
         move k-kodu-tasi         to mahsup-staf
         move borc-dep-hesap           to  hesap-kodu
         read hesap no lock invalid
                 continue
         end-read
         
         move HESAP-KDV-ORAN to mahsup-kdv-oran
         
         if combo-dovizlimi-value(1:1)  = "D" and 
            islem-kuru not = 0
            if mahsup-tutar <> zeroes
               move mgenel-banka  to mahsup-banka-kodu
               move mgenel-doviz  to mahsup-doviz-kodu
               move mgenel-d-e    to mahsup-d-e       
               move islem-kuru   to mahsup-doviz-kuru
               compute mahsup-tutar-dv rounded = 
                        mahsup-tutar / islem-kuru
            end-if
         end-if
        
         move "O"                 to mahsup-nereden
          move borc-dep-fatura-no    to mahsup-BELGE-NO 
          if mah-birles = 1 then 
            move mahsup-rec to mahsupm-rec
            move borc-dep-kredi to mahsupm-filler
            write mahsupm-rec invalid stop " " end-write
            else 
            write mahsup-rec invalid stop " " end-write
         end-if 
     end-read
     end-perform
     end-start
     if ara-bos not = 1
     if mah-birles not = 1 then 
      if fis-sira-sakla > 0 then 
             move numara      to islenen-fis-no
             move tarih       to islenen-tarih
             move "A"        to islenen-tipi
             move "O" to ISLENEN-NEREDEN
             write islenen-rec invalid 
                   rewrite islenen-rec end-rewrite
             end-write
             add 1 to numara
       end-if,  
       initialize fis-sira-sakla  
     end-if
     end-if

**************************************** kredi kartlari 108ler
     initialize borc-dep-rec alac-dep-rec 
     move "1" to borc-dep-corr

     start borc-dep key not < borc-dep-anah2 invalid
      continue
      not invalid
     initialize fs-borc-dep
     perform with test after until fs-borc-dep = "10"
     read borc-dep next no lock end move "10" to fs-borc-dep
     not at end
       if "1" not = borc-dep-corr
         move "10" to fs-borc-dep
         exit perform
       end-if
         initialize mahsup-rec 
         move tarih               to mahsup-tarih
         move numara              to mahsup-fis-no
         add  1                   to fis-sira-sakla
         move fis-sira-sakla      to mahsup-fis-sira
         move borc-dep-hesap      to mahsup-hesap-kodu
         move "A"                 to mahsup-tipi
         move borc-dep-ba         to mahsup-b-a 
         move borc-dep-tutar      to mahsup-tutar
         move borc-dep-aciklama   to mahsup-aciklama 
         move ref                 to mahsup-referans 
         if ref-var = 1 then 
            move borc-dep-ref to mahsup-referans
         end-if
         move k-kodu-tasi         to mahsup-staf 
         move borc-dep-fatura-no    to mahsup-BELGE-NO
         initialize hesap-rec
         move borc-dep-hesap           to  hesap-kodu
         read hesap no lock invalid
                 continue
         end-read
         
         move HESAP-KDV-ORAN to mahsup-kdv-oran


         if combo-dovizlimi-value(1:1)  = "D" and 
            islem-kuru not = 0
            if mahsup-tutar <> zeroes
               move mgenel-banka  to mahsup-banka-kodu
               move mgenel-doviz  to mahsup-doviz-kodu
               move mgenel-d-e    to mahsup-d-e       
               move islem-kuru   to mahsup-doviz-kuru
               compute mahsup-tutar-dv rounded = 
                       mahsup-tutar / islem-kuru
            end-if
         end-if
        
         move "O"                 to mahsup-nereden
          if mah-birles = 1 then 
            move mahsup-rec to mahsupm-rec
             move borc-dep-kredi to mahsupm-filler
            write mahsupm-rec invalid stop " " end-write
            else
            write mahsup-rec invalid stop " " end-write
         end-if 
         
         

     end-read
     end-perform
     end-start.
     if ara-bos not = 1
       if mah-birles not = 1 then 
     if fis-sira-sakla > 0 then 
             move numara      to islenen-fis-no
             move tarih       to islenen-tarih
             move "A"        to islenen-tipi
             move "O" to ISLENEN-NEREDEN
             write islenen-rec invalid 
                   rewrite islenen-rec end-rewrite
             end-write
             add 1 to numara
       end-if,  
       initialize fis-sira-sakla   
     end-if 
     end-if
       initialize kasa-borc-dep-rec 
     start kasa-borc-dep key not < kasa-borc-dep-anah2 invalid
              continue
              not invalid
     initialize fs-kasa-borc-dep
     perform with test after until fs-kasa-borc-dep = "10"
     read kasa-borc-dep next no lock end move "10" to fs-kasa-borc-dep
     not at end
         initialize mahsup-rec 
         move tarih               to mahsup-tarih
         move numara              to mahsup-fis-no
         add  1                   to fis-sira-sakla
         move fis-sira-sakla      to mahsup-fis-sira
         move kasa-borc-dep-hesap      to mahsup-hesap-kodu
         move "B"                 to mahsup-tipi
         move kasa-borc-dep-ba         to mahsup-b-a 
         move kasa-borc-dep-tutar      to mahsup-tutar
         move kasa-borc-dep-aciklama   to mahsup-aciklama 
         move ref                 to mahsup-referans 
         if ref-var = 1 then 
            move kasa-borc-dep-ref to mahsup-referans
         end-if
         move k-kodu-tasi         to mahsup-staf   
         move kasa-borc-dep-fatura-no    to mahsup-BELGE-NO 
         initialize hesap-rec
         move kasa-borc-dep-hesap           to  hesap-kodu
         read hesap no lock invalid
                 continue
         end-read
         move HESAP-KDV-ORAN to mahsup-kdv-oran

         if combo-dovizlimi-value(1:1)  = "D" and 
            islem-kuru not = 0
            if mahsup-tutar <> zeroes
               move mgenel-banka  to mahsup-banka-kodu
               move mgenel-doviz  to mahsup-doviz-kodu
               move mgenel-d-e    to mahsup-d-e       
               move islem-kuru   to mahsup-doviz-kuru
               compute mahsup-tutar-dv rounded = 
                       mahsup-tutar / islem-kuru
            end-if
         end-if
         move "O"                 to mahsup-nereden
          if mah-birles = 1 then 
            move mahsup-rec to mahsupm-rec
             move KASA-borc-dep-kredi to mahsupm-filler
            write mahsupm-rec invalid stop " " end-write
            else
            write mahsup-rec invalid stop " " end-write
         end-if 
        
         
     end-read
     end-perform
     end-start


     

     if ara-bos not = 1
        
     if fis-sira-sakla > 0 then 

             move numara      to islenen-fis-no
             move tarih       to islenen-tarih
             move "O" to ISLENEN-NEREDEN
             move "B"         to islenen-tipi
             write islenen-rec invalid 
                   rewrite islenen-rec end-rewrite
             end-write             
             add 1 to numara
       end-if, 
       initialize  fis-sira-sakla
       end-if   
*******>Alacak Departmanlari Muhasebelesiyor.........
     
  
     close borc-dep kasa-borc-dep
     initialize alac-dep-rec 
     start alac-dep key not < alac-dep-anah2 invalid
      continue
      not invalid
     initialize fs-alac-dep
     perform with test after until fs-alac-dep = "10"
     read alac-dep next no lock end move "10" to fs-alac-dep
     not at end
       if alac-dep-corr not = "C" then
          
         initialize mahsup-rec 
         move tarih               to mahsup-tarih
         move numara              to mahsup-fis-no
         add  1                   to fis-sira-sakla
         move fis-sira-sakla      to mahsup-fis-sira
         SET MAHSUP-DOVIZ-KILITLI TO TRUE
         move alac-dep-hesap      to mahsup-hesap-kodu
         move "A"                 to mahsup-tipi
         move alac-dep-ba         to mahsup-b-a 
         move alac-dep-tutar-tl   to mahsup-tutar
         move alac-dep-aciklama   to mahsup-aciklama 
         move ref                 to mahsup-referans 
         if ref-var = 1 then 
            move alac-dep-ref to mahsup-referans
         end-if
         move k-kodu-tasi         to mahsup-staf
         initialize hesap-rec
         move alac-dep-hesap           to  hesap-kodu
         read hesap no lock invalid
                 continue
         end-read
         move HESAP-KDV-ORAN to mahsup-kdv-oran
          if alac-dep-acenno not = spaces then
               move alac-dep-banka      to mahsup-banka-kodu
               move alac-dep-doviz      to mahsup-doviz-kodu
               move mgenel-d-e           to mahsup-d-e       
               move alac-dep-tutar-dv   to mahsup-tutar-dv
               move alac-dep-doviz-kuru to mahsup-doviz-kuru
         else
         if combo-dovizlimi-value(1:1)  = "D" and 
            islem-kuru not = 0
            if mahsup-tutar <> zeroes
               move mgenel-banka  to mahsup-banka-kodu
               move mgenel-doviz  to mahsup-doviz-kodu
               move mgenel-d-e    to mahsup-d-e       
               move islem-kuru   to mahsup-doviz-kuru
               compute mahsup-tutar-dv rounded = 
                       mahsup-tutar / islem-kuru
            end-if
         end-if
         if combo-dovizlimi-value(1:1)  = "D" and 
            alac-dep-banka  not = 0 and
            alac-dep-doviz  not = 0
            if mahsup-tutar <> zeroes
               move alac-dep-banka      to mahsup-banka-kodu
               move alac-dep-doviz      to mahsup-doviz-kodu
               move mgenel-d-e           to mahsup-d-e       
               move alac-dep-tutar-dv   to mahsup-tutar-dv
               move alac-dep-doviz-kuru to mahsup-doviz-kuru
            end-if
         end-if
         end-if
         if alac-dep-ara not = "A" then
             move alac-dep-fatura-no    to mahsup-BELGE-NO 
         end-if 

         move "O" to mahsup-nereden



          if mah-birles = 1 then 
            move mahsup-rec to mahsupm-rec
            move alac-dep-kredi to mahsupm-filler
            write mahsupm-rec invalid stop " " end-write
            else
            write mahsup-rec invalid stop " " end-write
         end-if 
         
         end-if
     end-read
     end-perform
     end-start.

************************** alacak correctionlar
       if ara-bos not = 1
       if mah-birles not = 1 then 
     if fis-sira-sakla > 0 then 

             move numara      to islenen-fis-no
             move tarih       to islenen-tarih
             move "A"         to islenen-tipi
                move "O" to ISLENEN-NEREDEN
             write islenen-rec invalid 
                   rewrite islenen-rec end-rewrite
             end-write
             add 1 to numara
             
       end-if,           
           initialize  fis-sira-sakla
    
     end-if
     end-if
     initialize alac-dep-rec 
     start alac-dep key not < alac-dep-anah invalid
      continue
      not invalid
     initialize fs-alac-dep
     perform with test after until fs-alac-dep = "10"
     read alac-dep next no lock end move "10" to fs-alac-dep
     not at end
       if alac-dep-corr  = "C" then
       
         initialize mahsup-rec 
         move tarih               to mahsup-tarih
         move numara              to mahsup-fis-no
         add  1                   to fis-sira-sakla
         move fis-sira-sakla      to mahsup-fis-sira
           SET MAHSUP-DOVIZ-KILITLI TO TRUE
        
         move alac-dep-hesap      to mahsup-hesap-kodu
         move "A"                 to mahsup-tipi
         move alac-dep-ba         to mahsup-b-a 
         move alac-dep-tutar-tl   to mahsup-tutar
         move alac-dep-aciklama   to mahsup-aciklama 
         move ref                 to mahsup-referans 
         if ref-var = 1 then 
            move alac-dep-ref to mahsup-referans
         end-if
         move k-kodu-tasi         to mahsup-staf
         initialize hesap-rec
         move alac-dep-hesap           to  hesap-kodu
         read hesap no lock invalid
                 continue
         end-read
         move HESAP-KDV-ORAN to mahsup-kdv-oran
         if alac-dep-acenno not = spaces then
               move alac-dep-banka      to mahsup-banka-kodu
               move alac-dep-doviz      to mahsup-doviz-kodu
               move mgenel-d-e           to mahsup-d-e       
               move alac-dep-tutar-dv   to mahsup-tutar-dv
               move alac-dep-doviz-kuru to mahsup-doviz-kuru
         else
         if combo-dovizlimi-value(1:1)  = "D" and 
            islem-kuru not = 0
            if mahsup-tutar <> zeroes
               move mgenel-banka  to mahsup-banka-kodu
               move mgenel-doviz  to mahsup-doviz-kodu
               move mgenel-d-e    to mahsup-d-e       
               move islem-kuru   to mahsup-doviz-kuru
               compute mahsup-tutar-dv rounded = 
                       mahsup-tutar / islem-kuru
            end-if
         end-if
         if combo-dovizlimi-value(1:1)  = "D" and 
            alac-dep-banka  not = 0 and
            alac-dep-doviz  not = 0
            if mahsup-tutar <> zeroes
               move alac-dep-banka      to mahsup-banka-kodu
               move alac-dep-doviz      to mahsup-doviz-kodu
               move mgenel-d-e           to mahsup-d-e       
               move alac-dep-tutar-dv   to mahsup-tutar-dv
               move alac-dep-doviz-kuru to mahsup-doviz-kuru
            end-if
         end-if
         end-if
*         move alac-dep-fatura-no    to mahsup-BELGE-NO  
         move "O" to mahsup-nereden

           if mah-birles = 1 then 
            move mahsup-rec to mahsupm-rec
            move alac-dep-kredi to mahsupm-filler
            write mahsupm-rec invalid stop " " end-write
            else
            write mahsup-rec invalid stop " " end-write
         end-if 
         
         end-if
     end-read
     end-perform
     end-start.
     if mah-birles not = 1 then 
        if fis-sira-sakla > 0 then 

             move numara      to islenen-fis-no
             move tarih       to islenen-tarih
             move "A"         to islenen-tipi
                move "O" to ISLENEN-NEREDEN
             write islenen-rec invalid 
                   rewrite islenen-rec end-rewrite
             end-write
             add 1 to numara             
       end-if,           
    end-if
************************   alacak kasalar  
     


     if mah-birles = 1 then 
          initialize fis-sira-sakla  mahsupm-rec 
          start mahsupm key >= mahsupm-kredi
                 invalid continue
                 not invalid
            perform until fs-mahsupm = "10"
                 read mahsupm  next 
                   end move "10" to fs-mahsupm
                    not end
                     if mahsupm-filler(1:1) = "K" then 
                          move "10" to fs-mahsupm
                          else

                    move mahsupm-rec to mahsup-rec
                     move numara              to mahsup-fis-no
                        add  1                   to fis-sira-sakla
                    move fis-sira-sakla      to mahsup-fis-sira
                   write mahsup-rec invalid stop " " end-write
                   end-if
                 end-read
            end-perform
         end-start
           if fis-sira-sakla > 0 then 

             move numara      to islenen-fis-no
             move tarih       to islenen-tarih
             move "A"         to islenen-tipi
                move "O" to ISLENEN-NEREDEN
             write islenen-rec invalid 
                   rewrite islenen-rec end-rewrite
             end-write
             add 1 to numara             
         end-if,     
          initialize fis-sira-sakla  mahsupm-rec 
         move "K" to mahsupm-filler
          start mahsupm key >= mahsupm-kredi
                 invalid continue
                 not invalid
            perform until fs-mahsupm = "10"
                 read mahsupm  next 
                   end move "10" to fs-mahsupm
                    not end
                    move mahsupm-rec to mahsup-rec
                     move numara              to mahsup-fis-no
                        add  1                   to fis-sira-sakla
                    move fis-sira-sakla      to mahsup-fis-sira
                   write mahsup-rec invalid stop " " end-write
                 end-read
            end-perform
         end-start
           if fis-sira-sakla > 0 then 

             move numara      to islenen-fis-no
             move tarih       to islenen-tarih
             move "A"         to islenen-tipi
                move "O" to ISLENEN-NEREDEN
             write islenen-rec invalid 
                   rewrite islenen-rec end-rewrite
             end-write
             add 1 to numara             
         end-if,  
         
         close mahsupm
     end-if
    
  
      
          initialize  fis-sira-sakla
     
     initialize kasa-alac-dep-rec 
     start kasa-alac-dep key not < kasa-alac-dep-anah invalid
      continue
      not invalid
     initialize fs-kasa-alac-dep
     perform with test after until fs-kasa-alac-dep = "10"
     read kasa-alac-dep next no lock end move "10" to fs-kasa-alac-dep
     not at end
         initialize mahsup-rec 
         move tarih               to mahsup-tarih
         move numara              to mahsup-fis-no
         add  1                   to fis-sira-sakla
         move fis-sira-sakla      to mahsup-fis-sira

         move kasa-alac-dep-hesap      to mahsup-hesap-kodu
         move "C"                 to mahsup-tipi
         move kasa-alac-dep-ba         to mahsup-b-a 
         move kasa-alac-dep-tutar   to mahsup-tutar
         move kasa-alac-dep-aciklama   to mahsup-aciklama 
         move ref                 to mahsup-referans 
         if ref-var = 1 then 
            move kasa-alac-dep-ref to mahsup-referans
         end-if
         move k-kodu-tasi         to mahsup-staf 
         initialize hesap-rec
         move kasa-alac-dep-hesap           to  hesap-kodu
         read hesap no lock invalid
                 continue
         end-read
         move HESAP-KDV-ORAN to mahsup-kdv-oran
         if combo-dovizlimi-value(1:1)  = "D" and 
            islem-kuru not = 0
            if mahsup-tutar <> zeroes
               move mgenel-banka  to mahsup-banka-kodu
               move mgenel-doviz  to mahsup-doviz-kodu
               move mgenel-d-e    to mahsup-d-e       
               move islem-kuru   to mahsup-doviz-kuru
               compute mahsup-tutar-dv rounded = 
                       mahsup-tutar / islem-kuru
            end-if
         end-if
         if combo-dovizlimi-value(1:1)  = "D" and 
            kasa-alac-dep-banka  not = 0 and
            kasa-alac-dep-doviz  not = 0
            if mahsup-tutar <> zeroes
               move kasa-alac-dep-banka      to mahsup-banka-kodu
               move alac-dep-doviz      to mahsup-doviz-kodu
               move mgenel-d-e           to mahsup-d-e       
               move kasa-alac-dep-tutar-dv   to mahsup-tutar-dv
               move kasa-alac-dep-doviz-kuru to mahsup-doviz-kuru
            end-if
         end-if
         move kasa-alac-dep-fatura-no    to mahsup-BELGE-NO  
         move "O" to mahsup-nereden
           if mah-birles = 1 then 
            move mahsup-rec to mahsupm-rec
             move kASA-ALAC-dep-kredi to mahsupm-filler
            write mahsupm-rec invalid stop " " end-write
            else
            write mahsup-rec invalid stop " " end-write
         end-if 


         
         
     end-read
     end-perform
     end-start.
     if ara-bos not = 1
           if fis-sira-sakla > 0 then 

             move numara      to islenen-fis-no
             move tarih       to islenen-tarih
             move "C"         to islenen-tipi
                move "O" to ISLENEN-NEREDEN
             write islenen-rec invalid 
                   rewrite islenen-rec end-rewrite
             end-write
             add 1 to numara             
       end-if,  
       else
       if fis-sira-sakla > 0 then 
             move numara      to islenen-fis-no
             move tarih       to islenen-tarih
             move "A"        to islenen-tipi
             move "O" to ISLENEN-NEREDEN
             write islenen-rec invalid 
                   rewrite islenen-rec end-rewrite
             end-write
             add 1 to numara
       end-if,          
      end-if
     
     
     
     close alac-dep mahsup kasa-alac-dep.
     delete file alac-dep kasa-alac-dep.
     delete file borc-dep kasa-borc-dep.



     close islenen.
     display message box 
             "Gunluk [ ONBURO  ] Faturalar Olusturulmustur Kontrol Ediniz !!!".
     modify form1-gd-1,reset-grid =1 .
     move 1 to enable-1 
     move 0 to enable-2
     display form1
     move 4 to accept-control
     move 4 to control-id.
*/-----------------------------\*  
*/---------DIL AYARLA----------\*    
*/-----------------------------\*    
     perform dil-ayarla-proc.
*/-----------------------------\*         
     .
*
 acc-ref-Ex-Other.
     if key-status =  1
        initialize link-referans
        call "/asya/ytl/obj/muha/refara.asy" using link-referans
             on exception 
                perform callerr-proc
        not on exception
             cancel "/asya/ytl/obj/muha/refara.asy"
        end-call
        if link-referans <> spaces
           move link-referans to ref
           display acc-ref
           move 4 to accept-control
           move 12 to control-id
        end-if
     end-if.
*
 kur-bul.
        initialize islem-kuru.
     if combo-dovizlimi-value(1:1)  = "D"
        
               
        open input kur
        initialize islem-kuru
        move tarih         to kur-tarih
        move mgenel-banka   to kur-banka
        move mgenel-doviz   to kur-doviz
        read kur no lock invalid 
         display message box "Gunluk Kur Kaydi Bulunamadi Devam Ederseniz Dovizsiz Mahsup Keser.."
                              new-line,
                              "Islem Tarihi...........:" gun "/" ay "/" yil   
                              new-line,
                              "Banka-Doviz Kodu.......:" mgenel-banka   "-" mgenel-doviz
                              title = " [ Kurlar Tanimsiz ] "
         close kur 
         exit paragraph
        end-read
        move doviz-alis to islem-kuru
        if mgenel-d-e = "D" and mgenel-a-s = "A" 
           move doviz-alis    to islem-kuru
        end-if 
        if mgenel-d-e = "D" and mgenel-a-s = "S" 
           move doviz-satis   to islem-kuru
        end-if 
        if mgenel-d-e = "E" and mgenel-a-s = "A" 
           move efektif-alis  to islem-kuru
        end-if 
        if mgenel-d-e = "E" and mgenel-a-s = "S" 
           move efektif-satis to islem-kuru
        end-if 

        if islem-kuru = 0 
           display message box "Kur Tutari [0] Olamaz, Islem Yapamazsiniz.."
                            new-line,
                            "Islem Tarihi...........:" gun "/" ay "/" yil
                            new-line,
                            "Banka-Doviz Kodu.......:" mgenel-banka   "-" mgenel-doviz
                            title = " [ Kurlar Tanimsiz ] "
          close kur 
          exit paragraph
        end-if
        close kur
     end-if.
 kur-bul-exit.
    exit.



 fatdetay-oku.
         
    open input  depkod2 depkod fatdetay romhrk exthrk fatura konuk.
    initialize fatdetay-rec .
    move tarih to fatdetay-fat-tar.
    
    start fatdetay key not < fatdetay-anah invalid continue,
        not invalid,
        move spaces to evet-hayir,
        perform with test after until evet,
        read fatdetay next no lock end move "E" to evet-hayir,
            not end,

************   **********************
            initialize fatura-rec
            move function numval(fatdetay-fat-no)  to fatura-no 
            
            read fatura no lock invalid 
               continue 
               not invalid 
               move FATURA-TARIHI to fatdetay-fat-tar
            end-read
           
*******************
            if fatdetay-fat-tar > tarih,
                 continue
*  move "E" to evet-hayir,
            end-if,

            if fatdetay-fat-tar = tarih,
               
                initialize depkod-rec depkod2-rec,
                move fatdetay-depkod to depkod-kodu depkod2-kodu,
                 if fatdetay-depkod = "C/L" then 
                   
                     continue

                  else
                    
                   if fatdetay-romhrk-exthrk = "R" then
                        move fatdetay-islem to romhrk-islem
                        move fatdetay-folio to romhrk-folio  konuk-folio
                         if ref-var = 1 then 
                        read konuk no lock invalid 
                        stop " "
                        end-read
                        move xkonum-ref(konuk-fiyat-konumu) to sat-ref
                        if xkonum-ref(konuk-oda-konumu) not = ref then 
                             exit perform cycle
                        end-if
                        end-if
                        read romhrk no lock 
                            invalid exit perform cycle
                              not invalid
                              move romhrk-corr-depkod to  depkod2-kodu
                           if function numval(fatdetay-fat-no) 
                                not = romhrk-FATURA-NO
                            
                           exit perform cycle
                         end-if
                      end-read
                  else
                       move fatdetay-islem to exthrk-islem
                           move fatdetay-folio to exthrk-folio    konuk-folio
                            if ref-var = 1 then 
                        read konuk no lock invalid 
                        stop " "
                        end-read
                        move xkonum-ref(konuk-fiyat-konumu) to sat-ref
                       
                        if xkonum-ref(konuk-oda-konumu) not = ref then 
                             exit perform cycle
                        end-if

                        end-if

                        read exthrk no lock 
                          invalid exit perform cycle
                          not invalid 
                          move exthrk-corr-depkod to  depkod2-kodu
                           if function numval(fatdetay-fat-no) not = exthrk-FATURA-NO
                            exit perform cycle
                          end-if
                        end-read


                end-if
                read depkod no lock invalid continue,
                    not invalid,
                      if  depkod-TURU not = 2 then 
                            move depkod-kodu to depkod2-kodu
                            else
                            move depkod2-kodu to depkod-kodu
                            read depkod no lock invalid
                              continue

                            end-read
                           move 2 to depkod-turu
                      end-if
                      read depkod2 no lock invalid continue
                        not invalid
*                          if depkod2-matrah-hesap(1:3) not = "100"
                                perform takaslara-yaz
*                               else
*                             perform kasa-takaslara-yaz
*                          end-if
                      end-read
                end-read,
              end-if
            end-if,
        end-read,
        end-perform,
    end-start.
    perform kredi-bul
    close fatdetay depkod depkod2 romhrk exthrk fatura konuk.

* 
 takaslara-yaz.
             if ref-var = 1
              move xkonum-ref(konuk-fiyat-konumu) to sat-ref 
              end-if
              evaluate true
                    when depkod-ba = "B"  or ( depkod-ba = "A"  and depkod-TURU = 2 )
                         initialize borc-dep-rec,
                         if depkod-toplam-hesap not = spaces
                            and  depkod2-toplam-hesap not = spaces
                            move depkod-toplam-hesap   to borc-dep-hesap
                            if depkod-matrah-ba = "A"
                               move "A"   to borc-dep-ba
                            else
                               move "B"   to borc-dep-ba
                            end-if
                            
                            move depkod-toplam-hesap  to borc-dep-hesap
                            if ref-var = 1
                             move ref to borc-dep-ref
                            end-if
                            read borc-dep no lock invalid continue,
                            end-read,
                            if  depkod-TURU= 2
                                  compute borc-dep-tutar rounded = 
                                 borc-dep-tutar - fatdetay-fatura-toplam
                               else
                                 compute borc-dep-tutar rounded = 
                                 borc-dep-tutar + fatdetay-fatura-toplam
                                 move "Gunluk Gelirler Geregi" to borc-dep-aciklama
                             end-if
                            write borc-dep-rec invalid rewrite borc-dep-rec,
                            end-write,

                             initialize borc-dep-rec,

                            move depkod-toplam-hesap   to borc-dep-hesap
                            if depkod-matrah-ba = "B"
                               move "A"   to borc-dep-ba
                            else
                               move "B"   to borc-dep-ba
                            end-if
                            
                            move depkod2-toplam-hesap   to borc-dep-hesap
                            move function numval(fatdetay-fat-no)        to borc-dep-fatura-no
                            if ref-var = 1

                             move ref to borc-dep-ref
                            if depkod-ref > 0 and < max-ref then
                               move depkod-ref to borc-dep-ref
                            end-if  end-if
                            read borc-dep no lock invalid continue,
                            end-read,
                            if  depkod-TURU= 2
                                  compute borc-dep-tutar rounded = 
                                 borc-dep-tutar - fatdetay-fatura-toplam
                               else
                                 compute borc-dep-tutar rounded = 
                                 borc-dep-tutar + fatdetay-fatura-toplam
                                 move "Gunluk Gelirler Geregi" to borc-dep-aciklama
                            end-if
                            write borc-dep-rec invalid rewrite borc-dep-rec,
                            end-write,
                         end-if
                           if (depkod-matrah-hesap not = spaces or ara-bos = 1)
                            and  depkod2-matrah-hesap not = spaces
                             initialize borc-dep-rec,
                            move depkod-matrah-hesap   to borc-dep-hesap
                            if depkod-matrah-ba = "B"
                               move "A"   to borc-dep-ba
                            else
                               move "B"   to borc-dep-ba
                            end-if
                            
                            
                            move depkod-matrah-hesap  to borc-dep-hesap
                             if ref-var = 1
                             move ref to borc-dep-ref
                            end-if
                            read borc-dep no lock invalid continue,
                            end-read,
                                if  depkod-TURU= 2
                                  compute borc-dep-tutar rounded = 
                                 borc-dep-tutar - fatdetay-fatura-matrah
                               else


                                 compute borc-dep-tutar rounded = borc-dep-tutar +
                                 fatdetay-fatura-matrah
                                 move "Gunluk Gelirler Geregi" to borc-dep-aciklama
                             end-if
                                 if ara-bos not = 1 
                                    write borc-dep-rec invalid rewrite borc-dep-rec,
                                    
                                    end-write,
                                end-if
                             initialize borc-dep-rec,
                            move depkod2-matrah-hesap   to borc-dep-hesap
                            if depkod-matrah-ba = "A"
                               move "A"   to borc-dep-ba
                            else
                               move "B"   to borc-dep-ba
                            end-if
                            
                            
                            move depkod2-matrah-hesap   to borc-dep-hesap
                            move  function numval(fatdetay-fat-no)        to borc-dep-fatura-no
                            if ref-var = 1

                             move ref to borc-dep-ref
                            if depkod-ref > 0 and < max-ref then
                               move depkod-ref to borc-dep-ref
                            end-if  end-if
                            read borc-dep no lock invalid continue,
                            end-read,
                            if  depkod-TURU= 2
                                  compute borc-dep-tutar rounded = 
                                 borc-dep-tutar - fatdetay-fatura-matrah
                               else
                                 compute borc-dep-tutar rounded = borc-dep-tutar + 
                                 fatdetay-fatura-matrah

                                 move fatdetay-fat-no  to borc-dep-aciklama    
                               
                                 move "Ft geregi" to borc-dep-aciklama (17:)
                             end-if
                            write borc-dep-rec invalid rewrite borc-dep-rec,
                            end-write,
                         end-if
                         if (depkod-kdv-hesap not = spaces or ara-bos = 1)
                            and  depkod2-kdv-hesap not = spaces
                             initialize borc-dep-rec,
                            move depkod-kdv-hesap   to borc-dep-hesap
                            if depkod-matrah-ba = "B"
                               move "A"   to borc-dep-ba
                            else
                               move "B"   to borc-dep-ba
                            end-if
                            
                            
                            move depkod-kdv-hesap  to borc-dep-hesap
                            if ref-var = 1
                                move ref to borc-dep-ref
                            end-if
                            read borc-dep no lock invalid continue,
                            end-read,
                            if  depkod-TURU= 2
                                  compute borc-dep-tutar rounded = 
                                 borc-dep-tutar - fatdetay-fatura-kdv
                               else
                                 compute borc-dep-tutar rounded = 
                                 borc-dep-tutar + fatdetay-fatura-kdv
                                 move "Gunluk Gelirler Geregi" to borc-dep-aciklama
                            end-if
                                 if ara-bos not = 1 
                            write borc-dep-rec invalid rewrite borc-dep-rec,
                            end-write,
                            end-if
                              initialize borc-dep-rec,
                            move depkod2-kdv-hesap   to borc-dep-hesap
                            if depkod-matrah-ba = "A"
                               move "A"   to borc-dep-ba
                            else
                               move "B"   to borc-dep-ba
                            end-if
                            
                           
                            move depkod2-kdv-hesap   to borc-dep-hesap
                            move  function numval(fatdetay-fat-no)        to borc-dep-fatura-no
                            if ref-var = 1
                                move ref to borc-dep-ref
                                if depkod-ref > 0 and < max-ref then
                                    move depkod-ref to borc-dep-ref
                                end-if  
                            end-if
                            read borc-dep no lock invalid continue,
                            end-read,
                               if  depkod-TURU= 2
                                  compute borc-dep-tutar rounded = 
                                 borc-dep-tutar - fatdetay-fatura-kdv
                               else
                                 compute borc-dep-tutar rounded = 
                                 borc-dep-tutar + fatdetay-fatura-kdv
                                 move fatdetay-fat-no  to borc-dep-aciklama
                                 
                                 move "Ft geregi" to borc-dep-aciklama (17:)
                                 end-if
                            write borc-dep-rec invalid rewrite borc-dep-rec,
                            end-write,
                         end-if
                          if  depkod-TURU= 2
                             move -1 to carpan 
                             else
                             move 1 to carpan
                          end-if
                         perform karsilik-bul
                                


                    end-evaluate,
          
    .   
*
************************************************************ *
*
karsilik-bul.
*        if  fatdetay-folio = "00180460" then stop " " end-if
       initialize romhrk-rec exthrk-rec  depkod-kodu  ad-soyad
       move fatdetay-folio to romhrk-folio exthrk-folio
      if fatdetay-romhrk-exthrk = "R" 
       start romhrk key > romhrk-anah 
       invalid continue
       not invalid
         perform until fs-romhrk = "10"
           read romhrk next no lock 
             end move "10" to fs-romhrk
             not end 
             if romhrk-folio not = fatdetay-folio
               move "10" to fs-romhrk
               else
               if romhrk-ba = "A" and (romhrk-corr-depkod = spaces or zeroes) then 
                 move romhrk-depkod to depkod-kodu
                 
               end-if
            end-if
            end-read

         end-perform 
        end-start
        else
          start exthrk key > exthrk-anah 
       invalid continue
       not invalid
         perform until fs-exthrk = "10"
           read exthrk next no lock 
             end move "10" to fs-exthrk
             not end 
             if exthrk-folio not = fatdetay-folio
               move "10" to fs-exthrk
               else
               if exthrk-ba = "A" and (exthrk-corr-depkod = spaces or zeroes) then 
                 move exthrk-depkod to depkod-kodu
                 
               end-if
             end-if
            end-read

         end-perform 
        end-start

        end-if

        move  depkod-kodu to depkod2-kodu
        if depkod-kodu not = spaces 
            read depkod no lock invalid continue,
                    not invalid,
                      read depkod2 no lock invalid continue
                        not invalid
                          
                          initialize borc-dep-rec,
                          if  depkod2-matrah-hesap(1:3)  = "108"
                                  move "1" to kk
                                  else  move " " to kk
                                end-if
                         if depkod-toplam-hesap not = spaces
                            and  depkod2-toplam-hesap not = spaces
                         

                             initialize borc-dep-rec,
                             if  depkod2-matrah-hesap(1:3) not = "100"
                                if  depkod2-matrah-hesap(1:3)  = "108"
                                  move "1" to kk
                                  else  move " " to kk
                                end-if
                                 move kk to  borc-dep-corr
                                move depkod-toplam-hesap   to borc-dep-hesap
                            if depkod-matrah-ba = "A"
                               move "A"   to borc-dep-ba
                            else
                               move "B"   to borc-dep-ba
                            end-if
                            move depkod-toplam-hesap  to borc-dep-hesap
                            if ref-var = 1
                                   move ref to borc-dep-ref
                            end-if
                            read borc-dep no lock invalid continue,
                            end-read,
                                 compute borc-dep-tutar rounded = 
                                 borc-dep-tutar + (fatdetay-fatura-toplam * carpan)

                                 move "Gunluk Tahsilati Geregi" to borc-dep-aciklama
                            write borc-dep-rec invalid rewrite borc-dep-rec,
                            end-write,

                                initialize borc-dep-rec,
                                  move kk to  borc-dep-corr
                            if depkod-matrah-ba = "B"
                               move "A"   to borc-dep-ba
                            else
                               move "B"   to borc-dep-ba
                            end-if
                            move depkod2-toplam-hesap   to borc-dep-hesap
                            move  function numval(fatdetay-fat-no)        to borc-dep-fatura-no


                            if ref-var = 1
                               move ref to borc-dep-ref
                               if depkod-ref > 0 and < max-ref
                                    move depkod-ref to borc-dep-ref
                                end-if
                            end-if



                            read borc-dep no lock invalid continue,
                            end-read,
                                 compute borc-dep-tutar rounded = 
                                 borc-dep-tutar + (fatdetay-fatura-toplam * carpan)
                                 move fatdetay-fat-no(1:6)        to borc-dep-aciklama(3:6)
                                 move "ft gr tahs-"   to borc-dep-aciklama(10:)
                                 string konuk-adi delimited by "  "
                                       " " delimited by size
                                        konuk-soyadi delimited by   "  "
                                       into ad-soyad
                                       move ad-soyad to borc-dep-aciklama(21:)
                            write borc-dep-rec invalid rewrite borc-dep-rec,
                            end-write,
                            else 
                              
                              if depkod-matrah-ba = "B"
                                initialize kasa-alac-dep-rec,
                               move depkod-toplam-hesap   to KASA-alac-dep-hesap
                            if depkod-matrah-ba = "A"
                               move "A"   to KASA-alac-dep-ba
                            else
                               move "B"   to KASA-alac-dep-ba
                            end-if
                            move depkod-toplam-hesap  to KASA-alac-dep-hesap
                            if ref-var = 1
                               move ref to kasa-alac-dep-ref
                               
                            end-if
                            read KASA-alac-dep no lock invalid continue,
                            end-read,
                                 compute KASA-alac-dep-tutar rounded = 
                                 KASA-alac-dep-tutar +(fatdetay-fatura-toplam * carpan)
                                 move "Gunluk iadeler Geregi" to KASA-alac-dep-aciklama
                            write KASA-borc-dep-rec invalid rewrite KASA-alac-dep-rec,
                            end-write,
                                    initialize kasa-alac-dep-rec,
                            if depkod-matrah-ba = "B"
                               move "A"   to kasa-alac-dep-ba
                            else
                               move "B"   to kasa-alac-dep-ba
                            end-if
                            move depkod2-toplam-hesap   to kasa-alac-dep-hesap
                            move  function numval(fatdetay-fat-no)        to kasa-alac-dep-fatura-no
                            if ref-var = 1
                               move ref to kasa-alac-dep-ref
                               if depkod-ref > 0 and < max-ref
                                    move depkod-ref to kasa-alac-dep-ref
                                end-if
                            end-if
                            
                            
                            read kasa-alac-dep no lock invalid continue,
                            end-read,
                                 compute kasa-alac-dep-tutar rounded = 
                                 kasa-alac-dep-tutar + (fatdetay-fatura-toplam * carpan)
                                 move  fatdetay-fat-no        to kasa-alac-dep-aciklama(1:)
                                 move "ft gr. iade-" to kasa-alac-dep-aciklama(10:)
                                 string konuk-adi delimited by "  "
                                       " " delimited by size
                                        konuk-soyadi delimited by   "  "
                                       into ad-soyad
                                       move ad-soyad to kasa-alac-dep-aciklama(22:)
                            write kasa-alac-dep-rec invalid rewrite kasa-alac-dep-rec,
                            end-write,

                      else
                               initialize kasa-borc-dep-rec,
                               move depkod-toplam-hesap   to KASA-borc-dep-hesap
                            if depkod-matrah-ba = "A"
                               move "A"   to KASA-borc-dep-ba
                            else
                               move "B"   to KASA-borc-dep-ba
                            end-if
                            move depkod-toplam-hesap  to KASA-borc-dep-hesap
                            if ref-var = 1
                               move ref to kasa-borc-dep-ref
                               
                            end-if
                            
                            read KASA-borc-dep no lock invalid continue,
                            end-read,
                                 compute KASA-borc-dep-tutar rounded = 
                                 KASA-borc-dep-tutar + (fatdetay-fatura-toplam * carpan)
                                 move "Gunluk Tahsilatlar Geregi" to KASA-borc-dep-aciklama
                            write KASA-borc-dep-rec invalid rewrite KASA-borc-dep-rec,
                            end-write,
                                    initialize kasa-borc-dep-rec,
                            if depkod-matrah-ba = "B"
                               move "A"   to kasa-borc-dep-ba
                            else
                               move "B"   to kasa-borc-dep-ba
                            end-if
                            move depkod2-toplam-hesap   to kasa-borc-dep-hesap
                            move  function numval(fatdetay-fat-no)        to kasa-borc-dep-fatura-no
                            
                            if ref-var = 1
                               move ref to kasa-borc-dep-ref
                               if depkod-ref > 0 and < max-ref
                                    move depkod-ref to kasa-borc-dep-ref
                                end-if
                            end-if

                            read kasa-borc-dep no lock invalid continue,
                            end-read,
                                 compute kasa-borc-dep-tutar rounded = 
                                 kasa-borc-dep-tutar + (fatdetay-fatura-toplam * carpan)
                                 move  fatdetay-fat-no        to kasa-borc-dep-aciklama(1:)
                                 move "ft gr tahs-" to kasa-borc-dep-aciklama(10:)
                                 string konuk-adi delimited by "  " 
                                        " " delimited by size
                                        konuk-soyadi delimited by "  "
                                        into ad-soyad
                                       move ad-soyad to kasa-borc-dep-aciklama(21:)
                            write kasa-borc-dep-rec invalid rewrite kasa-borc-dep-rec,
                            end-write,
                             end-if
                         end-if
                         
                         end-if



                         initialize borc-dep-rec,
                         if depkod-matrah-hesap not = spaces
                            and  depkod2-matrah-hesap not = spaces
                             if  depkod2-matrah-hesap(1:3) not = "100"
                              
                              initialize borc-dep-rec,
                              move kk to borc-dep-corr
                              move depkod-matrah-hesap   to borc-dep-hesap
                              if depkod-matrah-ba = "B"
                                   move "A"   to borc-dep-ba
                               else
                                  move "B"   to borc-dep-ba
                              end-if
                              move depkod-matrah-hesap  to borc-dep-hesap
                              if ref-var = 1
                               move ref to borc-dep-ref
                               
                              end-if
                              read borc-dep no lock invalid continue,
                               end-read,
                                 compute borc-dep-tutar rounded = 
                                 borc-dep-tutar + (fatdetay-fatura-toplam * carpan)
                                 move "Gunluk Tahsilatlar Geregi" to borc-dep-aciklama
                               write borc-dep-rec invalid rewrite borc-dep-rec,
                               end-write,

                                initialize borc-dep-rec,
                                 move kk to borc-dep-corr
                                if depkod-matrah-ba = "A"
                                  move "A"   to borc-dep-ba
                                else
                                  move "B"   to borc-dep-ba
                                end-if
                                move depkod2-matrah-hesap   to borc-dep-hesap
                                move function numval(fatdetay-fat-no)        to borc-dep-fatura-no
                              if ref-var = 1
                               move ref to borc-dep-ref
                               if depkod-ref > 0 and < max-ref
                                    move depkod-ref to borc-dep-ref
                                end-if
                               end-if


                                read borc-dep no lock invalid continue,
                                end-read,
                                 compute borc-dep-tutar rounded = 
                                 borc-dep-tutar + (fatdetay-fatura-toplam * carpan)
                                 move fatdetay-fat-no        to borc-dep-aciklama(1:)
                                 move "ft gr tahs-" to borc-dep-aciklama(10:)
                                 string konuk-adi delimited by "  " 
                                        " " delimited by size
                                         konuk-soyadi delimited by "  "
                                        into ad-soyad
                                       move ad-soyad to borc-dep-aciklama(21:)
                                write borc-dep-rec invalid rewrite borc-dep-rec,
                                  end-write,
                            else 
                                  initialize KASA-borc-dep-rec,
                              move depkod-matrah-hesap   to KASA-borc-dep-hesap
                              if depkod-matrah-ba = "B"
                                   move "A"   to KASA-borc-dep-ba
                               else
                                  move "B"   to KASA-borc-dep-ba
                              end-if
                              move depkod-matrah-hesap  to KASA-borc-dep-hesap
                              
                              if ref-var = 1
                               move ref to KASA-borc-dep-ref
                              end-if
                              
                              read KASA-borc-dep no lock invalid continue,
                               end-read,
                                 compute KASA-borc-dep-tutar rounded = 
                                 KASA-borc-dep-tutar + (fatdetay-fatura-toplam * carpan)
                                 move "Gunluk Tahsilatlar Geregi" to KASA-borc-dep-aciklama
                               write KASA-borc-dep-rec invalid rewrite KASA-borc-dep-rec,
                               end-write,
                               
                               initialize kasa-borc-dep-rec,
                                 if depkod-matrah-ba = "A"
                                     move "A"   to kasa-borc-dep-ba
                                    else
                                       move "B"   to kasa-borc-dep-ba
                                  end-if
                             
                                 move depkod2-matrah-hesap   to KASA-borc-dep-hesap
                                 move  function numval(fatdetay-fat-no)         to kasa-borc-dep-fatura-no
                              if ref-var = 1
                               move ref to KASA-borc-dep-ref
                               if depkod-ref > 0 and < max-ref
                                    move depkod-ref to KASA-borc-dep-ref
                                end-if
                               end-if



                                 read kasa-borc-dep no lock invalid continue,
                                 end-read,
                                 compute kasa-borc-dep-tutar rounded = 
                                 kasa-borc-dep-tutar + (fatdetay-fatura-toplam * carpan)
                                 move fatdetay-fat-no        to kasa-borc-dep-aciklama(1:)
                                  move "ft gr tahs-" to kasa-borc-dep-aciklama(10:)
                                 string konuk-adi delimited by "  " 
                                        " " delimited by size
                                        konuk-soyadi delimited by "  "
                                        into ad-soyad
                                       move ad-soyad to kasa-borc-dep-aciklama(21:)
                                 write kasa-borc-dep-rec invalid rewrite kasa-borc-dep-rec,
                              end-write,

                         end-if
                         
                         end-if
                      end-read
                end-read,
         end-if .
        .



kacgun-bul.
       open input takvim 
       initialize takvim-rec takas-acenta-gun
        
        move konuk-gel-tar to takvim-anah
        start takvim key > takvim-anah 
            invalid
            not invalid   
             perform until fs-takvim =  "10"  
               read takvim next no lock
                  end move "10" to fs-takvim
                  not end
                  if takvim-anah < konuk-git-tar then
                      add 1 to takas-acenta-gun
                    else
                       add 1 to takas-acenta-gun
                       move "10" to fs-takvim
                  end-if
               end-read
             end-perform
         end-start
         close takvim.

*
 takas-acenta-dovizleri-bul.
       
         open input acenfat
           initialize acenfat-rec
           move tarih to acenfat-tarih
           move konuk-acenta to acenfat-acenta
             start acenfat key > acenfat-anah
                invalid continue
                not invalid
                  perform until fs-acenfat = "10"
                    read acenfat next
                       end move "10" to fs-acenfat
                       not end
                       if tarih not =  acenfat-tarih
                         or konuk-acenta not = acenfat-acenta
                          move "10" to fs-acenfat
                          else
                          if acenfat-folio = konuk-folio
                                 
                             compute tl-gunluk rounded =   (ACENFAT-tl-TUTAR / acenfat-per-geceleme )
                             compute dv-gunluk rounded =   tl-gunluk / (konuk-kur-degeri)
                             compute takas-acenta-dv-tutar =  takas-acenta-dv-tutar + 
                                                           ( dv-gunluk  * acenfat-per-geceleme )
                          end-if 
                        end-if
                    end-read

                  end-perform
             end-start
         close acenfat

        
          .
*
 kredi-karsilik.
        
       initialize borc-dep-rec,
       if ( depkod-matrah-hesap not = spaces   or ara-bos = 1 )
           and  depkod2-matrah-hesap not = spaces
             if ara-bos not = 1 then
              initialize borc-dep-rec,
              move depkod-matrah-hesap   to borc-dep-hesap
              if depkod-matrah-ba = "B"
                    move "A"   to borc-dep-ba
                  else
                       move "B"   to borc-dep-ba
              end-if
              move depkod-matrah-hesap  to borc-dep-hesap
                 if ref-var = 1
                     move ref to borc-dep-ref
                 end-if
                  move "K" to borc-dep-kredi
                 read borc-dep no lock invalid continue,
                  end-read,
                       compute borc-dep-tutar rounded = borc-dep-tutar + 
                       fatdetay-fatura-matrah
                       move "Acenta faturalari Geregi" to borc-dep-aciklama
                      
                  write borc-dep-rec invalid rewrite borc-dep-rec,
                  end-write,
              end-if
                   initialize borc-dep-rec,
                  move depkod2-matrah-hesap   to borc-dep-hesap
                  if depkod-matrah-ba = "A"
                     move "A"   to borc-dep-ba
                  else
                     move "B"   to borc-dep-ba
                  end-if
                  move depkod2-matrah-hesap   to borc-dep-hesap
                  move  function numval(fatdetay-fat-no)         to borc-dep-fatura-no
                   if ref-var = 1
                     move ref to borc-dep-ref
                   end-if
                     move "K" to borc-dep-kredi
                  read borc-dep no lock invalid continue,
                  end-read,
                       compute borc-dep-tutar rounded = borc-dep-tutar + 
                       fatdetay-fatura-matrah
                       move fatdetay-fat-no  to borc-dep-aciklama 
                       move "Ft geregi" to borc-dep-aciklama (17:)
                      
                  write borc-dep-rec invalid rewrite borc-dep-rec,
                  end-write,
               end-if
                 if ( depkod-kdv-hesap not = spaces or ara-bos = 1 )
                    and  depkod2-kdv-hesap not = spaces
                     if ara-bos not = 1 then
                     initialize borc-dep-rec,
                    move depkod-kdv-hesap   to borc-dep-hesap
                    if depkod-matrah-ba = "B"
                       move "A"   to borc-dep-ba
                    else
                       move "B"   to borc-dep-ba
                    end-if
                    move depkod-kdv-hesap  to borc-dep-hesap
                    if ref-var = 1
                     move ref to borc-dep-ref
                   end-if
                     move "K" to borc-dep-kredi
                    read borc-dep no lock invalid continue,
                    end-read,
                         compute borc-dep-tutar rounded = 
                         borc-dep-tutar + fatdetay-fatura-kdv
                         move "Gunluk Gelirler Geregi" to borc-dep-aciklama
                    write borc-dep-rec invalid rewrite borc-dep-rec,
                    end-write,
                    end-if
                      initialize borc-dep-rec,
                    move depkod2-kdv-hesap   to borc-dep-hesap
                    if depkod-matrah-ba = "A"
                       move "A"   to borc-dep-ba
                    else
                       move "B"   to borc-dep-ba
                    end-if
                    move depkod2-kdv-hesap   to borc-dep-hesap
                    move  function numval(fatdetay-fat-no)        to borc-dep-fatura-no
                     if ref-var = 1
                        move ref to borc-dep-ref
                     end-if
                       move "K" to borc-dep-kredi
                    read borc-dep no lock invalid continue,
                    end-read,
                         compute borc-dep-tutar rounded = 
                         borc-dep-tutar + fatdetay-fatura-kdv
                         move fatdetay-fat-no  to borc-dep-aciklama 
                         move "Ft geregi" to borc-dep-aciklama (17:)
                        
                    write borc-dep-rec invalid rewrite borc-dep-rec,
                    end-write,
                 end-if  .

 kredi-bul.
******usendim ilk depkod cityledger a kalkan departmandir dedim  
      initialize depkod-rec
      start depkod   key >  depkod-anah
       invalid continue 
       not invalid 
       read depkod  next  no lock
       end-read
      end-start
      move depkod-anah to depkod2-anah
      read depkod2 no lock invalid continue end-read
    




    open i-o  acenta.
    initialize fatdetay-rec.
    move tarih        to fatdetay-fat-tar.
   
    start fatdetay key not < fatdetay-anah invalid continue,
        not invalid,

       
        perform with test after until fs-fatdetay = "10",
            read fatdetay next no lock end move "10" to fs-fatdetay,
                not end,
                if fatdetay-fat-tar > tarih,
                          move "10" to fs-fatdetay
                          exit perform 
                end-if,
*               if function  numval (fatdetay-fat-no) = 990980 then stop "  " end-if
                if fatdetay-depkod = "C/L" then  
                      move fatdetay-folio to konuk-folio
                     read konuk no lock invalid 
                        exit perform cycle
                        not invalid
                       if konuk-fat-no not = function numval (fatdetay-fat-no) then 
                        exit perform cycle
                       end-if
                     end-read
                       initialize takas-acenta-rec,
                       initialize konuk-rec,
                       move fatdetay-folio    to konuk-folio,
                           read konuk no lock invalid 
                                move spaces to konuk-adi konuk-soyadi,
                           end-read,
                                if ref-var = 1 then 
                                  move xkonum-ref(konuk-fiyat-konumu) to sat-ref
                       
                                 if xkonum-ref(konuk-oda-konumu) not = ref then 
                                         exit perform cycle
                                     end-if

                                end-if 
                           initialize kur-rec takas-acenta-rec acenta-rec
                           move konuk-acenta    to takas-acenta-kodu 
                           move takas-acenta-kodu   to acenta-kodu

                          read acenta no lock invalid 
                               continue

                          end-read
                          
                           move konuk-banka      to  takas-acenta-banka
                           move konuk-doviz      to  takas-acenta-doviz
************************************   EARLY BOOK            
                             move konuk-gel-tar to takas-acenta-gel-tar
                             if konuk-eb = "E" or "1" then 
                                  move konuk-eb      to takas-acenta-eb
                               end-if
*                            move konuk-pazar   to takas-acenta-pazar
************************************ 
                                      
*                           if acenta-detay-mahsup = "E" then
*                               move konuk-odano to takas-acenta-odano
*                           end-if
                            move  function numval(fatdetay-fat-no)  to takas-acenta-fatura-no  
                           if ref-var = 1
                             move sat-ref to takas-acenta-ref
                           end-if
                           read takas-acenta no lock invalid continue
                           end-read
                            if konuk-fat-no > 0 then  
                            move konuk-folio to takas-acenta-folno

                            end-if,
                           compute takas-acenta-tl-tutar rounded =  
                                   takas-acenta-tl-tutar + fatdetay-fatura-toplam
                              if konuk-kur-degeri = 0 then 
                                   move 1 to konuk-kur-degeri  
                               end-if
                               perform kacgun-bul
                             compute takas-acenta-dv-tutar rounded =  
                                   takas-acenta-dv-tutar + fatdetay-fatura-toplamdv   
                              
                              move konuk-kur-degeri to takas-acenta-doviz-kuru doviz-alis
                           write takas-acenta-rec invalid
                                 rewrite takas-acenta-rec end-rewrite
                           end-write,
                           perform kredi-karsilik
                end-if
            end-read,
        end-perform,
    end-start.
    

   


    move spaces to evet-hayir.
    initialize takas-acenta-rec.

    start takas-acenta key not < takas-acenta-anah invalid continue,
        not invalid,

        move spaces to evet-hayir,
        perform with test after until evet,
            read takas-acenta next no lock end move "E" to evet-hayir,
                not end,
                   initialize alac-dep-rec,
                          modify lb-1, title = takas-acenta-kodu
                   move takas-acenta-kodu   to acenta-kodu
                   read acenta no lock invalid 
              
                               display message box 
                                "Tanimsiz Acenta",
                                icon mb_error_icon
                                title "Hata"
                                move 1 to enable-1 
                                move 0 to enable-2
                                display form1
*/-----------------------------\*  
*/---------DIL AYARLA----------\*    
*/-----------------------------\*    
                                perform dil-ayarla-proc
*/-----------------------------\*         
                                move 4 to accept-control
                                move 4 to control-id
                                exit paragraph
                                close kasa-borc-dep kasa-alac-dep borc-dep alac-dep takas-acenta
                                delete file kasa-borc-dep kasa-alac-dep borc-dep alac-dep takas-acenta
                   not invalid
                        initialize alac-dep-rec
                         move "A"   to alac-dep-ba
                        move acenta-muhno       to alac-dep-hesap
                        move takas-acenta-banka to alac-dep-banka
                        move takas-acenta-doviz to alac-dep-doviz
                        move takas-acenta-kodu  to alac-dep-acenno    | Ayni hesap noya iki acenta atilirsa - mami
                        if acenta-detay-mahsup = "E" then
                           move takas-acenta-odano to alac-dep-odano
                        end-if
                       
************************************   EARLY BOOK            
*                        move takas-acenta-gel-tar to alac-dep-gel-tar
                        move takas-acenta-eb      to alac-dep-eb
*                        move takas-acenta-pazar   to alac-dep-pazar

************************************                           
                        move takas-acenta-folno    to konuk-folio,
                           read konuk no lock invalid 
                                move spaces to konuk-adi konuk-soyadi,
                           end-read
                        if acenta-muhno2  not = spaces then 
                           move "A" to alac-dep-ara

                        end-if
                          move takas-acenta-fatura-no   to alac-dep-fatura-no
                        if ref-var = 1 then 
                            move ref to alac-dep-ref
                        end-if
                          move "K" to alac-dep-kredi
                        read alac-dep no lock invalid
                           move alac-dep-fatura-no(3:)  to alac-dep-aciklama
                           move " Ft"         to alac-dep-aciklama(7:3) 
                        end-read

                        compute alac-dep-tutar-tl rounded =  
                                alac-dep-tutar-tl + takas-acenta-tl-tutar
                        compute alac-dep-tutar-dv rounded =  
                                alac-dep-tutar-dv + takas-acenta-dv-tutar
                 
                        
                        move takas-acenta-gel-tar(7:2) to alac-dep-aciklama(11:2)                        
                        move "/" to alac-dep-aciklama(13:1)                        
                        move takas-acenta-gel-tar(5:2) to alac-dep-aciklama(14:2)                        
                        move "-" to alac-dep-aciklama(16:01)
                        move gun to alac-dep-aciklama(17:2)
                        move "/" to alac-dep-aciklama(19:1)
                        move ay  to alac-dep-aciklama(20:2)
                        move acenta-adi to alac-dep-aciklama(23:10)
                        if alac-dep-eb = "E" then 
                                move "E/B" to alac-dep-aciklama(35:3)       
                        end-if
                        if acenta-detay-mahsup = "E" then
                        initialize alac-dep-aciklama
                        move gun to alac-dep-aciklama (11:2)
                        move "/" to alac-dep-aciklama(13:1)
                        move ay  to alac-dep-aciklama(14:2)
*                        move "Cikislar-" to alac-dep-aciklama(17:)
                        move acenta-kodu to alac-dep-aciklama(17:4)
                        move takas-acenta-odano to alac-dep-aciklama(22:4),
                        move konuk-adi        to alac-dep-aciklama(27:7)
                        move konuk-soyadi     to alac-dep-aciklama(35:)
                          end-if 
                        move  takas-acenta-doviz-kuru to alac-dep-doviz-kuru
                       
                        if ara-bos not = 1 then
                        write alac-dep-rec invalid
                              rewrite alac-dep-rec end-rewrite
                        end-write,
                        end-if
                        initialize alac-dep-rec
                        move "B"   to alac-dep-ba
                        move acenta-muhno2       to alac-dep-hesap
                        move takas-acenta-banka to alac-dep-banka
                        move takas-acenta-doviz to alac-dep-doviz
                        move takas-acenta-kodu  to alac-dep-acenno    | Ayni hesap noya iki acenta atilirsa - mami
                        if acenta-detay-mahsup = "E" then
                           move takas-acenta-odano to alac-dep-odano
                        end-if

************************************   EARLY BOOK            
*                        move takas-acenta-gel-tar to alac-dep-gel-tar
                        move takas-acenta-eb      to alac-dep-eb
*                        move takas-acenta-pazar   to alac-dep-pazar

************************************                           
                        move takas-acenta-folno    to konuk-folio,
                           read konuk no lock invalid 
                                move spaces to konuk-adi konuk-soyadi,
                           end-read

                        move takas-acenta-fatura-no   to alac-dep-fatura-no
                        if ref-var = 1 then
                            move xkonum-ref(konuk-fiyat-konumu) to sat-ref
                       
                            move sat-ref to alac-dep-ref
                        end-if
                         move "K" to alac-dep-kredi 
                        read alac-dep no lock invalid
*                        
                           move takas-acenta-fatura-no(3:)  to alac-dep-aciklama
                        
                           move " Ft"         to alac-dep-aciklama(7:3) 
                        end-read

                        compute alac-dep-tutar-tl rounded =  
                                alac-dep-tutar-tl + takas-acenta-tl-tutar
                        compute alac-dep-tutar-dv rounded =  
                                alac-dep-tutar-dv + takas-acenta-dv-tutar
                 
                        
                        move takas-acenta-gel-tar(7:2) to alac-dep-aciklama(11:2)                        
                        move "/" to alac-dep-aciklama(13:1)                        
                        move takas-acenta-gel-tar(5:2) to alac-dep-aciklama(14:2)                        
                        move "-" to alac-dep-aciklama(16:01)
                        move gun to alac-dep-aciklama(17:2)
                        move "/" to alac-dep-aciklama(19:1)
                        move ay  to alac-dep-aciklama(20:2)
                        move acenta-adi to alac-dep-aciklama(23:10)
                        if alac-dep-eb = "E" then 
                                move "E/B" to alac-dep-aciklama(35:3)       
                        end-if
                        if acenta-detay-mahsup = "E" then
                        initialize alac-dep-aciklama
                        move gun to alac-dep-aciklama (11:2)
                        move "/" to alac-dep-aciklama(13:1)
                        move ay  to alac-dep-aciklama(14:2)
*                        move "Cikislar-" to alac-dep-aciklama(17:)
                        move acenta-kodu to alac-dep-aciklama(17:4)
                        move takas-acenta-odano to alac-dep-aciklama(22:4),
                        move konuk-adi        to alac-dep-aciklama(27:7)
                        move konuk-soyadi     to alac-dep-aciklama(35:)
                          end-if 
                        move  takas-acenta-doviz-kuru to alac-dep-doviz-kuru
                           
                        write alac-dep-rec invalid
                              rewrite alac-dep-rec end-rewrite
                        end-write,
                        
                        if takas-acenta-eb = "E" and acenta-av-oran > 0 
                          AND ACENTA-AVANO NOT = SPACES then 
                             move " " to alac-dep-kredi 
                           perform  acenta-avans-yaz
                        end-if
                   end-read,
            end-read,
        end-perform,
    end-start.
    close acenta .
    


*
 acenta-avans-yaz.
          
          if alac-dep-ba = "B"
              move "A"   to alac-dep-ba
             else
              move "B"   to alac-dep-ba
          end-if
          move "C" to alac-dep-corr
*            initialize  alac-dep-fatura-no
          read alac-dep no lock invalid
              initialize alac-dep-tutar-tl   
               alac-dep-tutar-dv   
               alac-dep-doviz-kuru 
               alac-dep-aciklama   
              move konuk-fat-no to alac-dep-aciklama 
              move " Ft"    to alac-dep-aciklama(7:3)
          end-read
          
          compute alac-dep-tutar-tl rounded =  alac-dep-tutar-tl + 
                                ( takas-acenta-tl-tutar * ((acenta-av-oran) / 100))
          compute alac-dep-tutar-dv rounded =  alac-dep-tutar-dv + 
                                ( takas-acenta-dv-tutar * (( acenta-av-oran) / 100))
                        
*********************************                        
         move takas-acenta-gel-tar(7:2) to alac-dep-aciklama(11:2)                        
                        move "/" to alac-dep-aciklama(13:1)                        
                        move takas-acenta-gel-tar(5:2) to alac-dep-aciklama(14:2)                        
                        move "-" to alac-dep-aciklama(16:01)
                        move gun to alac-dep-aciklama(17:2)
                        move "/" to alac-dep-aciklama(19:1)
                        move ay  to alac-dep-aciklama(20:2)
                        move acenta-adi to alac-dep-aciklama(23:10)
                        
                       move "AVANSI" to alac-dep-aciklama(35:5)       
                        
*                        move alac-dep-pazar        to alac-dep-aciklama(35:2)
*                        if alac-dep-pazar not = spaces
*                                move "Knk" to alac-dep-aciklama(38:) 
*                                else 
*                                move "Extra Harcamalari" to alac-dep-aciklama(22:)       
*                        end-if
***********************************                                 
        move  takas-acenta-doviz-kuru to alac-dep-doviz-kuru
          write alac-dep-rec invalid
               rewrite alac-dep-rec end-rewrite
         end-write,
        
         
         .
          if alac-dep-ba = "B"
              move "A"   to alac-dep-ba
             else
              move "B"   to alac-dep-ba
          end-if
          move acenta-avano       to alac-dep-hesap
           move "C" to alac-dep-corr
          read alac-dep no lock invalid
               initialize alac-dep-tutar-tl   
               alac-dep-tutar-dv   
               alac-dep-doviz-kuru 
               alac-dep-aciklama   
             
              move konuk-fat-no to alac-dep-aciklama 
              move " Ft"    to alac-dep-aciklama(7:3)
          end-read
          
          compute alac-dep-tutar-tl rounded =  alac-dep-tutar-tl + 
                                ( takas-acenta-tl-tutar * ((acenta-av-oran) / 100))
          compute alac-dep-tutar-dv rounded =  alac-dep-tutar-dv + 
                                ( takas-acenta-dv-tutar * (( acenta-av-oran) / 100))
                        
*********************************                        
         move takas-acenta-gel-tar(7:2) to alac-dep-aciklama(11:2)                        
                        move "/" to alac-dep-aciklama(13:1)                        
                        move takas-acenta-gel-tar(5:2) to alac-dep-aciklama(14:2)                        
                        move "-" to alac-dep-aciklama(16:01)
                        move gun to alac-dep-aciklama(17:2)
                        move "/" to alac-dep-aciklama(19:1)
                        move ay  to alac-dep-aciklama(20:2)
                        move acenta-adi to alac-dep-aciklama(23:10)
                        
                       move "AVANSI" to alac-dep-aciklama(35:5)       
                        
*                        move alac-dep-pazar        to alac-dep-aciklama(35:2)
*                        if alac-dep-pazar not = spaces
*                                move "Knk" to alac-dep-aciklama(38:) 
*                                else 
*                                move "Extra Harcamalari" to alac-dep-aciklama(22:)       
*                        end-if
***********************************                                 
        move  takas-acenta-doviz-kuru to alac-dep-doviz-kuru
          write alac-dep-rec invalid
               rewrite alac-dep-rec end-rewrite
         end-write,

    .   
*
     .
*
 acc-ref-Bef-Procedure.
    initialize nereden.
*
 acuserve-adres-aktar.

    move muha-sirketi of genel-rec to CARI-DOSYA-adres         
                         ISLENEN-DOSYA-adres      
                         HESAP-DOSYA-adres        
                         MAHSUP-DOSYA-adres       
                         genelfis-DOSYA-adres     
                         REFERANS-DOSYA-adres     
                         mgenel-DOSYA-adres       
                         genelfis-DOSYA-adres     
                         move "muha" to genelfis-DOSYA(16:4)
            

    move all low-values to      
                           CARI-ACUSERVE-DOSYA       
                           ISLENEN-ACUSERVE-DOSYA    
                           HESAP-ACUSERVE-DOSYA      
                           MAHSUP-ACUSERVE-DOSYA     
                           genelfis-ACUSERVE-DOSYA   
                           REFERANS-ACUSERVE-DOSYA   
                           Mgenel-ACUSERVE-DOSYA     
                           genelfis-ACUSERVE-DOSYA  
                           ip-no.


    inspect genel-muha-uzak-ip 
            replacing trailing spaces by low-values.

    if genel-muha-uzak-ip <> low-values
       move all low-values to ip-no
       string ip-no,
              "@" delimited by low-values
              genel-muha-uzak-ip delimited by low-values
              ":" delimited by low-values
              into ip-no
    end-if

    string mgenel-acuserve-dosya,
           ip-no                        delimited by low-values
           mgenel-dosya                    delimited by low-values
           into mgenel-acuserve-dosya.
    string genelfis-acuserve-dosya,
           ip-no                        delimited by low-values
           genelfis-dosya                 delimited by low-values
           into genelfis-acuserve-dosya.

    
    string hesap-acuserve-dosya,
           ip-no                        delimited by low-values
           hesap-dosya                 delimited by low-values
           into hesap-acuserve-dosya.
    string mahsup-acuserve-dosya,
           ip-no                        delimited by low-values
           mahsup-dosya                 delimited by low-values
           into mahsup-acuserve-dosya.
    string cari-acuserve-dosya,
           ip-no                        delimited by low-values
           cari-dosya                 delimited by low-values
           into cari-acuserve-dosya.
    string islenen-acuserve-dosya,
           ip-no                        delimited by low-values
           islenen-dosya               delimited by low-values
           into islenen-acuserve-dosya.
    string referans-acuserve-dosya,
           ip-no                        delimited by low-values
           referans-dosya                delimited by low-values
           into referans-acuserve-dosya.
    
    inspect cari-acuserve-dosya        replacing  all spaces by low-values
    inspect islenen-acuserve-dosya     replacing  all spaces by low-values
    inspect hesap-acuserve-dosya       replacing  all spaces by low-values
    inspect mahsup-acuserve-dosya      replacing  all spaces by low-values
    inspect genelfis-acuserve-dosya    replacing  all spaces by low-values
    inspect referans-acuserve-dosya    replacing  all spaces by low-values
    inspect mgenel-acuserve-dosya      replacing  all spaces by low-values
    inspect genelfis-acuserve-dosya    replacing  all spaces by low-values.
*
 Form1-Aft-Initdata.
*/-----------------------------\*  
*/---------DIL AYARLA----------\*    
*/-----------------------------\*    
     perform dil-ayarla-proc.
*/-----------------------------\*         
     .
*
 netsise-at.
     open input romhrk exthrk fatura folref depkod depkod2 musteri .
     open output takas-nfatura close takas-nfatura open i-o takas-nfatura
     move ilk-tarih to fatura-tarihi
     start fatura key > fatura-anah1 invalid
        continue
        not invalid
          perform until fs-fatura = "10"
               read fatura next no lock end
                   move "10" to fs-fatura
                   not end
                   if fatura-tarihi > son-tarih 
                      move "10" to fs-fatura
                      else

                      perform fatlari-al
            

                  end-if
               end-read

          end-perform
     end-start .
  
*
 fatlari-al.
    initialize romhrk-rec exthrk-rec    folref-rec
    move fatura-folio to romhrk-folio  folref-folio
    read folref no lock invalid
      continue
       not invalid
    end-read
    start romhrk key > romhrk-anah1 invalid continue
       not invalid
         perform until fs-romhrk = "10"
             read romhrk next no lock 
                end move "10" to fs-romhrk 
                not end
                 if romhrk-folio not = fatura-folio 
                         move "10" to fs-romhrk
                      else
                      perform hrk-at
                 end-if
             end-read
         end-perform
     end-start.
    start exthrk key > exthrk-anah1 invalid continue
       not invalid
         perform until fs-exthrk = "10"
             read exthrk next no lock 
                end move "10" to fs-exthrk 
                not end
                 if exthrk-folio not = fatura-folio 
                         move "10" to fs-exthrk
                      else
                       move exthrk-rec to romhrk-rec
                      perform hrk-at
                 end-if
             end-read
         end-perform
     end-start.


 hrk-at.
  
          if ROMHRK-FATURA-NO = fatura-no  then
            move romhrk-anah to hrk2-ANAH
            read hrk2 no lock invalid
              continue
            end-read
             move romhrk-depkod to depkod-anah
                read depkod no lock invalid
                  continue
                   not invalid
                    if depkod-turu = 2 and depkod-ba = "A" then 
                        move ROMHRK-CORR-DEPKOD to depkod-anah
                        read depkod no lock invalid exit paragraph
                        end-read
                         move -1 to carpan 
                         else
                         move 1 to carpan 
                     end-if
                     if DEPKOD-FATURA-TAKIP = "E" then
                           move fatura-tarihi    to  takas-nfatura-tarih        
                           move fatura-no       to  takas-nfatura-fatno      
                           move romhrk-depkod   to takas-depkod        
                           move romhrk-islem    to  takas-islem         
                        
                           move DEPKOD2-MATRAH-HESAP   to takas-nfatura-hesap        
            
                         
                           compute takas-nfatura-tl-tutar rounded =  
                                      ROMHRK-TL-TUTAR   * carpan
                           move depkod-kdv           to  takas-nfatura-kdv-oran    
                           move hrk2-ger-doviz          to takas-nfatura-doviz 
                           compute takas-nfatura-dov-tutar rounded =  
                                     hrk2-ger-DV-TUTAR    * carpan
                             
*****   03 takas-nfatura-aciklama      pic 9(9)v99.
     

                           move romhrk-ref to folref-ref
                           read folref no lock invalid 
                              initialize folref-profil-anah
                              not invalid
                              if folref-ode = "1" then 
                               initialize musteri-rec
*                                  move folref-profil-anah to m-profil |firat m-profil bos gorunuyor.. 17/08/2020
                                  move folref-profil-sirket to musteri-sirket 
                                  move folref-profil-no     to musteri-no
                                  read musteri no lock invalid
                                      continue
                                      not invalid

                                      move musteri-muhasebe-kodu to  takas-nfatura-kapa      
                                 end-read
                               end-if
                           end-read
                         write takas-nfatura-rec invalid stop " " end-write
                      end-if
                  end-read
        end-if
      .

 
