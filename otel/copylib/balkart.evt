* balkart.evt
* balkart.evt is generated from D:\asya\acugt.ytl\otel\balkart.Psf
* This is a generated file. DO NOT modify this file directly.


 Form1-Event-Proc.
     .

 Form1-Exception-Proc.
     PERFORM Form1-Ex-Other
     .
***   start event editor code   ***
*
 Form1-Bef-Create.
    perform adresleri-tasi.
    open input genel depkod
    move 1 to genel-anahtar
    read genel no lock invalid continue
         not invalid continue
    end-read
**         move donem-basi of genel-rec to kv-gecis-tar
    move "100" to room-dep-100
    move  ONKPARA-oda-post-dep to depkod-anah
    read depkod no lock invalid continue
    not invalid 
      move depkod-anah to room-dep-100

    end-read

    close genel depkod

    if hangi-ref-secildi > 0
            move hangi-ref-secildi  to rapor-ref
    end-if.    
    
     .
*
 Form1-Aft-Initdata.
    move tarih-tasi to rapor-tarih.
    display acc-01 acc-02 acc-03.
    move 4 to accept-control
    move 4 to control-id.
*/-----------------------------\*  
*/---------DIL AYARLA----------\*    
*/-----------------------------\*    
     perform dil-ayarla-proc.
*/-----------------------------\*    
* 
 referans-kontrol.
     initialize kodlar02-rec  
     move "r"          to kodlar02-tipi
     start kodlar02 key > kodlar02-anah invalid 
           continue
     not invalid 
     perform until fs-kodlar02 = "10" 
     read kodlar02 next no lock end move "10" to fs-kodlar02
     not end 
         if kodlar02-tipi not = "r" 
            exit perform 
         end-if

         if function numval(kodlar02-ref-dahil(1:1)) = rapor-ref 
            move rapor-ref       to tmp-rap-ref
            move function numval(kodlar02-kodu)
                                 to rapor-ref 
            perform takasr-aktar thru takasr-aktar-exit
            move tmp-rap-ref     to rapor-ref
            move 1 to sanal-ref 
         end-if
            
      end-read
      end-perform
      end-start
      . 
*
 Form1-Ex-Other.
    evaluate key-status
        when 2
             initialize fiyat-ref-external
             move rapor-ref to oda-ref-external
             open input depkod depkod2
             if rapor-ref = 0 then 
                perform takas-aktar thru takas-aktar-exit
             else
*                move 0 to sanal-ref
*                open input kodlar02 
*                initialize kodlar02-rec 
*                move "r"          to kodlar02-tipi
*                move "0"          to kodlar02-kodu
*                move rapor-ref    to kodlar02-kodu(2:1)
*                read kodlar02 no lock invalid
*                     perform referans-kontrol
*                not invalid 
                     perform takasr-aktar thru takasr-aktar-exit
*                end-read 
*                close kodlar02
             end-if
             close depkod2
             initialize takas-rec
             start takas key not < takas-satir invalid
*                    initialize mesaj-link
*                    move 04 to mesaj-no
*                    perform mesaj-ver
*                    close takas depkod takaskdv
*                    exit paragraph
                    move "10" to fs-takas
             end-start

             open i-o genelfis
             move 1 to genelfis-anahtar
             read genelfis no lock invalid
                  accept print-no from time
             not invalid
                 add 1 to print-no
                 rewrite genelfis-rec end-rewrite
             end-read
             close genelfis
**************************
     initialize dokumer-rec dokumer-anah dokumer-ozellikler-rec
                dokumer-dosya

     set  dokumer-asya-set to true
     move print-no         to dokumer-dosya-adi
     open output dokumer
*/WINDOW TITLE
     initialize dokumer-rec detay
     move "W"                  to det-dokumer-20(1:)
     move "ONKASA BALANS KARTI"   to det-filler
     write dokumer-rec from detay
*/ BASLIKLAR
     initialize dokumer-rec detay
     move "1"            to det-dokumer-20(10:1)
     move "B"            to det-dokumer-20(1:1)
     move "ONKASA BALANS KARTI"   to det-filler
     move "Tarih..:"     to det-filler(41:10)
     move gun            to det-filler(51:02)
     move "/"            to det-filler(53:01)
     move ay             to det-filler(54:02)
     move "/"            to det-filler(56:01)
     move yil            to det-filler(57:04)
     write dokumer-rec from detay

     initialize dokumer-rec detay
     move "1"            to det-dokumer-20(10:1)
     move "B"            to det-dokumer-20(1:1)
     evaluate rapor-ref
     when 1
*         move "KAMELYA"  to det-filler(1:10)
     when 2
*         move "SELIN"    to det-filler(1:10)
     when 3
*         move "FULYA"  to det-filler(1:10)
     end-evaluate

     write dokumer-rec from detay

     initialize dokumer-rec detay
     move "B"                  to det-dokumer-20(1:1)
     write dokumer-rec from detay

     initialize dokumer-rec detay
     move "1"          to det-dokumer-20(10:1)
     move "B"                  to det-dokumer-20(1:1)
     move "  B O R C          "   to det-filler(20:)
     move " A L A C A K       "   to det-filler(75:)
     write dokumer-rec from detay
     initialize dokumer-rec detay


*/ DOKUMER OZELLIKLER-REC
     initialize dokumer-rec detay
     move "O" to det-dokumer-20(1:)
     move "E" to dokumer-oto-sayfa-basi
     move 56  to dokumer-oto-sayfa-satir
     move "|" to dokumer-detay-kolon-ayirici
     move "LLRRRRRRRLLRR" to dokumer-align-occ
     move dokumer-ozellikler-rec     to det-filler
     write dokumer-rec from detay
*/ BASLIKLAR  
           
     initialize dokumer-rec detay 
     move "1"          to det-dokumer-20(10:1)
     move "D1"                             to det-dokumer-20(1:2) 
     move "Kod"                            to det-k1  
     move "Departman"                      to det-1
     move "TL. Tutar"                      to det-2
     move "TL. Corr."                      to det-20
     move "TL - Corr"                      to det-23
     move "TL. KDV  "                      to det-21
     move "TL. KV  "                       to det-211
     move "TL.Matrah"                      to det-22
     move "DV. Tutar"                      to det-3
     move "Kod"                            to det-k4  
     move "Departman"                      to det-4
     move "TL. Tutar"                      to det-5
     move "DV. Tutar"                      to det-6
     move "|" to fil-1 fil-k1 fil-k4 fil-2 fil-211  fil-21 fil-23 fil-22 fil-3 fil-4 fil-5 fil-6 fil-20
     write dokumer-rec from detay

     initialize dokumer-rec detay
     move "D2"           to det-dokumer-20(1:2)
     move "-"            to det-dokumer-20(5:1)
     move all "-" to det-1 det-k1 det-k4 det-2 det-21 det-211 det-22 det-3 det-23 det-4 det-5 det-6 det-20
     move "+" to fil-1 fil-2 fil-21 fil-211 fil-k1 fil-k4  fil-23 fil-22  fil-3 fil-4 fil-5 fil-6 fil-20
     write dokumer-rec from detay
*********************************
             
              perform  until fs-takas = "10"
                    read takas next no lock end move "10" to fs-takas
                      not at end

                      initialize dokumer-rec detay
                      perform liste-detay-ata
                      write dokumer-rec from detay

                    end-read
              end-perform
              perform liste-toplam
 
              close dokumer takas takaskdv depkod
              call  dokumer-prog on exception
                   perform callerr-proc
              not on exception
                   cancel dokumer-prog
              end-call
              delete file dokumer takas takaskdv
    end-evaluate.
     .
 takas-aktar.
   
    perform takas-dosya-ac.
    initialize takas-rec toplam toplam-kdv-8 toplam-kdv-18
     toplam-matrah-8 toplam-matrah-18.
    open input onkasa.
    initialize onkasa-rec borc-satir alac-satir.
    move rapor-tarih to onkasa-tarih.

    start onkasa key not < onkasa-anah invalid continue,
        not invalid,
        move spaces to evet-hayir,
        perform with test after until evet,
        read onkasa next no lock end move "E" to evet-hayir,
            not end,

            if onkasa-tarih > rapor-tarih,
                      move "E" to evet-hayir,
            end-if,

*/CORRECTION
            if cb-corr-hesaplansin-value = 0
               initialize onkasa-corr-tutar-tl
                          onkasa-corr-tutar-dv
            end-if
*/CORRECTION


*            perform kdv-ayir thru kdv-ayir-exit,
           
            if onkasa-tarih = rapor-tarih,
                initialize depkod-rec,   initialize depkod2-rec 
                move onkasa-dep to depkod-kodu depkod2-kodu,
                read depkod no lock invalid 
                    continue,
                not invalid,
*/CORRECTION                                
                    read depkod2 no lock invalid 
                        continue
                    end-read
                    if cb-corr-hesaplansin-value = 1
                       if depkod-turu = 2
                          exit perform cycle
                       end-if
                    end-if
*/CORRECTION       

                    if onkasa-tarih >= kv-gecis-tar and depkod2-kv-uygula =1  then 

                      move kv-orani to kv-or
                       else
                        initialize  kv-or
                     end-if



                  
                    evaluate true
                    when depkod-ba = "B" and  ( DEPKOD-TURU not = 3 ) 
                    
                         add 1 to borc-satir,
                         initialize takas-rec,
                         move borc-satir       to takas-satir,
                         read takas no lock invalid continue,end-read,
                         move onkasa-dep       to takas-borc-dep,
                         
                         compute takas-borc-tl-tutar = onkasa-tutar-tl

                         compute takas-borc-tl-matrah rounded =
                                 ((onkasa-tutar-tl - onkasa-corr-tutar-tl - onkasa-matrah-disi) / ((100 + depkod-kdv + kv-or) / 100)) + 
                                 onkasa-matrah-disi
                          compute takas-borc-tl-kdv rounded =  (takas-borc-tl-matrah - onkasa-matrah-disi)   * depkod-kdv / 100

                           compute takas-borc-tl-kv rounded =  (takas-borc-tl-matrah - onkasa-matrah-disi)   * kv-or / 100

                           compute  takas-borc-tl-matrah  = onkasa-tutar-tl - onkasa-corr-tutar-tl -  takas-borc-tl-kdv  - takas-borc-tl-kv
                         


                         if DEPKOD-FATURA-TAKIP = "E" then
                            initialize takaskdv-rec
                            move depkod-kdv to takaskdv-anah 
                            read takaskdv no lock invalid continue
                            end-read
                            add  takas-borc-tl-matrah to takaskdv-matrah
                            add takas-borc-tl-kdv     to  takaskdv-kdv
                             write takaskdv-rec invalid rewrite takaskdv-rec end-write
                         end-if
                         if DEPKOD-FATURA-TAKIP  not = "E" then
                            initialize takas-borc-tl-matrah takas-borc-tl-kdv 
                         end-if 
                         if depkod-kdv = 8
                            add  takas-borc-tl-kdv    to toplam-kdv-8 
                            add  takas-borc-tl-matrah to toplam-matrah-8 

                         end-if 
                         if depkod-kdv = 18
                            add  takas-borc-tl-kdv    to toplam-kdv-18 
                            add  takas-borc-tl-matrah to toplam-matrah-18  
                         end-if 
                         compute takas-borc-corr-tutar = takas-borc-corr-tutar + onkasa-corr-tutar-tl  

                         compute takas-borc-dv-tutar = onkasa-tutar-dv + onkasa-corr-tutar-dv 
                   
                         compute b-tl-tutar = b-tl-tutar + onkasa-tutar-tl
                         compute b-tl-matrah = b-tl-matrah + takas-borc-tl-matrah,
                         compute b-tl-kdv = b-tl-kdv + takas-borc-tl-kdv,   
                         compute b-tl-kv = b-tl-kv + takas-borc-tl-kv,                       

                         compute b-dv-tutar = b-dv-tutar + onkasa-tutar-dv
                         compute b-tl-corr-tutar = b-tl-corr-tutar + onkasa-corr-tutar-tl
                         compute b-dv-corr-tutar = b-dv-corr-tutar + onkasa-corr-tutar-dv
                       if onkasa-dep not = room-dep-100 and br-ayir = 1  and Depkod2-alt-kate = "01" 
                           subtract 1 from borc-satir,
                            else
                              write takas-rec invalid rewrite takas-rec,end-write,
                        end-if
                       
                         if  onkasa-dep = room-dep-100 and br-ayir = 1 
                                       compute b-tl-corr-tutar = b-tl-corr-tutar - onkasa-corr-tutar-tl
                                        compute b-tl-tutar = b-tl-tutar - onkasa-corr-tutar-tl
                                       move rapor-tarih        to     link-ilk-tarih  
                                       move rapor-tarih        to  link-son-tarih   
                                       if onkpara-referans-var = 1 and rapor-ref > 0
                                          move rapor-ref       to link-referans 
                                       end-if 
                                       move 0 to link-tutar
                                         call "/asya/ytl/obj/otel/mpanbrh.asy" 
                                           using link-ilk-tarih link-son-tarih link-dov link-tutar link-occ link-kdvsiz link-referans
 
                                           on exception 
                                           perform callerr-proc
                                           exit paragraph
                                           not on exception 
                                         cancel "/asya/ytl/obj/otel/mpanbrh.asy"
                                      end-call

                                            initialize takas-rec,
                                                 move borc-satir       to takas-satir,
                                                 read takas no lock invalid continue,end-read,
                                                 move room-dep-100       to takas-borc-dep,
                                                 compute takas-borc-tl-tutar = link-tutar


                                                  compute takas-borc-tl-matrah rounded =
                                 ((link-tutar - link-kdvsiz) / ((100 + depkod-kdv + kv-or) / 100)) + 
                                 onkasa-matrah-disi
                          compute takas-borc-tl-kdv rounded =  (takas-borc-tl-matrah - onkasa-matrah-disi)   * depkod-kdv / 100

                           compute takas-borc-tl-kv rounded =  (takas-borc-tl-matrah - onkasa-matrah-disi)   * kv-or / 100

                           compute  takas-borc-tl-matrah  = (link-tutar - link-kdvsiz) -  takas-borc-tl-kdv  - takas-borc-tl-kv

                                                

                                                 initialize takas-borc-corr-tutar              
                                                  write takas-rec invalid rewrite takas-rec,end-write,

                                      perform varying occ from 1 by 1 until occ > 9 
                                        if link-dep(occ) > 0 then 
                                                

                                                 add 1 to borc-satir,
                                                 initialize takas-rec,
                                                 move borc-satir       to takas-satir,
                                                 read takas no lock invalid continue,end-read,
                                                 move link-dep(occ)       to takas-borc-dep,
                                                 compute takas-borc-tl-tutar = link-dep-tutar(occ)
                                                 compute takas-borc-tl-matrah rounded =
                                                         ((link-dep-tutar(occ) - link-dep-kdvsiz(occ)) / 
                                                         ((100 + depkod-kdv) / 100)) + link-dep-kdvsiz(occ)
                                                 compute takas-borc-tl-kdv = takas-borc-tl-tutar - 
                                                               takas-borc-tl-matrah
                                                  write takas-rec invalid rewrite takas-rec,end-write,
                                       end-if
                                     end-perform                                   
                         end-if
                    when other
                         add 1 to alac-satir,
                         initialize takas-rec,
                         move alac-satir       to takas-satir,
                         if depkod-ba = "B"
                            add onkasa-tutar-tl to onkasa-corr-tutar-tl
                            initialize onkasa-tutar-tl
                            add onkasa-tutar-dv to onkasa-corr-tutar-dv
                            initialize onkasa-tutar-dv
                         end-if
                         read takas no lock invalid continue,end-read,
                         move onkasa-dep       to takas-alac-dep,
                         compute takas-alac-tl-tutar = onkasa-tutar-tl - onkasa-corr-tutar-tl

**************************************************************
                    open input genel
                    move 1 to genel-anahtar
                    read genel no lock invalid
                            continue
                    end-read
                    close genel
                                                    
                    open input kur
                    initialize kur-rec 
                    move onkasar-tarih      to kur-tarih
                    move onkpara-banka      to kur-banka 
                    move onkpara-doviz      to kur-doviz 
                    read kur no lock invalid
                               move 1 to DOVIZ-ALIS
                    end-read
                    close kur
                    
                    compute hes-dv-tutar rounded =
                    onkasa-corr-tutar-tl /  doviz-alis
************************************************************
                         compute takas-alac-dv-tutar = onkasa-tutar-dv - hes-dv-tutar  


                         write takas-rec invalid rewrite takas-rec,end-write,
                         compute a-tl-tutar = a-tl-tutar + onkasa-tutar-tl - onkasa-corr-tutar-tl,
                         compute a-dv-tutar = a-dv-tutar + onkasa-tutar-dv - hes-dv-tutar

                    end-evaluate,
                end-read,
            end-if,
        end-read,
        end-perform,
    end-start.
    close onkasa.
 takas-aktar-exit.
    exit.

*
 takasr-aktar.
*    if sanal-ref = 0
       perform takas-dosya-ac
*    end-if
    initialize takas-rec toplam.
    open input onkasar.
    initialize onkasar-rec borc-satir alac-satir.
    move rapor-tarih to onkasar-tarih.
    move rapor-ref to onkasar-ref

     


    start onkasar key not < onkasar-anah invalid continue,
        not invalid,
        move spaces to evet-hayir,
        perform with test after until evet,
        read onkasar next no lock end move "E" to evet-hayir,
            not end,

            if onkasar-tarih > rapor-tarih, 
            or onkasar-ref not = rapor-ref
                      move "E" to evet-hayir,
            end-if,


*            perform kdv-ayir thru kdv-ayir-exit,

           if onkasar-tarih = rapor-tarih,
                initialize depkod-rec,  initialize depkod2-rec 
                move onkasar-dep to depkod-kodu depkod2-anah,
                read depkod no lock invalid continue,
                    not invalid,
*/CORRECTION        
                    
                    read depkod2 no lock invalid continue
                    end-read
                    if cb-corr-hesaplansin-value = 1
                       if depkod-turu = 2
                          exit perform cycle
                       end-if
                    end-if
*/CORRECTION        

                 if onkasar-tarih >= kv-gecis-tar and depkod2-kv-uygula =1  then 

                      move kv-orani to kv-or
                       else
                        initialize  kv-or
                     end-if

                    
                    evaluate true
                    when depkod-ba = "B" and  ( DEPKOD-TURU not = 3 ) 
                         add 1 to borc-satir,
                         initialize takas-rec,
                         move borc-satir       to takas-satir,
                         read takas no lock invalid continue,end-read,
                         move onkasar-dep       to takas-borc-dep,
                         compute takas-borc-tl-tutar = onkasar-tutar-tl
                         compute takas-borc-tl-matrah rounded =
                                 (onkasar-tutar-tl - onkasar-corr-tutar-tl - onkasar-matrah-disi) /
                                 ((100 + depkod-kdv) / 100)
                         compute takas-borc-tl-kdv = takas-borc-tl-tutar - 
                         onkasar-corr-tutar-tl - 
                                       takas-borc-tl-matrah

                         if DEPKOD-FATURA-TAKIP = "E" then
                         
                            initialize takaskdv-rec
                            move depkod-kdv to takaskdv-anah 
                            read takaskdv no lock invalid continue
                            end-read
                            add  takas-borc-tl-matrah to takaskdv-matrah
                            add takas-borc-tl-kdv     to  takaskdv-kdv
                             write takaskdv-rec invalid rewrite takaskdv-rec end-write
                         end-if
                         if depkod-kdv = 0
                            initialize takas-borc-tl-matrah takas-borc-tl-kdv 
                         end-if 
                         if depkod-kdv = 8
                            add  takas-borc-tl-kdv    to toplam-kdv-8 
                            add  takas-borc-tl-matrah to toplam-matrah-8 

                         end-if 
                         if depkod-kdv = 18
                            add  takas-borc-tl-kdv    to toplam-kdv-18 
                            add  takas-borc-tl-matrah to toplam-matrah-18  
                         end-if 
                         compute takas-borc-corr-tutar = takas-borc-corr-tutar + 
                               onkasar-corr-tutar-tl
                         compute takas-borc-dv-tutar = onkasar-tutar-dv + 
                               onkasar-corr-tutar-dv 
                       
                         compute b-tl-tutar = b-tl-tutar + onkasar-tutar-tl
                         compute b-tl-matrah = b-tl-matrah + takas-borc-tl-matrah,
                         compute b-tl-kdv = b-tl-kdv + takas-borc-tl-kdv,  
                          compute b-tl-kv = b-tl-kv + takas-borc-tl-kv,     
                         compute b-dv-tutar = b-dv-tutar + onkasar-tutar-dv
                         compute b-tl-corr-tutar = b-tl-corr-tutar + onkasar-corr-tutar-tl
                         compute b-dv-corr-tutar = b-dv-corr-tutar + onkasar-corr-tutar-dv
                        if onkasar-dep not = room-dep-100 and br-ayir = 1  and Depkod2-alt-kate = "01" 
                           subtract 1 from borc-satir,
                            else
                              write takas-rec invalid rewrite takas-rec,end-write,
                        end-if
                       
                         if  onkasar-dep = room-dep-100 and br-ayir = 1 
                                       compute b-tl-corr-tutar = b-tl-corr-tutar - onkasar-corr-tutar-tl
                                        compute b-tl-tutar = b-tl-tutar - onkasar-corr-tutar-tl
                                       move rapor-tarih      To link-ilk-tarih  
                                       move rapor-tarih      to link-son-tarih   
                                       if onkpara-referans-var = 1 and rapor-ref > 0
                                          move rapor-ref        to link-referans
                                       end-if 
                                       move 0 to link-tutar
                                         call "/asya/ytl/obj/otel/mpanbrh.asy" 
                                           using    link-ilk-tarih   link-son-tarih  link-dov link-tutar link-occ link-kdvsiz link-referans
 
                                           on exception 
                                           perform callerr-proc
                                           exit paragraph
                                           not on exception 
                                         cancel "/asya/ytl/obj/otel/mpanbrh.asy"
                                      end-call

                                            initialize takas-rec,
                                                 move borc-satir       to takas-satir,
                                                 read takas no lock invalid continue,end-read,
                                                 move room-dep-100       to takas-borc-dep,
                                                 compute takas-borc-tl-tutar = link-tutar

                                                 compute takas-borc-tl-matrah rounded =
                                                         ((link-tutar - link-kdvsiz) / ((100 + depkod-kdv) / 100)) + link-kdvsiz

                                                 compute takas-borc-tl-kdv = takas-borc-tl-tutar - 
                                                               takas-borc-tl-matrah

                                                 initialize takas-borc-corr-tutar              
                                                  write takas-rec invalid rewrite takas-rec,end-write,

                                      perform varying occ from 1 by 1 until occ > 9 
                                        if link-dep(occ) > 0 then 
                                                      
                                                 add 1 to borc-satir,
                                                 initialize takas-rec,
                                                 move borc-satir       to takas-satir,
                                                 read takas no lock invalid continue,end-read,
                                                 move link-dep(occ)       to takas-borc-dep,
                                                 compute takas-borc-tl-tutar = link-dep-tutar(occ)
                                                 compute takas-borc-tl-matrah rounded =
                                                         ((link-dep-tutar(occ) - link-dep-kdvsiz(occ)) / 
                                                         ((100 + depkod-kdv) / 100)) + link-dep-kdvsiz(occ)
                                                 compute takas-borc-tl-kdv = takas-borc-tl-tutar - 
                                                               takas-borc-tl-matrah
                                                  write takas-rec invalid rewrite takas-rec,end-write,
                                       end-if
                                     end-perform


                         end-if

                    when other
                         add 1 to alac-satir,
                         initialize takas-rec,
                         move alac-satir       to takas-satir,
                         if depkod-ba = "B"
                            add  onkasar-tutar-tl to  onkasar-corr-tutar-tl
                            initialize onkasar-tutar-tl
                            add  onkasar-tutar-dv to  onkasar-corr-tutar-dv
                            initialize onkasar-tutar-dv

                         end-if
                         read takas no lock invalid continue,end-read,
                         move onkasar-dep       to takas-alac-dep,
                         compute takas-alac-tl-tutar = onkasar-tutar-tl - onkasar-corr-tutar-tl
                         compute takas-alac-dv-tutar = onkasar-tutar-dv - onkasar-corr-tutar-dv
                         write takas-rec invalid rewrite takas-rec,end-write,
                         compute a-tl-tutar = a-tl-tutar + onkasar-tutar-tl - onkasar-corr-tutar-tl,
                         compute a-dv-tutar = a-dv-tutar + onkasar-tutar-dv - onkasar-corr-tutar-dv

                    end-evaluate,
                end-read,
            end-if,
        end-read,
        end-perform,
    end-start.
    close onkasar.
 takasr-aktar-exit.
    exit.


*
 takas-dosya-ac.
    open i-o genelfis.
    move 1 to genelfis-anahtar.
    read genelfis no lock invalid move 1 to ekran-fis-1.
    add 1 to ekran-fis-1.

    move ekran-fis-1(2:) to takas-no takaskdv-no.
    rewrite genelfis-rec invalid write genelfis-rec.
    close genelfis.
    open output takas close takas open i-o takas with mass-update.
     open output takaskdv close takaskdv open i-o takaskdv with mass-update.
 liste-detay-ata.
    initialize dokumer-rec detay.
    move "|" to fil-1 fil-2  fil-21 fil-211 fil-22 fil-23 fil-3 fil-4 fil-5 fil-6 fil-20
    move takas-borc-dep        to det-k1
    move takas-borc-dep        to det-1 depkod-kodu.
    read depkod no lock invalid move spaces to depkod-adi.
    move depkod-adi            to det-1.
    move takas-borc-tl-tutar   to z-1    
    move z-1                   to det-2.
    if cb-corr-hesaplansin-value = 1
       move takas-borc-corr-tutar    to z-1
       move z-1                      to det-20
    end-if
    compute takas-borc-corr-dahil = takas-borc-tl-tutar - 
           takas-borc-corr-tutar 
 
    move takas-borc-corr-dahil     to z-1    
    move z-1                   to det-23.
    move takas-borc-tl-kdv     to z-1    
    move z-1                   to det-21.
     move takas-borc-tl-kv     to z-1    
    move z-1                   to det-211.
    move takas-borc-tl-matrah  to z-1    
    move z-1                   to det-22.
    move takas-borc-dv-tutar   to z-2         
    move z-2                   to det-3.
    move takas-alac-dep        to det-4 det-k4 depkod-kodu.
    read depkod no lock invalid move spaces to depkod-adi.
    move depkod-adi            to det-4.
    move takas-alac-tl-tutar   to z-1            
    move z-1                   to det-5.
    move takas-alac-dv-tutar   to z-2        
    move z-2                   to det-6.
 liste-toplam.
    initialize dokumer-rec detay
    move "-"            to det-dokumer-20(5:1)
    move all "-"  to det-1 det-2 det-k1 det-k4 det-21  det-211  det-22 det-3 det-4 det-5 det-6 det-20 det-23 
    move "+" to fil-1 fil-2  fil-21  fil-211 fil-k1 fil-k4 fil-22 fil-23 fil-3 fil-4 fil-5 fil-6 fil-20
    write dokumer-rec from detay
    initialize dokumer-rec detay
    move "A"          to det-dokumer-20(3:1)
    move 481          to det-renk1
    move "1"          to det-dokumer-20(10:1)
    move "|" to fil-1 fil-2  fil-21  fil-211 fil-k1 fil-k4 fil-22 fil-23 fil-3 fil-4 fil-5 fil-6 fil-20 
    move "Toplam  (+) :"       to det-1.
    move b-tl-tutar            to z-1.
    move z-1                   to det-2.
    move b-tl-kdv              to z-1.
    move z-1                   to det-21.
     move b-tl-kv              to z-1.
    move z-1                   to det-211.
    move b-tl-matrah           to z-1.
    move z-1                   to det-22.
    move b-tl-corr-tutar       to z-1
    move z-1                   to det-20.
    compute b-tl-corr-dahil =  b-tl-tutar - b-tl-corr-tutar 
    move b-tl-corr-dahil       to z-1
    move z-1                   to det-23.
    move b-dv-tutar            to z-2      
    move z-2                   to det-3.
    move "Toplam  (-) :"       to det-4.
    move a-tl-tutar            to z-1         
    move z-1                   to det-5.
    move a-dv-tutar            to z-2         
    move z-2                   to det-6.
    write dokumer-rec from detay.
    initialize takaskdv-rec  kdv-bitti
    start takaskdv key > takaskdv-anah invalid move 1 to kdv-bitti
    end-start
    if kdv-bitti not = 1 
    
            read takaskdv next no lock end  move 1 to kdv-bitti
            end-read    
    end-if
    initialize dokumer-rec detay
    move "A"          to det-dokumer-20(3:1)
    move 481          to det-renk1
    move "1"          to det-dokumer-20(10:1)
    move "|" to fil-1 fil-2  fil-21 fil-211 fil-k1 fil-k4 fil-22 fil-3 fil-4 fil-5 fil-6 fil-20 fil-23
 
    compute bugun-tl = b-tl-tutar - a-tl-tutar - b-tl-corr-tutar.
    compute bugun-dv = b-dv-tutar - a-dv-tutar - b-dv-corr-tutar.
    move "Bugun Toplam:"       to det-1.
    move bugun-tl              to z-1          
    move z-1                   to det-2.
     if kdv-bitti not = 1 
            
         
   
            move takaskdv-anahtar to z-kdv
            move z-kdv    to det-20(2:)
            move " KDV"              to det-20(4:)
            MOVE "%" TO det-20(1:1)
            move takaskdv-kdv            to z-1          
            move z-1                   to det-21
            move takaskdv-matrah       to z-1          
            move z-1                   to det-22
                 compute takaskdv-toplam = takaskdv-matrah + takaskdv-kdv
            move takaskdv-toplam       to z-1          
            move z-1                   to det-23
            
          read takaskdv next no lock end  move 1 to kdv-bitti
            end-read    

    end-if
    move bugun-dv              to z-2        
    move z-2                   to det-3.
    write dokumer-rec from detay.

    initialize dokumer-rec detay
    move "A"          to det-dokumer-20(3:1)
    move 481          to det-renk1
    move "1"          to det-dokumer-20(10:1)
    move "|" to fil-1 fil-2 fil-23 fil-k1 fil-k4 fil-21 fil-211 fil-22 fil-3 fil-4 fil-5 fil-6 fil-20  
    move rapor-tarih to onkasar-tarih onkasa-tarih.
    move "888"       to onkasar-dep   onkasa-dep.
    
    if  rapor-ref  = 0 
    open input onkasa
    read onkasa no lock invalid initialize onkasa-tutar-tl onkasa-tutar-dv
    end-read
    close onkasa
*    perform kdv-ayir thru kdv-ayir-exit,
    move onkasa-tutar-tl to z-1           
    move z-1             to dunden-tl
    if onkasa-tutar-tl = 0 
       move 0 to   onkasa-tutar-dv
    end-if 
    move onkasa-tutar-dv to z-2            
    move z-2             to dunden-dv
    else
    move rapor-ref to onkasar-ref
    open input onkasar
    read onkasar no lock invalid initialize onkasar-tutar-tl onkasar-tutar-dv
    end-read
    close onkasar
*    stop " "
*    perform kdv-ayir thru kdv-ayir-exit,
    move onkasar-tutar-tl to z-1           
    move z-1             to dunden-tl
    move onkasar-tutar-dv to z-2            
    move z-2             to dunden-dv
    end-if
    move "Dunden Devir:"       to det-1.
    move dunden-tl             to z-1       
    move z-1                   to det-2.
    if kdv-bitti not = 1 
            
         
   
            move takaskdv-anahtar to z-kdv
            move z-kdv    to det-20(2:)
            move " KDV"              to det-20(4:)
             MOVE "%" TO det-20(1:1)
            move takaskdv-kdv            to z-1          
            move z-1                   to det-21
            move takaskdv-matrah       to z-1          
            move z-1                   to det-22
                 compute takaskdv-toplam = takaskdv-matrah + takaskdv-kdv
             move takaskdv-toplam       to z-1          
            move z-1                   to det-23
          read takaskdv next no lock end  move 1 to kdv-bitti
            end-read    



    end-if



    write dokumer-rec from detay.

    initialize dokumer-rec detay
    move "A"          to det-dokumer-20(3:1)
    move 481          to det-renk1
    move "1"          to det-dokumer-20(10:1)
    move "|" to fil-1 fil-2  fil-21 fil-211 fil-22 fil-23 fil-k1 fil-k4 fil-3 fil-4 fil-5 fil-6 fil-20
    compute yarin-tl = dunden-tl + bugun-tl.
    compute yarin-dv = dunden-dv + bugun-dv.
    move "Yarina devir:"       to det-1.
    move yarin-tl              to z-1        
    move z-1                   to det-2.
    if yarin-tl = 0 
       move 0 to   yarin-dv
    end-if 
    move yarin-dv              to z-2.
    move z-2                   to det-3.

      if kdv-bitti not = 1 
            
         
   
            move takaskdv-anahtar to z-kdv
            move z-kdv    to det-20(2:)
            move " KDV"              to det-20(4:)
             MOVE "%" TO det-20(1:1)
            move takaskdv-kdv            to z-1          
            move z-1                   to det-21
            move takaskdv-matrah       to z-1          
            move z-1                   to det-22
                 compute takaskdv-toplam = takaskdv-matrah + takaskdv-kdv 
             move takaskdv-toplam       to z-1          
            move z-1                   to det-23
          read takaskdv next no lock end move 1 to kdv-bitti
            end-read    

    end-if
    write dokumer-rec from detay

    perform until kdv-bitti = 1 


           initialize dokumer-rec detay
            move "A"          to det-dokumer-20(3:1)
            move 481          to det-renk1
            move "1"          to det-dokumer-20(10:1)
            move "|" to fil-1 fil-2  fil-21 fil-211 fil-22  fil-k1 fil-k4 fil-23 fil-3 fil-4 fil-5 fil-6 fil-20
            compute yarin-tl = dunden-tl + bugun-tl
            if  dunden-tl = 0 
               move  0   to dunden-dv
            end-if 
            compute yarin-dv = dunden-dv + bugun-dv
            move "Yarina devir:"       to det-1
            move yarin-tl              to z-1        
            move z-1                   to det-2
            move yarin-dv              to z-2
            move z-2                   to det-3
              if kdv-bitti not = 1 
            
         
   
                    move takaskdv-anahtar to z-kdv
                    move z-kdv    to det-20(2:)
                    move " KDV"              to det-20(4:)
                    MOVE "%" TO det-20(1:1)  
                    move takaskdv-kdv            to z-1  
                     
                    move z-1                   to det-21
                    move takaskdv-matrah       to z-1   
                    move z-1                   to det-22
                    compute takaskdv-toplam = takaskdv-matrah + takaskdv-kdv
                     move takaskdv-toplam       to z-1          
                      move z-1                   to det-23
                  read takaskdv next no lock end move 1 to kdv-bitti
                    end-read    

              end-if
              write dokumer-rec from detay

    end-perform 
    if onkpara-referans-var = 1 and rapor-ref = 0 and (k-kodu-tasi = "ASYA" or "X   ")
    open input onkasar
    initialize onkasar-rec  devlerler
    move rapor-tarih to onkasar-tarih
    move "888" to onkasar-dep
     perform varying idev from 1 by 1 until idev > 8 
     move idev to onkasar-ref
    
    read onkasar no lock invalid initialize onkasar-tutar-tl onkasar-tutar-dv
      exit perform cycle
    end-read
     add   onkasar-tutar-tl to devler(11)
      initialize dokumer-rec detay
            move "A"          to det-dokumer-20(3:1)
            move 481          to det-renk1
            move "1"          to det-dokumer-20(10:1)
            move "|" to fil-1 fil-2  fil-21 fil-211 fil-22  fil-k1 fil-k4 fil-23 fil-3 fil-4 fil-5 fil-6 fil-20
    move onkasar-tutar-tl to z-1         
    move "Dunden Devir:"       to det-1
    move z-1                   to det-2
    move ref-adi(idev) to det-3
            write dokumer-rec from detay


     end-perform 
     close onkasar
      initialize dokumer-rec detay
            move "A"          to det-dokumer-20(3:1)
            move 481          to det-renk1
            move "1"          to det-dokumer-20(10:1)
            move "|" to fil-1 fil-2  fil-21 fil-211 fil-22  fil-k1 fil-k4 fil-23 fil-3 fil-4 fil-5 fil-6 fil-20
    move devler(11) to z-1         
    move "Dunden Devir:"       to det-1
    move z-1                   to det-2
    move "TOPLAM" to det-3
            write dokumer-rec from detay
    end-if



    initialize dokumer-rec detay
    move "-"            to det-dokumer-20(5:1)
    move all "-"  to det-1 det-2  det-21  det-211 det-23 det-22 det-3 det-4 det-5 det-6 det-20
    move "+" to fil-1 fil-2  fil-21 fil-211 fil-22 fil-23 fil-k1 fil-k4 fil-3 fil-4 fil-5 fil-6 fil-20
    write dokumer-rec from detay.
*
 Form1-Ef-1-Aft-Procedure.
     if hangi-ref-secildi > 0
       if hangi-ref-secildi not = rapor-ref
            move hangi-ref-secildi  to rapor-ref
            display Form1-Ef-1
       end-if 
    end-if 
     .

 
