* acfkont.evt
* acfkont.evt is generated from D:\asya\acugt.ytl\otel\acfkont.Psf
* This is a generated file. DO NOT modify this file directly.


 Form1-Event-Proc.
     EVALUATE Event-Control-Id
     WHEN 1
        PERFORM Form2-Gd-1-Ev-Other
     END-EVALUATE
     .

 Form1-Exception-Proc.
     PERFORM Form1-Ex-Other
     .

 Form2-Exception-Proc.
     PERFORM Form2-Ex-Other
     .

 Form2-Cm-1-Exception-Proc.
* 
     IF Event-Occurred
        EVALUATE Event-Type
        WHEN Ntf-Selchange
           PERFORM Form2-Cm-1-Ex-Ntf-Selchange
        END-EVALUATE
     END-IF
     .

 Form2-Gd-1-Exception-Proc.
     PERFORM Form2-Gd-1-Ex-Other
     .

 screen1-Event-Proc.
     .

 screen1-Exception-Proc.
     PERFORM screen1-Ex-Other
     .

 Form3-Event-Proc.
     .

 Form3-Exception-Proc.
     PERFORM Form3-Ex-Other
     .
***   start event editor code   ***
*
 Form1-Bef-Create.
*     if k-kodu-tasi = "ASYA" stop " " end-if
*******************************************************************
     accept pflege from environment "EFATCISIRKET"
*******************************************************************
     perform adresleri-tasi.
     open input genel
    move 1 to genel-anahtar
    read genel no lock invalid continue
         not invalid continue
    end-read
    close genel.
**    move donem-basi of genel-rec to kv-gecis-tar

    move 0 to  ear-vis
    if genel-kaya-otelleri
       move 1 to ear-vis
    end-if
    move ONKPARA-oda-post-dep to d-basdep
    move ONKPARA-duzeltme-dep to d-kardep
    move genel-printer-filtre           to text-oku-filtre.
       move muha-sirketi of genel-rec to muhasebe-entegre-sirketi
    perform acuserve-adres-aktar.
     move tarih-tasi  to ilk-tarih son-tarih.
       open i-o acenfat. 
       close acenfat.

        
       open i-o genelfis
            move 1 to genelfis-anahtar
            read genelfis no lock invalid
                 initialize genelfis-rec 
                 move 1 to genelfis-anahtar
                 not invalid continue 
            end-read
            add 1 to EKRAN-FIS-1
              move ekran-fis-1    to deptop-no takaskdv-no
              move k-kodu-tasi    to deptop-k  takaskdv-k
            rewrite genelfis-rec invalid 
                    write genelfis-rec 
                    end-write continue
            end-rewrite
            close genelfis.
         call "c$narg" using link-var         
         perform max-bul.     
*
acenfat-yeniden.        
         display message box "Data degisti. Tum veri olusturulacak.   " new-line
         "Birkac dakika sürebilir. Tamam tusuna basip bekleyiniz" title "  "
         open output acenfat
          close acenfat
          open i-o acenfat
         call "/asya/ytl/obj/otel/fatolus.asy" 
                    using  DONEM-BASI of genel-rec   tarih-tasi
                         on exception 
                     perform callerr-proc
                     exit paragraph
                    not on exception 
                     cancel "/asya/ytl/obj/otel/fatolus.asy"
                  end-call
     .
*
acc-ilk-yil-Aft-Procedure.
     initialize gec-gecme.
     open input takvim.
     move ilk-tarih   to takvim-anah
     read takvim no lock invalid
          move 1 to gec-gecme
     end-read
     close takvim.
*
acc-son-yil-Aft-Procedure.
     initialize gec-gecme.
     open input takvim.
     move son-tarih   to takvim-anah
     read takvim no lock invalid
          move 1 to gec-gecme
     end-read
     close takvim.
     
     .
*
acc-acenta-Aft-Procedure.
     initialize gec-gecme.
     if rapor-acenta = spaces
        move "Tum acentalar ..." to acenta-adi
        display lb-acenta-adi
        exit paragraph
     end-if
     open input acenta.
     move rapor-acenta to acenta-kodu
     read acenta no lock invalid
          move "Tanimsiz ..." to acenta-adi
          move 1 to gec-gecme
     end-read
     close acenta.
     display lb-acenta-adi.
*
Form1-Ex-Other.
     if  key-status = 1 and control-id = 12 then
           perform acenta-ara  
     end-if
     if key-status = 1 and control-id = 24
        perform anlasma-ara
     end-if 
     if key-status = 1 and control-id = 21
        perform firma-ara
     end-if 
     if key-status = 2001 or key-status = 2 
** osman        move son-tarih  to ilk-tarih 
       
        display acc-ilk-gun acc-ilk-ay acc-ilk-yil
        continue
     else
        exit paragraph
     end-if.
     perform acc-ilk-yil-Aft-Procedure.
     if gec-gecme = 1
        move 4 to accept-control
        move 6 to control-id
        exit paragraph
     end-if.
     
     perform acc-son-yil-Aft-Procedure.
     if gec-gecme = 1
        move 4 to accept-control
        move 9 to control-id
        exit paragraph
     end-if.

     perform acc-acenta-Aft-Procedure.
     if gec-gecme = 1 
        move 4 to accept-control
        move 12 to control-id
        exit paragraph
     end-if.

     if key-status = 2001 
        perform raporla
     else 
            move ilk-tarih to fat-tarih 
           
                    call "/asya/ytl/obj/otel/fatolus.asy" 
                    using  ilk-tarih  son-tarih
                         on exception 
                     perform callerr-proc
                     exit paragraph
                    not on exception 
                     cancel "/asya/ytl/obj/otel/fatolus.asy"
                  end-call
            perform acu-form2-routine
       end-if    .

raporla.
     if key-status = 2001
        open input acenfat
     end-if.
     
     open input konuk  konu2 acenta  firma doviz cari rez odalar.
     open i-o musteri
     initialize acenfat-rec  oda-top
     move ilk-tarih   to acenfat-tarih
     start acenfat key not < acenfat-anah invalid
                  if fatupdate <> 1 then
                    initialize mesaj-link
                    move 04 to mesaj-no
                    perform mesaj-ver
                  end-if
                    close  konuk konu2 acenta firma musteri acenfat  doviz cari rez odalar
                    exit paragraph
     end-start.

     if key-status = 2001
        open i-o genelfis
        move 1 to genelfis-anahtar
        read genelfis no lock invalid
             accept print-no from time
        not invalid
             add 1 to print-no
             rewrite genelfis-rec end-rewrite
        end-read
        close genelfis

**************************
     initialize dokumer-rec dokumer-anah dokumer-ozellikler-rec
                dokumer-dosya

     set  dokumer-asya-set to true
     move print-no         to dokumer-dosya-adi
     open output dokumer
*/WINDOW TITLE
     initialize dokumer-rec detay
     move "W"                  to det-dokumer-20(1:)
     move "Acenta Fatura Kontrol Raporu"   to det-filler
     write dokumer-rec from detay
*/ BASLIKLAR
     initialize dokumer-rec detay
     move "B"                  to det-dokumer-20(1:1)
     move "1"          to det-dokumer-20(10:1)
     move "Acenta Fatura Kontrol Raporu"   to det-filler
     move "Tarih..:"     to det-filler(41:10)
     move ilk-gun        to det-filler(51:02)
     move "/"            to det-filler(53:01)
     move ilk-ay         to det-filler(54:02)
     move "/"            to det-filler(56:01)
     move ilk-yil        to det-filler(57:04)
     move "-"            to det-filler(61:01)
     move son-gun        to det-filler(62:02)
     move "/"            to det-filler(64:01)
     move son-ay         to det-filler(65:02)
     move "/"            to det-filler(67:01)
     move son-yil        to det-filler(68:04)
     write dokumer-rec from detay
     initialize dokumer-rec detay

     initialize dokumer-rec detay
     move "B"                  to det-dokumer-20(1:1)
     move "1"          to det-dokumer-20(10:1)
     move "Acenta.:"           to det-filler(01:10)
     move acenta-adi           to det-filler(11:)
     write dokumer-rec from detay

     initialize dokumer-rec detay
     move "B"                  to det-dokumer-20(1:)
     write dokumer-rec from detay

*/ DOKUMER OZELLIKLER-REC
     initialize dokumer-rec detay
     move "O" to det-dokumer-20(1:)
     move "E" to dokumer-oto-sayfa-basi
     move 56  to dokumer-oto-sayfa-satir
     move "|" to dokumer-detay-kolon-ayirici
     move "LLLRRLLRRLL" to dokumer-align-occ
     move dokumer-ozellikler-rec     to det-filler
     write dokumer-rec from detay
*/ BASLIKLAR  
     initialize dokumer-rec detay 
     move "D1"         to det-dokumer-20(1:2)
     move "1"          to det-dokumer-20(10:1)
     move "Tarih"          to det-1
     move "Acenta"         to det-2
     move "Acenta adi"     to det-3
     move "Gece"           to det-31
     move "Folio"          to det-4
     move "Adi"            to det-5
     move "Soyadi"         to det-6
     move "Tl tutar"       to det-7
     move "Doviz tutar"    to det-8
     move "Fatura"         to det-9
     move "|" to fil-1 fil-2 fil-3 fil-4 fil-5 fil-6
                 fil-7 fil-8 fil-9  fil-31
     write dokumer-rec from detay
     move high-values to son-profil

     initialize dokumer-rec detay
     move "D2"           to det-dokumer-20(1:2)
     move "-"            to det-dokumer-20(5:1)
     move all "-" to det-1 det-2 det-3 det-4 det-5 det-6
                 det-7 det-8 det-9  det-31
     write dokumer-rec from detay
     end-if.
********************* ramco ekle************************
      open i-o genelfis
         move 1 to genelfis-anahtar
         read genelfis no lock invalid
            accept print-no from time
           not invalid
            add 1 to print-no
            rewrite genelfis-rec end-rewrite
          end-read
          close genelfis
         move print-no to fattop-no fattop2-no   tacenfat-no

       open output fattop. close fattop. open i-o fattop.
        open output fattop2. close fattop2. open i-o fattop2.
********************* ramco ekle bitti ************************
***********************SYYY*********
     delete file tacenfat
     OPEN output tacenfat close tacenfat
     open i-o tacenfat
        
     initialize fs-acenfat 
     perform with test after until fs-acenfat = "10"
     read acenfat next no lock end move "10" to fs-acenfat
     not at end

             if acenfat-tarih > son-tarih
                move "10" to fs-tacenfat
                exit perform
             end-if



             initialize tacenfat-rec
             move ACENFAT-TARIH to  tACENFAT-TARIH
             move acenfat-p-sirket to tacenfat-p-sirket   
             move acenfat-p-no to    tacenfat-p-no  
             move acenfat-pan  to   tacenfat-pan    
             move acenfat-grup to tacenfat-grup      
             move acenfat-op   to  tacenfat-op 
             initialize musteri-rec
*             move ACENFAT-PROFIL  to m-profil   |firat m-profil bos geliyordu 17/08/2020
             move acenfat-p-sirket to musteri-sirket 
             move acenfat-p-no     to musteri-no
                 initialize musteri-rec   || aytac royal wings
                   if musteri-no not numeric
                   ||   move "999999992" to musteri-no
                   end-if
                   read musteri no lock invalid
                           move ACENFAT-acenta to acenta-kodu
                           read acenta no lock invalid
                              continue
                           not invalid
                                    if ACENTA-MUHNO2 = spaces
                                       move acenta-muhno to cari-kodu  musteri-muhasebe-kodu
                                        else
                                      move acenta-muhno2 to cari-kodu  musteri-muhasebe-kodu
                                  end-if
                                        move ACENFAT-sirket to konu2-firma 
                                       perform firma-oku-getir
                                read cari no lock invalid
                                  initialize cari-rec
                                end-read,
                                    perform varying ix from 1 by 1 until ix > 18
                                       if c-vergi-no(ix:1) = spaces then 
                                           move  c-vergi-no(ix + 1 :) to c-vergi-no(ix :) 
                                           move  " "                  to c-vergi-no(20:1)
                                       end-if
                                  end-perform 
                                     move c-unvan-1       to musteri-unvan1(1:40)       
                                     move c-unvan-2       to musteri-unvan2(1:40)       
                                     move c-adres-1       to musteri-adres1 (1:40)      
                                     move c-adres-2       to musteri-adres2 (1:40)      
                                     move c-il-ilce       to musteri-ilce(1:20)         
                                     move c-ulke(1:14)    to musteri-il(1:14)           
                                     move c-vergi-daire   to musteri-vdairesi (1:20)    
                                     move c-vergi-no      to musteri-vno    
                                      move C-EMAIL        to musteri-e-mail
                                end-read
                  not invalid
                      move   musteri-vno    to  c-vergi-no    
                  end-read
                 
              move musteri-vno   to tacenfat-vergi-no
              move musteri-muhasebe-kodu to tacenfat-muh-hesap


             move ACENFAT-GECELEME to tACENFAT-GECELEME   
             move acenfat-eb  to tacenfat-eb  tacenfat-eb2      
             move acenfat-voucher to  tacenfat-voucher  
             move ACENFAT-FOLIO   to    tACENFAT-FOLIO
             move acenfat-kfolio   to  tacenfat-kfolio 
             move ACENFAT-PENCERE  to   tACENFAT-PENCERE
             move ACENFAT-TIP     to tACENFAT-TIP  
             move ACENFAT-KDV    to  tACENFAT-KDV   
             move ACENFAT-kv    to  tACENFAT-kv   
             move acenfat-peryod  to tacenfat-peryod   

             move acenfat-anah to tacenfat-anah2
             write tacenfat-rec invalid
                     stop " "
             end-write
               
      END-READ
      END-PERFORM
               
******************************************    

    
       open i-o efatci
       open i-o fatdetay   fatdetayek
       open input muh-kodlar 
     initialize fat-sira son-profil  a
     initialize fat-sat
     initialize fs-acenfat toplamlar
     initialize tacenfat-rec fat-yok
      
     move ilk-tarih   to tacenfat-tarih  
     if eb-ayir = 1 then
            start tacenfat key not < tacenfat-anah-eb invalid
                   move 1 to fat-yok
             end-start
     end-if
     if gir-ayir = 1 then
             start tacenfat key not < tacenfat-anah invalid
                    move 1 to fat-yok
             end-start
     end-if
     if fat-yok = 0 then
             perform with test after until fs-tacenfat = "10"
             read tacenfat next no lock end move "10"  to fs-tacenfat
             not at end 
              
                      initialize acenfat-rec
                      move tacenfat-anah2 to acenfat-anah
                      read acenfat no lock invalid
                        if k-kodu-tasi = "ASYA" then stop " " end-if
                              display message box "tacenfat to  read acenfat invalid"
                      end-read
                      if rapor-ref > 0
                
                                initialize konuk-rec
                                move acenfat-kfolio  to konuk-folio
                                read konuk no lock invalid 
                                     continue 
                                end-read 
                                move konuk-fiyat-konumu   to rez-fiyat-konumu
                                move konuk-oda-konumu     to rez-oda-konumu
                                move rapor-ref   to fiyat-ref
                                move 0           to oda-ref
                                move konuk-odano to cast-oda-no rez-odano
                                
                                if onkpara-referans-var = 1 then 
                                    perform ref-filtre
                                     if  not ref-gecti then 
                                          exit perform cycle  
                                       end-if
                                end-if
                       end-if 
         
                     if rapor-acenta = spaces or 
                        rapor-acenta = acenfat-acenta 
                              continue
                     else 
                        exit perform cycle
                     end-if
                    
                     if key-status = 2001
                        move 0 to uyari-verdim
                        initialize detay
                        move acenfat-gun         to egun
                        move acenfat-ay          to eay
                        move acenfat-yil         to eyil
                        move etarih              to det-1
                        move acenfat-acenta      to acenta-kodu det-2
                        read acenta no lock invalid
                             move "Tanimsiz acenta"  to acenta-adi
                        end-read
                         move acenta-faturada-voucher to max-voucher
                        if max-voucher < 1 or   max-voucher > 50
                              move 20 to max-voucher
                        end-if
                        move acenta-kodu         to det-3(1:4)
                        move "-"                 to det-3(5:1)
                        move acenta-adi          to det-3(6:)
                        move acenfat-per-geceleme    to 3-hane
                        move 3-hane              to det-31
                        move acenfat-folio       to det-4 konuk-folio
                        read konuk no lock invalid
                             initialize konuk-rec
                        end-read
                          
                        move konuk-adi           to det-5
                        move konuk-soyadi        to det-6
                        
                        move acenfat-tl-tutar    to etutar
                        move etutar              to det-7 
                        move acenfat-ger-dv-tutar    to etutar-dv
                        move etutar-dv           to det-8
                        add 1 to oda-top
                        add acenfat-tl-tutar     to tl-top
                        add acenfat-ger-dv-tutar     to dv-top
                        if acenfat-e-h = "H"
                           move "Hayir"          to det-9
                        else
                           move "Evet"           to det-9
                        end-if
                        write dokumer-rec from detay
                     else
                     
                        initialize form2-gd-1-record
                        move acenfat-gun         to egun
                        move acenfat-ay          to eay
                        move acenfat-yil         to eyil
                        move acenfat-acenta      to acenta-kodu 
*                move etarih              to gd-1-col-1
                        read acenta no lock invalid
                             move "Tanimsiz acenta"  to acenta-adi
                        end-read
                         move acenfat-folio       to  konuk-folio
*                if acenfat-folio = 34630 
*                 | and k-kodu-tasi = "X   " 
*                  then stop " " end-if
                        read konuk no lock invalid
                             initialize konuk-rec
                        end-read
                            if konuk-firma not = rapor-firma and
                               rapor-firma not = spaces 
                                  exit perform cycle 
                            end-if
                            if konuk-anlasma not = rapor-anlasma and
                               rapor-anlasma not = spaces
                                 exit perform cycle 
                            end-if 
*                 if konuk-voucher = spaces then 
*                    move konuk-folio to konuk-voucher
*                 end-if
                        if son-profil = high-values
                                move acenfat-profil    to son-profil 
                                move acenfat-eb        to son-eb
                                move acenfat-geceleme  to son-geceleme 
                                move acenfat-op        to son-op 
                                move acenfat-pan       to son-pan
                                move acenfat-grup      to son-grup
                                move konuk-doviz       to son-dov
                                move 1                 to adet-voucher
                                move konuk-voucher     to son-voucher                               
                        end-if
        
                        move acenta-faturada-voucher to max-voucher
                        if max-voucher < 1 or   max-voucher > 50
                              move 20 to max-voucher
                        end-if
                        
                         if konuk-voucher not = son-voucher 
                            
                            add 1 to adet-voucher
                            move konuk-voucher to son-voucher
                         
                         end-if
        
        
*/////////////////////e-fatura eklemee**************************
        
                        move acenfat-kfolio to konu2-folio
                        
                        read konu2 no lock invalid
                                  initialize konu2-rec
                        end-read

                     if musteri-no = 0 
                        initialize musteri-rec
**                       move ACENFAT-PROFIL  to m-profil   |firat m-profil bos geliyordu 17/08/2020
                        move acenfat-p-sirket to musteri-sirket 
                        move acenfat-p-no     to musteri-no
                        read musteri no lock invalid
                            continue 
                        not invalid 
                           delete musteri invalid 
                             continue 
                           end-delete 
                           perform log-operation-musteri
                        end-read 
                     end-if 

                        initialize musteri-rec
*                        move ACENFAT-PROFIL  to m-profil
                         move acenfat-p-sirket to musteri-sirket    
                         move acenfat-p-no     to musteri-no   
                        move konu2-odano to  gd-1-col-2
                           if musteri-no not numeric
                              move "999999992" to musteri-no
                           end-if

                           initialize musteri-rec
        
                           read musteri no lock invalid
                                   move konu2-acenta to acenta-kodu
                                   read acenta no lock invalid
                                       continue
                                   not invalid
                                    if ACENTA-MUHNO2 = spaces
                                          move acenta-muhno to cari-kodu  musteri-muhasebe-kodu
                                    else
                                          move acenta-muhno2 to cari-kodu  musteri-muhasebe-kodu
                                    end-if

                                  perform firma-oku-getir

                                 read cari no lock invalid
                                  initialize cari-rec
                                 end-read,
                                     perform varying ix from 1 by 1 until ix > 18
                                           if c-vergi-no(ix:1) = spaces then 
                                                move  c-vergi-no(ix + 1 :) to c-vergi-no(ix :) 
                                                move  " "                  to c-vergi-no(20:1)
                                           end-if
                                     end-perform 
                                     move c-unvan-1         to musteri-unvan1(1:40)       
                                     move c-unvan-2         to musteri-unvan2(1:40)       
                                     move c-adres-1         to musteri-adres1 (1:40)      
                                     move c-adres-2         to musteri-adres2 (1:40)      
                                     move c-il-ilce         to musteri-ilce(1:20)         
                                     move c-ulke(1:14)      to musteri-il(1:14)           
                                     move c-vergi-daire     to musteri-vdairesi (1:20)    
                                     move c-vergi-no        to musteri-vno
                                     move C-EMAIL           to musteri-e-mail
                               end-read
                          not invalid
                                      move musteri-vno      to  c-vergi-no    
                          end-read
                         
                         initialize efatci-rec efatcari
                                 initialize axxx aa buffer x10 x100
                                 perform varying axxx from 1 by 1 until axxx > 20
                                      if c-vergi-no(axxx:1) <> spaces
                                         add 1 to aa
                                         move c-vergi-no(axxx:1)   to buffer(aa:1)
                                      end-if
                                 end-perform
        
        
                         
                         move buffer     to c-vergi-no
                         move c-vergi-no to efatci-kodu
 
                         if efatci-kodu = spaces then 
                           initialize muh-kodlar-rec
                          set muh-kodlar-tipi-cari to true
                  
                  move cari-kodu to muh-kodlar-kodu1 
                  read muh-kodlar no lock invalid
                          continue
                  end-read


                            move  muh-kodlar-cari-tc-kimlik-no(1:11) to  efatci-kodu

                         end-if
        
                         if genel-efatura-kllnc-degil not = 1
                            read efatci no lock invalid 
                                 move 0 to efatcari
                            not invalid 
                                if genel-e-arsiv-yil  < 2100 
                                   if efatci-giris-tarih > fat-tarih 
                                      move 0 to efatcari
                                   else
                                      move 1 to efatcari
                                   end-if
                                end-if
                            end-read
                         end-if

                         if efatcari = 0 and v-comboefat(1:1) = "E" 
                            exit perform cycle
                         end-if
                          if efatcari = 1 and v-comboefat(1:1) = "K" 
                            exit perform cycle
                         end-if
                  

                  
*/////////////////////e-fatura eklemee**************************
                        if acenfat-peryod = 0 
                              initialize isalih
                              perform varying isalih from 1 by 1 until isalih > 10
                                    if acenfat-per-tut(isalih) = zeroes
                                          compute isalih = isalih - 1
                                          exit perform
                                    end-if
                              end-perform
                        end-if
                        if isalih = 0 
                              move 1 to isalih
                        end-if
                        
                         if acenfat-fat-no = 0 then

                          if acenfat-peryod = 0 and ( (
                          (      
                                 son-dov not = konuk-doviz or
                               ( EB-AYir = 1 and son-eb not = acenfat-eb) or
                               ( gir-ayir = 1  and acenfat-geceleme not = son-geceleme ) or 
                               ( max-voucher < adet-voucher ) or 
                                son-pan not = ACENFAT-pan  or
                                son-grup not = acenfat-grup or
                               ( op-ayir = 1 and acenfat-op not =  son-op )
                                ) and fat-ayirma = 0 ) or 
                               ( fat-sat > max-satir - isalih ) or son-profil not = ACENFAT-PROFIL) 
                               or (acenfat-sirket not = spaces and acenfat-sirket not = son-firma)  then
                          
                                 move konuk-voucher to son-voucher
                                 move  ACENFAT-PROFIL   to  son-profil 
                                 move  acenfat-eb       to  son-eb
                                 move  acenfat-geceleme to  son-geceleme 
                                 move  acenfat-op       to  son-op 
                                 move konuk-doviz to son-dov
                                 move 1 to adet-voucher
                                 move acenfat-op to son-op
                                 move acenfat-eb to son-eb
                                 move acenfat-pan       to son-pan
                                 move acenfat-grup      to son-grup
                                 move acenfat-geceleme to son-geceleme 
                                 move acenfat-sirket   to son-firma
                                 add 1 to fat-sira
                              
                                 move ACENFAT-PROFIL to son-profil
                                 initialize fat-sat 
                            end-if
                            
                            add 1 to fat-sat 
                            move fat-sira to z-4
                            move z-4 to gd-1-col-0
                         end-if
                               
                        move acenfat-per-geceleme    to 3-hane
                        move 3-hane              to gd-1-col-9
                        move acenfat-kfolio to konu2-folio
                        read konu2 no lock invalid
                                  initialize konu2-rec
                        end-read
                          initialize bas-ek son-ek
                         if konu2-rez-no > 0 then 
                                initialize rez-rec
                                move  konu2-rez-no to rez-no
                                read rez no lock invalid continue
                                end-read
                                  if rez-gel-sirket not  = spaces then 
                                 
                                      move "*" to  bas-ek   
                                    
                                 end-if
                                  if rez-git-sirket  not  = spaces then 
                                      move "*"    to son-ek  
                                  end-if
        
        
                              end-if
        
                        string bas-ek   delimited by " " 
                              konu2-adi delimited by "  " 
                              son-ek    delimited by " " 
                              " " delimited by size
        
                               konu2-soyadi  delimited by "  "
                                 into gd-1-col-3
                        if konu2-eb = "E" then
                           move " E/B"        to gd-1-col-3(12:)
                       end-if     
                         initialize musteri-rec
**                        move ACENFAT-PROFIL  to m-profil
                         move acenfat-p-sirket to musteri-sirket    
                         move acenfat-p-no     to musteri-no 
                        move konu2-odano to  gd-1-col-2
                        if musteri-no not numeric
                              move "999999992" to musteri-no
                           end-if
                            initialize musteri-rec
                           read musteri no lock invalid
                           move konu2-acenta to acenta-kodu
                           read acenta no lock invalid
                              continue
                              not invalid
                                    if ACENTA-MUHNO2 = spaces
                                       move acenta-muhno to cari-kodu  musteri-muhasebe-kodu
                                        else
                                      move acenta-muhno2 to cari-kodu  musteri-muhasebe-kodu
                                  end-if
                                  perform firma-oku-getir
                                 read cari no lock invalid
                                  initialize cari-rec
                                end-read,
                                    perform varying ix from 1 by 1 until ix > 18
                                       if c-vergi-no(ix:1) = spaces then 
                                           move  c-vergi-no(ix + 1 :) to c-vergi-no(ix :) 
                                           move  " "                  to c-vergi-no(20:1)
                                       end-if
                                  end-perform 
                                      move c-unvan-1          to  musteri-unvan1(1:40)       
                                     move  c-unvan-2         to  musteri-unvan2(1:40)       
                                     move  c-adres-1         to  musteri-adres1 (1:40)      
                                     move  c-adres-2         to  musteri-adres2 (1:40)      
                                     move  c-il-ilce         to  musteri-ilce(1:20)         
                                     move  c-ulke(1:14)      to  musteri-il(1:14)           
                                     move  c-vergi-daire     to musteri-vdairesi (1:20) 
                                   
                                   

                                     move  c-vergi-no          to musteri-vno
                                end-read
                          not invalid
                              move   musteri-vno    to  c-vergi-no    

                          end-read







                         
                         move c-vergi-no to Gd-1-Col-18
                         move rez-voucher to gd-1-col-19
                         move  musteri-unvan1 to gd-1-col-6 
                         move  musteri-muhasebe-kodu to gd-1-col-7
                          move acenfat-acenta to acenta-kodu 
                        read acenta no lock invalid
                             move "Tanimsiz acenta"  to acenta-adi
                        end-read
                        move acenta-kodu   to gd-1-col-1(1:4) 
                        move "-" to   gd-1-col-1(5:1) 
                        move acenta-adi          to gd-1-col-1(6:)
                        initialize firma-rec
                        move konu2-firma      to firma-kodu 
                        read firma no lock invalid
                            continue
                        end-read
                        move firma-adi          to gd-1-col-4
                         if acenfat-tip = "2" then 
                           move "ROOM" to  gd-1-col-8
                           else
                           move "EXTRA" to  gd-1-col-8
                         end-if
                         move konu2-doviz to doviz-kodu
                         read doviz no lock invalid continue
                         end-read
                         move d-kisa-adi to gd-1-col-11
                        
                        move acenfat-tl-tutar    to z-8
                        move z-8             to gd-1-col-13

                        move acenfat-ger-dv-tutar    to z-8
                        move z-8                     to gd-1-col-10
                        move acenfat-ger-tl-tutar    to z-8
                        move z-8                     to gd-1-col-12
                        add 1 to oda-top
                        add acenfat-tl-tutar         to tl-top
                        add acenfat-ger-dv-tutar     to dv-top
                        add acenfat-ger-tl-tutar     to ger-tl-top
        || stop " " 
                         move acenfat-fat-no   to gd-1-col-14
                          if konu2-gec-giris > 0 then  
                                    perform takvim-onceki-oku
                              end-if
                         move konu2-gel-tar(7:2)  to gd-1-col-16(1:2)
                         move "-" to  gd-1-col-16(3:1)  gd-1-col-16(9:1) 
                         move konu2-gel-tar(5:2)  to gd-1-col-16(4:2)
                         move konu2-git-tar(7:2)  to gd-1-col-16(7:2)
                         move konu2-git-tar(5:2)  to gd-1-col-16(10:2)
                         move acenfat-geceleme to zzz move zzz to gd-1-col-16(12:)
*********************ramco ekle **********************
                         PERFORM fattop-takas-at
                         initialize fattop-rec
                         
                      move acenta-kodu to  fattop-acenta  
                      move cari-kodu to  fattop-cari     
****              move  fattop-referans      
                      move acenfat-fat-no  to  fattop-fatno  
                      if acenfat-fat-no not > 0 then 
                         compute fattop-fatno = 90000000 + fat-sira - 1
                         if fat-sira   > 0                           
                            move 1 to fattop-fat-kes
                         else
                            move 0 to fattop-fat-kes
                         end-if
                      else                        
                           move 2 to fattop-fat-kes
                      end-if 
                   
******             move  fattop-fat-kes    .
                      move doviz-kodu   to  fattop-doviz       
                     read fattop no lock invalid 
                        continue
                     end-read
                      if acenfat-fat-no not > 0 then 
                     
                          add  acenfat-tl-tutar to fattopk-tl-tut
                          add acenfat-ger-dv-tutar to fattopk-dv-tut
                         if fat-sira   > 0
                            move 1 to fattopk-fat-adet                                                                
                            move 1 to fattop-fat-kes
                         else
                            move 0 to fattop-fat-kes
                         end-if
                      else
                            move acenfat-fat-no  to fattop-fatno  
                            move 2               to fattop-fat-kes
                            move 1               to fattop-fat-adet
                            add  acenfat-tl-tutar to fattop-tl-tut
                            add acenfat-ger-dv-tutar to fattop-dv-tut
                      end-if 
                      add 1 to fattop-adet
                     
                       write fattop-rec invalid rewrite fattop-rec end-write
******************************************************************
        
                    if fatupdate = 1 then 
                          perform fatupdateyap
                    end-if      
        
        
******************** ramco ekle bitti ************************
                         
                        modify form2-gd-1,
                               record-to-add(form2-gd-1-record)
                               
                        modify form2-gd-1(oda-top + 1, 1),                      
                               hidden-data = acenfat-anah
                               
                        if acenfat-fat-no > 0
                           modify form2-gd-1(oda-top + 1, 17),                      
                                  hidden-data = secim-durumu
                           move "E"                 to secim-durumu
                           if secim-durumu = "E"
                                  modify form2-gd-1(oda-top + 1,17),
                                         bitmap = yes-bmp
                                         bitmap-width = 16
                                         bitmap-number = 1
                           end-if 
                        end-if 
                         if  acenfat-fat-no > 0 then 
                             modify form2-gd-1(oda-top + 1) row-color = 5
                         end-if
                      end-if
                 end-read
            end-perform
      end-if
     close fatdetay fatdetayek tacenfat
********************* ramco ekle  ************************
     close fattop  fattop2   efatci  muh-kodlar

     perform kayit-kontrol
********************* ramco ekle bitti ************************
*/*-*\**/*-*\**/*-*\**/*-*\**/*-*\**/*-*\**/*-*\*
     if key-status = 2001
        initialize dokumer-rec detay
        move "-"            to det-dokumer-20(5:1)
        move all "-" to det-1 det-2 det-3 det-4 det-5 det-6
                     det-7 det-8 det-9 det-31
        write dokumer-rec from detay
        initialize dokumer-rec detay
        move "A"          to det-dokumer-20(3:1)
        move 481          to det-renk1
        move "1"          to det-dokumer-20(10:1)
        move "Toplam =>"             to det-1
        move oda-top                 to 3-hane
        move 3-hane                  to det-31

        move dv-top                  to etutar-dv
        move etutar-dv               to det-8  
        move tl-top                  to etutar
        move etutar                  to det-7
        write dokumer-rec from detay 
        initialize dokumer-rec detay
        move "-"            to det-dokumer-20(5:1)
        move all "-" to det-1 det-2 det-3 det-4 det-5 det-6
                     det-7 det-8 det-9 det-31
        write dokumer-rec from detay

        close dokumer
        call dokumer-prog on exception
             perform callerr-proc
        not on exception
             cancel dokumer-prog
        end-call
        delete file dokumer
     end-if.
     
     close acenta konuk konu2 musteri acenfat firma doviz cari rez odalar.

*
Form2-Aft-Initdata.
    open i-o genel
    initialize genel-rec
    move 1                to genel-anahtar
    read genel no lock invalid 
       continue 
    not invalid 
     if v-comboefat(1:1) = "E" 
         compute  cfat-no  = genel-eacen-fat-no + 1
         else
        compute  cfat-no  = genel-acen-fat-no + 1
     end-if
      rewrite genel-rec end-rewrite 
      end-read.
      close genel
     
      display   acc-ilk-gunaa

     initialize duz-yapildi
     move "FSira"               to gd-1-col-0
     move "Acenta/Rate"         to gd-1-col-1
     move "Oda "                to gd-1-col-2
     move "Mis. Adi"            to gd-1-col-3
     move "Sirket"              to gd-1-col-4
     move "Odem"                to gd-1-col-5
     move "Cari Adi"            to gd-1-col-6
     move "Cari Kodu"           to gd-1-col-7
     move "Tip"                 to gd-1-col-8
     move "Geceleme"            to gd-1-col-9 
     move "Bas Doviz"           to gd-1-col-10
     move "Doviz"               to gd-1-col-11
     move "Bas TL"              to gd-1-col-12

     move "Tutar   "            to gd-1-col-13
     move "Fat No"              to gd-1-col-14
     move "C-In/Cout/Gece"      to gd-1-col-16
     move "Secim"               to gd-1-col-17
     move "VKN     "            to gd-1-col-18
     move "Voucher"             to gd-1-col-19
     move EKRAN-FIS-1 to takaskdv-no
     move k-kodu-tasi to takaskdv-k
     modify form2-gd-1,
            record-to-add(form2-gd-1-record).
            
     perform raporla
     if link-var > 0 then 

*        display message box "Fatura kontrolleri tamamlandi"
           set exit-pushed to true
        end-if

     .
*/-----------------------------\*  
*/---------DIL AYARLA----------\*    
*/-----------------------------\*    
     perform dil-ayarla-proc.
*/-----------------------------\*         
*
Form2-Gd-1-Ev-Other.
     initialize acenfat-rec
              inquire form2-gd-1,
                      y in i
                      x in ii
     evaluate event-type
     when msg-heading-dblclick
         evaluate event-data-1
         when 17        
             initialize secim-durumu son-satir
             inquire form2-gd-1,last-row in son-satir 
            
             initialize kk ip  
             perform varying ip 
                        from 1
                        by 1
                        until ip > son-satir
                            compute kk = ip + 1
                            initialize akildaki-fat-no
                            inquire form2-gd-1(kk,15),
                                cell-data akildaki-fat-no
                            if akildaki-fat-no = zeroes
                                move event-action-fail to event-action
                               exit perform cycle 
                            end-if 
                                    
                        inquire form2-gd-1(kk ,17),
                                hidden-data secim-durumu
                
                        if secim-durumu = "H"
                              modify form2-gd-1(kk,17),
                                     bitmap = yes-bmp
                                     bitmap-width = 16
                                     bitmap-number = 1
                                     hidden-data = "E"
                        else
                              modify form2-gd-1(kk,17),
                                     bitmap = no-bmp
                                     bitmap-width = 16
                                     bitmap-number = 1
                                     hidden-data = "H"
                        end-if 
             end-perform
         end-evaluate

         when msg-begin-entry
           if ii = 17
              initialize secim-durumu son-satir
              inquire form2-gd-1,last-row in son-satir
              inquire form2-gd-1(event-data-2,17),
                      hidden-data = secim-durumu
              if secim-durumu = "H"
                    initialize akildaki-fat-no
                    inquire form2-gd-1(event-data-2,15),
                        cell-data akildaki-fat-no
                    if akildaki-fat-no = zeroes
                       move event-action-fail to event-action
                       exit paragraph
                    end-if 
                    initialize kk hangi-satir
                    perform varying kk 
                            from 1 
                            by 1 
                            until kk > son-satir
                       inquire form2-gd-1(kk + 1),
                               record-data form2-gd-1-record
                       compute hangi-satir = kk + 1
                       if function numval(gd-1-col-14) = akildaki-fat-no
                          modify form2-gd-1(hangi-satir,17),
                                 bitmap = yes-bmp
                                 bitmap-width = 16
                                 bitmap-number = 1
                                 hidden-data = "E"                                   
                       end-if 
                    end-perform
              else
                    initialize akildaki-fat-no
                    inquire form2-gd-1(event-data-2,15),
                            cell-data akildaki-fat-no
                    if akildaki-fat-no = zeroes
                       move event-action-fail to event-action
                       exit paragraph
                    end-if 

                    initialize kk hangi-satir
                    perform varying kk 
                            from 1 
                            by 1 
                            until kk > son-satir
                       inquire form2-gd-1(kk + 1),
                               record-data form2-gd-1-record
                       compute hangi-satir = kk + 1
                       if function numval(gd-1-col-14) = akildaki-fat-no
                          modify form2-gd-1(hangi-satir,17),
                                 bitmap = no-bmp
                                 bitmap-width = 16
                                 bitmap-number = 1
                                 hidden-data = "H"                                   
                       end-if 
                    end-perform
              end-if
           end-if 
           if ii = 1
               modify form2-gd-1(i,1),
                      cell-data = spaces
           end-if
           if ii = 2 and (k-kodu-tasi = "ASYA" or "X   ") then 
             inquire form2-gd-1(i,1) hidden-data in acenfat-anah
             display message box    "ACENFAT-TARIH       :" ACENFAT-TARIH    new-line    
                                    "ACENFAT-PROFIL.     :"  ACENFAT-PROFIL  new-line       
                                    "acenfat-pan         :" acenfat-pan      new-line       
                                    "acenfat-grup        :" acenfat-grup     new-line       
                                    "acenfat-op          :" acenfat-op       new-line       
                                    "ACENFAT-GECELEME    :" ACENFAT-GECELEME new-line       
                                    "acenfat-eb          :" acenfat-eb       new-line       
                                    "acenfat-voucher     :" acenfat-voucher  new-line       
                                    "ACENFAT-FOLIO       :" ACENFAT-FOLIO    new-line       
                                    "acenfat-kfolio      :" acenfat-kfolio   new-line       
                                    "ACENFAT-PENCERE     :" ACENFAT-PENCERE  new-line       
                                    "ACENFAT-TIP         :" ACENFAT-TIP      new-line       
                                    "ACENFAT-KDV         :" ACENFAT-KDV      new-line       
                                    "acenfat-peryod      :" acenfat-peryod   new-line       
                                



                               







           end-if
           if ii = 14
             display message box "Duzeltme Folio'su Acilacaktir." new-line
                                 "Eminmisiniz?"
                             title "Uyari"
                             icon 1
                             type 2
                             default 2 
                             returning return-code 
             if return-code = 2
                exit paragraph 
             end-if 

             perform fat-duz-gonder

           end-if
           if ii=15 then 
              perform fat-sil-gonder
          end-if
           move event-action-fail to event-action        
            
     end-evaluate.
*
fat-duz-gonder. 

                 inquire form2-gd-1,
                      cursor-y in i
             open input konuk konu2  depkod depkod2      
                    inquire form2-gd-1(i,1),
                                 hidden-data in acenfat-anah
            perform duzeltme-folio-bul.
          
           move acenfat-kfolio to konu2-folio
                read konu2 no lock invalid
                        display message box "HATAAA"
                end-read
                move acenfat-folio       to  konuk-folio
                read konuk no lock invalid
                     display message box "HATAAA"
                end-read
                if konuk-git-tar > acenfat-tarih then
                     display message box "Ara City ledgerlara Duzeltme Giremessiniz" title " " 
                    
                else
              initialize depkod-rec  d-cor1 d-cor2
              start depkod key > depkod-anah invalid continue
                     not invalid
                     perform until fs-depkod = "10"
                       read depkod next no lock end move "10" to fs-depkod
                           not end
                            if depkod-kullanma = 1 then
                                  exit perform cycle
                            end-if
                            initialize depkod2-rec
                            move depkod-anah to depkod2-anah
                            read depkod2 no lock invalid 
                                continue
                            not invalid 
                                 if depkod2-isk-dep = 1
                                     exit perform cycle 
                                 end-if 
                            end-read 
                            if depkod-BA = "B" and depkod-turu = 2 
                                  move depkod-anah to d-cor2
                            end-if
                            if depkod-BA = "A" and depkod-turu = 2 
                                  move depkod-anah to d-cor1
                            end-if
                       end-read
                     end-perform
               end-start
                  evaluate true
                    when d-cor1 = 0 
                         display message box "CORRECTION (-) Departmani aciniz"
                    when d-cor2 = 0 
                          display message box "CORRECTION (+) Departmani aciniz"
                    when other 
                        perform acu-screen1-routine
                   end-evaluate
                end-if
                
           close  konuk konu2 depkod  depkod2.

*
screen1-Aft-Initdata.                                
          initialize d-tl romhrk-rec d-dv karislem basislem
         move konu3-folio to romhrk-folio exthrk-folio
         move tarih-tasi to romhrk-tarih exthrk-tarih
         open input romhrk hrk2
         start romhrk key >= romhrk-anah1 invalid continue
            not invalid
              perform until fs-romhrk = "10" 
              read romhrk next no lock end move "10" to fs-romhrk
                  not end
                   if romhrk-folio not = konu3-folio or romhrk-tarih not = tarih-tasi
                      move "10" to fs-romhrk
                      exit perform cycle
                  end-if
                  move romhrk-anah to hrk2-anah
                  read hrk2 no lock invalid
                     exit perform cycle
                    not invalid
                    if hrk2-kaynak-folio = konu2-folio
                       if romhrk-ba = "B" 
                         if romhrk-corr-depkod > 0 then 
                              if  d-tl not = 0 and d-tl not =   romhrk-tl-tutar * ( - 1 )
                                   display message box "uyumsuz karsilik "
                              end-if
                           compute d-tl  = romhrk-tl-tutar * ( - 1 )
                           if karislem not = 0 then 
                              display message box " cift karsilik" 
                           end-if
                           move romhrk-corr-depkod to d-kardep
                           move romhrk-islem to karislem
                           else
                             if  d-tl not = 0 and d-tl not =   romhrk-tl-tutar 
                                display message box "uyumsuz karsilik "
                             end-if
                           compute d-tl  = romhrk-tl-tutar 
                           if basislem not = 0 then 
                              display message box " cift basilan" 
                           end-if
                           move romhrk-depkod to d-basdep
                           move romhrk-islem to basislem
                         end-if
                       else
                           if romhrk-corr-depkod > 0 then 
                              if  d-tl not = 0 and d-tl not =   romhrk-tl-tutar * ( - 1 )
                                   display message box "uyumsuz karsilik "
                              end-if
                           compute d-tl  = romhrk-tl-tutar * ( - 1 )
                           if basislem not = 0 then 
                              display message box " cift basilan" 
                           end-if
                           move romhrk-corr-depkod to d-basdep
                           move romhrk-islem to basislem
                           else
                             if  d-tl not = 0 and d-tl not =   romhrk-tl-tutar 
                                display message box "uyumsuz karsilik "
                             end-if
                           compute d-tl  = romhrk-tl-tutar  
                           move romhrk-depkod to d-kardep
                           if karislem not = 0 then 
                              display message box " cift karsilik" 
                           end-if
                           move romhrk-islem to karislem
                         end-if


                       end-if
                    end-if
                end-read
                end-read
              end-perform 
         end-start
          close romhrk hrk2
           compute d-dv rounded = d-tl / konu2-kur-degeri
          display ad-dv
            display ad-tl ad-kar ad-bas
          if d-tl > 0 then
            
              display ad-tl ad-kar ad-bas
              if d-kardep = 0 or d-basdep = 0 then 
                 display message box "uyumsuzluk"
              end-if

         end-if

     .
*
screen1-Ex-Other.
     if key-status = 27 
       set exit-pushed to true
     end-if
     if key-status = 2 then
        open i-o onkasa romhrk yromhrk hrk2 
         perform har-sil
       
        if d-tl not = 0 then
          perform har-yaz
        end-if
         set exit-pushed to true
          close onkasa romhrk yromhrk hrk2 
     end-if.

*
  har-yaz.
      initialize hata 
     move d-basdep to depkod-anah 
     read depkod no lock invalid
       move 1 to hata 
       not invalid
         if depkod-ba not = "B" then 
               move 1 to hata 
         end-if
           if depkod-turu not = 1 then 
            move 1 to hata
         end-if
     end-read
    move d-kardep to depkod-anah 
     read depkod no lock invalid
       move 1 to hata 
       not invalid
         if depkod-ba not = "A" then 
               move 1 to hata 
         end-if
         if depkod-turu not = 1 then 
            move 1 to hata
         end-if
     end-read
     if hata = 1 then 
        display message box "Uyumsuz duzeltme"
         else
         perform har-yaz2
        
     end-if


     .

*
har-yaz2.
           open i-o genelfis
            move 1 to genelfis-anahtar
            read genelfis no lock invalid
                 initialize genelfis-rec 
                 move 1 to genelfis-anahtar
                 not invalid continue 
            end-read
            add 1 to cekgir-oto
            move cekgir-oto to hrkgir-islem
            add 1 to cekgir-oto
            rewrite genelfis-rec invalid 
                    write genelfis-rec 
                    end-write continue
            end-rewrite
            close genelfis.
              initialize romhrk-rec
              move  konu3-folio    to romhrk-folio
              move  hrkgir-islem   to romhrk-islem
             if d-tl > 0 then 
                  move d-basdep    to romhrk-depkod
                  move "B" to romhrk-ba
                  compute ROMHRK-TL-TUTAR = d-tl
                  compute ROMHRK-dv-TUTAR = d-dv 
               else
                  move d-basdep    to romhrk-corr-depkod
                  move d-cor1      to  romhrk-depkod
                  move "A" to romhrk-ba
                  compute ROMHRK-TL-TUTAR = d-tl * ( - 1 )
                  compute ROMHRK-dv-TUTAR = d-dv * ( - 1 )
             end-if

                 move tarih-tasi to romhrk-tarih
                 move "D" to ROMHRK-ISLEM-TIPI
                 accept romhrk-zaman from time
                   move 1 to ROMHRK-ref
                move k-kodu-tasi to romhrk-staf
                write romhrk-rec invalid stop " "
                end-write
                perform log-operation-romhrk
                move romhrk-anah to hrk2-anah
                move konu2-folio to hrk2-kaynak-folio
                write hrk2-rec invalid stop " "
                end-write
                move romhrk-rec to yromhrk-rec
                 move romhrk-folio to yROMHRK-kaynak-folio 
                 move hrk2-kaynak-folio to yromhrk-folio
                 move k-kodu-tasi to yromhrk-staf
                 write yromhrk-rec invalid stop " "
                 end-write
                  move romhrk-rec to hrkgir-rec
                           if romhrk-corr-depkod > 0 then 
                             perform   onkasa-corr-artir
                              else
                             perform  onkasa-artir
                           end-if
     
                initialize romhrk-rec
              move  konu3-folio    to romhrk-folio
              move  cekgir-oto   to romhrk-islem
             if d-tl > 0 then 
                  move d-kardep    to romhrk-depkod
                  move "A" to romhrk-ba
                  compute ROMHRK-TL-TUTAR = d-tl
                  compute ROMHRK-dv-TUTAR = d-dv 
               else
                  move d-kardep    to romhrk-corr-depkod
                  move d-cor2      to  romhrk-depkod
                  move "B" to romhrk-ba
                  compute ROMHRK-TL-TUTAR = d-tl * ( - 1 )
                  compute ROMHRK-dv-TUTAR = d-dv * ( - 1 )
             end-if

                 move tarih-tasi to romhrk-tarih
                 move "D" to ROMHRK-ISLEM-TIPI
                 accept romhrk-zaman from time
                 move 1 to ROMHRK-ref 
                 move k-kodu-tasi to romhrk-staf
                write romhrk-rec invalid stop " "
                end-write
                perform log-operation-romhrk
                move romhrk-anah to hrk2-anah
                move konu2-folio to hrk2-kaynak-folio
                write hrk2-rec invalid stop " "
                end-write
                move romhrk-rec to yromhrk-rec
                 move romhrk-folio to yROMHRK-kaynak-folio 
                 move hrk2-kaynak-folio to yromhrk-folio
                 move k-kodu-tasi to yromhrk-staf
                 write yromhrk-rec invalid stop " "
                 end-write
                  move romhrk-rec to hrkgir-rec
                           if romhrk-corr-depkod > 0 then 
                             perform   onkasa-corr-artir
                              else
                             perform  onkasa-artir
                           end-if
            move 1 to duz-yapildi.
           

*
har-sil.
            if basislem > 0 then 
              move konu3-folio to romhrk-folio
              move basislem    to romhrk-islem
              read romhrk no lock invalid
                   stop  " " 
                not invalid
                   move romhrk-anah to hrk2-anah
                   read hrk2 no lock invalid
                      stop " "
                      not invalid
                      move hrk2-kaynak-folio to yromhrk-folio
                      move romhrk-islem to yromhrk-islem
                      read yromhrk no lock invalid
                        stop " " 
                          not invalid
                            delete romhrk end-delete
                            delete yromhrk end-delete
                           delete hrk2 end-delete
                            if romhrk-corr-depkod > 0 then 
                             perform   onkasa-corr-eksilt
                              else
                              perform  onkasa-eksilt
                           end-if
                      end-read
                   end-read
              end-read
             end-if
             if karislem > 0 then 
              move konu3-folio to romhrk-folio
              move karislem    to romhrk-islem
              read romhrk no lock invalid
                   stop  " " 
                not invalid
                   move romhrk-anah to hrk2-anah
                   read hrk2 no lock invalid
                      stop " "
                      not invalid
                      move hrk2-kaynak-folio to yromhrk-folio
                      move romhrk-islem to yromhrk-islem
                      read yromhrk no lock invalid
                        stop " " 
                          not invalid
                            delete romhrk end-delete
                            delete yromhrk end-delete
                           delete hrk2 end-delete
                           move romhrk-rec to hrkgir-rec
                           if romhrk-corr-depkod > 0 then 
                               perform   onkasa-corr-eksilt
                              else
                              perform  onkasa-eksilt
                           end-if
                      end-read
                   end-read
        
              end-read
             end-if.

*
onkasa-artir.
        initialize onkasa-rec
       move hrkgir-tarih    to onkasa-tarih.
       move hrkgir-depkod   to onkasa-dep.
       read onkasa no lock invalid 
            compute onkasa-tutar-tl   = onkasa-tutar-tl + hrkgir-tl-tutar
            compute onkasa-tutar-dv   = onkasa-tutar-dv + hrkgir-dv-tutar
               write onkasa-rec invalid   continue
             end-write
            not invalid 
            compute onkasa-tutar-tl   = onkasa-tutar-tl + hrkgir-tl-tutar
            compute onkasa-tutar-dv   = onkasa-tutar-dv + hrkgir-dv-tutar
               rewrite onkasa-rec invalid 
                  continue
              end-rewrite

       end-read
                  .
      

*/CORRECTION

onkasa-corr-artir.
       initialize onkasa-rec
       move hrkgir-tarih              to onkasa-tarih.
       move hrkgir-corr-depkod        to onkasa-dep.
       read onkasa no lock invalid 
            initialize onkasa-rec
            move hrkgir-tarih         to onkasa-tarih
            move hrkgir-corr-depkod   to onkasa-dep
       end-read.
       compute onkasa-corr-tutar-tl = onkasa-corr-tutar-tl + hrkgir-tl-tutar.
       compute onkasa-corr-tutar-dv = onkasa-corr-tutar-dv + hrkgir-dv-tutar.
       rewrite onkasa-rec invalid 
               write onkasa-rec end-write
       end-rewrite.


*
onkasa-eksilt.
       initialize onkasa-rec
       move calisma-tarihi    to onkasa-tarih.
       move hrkgir-depkod        to onkasa-dep.
       read onkasa no lock invalid 
          continue
       end-read.
       compute onkasa-tutar-tl   = onkasa-tutar-tl - hrkgir-tl-tutar.    
       compute onkasa-tutar-dv   = onkasa-tutar-dv - hrkgir-dv-tutar.    
       rewrite onkasa-rec invalid continue.


*/CORRECTION
onkasa-corr-eksilt.
       move hrkgir-tarih              to onkasa-tarih.
       move hrkgir-corr-depkod        to onkasa-dep.
       read onkasa no lock invalid 
            continue
       end-read.
       compute onkasa-corr-tutar-tl   = onkasa-corr-tutar-tl - hrkgir-tl-tutar.    
       compute onkasa-corr-tutar-dv   = onkasa-corr-tutar-dv - hrkgir-dv-tutar.    
       rewrite onkasa-rec invalid 
               write onkasa-rec end-write
       end-rewrite.

*
duzeltme-folio-bul. 
         move 0 to bulundu
         initialize konuk-rec
         move "H" to konuk-durumu
         move tarih-tasi to konuk-git-tar
         start konuk key >= konuk-git invalid 
               continue
               not invalid
               perform until fs-konuk = "10" 
                 read konuk next no lock end move "10" to fs-konuk
                     not end
                      if konuk-git-tar not = tarih-tasi or konuk-durumu not = "H"
                           move "10" to fs-konuk
                           exit perform cycle
                      end-if
                     if konuk-duzeltme not = 1 then 
                           exit perform cycle
                     end-if
                     if konuk-al-tar not = ilk-tarih(3:)
                          exit perform cycle
                     end-if
                     move 1 to bulundu
                        move konuk-rec to konu3-rec
                end-read
              end-perform 
         end-start.
         if bulundu = 0 then 
           perform duzeltme-ac
             move konuk-rec to konu3-rec
        end-if  .
  
*
duzeltme-ac.
      close konuk
      open i-o konuk rez cast
      initialize rez-rec  konuk-rec


                  open i-o genelfis
             move 1 to genelfis-anahtar
             read genelfis no lock invalid  stop " "





             not invalid
               add 1 to rez-oto
               add 1 to folio-oto
                  move rez-oto to rez-no 
                  rewrite genelfis-rec end-rewrite
             end-read .
           close genelfis
         

         move rez-oto to REZ-NO         
         move 1 to  REZ-TIPI  konuk-rez-tipi           

          move "I" to REZ-DURUMU    

         
             
             move tarih-tasi to  REZ-GIR-TAR  rez-cik-tar konuk-gel-tar konuk-git-tar
        move ilk-gun to  egun
        move ilk-ay  to eay
        move ilk-yil to eyil
        move etarih to  REZ-ADI  konuk-adi   
          move "FAT FARKLARI " to  REZ-ADI(10:)  konuk-adi(10:) 
  
                move ilk-gun to  egun
                move ilk-ay  to eay
                move ilk-yil to eyil
                move etarih to  REZ-ADI  konuk-adi   
          move  "C/L DUZELTMELERI" to REZ-soyadi  konuk-soyadi  
          move rezpara-banka          to rez-banka   konuk-banka.
             move rezpara-doviz       to rez-doviz       konuk-doviz           .
             move rezpara-pan-tipi    to rez-pan-tipi    konuk-pan-tipi      .
             move rezpara-odeme-tipi  to rez-odeme-tipi  konuk-odeme-tipi      .
             move rezpara-ulke        to rez-ulke        konuk-ulke           .
             move rezpara-anlasma     to rez-anlasma     konuk-anlasma       .
             move rezpara-pazar       to rez-pazar       konuk-pazar       .
             move rezpara-aygun       to rez-kur-aygun   konuk-kur-aygun     .
          

          move "K" to  REZ-K-G-B    
          move "N" to rez-vip   konuk-vip

          move "E"                  to rez-c-in
          move folio-oto to  REZ-FOLIO   KONUK-FOLIO 

          move "9998" to REZ-ODANO  konuk-odano 

       
          move "01" to  REZ-ODA-KONUMU   REZ-FIYAT-KONUMU    konuk-ODA-KONUMU   konuk-FIYAT-KONUMU      
         move tarih-tasi to  REZ-ISL-TAR.
            
          move ilk-tarih to  REZ-AL-TAR 
          move ilk-tarih(3:) to konuk-al-tar
          move 1 to    KONUK-KUR-DEGERI 
          move k-kodu-tasi to REZ-STAF KONUK-STAF         
      
          move "H" to KONUK-DURUMU   

          move "R" to  KONUK-FOL-KODU    
         
         
          move rez-no to KONUK-REZ-NO 
         
          move acenta-kodu to  KONUK-ACENTA rez-acenta
          
          move 1 to konuk-duzeltme    
        

          accept rez-edit-tarih from century-date  |firat amonra için konuldu 03/11/2020
          accept rez-edit-zaman from time          |                           

          write rez-rec invalid 
              stop " "
          not invalid
              write konuk-rec
                invalid 
                   stop" " 
              end-write
          end-write
              initialize cast-rec
                  move tarih-tasi to cast-tarih
                  move rez-no to cast-rez-no
                  move rez-odano        to cast-oda-no
                   move rez-buyuk        to cast-buyuk
                   move rez-kucuk        to cast-kucuk
        
                   move rez-bebek        to cast-bebek
                   move rez-free         to cast-free
                   move rez-oda-konumu   to cast-oda-konumu
                   move rez-fiyat-konumu to cast-fiyat-konumu
                   move rez-anlasma      to cast-anlasma
                   move rez-pan-tipi     to cast-pan-tipi
              write cast-rec invalid stop " " end-write

                display message box "Duzeltme Foliosu acildi"

                    open i-o romhrk yromhrk hrk2

                     initialize romhrk-rec
              move  konuk-folio    to romhrk-folio
              move  cekgir-oto   to romhrk-islem
            
                   move onkpara-city-ledger      to romhrk-depkod
                  move "B" to romhrk-ba
                  compute ROMHRK-TL-TUTAR = 0
                  compute ROMHRK-dv-TUTAR = 0
            

                 move rez-al-tar to romhrk-tarih
                 move "D" to ROMHRK-ISLEM-TIPI
                 accept romhrk-zaman from time
               move 1 to ROMHRK-ref
                move k-kodu-tasi to romhrk-staf
                write romhrk-rec invalid stop " "
                end-write
                perform log-operation-romhrk
                move romhrk-anah to hrk2-anah
                move konuk-folio to hrk2-kaynak-folio
                write hrk2-rec invalid stop " "
                end-write
                move romhrk-rec to yromhrk-rec
                 move romhrk-folio to yROMHRK-kaynak-folio 
               
                 write yromhrk-rec invalid stop " "
                 end-write
                  move romhrk-rec to hrkgir-rec
                          
              close  romhrk yromhrk hrk2


         



      close konuk rez cast
      open input konuk
     .

*
fat-sil-gonder.
            inquire  form2-gd-1(i,ii),
                      cell-data in link-fat-no
                       call "/asya/ytl/obj/otel/fatiptal.asy" 
                    using  link-fat-no fat-tarih
                    on exception 
                     perform callerr-proc
                     exit paragraph
                    not on exception 
                     cancel "/asya/ytl/obj/otel/fatiptal.asy"
                  end-call

 
 
 
           .
*
Form2-Gd-1-Ex-Other.
                  inquire form2-gd-1,
                      cursor-y in i
                      
                    inquire form2-gd-1(i,1),
                                 hidden-data in acenfat-anah
      evaluate key-status 
              when 664
                 perform detay-liste-ver
              when  4 
              perform fattop-toplam-al
               when 3 
               when 2
                 perform Form2-Ex-Other
               WHEN 12 
               DiSPLAY MESSAGE BOX acenfat-anah
                 when 6
                 
                
                   if acenfat-folio > 0 then 
                    call "/asya/ytl/obj/otel/folio.asy" 
                    using  acenfat-folio
                    on exception 
                     perform callerr-proc
                     exit paragraph
                    not on exception 
                     cancel "/asya/ytl/obj/otel/folio.asy"
                  end-call
                    end-if
              when 11
                   if acenfat-kfolio > 0 then 
                    call "/asya/ytl/obj/otel/kfolio.asy" 
                    using  acenfat-kfolio
                    on exception 
                     perform callerr-proc
                     exit paragraph
                    not on exception 
                     cancel "/asya/ytl/obj/otel/kfolio.asy"
                  end-call
                    end-if
              when 18
                   if acenfat-kfolio > 0 then 
                     move acenfat-kfolio to konuk-folio
                     open input konuk
                     read konuk no lock invalid continue
                        not invalid
                          if konuk-rez-no > 0 then 
                        call "/asya/ytl/obj/otel/rez.asy" 
                          using  konuk-rez-no
                        on exception 
                              perform callerr-proc
                             exit paragraph
                          not on exception 
                        cancel "/asya/ytl/obj/otel/rez.asy"
                        end-call
                        end-if
                      end-read
                      close konuk
                    end-if
               when 16
                   if acenfat-kfolio > 0 then 
                     move acenfat-kfolio to konuk-folio
                     open input konuk
                     read konuk no lock invalid continue
                        not invalid
                          if konuk-rez-no > 0 then 
                        call "/asya/ytl/obj/otel/profat.asy" 
                          using   konuk-folio   konuk-rez-no
                        on exception 
                              perform callerr-proc
                             exit paragraph
                          not on exception 
                        cancel "/asya/ytl/obj/otel/profat.asy"
                        end-call
                        end-if
                      end-read
                      close konuk
                    end-if
            end-evaluate
     .
*
Form2-Bef-Create.
     move 4 to m
     if genel-kaya-otelleri  and  v-comboefat(1:1) not = "E" 
       move 1 to ear-vis e-arsiv-var-mi
     else
       move 0 to ear-vis e-arsiv-var-mi
     end-if
     open i-o acenfat.
*
Form2-Aft-Routine.
    close takaskdv deptop.
    open input acenfat
    perform raporla
    exit paragraph .
     
    

acenfat-yaz.
    
     rewrite acenfat-rec invalid
             
               display message box 
                     "Kayit duzeltilemedi ..."
                     icon mb_error_icon
                     title "Hata",
     end-rewrite.
     
 acenta-ara.
      initialize acenta-cagir.
      call "/asya/ytl/obj/otel/acenara.asy" using acenta-cagir
            on exception perform callerr-proc
               not on exception
               cancel "/asya/ytl/obj/otel/acenara.asy" 
       end-call.
       move acenta-cagir     to rapor-acenta.
       display  acc-acenta.
acenta-oku.
       initialize gec-gecme.
       move "Tum Acentalar"      to adi-goster
       display lb-acenta-adi.
       if rapor-acenta not = spaces
          open input acenta
          initialize acenta-rec
          move rapor-acenta   to acenta-kodu
          read acenta        no lock invalid 
               move 1        to gec-gecme
               display message box "Acenta Kodu Tanimsiz.."
               move 4    to accept-control
               move 12 to control-id
               not invalid continue 
          end-read
          close acenta
          move acenta-adi     to adi-goster
          display lb-acenta-adi
       end-if.
anlasma-ara.
         initialize infox-cagir
         move "D"   to infox-tipi-cagir
         call "/asya/ytl/obj/otel/infoxara.asy" using infox-cagir
            on exception perform callerr-proc
               not on exception
         cancel "/asya/ytl/obj/otel/infoxara.asy" 
         end-call
         move infox-kodu-cagir     to rapor-anlasma
         display acc-anlasma.
anlasma-oku.
       initialize gec-gecme.
       move "Tum Anlasmalar"      to adi-goster-anlasma
       display lb-anlasma-adi.
       if rapor-anlasma not = spaces
          open input kodlar02
          initialize kodlar02-rec
          move rapor-anlasma   to kodlar02-kodu
          move "D"             to kodlar02-tipi
          read kodlar02        no lock invalid 
               move 1        to gec-gecme
               display message box "Acenta Kodu Tanimsiz.."
               move 4    to accept-control
               move 12 to control-id
               not invalid continue 
          end-read
          close kodlar02
          move kodlar02-adi     to adi-goster-anlasma
          display lb-anlasma-adi
       end-if.
firma-ara.
      initialize firma-cagir.
      call "/asya/ytl/obj/otel/firmara.asy" using firma-cagir
            on exception perform callerr-proc
               not on exception


               cancel "/asya/ytl/obj/otel/firmara.asy" 
       end-call.
       move firma-cagir     to rapor-firma.
       display  acc-firma.
firma-oku.
       initialize gec-gecme.
       move "Tum Firmalar"      to adi-goster-firma
       display lb-firma-adi.
       if rapor-firma not = spaces
          open input firma
          initialize firma-rec
          move rapor-firma   to firma-kodu
          read firma        no lock invalid 
               move 1        to gec-gecme
               display message box "Firma Kodu Tanimsiz.."
               move 4    to accept-control
               move 12 to control-id
               not invalid continue 
          end-read
          close firma
          move firma-adi     to adi-goster-firma
          display lb-firma-adi
       end-if.


     .
*
Form2-Ex-Other. 
     move fat-tarih  to muhasebe-tar
     perform muhasebe-entegre-kontrol
     if muh-isl-durdur = 1 
        exit paragraph
     end-if
     if key-status = 3 or 2 then
        if duz-yapildi = 1 then 
           display message box " Duzeltmeler aktif olmasi icin onceki menuye donmelisiniz"
           exit paragraph
        end-if
        if cfat-no not > 0 then 
           display message box "Lutfen  Fatura no giriniz "
           exit paragraph
        end-if
        if fat-gun = 0 then  
           display message box "     " new-line 
                               "Faturatarihi 0 olamaz."new-line
                         title "Uyari"
                          icon 1
           exit paragraph
        end-if
        if key-status = 3
           move 3 to key-status2
           display message box "   !!! T E S T !!!   " new-line 
                               "Faturalar Kesilecektir."new-line
                               "Eminmisiniz.?"
                         title "Uyari"
                          icon 1
                          type 2
                       default 2
                     returning return-code 
           if return-code = 2
              exit paragraph
           end-if 
        else
           move 2 to key-status2
           display message box "Faturalar Kesilecektir."new-line
                                   "Eminmisiniz.?"
                               title "Uyari"
                               icon 1
                               type 2
                               default 2
                               returning return-code 
           if return-code = 2
              exit paragraph
           end-if 
           
        end-if
        move 0 to fattar-en
        display acc-ilk-guna acc-ilk-aya acc-ilk-yila
        if cb-yazici-tipi(1:1) not = "S"
           perform yazici-sor
        end-if 
        perform fatlar-olussun 
        move 1 to fattar-en
        display acc-ilk-guna acc-ilk-aya acc-ilk-yila
             
***           perform kayit-kontrol            
        set exit-pushed to true  
        exit paragraph
     end-if
     .
*
 fatlar-olussun.

      open i-o acenfat fatura gerfat romhrk exthrk  konuk FATDETAY    fatdetayek
      open input musteri doviz konu2 hrk2 yromhrk depkod acenta konum cari rez kodlar02 depkod2  odalar
        accept omitted before time 0 
           open i-o fatdokum
       inquire  form2-gd-1,
                       LAST-ROW in satir-say
        initialize i sonfat-sira formatlar det-ara-rec  fat-sira
         close takaskdv deptop
                    open output takaskdv deptop close takaskdv deptop open i-o takaskdv deptop
       perform varying bu-satir from 2 by 1 until bu-satir > satir-say
           initialize ykonuk-gel-tar
         accept omitted before time 0
           inquire  form2-gd-1(bu-satir,1),
                       hidden-data in acenfat-anah
                       cell-data in fat-sira
           accept omitted before time 0
              if fat-sira > 0 then 
                 if sonfat-sira = 0 then 
                    move fat-sira to sonfat-sira
                    move 0        to fat-ekle
                    move 0        to fat-ok
                    perform until fat-ok = 1
                       add 1 to fat-ekle
                       perform fat-kont
                       if fat-hata = 1
                          exit paragraph 
                       end-if 
                       if fat-ok = 0 and fat-ekle > 2
                          exit paragraph
                       end-if
                    end-perform
                 end-if
                 if sonfat-sira not = fat-sira then 
                    initialize fatdokum-rec
                    accept fatdokum-tarih from century-date
                    accept fatdokum-zaman from time
                    move fat-no             to fatdokum-fat-no
                    evaluate cb-yazici-tipi(1:1)
                        when "A"
                             initialize k 
                             perform varying k 
                                   from 1
                                     by 1
                                     until k > m
                                           perform fat-bas2        
                             end-perform
                        when "S"
                             perform fat-bas
                    end-evaluate 
                 
                    if key-status2 = 2                  
                       accept omitted before time 0
                       perform fattop-yaz
                    end-if
                    move fat-sira to sonfat-sira
                    move 0 to fat-ok
                    perform until fat-ok = 1 
                       add 1 to fat-ekle
                       perform fat-kont
                       if fat-hata = 1                        
                          exit paragraph 
                       end-if
                       if fat-ok = 0 and fat-ekle > 20
                          exit paragraph
                       end-if
                    end-perform
                    initialize i det-ara-rec formatlar
                    close takaskdv deptop
                    open output takaskdv deptop close takaskdv deptop open i-o takaskdv deptop 
                 end-if
                 add 1 to i
                 read acenfat no lock invalid 
                      stop " "
                 end-read
                
                 inquire form2-gd-1(bu-satir,8)
                         cell-data in det-ara-cari(i)
                 move acenfat-kfolio to konuk-folio 
                 read konuk no lock invalid
                      display message box "Konuk Bulunamadi" title "x"
                 end-read
                 move konuk-gel-tar  to ykonuk-gel-tar
                 if konuk-gec-giris > 0 then  
                    perform takvim-onceki-oku2
                 end-if
                 move acenfat-kdv to det-ara-kdv(i)
             ||     stop " " 
                 move   acenfat-kv-matrah    to  det-ara-kv-matrah(i)   
                 move   ACENFAT-MATRAH8      to det-ara-kdv8-matrah(i)   
                 move   ACENFAT-MATRAH18    to   det-ara-kdv18-matrah(i) 
                     
                 move   acenfat-kv     to  det-ara-kv-tutar(i)            
                 move   ACENFAT-KDV8    to    det-ara-kdv8-tutar(i)         
                 move   ACENFAT-KDV18     to      det-ara-kdv18-tutar(i)                                 
                                                  
                                                    
                                                    
                                                       
                                                   







                 if acenfat-har-depkod not = high-values
                    move   acenfat-har-depkod to  det-ara-har-depkod(i)
                 else
                    initialize det-ara-har-depkod(i)
                 end-if
                 if acenfat-peryod = 0 
                    move ykonuk-gel-tar  to  det-ara-girtar(i)
                    move konuk-git-tar  to  det-ara-ciktar(i)
                    move konuk-adi to  det-ara-adi(i)     
                    move konuk-soyadi to  det-ara-soy(i)    
                    if konuk-rez-no > 0 then 
                       initialize rez-rec
                       move konuk-rez-no to rez-no
                       read rez no lock invalid 
                            continue
                       end-read
                       if rez-gel-sirket not  = spaces then 
                          move "*" to   det-ara-adi(i)(1:)     
                          move konuk-adi      to        det-ara-adi(i)(2:)     
                       end-if
                       if rez-git-sirket  not  = spaces then 
                          move "*"    to det-ara-soy(i)(1:)   
                          move konuk-soyadi to det-ara-soy(i) (2:)  
                       end-if
                       move rez-no         to det-ara-rez-no(i)
                    end-if
                    move konuk-odano    to  det-ara-oda(i) 
                    if konuk-voucher = spaces or konuk-voucher = konuk-folio then
                       move "Oda:"  to   det-ara-voucher(i)(1:4) 
                       move konuk-odano    to   det-ara-voucher(i)(5:4) 
                    else
                       move rez-voucher(1:20) to  det-ara-voucher(i)
*                       move konuk-voucher to  det-ara-voucher(i) |fat satir aciklamasinda eksik gorunuyordu rez-voucher alindi firat 20/10/2020
                    end-if
                 end-if  
                 move konuk-doviz      to det-ara-kur-kod(i)  
                 move konuk-pan-tipi  to  det-ara-pan-kod(i)  
                 move konuk-buyuk     to  det-ara-buyuk(i) 
                 move acenfat-acenta to  det-ara-acenta(i) 
                 move konuk-kucuk     to  det-ara-kucuk(i)
                 move konuk-folio    to  det-ara-folio(i)
                 move 1              to  det-ara-adet(i)     
                 move konuk-kur-degeri to det-ara-kuru(i) 
                 move acenfat-tl-tutar  to  det-ara-tl-tut(i)
                 move konuk-banka      to  det-ara-banka(i)  
                 move ACENFAT-KDV       to DET-ARA-KDV-ORAN(i)

                 move   acenfat-kv-matrah    to  det-ara-kv-matrah(i)   
                 move   ACENFAT-MATRAH8      to det-ara-kdv8-matrah(i)   
                 move   ACENFAT-MATRAH18    to   det-ara-kdv18-matrah(i) 
                     
                 move   acenfat-kv     to  det-ara-kv-tutar(i)            
                 move   ACENFAT-KDV8    to    det-ara-kdv8-tutar(i)         
                 move   ACENFAT-KDV18     to      det-ara-kdv18-tutar(i)          


                 move acenfat-bos to det-ara-acenfat-bos(i)
                 move acenfat-per-geceleme to det-ara-geceleme(i)
                 move function numval(acenfat-op)  to det-ara-referans(i)
                 if acenfat-tip not = "2" then 
                    move 0 to det-ara-geceleme(i)
                 end-if

                 initialize musteri-rec
                 move acenfat-profil   to det-ara-profil(i) |m-profil     |firat m-profil bos geliyordu 17/08/2020  
                 move acenfat-p-sirket to musteri-sirket         
                 move acenfat-p-no     to musteri-no
                 if musteri-no not numeric
                    move "999999992" to musteri-no
                 end-if
                  initialize musteri-rec
                 read musteri no lock invalid
                      move acenfat-acenta to acenta-kodu
                      read acenta no lock invalid
                           continue
                      not invalid
                          if ACENTA-MUHNO2 = spaces
                             move acenta-muhno to cari-kodu
                          else
                             move acenta-muhno2 to cari-kodu
                          end-if
                          move ACENFAT-sirket to konu2-firma 
                          open input firma
                          perform firma-oku-getir
                          close firma
                          move ACENFAT-sirket to det-ara-firma(i)
                          read cari no lock invalid
                               initialize cari-rec
                          end-read,
                          perform varying ix from 1 by 1 until ix > 18
                             if c-vergi-no(ix:1) = spaces then 
                                move  c-vergi-no(ix + 1 :) to c-vergi-no(ix :) 
                                move  " " to c-vergi-no(20:1)
                             end-if
                          end-perform 
                          move c-unvan-1      to  musteri-unvan1(1:40)       
                          move c-unvan-2      to  musteri-unvan2(1:40)       
                          move c-adres-1      to  musteri-adres1 (1:40)      
                          move c-adres-2      to  musteri-adres2 (1:40)      
                          move c-il-ilce      to  musteri-ilce(1:20)         
                          move c-ulke(1:14)   to  musteri-il(1:14)           
                          move c-vergi-daire  to musteri-vdairesi (1:20)    
                          move c-vergi-no     to musteri-vno
                          move c-email        to musteri-e-mail                               
                      end-read
                  not invalid
                      move musteri-vno  to c-vergi-no         
                  end-read
                  add acenfat-tl-tutar to top-TL-TUTAR 
                  initialize takaskdv-rec
                  move acenfat-kdv to takaskdv-oran 
                  read takaskdv no lock invalid 
                       continue
                  end-read
                         
                  compute tek-matrah rounded =

                  (ACENFAT-TL-TUTAR / ( 1 + ((acenfat-kdv + acenfat-kv-orani) / 100 ) ) )

                  compute tek-kv rounded = tek-matrah * ( acenfat-kv-orani / 100 )

                   compute tek-kdv rounded = tek-matrah * ( acenfat-kdv / 100 )

                     compute tek-matrah =   ACENFAT-TL-TUTAR - tek-kv - tek-kdv
                     if    (acenfat-kv-orani = 0)
                     move 0 to tek-kv-matrah
                     else
                     move tek-matrah to tek-kv-matrah
                     end-if

                  compute    takaskdv-kv-matrah  =  takaskdv-kv-matrah +  tek-kv-matrah
                  compute     takaskdv-kv = takaskdv-kv + tek-kv


                  compute takaskdv-kdv rounded = takaskdv-kdv + tek-kdv
                  compute  takaskdv-matrah = takaskdv-matrah +  tek-matrah
                         
     
                  write takaskdv-rec invalid rewrite takaskdv-rec end-write

                  add       acenfat-kv-matrah   to top-kv-matrah
                   add       acenfat-kv          to top-kv

                  if kdv-yok not = 1
                     add  ACENFAT-GER-DV-TUTAR   to   top-GER-DV-TUTAR 
                     add  ACENFAT-GER-TL-TUTAR   to   top-GER-TL-TUTAR 
                     if acenfat-kdv = 1
                        add  ACENFAT-MATRAH8        to   top-MATRAH1      
                     else
                        add  ACENFAT-MATRAH8        to   top-MATRAH8      
                     end-if 

                     add  ACENFAT-MATRAH18       to   top-MATRAH18     
                     if acenfat-kdv = 1
                        add  ACENFAT-KDV8           to   top-KDV1 
                     else
                        add  ACENFAT-KDV8           to   top-KDV8                           
                     end-if 
                     add  ACENFAT-KDV18          to   top-KDV18 
                  else
                     add  ACENFAT-GER-DV-TUTAR   to   top-GER-DV-TUTAR 
                     add  ACENFAT-GER-TL-TUTAR   to   top-GER-TL-TUTAR              
                     if acenfat-kdv = 1
                         compute top-MATRAH1 = top-MATRAH1 + ACENFAT-MATRAH8 + ACENFAT-KDV8 
                     else
                         compute top-MATRAH8 = top-MATRAH8 + ACENFAT-MATRAH8 + ACENFAT-KDV8 
                     end-if  
                     compute top-MATRAH18 = top-MATRAH18 + ACENFAT-MATRAH18 +  ACENFAT-KDV18                       
                  end-if 
                  move acenfat-folio to konu2-folio
                   if konuk-eb = "E" then
                    move " E/B"        to DET-ara-soy(i)(7:)
                   end-if 
  

                    read konu2 no lock invalid continue
                    end-read
                 
                    if key-status2 = 2
                          perform fatara-yaz
                    end-if
              end-if
       
       end-perform .
   
        if i > 0 then 
                    evaluate cb-yazici-tipi(1:1)
                    when "A"
                            initialize k 
                            perform varying k 
                                     from 1
                                     by 1
                                     until k > m
                                            perform fat-bas2
        
                            end-perform
                    when "S"
                       perform fat-bas
                    end-evaluate           

          if key-status2 = 2
             perform fattop-yaz
          end-if
        end-if
          close fatdokum
       close acenfat FATDETAY   fatdetayek
       close musteri konuk doviz fatura konum gerfat yromhrk romhrk exthrk  odalar
             konu2 hrk2 depkod acenta cari rez kodlar02 depkod2.
*
fat-kont.
         compute fat-no = cfat-no + fat-ekle - 1

     initialize fatura-rec
     move fat-no       to fatura-no
     move 0                    to fatura-sira
     read fatura no lock invalid
          display message box 
                  fat-no," seri numarali fatura tanimlamasi yapilmamis"
                  icon mb_error_icon
                  title "Hata"
                  move 1 to fat-hata
          exit paragraph
          
         not invalid
     evaluate fatura-durumu
     when "I"
        display message box 
                fat-no," numarali fatura iptal edilmis !" new-line
                       "Lutfen Farkli Fatura Numarasi Giriniz."
                icon mb_error_icon
                title "Hata"
        move 1 to fat-hata
        exit paragraph

     when "D"
        display message box 
                fat-no," seri numarali fatura daha once kesilmis !",
                new-line,
                new-line,
                "Kesilmis fatura Bilgileri"
                new-line,
                "Fatura Tarihi :",x"09",fatura-gun,"/"fatura-ay,"/",fatura-yil
                new-line,
                "Folio :",x"0909",fatura-folio,
                new-line,
                fatura-baslik-1, new-line,
                fatura-baslik-2, new-line,
                "Adres 1 :", x"09",fatura-adres-1,  new-line,
                "Adres 2 :", x"09",fatura-adres-2,  new-line,
                "Il :",      x"09",fatura-il,       new-line,
                "Ilce :",    x"09",fatura-ilce,     new-line,
                "Ulke :",    x"09",fatura-ulke,     new-line,
                "Vergi D.:", x"09",fatura-ver-da,   new-line,
                "Vergi N. :",x"09",fatura-ver-no    new-line new-line
                
           exit paragraph
        
                
     end-evaluate
     end-read
    
     move 1 to fat-ok.    
    

fat99-yaz.
     initialize fatura-rec
    move fat-no                    to fatura-no
    move 999                          to fatura-sira
    read fatura no lock invalid
       continue
     end-read
         string fatura-aciklama delimited by "  "
              konuk-folio delimited by size
              into 
                 fatura-aciklama
           end-string
   
    write fatura-rec invalid
          rewrite fatura-rec end-rewrite
    end-write .
*/
fatara-yaz.
      perform fat99-yaz.
       move fat-no                    to fatura-no
       move i                         to fatura-sira
        move fat-tarih                to fatura-tarihi
    move "A"                          to fatura-tipi
    move "D"                          to fatura-durumu
    move konu2-folio                  to fatura-folio
    move musteri-unvan1                    to fatura-baslik-1 
    move musteri-unvan2                    to fatura-baslik-2 
    move musteri-adres1                    to fatura-adres-1  
    move musteri-adres2                    to fatura-adres-2
    move musteri-vdairesi                  to fatura-ver-da   
    move musteri-vno                       to fatura-ver-no 
    move musteri-e-mail                    to fatura-e-mail

        move musteri-il               to fatura-il
    move musteri-ilce             to fatura-ilce
        MOVE musteri-fat-ulke             TO FATURA-ULKE
 

    if musteri-tel1 not = spaces
       move musteri-tel1    to fatura-telefon
    end-if
    if musteri-tel2 not = spaces
       move musteri-tel2    to fatura-telefon
    end-if
    if musteri-tel3 not = spaces
       move musteri-tel3    to fatura-telefon
    end-if
    if musteri-gsm not = spaces
       move musteri-gsm    to fatura-telefon
    end-if 
    move k-kodu-tasi                  to fatura-staf
    move ACENFAT-TL-TUTAR             to fatura-toplam   fatura-g-toplam
    move ACENFAT-MATRAH8              to fatura-matrah-8  
    move ACENFAT-MATRAH18             to fatura-matrah-18  
    move ACENFAT-KDV8                 to fatura-kdv-8   
    move ACENFAT-KDV18                to fatura-kdv-18
    move cari-kodu to fatura-e-cari
       compute fatura-matrah = fatura-matrah-8     + fatura-matrah-18 
       compute fatura-kdv = fatura-kdv-8    + fatura-kdv-18     
     perform fatfol-yaz.
      open i-o genel
    initialize genel-rec
    move 1                to genel-anahtar
    read genel no lock invalid 
       continue 
    not invalid 
     if v-comboefat(1:1) = "E" 
         move  fat-no  to genel-eacen-fat-no
         else
         move  fat-no  to genel-acen-fat-no
     end-if
      rewrite genel-rec end-rewrite 
      end-read.
      close genel

         .
*
fattop-yaz.
    move fat-no                to fatura-no
    move 0                     to fatura-sira
    read fatura no lock invalid
         continue
    end-read
    
    move fat-tarih                to fatura-tarihi
    move "A"                      to fatura-tipi
    move "D"                      to fatura-durumu
   
    move musteri-unvan1           to fatura-baslik-1 
    move musteri-unvan2           to fatura-baslik-2 
    move musteri-adres1           to fatura-adres-1  
    move musteri-adres2           to fatura-adres-2
    move musteri-vdairesi         to fatura-ver-da   
    move musteri-vno              to fatura-ver-no 
    move musteri-e-mail           to fatura-e-mail

    move musteri-il               to fatura-il
    move musteri-ilce             to fatura-ilce
    MOVE musteri-fat-ulke         to FATURA-ULKE
 
    if musteri-tel1 not = spaces
       move musteri-tel1    to fatura-telefon
    end-if
    if musteri-tel2 not = spaces
       move musteri-tel2    to fatura-telefon
    end-if
    if musteri-tel3 not = spaces
       move musteri-tel3    to fatura-telefon
    end-if
    if musteri-gsm not = spaces
       move musteri-gsm    to fatura-telefon
    end-if 
**    move rap-telefon              to fatura-telefon
    move k-kodu-tasi              to fatura-staf
    move top-TL-TUTAR             to fatura-toplam   fatura-g-toplam
    move top-MATRAH1              to fatura-matrah-1  
    move top-MATRAH8              to fatura-matrah-8  
    move top-MATRAH18             to fatura-matrah-18
    move top-KDV1                 to fatura-kdv-1  
    move top-KDV8                 to fatura-kdv-8   
    move top-KDV18                to fatura-kdv-18
    move top-kv-matrah to      FATURA-KV-MATRAH

      move top-kv to      FATURA-KV       
       compute fatura-matrah = fatura-matrah-8 + fatura-matrah-18  + fatura-matrah-1
       compute fatura-kdv    = fatura-kdv-8    + fatura-kdv-18  +  fatura-kdv-1  
     move  v-comboefat(1:1) to fatura-e-tipi
      move cari-kodu to fatura-e-cari

    if e-arsiv-var-mi = 1  then
    initialize gerfat-rec   
    move fatura-anah to gerfat-anah
    read gerfat no lock invalid 
      continue 
    end-read
    
       MOVE  gerfat-onek   TO  rap-ger-seri
       MOVE   gerfat-gerfatno   TO   rap-ger-no
       display acc-ger-seri acc-ger-no
    move fatura-durumu to    gerfat-durumu
    move fatura-tarihi to gerfat-fat-tar
        move rap-ger-no to FATURA-GERCEK-FAT gerfat-gerfatno
         move rap-ger-seri to  fatura-onek  gerfat-onek    
        move 1 to fatura-no-alindi gerfat-no-alindi
    
         write gerfat-rec invalid 
          rewrite gerfat-rec end-rewrite
        end-write
    
    end-if

     write fatura-rec invalid 
          rewrite fatura-rec end-rewrite
    end-write  .




*
deptop-yaz.


          initialize deptop-rec 
          move romhrk-depkod     to deptop-depkod(1:3)
                if yromhrk-kk-onay-kodu not = spaces 
                   move yromhrk-kk-onay-kodu  to deptop-depkod(4:)
                   move 2                     to deptop-dovizli|onay kodu
                else
                   if yromhrk-doviz-kodu > 0
                      initialize doviz-rec 
                      move yromhrk-doviz-kodu to doviz-kodu
                      read doviz no lock invalid 
                           continue 
                      not invalid 
                           move d-kisa-adi    to deptop-depkod(4:)
                           move 1             to deptop-dovizli
                      end-read                        
                   end-if 
                end-if 
          move romhrk-ba                      to deptop-ba
          read deptop no lock invalid 
              if DEPKOD-TURU = 2 then             
                 initialize depkod-rec deptop-rec 
                 move ROMHRK-CORR-DEPKOD to depkod-anah deptop-depkod   
                 read depkod no lock invalid
                     continue
                 end-read
                     move depkod-ba  to deptop-ba
                     read deptop no lock invalid 
                        continue                     
                     end-read 
                     move -1 to carpan
                     else 
                     move 1 to carpan
              end-if

        

              
               move depkod-adi             to deptop-dep-adi

                  if carpan = 1 
                       add romhrk-tl-tutar         to deptop-tutar
                       if yromhrk-doviz-kodu > 0
                          add yromhrk-doviz-tut       to deptop-dv-tutar
                       end-if 
                    
                  else
                      subtract romhrk-tl-tutar         from deptop-tutar
                  
                       if yromhrk-doviz-kodu > 0
                          subtract yromhrk-doviz-tut       from deptop-dv-tutar
                       end-if
                 end-if

               write deptop-rec invalid 
                  rewrite deptop-rec end-rewrite 
               end-write 
          not invalid 
              if DEPKOD-TURU = 2 then             
                 initialize depkod-rec deptop-rec 
                 move ROMHRK-CORR-DEPKOD to depkod-anah deptop-depkod   
                 read depkod no lock invalid
                     exit paragraph
                 end-read
                     move depkod-ba  to deptop-ba
                     read deptop no lock invalid 
                        continue                             
                     not invalid 
                         compute deptop-tutar = deptop-tutar - romhrk-tl-tutar
                         if deptop-tutar < 0
                             continue
                         end-if
                     end-read
                     move -1 to carpan
              else 
                     move 1 to carpan
              end-if

             

              compute deptop-tutar = 
                      deptop-tutar + ( romhrk-tl-tutar  * carpan )
         
              if yromhrk-doviz-kodu > 0                       
                     compute deptop-dv-tutar = deptop-dv-tutar + (yromhrk-doviz-tut * carpan)
              end-if 
              rewrite deptop-rec end-rewrite 
          end-read
        .
         
*       
 fatfol-yaz. 
        
          initialize romhrk-rec exthrk-rec  fatdetay-rec fatdetayek-rec
         
          move  acenfat-folio to romhrk-folio exthrk-folio


                    move fat-no to konuk-fat-no
                     rewrite konuk-rec invalid stop "g ye bas" end-rewrite
                     perform log-operation-konuk
                     initialize fatdetay-rec
                    move fat-tarih to fatdetay-fat-tar
*                    if kont-fat-no > 100 then stop         " " end-if
                    move fat-no      to fatdetay-fat-no
                    move "C/L"       to fatdetay-depkod  
                    move konuk-folio to fatdetay-folio
                     
                    move acenfat-pencere to fatdetay-islem
*                    if k-kodu-tasi = "X   "  and function numval( fatdetay-fat-no ) = 17824 then 
*                         stop " "
*                    end-if
                      
                     move acenfat-kdv to   fatdetay-kdv
                     move acenfat-tip to fatdetay-tip


                       move fatdetay-anah to fatdetayek-anah


                    read fatdetay no lock invalid continue
                    end-read

                     read fatdetayek no lock invalid continue
                    end-read

                       
         start romhrk key > romhrk-anah invalid
            continue
            not invalid
            perform until fs-romhrk= "10"
            read romhrk next no lock 
               end move "10" to fs-romhrk
               not end
                  if romhrk-folio > acenfat-folio
                     exit perform 
                  end-if
                  if romhrk-ref not = acenfat-pencere then 
                    exit perform cycle
                  end-if
                  move romhrk-anah to hrk2-anah
                  read hrk2 no lock invalid stop " "
                  end-read
                  move romhrk-anah to yromhrk-anah
                  move hrk2-kaynak-folio to yromhrk-folio
                  read yromhrk no lock invalid stop " "
                  end-read
                  if hrk2-kaynak-folio not = acenfat-kfolio
                       exit perform cycle
                  end-if
                  move romhrk-depkod to depkod-anah
                  read depkod no lock invalid
                     stop " "
                  end-read
                  if romhrk-corr-depkod not = zeroes and  romhrk-corr-depkod not = spaces then
                   
                      move romhrk-corr-depkod to depkod-anah
                  read depkod no lock invalid
                     stop " "
                  end-read
                  end-if
                  
                  if depkod-kdv not = ACENFAT-KDV
                      exit perform cycle
                  end-if
                  if depkod-tipi not =  acenfat-tip
                      exit perform cycle
                  end-if
                  if romhrk-fatura-no < 1 then 

                     move fat-no to romhrk-fatura-no
                     rewrite romhrk-rec end-rewrite
                     perform log-operation-romhrk
                      perform deptop-yaz                                        

                  end-if
            end-read
            end-perform
          end-start
         
        
         start exthrk key > exthrk-anah invalid
            continue
            not invalid
            perform until fs-exthrk= "10"
            read exthrk next no lock 
               end move "10" to fs-exthrk
               not end
                  if exthrk-folio > acenfat-folio
                     exit perform 
                  end-if
                  if exthrk-ref not = acenfat-pencere then 
                    exit perform cycle
                  end-if
                   move exthrk-anah to hrk2-anah
                  read hrk2 invalid stop " "
                  end-read
                  move exthrk-depkod to depkod-anah
                  read depkod no lock invalid
                     stop " "
                  end-read
                  if exthrk-corr-depkod not = zeroes and  exthrk-corr-depkod not = spaces then
                      move exthrk-corr-depkod to depkod-anah
                  read depkod no lock invalid
                     stop " "
                  end-read
                  end-if
                  if hrk2-kaynak-folio not = acenfat-kfolio
                       exit perform cycle
                  end-if
                   move exthrk-anah to yromhrk-anah
                  move hrk2-kaynak-folio to yromhrk-folio
                  read yromhrk no lock invalid stop " "
                  end-read
                  if depkod-kdv not = ACENFAT-KDV
                      exit perform cycle
                  end-if
                  if depkod-tipi not =  acenfat-tip
                      exit perform cycle
                  end-if
                  if exthrk-fatura-no < 1 then 
                      move fat-no to exthrk-fatura-no
                     rewrite exthrk-rec end-rewrite
                     perform log-operation-exthrk
                     move exthrk-rec    to romhrk-rec 
                         perform deptop-yaz
                  end-if
            end-read
            end-perform
          end-start
        


                    move konuk-fol-kodu to  fatdetay-romhrk-exthrk    
                    move acenfat-tarih to  fatdetay-isl-tar
                    accept fatdetay-kes-tar  from century-date
                    accept fatdetay-kes-zaman from time
                    move acenfat-folio to  fatdetay-ger-fol         
                     move acenfat-kdv to fatdetay-kdv-orani  fatdetay-kdv
                     move acenfat-tip to fatdetay-tip
*****PALMÝYED YILDIZ KALDÝRÝLDÝ
                         if acenfat-peryod = 0 then 
                          initialize fatdetay-fatura-matrah fatdetay-fatura-toplam
                                       fatdetay-fatura-toplamdv  fatdetay-fatura-matrah18
                                      fatdetay-fatura-kdv fatdetay-fatura-kdv18 fatdetayek-kv-matrah  fatdetayek-kv  fatdetayek-kv-oran
                         end-if
                     
                     compute fatdetay-fatura-matrah = fatdetay-fatura-matrah  + acenfat-matrah8 
                     compute fatdetay-fatura-matrah18 = fatdetay-fatura-matrah18  + acenfat-matrah18 

                    

                    compute fatdetay-fatura-toplam = fatdetay-fatura-toplam  + acenfat-tl-tutar
                      
                      

                    compute fatdetay-fatura-toplamdv = fatdetay-fatura-toplamdv  + ACENFAT-GER-DV-TUTAR

                    compute  fatdetay-fatura-kdv =  fatdetay-fatura-kdv +  ACENFAT-KDV8  
                    compute  fatdetay-fatura-kdv18 = fatdetay-fatura-kdv18  + ACENFAT-KDV18 

                       move  ACENFAT-KV-orani   to fatdetayek-kv-oran
                     compute  fatdetayek-kv =  fatdetayek-kv +  ACENFAT-KV  
                       compute fatdetayek-kv-matrah = fatdetayek-kv-matrah  + acenfat-kv-matrah
                      
                  write fatdetay-rec invalid rewrite fatdetay-rec end-write
       
        if acenfat-ger-islem > 0 then 
         
             move acenfat-ger-folio to romhrk-folio exthrk-folio
            move acenfat-ger-islem  to romhrk-islem exthrk-islem
           if acenfat-ger-f = "R" then
             read romhrk no lock invalid
               display message box "jdkfhdkjsfh"
               not invalid
                  move fat-no to romhrk-fatura-no
                     rewrite romhrk-rec end-rewrite
                     perform log-operation-romhrk
            end-read
           end-if
           if acenfat-ger-f = "E" then
             read exthrk no lock invalid
               display message box "etr5555fh"
               not invalid
                  move fat-no to exthrk-fatura-no
                     rewrite exthrk-rec end-rewrite
                     perform log-operation-exthrk
            end-read
           end-if
        end-if

       .
*
kdv-duzelt.

        
      initialize  top8  top-MATRAH8  top-KDV8 top-kv top-kv-matrah
    top1  top-MATRAH1  top-KDV1
     top18   top-MATRAH18  top-KDV18
     
    initialize takaskdv-rec
    start takaskdv key >= takaskdv-anah
      invalid continue
      not invalid
        perform until fs-takaskdv = "10"
          read takaskdv next no lock 
              end move "10" to fs-takaskdv
              not end
                if kdv-yok not = 1
                
                  compute takaskdv-toplam = takaskdv-matrah + takaskdv-kdv + takaskdv-kv
                  compute takaskdv-kv = takaskdv-kv-matrah * (kv-orani / 100)
                   compute takaskdv-toplam =   takaskdv-toplam - takaskdv-kv
                  compute   takaskdv-matrah rounded =  takaskdv-toplam / ( 1 + (takaskdv-oran  / 100) )
                   compute  takaskdv-kdv rounded =  takaskdv-matrah * ( takaskdv-oran /100)
                    compute   takaskdv-matrah =   takaskdv-toplam - takaskdv-kdv
                     compute takaskdv-toplam =  takaskdv-matrah +   takaskdv-kdv +   takaskdv-kv

                else
                  compute takaskdv-toplam = takaskdv-matrah + takaskdv-kdv
                  compute   takaskdv-matrah rounded =  takaskdv-toplam / ( 1 + (takaskdv-oran / 100) )
                  compute  takaskdv-kdv = takaskdv-toplam - takaskdv-matrah                   
                  compute takaskdv-matrah = takaskdv-matrah +  takaskdv-kdv
                  
                end-if 
                add takaskdv-kv to   top-kv
                add takaskdv-kv-matrah to top-kv-matrah
                if  takaskdv-oran < 8
                   move  takaskdv-toplam   to top1
                   move  takaskdv-matrah to  top-MATRAH1
                   move  takaskdv-kdv to  top-KDV1

                else
                        if    takaskdv-oran = 8
                           move  takaskdv-toplam   to top8
                           move  takaskdv-matrah to  top-MATRAH8
                           move  takaskdv-kdv to  top-KDV8
                        else
                           move  takaskdv-toplam   to top18
                           move  takaskdv-matrah to  top-MATRAH18
                           move  takaskdv-kdv to  top-KDV18
                        end-if
                end-if

               rewrite takaskdv-rec invalid stop " " end-rewrite
           end-read
        end-perform
     end-start


*      compute top8 = top-MATRAH8 + top-KDV8
*    compute top1 = top-MATRAH1 + top-KDV1
*    compute top18 =   top-MATRAH18 + top-KDV18
*    if kdv-yok not = 1      
*       compute top-MATRAH8 rounded = top8 / (1.08)
*       compute top-MATRAH1 rounded = top1 / (1.01)
*
*      compute  top-MATRAH18 rounded = top18 / (1.18)
*
*       compute  top-KDV1 rounded =   top1 - top-MATRAH1    
*       compute  top-KDV8 rounded =   top8 - top-MATRAH8
*       compute  top-KDV18 rounded =   top18 - top-MATRAH18
*    end-if 
        
      .
*
fat-bas.
        accept omitted before time 0 
       initialize deptop-rec depler kram  pram
       start deptop key not < deptop-anah invalid 
            continue 
       not invalid 
       perform with test after until fs-deptop = "10"
       read deptop next no lock end move "10" to fs-deptop
       not at end         
              evaluate deptop-ba
              when "B"
                if kram < 30 
                add 1                to kram
                end-if
                move deptop-dep-adi  to bordepadi(kram)
                move deptop-tutar    to bordeptutar(kram)
                initialize depkod-rec 
                move deptop-depkod(1:3)   to depkod-kodu
                read depkod no lock invalid
                    continue 
                not invalid 
                    move depkod-kdv  to bordep-kdv(kram)
                end-read 
              when "A" 
                if pram < 30   
                   add 1                to pram
                end-if
                move deptop-dep-adi  to aladepadi(pram)(1:10)
                if deptop-depkod(4:) not = spaces 
                   if deptop-dovizli = 2
                      move "-"                 to aladepadi(pram)(11:1)
                      move deptop-depkod(4:)   to aladepadi(pram)(12:) 
                   end-if 
                   if deptop-dovizli = 1
                      move "-"                 to aladepadi(pram)(8:1)
                      move deptop-dv-tutar     to z4
                      move z4                  to aladepadi(pram)(9:)
                      move deptop-depkod(4:3)  to aladepadi(pram)(17:)
                   end-if 
                end-if 
                
                move deptop-tutar    to aladeptutar(pram)
              end-evaluate
       end-read 
       end-perform
       end-start
   



         perform kdv-duzelt.


          open i-o genelfis
         move 1 to genelfis-anahtar
         read genelfis no lock invalid
            accept print-no from time
           not invalid
            add 1 to print-no
            rewrite genelfis-rec end-rewrite
          end-read
          close genelfis


              initialize dokumer-rec dokumer-anah dokumer-ozellikler-rec
                       dokumer-dosya 
            set  dokumer-asya-set to true
            move print-no         to dokumer-dosya-adi
            open output dokumer
            add 1 to dokumer-anah
            write dokumer-rec
            if cb-yazici-tipi not = "S"
               call "c$sleep" using 1  
            end-if 
*                if v-comboefat(1:1) = "E" 
                 open i-o alsat muh-kodlar alsatek  earsbil
*                end-if
            
            perform  fat-dok
           
            set dokumer-yazici-text to true
            move "H"                to dokumer-genel-baslik-yaz
            close dokumer
             if v-comboefat(1:1) not = "E" 
                if genel-e-arsiv-gecis-tarihi <= fat-tarih and
                   genel-e-arsiv-gecis-tarihi > "20150101"
                       perform e-arsiv-fat-dok
                      continue 
                else
                      call dokumer-prog on exception
                           perform callerr-proc
                      not on exception
                           cancel dokumer-prog
                      end-call
                end-if
            end-if 
            close alsat alsatek muh-kodlar earsbil.
*
fat-bas2.
         perform kdv-duzelt.
          open i-o genelfis
         move 1 to genelfis-anahtar
         read genelfis no lock invalid
            accept print-no from time
           not invalid
            add 1 to print-no
            rewrite genelfis-rec end-rewrite
          end-read
          close genelfis

            initialize dokumer-rec dokumer-anah dokumer-ozellikler-rec
                       dokumer-dosya 
            set dokumer-asya-set to true
            move print-no         to dokumer-dosya-adi
            open output dokumer
            add 1 to dokumer-anah
            write dokumer-rec
            
               call "c$sleep" using 1  
            
            open i-o alsat alsatek muh-kodlar earsbil
            perform fat-dok
           
            set dokumer-yazici-text to true
            move "H"                to dokumer-genel-baslik-yaz
            close dokumer alsat alsatek muh-kodlar earsbil
****************************************************************           
*     if v-comboefat(1:1) not = "E"   
*        if genel-e-arsiv-gecis-tarihi <= fat-tarih and
*           genel-e-arsiv-gecis-tarihi > "20150101"              
*             continue  
*        else
*          call dokumer-prog using dokumer-link-bilgiler on exception
*          call dokumer-prog on exception
*               perform callerr-proc
*          not on exception
*               cancel dokumer-prog
*          end-call
*        end-if 
*     end-if
              call dokumer-prog using dokumer-link-bilgiler on exception
                   perform callerr-proc
              not on exception
                   cancel dokumer-prog
              end-call
              delete file dokumer
           .

*
Form1-Aft-Initdata.
*/-----------------------------\*  
*/---------DIL AYARLA----------\*    
*/-----------------------------\*    
     perform dil-ayarla-proc.
*/-----------------------------\*         
         if link-var > 0 then 
 
               move link-tarih(1:4) to ilk-yil son-yil
               move link-tarih(5:2) to ilk-ay  son-ay
               move link-tarih(7:2) to ilk-gun son-gun
     
         move 1 to fatupdate
         display form1
     
         move 2 to key-status
         perform Form1-Ex-Other


         move "E" to v-comboefat
         move 1 to fatupdate
         display form1

         move 2 to key-status
         perform Form1-Ex-Other
         set exit-pushed to true
      end-if
        
         .


*
fat-dok. 

        move 0 to fatdok-sira
       initialize takaskdv-rec  kdv-bitti
       start takaskdv key >= takaskdv-anah invalid 
          move 1 to kdv-bitti
            not invalid 
              read takaskdv next no lock end move 1 to kdv-bitti
              end-read
       end-start
       move 1 to i
       initialize dokumer-rec  text-oku-rec
       open input text-oku,
       perform with test after until fs-text-oku = "10"
       initialize text-oku-2
       read text-oku next no lock end move "10" to fs-text-oku
          not end

          initialize dokumer-rec
          if text-oku-1  = "0"
             initialize text-oku-2
          end-if
          if text-oku-1  = "A"
*            if k-kodu-tasi(1:2) = "X " then stop " " end-if
            if det-ara-cari(i) not = spaces then
               initialize musteri-rec
*                move  det-ara-profil(i) to m-profil     | mprofil bos geliyor. firat 17/08/2020
                move det-ara-profil(i)(1:8) to musteri-sirket
                move det-ara-profil(i)(9:8) to musteri-no
                if musteri-no not numeric
                      move "999999992" to musteri-no
                   end-if
                    initialize musteri-rec
                read musteri no lock invalid
                   move det-ara-acenta(i) to acenta-kodu
                   read acenta no lock invalid
                      continue
                   not invalid

                            if ACENTA-MUHNO2 = spaces
                             move acenta-muhno to cari-kodu
                                else
                              move acenta-muhno2 to cari-kodu
                          end-if
                         

                            move det-ara-firma(i) to konu2-firma 
                            open input firma
                            perform firma-oku-getir
                            close firma

                         read cari no lock invalid
                          initialize cari-rec
                         end-read,
                 
                      move c-unvan-1          to  musteri-unvan1(1:40)       
                     move  c-unvan-2         to  musteri-unvan2(1:40)       
                     move  c-adres-1         to  musteri-adres1 (1:40)      
                     move  c-adres-2         to  musteri-adres2 (1:40)      
                     move  c-il-ilce         to  musteri-ilce(1:20)         
                     move  c-ulke(1:14)      to  musteri-il(1:14)           
                     move  c-vergi-daire     to musteri-vdairesi (1:20) 
                     move C-EMAIL            to musteri-e-mail
                     move c-telefon          to musteri-tel1
                           perform varying ix from 1 by 1 until ix > 18
                               if c-vergi-no(ix:1) = spaces then 
                                        move  c-vergi-no(ix + 1 :) to c-vergi-no(ix :) 
                                        move  " " to c-vergi-no(20:1)
                               end-if
                           end-perform 
                            move  c-vergi-no          to musteri-vno
                 end-read
                not invalid
                      move   musteri-vno to c-vergi-no  
                                  move musteri-muhasebe-kodu   to cari-kodu
                         read cari no lock invalid
                          initialize cari-rec
*************************************************
                       move det-ara-acenta(i) to acenta-kodu
                            read acenta no lock invalid
                               continue
                            not invalid

                            if ACENTA-MUHNO2 = spaces
                             move acenta-muhno to cari-kodu
                                else
                              move acenta-muhno2 to cari-kodu
                            end-if
                         read cari no lock invalid
                          initialize cari-rec
                         end-read,                             
                         end-read
                         not invalid 
                         if   c-vergi-no = spaces then
                             move   musteri-vno to c-vergi-no  
                          end-if

****************************************
                         end-read, 
                 end-read
            
              end-if
          end-if


          if text-oku-1 = "1"
             move det-ara-referans(i) to buf3
******** lonicera için eklendi
          if buf3 > 0 then 
             move ref-adi(buf3) to ref-adi2
           end-if
******** lonicera için eklendi

           inspect text-oku-2 replacing all "[ACENTA_ADI__________________]" by acenta-adi

           move fat-yil to e-yil
           move fat-ay  to e-ay
           move fat-gun to e-gun          
           move c-vergi-no to vergi-uzun
*             inspect text-oku-2 replacing all "[REFACIK_____________________]"            by ref-aciklama
             inspect text-oku-2 replacing all "[ACENADI_______________________________]" 
                   by musteri-unvan1(1:40) 
             inspect text-oku-2 replacing all "[ACENUNV_______________________________]"  
                   by musteri-unvan2(1:40)  
             inspect text-oku-2 replacing all "[ACENADR1______________________________]"  
                   by musteri-adres1 (1:40) 
             inspect text-oku-2 replacing all "[ACENADR2______________________________]"  
                   by musteri-adres2 (1:40) 
             inspect text-oku-2 replacing all "[ACEN-IL-ILCE______]"                     
                   by musteri-ilce(1:20) 
             inspect text-oku-2 replacing all "[ACENULKE____]"                            
                   by musteri-il(1:14)  
             inspect text-oku-2 replacing all "[ACENVDA___________]"                      
                   by musteri-vdairesi (1:20) 
             inspect text-oku-2 replacing all "[ACENVNO__________]"                       
                   by vergi-uzun(1:19)
             inspect text-oku-2 replacing all "[FATTAR__]"                                
                   by etarih2
          end-if
          if text-oku-1 = "2"
             if det-ara-rez-no(i) > 0
                 initialize toplam-dv toplam-tl               
             end-if 
             if det-ara-tl-tut(i) not = zeroes                                        
                move det-ara-pan-kod(i)    to 2-x,
                inspect text-oku-2 replacing all "PP"       by  2-x
                inspect text-oku-2 replacing all "QQ" by det-ara-geceleme(i)      | geceleme sorunu
                if depkod-acik-bas = 1 
                   inspect text-oku-2 replacing all "[VOUCHER_]"       by det-ara-har-depkod(i)(1:10) 
                   inspect text-oku-2 replacing all "[VOUCHER__]"      by det-ara-har-depkod(i)(1:11) 
                   inspect text-oku-2 replacing all "[VOUCHER___]"     by det-ara-har-depkod(i)(1:12) 
                   inspect text-oku-2 replacing all "[VOUCHER____]"    by det-ara-har-depkod(i)(1:13) 
                   inspect text-oku-2 replacing all "[VOUCHER_____]"   by det-ara-har-depkod(i)(1:14)  
                   inspect text-oku-2 replacing all "[VOUCHER______]"  by det-ara-har-depkod(i)(1:15)
                   inspect text-oku-2 replacing all "[VOUCHER_______]" by det-ara-har-depkod(i)(1:16)
                   inspect text-oku-2 replacing all "[VOUCHER___________]" by det-ara-har-depkod(i)(1:20)
                   inspect text-oku-2 replacing all "[GUNFIY]"      by   "%[kd] LI"
                   move det-ara-kdv(i)   to 4-z  
                   inspect text-oku-2 replacing all "[kd]"        by  4-z
                   inspect text-oku-2 replacing all "[DVTUTAR__]"  by   "KDVLI TUTAR"
                   inspect text-oku-2 replacing all "[B]"         by  spaces
                   inspect text-oku-2 replacing all "[K]"         by  spaces
                   inspect text-oku-2 replacing all "[ADET]"      by  spaces
                   inspect text-oku-2 replacing all "QQ" by spaces
                   inspect text-oku-2 replacing all "x" by spaces
                                                    "+" by spaces
                                                    "=" by spaces
                   inspect text-oku-2 replacing all "[BK]"        by  spaces
                         
                   inspect text-oku-2 replacing all "[CK]"        by  spaces
                   inspect text-oku-2 replacing all "[DOV]"         by  spaces
                   inspect text-oku-2 replacing all "[KURU____]"    by  spaces
                   inspect text-oku-2 replacing all "PP"          by  spaces

                else
                   inspect text-oku-2 replacing all "[VOUCHER_]" by det-ara-voucher(i)(1:10) 
                   inspect text-oku-2 replacing all "[VOUCHER__]" by det-ara-voucher(i)(1:11) 
                   inspect text-oku-2 replacing all "[VOUCHER___]" by det-ara-voucher(i)(1:12) 
                   inspect text-oku-2 replacing all "[VOUCHER____]" by det-ara-voucher(i)(1:13) 
                   inspect text-oku-2 replacing all "[VOUCHER_____]" by det-ara-voucher(i)(1:14)  
                   inspect text-oku-2 replacing all "[VOUCHER______]" by det-ara-voucher(i)(1:15)
                   inspect text-oku-2 replacing all "[VOUCHER_______]" by det-ara-voucher(i)(1:16)
                   inspect text-oku-2 replacing all "[VOUCHER___________]" by det-ara-voucher(i)(1:20)
                end-if                  
                move det-ara-giryil(i)  to cin-yil
                move det-ara-giray(i)   to cin-ay
                move det-ara-girgun(i)  to cin-gun
                if det-ara-giryil(i) = zeroes
                   inspect text-oku-2 replacing all "[GIRTAR__]" by spaces
                else  
                   inspect text-oku-2 replacing all "[GIRTAR__]" by d03-detay
                end-if
              
                move det-ara-cikyil(i)  to cout-yil
                move det-ara-cikay(i)   to cout-ay
                move det-ara-cikgun(i)  to cout-gun
                if det-ara-cikyil(i) = zeroes
                   inspect text-oku-2 replacing all "[CIKTAR__]"  by spaces
                else
                   inspect text-oku-2 replacing all "[CIKTAR__]"  by d04-detay
                end-if 
  
                inspect text-oku-2 replacing all "[MUSSOY__]"  by det-ara-soy(i)
*************************************
                move 0 to oda-uzun
                move det-ara-oda(i) to odalar-anah
                read odalar no lock invalid
                     continue
                not invalid
                   if genel-uzun-oda-no-kullanilsin = 1
                      if odalar-uzun-no not = spaces
                         move 1 to oda-uzun
                      end-if
                   end-if
                end-read
*************************************
                if oda-uzun = 1
                   inspect text-oku-2 replacing all " [OD]"        by odalar-uzun-no(1:5)
                else
                   inspect text-oku-2 replacing all "[OD]"        by det-ara-oda(i)
                end-if
                if det-ara-buyuk(i) = zeroes and det-ara-buy-kisi(i) or det-ara-geceleme(i) = 0
                   if det-ara-geceleme(i) = 0 and  det-ara-buyuk(i) > 0
                      move det-ara-buyuk(i)       to 3-z
                      inspect text-oku-2 replacing all "[B]"         by  3-z
                      move det-ara-kucuk(i)       to 3-z
                      inspect text-oku-2 replacing all "[K]"         by  3-z                          
                   else

                      inspect text-oku-2 replacing all "[B]"         by spaces
                      inspect text-oku-2 replacing all "[K]"         by spaces
                      inspect text-oku-2 replacing all "[ADET]"      by spaces
                      inspect text-oku-2 replacing all "QQ" by spaces
                      inspect text-oku-2 replacing all "x" by spaces
                                                       "+" by spaces
                                                       "=" by spaces
                      inspect text-oku-2 replacing all "[BK]"        by spaces                              
                      inspect text-oku-2 replacing all "[CK]"        by spaces
                      inspect text-oku-2 replacing all "[DOV]"       by spaces
                      inspect text-oku-2 replacing all "[KURU____]"  by spaces
                      inspect text-oku-2 replacing all "PP"          by spaces                                                                                            
                      move det-ara-tl-tut(i) to tl-tut                           
                      if tl-tut   > 0 then                                 
                         inspect text-oku-2 replacing all "[GUNFIY]"      by   "%[kd] li"
                         move det-ara-kdv(i)   to 4-z  
                         inspect text-oku-2 replacing all "[kd]"        by  4-z
                         inspect text-oku-2 replacing all "[DVTUTAR__]"   by   "kdvli tutar"
                      else
                         inspect text-oku-2 replacing all "[GUNFIY]"      by   spaces
                         move det-ara-kdv(i)   to 4-z  
                         inspect text-oku-2 replacing all "[kd]"        by  4-z
                         inspect text-oku-2 replacing all "[DVTUTAR__]"   by   spaces
                      end-if
                   end-if   
                else
                   move det-ara-buyuk(i)       to 3-z
                   inspect text-oku-2 replacing all "[B]"         by  3-z
                   move det-ara-kucuk(i)       to 3-z
                   inspect text-oku-2 replacing all "[K]"         by  3-z
                   move det-ara-adet(i)        to 6-z
                   inspect text-oku-2 replacing all "[ADET]"      by  6-z
                   move det-ara-buy-kisi(i)    to 4-z
                   inspect text-oku-2 replacing all "[BK]"        by  4-z
                   move det-ara-kuc-kisi(i)    to 4-z
                   inspect text-oku-2 replacing all "[CK]"        by  4-z  
                end-if  
                        
                inspect text-oku-2 replacing all "[MUSADI__]"    by det-ara-adi(i)
                inspect text-oku-2 replacing all "[MUSSOY__]"    by det-ara-soy(i)
                move det-ara-kur-kod(i)    to doviz-kodu
                read doviz no lock invalid
                     initialize d-kisa-adi
                end-read

*                inspect text-oku-2 replacing all "QQ" by det-ara-geceleme(i)      | geceleme sorunu
                move d-kisa-adi       to 5-x,
                inspect text-oku-2 replacing all "[DOV]"             by  5-x
*->
                move det-ara-kuru(i)        to 10-z
                inspect text-oku-2 replacing all "[KURU____]"        by  10-z

                initialize dv-tut tl-tut  
                move det-ara-tl-tut(i) to tl-tut
                
                if det-ara-geceleme(i) = 0
                   compute  dv-tut rounded =  tl-tut / det-ara-kuru(i)
                else
                   compute  gun-tut rounded = ( tl-tut / det-ara-kuru(i)) /  det-ara-geceleme(i)
                   compute  dv-tut rounded = gun-tut *  det-ara-geceleme(i)
                end-if                 
                
                if acenta-fatalti-ind > 0 then
                    compute gun-tut rounded = 
                           (gun-tut / (100 - acenta-fatalti-ind )) * 100
                    compute dv-tut rounded = gun-tut * det-ara-geceleme(i)
                    compute tl-tut rounded = gun-tut * det-ara-kuru(i) * det-ara-geceleme(i)
                    compute tdv-tut-mat = tdv-tut-MAT + dv-tut
                    compute ttl-tut-mat = ttl-tut-MAT + tl-tut
                end-if
                move dv-tut         to 11-z                 
                inspect text-oku-2 replacing all "[DVTUTAR__]"    by  11-z
                move tl-tut      to 13-z
                inspect text-oku-2 replacing all "[TLTUTAR____]"  by  13-z
                if det-ara-acenfat-bos(i) not = spaces
                   move det-ara-acenfat-bos(i) to  genel-oda-disi-fatura-aciklama
                end-if
       
                if det-ara-geceleme(i) = 0 and  det-ara-buyuk(i) > 0
                   if genel-oda-disi-fatura-aciklama(1:3) not = spaces and
                      genel-oda-disi-fatura-aciklama(4:3) not = spaces 
                      inspect text-oku-2 replacing all "[GUNFIY]"       by   genel-oda-disi-fatura-aciklama(4:8)
                      inspect text-oku-2 replacing all "00x" by genel-oda-disi-fatura-aciklama(1:3)

                   else
                      inspect text-oku-2 replacing all "[GUNFIY]"       by  "LATECOUT"  
                      inspect text-oku-2 replacing all "00x" by "   "
                   end-if
                else
                   move gun-tut       to 8-z
                   inspect text-oku-2 replacing all "[GUNFIY]"       by  8-z
               end-if
********************************************************
               if key-status2 = 2
                  initialize alsat-rec
                  move "S"       to  alsat-tipi   
                  move fat-tarih to alsat-tarih
*******************             move  alsat-toplam-hesap        
                  move fat-no   to alsat-belge-no         
                  move i        to alsat-sira
****e-arsiv zamanýnda kaldýrýldý                     move "BS"     to alsat-belge-tipi              
********************          02 alsat-matrah-hesap             PIC x(15).| 740-xx-xxx
**********************          02 alsat-kdv-hesap                PIC x(15).| 191-xx-xxx
**********************          02 alsat-vergi-hesap-occ occurs 9 times.
*******************             03 alsat-vergi-hesap           pic x(15).

************************************************************************************************
*****************************************MATRAH HESAP KODU BULMA 007****************************
                  initialize kodlar02-rec
                  move "A"                 to KODLAR02-TIPI
                  move det-ara-pan-kod(i)  to KODLAR02-kodu
                  read koDlar02 no lock invalid
                       continue
                  end-read
                  initialize depkod-rec depkod2-rec
                  move oda-dep to DEPKOD-KODU DEPKOD2-KODU
                  read depkod no lock invalid
                       continue
                  end-read
                  read depkod2 no lock invalid
                       continue
                  end-read

                  if depkod2-matrah-hesap <> spaces
                     move depkod2-matrah-hesap to alsat-matrah-hesap
                  else
                     move depkod-matrah-hesap  to alsat-matrah-hesap
                  end-if
                
                  initialize muh-kodlar-rec
                  set muh-kodlar-tipi-kdv to true
                  move fat-yil    to muh-kodlar-yil
                  MOVE "S"        to muh-kodlar-kodu1
                  MOVE "O"        to muh-kodlar-kodu2
                  move depkod-kdv to muh-kodlar-fis 
                  read muh-kodlar no lock invalid
                          continue
                  end-read
                  move muh-kodlar-kdv-hesap(fat-ay) to alsat-kdv-hesap

***********************************02.07.2015**********************************************************
*******************************************************************************************************
                  move  cari-kodu to     alsat-toplam-hesap-babs  alsat-toplam-hesap 
                  
                  move genel-muha-ref to alsat-referans         
                  if onkpara-referans-var = 1
                     move det-ara-referans(i) to alsat-referans
                  end-if 
                  move text-oku-2(5:) to  alsat-satir-aciklama 
                
                  move top-GER-DV-TUTAR          to 11-z alsat-doviz-tutar
                  move 11-z                      to alsat-fis-not
                  move d-kisa-adi                to alsat-fis-not(13:5)

                  move "Onburo C/L Fatura"       to alsat-fis-aciklama(1:17)
                  initialize acenta-rec 
                  move det-ara-acenta(i)         to acenta-kodu
                  read acenta no lock invalid
                       continue 
                  end-read 
                
       
                  move det-ara-firma(i) to konu2-firma 
                  open input firma
                  perform firma-oku-getir
                  close firma
                      
                  move acenta-adi              to alsat-fis-aciklama(19:30)
                  if det-ara-firma(i) not = spaces and firma-adi not = spaces
                        move firma-adi         to alsat-fis-aciklama(19:30)
                  end-if

                  if onkpara-referans-var = 1
                     move ref-adi2               to alsat-fis-aciklama(51:)
                  end-if 

                  move 01                        to alsat-banka                
                  move det-ara-kur-kod(i) to alsat-doviz     
                  compute  alsat-doviz-kuru rounded = tl-tut / dv-tut       
                  move det-ara-kdv-oran(i) to alsat-kdv-orani  
    


                  compute   alsat-matrah rounded =   det-ara-kdv8-matrah(i)    +   det-ara-kdv18-matrah(i)  
                  
                  
                  move alsat-matrah to alsat-gercek-matrah

                  compute  alsat-kdv-tutar   =  det-ara-kdv8-tutar(i)   +    det-ara-kdv18-tutar(i)  

       
                     

                  move  det-ara-kv-matrah(i)    to  alsat-konaklama-vergisi-matrah                             
                  move    det-ara-kv-tutar(i)  to alsat-konaklama-vergisi-tutar 
                  if    det-ara-kv-tutar(i) > 0        
                        move   2   to alsat-konaklama-vergisi-oran    
                        else
                        move 0 to   alsat-konaklama-vergisi-oran 
                  end-if





                     move c-vergi-no            to alsat-adres-vergi-no
******                     move "0000000065"          to alsat-adres-vergi-no           
                     move musteri-unvan1(1:40)  to alsat-adres-unvani(1:40) 
                     move musteri-unvan2(1:40)  TO alsat-adres-unvani(41:40) 
                     move musteri-adres1 (1:40) TO alsat-adres-cadde-adi(1:40)
                     move musteri-adres2 (1:40) TO alsat-adres-cadde-adi(41:40)
                     move musteri-ilce(1:20)    to alsat-adres-ilce 
                     move musteri-il(1:14)      to alsat-adres-il  
                     move musteri-vdairesi(1:20)   to alsat-adres-vergi-dairesi  
                     move musteri-fat-ulke             to alsat-adres-ulke        
                     
                    move musteri-e-mail     to alsat-adres-mail
                    if musteri-tel1 not = spaces
                       move musteri-tel1    to alsat-adres-tel
                    end-if
                    if musteri-tel2 not = spaces
                       move musteri-tel2    to alsat-adres-tel
                    end-if
                    if musteri-tel3 not = spaces
                       move musteri-tel3    to alsat-adres-tel
                    end-if
                    if musteri-gsm not = spaces
                       move musteri-gsm    to alsat-adres-tel
                    end-if                     
                    
                    if e-arsiv-var-mi = 1
                      initialize gerfat-rec
                      MOVE  FATURA-REC TO gerfat-ANAH 
                      READ GERFAT NO LOCK INVALID 
                         CONTINUE
                      END-READ
      
                        MOVE  gerfat-onek   TO  rap-ger-seri
                        MOVE   gerfat-gerfatno   TO   rap-ger-no

                       display acc-ger-seri acc-ger-no

                        move rap-ger-seri      to gerfat-onek
                        move rap-ger-no        to gerfat-gerfatno     
                        move "K"               to alsat-earsiv-gonderim-sekli
                        move rap-ger-no        to alsat-efatura-numarasi(8:9)
                        move rap-ger-seri      to alsat-efatura-numarasi(1:7)
                    end-if
                   
                         set alsat-kayit-vkn to true
                     

                  move "D" to  alsat-kdv-dh              
                  compute alsat-kdvli =  tl-tut - alsat-konaklama-vergisi-tutar            
** **                  compute alsat-kdv-tutar = alsat-kdvli - alsat-matrah     
                  move 1 to  alsat-miktar           
                  move alsat-matrah to alsat-birim-fiyat
                  move "Adet"       to alsat-birim
                  move "O"          to alsat-kaynak
                  if v-comboefat(1:1) = "E" 
                      move "E" to alsat-efatura-mi
                  else
                      move " " to alsat-efatura-mi
                  end-if

                move isyeri-adres-tasi to alsat-kaynak-kutuphane
                
                initialize acenta-rec 
                move det-ara-acenta(i) to acenta-kodu
                read acenta no lock invalid
                     continue 
                end-read 

                if acenta-online-rez-acentasi = 1
                   initialize earsbil-rec
                   move "R"                     to earsbil-tip
                   move det-ara-rez-no(i)       to earsbil-alt-anah
                   read earsbil no lock invalid
                       if acenta-web-adresim not = spaces
                          move acenta-web-adresim to earsbil-odeme-web-adresi
                          move "E"          to alsat-earsiv-online-satis
                       end-if 
                   not invalid
                       if earsbil-odeme-web-adresi = spaces
                          move acenta-web-adresim to earsbil-odeme-web-adresi
                       end-if 
                       if earsbil-odeme-web-adresi not = spaces
                          move "E"          to alsat-earsiv-online-satis
                       end-if 
                   end-read 
                end-if
**************************pegas tur ****************************************************** 
                move det-ara-voucher(i) to alsat-mis-voucher                     |firat her faturada alsata yazmasý için koþul dýþýna taþýndý 23/09/2020
                if acenta-pegas-entegre = 1
                        move det-ara-adi(i)     to alsat-mis-adsoyad(1:10)
                        move det-ara-soy(i)     to alsat-mis-adsoyad(11:10)
*                        move det-ara-voucher(i) to alsat-mis-voucher            |firat her faturada alsata yazmasý için koþul dýþýna taþýndý 23/09/2020
                        move det-ara-pan-kod(i) to alsat-mis-board

                        initialize temp-rez-no
                        if det-ara-rez-no(i) > 0
                           move det-ara-rez-no(i)  to temp-rez-no yed-rez-no
                        else
                          if det-ara-rez-no(i) = 0
                             move yed-rez-no  to temp-rez-no
                          end-if 
                        end-if 

                        initialize rez-rec
                        move temp-rez-no  to rez-no
                        read rez no lock invalid
                            continue 
                        end-read 
                        initialize konum-rec
                        move rez-fiyat-konumu  to konum-anahtar
                        read konum no lock invalid 
                           continue 
                        end-read
                        move konum-adi         to alsat-mis-konum
              
                        move rez-buyuk     to alsat-mis-pax                
                        move rez-kucuk     to alsat-mis-chi                
                        move rez-free      to alsat-mis-fre                
                        move rez-bebek     to alsat-mis-beb                
                        move rez-gir-tar   to alsat-mis-cin
                        move rez-cik-tar   to alsat-mis-cout
                        move det-ara-oda(i) to alsat-mis-oda
*                        compute toplam-dv = toplam-dv + dv-tut
*                        compute toplam-tl = toplam-tl + tl-tut

                        move dv-tut          to alsat-mis-dov-tutar          
                        move d-kisa-adi      to alsat-mis-doviz-kodu         
                        move det-ara-kuru(i) to alsat-mis-doviz-kur    
                        move tl-tut          to alsat-mis-toplam-tl 
                        move rez-no          to alsat-mis-rezno
                 end-if
**************************pegas tur ****************************************************** 
                 move alsat-matrah to alsat-gercek-matrah
                move alsat-kdvli to alsat-gercek-tutar-kdvli

                write alsat-rec invalid
                     rewrite alsat-rec invalid
                             stop " " 
                     end-rewrite 
                end-write

                initialize alsatek-rec
                move alsat-ana-anahtar   to alsatek-ana-anahtar
                read alsatek no lock invalid
                     continue 
                end-read 
                   if earsbil-odeme-tarihi > "19000101"
                      move earsbil-odeme-tarihi          to alsatek-odeme-tarihi(1)                     
                   else
                      move fat-tarih                     to alsatek-odeme-tarihi(1)
                   end-if 
                   if earsbil-odeme-tipi not = spaces
                      move earsbil-odeme-tipi            to alsatek-online-odeme-yontemi(1)
                   else
                      move 5                             to alsatek-online-odeme-yontemi(1)                     
                   end-if
                   if earsbil-odeme-web-adresi = spaces
                      move acenta-web-adresim            to earsbil-odeme-web-adresi
                   end-if 
                   if earsbil-odeme-web-adresi not = spaces
                      if acenta-online-rez-acentasi = 1
                         move earsbil-odeme-web-adresi   to alsatek-online-web-site                       
                      end-if 
                   end-if 
                   move earsbil-kredi-karti           to alsatek-kredi-karti(1)
                   move earsbil-kredi-karti-onay-no   to alsatek-kredi-karti-onay-no(1) 
                   move "C/L-Krediye Kalkan"          to alsatek-odeme-departman-adi(1)
                   if alsatek-online-odeme-yontemi(1) = 5
                      move "C/L-Krediye Kalkan"       to alsatek-online-odeme-aciklama(1)
                   end-if 
                   move top-ger-tl-tutar              to alsatek-odeme-dep-tutar(1)

                write alsatek-rec invalid 
                    rewrite alsatek-rec end-rewrite 
                end-write                
          end-if
************************************move  
             else
                initialize text-oku-2 
             end-if
             add 1 to i
          end-if
           if text-oku-1 = "8" and text-oku-2 not = spaces then            
              if kdv-bitti = 1 then 
                   move spaces to 13-z
                   inspect text-oku-2 replacing all "[TTLTUTAR___]"     by  spaces
                   inspect text-oku-2 replacing all "[TTLKDVNET__]"     by  spaces
                   inspect text-oku-2 replacing all "[TTLKDVSI___]"     by  spaces
                   inspect text-oku-2 replacing all "[KD]"        by  spaces
              else
                 if kdv-yok not = 1
                    move takaskdv-oran   to 4-z  
                    inspect text-oku-2 replacing all "[KD]"        by  4-z
                 else
                    move spaces          to 4-z  
                    inspect text-oku-2 replacing all "[KD]"        by  4-z                  
                 end-if
                     move takaskdv-matrah   to  13-z
                 inspect text-oku-2 replacing all "[TTLKDVNET__]"     by  13-z
                 if kdv-yok not = 1
                          move takaskdv-kdv   to  13-z
                    inspect text-oku-2 replacing all "[TTLKDVSI___]"     by  13-z
                 else
                          move spaces   to  13-z
                    inspect text-oku-2 replacing all "[TTLKDVSI___]"     by  13-z
                   
                 end-if 
                    move takaskdv-toplam   to  13-z
                 inspect text-oku-2 replacing all "[TTLTUTAR___]"     by  13-z
                 read takaskdv next no lock end 
                     move 1 to kdv-bitti
                 end-read
               end-if
            end-if
          if text-oku-1 = "3" or text-oku-1 = "5"  
          inspect text-oku-2 replacing all  
             "[ASYA.........................................................................................]"
             by asya-text(1:95)
             move d-kisa-adi       to 5-x,
             inspect text-oku-2 replacing all "[DOV]"       by  5-x

             move top-GER-DV-TUTAR         to 11-z
             inspect text-oku-2 replacing all  "[GDVTUTAR_]"       by  11-z
              move top-GER-TL-TUTAR         to 11-z
              inspect text-oku-2 replacing all "[GTLTUTAR_]"       by  11-z
              move  top-TL-TUTAR        to 13-z
             inspect text-oku-2 replacing all "[TTLTUTAR___]"     by  13-z
             
             move top-matrah18        to 13-z
             inspect text-oku-2 replacing all "[T18KDVNET__]"     by  13-z
                
             move  top-KDV18         to 13-z
             inspect text-oku-2 replacing all "[T18KDVSI___]"     by  13-z
             
            
             move top-matrah8            to 13-z
             inspect text-oku-2 replacing all "[TTLKDVNET__]"     by  13-z
                
             move top-KDV8        to 13-z
             inspect text-oku-2 replacing all "[TTLKDVSI___]"     by  13-z
           

             move top-matrah1            to 13-z
             inspect text-oku-2 replacing all "[TTLKDVNET1_]"     by  13-z
                
             move top-KDV1        to 13-z
             inspect text-oku-2 replacing all "[TTLKDVSI1__]"     by  13-z


                move top-KV        to 13-z
             inspect text-oku-2 replacing all "[TTLKV_SIT__]"     by  13-z

                      move top-KV-matrah       to 13-z
             inspect text-oku-2 replacing all "[TTLKV_NET__]"     by  13-z

    










              inspect text-oku-2 replacing all "[BORC_ADI_1_______]"                                
                  by bordepadi(1)                  
                  move bordeptutar(1) to 13-z
                  inspect text-oku-2 replacing all "[B1TUTAR____]"                                
                  by 13-z
                 
                  inspect text-oku-2 replacing all "[BORC_ADI_2_______]"                                
                  by bordepadi(2)                  
                  move bordeptutar(2) to 13-z
                  inspect text-oku-2 replacing all "[B2TUTAR____]"                                
                  by 13-z                                
                  inspect text-oku-2 replacing all "[BORC_ADI_3_______]"                                
                  by bordepadi(3)                  
                  move bordeptutar(3) to 13-z
                  inspect text-oku-2 replacing all "[B3TUTAR____]"                                
                  by 13-z
                   
                  inspect text-oku-2 replacing all "[BORC_ADI_4_______]"                                
                  by bordepadi(4)                  
                  move bordeptutar(4) to 13-z
                  inspect text-oku-2 replacing all "[B4TUTAR____]"                                
                  by 13-z

                  inspect text-oku-2 replacing all "[BORC_ADI_5_______]"                                
                  by bordepadi(5)                  
                  move bordeptutar(5) to 13-z
                  inspect text-oku-2 replacing all "[B5TUTAR____]"                                
                  by 13-z

                  inspect text-oku-2 replacing all "[BORC_ADI_6_______]"                                
                  by bordepadi(6)                  
                  move bordeptutar(6) to 13-z
                  inspect text-oku-2 replacing all "[B6TUTAR____]"                                
                  by 13-z

                  inspect text-oku-2 replacing all "[BORC_ADI_7_______]"                                
                  by bordepadi(7)                  
                  move bordeptutar(7) to 13-z
                  inspect text-oku-2 replacing all "[B7TUTAR____]"                                
                  by 13-z

                  inspect text-oku-2 replacing all "[BORC_ADI_8_______]"                                
                  by bordepadi(8)                  
                  move bordeptutar(8) to 13-z
                  inspect text-oku-2 replacing all "[B8TUTAR____]"                                
                  by 13-z

                  inspect text-oku-2 replacing all "[BORC_ADI_9_______]"                                
                  by bordepadi(9)                  
                  move bordeptutar(9) to 13-z
                  inspect text-oku-2 replacing all "[B9TUTAR____]"                                
                  by 13-z

                  inspect text-oku-2 replacing all "[BORC_ADI_10______]"                                
                  by bordepadi(10)
                  move bordeptutar(10) to 13-z
                  inspect text-oku-2 replacing all "[B10TUTAR___]"                                
                  by 13-z

                   inspect text-oku-2 replacing all "[BORC_ADI_11______]"                                
                  by bordepadi(11)
                  move bordeptutar(11) to 13-z
                  inspect text-oku-2 replacing all "[B11TUTAR___]"                                
                  by 13-z

                   inspect text-oku-2 replacing all "[BORC_ADI_12______]"                                
                  by bordepadi(12)
                  move bordeptutar(12) to 13-z
                  inspect text-oku-2 replacing all "[B12TUTAR___]"                                
                  by 13-z

                   inspect text-oku-2 replacing all "[BORC_ADI_13______]"                                
                  by bordepadi(13)
                  move bordeptutar(13) to 13-z
                  inspect text-oku-2 replacing all "[B13TUTAR___]"                                
                  by 13-z

                   inspect text-oku-2 replacing all "[BORC_ADI_14______]"                                
                  by bordepadi(14)
                  move bordeptutar(14) to 13-z
                  inspect text-oku-2 replacing all "[B14TUTAR___]"                                
                  by 13-z

                   inspect text-oku-2 replacing all "[BORC_ADI_15______]"                                
                  by bordepadi(15)
                  move bordeptutar(15) to 13-z
                  inspect text-oku-2 replacing all "[B15TUTAR___]"                                
                  by 13-z
*/alacak departmanlarý yukleniyor                  
                  inspect text-oku-2 replacing all "[ALAC_ADI_1_______]"                                
                  by aladepadi(1)                  
                  move aladeptutar(1) to 13-z
                  inspect text-oku-2 replacing all "[A1TUTAR____]"                                
                  by 13-z

                  inspect text-oku-2 replacing all "[ALAC_ADI_2_______]"                                
                  by aladepadi(2)                  
                  move aladeptutar(2) to 13-z
                  inspect text-oku-2 replacing all "[A2TUTAR____]"                                
                  by 13-z

                  inspect text-oku-2 replacing all "[ALAC_ADI_3_______]"                                
                  by aladepadi(3)                  
                  move aladeptutar(3) to 13-z
                  inspect text-oku-2 replacing all "[A3TUTAR____]"                                
                  by 13-z

                  inspect text-oku-2 replacing all "[ALAC_ADI_4_______]"                                
                  by aladepadi(4)                  
                  move aladeptutar(4) to 13-z
                  inspect text-oku-2 replacing all "[A4TUTAR____]"                                
                  by 13-z

                  inspect text-oku-2 replacing all "[ALAC_ADI_5_______]"                                
                  by aladepadi(5)                  
                  move aladeptutar(5) to 13-z
                  inspect text-oku-2 replacing all "[A5TUTAR____]"                                
                  by 13-z






             if text-oku-1 =  "5"
                
                if acenta-fatalti-ind > 0 then
                   compute ttl-tut-mat-net  rounded 
                   = ( ttl-tut-mat * 100 ) /  ( cinpara-mus-kdv + 100 ) 
                   
                   compute ind-mat = tlnet - ttl-tut-mat-net
                   move ttl-tut-mat-net         to 13-z

                  inspect text-oku-2 replacing all "[TTLINDSIZ__]"     by  13-z
                    move ind-mat         to 13-z
                  inspect text-oku-2 replacing all "[IND-TUTAR__]"     by  13-z
                
                  move acenta-fatalti-ind         to ind-z
                  inspect text-oku-2 replacing all "[IND]"     by  ind-z

              
                 else
                 initialize text-oku-2
                end-if
             end-if
          end-if

          if text-oku-1 = "4"
             initialize rakam yaziile
             move top-TL-TUTAR to rakam
             call "/asya/ytl/obj/otel/yaziile.asy" using rakam yaziile
                  on exception perform callerr-proc
                  not on exception
                  cancel "/asya/ytl/obj/otel/yaziile.asy" 
             end-call

             inspect text-oku-2 replacing all
             "[YAZI.........................................................................................]"
                                                      by yaziile(1:95)


                   
          end-if,
          if text-oku-1 = "9"
             move text-oku-2 to yaziile(1:95)
          end-if,
          if v-comboefat(1:1) not = "E" 
                  move text-oku-2   to det-filler
                  write dokumer-rec from detay
               
           end-if
             add 1 to fatdok-sira
             move fatdok-sira      to fatdokum-fat-sira
             move fat-no           to fatdokum-fat-no
             move det-filler       to fatdokum-detay

             move k-kodu-tasi      to fatdokum-staf
             move "C/L FATURA"     to fatdokum-aciklama
             write fatdokum-rec invalid 
               continue 
             end-write
       end-read
       end-perform,
       close text-oku

         .
*    
 max-bul.
       open input text-oku,
       initialize max-satir
       perform with test after until fs-text-oku = "10"
       read text-oku next no lock end move "10" to fs-text-oku
            not end
              if text-oku-1 = "2"
                  initialize  apo
                 inspect text-oku-2 tallying apo for   all "[TLTUTAR____]" 
                   if apo > 0
                     add 1 to max-satir
                  end-if
              end-if
       end-read
       end-perform,
       close text-oku.


*
acuserve-adres-aktar.
    move muhasebe-entegre-sirketi to CARI-DOSYA-adres         
                         ISLENEN-DOSYA-adres      
                         HESAP-DOSYA-adres        
                         MAHSUP-DOSYA-adres       
                         alsat-dosya-adres 
                         alsatek-dosya-adres
                         muh-kodlar-DOSYA-adres
                         REFERANS-DOSYA-adres     
                         Mgenel-DOSYA-adres       
                        
 
    move all low-values to      
                           CARI-ACUSERVE-DOSYA       
                           ISLENEN-ACUSERVE-DOSYA    
                           HESAP-ACUSERVE-DOSYA      
                           MAHSUP-ACUSERVE-DOSYA     
                           genelfis-ACUSERVE-DOSYA   
                           REFERANS-ACUSERVE-DOSYA   
                           Mgenel-ACUSERVE-DOSYA     
                           genelfis-ACUSERVE-DOSYA 
                           alsat-ACUSERVE-DOSYA
                           muh-kodlar-ACUSERVE-DOSYA
                           alsatek-acuserve-dosya
                           ip-no.


    inspect genel-muha-uzak-ip 
            replacing trailing spaces by low-values.

    if genel-muha-uzak-ip <> low-values
       move all low-values to ip-no
       string ip-no,
              "@" delimited by low-values
              genel-muha-uzak-ip delimited by low-values
              ":" delimited by low-values
              into ip-no
    end-if

    string mgenel-acuserve-dosya,
           ip-no                        delimited by low-values
           mgenel-dosya                    delimited by low-values
           into mgenel-acuserve-dosya.
    string genelfis-acuserve-dosya,
           ip-no                        delimited by low-values
           genelfis-dosya                 delimited by low-values
           into genelfis-acuserve-dosya.

    string alsat-acuserve-dosya,

           ip-no                        delimited by low-values
           alsat-dosya                 delimited by low-values
           into alsat-acuserve-dosya.
    string alsatek-acuserve-dosya,
           ip-no                        delimited by low-values
           alsatek-dosya                 delimited by low-values
           into alsatek-acuserve-dosya.
    string MUH-KODLAR-acuserve-dosya,
           ip-no                        delimited by low-values
           muh-kodlar-DOSYA              delimited by low-values
           into MUH-KODLAR-acuserve-dosya.
    
    string hesap-acuserve-dosya,
           ip-no                        delimited by low-values
           hesap-dosya                 delimited by low-values
           into hesap-acuserve-dosya.
    string mahsup-acuserve-dosya,
           ip-no                        delimited by low-values
           mahsup-dosya                 delimited by low-values
           into mahsup-acuserve-dosya.
    string cari-acuserve-dosya,
           ip-no                        delimited by low-values
           cari-dosya                 delimited by low-values
           into cari-acuserve-dosya.
    string islenen-acuserve-dosya,
           ip-no                        delimited by low-values
           islenen-dosya               delimited by low-values
           into islenen-acuserve-dosya.
    string referans-acuserve-dosya,
           ip-no                        delimited by low-values
           referans-dosya                delimited by low-values
           into referans-acuserve-dosya.
    

    inspect CARI-ACUSERVE-DOSYA        replacing  all spaces by low-values
    inspect ISLENEN-ACUSERVE-DOSYA     replacing  all spaces by low-values
    inspect HESAP-ACUSERVE-DOSYA       replacing  all spaces by low-values
    inspect MAHSUP-ACUSERVE-DOSYA      replacing  all spaces by low-values
    inspect genelfis-ACUSERVE-DOSYA    replacing  all spaces by low-values
    inspect REFERANS-ACUSERVE-DOSYA    replacing  all spaces by low-values
    inspect mgenel-ACUSERVE-DOSYA      replacing  all spaces by low-values
    inspect genelfis-ACUSERVE-DOSYA    replacing  all spaces by low-values
    inspect Alsat-ACUSERVE-DOSYA       replacing  all spaces by low-values
    inspect Alsatek-ACUSERVE-DOSYA       replacing  all spaces by low-values
    inspect MUH-KODLAR-acuserve-dosya  replacing  all spaces by low-values.
    open input mgenel
        move 1 to mgenel-anahtar
        read mgenel no lock invalid
             display message box 
                     "mgenel parametre tanimsiz ..."
                     icon mb_error_icon
                     title "Hata"
                     close mgenel
                     destroy form1-handle
                     goback
        end-read
        close mgenel  .

*
ad-tl-Aft-Procedure.
          compute d-dv rounded = d-tl / konu2-kur-degeri
          display ad-dv
     .
*
ad-dv-Aft-Procedure.
        compute d-tl rounded = d-dv * konu2-kur-degeri
        display ad-tl
     .
*
takvim-onceki-oku.
       open input takvim.
       initialize takvim-rec.
       move konu2-gel-tar     to takvim-anah 
       read takvim        no lock invalid 
            display message box "C/L Ledger Tarihi Tanimsiz.."
            
            not invalid 
            read takvim backward no lock 
               end continue
               not end 
                move takvim-anah to konu2-gel-tar
             end-read 
       end-read.
       close takvim.
*
*
takvim-onceki-oku2.
       open input takvim.
       initialize takvim-rec.
       move konuk-gel-tar     to takvim-anah 
       read takvim        no lock invalid 
            display message box "C/L Ledger Tarihi Tanimsiz.."
            
            not invalid 
            read takvim backward no lock 
               end continue

               not end 
                move takvim-anah to ykonuk-gel-tar
             end-read 
       end-read.
       close takvim.
  


*
Form2-Bef-Routine.
      open output takaskdv deptop.
     .
*
Form2-Cm-1-Ex-Ntf-Selchange.
      if cb-yazici-tipi(1:1) = "A"
         move 4  to m
         display acc-kopya-adet
         modify acc-kopya-adet, VISIBLE = 1
         modify Form1-La-1baaa,visible = 1
      else
         initialize m
         display acc-kopya-adet
         modify acc-kopya-adet, VISIBLE = 0
         modify Form1-La-1baaa,visible = 0        
      end-if      
     .
*
yazici-sor.
        call "/asya/ytl/obj/otel/prtcagir.asy" using link-prtler
          on exception 
             perform callerr-proc
          not on exception 
          cancel "/asya/ytl/obj/otel/prtcagir.asy"
          end-call
          if link-liste-adres = spaces 
             exit program
          else
             move link-liste-adres to dokumer-link-liste-adres

          end-if
          open input prtler
          move link-print-no   to prtler-anah dokumer-link-print-no
         read prtler no lock invalid
               initialize prtler-rec
          end-read

          close prtler.
*
folref-sil.
     open i-o folref
     initialize folref-rec
     start folref key not < folref-anah invalid 
         continue 
     not invalid 
     perform with test after until fs-folref = "10"
     read folref next no lock end move "10" to fs-folref
     not at end
            initialize folref-profil-anah
            rewrite folref-rec end-rewrite 
     end-read 
     end-perform
     end-start
     close folref
     display message box "bitti" .
*
Form3-Ex-Other.
     evaluate key-status
     when 2
        perform konuk-rez-duzelt
     end-evaluate 
     
     .
*
konuk-rez-duzelt.
     open i-o konuk rez ozluk yanrez
     initialize konuk-rec
     move acenfat-folio   to konuk-folio
     read konuk no lock invalid 
         display message box "Folio Bulunamadi.."
     not invalid 
         if konuk-rez-no > 0 and 
            konuk-fol-kodu = "R"
            initialize rez-rec 
            move konuk-rez-no   to rez-no
            read rez no lock invalid 
               display message box "Rezervasyon Bulunamadi.."
            not invalid
                move deg-adi    to konuk-adi rez-adi
                move deg-soy    to konuk-soyadi rez-soyadi
                move deg-grup   to konuk-grup-no rez-grup-no
                rewrite konuk-rec end-rewrite
                perform log-operation-konuk

                accept rez-edit-tarih from century-date  |firat amonra için konuldu 03/11/2020
                accept rez-edit-zaman from time          |                           

                rewrite rez-rec end-rewrite 
                perform log-operation-rez
                initialize yanrez-rec
                move rez-no   to yanrez-rezno
                move 1        to yanrez-sirano
                read yanrez no lock invalid 
                     continue 
                not invalid 
                    move deg-adi  to yanrez-adi
                    move deg-soy  to yanrez-soyadi
                    rewrite yanrez-rec end-rewrite 
                    perform log-operation-yanrez
                end-read 
                initialize ozluk-rec 
                move konuk-folio to ozluk-folio
                read ozluk no lock invalid 
                     continue 
                not invalid 
                    move deg-adi  to ozluk-adi 
                    move deg-soy  to ozluk-soyadi
                    rewrite ozluk-rec end-rewrite
                    perform log-operation-ozluk
                end-read
            end-read 
         end-if
         if konuk-fol-kodu = "E"
                    move deg-adi  to konuk-adi 
                    move deg-soy  to konuk-soyadi
                    rewrite konuk-rec end-rewrite 
                    perform log-operation-konuk

                initialize ozluk-rec 
                move konuk-folio to ozluk-folio
                read ozluk no lock invalid 
                     continue 
                not invalid 
                    move deg-adi  to ozluk-adi 
                    move deg-soy  to ozluk-soyadi
                    rewrite ozluk-rec end-rewrite 
                    perform log-operation-ozluk
                end-read
         end-if 
     end-read 
     close konuk rez ozluk yanrez
     display message box "Duzeltme islemi Tamamlandi."
                     title "Uyari"
                     icon 1
     set exit-pushed to true.
*
Form2-Mn-1-MI-RezervasyonIsmiDuzenle-Link.
     inquire form2-gd-1,
             cursor-y in i                    
     inquire form2-gd-1(i,1),
              hidden-data in acenfat-anah
     perform Acu-Form3-Routine.
*
Form3-Aft-Initdata.
     open input konuk
     initialize konuk-rec
     move acenfat-folio       to konuk-folio
     read konuk no lock invalid 
         display message box "Folio Bulunamadi.."
     not invalid 
         move konuk-adi       to deg-adi
        move konuk-soyadi    to deg-soy
         display acc-1 acc-2
     end-read 
     close konuk

     
     .
**********************ramco ekle **********************
fattop-takas-at.




fattop-toplam-al.
         open output fattop2. close fattop2.
        open i-o fattop fattop2
        open input acenta doviz cari
        initialize fattop-rec
        start fattop key > fattop-anah invalid continue
           not invalid
              perform until fs-fattop = "10"
                 read fattop next no lock end move "10" to fs-fattop
                    not end
                        initialize fattop2-rec 
                      move fattop-anah to fattop2-anah
                       initialize fattop2-fatno     
                      read fattop2 no lock invalid continue
                      end-read
                      if fattop-fat-kes  = 2 
                            add 1 to fattop2-fat-adet
                            add    fattop-tl-tut   to    fattop2-tl-tut      
                            add    fattop-dv-tut   to    fattop2-dv-tut        
                      else
                         add   1 to fattop2k-fat-adet
                         add   fattopk-tl-tut     to    fattop2k-tl-tut      
                         add   fattopk-dv-tut     to    fattop2k-dv-tut     
                      end-if
                      write fattop2-rec invalid rewrite fattop2-rec end-write
                 end-read
              end-perform
        end-start
         open i-o genelfis
        move 1 to genelfis-anahtar
        read genelfis no lock invalid
             accept print-no from time
        not invalid
             add 1 to print-no
             rewrite genelfis-rec end-rewrite
        end-read
        close genelfis

**************************
     initialize dokumer-rec dokumer-anah dokumer-ozellikler-rec
                dokumer-dosya

     set  dokumer-asya-set to true
     move print-no         to dokumer-dosya-adi
     open output dokumer
*/WINDOW TITLE
     initialize dokumer-rec detay
     move "W"                  to det-dokumer-20(1:)
     move "Acenta Kredi Faturalar Raporu"   to det-filler
     write dokumer-rec from detay
*/ BASLIKLAR
     initialize dokumer-rec detay
     move "B"                  to det-dokumer-20(1:1)
     move "1"          to det-dokumer-20(10:1)
     move "Acenta Kredi Faturalar Raporu"   to det-filler
     move "Tarih..:"     to det-filler(41:10)
     move ilk-gun        to det-filler(51:02)
     move "/"            to det-filler(53:01)
     move ilk-ay         to det-filler(54:02)
     move "/"            to det-filler(56:01)
     move ilk-yil        to det-filler(57:04)
     move "-"            to det-filler(61:01)
     move son-gun        to det-filler(62:02)
     move "/"            to det-filler(64:01)
     move son-ay         to det-filler(65:02)
     move "/"            to det-filler(67:01)
     move son-yil        to det-filler(68:04)
     write dokumer-rec from detay
     initialize dokumer-rec detay

     initialize dokumer-rec detay
     move "B"                  to det-dokumer-20(1:1)
     move "1"          to det-dokumer-20(10:1)
     move "Acenta.:"           to det-filler(01:10)
    
     write dokumer-rec from detay

     initialize dokumer-rec detay
     move "B"                  to det-dokumer-20(1:)
     write dokumer-rec from detay

*/ DOKUMER OZELLIKLER-REC
     initialize dokumer-rec detay
     move "O" to det-dokumer-20(1:)
     move "E" to dokumer-oto-sayfa-basi
     move 56  to dokumer-oto-sayfa-satir
     move "|" to dokumer-detay-kolon-ayirici
     move "LLLRRLLRRLL" to dokumer-align-occ
     move dokumer-ozellikler-rec     to det-filler
     write dokumer-rec from detay
*/ BASLIKLAR  
     initialize dokumer-rec detay 
     move "D1"         to det-dokumer-20(1:2)
     move "1"          to det-dokumer-20(10:1)
     move "Fatno"          to det-1
     move "Acenta"         to det-2
     move "Acenta adi"     to det-3
    
    
     move "Cari-kodu"      to det-5
     move "Cari-Adi"       to det-6
       move "Fat."         to det-9
     move "Kesilen TL"     to det-7
     move "Kesilen Dov"    to det-8
     move "Doviz"          to det-31
       move "Kes.F"        to det-19
     move "Kesilecek TL"   to det-17
     move "Kesilecek Dov"  to det-18
     move "Doviz"          to det-131
       
     move "|" to fil-1 fil-2 fil-3 fil-4 fil-5 fil-6
                 fil-7 fil-8 fil-9  fil-31  fil-17 fil-18 fil-131 fil-19
                 write dokumer-rec from detay
     move high-values to son-profil

     initialize dokumer-rec detay
     move "D2"           to det-dokumer-20(1:2)
     move "-"            to det-dokumer-20(5:1)
     move all "-" to det-1 det-2 det-3 det-4 det-5 det-6
                 det-7 det-8 det-9  det-31
     write dokumer-rec from detay

      open i-o genelfis
         move 1 to genelfis-anahtar
         read genelfis no lock invalid
            accept print-no from time
           not invalid
            add 1 to print-no
            rewrite genelfis-rec end-rewrite
          end-read
          close genelfis
  
     initialize fattop-rec icmal-toplamlar   
     start fattop key > fattop-anah invalid continue
       not invalid
     perform with test after until fs-fattop = "10"
        read fattop next no lock
             end
                 move "10" to fs-fattop
             not at end
                 initialize dokumer-rec detay
                move fattop-acenta      to acenta-kodu det-2
                read acenta no lock invalid
                     move "Tanimsiz acenta"  to acenta-adi
                end-read
                 move fattop-doviz to doviz-kodu
                 read doviz no lock invalid continue
                 end-read
                
               
                 move acenta-adi          to det-3(1:)

                 move fattop-cari to cari-kodu
                 read cari no lock invalid
                          initialize cari-rec
                 end-read,
                          
                      move c-unvan-1          to det-6
                      move cari-kodu to det-5
        

                if fattop-fat-kes =  2

                        move fattop-fat-adet  to z-adet
                        move z-adet           to det-9
                        move fattop-tl-tut    to etutar
                        move etutar           to det-7 
                        move fattop-dv-tut    to etutar-dv
                        move etutar-dv        to det-8

                       add fattop-fat-adet  to icmal-fat
                       add fattop-tl-tut    to icmal-tl
                       add fattop-dv-tut    to icmal-dv
                         move d-kisa-adi             to det-31 


                         compute   bas-no = fattop-fatno 
                    else
                        move d-kisa-adi             to   det-131
                        move fattopk-tl-tut      to etutar
                        move etutar              to det-17 
                        move fattopk-dv-tut      to etutar-dv
                        move etutar-dv           to det-18
                        move fattopk-fat-adet    to z-adet
                        move z-adet              to det-19

                       add fattopk-fat-adet  to icmal-fatk
                       add fattopk-tl-tut    to icmal-tlk
                       add fattopk-dv-tut    to icmal-dvk
                         compute   bas-no = fattop-fatno - 90000000 + cfat-no
                end-if
                     move bas-no to z-fat
                     move z-fat  to det-1
              
               
                write dokumer-rec from detay
            end-read
     end-perform
     end-start
      

        initialize dokumer-rec detay
        move "-"            to det-dokumer-20(5:1)
        move all "-" to det-1 det-2 det-3 det-4 det-5 det-6
                     det-7 det-8 det-9 det-31
        write dokumer-rec from detay
        initialize dokumer-rec detay
        move "A"          to det-dokumer-20(3:1)
        move 481          to det-renk1
        move "1"          to det-dokumer-20(10:1)
        move "Toplam =>"             to det-1


                        move icmal-fat  to z-adet
                        move z-adet           to det-9
                        move icmal-tl    to etutar
                        move etutar           to det-7 
                        move icmal-dv    to etutar-dv
                        move etutar-dv        to det-8

                        move icmal-fatk  to z-adet
                        move z-adet           to det-19
                        move icmal-tlk    to etutar
                        move etutar           to det-17 
                        move icmal-dvk    to etutar-dv
                        move etutar-dv        to det-18   

                      
        write dokumer-rec from detay 
        initialize dokumer-rec detay
        move "-"            to det-dokumer-20(5:1)
        move all "-" to det-1 det-2 det-3 det-4 det-5 det-6
                     det-7 det-8 det-9 det-31
        write dokumer-rec from detay



            initialize fattop2-rec icmal-toplamlar   
     start fattop2 key > fattop2-anah invalid continue
       not invalid
     perform with test after until fs-fattop2 = "10"
        read fattop2 next no lock
             end
                 move "10" to fs-fattop2
             not at end
                 initialize dokumer-rec detay
                move fattop2-acenta      to acenta-kodu det-2
                read acenta no lock invalid
                     move "Tanimsiz acenta"  to acenta-adi
                end-read
                 move fattop2-doviz to doviz-kodu
                 read doviz no lock invalid continue
                 end-read
                
               
                 move acenta-adi          to det-3(1:)

                 move fattop2-cari to cari-kodu
                 read cari no lock invalid
                          initialize cari-rec
                        end-read,
                          
                      move c-unvan-1          to det-6
                      move cari-kodu to det-5

                        move fattop2-fat-adet  to z-adet
                        move z-adet           to det-9
                        move fattop2-tl-tut    to etutar
                        move etutar           to det-7 
                        move fattop2-dv-tut    to etutar-dv
                        move etutar-dv        to det-8

                        add fattop2-fat-adet  to icmal-fat
                        add fattop2-tl-tut    to icmal-tl
                        add fattop2-dv-tut    to icmal-dv
                        move d-kisa-adi             to det-31 

                      
                  
                        move d-kisa-adi             to   det-131
                        move fattop2k-tl-tut      to etutar
                        move etutar              to det-17 
                        move fattop2k-dv-tut      to etutar-dv
                        move etutar-dv           to det-18
                        move fattop2k-fat-adet    to z-adet
                        move z-adet              to det-19


                       add fattop2k-fat-adet  to icmal-fatk
                       add fattop2k-tl-tut    to icmal-tlk
                       add fattop2k-dv-tut    to icmal-dvk

                write dokumer-rec from detay

            
         end-read
     end-perform
     end-start
      
        initialize dokumer-rec detay
        move "-"            to det-dokumer-20(5:1)
        move all "-" to det-1 det-2 det-3 det-4 det-5 det-6
                     det-7 det-8 det-9 det-31
        write dokumer-rec from detay
        initialize dokumer-rec detay
        move "A"          to det-dokumer-20(3:1)
        move 481          to det-renk1
        move "1"          to det-dokumer-20(10:1)
        move "Toplam =>"             to det-1
        move icmal-fat    to z-adet
        move z-adet       to det-9
        move icmal-tl     to etutar
        move etutar       to det-7 
        move icmal-dv     to etutar-dv
        move etutar-dv    to det-8
  
        move icmal-fatk   to z-adet
        move z-adet       to det-19
        move icmal-tlk    to etutar
        move etutar       to det-17 
        move icmal-dvk    to etutar-dv
        move etutar-dv    to det-18   
     
        write dokumer-rec from detay 
        initialize dokumer-rec detay
        move "-"            to det-dokumer-20(5:1)
        move all "-" to det-1 det-2 det-3 det-4 det-5 det-6
                     det-7 det-8 det-9 det-31
        write dokumer-rec from detay

        close fattop fattop2  acenta cari doviz

        close dokumer
        call dokumer-prog on exception
             perform callerr-proc
        not on exception
             cancel dokumer-prog
        end-call
        delete file dokumer .

* 
 fatupdateyap.  
 
 
                 initialize fatdetay-rec
                    move fat-tarih to fatdetay-fat-tar
*                    if kont-fat-no > 100 then stop         " " end-if
                    move acenfat-fat-no   to fatdetay-fat-no
                    move "C/L" to fatdetay-depkod  
                    move acenfat-folio to fatdetay-folio

                   | MOVE ACENFAT-KFOLIO TO fatdetay-folio |//************KOYULDUUUU
                     
                    move acenfat-pencere to fatdetay-islem
*                    if k-kodu-tasi = "X   "  and function numval( fatdetay-fat-no ) = 17824 then 
*                         stop " "
*                    end-if
                      
                     move acenfat-kdv to   fatdetay-kdv
                     move acenfat-tip to   fatdetay-tip

                      move konu2-fol-kodu to  fatdetay-tip
                     move "R" to  fatdetay-tip
                        move 99 to fatdetay-kdv 
                    read fatdetay no lock invalid 
                            continue
                    not invalid 
                          delete fatdetay invalid continue end-delete
                    end-read
                     move "E" to fatdetay-tip 
                    read fatdetay no lock invalid 
                            continue
                    not invalid 
                            delete fatdetay invalid continue end-delete
                    end-read
                       move 88 to fatdetay-kdv
                        move "R" to  fatdetay-tip
                     read fatdetay no lock invalid 
                          continue
                     not invalid 
                                 delete fatdetay invalid continue end-delete
                    end-read

                       move "E" to  fatdetay-tip
                        read fatdetay no lock invalid continue
                        not invalid delete fatdetay invalid continue end-delete
                    end-read


                    if acenfat-fat-no not  > 0 then        
                       exit     paragraph
                   end-if
                     initialize fatdetay-rec
                    move fat-tarih to fatdetay-fat-tar

                    move acenfat-fat-no   to fatdetay-fat-no
                    move "C/L" to fatdetay-depkod  

                    move acenfat-folio to fatdetay-folio
                     
                    move acenfat-pencere to fatdetay-islem

                      
                     move acenfat-kdv to   fatdetay-kdv
                     move acenfat-tip to   fatdetay-tip
                     
                     read fatdetay no lock invalid continue
                     end-read
                                  
                      


                    move konu2-fol-kodu to  fatdetay-romhrk-exthrk    
                    move acenfat-tarih to  fatdetay-isl-tar
                    accept fatdetay-kes-tar  from century-date
                    accept fatdetay-kes-zaman from time
                   
                     move acenfat-kdv to fatdetay-kdv-orani  fatdetay-kdv
                     move acenfat-tip to fatdetay-tip
*****PALMÝYED YILDIZ KALDÝRÝLDÝ
                        if acenfat-peryod = 0 then 
                  initialize fatdetay-fatura-matrah fatdetay-fatura-toplam
                                       fatdetay-fatura-toplamdv  fatdetay-fatura-matrah18
                                    fatdetay-fatura-kdv fatdetay-fatura-kdv18 
                         end-if
*****PALMÝYED YILDIZ KALDÝRÝLDÝ
                     
                     compute fatdetay-fatura-matrah = fatdetay-fatura-matrah  + acenfat-matrah8 
                     compute fatdetay-fatura-matrah18 = fatdetay-fatura-matrah18  + acenfat-matrah18 

                    

                    compute fatdetay-fatura-toplam = 
                            fatdetay-fatura-toplam  + 
                            acenfat-tl-tutar
                      

                    compute fatdetay-fatura-toplamdv = 
                            fatdetay-fatura-toplamdv  + 
                            ACENFAT-GER-DV-TUTAR

                    compute  fatdetay-fatura-kdv =  
                            fatdetay-fatura-kdv +  
                            ACENFAT-KDV8  
                    compute  fatdetay-fatura-kdv18 = 
                            fatdetay-fatura-kdv18  + 
                            ACENFAT-KDV18 
                      
                    write fatdetay-rec invalid rewrite fatdetay-rec end-write.
********************* ramco ekle bitti ************************








     
     .
*
 Form2-Pb-1aaaa-Link.
    display message box "          !!! Dikkat !!!        " new-line new-line new-line
                        "Faturalar Yeniden Yazdirilacaktir." new-line
                        "Eminmisiniz.?" new-line new-line new-line
                        
                    title "!!! Dikkat !!!"
                    icon 3
                    type 2
                    default 2
                    returning return-code 
    if return-code = 2
        exit paragraph 
    end-if 
    open i-o genelfis  
    move 1 to genelfis-anahtar
    read genelfis no lock invalid
        accept print-no from time
     not invalid
        add 1 to print-no
        move print-no      to tfatdokum-no
        rewrite genelfis-rec end-rewrite
     end-read
     close genelfis
     move k-kodu-tasi      to tfatdokum-k
     open output tfatdokum close tfatdokum open i-o tfatdokum
                            
    inquire form2-gd-1,last-row in son-satir
    initialize satir-sayisi  onceki-fatura-no
    perform varying satir-sayisi
                 from 1 
                 by 1
                 until satir-sayisi > son-satir
                     
                     if satir-sayisi = 1
                        exit perform cycle 
                     end-if 
                     
                     inquire form2-gd-1(satir-sayisi ,17),hidden-data secim-durumu
                     
                     if secim-durumu = "H"
                        exit perform cycle 
                     end-if
 
                     inquire form2-gd-1(satir-sayisi),record-data form2-gd-1-record
                     if onceki-fatura-no = zeroes 
                        move function numval(gd-1-col-14) to onceki-fatura-no
                     else 
                        if function numval(gd-1-col-14) = onceki-fatura-no
                           exit perform cycle
                        end-if 
                     end-if 
                     if function numval(gd-1-col-14) > 0
                        perform fatura-tekrar-yazdir        
                     end-if 
    end-perform 
    close tfatdokum
    delete file tfatdokum.
*
 fatura-tekrar-yazdir. 
    open i-o genelfis  
    move 1 to genelfis-anahtar
    read genelfis no lock invalid
        accept print-no from time
     not invalid
        add 1 to print-no
        rewrite genelfis-rec end-rewrite
     end-read
     close genelfis
     initialize dokumer-rec dokumer-anah dokumer-ozellikler-rec
               dokumer-dosya 
     set  dokumer-asya-set to true
     move print-no         to dokumer-dosya-adi

     open output dokumer
     add 1 to dokumer-anah
     write dokumer-rec     
     
     perform fatdokum-takas-yaz
     
     open input  fatdokum
     initialize tfatdokum-rec yedek-tfatdokum-fat-no
     move function numval(gd-1-col-14)      to tfatdokum-fat-no
     move all high-values                   to tfatdokum-tarih tfatdokum-zaman
    
     start tfatdokum key not > tfatdokum-anah invalid 
         continue
         close  fatdokum dokumer
     not invalid 
     perform with test after until fs-tfatdokum = "10"
     read tfatdokum backward no lock end move "10" to fs-tfatdokum
     not at end            
            if tfatdokum-fat-no <> function numval(gd-1-col-14)
                close  fatdokum dokumer
               exit paragraph               
            end-if

            if yedek-tfatdokum-fat-no = zeroes 
               move tfatdokum-fat-no to yedek-tfatdokum-fat-no
            else 
               if tfatdokum-fat-no = yedek-tfatdokum-fat-no
                  delete tfatdokum invalid 
                      continue 
                  end-delete
                  close  fatdokum dokumer
                  exit paragraph
               end-if 
            end-if
*/*/*/**/**/            display message box tfatdokum-zaman 
            initialize fatdokum-rec detay-bulundu 
            move tfatdokum-fat-no  to fatdokum-fat-no
            move tfatdokum-tarih   to fatdokum-tarih
            move tfatdokum-zaman   to fatdokum-zaman
            start fatdokum key not < fatdokum-anah invalid
                continue 
            not invalid 
            perform with test after until fs-fatdokum = "10"
            read fatdokum next no lock end              
                 if detay-bulundu = 1
                     set dokumer-yazici-text  to true
                     move "H"                 to dokumer-genel-baslik-yaz            
                     call dokumer-prog on exception
                        perform callerr-proc
                     not on exception
                        cancel dokumer-prog
                     end-call
                 end-if                    
                 move "10" to fs-fatdokum
                 close fatdokum dokumer  
                 initialize detay-bulundu
                 exit paragraph 
            not at end
                 if fatdokum-fat-no <> tfatdokum-fat-no or
                    fatdokum-tarih <> tfatdokum-tarih or
                    fatdokum-zaman <> tfatdokum-zaman
                     if detay-bulundu = 1
                        set dokumer-yazici-text  to true
                        move "H"                 to dokumer-genel-baslik-yaz            
                        call dokumer-prog on exception
                           perform callerr-proc
                        not on exception
                           cancel dokumer-prog
                        end-call
                     end-if                    
                    move "10" to fs-fatdokum
                    close fatdokum dokumer  
                    initialize detay-bulundu
                    exit paragraph 
                 end-if             
                    initialize dokumer-rec detay
                    move fatdokum-diger to det-filler
                    if detay-bulundu = 0 |tekrar fatura yazdirdan gelirse faturanýn üzerine * atýyor
                       move "*"         to det-filler(1:1)
                    end-if 
                    write dokumer-rec from detay
                    move 1              to detay-bulundu             
                    move function numval(gd-1-col-14) to onceki-fatura-no
            end-read 
            end-perform
            end-start                   
 
     end-read 
     end-perform
     end-start 
      .
*
 fatdokum-takas-yaz.
     open input fatdokum
     initialize fatdokum-rec detay-bulundu 
     move function numval(gd-1-col-14)  to fatdokum-fat-no

     start fatdokum key not < fatdokum-anah1 invalid
         continue 
     not invalid 
     perform with test after until fs-fatdokum = "10"
     read fatdokum next no lock end move "10" to fs-fatdokum
     not at end
             if fatdokum-fat-no <> function numval(gd-1-col-14)
                close  fatdokum
                exit paragraph 
             end-if               
             initialize tfatdokum-rec
             move fatdokum-tarih        to tfatdokum-tarih
             move fatdokum-zaman        to tfatdokum-zaman
             move fatdokum-fat-no       to tfatdokum-fat-no
             read tfatdokum no lock invalid
                  continue 
             end-read 

             write tfatdokum-rec invalid 
                 rewrite tfatdokum-rec invalid
                    continue 
                 end-rewrite 
             end-write 
     end-read 
     end-perform
     end-start
     close  fatdokum.
*
 e-arsiv-fat-dok.
     if e-arsiv-var-mi = 1     
        initialize efatr1-lnk
        move alsat-ana-anahtar         to efatr1-lnk
        move k-kodu-tasi               to yedek-k-kodu-tasi
        move isyeri-adres-tasi         to yedek-isyeri-adres-tasi        
        move "ASYA"                    to k-kodu-tasi              
        move muhasebe-entegre-sirketi              to isyeri-adres-tasi  

        if genel-muha-uzak-ip not = spaces
           move "ASYA"             to efatr1-uzak-k-kodu-tasi
           move "E"                to efatr1-uzak-call 
           move isyeri-adres-tasi  to efatr1-uzak-isyeri-adres-tasi
           move genel-muha-uzak-ip to efatr1-uzak-ip       
           call "/asya/ytl/obj/muha/earsivprintmanager.asy" using efatr1-lnk
           on exception 
                 
              move yedek-k-kodu-tasi       to k-kodu-tasi
              move yedek-isyeri-adres-tasi to isyeri-adres-tasi
              perform callerr-proc
           not on exception
           cancel "/asya/ytl/obj/muha/earsivprintmanager.asy"
           end-call
            
        else 
           call "/asya/ytl/obj/muha/earsivprintmanager.asy" using efatr1-lnk
           on exception 
              move yedek-k-kodu-tasi       to k-kodu-tasi
              move yedek-isyeri-adres-tasi to isyeri-adres-tasi
              perform callerr-proc
           not on exception
           cancel "/asya/ytl/obj/muha/earsivprintmanager.asy"
           end-call
        end-if 
        
        move yedek-k-kodu-tasi       to k-kodu-tasi
        move yedek-isyeri-adres-tasi to isyeri-adres-tasi
     end-if.
*
 Form2-Mn-1-MI-EArsivOdemeBilgileriniDuzenle-Link.
     inquire form2-gd-1,
             cursor-y in i                    
     inquire form2-gd-1(i,1),
              hidden-data in acenfat-anah
     open input konuk
     initialize konuk-rec
     move acenfat-folio       to konuk-folio
     read konuk no lock invalid 
         display message box "Folio Bulunamadi.."
     not invalid 
          if genel-e-arsiv-gecis-tarihi <= tarih-tasi and
             genel-e-arsiv-gecis-tarihi > "20150101"
                  initialize link-earsiv-odeme-bilgileri
                  if konuk-fol-kodu = "R"
                     move konuk-rez-no   to  link-earsiv-odeme-anah
                  else
                     move konuk-extra-rez-no   to  link-earsiv-odeme-anah
                  end-if 
                move "R"               to link-earsiv-odeme-nereden
                move tarih-tasi    to link-earsiv-odeme-tarihi
                call "/asya/ytl/obj/otel/earsbil.asy" 
                     using link-earsiv-odeme-bilgileri
                     on exception 
                     perform callerr-proc
                     exit paragraph
                     not on exception 
                cancel "/asya/ytl/obj/otel/earsbil.asy"
                end-call
          end-if            
     end-read 
     close konuk.
****
*
 acc-fat-no-Aft-Procedure.
      open i-o fatura gerfat
      initialize fatura-rec
     move cfat-no        to fatura-no
     move 0                    to fatura-sira
     read fatura no lock invalid
       continue
      end-read
      move FATURA-GERCEK-FAT to rap-ger-no
      move FATURA-onek        to rap-ger-seri
      display   acc-ger-no acc-ger-seri
      close fatura gerfat
      .
*
 kayit-kontrol.
      open input fattop fatura alsat 
      initialize fattop-rec hata-var alsat-hata-var hata-fat  alsat-hata-fat
      start fattop key > fattop-anah invalid 
         continue
      not invalid
      perform until fs-fattop = "10"
      read fattop next no lock end move "10" to fs-fattop
      not end
               initialize fatura-rec 
               move fattop-fatno   to fatura-no
               move 0              to fatura-sira
               read fatura no lock invalid
                    continue 
               not invalid 
                   if genel-muha-uzak-ip = spaces
                      perform alsat-fat-kont
                   end-if
                   if fatura-toplam not = fattop-tl-tut 
                      move fatura-no      to zfat     
                      string hata-fat
                            zfat delimited by "     "
                            ";" delimited by size 
                      into hata-fat
                      move 1 to hata-var 
                   end-if 
               end-read 
      end-read
      end-perform
      end-start

      close fattop fatura alsat

      initialize fatura-rec

      if hata-var = 1
      display message box "           !!! Uyari !!!                  " 
                          new-line 
                          new-line
                          "Asagidaki Faturalari Yeniden Kesmenizi Oneririz..."
                          new-line
                          hata-fat
                       title "Uyari"
                       icon 1
      end-if
      if alsat-hata-var = 1
      display message box "           !!! Uyari !!!                  " 
                          new-line 
                          new-line
                          "Asagidaki Faturalari Yeniden Kesmenizi Oneririz..."
                          new-line
                          alsat-hata-fat
                       title "Uyari"
                       icon 1
      end-if.
*
 alsat-fat-kont.
      initialize alsat-rec fat-bulundu muh-tl-top |//***** alsat-hata-var   24.05.2019 salih
      move "S"          to alsat-tipi
*      move fatura-no    to alsat-belge-no
      move fatura-tarihi to alsat-tarih                     
      start alsat key not < tarih-anahtar invalid
            continue
      not invalid
      perform with test after until fs-alsat = "10" 
      read alsat next no lock end move "10" to fs-alsat                  | alsat-mis-toplam-tl
      not at end 
          if alsat-tarih <> fatura-tarihi
             exit perform 
          end-if
          move alsat-belge-no(1:6) to 9-fat
          if 9-fat <> fatura-no
             exit perform cycle
          else 
             move 1 to fat-bulundu
             add alsat-kdvli alsat-konaklama-vergisi-tutar to muh-tl-top
          end-if

      end-read
      end-perform 
      end-start
      if fat-bulundu <> 1
         move fatura-no      to zfat     
         string alsat-hata-fat
                zfat delimited by "     "
                ";" delimited by size 
           into alsat-hata-fat
         move 1 to alsat-hata-var 
      else 
         if muh-tl-top not = fattop-tl-tut
            move fatura-no      to zfat     
            string alsat-hata-fat
                   zfat delimited by "     "
                   ";" delimited by size 
              into alsat-hata-fat
            move 1 to alsat-hata-var 
          end-if
      end-if.

* 
 firma-oku-getir.
    if konu2-firma not = spaces || 02.02.2019 salih
        initialize firma-rec
        move konu2-firma  to firma-kodu 
        read firma no lock invalid
                 initialize firma-rec
        not invalid
            if firma-muhno = spaces and firma-muhno2 = spaces
                 exit paragraph
            end-if
            if firma-MUHNO2 = spaces
                  move firma-muhno to cari-kodu  musteri-muhasebe-kodu
            else
                  move firma-muhno2 to cari-kodu  musteri-muhasebe-kodu
            end-if
        end-read
    end-if.

*
 detay-liste-ver.
        open i-o genelfis
        move 1 to genelfis-anahtar
        read genelfis no lock invalid
             accept print-no from time
        not invalid
             add 1 to print-no
             rewrite genelfis-rec end-rewrite
        end-read
        close genelfis

**************************
     initialize dokumer-rec dokumer-anah dokumer-ozellikler-rec
                dokumer-dosya

     set  dokumer-asya-set to true
     move print-no         to dokumer-dosya-adi
     open output dokumer
*/WINDOW TITLE
     initialize dokumer-rec detay2
     move "W"                  to det2-dokumer-20(1:)
     move "Acenta Fatura Kontrol Raporu"   to det2-filler
     write dokumer-rec from detay2
* 
     initialize dokumer-rec detay2
     move "B"                  to det2-dokumer-20(1:)
     write dokumer-rec from detay2

*/ DOKUMER OZELLIKLER-REC
     initialize dokumer-rec detay2
     move "O" to det2-dokumer-20(1:)
     move "E" to dokumer-oto-sayfa-basi
     move 56  to dokumer-oto-sayfa-satir
     move "|" to dokumer-detay-kolon-ayirici
     move "LLLLLLLLLCRLRRLLLL" to dokumer-align-occ
     move dokumer-ozellikler-rec     to det2-filler
     write dokumer-rec from detay2
*/ BASLIKLAR  
     initialize dokumer-rec detay2 
     move "D1"         to det2-dokumer-20(1:2)
     move "1"          to det2-dokumer-20(10:1)
     move "F.Sira"          to det2-1
     move "Acenta/Rate"          to det2-2
     move "Oda"          to det2-3
     move "Mis.Adi"          to det2-4
     move "Sirket"          to det2-5
     move "Odeme"          to det2-6
     move "Cari Adi."          to det2-7
     move "Cari Kodu"          to det2-8
     move "Tip"          to det2-9
     move "Gece"          to det2-10
     move "Bas.Doviz"          to det2-11
     move "Dvz"          to det2-12
     move "Bas.TL"          to det2-13
     move "Tutar"          to det2-14
     move "Fat No"          to det2-15
     move "C-in/C-out/Gec"          to det2-16
     move "Sec"          to det2-17
     move "VKN"          to det2-18
 
     move "|"         to fil2-1 fil2-2 fil2-3 fil2-4 fil2-5 
     fil2-6 fil2-7 fil2-8 fil2-9 fil2-10
     fil2-11 fil2-12 fil2-13 fil2-14 fil2-15 fil2-16 fil2-17 fil2-18
     write dokumer-rec from detay2
          
    initialize satir-sayisi   
    inquire Form2-Gd-1,last-row in son-satir
    perform varying satir-sayisi
                 from 1 
                 by 1
                 until satir-sayisi > son-satir                     
                   if satir-sayisi = 1
                      exit perform cycle 
                   end-if
                   initialize Form2-Gd-1-Record
                   inquire form2-gd-1(satir-sayisi),record-data Form2-Gd-1-Record
                   initialize dokumer-rec detay2
                    move Gd-1-Col-0   to det2-1    
                    move Gd-1-Col-1   to det2-2        
                    move Gd-1-Col-2   to det2-3        
                    move Gd-1-Col-3   to det2-4        
                    move Gd-1-Col-4   to det2-5        
                    move Gd-1-Col-5   to det2-6        
                    move Gd-1-Col-6   to det2-7        
                    move Gd-1-Col-7   to det2-8        
                    move Gd-1-Col-8   to det2-9        
                    move Gd-1-Col-9   to det2-10        
                    move Gd-1-Col-10  to det2-11        
                    move Gd-1-Col-11  to det2-12        
                    move Gd-1-Col-12  to det2-13        
                    move Gd-1-Col-13  to det2-14        
                    move Gd-1-Col-14  to det2-15        
                    move Gd-1-Col-16  to det2-16        
                    move Gd-1-Col-17  to det2-17        
                    move Gd-1-Col-18  to det2-18        
                    write dokumer-rec from detay2
    end-perform       

        initialize dokumer-rec detay2
        move "-"            to det2-dokumer-20(5:1)
        move all "-" to det2-1 det2-2 det2-3 det2-4 det2-5 det2-6
                     det2-7 det2-8 det2-9 det2-10 det2-11 det2-12
                     det2-13 det2-14 det2-15 det2-16
                     det2-17 det2-18
        write dokumer-rec from detay2

        close dokumer
        call dokumer-prog on exception
             perform callerr-proc
        not on exception
             cancel dokumer-prog
        end-call
        delete file dokumer.

 

 


 
