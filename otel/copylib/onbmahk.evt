* onbmahk.evt
* onbmahk.evt is generated from D:\asya\acugt.ytl\otel\onbmahk.Psf
* This is a generated file. DO NOT modify this file directly.


 Form1-Event-Proc.
     .

 Form1-Exception-Proc.
     PERFORM Form1-Ex-Other
     .

 acc-ref-Exception-Proc.
     PERFORM acc-ref-Ex-Other
     .

 Form1-Gd-1-Event-Proc.
     .
***   start event editor code   ***
*
 Form1-Bef-Create.
     perform adresleri-tasi.
     move tarih-tasi     to tarih.
     
       open input genel
    move 1 to genel-anahtar
    read genel no lock
      invalid
        move 3 to mesaj-no
        perform mesaj-ver
        set exit-pushed to true
      not invalid
        continue
*        move muha-sirketi to odenmez-dosya-adres
    end-read
    close genel
     if ONKPARA-REFERANS-VAR = 1 then 
       move 1 to ref-var
       else
       move 0 to ref-var
    end-if
    move genel-muha-ref to ref
     initialize referans-ip
     move muha-sirketi to enf-muha
      
     perform acuserve-adres-aktar.
     open input mgenel.
     move 1 to mgenel-anahtar.
     read mgenel no lock invalid
          display message box 
                  "mgenel parametre tanimsiz ..."
                  icon mb_error_icon
                  title "Hata"
                  close mgenel
                  destroy form1-handle
                  goback
     end-read.
     close mgenel.
     if mgenel-referans = "E" 
        move 1 to vis-1
     else
        move 0 to vis-1
     end-if.
     move 1 to enable-1
     move 0 to enable-2.
     open i-o odalar2
     
     .
*
 acc-yil-Aft-Procedure.
     initialize gec-gecme.
     open input takvim.
     move tarih   to takvim-anah
     read takvim no lock invalid
          move 1 to gec-gecme
     end-read
     close takvim.
   
     if girilemez-tarih <> zeroes 
        if tarih < girilemez-tarih
         if k-kodu-tasi not = "ASYA" and "X   "
           move 1 to gec-gecme
           display message box
                   girilemez-gun,"/",girilemez-ay,"/",girilemez-yil,
                   " tarihinden onceye mahsup fisi kesilemez ....",
                   icon mb_error_icon
                   title "Hata"
         end-if
        end-if
     end-if.
*
*
 Form1-Ef-1-Aft-Procedure.
          open input genel
    move 1 to genel-anahtar
    read genel no lock
      invalid
        move 3 to mesaj-no
        perform mesaj-ver
        set exit-pushed to true
      not invalid
        continue
*        move muha-sirketi to odenmez-dosya-adres
    end-read
    close genel
    move genel-muha-ref to ref
     initialize referans-ip
     
      
     perform acuserve-adres-aktar.
     open input mgenel.
     move 1 to mgenel-anahtar.
     read mgenel no lock invalid
          display message box 
                  "mgenel parametre tanimsiz ..."
                  icon mb_error_icon
                  title "Hata"
                  close mgenel
                  destroy form1-handle
                  goback
     end-read.
     close mgenel.
     if mgenel-referans = "E" 
        move 1 to vis-1
     else
        move 0 to vis-1
     end-if.
     move 1 to enable-1
     move 0 to enable-2.
     open input depkod depkod2
     initialize depkod-rec
      start depkod   key >  depkod-anah
       invalid continue 
       not invalid 
       read depkod  next  no lock
       end-read
      end-start
      move depkod-anah to depkod2-anah
      read depkod2 no lock invalid continue end-read
      close depkod depkod2
      move DEPKOD-MATRAH-HESAP to matrah-hesap
      move depkod-kdv-hesap    to kdv-hesap
      display  ef-kdv, ef-matrah
      perform matrah-after
      perform kdv-after
      perform tek-after
     
     .
*

 acc-numara-Aft-Procedure.
     initialize gec-gecme.
     if numara = zeroes 
        open i-o genelfis 
        move 1 to genelfis-anahtar
        read genelfis no lock invalid
             display message box
                     "Genel parametre'de genelfis fis tanimlamalari eksik !!!",new-line,
                     "Lutfen tanimlayiniz ..."
                     icon mb_error_icon
                     title "Hata"
                     destroy form1-handle
                     close genelfis
                     goback
        end-read
        add 1 to mahsup-oto
        move mahsup-oto to numara
        if mgenel-referans = "E"
           open i-o referans
             move ref   to referans-kodu
             move "A"   to referans-tipi
             read referans no lock invalid           
                  continue
             end-read
             add 1 to referans-fisno-ekle
             move referans-fisno-ekle   to numara
             add 4 to referans-fisno-ekle
             rewrite referans-rec end-rewrite

           close referans
        else
           add 4 to mahsup-oto
           rewrite genelfis-rec end-rewrite
        end-if
        close genelfis
        display acc-numara
     end-if.

     open input islenen.
     move numara to no-kont
     perform 4 times

     move no-kont to islenen-fis-no
     read islenen no lock invalid
          continue
     not invalid
          move 1 to gec-gecme
          display message box 
                  islenen-fis-no," numarali fis ",islenen-gun,"/",
                  islenen-ay,"/",islenen-yil," tarih kayitli",new-line,
                  "Lutfen kontrol ediniz",
                  icon mb_error_icon
                  title "Hata"
     end-read
     add 1 to no-kont 
     end-perform
     close islenen.
     
     .
*
 acc-ref-Aft-Procedure.
     initialize gec-gecme.
     if mgenel-referans = "E"
        continue else 
             exit paragraph.
*     if k-referans not = 0
*        if ref not = k-referans
*           display message box "Sadece ->" ,k-referans 
*           "<- Nolu Referansi Kullanmaya yetkilisiniz..."
*        end-if
*        move k-referans  to ref
*        display acc-ref
*     end-if

     open input referans.
     move ref   to referans-kodu
     move "A"   to referans-tipi
     read referans no lock invalid
          
          

          initialize referans-ip
          perform acuserve-adres-aktar

          move 1 to gec-gecme
          move "Tanimsiz ..." to referans-adi
     not invalid
          continue
     end-read
     close referans.
     display lb-ref.
     if referans-fisno-ekle not numeric
        move 0 to referans-fisno-ekle
     end-if.
     if nereden <> "E"
        move 0 to numara
        display acc-numara.     
     .


*
 Form1-Ex-Other.
     if key-status = 2001 or 
        key-status = 2002 or
        key-status = 2003 
        continue else 
             exit paragraph.
          move tarih  to muhasebe-tar
        perform muhasebe-entegre-kontrol
        if  muh-isl-durdur = 1 
          exit paragraph
        end-if
     if key-status = 2001
        perform yaz-boggam
        exit paragraph.

     if key-status = 2003
        move 1 to enable-1 
        move 0 to enable-2
        modify form1-gd-1,reset-grid =1 
        display form1
*/-----------------------------\*  
*/---------DIL AYARLA----------\*    
*/-----------------------------\*    
        perform dil-ayarla-proc
*/-----------------------------\*         
        move 4 to accept-control
        move 4 to control-id
        close borc-dep alac-dep ara-borc-dep ara-alac-dep ara-fark kasa-borc-dep kasa-alac-dep takas-acenta
        delete file borc-dep alac-dep kasa-borc-dep kasa-alac-dep takas-acenta ara-borc-dep ara-alac-dep ara-fark

        exit paragraph.

*       display message box  "geldi".
     perform Acc-Yil-Aft-Procedure.
     if gec-gecme = 1 
        move 4 to accept-control
        move 4 to control-id
        exit paragraph.

     perform Acc-Numara-Aft-Procedure.
     if gec-gecme = 1 
        move 4 to accept-control
        move 8 to control-id
        exit paragraph.

     move "E" to nereden.
     perform Acc-Ref-Aft-Procedure.
     if gec-gecme = 1 
        move 4 to accept-control
        move 12 to control-id
        exit paragraph.

     open i-o genelfis.
     move 1 to genelfis-anahtar.
     read genelfis no lock invalid move 1 to ekran-fis-1.
      
     add 1 to ekran-fis-1.
     move ekran-fis-1 to borc-dep-no.
      
     add 1 to ekran-fis-1.
     move ekran-fis-1 to kasa-borc-dep-no.
      
     add 1 to ekran-fis-1.
     move ekran-fis-1 to kasa-alac-dep-no.
     add 1 to ekran-fis-1.
      
     add 1 to ekran-fis-1.
     move ekran-fis-1 to alac-dep-no ara-alac-dep-no ara-borc-dep-no ara-fark-no.
       
     add 1 to ekran-fis-1.
     move ekran-fis-1 to takas-acenta-no.
     rewrite genelfis-rec invalid write genelfis-rec end-write end-rewrite.
     close genelfis.
     open output borc-dep close borc-dep open i-o borc-dep with mass-update.
     open output alac-dep close alac-dep open i-o alac-dep with mass-update.
     open output ara-borc-dep close ara-borc-dep open i-o ara-borc-dep with mass-update.
     open output ara-alac-dep close ara-alac-dep open i-o ara-alac-dep with mass-update.
     open output ara-fark     close ara-fark     open i-o ara-fark     with mass-update.
     open output kasa-borc-dep close kasa-borc-dep open i-o kasa-borc-dep with mass-update.
     open output kasa-alac-dep close kasa-alac-dep open i-o kasa-alac-dep with mass-update.
     open output takas-acenta close takas-acenta open i-o takas-acenta with mass-update.
     initialize kasa-borc-dep-rec kasa-alac-dep-rec borc-dep-rec alac-dep-rec takas-acenta-rec borc alac.

****|HAKAN|*** PROGRAMDAKÝ ARIZA YÜZÜNDEN BENÝ UÐRAÞTIRAN
**** DÝÐER PROGRAMCI ARKADAÞLARA SESLENÝYORUZ
*****


      if ref-var = 1 and ref > 0 then 
          perform onkasar-oku thru onkasar-oku-exit
        else
          perform onkasa-oku thru onkasa-oku-exit
      end-if 

   
       
     move 0 to enable-1
     move 1 to enable-2
     display form1.
*/-----------------------------\*  
*/---------DIL AYARLA----------\*    
*/-----------------------------\*    
     perform dil-ayarla-proc.
*/-----------------------------\*         
     modify form1-gd-1,reset-grid =1,mass-update = 1.
     move "Hesap kodu"       to gd-1-col-1
     move "Hesap adi"        to gd-1-col-2
     move "Aciklama"         to gd-1-col-3
     move "Borc Tutar"       to gd-1-col-5
     move "Alacak Tutar"     to gd-1-col-6
     modify form1-gd-1,record-to-add(form1-gd-1-record).

     open input hesap.

     initialize borc-dep-rec alac-dep-rec kasa-borc-dep-rec kasa-alac-dep-rec borc alac
     start borc-dep key not < borc-dep-anah2 invalid continue
     not invalid
     initialize fs-borc-dep
     perform with test after until fs-borc-dep = "10"
     read borc-dep next no lock end move "10" to fs-borc-dep
     not at end
          initialize form1-gd-1-record
          move borc-dep-hesap           to gd-1-col-1 hesap-kodu
          read hesap no lock invalid
                 add 1 to tanimsiz-sayi
                 move "Tanimsiz ..."   to hesap-adi
          end-read
          move hesap-adi             to gd-1-col-2
          move borc-dep-aciklama     to gd-1-col-3
          move borc-dep-tutar        to etutar
          if borc-dep-ba = "B"
             move etutar             to gd-1-col-5
          else
             move etutar             to gd-1-col-6
          end-if
          modify form1-gd-1,record-to-add(form1-gd-1-record)
          if borc-dep-ba = "B"
             add borc-dep-tutar to borc
          else
             add borc-dep-tutar to alac
          end-if
     end-read
     end-perform
     end-start
     initialize borc-dep-rec alac-dep-rec 
     
     start alac-dep key not < alac-dep-anah2 invalid continue
     not invalid
     initialize fs-alac-dep
     perform with test after until fs-alac-dep = "10"
     read alac-dep next no lock end move "10" to fs-alac-dep
     not at end
         if ters = 1 then 
               if  alac-dep-ba  not = "B"   then
                  move "B" to alac-dep-ba
                  else
                  move "A" to alac-dep-ba
               end-if
         end-if
          initialize form1-gd-1-record
          move alac-dep-hesap           to gd-1-col-1 hesap-kodu
          read hesap no lock invalid
               add 1 to tanimsiz-sayi
               move "Tanimsiz ..."   to hesap-adi
          end-read
          move hesap-adi             to gd-1-col-2
          move alac-dep-aciklama     to gd-1-col-3
          move alac-dep-tutar-tl     to etutar
          if alac-dep-ba = "B"
             move etutar             to gd-1-col-5
          else
             move etutar             to gd-1-col-6
          end-if
          modify form1-gd-1,record-to-add(form1-gd-1-record)
          if alac-dep-ba = "B"
             add alac-dep-tutar-tl to borc
          else
             add alac-dep-tutar-tl to alac
          end-if
          
          move  alac-dep-tutar-tl to tlbrt
         compute tlnet rounded = ( tlbrt * 100 ) / ( cinpara-mus-kdv + 100 )
         compute tlkdv = tlbrt - tlnet 
               
          initialize gd-1-col-5 gd-1-col-6
          move matrah-hesap       to gd-1-col-1 hesap-kodu
          read hesap no lock invalid
               add 1 to tanimsiz-sayi
               move "Tanimsiz ..."   to hesap-adi
          end-read
          move hesap-adi             to gd-1-col-2
          move tlnet     to etutar
          if alac-dep-ba = "A"
             move etutar             to gd-1-col-5
          else
             move etutar             to gd-1-col-6
          end-if
           modify form1-gd-1,record-to-add(form1-gd-1-record)
          if alac-dep-ba = "A"
             add tlnet to borc
          else
             add tlnet to alac
          end-if
           initialize gd-1-col-5 gd-1-col-6
           move kdv-hesap       to gd-1-col-1 hesap-kodu
          read hesap no lock invalid
               add 1 to tanimsiz-sayi
               move "Tanimsiz ..."   to hesap-adi
          end-read
          move hesap-adi             to gd-1-col-2
          move tlkdv     to etutar
          if alac-dep-ba = "A"
             move etutar             to gd-1-col-5
          else
             move etutar             to gd-1-col-6
          end-if
           modify form1-gd-1,record-to-add(form1-gd-1-record)
          if alac-dep-ba = "A"
             add tlkdv to borc
          else
             add tlkdv to alac
          end-if
       
        



     end-read
     end-perform
     end-start
********************* KASALAR **********************************
    
    



     close hesap.

     modify form1-gd-1,
            mass-update = 0.

     compute bakiye = borc - alac
     move borc   to etutar
     modify acc-borc, value = etutar
     move alac   to etutar
     modify acc-alac, value = etutar
     move bakiye to etutar
     modify acc-bakiye, value = etutar
     if borc <> alac 
        display message box 
                "Borc/Alacak toplami esit degil Kontrol ediniz",
                icon mb_error_icon
                title "Hata"
*                move 1 to enable-1 
*                move 0 to enable-2
*                display form1
*                move 4 to accept-control
*               move 4 to control-id
*                exit paragraph
*                close borc-dep alac-dep kasa-borc-dep 
*                ara-borc-dep ara-alac-dep ara-fark kasa-alac-dep takas-acenta
*                delete file borc-dep alac-dep 
*                ara-borc-dep ara-alac-dep ara-fark kasa-borc-dep kasa-alac-dep takas-acenta
    end-if.

 yaz-boggam.
     close takas-acenta.
     delete file takas-acenta.
     if combo-dovizlimi-value(1:1)  = "D"
        perform kur-bul thru kur-bul-exit
     end-if
     if borc = 0 or alac = 0
        display message box
                "Muhasebelestirilecek kayit bulunamadi ..."
                icon mb_error_icon
                title "Hata"
                move 1 to enable-1 
                move 0 to enable-2
                display form1
*/-----------------------------\*  
*/---------DIL AYARLA----------\*    
*/-----------------------------\*    
                perform dil-ayarla-proc
*/-----------------------------\*         
                move 4 to accept-control
                move 4 to control-id
                close  borc-dep alac-dep  ara-borc-dep ara-alac-dep ara-fark kasa-borc-dep kasa-alac-dep 
                delete file borc-dep alac-dep ara-borc-dep ara-alac-dep ara-fark kasa-borc-dep kasa-alac-dep 
                exit paragraph
      end-if.
*******>Borc Departmanlari Muhasebelesiyor.........

    
     open i-o mahsup islenen.
     initialize borc-dep-rec alac-dep-rec fis-sira-sakla
    
    
     initialize  fis-sira-sakla
     initialize alac-dep-rec 
     start alac-dep key not < alac-dep-anah2 invalid
      continue
      not invalid
     initialize fs-alac-dep
     perform with test after until fs-alac-dep = "10"
     read alac-dep next no lock end move "10" to fs-alac-dep
     not at end
          if ters = 1 then 
               if  alac-dep-ba  not = "B"   then
                  move "B" to alac-dep-ba
                  else
                  move "A" to alac-dep-ba
               end-if
         end-if
         initialize mahsup-rec 
         move tarih               to mahsup-tarih
         move numara              to mahsup-fis-no
         add  1                   to fis-sira-sakla
         move fis-sira-sakla      to mahsup-fis-sira

         move alac-dep-hesap      to mahsup-hesap-kodu
         move "A"                 to mahsup-tipi
         move alac-dep-ba         to mahsup-b-a 
         move alac-dep-tutar-tl   to mahsup-tutar
         move alac-dep-aciklama   to mahsup-aciklama 
         move ref                 to mahsup-referans 
         move k-kodu-tasi         to mahsup-staf 
          if alac-dep-tutar-dv not = zeroes then
               move alac-dep-banka      to mahsup-banka-kodu
               move alac-dep-doviz      to mahsup-doviz-kodu
               move mgenel-d-e          to mahsup-d-e       
               move alac-dep-tutar-dv   to mahsup-tutar-dv
               compute alac-dep-doviz-kuru rounded = alac-dep-tutar-tl / alac-dep-tutar-dv
               set MAHSUP-DOVIZ-KILITLI  to true
               move alac-dep-doviz-kuru to mahsup-doviz-kuru
         else
         if combo-dovizlimi-value(1:1)  = "D" and 
            islem-kuru not = 0
            if mahsup-tutar <> zeroes
               move mgenel-banka  to mahsup-banka-kodu
               move mgenel-doviz  to mahsup-doviz-kodu
               move mgenel-d-e    to mahsup-d-e       
               move islem-kuru   to mahsup-doviz-kuru
               compute mahsup-tutar-dv rounded = 
                       mahsup-tutar / islem-kuru
            end-if
         end-if
         if combo-dovizlimi-value(1:1)  = "D" and 
            alac-dep-banka  not = 0 and
            alac-dep-doviz  not = 0
            if mahsup-tutar <> zeroes
               move alac-dep-banka      to mahsup-banka-kodu
               move alac-dep-doviz      to mahsup-doviz-kodu
               move mgenel-d-e           to mahsup-d-e       
               move alac-dep-tutar-dv   to mahsup-tutar-dv
               move alac-dep-doviz-kuru to mahsup-doviz-kuru
            end-if
         end-if
         end-if
         move alac-dep-fatura-no to mahsup-belge-no
         move CINPARA-MUS-KDV to mahsup-kdv-oran
         move "O" to mahsup-nereden
********************************************************************************************
            initialize doviz-rec                              | firat liberty likya 28/12/2018..
            move mahsup-doviz-kodu to doviz-kodu
            read doviz no lock invalid
                 continue
            not invalid
                if d-muh-doviz-kodu > 0
                   move d-muh-doviz-kodu to mahsup-doviz-kodu
                end-if
            end-read
********************************************************************************************
         write mahsup-rec invalid continue end-write
        
         move  alac-dep-tutar-tl to tlbrt
         compute tlnet rounded = ( tlbrt * 100 ) / ( cinpara-mus-kdv + 100 )
         compute tlkdv = tlbrt - tlnet 
               initialize mahsup-banka-kodu
                mahsup-doviz-kodu
                mahsup-d-e       
                mahsup-tutar-dv
                mahsup-doviz-kuru


 
       
          add  1                   to fis-sira-sakla
           move fis-sira-sakla      to mahsup-fis-sira
          move matrah-hesap       to mahsup-hesap-kodu
         if  alac-dep-ba  = "B" 
              move "A" to mahsup-b-a
          else
              move "B" to mahsup-b-a
         end-if
         move tlnet                to mahsup-tutar
         
         write mahsup-rec invalid continue end-write
        
          add  1                   to fis-sira-sakla
           move fis-sira-sakla      to mahsup-fis-sira
          move kdv-hesap           to mahsup-hesap-kodu
         
         move tlkdv                to mahsup-tutar
         write mahsup-rec invalid continue end-write
        


     end-read
     end-perform
     end-start
************************** alacak correctionlar
     if fis-sira-sakla > 0 then 
            move "O" to islenen-nereden
             move numara      to islenen-fis-no
             move tarih       to islenen-tarih
             move "A"         to islenen-tipi
             write islenen-rec invalid 
                   rewrite islenen-rec end-rewrite
             end-write
             add 1 to numara
       end-if,           

    
     
     
     close borc-dep kasa-borc-dep.
     close alac-dep mahsup kasa-alac-dep ara-borc-dep ara-alac-dep ara-fark.
     delete file alac-dep kasa-alac-dep ara-borc-dep ara-alac-dep ara-fark .
     delete file borc-dep kasa-borc-dep.



     close islenen.
     display message box 
             "Gunluk [ ONBURO MAHSUBU ] Olusturulmustur Kontrol Ediniz !!!".
     modify form1-gd-1,reset-grid =1 .
     move 1 to enable-1 
     move 0 to enable-2
     display form1
*/-----------------------------\*  
*/---------DIL AYARLA----------\*    
*/-----------------------------\*    
     perform dil-ayarla-proc
*/-----------------------------\*         
     move 4 to accept-control
     move 4 to control-id.
     .
*
 acc-ref-Ex-Other.
     if key-status =  1
        initialize link-referans
        call "/asya/ytl/obj/muha/refara.asy" using link-referans
             on exception 
                perform callerr-proc
        not on exception
             cancel "/asya/ytl/obj/muha/refara.asy"
        end-call
        if link-referans <> spaces
           move link-referans to ref
           display acc-ref
           move 4 to accept-control
           move 12 to control-id
        end-if
     end-if.
*
 kur-bul.
        initialize islem-kuru.
     if combo-dovizlimi-value(1:1)  = "D"
               
        open input kur

        initialize islem-kuru
        move tarih         to kur-tarih
        move mgenel-banka   to kur-banka
        move mgenel-doviz   to kur-doviz
        read kur no lock invalid 
         display message box "Gunluk Kur Kaydi Bulunamadi Devam Ederseniz Dovizsiz Mahsup Keser.."
                              new-line,
                              "Islem Tarihi...........:" gun "/" ay "/" yil   
                              new-line,
                              "Banka-Doviz Kodu.......:" mgenel-banka   "-" mgenel-doviz
                              title = " [ Kurlar Tanimsiz ] "
         close kur 
         exit paragraph
        end-read
        move doviz-alis to islem-kuru
        if mgenel-d-e = "D" and mgenel-a-s = "A" 
           move doviz-alis    to islem-kuru
        end-if 
        if mgenel-d-e = "D" and mgenel-a-s = "S" 
           move doviz-satis   to islem-kuru
        end-if 
        if mgenel-d-e = "E" and mgenel-a-s = "A" 
           move efektif-alis  to islem-kuru
        end-if 
        if mgenel-d-e = "E" and mgenel-a-s = "S" 
           move efektif-satis to islem-kuru
        end-if 

        if islem-kuru = 0 
           display message box "Kur Tutari [0] Olamaz, Islem Yapamazsiniz.."
                            new-line,
                            "Islem Tarihi...........:" gun "/" ay "/" yil
                            new-line,
                            "Banka-Doviz Kodu.......:" mgenel-banka   "-" mgenel-doviz
                            title = " [ Kurlar Tanimsiz ] "
          close kur 
          exit paragraph
        end-if
        close kur
     end-if.
 kur-bul-exit.
    exit.
 onkasa-oku.
    open input onkasa depkod.
    initialize onkasa-rec .
    move tarih to onkasa-tarih.

    start onkasa key not < onkasa-anah invalid continue,
        not invalid,
        move spaces to evet-hayir,
        perform with test after until evet,
        read onkasa next no lock end move "E" to evet-hayir,
            not end,

            if onkasa-tarih > tarih,
                      move "E" to evet-hayir,
            end-if,

            if onkasa-tarih = tarih  ,
                initialize depkod-rec,
                move onkasa-dep to depkod-kodu,
                read depkod no lock invalid continue,
                    not invalid,
                    
                      if   depkod-turu = 4 and depkod-ba = "A" 
                                

                           perform kredi-bul thru kredi-bul-exit
                              
                          
                      
                     
                     end-if
                end-read,
            end-if,
        end-read,
        end-perform,
    end-start.
    close onkasa depkod.
 onkasa-oku-exit.
    exit.

*
 onkasar-oku.
    open input onkasar depkod.
    initialize onkasar-rec .
    move tarih to onkasar-tarih.
      move ref to onkasar-ref
    start onkasar key not < onkasar-anah invalid continue,
        not invalid,
        move spaces to evet-hayir,
        perform with test after until evet,
        read onkasar next no lock end move "E" to evet-hayir,
            not end,

            if onkasar-tarih > tarih or onkasar-ref not = ref,
                      move "E" to evet-hayir,
            end-if,


            if onkasar-tarih = tarih  ,
                initialize depkod-rec,
                move onkasar-dep to depkod-kodu,
                read depkod no lock invalid continue,
                    not invalid,
                    
                      if   depkod-turu = 4 and depkod-ba = "A" 
                                

                           perform kredi-bul thru kredi-bul-exit
                              
                          
                      
                     
                     end-if
                end-read,
            end-if,
        end-read,
        end-perform,
    end-start.
    close onkasar depkod.
 onkasar-oku-exit.
    exit.
          
    .   
*
************************************************************ *
*
kacgun-bul.
       open input takvim 
       initialize takvim-rec takas-acenta-gun
        
        move konuk-gel-tar to takvim-anah
        start takvim key > takvim-anah 
            invalid
            not invalid   
             perform until fs-takvim =  "10"  
               read takvim next no lock
                  end move "10" to fs-takvim
                  not end
                  if takvim-anah < konuk-git-tar then
                      add 1 to takas-acenta-gun
                    else
                       add 1 to takas-acenta-gun
                       move "10" to fs-takvim
                  end-if
               end-read
             end-perform
         end-start
         close takvim.

*
 takas-acenta-dovizleri-bul.
           
         open input acenfat
           initialize acenfat-rec
           move tarih to acenfat-tarih
         

             start acenfat key > acenfat-anah
                invalid continue
                not invalid
                  perform until fs-acenfat = "10"
                    read acenfat next
                       end move "10" to fs-acenfat
                       not end
                       if tarih not =  acenfat-tarih
                         
                          move "10" to fs-acenfat
                          else
                          if acenfat-folio = konuk-folio
                                 
                             compute tl-gunluk rounded =   (ACENFAT-tl-TUTAR / acenfat-per-geceleme )
                             compute dv-gunluk rounded =   tl-gunluk / (konuk-kur-degeri)
                             compute takas-acenta-dv-tutar =  takas-acenta-dv-tutar + 
                                                           ( dv-gunluk  * acenfat-per-geceleme )
                            compute ACENFAT-GER-DV-TUTAR = dv-gunluk  * acenfat-per-geceleme 
                          
                          end-if 
                        end-if
                    end-read

                  end-perform
             end-start
         close acenfat

        
          .

 kredi-bul.
    
    move spaces to evet-hayir.
    open input romhrk konuk kur acenta.
    initialize romhrk-rec.
    move tarih        to romhrk-tarih.
    move depkod-kodu  to romhrk-depkod.
    start romhrk key not < romhrk-anah2 invalid continue,
        not invalid,

        move spaces to evet-hayir,
        perform with test after until evet,
            read romhrk next no lock end move "E" to evet-hayir,
                not end,
                if romhrk-tarih > tarih,
                          move "E" to evet-hayir,
                end-if,

                if romhrk-tarih not > tarih,
                   if romhrk-depkod = depkod-kodu,
                          modify lb-1, title = romhrk-folio
                           initialize takas-acenta-rec,
                           initialize konuk-rec,
                           move romhrk-folio    to konuk-folio,
                           read konuk no lock invalid 
                                move spaces to konuk-adi konuk-soyadi,
                           end-read,
                            
                           initialize kur-rec takas-acenta-rec acenta-rec
                           move konuk-acenta    to takas-acenta-kodu 
                           move takas-acenta-kodu   to acenta-kodu

                          read acenta no lock invalid 
                               continue

                          end-read
                           if konuk-kur-aygun = "A"
                              move 01         to kur-gun
                           else 
                             move konuk-gel-gun to kur-gun
                           end-if
                           move konuk-gel-ay     to kur-ay
                           move konuk-gel-yil    to kur-yil
                           move konuk-banka      to kur-banka takas-acenta-banka
                           move konuk-doviz      to kur-doviz takas-acenta-doviz
************************************   EARLY BOOK            
                            move konuk-gel-tar to takas-acenta-gel-tar
                            move konuk-eb      to takas-acenta-eb
                           
*                            move konuk-pazar   to takas-acenta-pazar
************************************ 
                                      
                           if acenta-detay-mahsup = "E" then
                               move konuk-odano to takas-acenta-odano
                           end-if
                            move konuk-fat-no to takas-acenta-fatura-no               
                           read takas-acenta no lock invalid continue
                           end-read
                            if konuk-fat-no > 0 then  
                            move konuk-folio to takas-acenta-folno

                            end-if,
                           compute takas-acenta-tl-tutar rounded =  
                                   takas-acenta-tl-tutar + romhrk-tl-tutar 
                              if konuk-kur-degeri = 0 then 
                                   move 1 to konuk-kur-degeri  
                               end-if
                               perform kacgun-bul
                           
                               perform takas-acenta-dovizleri-bul
                              move konuk-kur-degeri to takas-acenta-doviz-kuru doviz-alis
*                    
                          
                            
                           write takas-acenta-rec invalid
                                 rewrite takas-acenta-rec end-rewrite
                           end-write,
                   end-if, 
                end-if,
            end-read,
        end-perform,
    end-start.
    close romhrk.

    

  
    close  kur.

    move spaces to evet-hayir.
    initialize takas-acenta-rec.

    start takas-acenta key not < takas-acenta-anah invalid continue,
        not invalid,

        move spaces to evet-hayir,
        perform with test after until evet,
            read takas-acenta next no lock end move "E" to evet-hayir,
                not end,
                   initialize alac-dep-rec,
                          modify lb-1, title = takas-acenta-kodu
                   move takas-acenta-kodu   to acenta-kodu
                   read acenta no lock invalid 
              
                               display message box 
                                "Tanimsiz Acenta",
                                icon mb_error_icon
                                title "Hata"
                                move 1 to enable-1 
                                move 0 to enable-2
                                display form1
*/-----------------------------\*  
*/---------DIL AYARLA----------\*    
*/-----------------------------\*    
                                perform dil-ayarla-proc
*/-----------------------------\*         
                                move 4 to accept-control
                                move 4 to control-id
                                exit paragraph
                                close kasa-borc-dep kasa-alac-dep borc-dep alac-dep takas-acenta
                                delete file kasa-borc-dep kasa-alac-dep borc-dep alac-dep takas-acenta
                   not invalid
                        if depkod-matrah-ba = "B"
                           move "B"   to alac-dep-ba
                        else
                           move "A"   to alac-dep-ba
                        end-if
                        if gelen-fatura = 1 then 

                            if depkod-matrah-ba = "A"
                           move "B"   to alac-dep-ba
                        else
                           move "A"   to alac-dep-ba
                        end-if



                        end-if
                        if tek-hesap  = spaces       
                            move acenta-muhno       to alac-dep-hesap
                        else
                           move tek-hesap       to alac-dep-hesap
                           if tek-dov = takas-acenta-doviz then
                                  move tek-hesap2       to alac-dep-hesap
                           end-if



                        end-if
                        move takas-acenta-banka to alac-dep-banka
                        move takas-acenta-doviz to alac-dep-doviz
*                        move takas-acenta-kodu  to alac-dep-acenno    | Ayni hesap noya iki acenta atilirsa - mami
                        if acenta-detay-mahsup = "E" then
                           move takas-acenta-odano to alac-dep-odano
                        end-if

************************************   EARLY BOOK            
*                         move takas-acenta-gel-tar to alac-dep-gel-tar
*                         move takas-acenta-eb      to alac-dep-eb
*                        move takas-acenta-pazar   to alac-dep-pazar

************************************                           
                        move takas-acenta-folno    to konuk-folio,
                           read konuk no lock invalid 
                                move spaces to konuk-adi konuk-soyadi,
                           end-read

                        move takas-acenta-fatura-no   to alac-dep-fatura-no
                        
                        read alac-dep no lock invalid
*                           if konuk-fat-no = 0 then stop " " end-if
                           move konuk-fat-no  to alac-dep-aciklama
                           move " Ft"         to alac-dep-aciklama(7:3) 
                        end-read
*                        if alac-dep-eb = "E" then 
*                        compute dusulecek rounded = ( takas-acenta-tl-tutar * ((acenta-av-oran) / 100))
*                        compute alac-dep-tutar-tl rounded =  
*                                alac-dep-tutar-tl + ( takas-acenta-tl-tutar - dusulecek )
*                        compute dusulecek rounded = ( takas-acenta-dv-tutar * ((acenta-av-oran) / 100))
*                        compute alac-dep-tutar-dv rounded =  
*                                alac-dep-tutar-dv + ( takas-acenta-dv-tutar - dusulecek )
*                        else
                        compute alac-dep-tutar-tl rounded =  
                                alac-dep-tutar-tl + takas-acenta-tl-tutar
                        compute alac-dep-tutar-dv rounded =  
                                alac-dep-tutar-dv + takas-acenta-dv-tutar
*                        end-if
*********************************                        
                        
                        move takas-acenta-gel-tar(7:2) to alac-dep-aciklama(11:2)                        
                        move "/" to alac-dep-aciklama(13:1)                        
                        move takas-acenta-gel-tar(5:2) to alac-dep-aciklama(14:2)                        
                        move "-" to alac-dep-aciklama(16:01)
                        move konuk-git-gun to alac-dep-aciklama(17:2)
                        move "/" to alac-dep-aciklama(19:1)
                        move konuk-git-ay  to alac-dep-aciklama(20:2)
                        move acenta-adi to alac-dep-aciklama(23:10)
                        if alac-dep-eb = "E" then 
                                move "E/B" to alac-dep-aciklama(35:3)       
                        end-if
*                        move alac-dep-pazar        to alac-dep-aciklama(35:2)
*                        if alac-dep-pazar not = spaces
*                                move "Knk" to alac-dep-aciklama(38:) 
*                                else 
*                                move "Extra Harcamalari" to alac-dep-aciklama(22:)       
*                        end-if
***********************************                                 



                        
                        

                        if acenta-detay-mahsup = "E" then
                        initialize alac-dep-aciklama
                        move gun to alac-dep-aciklama (11:2)
                        move "/" to alac-dep-aciklama(13:1)
                        move ay  to alac-dep-aciklama(14:2)
*                        move "Cikislar-" to alac-dep-aciklama(17:)
                        move acenta-kodu to alac-dep-aciklama(17:4)
                        move takas-acenta-odano to o-kisa 
            perform oda-uzat
            move o-uzun to  alac-dep-aciklama(22:5),
                        move konuk-adi        to alac-dep-aciklama(28:7)
                        move konuk-soyadi     to alac-dep-aciklama(36:)
                          end-if 
                       

                        move  takas-acenta-doviz-kuru to alac-dep-doviz-kuru
                        write alac-dep-rec invalid
                              rewrite alac-dep-rec end-rewrite
                        end-write,
*                        if takas-acenta-eb = "E" and acenta-av-oran > 0 then 
*                           perform  acenta-avans-yaz
*                        end-if
                   end-read,
            end-read,
        end-perform,
    end-start.
    close acenta konuk.
    move spaces to evet-hayir.

 kredi-bul-exit.
     exit.

        
         
         .


***************** KASA BORC DEPARTMANI *******************




     .
*
 acc-ref-Bef-Procedure.
    initialize nereden.
*
 acuserve-adres-aktar.
    move enf-muha to CARI-DOSYA-adres         
                         ISLENEN-DOSYA-adres      
                         HESAP-DOSYA-adres        
                         MAHSUP-DOSYA-adres       
                         genelfis-DOSYA-adres     
                         REFERANS-DOSYA-adres     
                         Mgenel-DOSYA-adres       
                         genelfis-DOSYA-adres     
                         move "muha" to genelfis-DOSYA(16:4)
                

    move all low-values to      
                           CARI-ACUSERVE-DOSYA       
                           ISLENEN-ACUSERVE-DOSYA    
                           HESAP-ACUSERVE-DOSYA      
                           MAHSUP-ACUSERVE-DOSYA     
                           genelfis-ACUSERVE-DOSYA   
                           REFERANS-ACUSERVE-DOSYA   
                           Mgenel-ACUSERVE-DOSYA     
                           genelfis-ACUSERVE-DOSYA  
                           ip-no.


    inspect genel-muha-uzak-ip 
            replacing trailing spaces by low-values.

    if genel-muha-uzak-ip <> low-values
       move all low-values to ip-no
       string ip-no,
              "@" delimited by low-values
              genel-muha-uzak-ip delimited by low-values
              ":" delimited by low-values
              into ip-no
    end-if

    string mgenel-acuserve-dosya,
           ip-no                        delimited by low-values
           mgenel-dosya                    delimited by low-values
           into mgenel-acuserve-dosya.
    string genelfis-acuserve-dosya,
           ip-no                        delimited by low-values
           genelfis-dosya                 delimited by low-values
           into genelfis-acuserve-dosya.

    
    string hesap-acuserve-dosya,
           ip-no                        delimited by low-values
           hesap-dosya                 delimited by low-values
           into hesap-acuserve-dosya.
    string mahsup-acuserve-dosya,
           ip-no                        delimited by low-values
           mahsup-dosya                 delimited by low-values
           into mahsup-acuserve-dosya.
    string cari-acuserve-dosya,
           ip-no                        delimited by low-values
           cari-dosya                 delimited by low-values
           into cari-acuserve-dosya.
    string islenen-acuserve-dosya,
           ip-no                        delimited by low-values
           islenen-dosya               delimited by low-values
           into islenen-acuserve-dosya.
    string referans-acuserve-dosya,
           ip-no                        delimited by low-values
           referans-dosya                delimited by low-values
           into referans-acuserve-dosya.
    

    inspect CARI-ACUSERVE-DOSYA        replacing  all spaces by low-values
    inspect ISLENEN-ACUSERVE-DOSYA     replacing  all spaces by low-values
    inspect HESAP-ACUSERVE-DOSYA       replacing  all spaces by low-values
    inspect MAHSUP-ACUSERVE-DOSYA      replacing  all spaces by low-values
    inspect genelfis-ACUSERVE-DOSYA    replacing  all spaces by low-values
    inspect REFERANS-ACUSERVE-DOSYA    replacing  all spaces by low-values
    inspect mgenel-ACUSERVE-DOSYA      replacing  all spaces by low-values
    inspect genelfis-ACUSERVE-DOSYA   replacing  all spaces by low-values.
    
*
 matrah-after.
     open input hesap 
     initialize hesap-rec
     move matrah-hesap to hesap-kodu
     read hesap no lock invalid
       move "Tanimsiz Hesap " to matrah-title
       not invalid 
       move hesap-adi to matrah-title
    end-read
    display lb-matrah
    close hesap   
     .
*
 tek-after.
    if tek-hesap = spaces then 
      move "Kendi Carisine " to tek-title
      else
      open input hesap 
     initialize hesap-rec
     move tek-hesap to hesap-kodu
     read hesap no lock invalid
       move "Tanimsiz Hesap " to tek-title
       not invalid 
       move hesap-adi to tek-title
    end-read
    display lb-tek
    close hesap
     .
*
 kdv-after.
       open input hesap 
     initialize hesap-rec
     move kdv-hesap to hesap-kodu
     read hesap no lock invalid
       move "Tanimsiz Hesap " to kdv-title
       not invalid 
       move hesap-adi to kdv-title
    end-read
    display lb-kdv
    close hesap
     .
*
 Form1-Aft-Initdata.
*/-----------------------------\*  
*/---------DIL AYARLA----------\*    
*/-----------------------------\*    
     perform dil-ayarla-proc.
*/-----------------------------\*         
     .
*
 Form1-Aft-Routine.
     close odalar2
     .

 
